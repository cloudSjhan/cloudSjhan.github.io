<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>cloud world</title>
  
  <subtitle>To be A geek</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://cloudsjhan.github.io/"/>
  <updated>2020-04-22T03:54:56.182Z</updated>
  <id>https://cloudsjhan.github.io/</id>
  
  <author>
    <name>cloud sjhan</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>å¹¶å‘è®¿é—® slice å¦‚ä½•åšåˆ°ä¼˜é›…å’Œå®‰å…¨ï¼Ÿ</title>
    <link href="https://cloudsjhan.github.io/2020/04/22/%E5%B9%B6%E5%8F%91%E8%AE%BF%E9%97%AE-slice-%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E4%BC%98%E9%9B%85%E5%92%8C%E5%AE%89%E5%85%A8%EF%BC%9F/"/>
    <id>https://cloudsjhan.github.io/2020/04/22/å¹¶å‘è®¿é—®-slice-å¦‚ä½•åšåˆ°ä¼˜é›…å’Œå®‰å…¨ï¼Ÿ/</id>
    <published>2020-04-22T03:43:15.000Z</published>
    <updated>2020-04-22T03:54:56.182Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="æŠ›å‡ºé—®é¢˜"><a href="#æŠ›å‡ºé—®é¢˜" class="headerlink" title="æŠ›å‡ºé—®é¢˜"></a>æŠ›å‡ºé—®é¢˜</h3><p>ç”±äº slice/map æ˜¯å¼•ç”¨ç±»å‹ï¼Œgolangå‡½æ•°æ˜¯ä¼ å€¼è°ƒç”¨ï¼Œæ‰€ç”¨å‚æ•°å‰¯æœ¬ä¾ç„¶æ˜¯åŸæ¥çš„ sliceï¼Œ å¹¶å‘è®¿é—®åŒä¸€ä¸ªèµ„æºä¼šå¯¼è‡´ç«Ÿæ€æ¡ä»¶ã€‚</p><p>çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        slc = []<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">        n   = <span class="number">10000</span></span><br><span class="line">        wg  sync.WaitGroup</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    wg.Add(n)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">            slc = <span class="built_in">append</span>(slc, i)</span><br><span class="line">            wg.Done()</span><br><span class="line">        &#125;()</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"len:"</span>, <span class="built_in">len</span>(slc))</span><br><span class="line">    fmt.Println(<span class="string">"done"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Output:</span></span><br><span class="line"><span class="built_in">len</span>: <span class="number">8586</span></span><br><span class="line">done</span><br></pre></td></tr></table></figure><p>çœŸå®çš„è¾“å‡ºå¹¶æ²¡æœ‰è¾¾åˆ°æˆ‘ä»¬çš„é¢„æœŸï¼Œlen(slice) &lt; nã€‚ é—®é¢˜å‡ºåœ¨å“ªï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“sliceæ˜¯å¯¹æ•°ç»„ä¸€ä¸ªè¿ç»­ç‰‡æ®µçš„å¼•ç”¨ï¼Œå½“sliceé•¿åº¦å¢åŠ çš„æ—¶å€™ï¼Œå¯èƒ½åº•å±‚çš„æ•°ç»„ä¼šè¢«æ¢æ‰ã€‚å½“å‡ºåœ¨æ¢åº•å±‚æ•°ç»„ä¹‹å‰ï¼Œåˆ‡ç‰‡åŒæ—¶è¢«å¤šä¸ªgoroutineæ‹¿åˆ°ï¼Œå¹¶æ‰§è¡Œappendæ“ä½œã€‚é‚£ä¹ˆå¾ˆå¤šgoroutineçš„appendç»“æœä¼šè¢«è¦†ç›–ï¼Œå¯¼è‡´nä¸ªgouroutine appendåï¼Œé•¿åº¦å°äºnã€‚</p><p>é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ<br>map åœ¨ go 1.9 ä»¥åå®˜æ–¹å°±ç»™å‡ºäº† sync.map çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¦‚æœè¦å¹¶å‘è®¿é—® slice å°±è¦è‡ªå·±å¥½å¥½è®¾è®¡ä¸€ä¸‹äº†ã€‚ä¸‹é¢æä¾›ä¸¤ç§æ–¹å¼ï¼Œå¸®åŠ©ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h3 id="æ–¹æ¡ˆ-1-åŠ é”-ğŸ”"><a href="#æ–¹æ¡ˆ-1-åŠ é”-ğŸ”" class="headerlink" title="æ–¹æ¡ˆ 1: åŠ é” ğŸ”"></a>æ–¹æ¡ˆ 1: åŠ é” ğŸ”</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">slc := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="number">1000</span>)</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> lock sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">wg.Add(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(a <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">      <span class="comment">// åŠ ğŸ”</span></span><br><span class="line">lock.Lock()</span><br><span class="line"><span class="keyword">defer</span> lock.Unlock()</span><br><span class="line">slc = <span class="built_in">append</span>(slc, a)</span><br><span class="line">&#125;(i)</span><br><span class="line">wg.Wait()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(slc))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¼˜ç‚¹æ˜¯æ¯”è¾ƒç®€å•ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚</p></blockquote><h3 id="æ–¹æ¡ˆ-2ï¼š-ä½¿ç”¨-channel-ä¸²è¡ŒåŒ–æ“ä½œ"><a href="#æ–¹æ¡ˆ-2ï¼š-ä½¿ç”¨-channel-ä¸²è¡ŒåŒ–æ“ä½œ" class="headerlink" title="æ–¹æ¡ˆ 2ï¼š ä½¿ç”¨ channel ä¸²è¡ŒåŒ–æ“ä½œ"></a>æ–¹æ¡ˆ 2ï¼š ä½¿ç”¨ channel ä¸²è¡ŒåŒ–æ“ä½œ</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> ServiceData <span class="keyword">struct</span> &#123;</span><br><span class="line">ch   <span class="keyword">chan</span> <span class="keyword">int</span> <span class="comment">// ç”¨æ¥ åŒæ­¥çš„channel</span></span><br><span class="line">data []<span class="keyword">int</span>    <span class="comment">// å­˜å‚¨æ•°æ®çš„slice</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServiceData)</span> <span class="title">Schedule</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// ä» channel æ¥æ”¶æ•°æ®</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> s.ch &#123;</span><br><span class="line">s.data = <span class="built_in">append</span>(s.data, i)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServiceData)</span> <span class="title">Close</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// æœ€åå…³é—­ channel</span></span><br><span class="line"><span class="built_in">close</span>(s.ch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServiceData)</span> <span class="title">AddData</span><span class="params">(v <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">s.ch &lt;- v <span class="comment">// å‘é€æ•°æ®åˆ° channel</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewScheduleJob</span><span class="params">(size <span class="keyword">int</span>, done <span class="keyword">func</span>()</span>) *<span class="title">ServiceData</span></span> &#123;</span><br><span class="line">s := &amp;ServiceData&#123;</span><br><span class="line">ch:   <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, size),</span><br><span class="line">data: <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// å¹¶å‘åœ° append æ•°æ®åˆ° slice</span></span><br><span class="line">s.Schedule()</span><br><span class="line">done()</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">wg sync.WaitGroup</span><br><span class="line">n  = <span class="number">1000</span></span><br><span class="line">)</span><br><span class="line">c := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// new äº†è¿™ä¸ª job åï¼Œè¯¥ job å°±å¼€å§‹å‡†å¤‡ä» channel æ¥æ”¶æ•°æ®äº†</span></span><br><span class="line">s := NewScheduleJob(n, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; c &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; &#125;)</span><br><span class="line"></span><br><span class="line">wg.Add(n)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; n; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(v <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">defer</span> wg.Done()</span><br><span class="line">s.AddData(v)</span><br><span class="line"></span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">wg.Wait()</span><br><span class="line">s.Close()</span><br><span class="line">&lt;-c</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(s.data))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å®ç°ç›¸å¯¹å¤æ‚ï¼Œä¼˜ç‚¹æ˜¯æ€§èƒ½å¾ˆå¥½ï¼Œåˆ©ç”¨äº†channelçš„ä¼˜åŠ¿</p></blockquote><p>ä»¥ä¸Šä»£ç éƒ½æœ‰æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šï¼Œå°±ä¸å±•å¼€è®²äº†ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      å¹¶å‘è®¿é—® slice å¦‚ä½•åšåˆ°ä¼˜é›…å’Œå®‰å…¨ï¼Ÿ
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>javaè½¬goé‡åˆ°Apollo?è®©agolloæ¥å¸®ä½ å¹³æ»‘è¿ç§»</title>
    <link href="https://cloudsjhan.github.io/2020/04/17/java%E8%BD%ACgo%E9%81%87%E5%88%B0Apollo-%E8%AE%A9agollo%E6%9D%A5%E5%B8%AE%E4%BD%A0%E5%B9%B3%E6%BB%91%E8%BF%81%E7%A7%BB/"/>
    <id>https://cloudsjhan.github.io/2020/04/17/javaè½¬goé‡åˆ°Apollo-è®©agolloæ¥å¸®ä½ å¹³æ»‘è¿ç§»/</id>
    <published>2020-04-17T07:50:33.000Z</published>
    <updated>2020-04-17T07:52:46.723Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1gdueckqd79j30u00u043g.jpg" alt=""></p><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>agollo æ˜¯<a href="https://github.com/ctripcorp/apollo" target="_blank" rel="noopener">Apollo</a>çš„ Golang å®¢æˆ·ç«¯</p><blockquote><p>Apolloï¼ˆé˜¿æ³¢ç½—ï¼‰æ˜¯æºç¨‹æ¡†æ¶éƒ¨é—¨ç ”å‘çš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒç¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åèƒ½å¤Ÿå®æ—¶æ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯ã€‚</p></blockquote><p>å¦‚æœåœ¨ä½¿ç”¨ golang é‡æ„ java çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨åˆ°äº†åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ Apolloï¼Œé‚£ä¹ˆæœ€å¿«çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨åŸæ¥çš„é…ç½®ï¼Œä¿æŒæœ€å¹³æ»‘çš„è¿ç§»ï¼Œè¿™ä¸ªæ—¶å€™ä½ å°±éœ€è¦ä¸€ä¸ª Apollo çš„ golang å®¢æˆ·ç«¯ï¼Œagollo å¯ä»¥æ˜¯ä½ çš„ä¸€ä¸ªé€‰æ‹©ã€‚</p><h2 id="ä½¿ç”¨æŒ‡å—"><a href="#ä½¿ç”¨æŒ‡å—" class="headerlink" title="ä½¿ç”¨æŒ‡å—"></a>ä½¿ç”¨æŒ‡å—</h2><h3 id="1-1-ç¯å¢ƒè¦æ±‚"><a href="#1-1-ç¯å¢ƒè¦æ±‚" class="headerlink" title="1.1.ç¯å¢ƒè¦æ±‚"></a>1.1.ç¯å¢ƒè¦æ±‚</h3><ul><li>Go 1.11+ (æœ€å¥½ä½¿ç”¨Go 1.12)</li></ul><h3 id="1-2-ä¾èµ–"><a href="#1-2-ä¾èµ–" class="headerlink" title="1.2.ä¾èµ–"></a>1.2.ä¾èµ–</h3><h4 id="1-2-1-ä½¿ç”¨-go-get-æ–¹å¼"><a href="#1-2-1-ä½¿ç”¨-go-get-æ–¹å¼" class="headerlink" title="1.2.1.ä½¿ç”¨ go get æ–¹å¼"></a>1.2.1.ä½¿ç”¨ go get æ–¹å¼</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/zouyx/agollo/v3@latest</span><br></pre></td></tr></table></figure><h4 id="1-2-2-ä½¿ç”¨-go-mod-æ–¹å¼"><a href="#1-2-2-ä½¿ç”¨-go-mod-æ–¹å¼" class="headerlink" title="1.2.2.ä½¿ç”¨ go mod æ–¹å¼"></a>1.2.2.ä½¿ç”¨ go mod æ–¹å¼</h4><p>go.mod<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require github.com/zouyx/agollo/v3 latest</span><br></pre></td></tr></table></figure></p><p>æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod tidy</span><br></pre></td></tr></table></figure></p><p>import<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"github.com/zouyx/agollo/v3"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure></p><p>FAQ</p><ul><li><a href="https://github.com/golang/go/wiki/Modules#semantic-import-versioning" target="_blank" rel="noopener">ä¸ºä»€ä¹ˆè¦åŠ +incompatible</a></li><li><a href="https://github.com/zouyx/agollo/issues/85" target="_blank" rel="noopener">go.modä¸èƒ½ä¸‹è½½agolloçš„è§£å†³æ–¹æ³•</a></li></ul><h3 id="1-3-å¿…è¦è®¾ç½®"><a href="#1-3-å¿…è¦è®¾ç½®" class="headerlink" title="1.3.å¿…è¦è®¾ç½®"></a>1.3.å¿…è¦è®¾ç½®</h3><p>Apollo å®¢æˆ·ç«¯ä¾èµ–äº AppIdï¼ŒEnvironment ç­‰ç¯å¢ƒä¿¡æ¯æ¥å·¥ä½œï¼Œæ‰€ä»¥è¯·ç¡®ä¿é˜…è¯»ä¸‹é¢çš„è¯´æ˜å¹¶ä¸”åšæ­£ç¡®çš„é…ç½®ï¼š</p><ul><li>main ï¼š your application</li><li>app.properties (å¿…è¦) ï¼š è¿æ¥æœåŠ¡ç«¯å¿…è¦é…ç½®</li><li>seelog.xmlï¼ˆéå¿…è¦ï¼‰</li></ul><h4 id="1-3-1-é…ç½®"><a href="#1-3-1-é…ç½®" class="headerlink" title="1.3.1.é…ç½®"></a>1.3.1.é…ç½®</h4><p>åŠ è½½ä¼˜å…ˆçº§ï¼š</p><ol><li>ç±»é…ç½®</li><li>ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶</li><li>é»˜è®¤ï¼ˆapp.propertiesï¼‰é…ç½®æ–‡ä»¶</li></ol><h5 id="1-3-1-1-ç±»é…ç½®"><a href="#1-3-1-1-ç±»é…ç½®" class="headerlink" title="1.3.1.1.ç±»é…ç½®"></a>1.3.1.1.ç±»é…ç½®</h5><p>ä¼šè¦†ç›–<code>app.properties</code>ä¸­é…ç½®ï¼Œåœ¨è°ƒç”¨Startæ–¹æ³•ä¹‹å‰è°ƒç”¨</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">readyConfig:=&amp;AppConfig&#123;</span><br><span class="line">AppId:<span class="string">"test1"</span>,</span><br><span class="line">Cluster:<span class="string">"dev1"</span>,</span><br><span class="line">NamespaceName:<span class="string">"application1"</span>,</span><br><span class="line">Ip:<span class="string">"localhost:8889"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">InitCustomConfig(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(*AppConfig, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> readyConfig,<span class="literal">nil</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ç±»é…ç½® agollo çš„ demo:</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/zouyx/agollo/v3"</span></span><br><span class="line"><span class="string">"github.com/zouyx/agollo/v3/env/config"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitAgolloConfig</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">readyConfig := &amp;config.AppConfig&#123;</span><br><span class="line">AppID:         <span class="string">"test"</span>,</span><br><span class="line">Cluster:       <span class="string">"default"</span>,</span><br><span class="line">NamespaceName: <span class="string">"application"</span>,</span><br><span class="line">IP:            <span class="string">"localhost:8080"</span>,</span><br><span class="line">&#125;</span><br><span class="line">agollo.InitCustomConfig(<span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="params">(*config.AppConfig, error)</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> readyConfig, <span class="literal">nil</span></span><br><span class="line">&#125;)</span><br><span class="line">err := agollo.Start()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Errorf(<span class="string">"%v"</span>, err)</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">//Init Apollo</span></span><br><span class="line">err := config.InitAgolloConfig()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Errorf(<span class="string">"åˆå§‹åŒ–Apolloå¤±è´¥"</span>, err)</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">    fmt.Println(<span class="string">"åˆå§‹åŒ–Apolloé…ç½®æˆåŠŸ"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Use your apollo key to test</span></span><br><span class="line">    value := agollo.GetStringValue(<span class="string">"key"</span>, <span class="string">""</span>)</span><br><span class="line">    fmt.Println(value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="1-3-1-2-ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶"><a href="#1-3-1-2-ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶" class="headerlink" title="1.3.1.2.ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶"></a>1.3.1.2.ç¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶</h5><p>Linux/Mac<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> AGOLLO_CONF=/a/conf.properties</span><br></pre></td></tr></table></figure></p><p>Windows<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> AGOLLO_CONF=c:/a/conf.properties</span><br></pre></td></tr></table></figure></p><p>é…ç½®æ–‡ä»¶å†…å®¹ä¸app.propertieså†…å®¹ä¸€æ ·</p><h5 id="1-3-1-3-æ–‡ä»¶é…ç½®-app-properties"><a href="#1-3-1-3-æ–‡ä»¶é…ç½®-app-properties" class="headerlink" title="1.3.1.3.æ–‡ä»¶é…ç½® - app.properties"></a>1.3.1.3.æ–‡ä»¶é…ç½® - app.properties</h5><p>1.å¼€å‘:è¯·ç¡®ä¿ <strong>app.properties</strong> æ–‡ä»¶å­˜åœ¨äºworkingdirç›®å½•ä¸‹</p><p>2.æ‰“åŒ…å:è¯·ç¡®ä¿ <strong>app.properties</strong> æ–‡ä»¶å­˜åœ¨äºä¸æ‰“åŒ…ç¨‹åºåŒçº§ç›®å½•ä¸‹ï¼Œå‚è€ƒ1.3.å¿…è¦é…ç½®ã€‚</p><p>ç›®å‰åªæ”¯æŒjsonå½¢å¼ï¼Œå…¶ä¸­å­—æ®µåŒ…æ‹¬ï¼š</p><ul><li><em>appId</em> ï¼šåº”ç”¨çš„èº«ä»½ä¿¡æ¯ï¼Œæ˜¯ä»æœåŠ¡ç«¯è·å–é…ç½®çš„ä¸€ä¸ªé‡è¦ä¿¡æ¯ã€‚</li><li><em>cluster</em> ï¼šéœ€è¦è¿æ¥çš„é›†ç¾¤ï¼Œé»˜è®¤default</li><li><p><em>namespaceName</em> ï¼šå‘½åç©ºé—´ï¼Œé»˜è®¤ï¼šapplicationï¼ˆå…·ä½“å®šä¹‰å‚è€ƒï¼š<a href="https://github.com/ctripcorp/apollo/wiki/Apolloæ ¸å¿ƒæ¦‚å¿µä¹‹â€œNamespaceâ€" target="_blank" rel="noopener">namespace</a>ï¼‰,<strong>å¤šnamespaceä½¿ç”¨è‹±æ–‡é€—å·åˆ†å‰²</strong>ï¼Œ<br>ékey/valueé…ç½®ï¼ˆjson,properties,ymlç­‰ï¼‰ï¼Œåˆ™é…ç½®ä¸ºï¼šnamespace.æ–‡ä»¶ç±»å‹ã€‚å¦‚ï¼šnamespace.json</p></li><li><p><em>ip</em> ï¼šApolloçš„CONFIG_SERVICEçš„ipï¼ŒéMETA_SERVICEåœ°å€</p></li></ul><p>é…ç½®ä¾‹å­å¦‚ä¸‹ï¼š</p><p><strong>ä¸€èˆ¬é…ç½®</strong><br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"appId"</span>: <span class="string">"test"</span>,</span><br><span class="line">    <span class="attr">"cluster"</span>: <span class="string">"dev"</span>,</span><br><span class="line">    <span class="attr">"namespaceName"</span>: <span class="string">"application"</span>,</span><br><span class="line">    <span class="attr">"ip"</span>: <span class="string">"localhost:8888"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>å¤šnamespaceé…ç½®</strong><br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"appId"</span>: <span class="string">"test"</span>,</span><br><span class="line">    <span class="attr">"cluster"</span>: <span class="string">"dev"</span>,</span><br><span class="line">    <span class="attr">"namespaceName"</span>: <span class="string">"application, applications1"</span>,</span><br><span class="line">    <span class="attr">"ip"</span>: <span class="string">"localhost:8888"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><strong>ékey/value namespaceé…ç½®</strong><br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"appId"</span>: <span class="string">"test"</span>,</span><br><span class="line">    <span class="attr">"cluster"</span>: <span class="string">"dev"</span>,</span><br><span class="line">    <span class="attr">"namespaceName"</span>: <span class="string">"application.json,a.yml"</span>,</span><br><span class="line">    <span class="attr">"ip"</span>: <span class="string">"localhost:8888"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="1-4æ—¥å¿—ç»„ä»¶"><a href="#1-4æ—¥å¿—ç»„ä»¶" class="headerlink" title="1.4æ—¥å¿—ç»„ä»¶"></a>1.4æ—¥å¿—ç»„ä»¶</h3><p>å‚è€ƒ:</p><ul><li><a href="https://github.com/zouyx/agollo/wiki/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97%E7%BB%84%E4%BB%B6" target="_blank" rel="noopener">è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶</a></li><li><a href="https://github.com/zouyx/agollo/wiki/ä½¿ç”¨seelogæ—¥å¿—ç»„ä»¶" target="_blank" rel="noopener">ä½¿ç”¨seelogæ—¥å¿—ç»„ä»¶</a></li></ul><h2 id="å¯åŠ¨æ–¹å¼"><a href="#å¯åŠ¨æ–¹å¼" class="headerlink" title="å¯åŠ¨æ–¹å¼"></a>å¯åŠ¨æ–¹å¼</h2><ul><li>å¼‚æ­¥å¯åŠ¨ agollo</li></ul><p>åœºæ™¯ï¼šå¯åŠ¨ç¨‹åºä¸ä¾èµ–åŠ è½½Apolloçš„é…ç½®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> <span class="keyword">go</span> agollo.Start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åŒæ­¥å¯åŠ¨ agolloï¼ˆv1.2.0+ï¼‰</li></ul><p>åœºæ™¯ï¼šå¯åŠ¨ç¨‹åºä¾èµ–åŠ è½½ Apollo çš„é…ç½®ã€‚ä¾‹ï¼šåˆå§‹åŒ–ç¨‹åºåŸºç¡€é…ç½®ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> agollo.Start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ agollo - è‡ªå®šä¹‰ logger æ§ä»¶</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> agollo.StartWithLogger(loggerInterface)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ agollo - è‡ªå®šä¹‰ cache æ§ä»¶ (v1.7.0+)</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"> agollo.StartWithCache(cacheInterface)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨ agollo - è‡ªå®šä¹‰å„ç§æ§ä»¶ (v1.8.0+)</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    agollo.SetLogger(loggerInterface)</span><br><span class="line">agollo.SetCache(cacheInterface)</span><br><span class="line">agollo.Start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç›‘å¬å˜æ›´äº‹ä»¶ï¼ˆé˜»å¡ï¼‰</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">event := agollo.ListenChangeEvent()</span><br><span class="line">changeEvent := &lt;-event</span><br><span class="line">bytes, _ := json.Marshal(changeEvent)</span><br><span class="line">fmt.Println(<span class="string">"event:"</span>, <span class="keyword">string</span>(bytes))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸºæœ¬æ–¹æ³•"><a href="#åŸºæœ¬æ–¹æ³•" class="headerlink" title="åŸºæœ¬æ–¹æ³•"></a>åŸºæœ¬æ–¹æ³•</h2><ul><li>String</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agollo.GetStringValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><ul><li>Int</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agollo.GetIntValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><ul><li>Float</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agollo.GetFloatValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><ul><li>Bool</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">agollo.GetBoolValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><h2 id="åˆ‡æ¢namespaceè·å–é…ç½®"><a href="#åˆ‡æ¢namespaceè·å–é…ç½®" class="headerlink" title="åˆ‡æ¢namespaceè·å–é…ç½®"></a>åˆ‡æ¢namespaceè·å–é…ç½®</h2><ul><li>æ ¹æ®namespaceè·å–é…ç½®</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config := agollo.GetConfig(namespace)</span><br></pre></td></tr></table></figure><ul><li>String</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.GetStringValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><ul><li>Int</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.GetIntValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><ul><li>Float</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.GetFloatValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><ul><li>Bool</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">config.GetBoolValue(Key,DefaultValue)</span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶"><a href="#è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶" class="headerlink" title="è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶"></a>è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶</h2><p>å¤åˆ¶ä»¥ä¸‹ä»£ç è‡³é¡¹ç›®ä¸­ï¼Œå¹¶åœ¨å…¶ä¸­å¼•ç”¨æ—¥å¿—ç»„ä»¶çš„æ–¹æ³•è¿›è¡Œæ‰“å° log</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> DefaultLogger <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Debugf</span><span class="params">(format <span class="keyword">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;)</span></span>  &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Infof</span><span class="params">(format <span class="keyword">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Warnf</span><span class="params">(format <span class="keyword">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Errorf</span><span class="params">(format <span class="keyword">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Debug</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Info</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Warn</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DefaultLogger)</span><span class="title">Error</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   agollo.SetLogger(&amp;DefaultLogger&#123;&#125;)</span><br><span class="line">   agollo.Start()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶"><a href="#è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶" class="headerlink" title="è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶"></a>è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶</h2><h3 id="å£°æ˜è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶"><a href="#å£°æ˜è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶" class="headerlink" title="å£°æ˜è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶"></a>å£°æ˜è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//DefaultCache é»˜è®¤ç¼“å­˜</span></span><br><span class="line"><span class="keyword">type</span> DefaultCache <span class="keyword">struct</span> &#123;</span><br><span class="line">defaultCache sync.Map</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Set è·å–ç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCache)</span><span class="title">Set</span><span class="params">(key <span class="keyword">string</span>, value []<span class="keyword">byte</span>, expireSeconds <span class="keyword">int</span>)</span> <span class="params">(err error)</span></span>  &#123;</span><br><span class="line">d.defaultCache.Store(key,value)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//EntryCount è·å–å®ä½“æ•°é‡</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCache)</span><span class="title">EntryCount</span><span class="params">()</span> <span class="params">(entryCount <span class="keyword">int64</span>)</span></span>&#123;</span><br><span class="line">count:=<span class="keyword">int64</span>(<span class="number">0</span>)</span><br><span class="line">d.defaultCache.Range(<span class="function"><span class="keyword">func</span><span class="params">(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">count++</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> count</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Get è·å–ç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCache)</span><span class="title">Get</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(value []<span class="keyword">byte</span>, err error)</span></span>&#123;</span><br><span class="line">v, ok := d.defaultCache.Load(key)</span><br><span class="line"><span class="keyword">if</span> !ok&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>,errors.New(<span class="string">"load default cache fail"</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> v.([]<span class="keyword">byte</span>),<span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Range éå†ç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCache)</span><span class="title">Range</span><span class="params">(f <span class="keyword">func</span>(key, value <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">bool</span>)</span>&#123;</span><br><span class="line">d.defaultCache.Range(f)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Del åˆ é™¤ç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCache)</span><span class="title">Del</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(affected <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">d.defaultCache.Delete(key)</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Clear æ¸…é™¤æ‰€æœ‰ç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCache)</span><span class="title">Clear</span><span class="params">()</span></span> &#123;</span><br><span class="line">d.defaultCache=sync.Map&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//DefaultCacheFactory æ„é€ é»˜è®¤ç¼“å­˜ç»„ä»¶å·¥å‚ç±»</span></span><br><span class="line"><span class="keyword">type</span> DefaultCacheFactory <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//Create åˆ›å»ºé»˜è®¤ç¼“å­˜ç»„ä»¶</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d *DefaultCacheFactory)</span> <span class="title">Create</span><span class="params">()</span><span class="title">CacheInterface</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> &amp;DefaultCache&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜"><a href="#ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜" class="headerlink" title="ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜"></a>ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">agollo.SetCache(&amp;DefaultCacheFactory&#123;&#125;)</span><br><span class="line">agollo.Start()</span><br></pre></td></tr></table></figure><hr><ul><li>é¡¹ç›®åœ°å€: <a href="https://github.com/zouyx/agollo" target="_blank" rel="noopener">https://github.com/zouyx/agollo</a></li></ul><p>â€‹                          <em>æ–¹èµ„è®¯\</em>æœ€æ–°æŠ€æœ¯*ç‹¬å®¶è§£è¯»*</p><p><img src="https://tva1.sinaimg.cn/large/00831rSTgy1gcmcur033tj306b06b74o.jpg" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      java è½¬ go é‡åˆ° Apolloï¼Ÿ è®© agollo æ¥å¸®ä½ å¹³æ»‘è¿ç§»
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>fuckdb Lite, å¸®åŠ©ä½ æ›´å¿«åœ°ç”Ÿæˆgo structä»£ç </title>
    <link href="https://cloudsjhan.github.io/2020/04/06/fuckdb-Lite-%E5%B8%AE%E5%8A%A9%E4%BD%A0%E6%9B%B4%E5%BF%AB%E5%9C%B0%E7%94%9F%E6%88%90go-struct%E4%BB%A3%E7%A0%81/"/>
    <id>https://cloudsjhan.github.io/2020/04/06/fuckdb-Lite-å¸®åŠ©ä½ æ›´å¿«åœ°ç”Ÿæˆgo-structä»£ç /</id>
    <published>2020-04-06T01:07:07.000Z</published>
    <updated>2020-04-06T01:12:34.978Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h2 id="å‰è¨€-amp-èƒŒæ™¯"><a href="#å‰è¨€-amp-èƒŒæ™¯" class="headerlink" title="å‰è¨€&amp;èƒŒæ™¯"></a>å‰è¨€&amp;èƒŒæ™¯</h2><p>åœ¨golangçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ormçš„æ—¶å€™ï¼Œå¸¸å¸¸éœ€è¦å°†æ•°æ®åº“è¡¨å¯¹åº”åˆ°golangçš„ä¸€ä¸ªstructï¼Œè¿™äº›structä¼šæºå¸¦ormå¯¹åº”çš„<code>tag</code>ï¼Œå°±åƒä¸‹é¢çš„structå®šä¹‰ä¸€æ ·ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">type InsInfo struct &#123;</span><br><span class="line">  Connections  string    `gorm:&quot;column:connections&quot;`</span><br><span class="line">  CPU          int       `gorm:&quot;column:cpu&quot;`</span><br><span class="line">  CreateTime   time.Time `gorm:&quot;column:create_time&quot;`</span><br><span class="line">  Env          int       `gorm:&quot;column:env&quot;`</span><br><span class="line">  ID           int64     `gorm:&quot;column:id;primary_key&quot;`</span><br><span class="line">  IP           string    `gorm:&quot;column:ip&quot;`</span><br><span class="line">  Organization string    `gorm:&quot;column:organization&quot;`</span><br><span class="line">  Pass         string    `gorm:&quot;column:pass&quot;`</span><br><span class="line">  Port         string    `gorm:&quot;column:port&quot;`</span><br><span class="line">  RegionId     string    `gorm:&quot;column:regionid&quot;`</span><br><span class="line">  ServerIP     string    `gorm:&quot;column:server_ip&quot;`</span><br><span class="line">  Status       int       `gorm:&quot;column:status&quot;`</span><br><span class="line">  Type         string    `gorm:&quot;column:type&quot;`</span><br><span class="line">  UUID         string    `gorm:&quot;column:uuid&quot;`</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>è¿™æ˜¯gormå¯¹åº”çš„æ•°æ®åº“è¡¨çš„structæ˜ å°„ï¼Œå³ä½¿æ•°æ®è¡¨çš„å­—æ®µä¸å¤šï¼Œå¦‚æœæ˜¯æ‰‹åŠ¨å†™èµ·æ¥ä¹Ÿæ˜¯ä¸€äº›é‡å¤æ€§çš„å·¥ä½œã€‚åƒMySQLè¿™ç§å…³ç³»å‹æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ormå»æ“ä½œæ•°æ®åº“ï¼Œäºæ˜¯å°±æƒ³mysqlçš„æ•°æ®è¡¨èƒ½ä¸èƒ½æ¥è‡ªåŠ¨ç”Ÿæˆgolang çš„structå®šä¹‰ ï¼Œå‡å°‘é‡å¤æ€§çš„å¼€å‘å·¥ä½œï¼ˆæ—©ç‚¹ä¸‹ç­ï¼‰ã€‚</p><h2 id="ç°çŠ¶"><a href="#ç°çŠ¶" class="headerlink" title="ç°çŠ¶"></a>ç°çŠ¶</h2><p>è°ƒç ”äº†ä¸€ä¸‹ç›®å‰æœ‰ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚chromeæ’ä»¶SQL2Struct(ä¸€æ¬¾æ ¹æ®sqlè¯­å¥è‡ªåŠ¨ç”Ÿæˆgolangç»“æ„ä½“çš„chromeæ’ä»¶)ï¼Œæ„Ÿè§‰ç”¨èµ·æ¥æ¯”è¾ƒç¹çï¼Œæ¯æ¬¡éœ€è¦è¿›å…¥æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLè¯­å¥æ‹¿åˆ°å»ºè¡¨è¯­å¥copyåˆ°æµè§ˆå™¨ä¸­ï¼Œæ‰èƒ½ä½¿ç”¨ã€‚åœ¨æƒ³èƒ½ä¸èƒ½æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ç¯å¢ƒï¼Œæä¾›webç•Œé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼Œå°±å¯ä»¥ä¸€é”®ç”Ÿæˆå¯¹åº”çš„ORMçš„structï¼Œäºæ˜¯å°±è¯ç”Ÿäº†è¿™ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/hantmac/fuckdb" target="_blank" rel="noopener">https://github.com/hantmac/fuckdb</a></p><h2 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h2><p>mysqlæœ‰ä¸ªè‡ªå¸¦çš„æ•°æ®åº“<code>information_schema</code>ï¼Œæœ‰ä¸€å¼ è¡¨<code>COLUMNS</code>ï¼Œå®ƒçš„å­—æ®µåŒ…å«æ•°æ®åº“åã€è¡¨åã€å­—æ®µåã€å­—æ®µç±»å‹ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¡¨çš„æ•°æ®ï¼ŒæŠŠå¯¹åº”çš„è¡¨çš„å­—æ®µä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œç„¶åå†æ ¹æ®golangçš„è¯­æ³•è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„structã€‚å…·ä½“ä¸è¯¦ç»†å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥å»çœ‹ä¸‹æºç ã€‚</p><h2 id="Web-ç‰ˆ"><a href="#Web-ç‰ˆ" class="headerlink" title="Web ç‰ˆ"></a>Web ç‰ˆ</h2><h3 id="è¿æ¥æœ¬åœ°æ•°æ®åº“"><a href="#è¿æ¥æœ¬åœ°æ•°æ®åº“" class="headerlink" title="è¿æ¥æœ¬åœ°æ•°æ®åº“"></a>è¿æ¥æœ¬åœ°æ•°æ®åº“</h3><p>å¦‚æœä½ çš„æ•°æ®åº“åœ¨æœ¬åœ°ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œ <code>docker-compose up -d</code>ï¼Œ<br>è®¿é—®<code>localhost:8000</code>ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç•Œé¢ï¼š</p><p><img src="https://user-gold-cdn.xitu.io/2020/4/6/1714cf8416f8ebde?w=3324&amp;h=892&amp;f=png&amp;s=151985" alt=""></p><h3 id="æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“"><a href="#æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“" class="headerlink" title="æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“"></a>æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“</h3><p>å¦‚æœä½ çš„æ•°æ®åº“åœ¨å†…ç½‘æœåŠ¡å™¨ä¸Šï¼Œä½ éœ€è¦å…ˆä¿®æ”¹åç«¯æ¥å£çš„ip:port,ç„¶åé‡æ–°build Dockeré•œåƒï¼Œpushåˆ°è‡ªå·±çš„é•œåƒä»“åº“ï¼Œç„¶åä¿®æ”¹docker-compose.yamlï¼Œå†æ‰§è¡Œ<code>docker-compose up -d</code>ã€‚ä¿®æ”¹çš„ä½ç½®æ˜¯ï¼š<code>fuckdb/frontend/src/config/index.js</code>.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">let APIdb2struct</span><br><span class="line"></span><br><span class="line">if(process.env.NODE_ENV === &quot;development&quot;)&#123;</span><br><span class="line">  APIdb2struct = &quot;http://0.0.0.0:8000&quot; //ä¿®æ”¹ä¸ºéƒ¨ç½²æœåŠ¡å™¨çš„ip</span><br><span class="line">&#125;else&#123;</span><br><span class="line">  APIdb2struct = &quot;http://0.0.0.0:8000&quot; //ä¿®æ”¹ä¸ºéƒ¨ç½²æœåŠ¡å™¨çš„ip</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export default &#123;</span><br><span class="line">  APIdb2struct</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>åªéœ€è¦å¡«å…¥æ•°æ®åº“ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠä½ æƒ³å¾—åˆ°çš„golangä»£ç çš„<code>package name</code>ã€<code>struct name</code>,ç„¶åç‚¹å‡»ç”Ÿæˆï¼Œå°±å¯ä»¥å¾—åˆ°gormå¯¹åº”çš„ç»“æ„ä½“æ˜ å°„ã€‚</p><p>åœ¨ä½ çš„é¡¹ç›®é¡¹ç›®ä¸­åªè¦ Ctrl+C&amp;Ctrl+V å³å¯ã€‚æˆ‘ä»¬çŸ¥é“golangçš„structçš„tagæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œè¿™é‡Œä¹Ÿæä¾›äº†å¾ˆå¤štagçš„å¯é€‰é¡¹ï¼Œæ¯”å¦‚<code>json</code>,<code>xml</code>ç­‰ï¼Œåé¢ä¼šå¢åŠ æ›´å¤šçš„tagå¯é€‰é¡¹æ”¯æŒã€‚</p><p>webç‰ˆçš„ç‰¹è‰²åŠŸèƒ½æ˜¯æ•°æ®åº“ä¿¡æ¯ç¼“å­˜åŠŸèƒ½ï¼Œèƒ½å¤Ÿè®°å¿†ä½ ä¹‹å‰å¡«å†™è¿‡çš„æ•°æ®åº“ä¿¡æ¯ï¼Œçœå»äº†å¤§é‡é‡å¤çš„æ“ä½œï¼Œä½ ä¸ç”¨å†å¡«å†™ç¹ççš„æ•°æ®åº“åï¼Œè¡¨åï¼Œåªéœ€ä¸€é”®ï¼Œå°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„ä»£ç ï¼Œé…åˆé™„å¸¦json-to-goæ’ä»¶(<a href="https://github.com/mholt/json-to-go)ï¼Œå¼€å‘æ•ˆç‡å¾—åˆ°æé€Ÿæå‡ã€‚ç›®å‰è¿™ä¸ªå·¥å…·åœ¨æˆ‘ä»¬ç»„å†…å·²ç»å¼€å§‹ä½¿ç”¨ï¼Œåé¦ˆæ¯”è¾ƒå¥½ï¼ŒèŠ‚çœäº†å¾ˆå¤šé‡å¤çš„å·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨å¼€å‘çš„æ—¶å€™ç”¨åˆ°åŒä¸€ä¸ªåº“çš„å¤šå¼ è¡¨ï¼Œå¾ˆå¿«å°±å¯ä»¥å®Œæˆæ•°æ®åº“è¡¨-&gt;strcutçš„æ˜ å°„ã€‚" target="_blank" rel="noopener">https://github.com/mholt/json-to-go)ï¼Œå¼€å‘æ•ˆç‡å¾—åˆ°æé€Ÿæå‡ã€‚ç›®å‰è¿™ä¸ªå·¥å…·åœ¨æˆ‘ä»¬ç»„å†…å·²ç»å¼€å§‹ä½¿ç”¨ï¼Œåé¦ˆæ¯”è¾ƒå¥½ï¼ŒèŠ‚çœäº†å¾ˆå¤šé‡å¤çš„å·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨å¼€å‘çš„æ—¶å€™ç”¨åˆ°åŒä¸€ä¸ªåº“çš„å¤šå¼ è¡¨ï¼Œå¾ˆå¿«å°±å¯ä»¥å®Œæˆæ•°æ®åº“è¡¨-&gt;strcutçš„æ˜ å°„ã€‚</a></p><p><strong>æ¥çœ‹ä¸€æ®µæ¼”ç¤ºè§†é¢‘ã€‚</strong></p><p><img src="https://user-gold-cdn.xitu.io/2020/4/6/1714cf9e25576889?w=1920&amp;h=1080&amp;f=gif&amp;s=765691" alt=""></p><h2 id="æ’æ›²"><a href="#æ’æ›²" class="headerlink" title="æ’æ›²"></a>æ’æ›²</h2><p>å‰å‡ å¤©æœ‰åŒå­¦æ‰¾ä¸Šé—¨ï¼Œè¯´fuckdbçš„webç‰ˆéƒ¨ç½²åæ— æ³•ä½¿ç”¨ï¼Œè§£å†³äº†åŠå¤©ä¹Ÿæ²¡èƒ½è®©ç”¨æˆ·éƒ¨ç½²èµ·æ¥ï¼Œåé¦ˆè¿‡æ¥è¿˜æ˜¯æ„Ÿè§‰éƒ¨ç½²æœ‰äº›å¤æ‚ã€‚åæ€äº†ä¸€ä¸‹ï¼Œå¯¹äºä¸€ä¸ªå·¥å…·åŒ–çš„è½¯ä»¶ï¼Œæœ‰äº›ç”¨æˆ·å¹¶ä¸æƒ³åšä¸€äº›å¤æ‚çš„éƒ¨ç½²æµç¨‹æˆ–è€…ä¸ç†Ÿæ‚‰éƒ¨ç½²æ“ä½œï¼Œå¯èƒ½å°±æ˜¯æƒ³æš‚æ—¶ä½¿ç”¨ä¸€ä¸‹ï¼Œæ‰€ä»¥åº”è¯¥è®©å·¥å…·æ›´åŠ è½»é‡åŒ–ï¼Œæ›´åŠ å¼€ç®±å³ç”¨ï¼Œäºæ˜¯è¿å¤œå†™äº†ä¸€ä¸ªfuckdb lite, æ›´å®¹æ˜“ä¸Šæ‰‹ä½¿ç”¨ï¼Œæ›´æ–¹ä¾¿çš„å®‰è£…æµç¨‹ï¼Œ1åˆ†é’Ÿæ‹¿åˆ°ä½ æƒ³è¦çš„ä»£ç ã€‚</p><h2 id="fuckdb-Lite"><a href="#fuckdb-Lite" class="headerlink" title="fuckdb Lite"></a>fuckdb Lite</h2><h3 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>åŸºäº cobra(<a href="https://github.com/spf13/cobra)ï¼Œæ ¸å¿ƒä»£ç ç»§æ‰¿webç‰ˆã€‚" target="_blank" rel="noopener">https://github.com/spf13/cobra)ï¼Œæ ¸å¿ƒä»£ç ç»§æ‰¿webç‰ˆã€‚</a></p><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><p>å¬å–ç”¨æˆ·åé¦ˆï¼Œå®‰è£…æµç¨‹æç®€åŒ–ï¼ŒMacç”¨æˆ·å¯ä»¥ç›´æ¥brew install å®‰è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew tap hantmac/tap &amp;&amp; brew install fuckdb</span><br></pre></td></tr></table></figure><ul><li>Linuxç”¨æˆ·:<br><code>curl https://github.com/hantmac/fuckdb/releases/download/v0.2/fuckdb_linux.tar.gz</code> ä¸‹è½½ã€è§£å‹ã€å®‰è£…</li><li>windowsç”¨æˆ·emmm, å°±å»GitHubçš„releaseæ‰‹åŠ¨ä¸‹è½½å§</li></ul><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fuckdb --help</span><br><span class="line">From mysql schema generate golang struct with gorm, json tag</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line">  fuckdb [command]</span><br><span class="line"></span><br><span class="line">Available Commands:</span><br><span class="line">  generate    use `fuckdb generate` to generate fuckdb.json</span><br><span class="line">  go          fuckdb go to generate golang struct with gorm and json tag</span><br><span class="line">  help        Help about any command</span><br><span class="line"></span><br><span class="line">Flags:</span><br><span class="line">  -h, --help   help for fuckdb</span><br><span class="line"></span><br><span class="line">Use &quot;fuckdb [command] --help&quot; for more information about a command.</span><br></pre></td></tr></table></figure><p>ç›®å‰æä¾›äº†ä¸¤ä¸ªä¸»è¦å‘½ä»¤ï¼Œ<code>fuckdb generate</code> å’Œ <code>fuckdb go</code>ï¼Œæˆ‘ä»¬ä¾æ¬¡æ¥çœ‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fuckdb generate</span><br></pre></td></tr></table></figure><p>ç”Ÿæˆä¸€ä¸ªå­˜å‚¨MySQLä¿¡æ¯çš„<code>fuckdb.json</code>æ–‡ä»¶,<br>ç¼–è¾‘ fuckdb.json  ï¼Œå¡«å†™ä½ çš„MySQLä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶å¯å¤ç”¨ï¼Œç®€å•ä¿®æ”¹è¡¨åå³å¯ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;db&quot;: &#123;</span><br><span class="line">    &quot;host&quot;: &quot;localhost&quot;,</span><br><span class="line">    &quot;port&quot;: 3306,</span><br><span class="line">    &quot;password&quot;: &quot;password&quot;,</span><br><span class="line">    &quot;user&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;table&quot;: &quot;tableName&quot;,</span><br><span class="line">    &quot;database&quot;: &quot;example&quot;,</span><br><span class="line">    &quot;packageName&quot;: &quot;packageName&quot;,</span><br><span class="line">    &quot;structName&quot;: &quot;structName&quot;,</span><br><span class="line">    &quot;jsonAnnotation&quot;: true,</span><br><span class="line">    &quot;gormAnnotation&quot;: true</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">â€‹</span><br></pre></td></tr></table></figure></p><p>ä¿®æ”¹å®Œæ–‡ä»¶åï¼Œå°±å®Œæˆäº†å‡†å¤‡å·¥ä½œï¼Œgo go go!</p><p>â€‹æ‰§è¡Œ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fuckdb go</span><br></pre></td></tr></table></figure></p><p><img src="https://user-gold-cdn.xitu.io/2020/4/6/1714cfdc08b200b9?w=1238&amp;h=528&amp;f=png&amp;s=619750" alt=""><br><strong>Enjoy Your Codeï¼</strong></p><p>æ¥çœ‹ä¸€æ®µæ¼”ç¤ºæ“ä½œ(è¯´å¥½ä¸€åˆ†é’Ÿæ‹¿åˆ°ä»£ç ï¼Œç»ä¸è¶…1ç§’)</p><p><img src="https://user-gold-cdn.xitu.io/2020/4/6/1714cfdf3764125e?w=1736&amp;h=1080&amp;f=gif&amp;s=675007" alt=""></p><p>æ¯”ä¹‹å‰çš„webç‰ˆçš„å®‰è£…ç®€ç›´æ–¹ä¾¿äº†å¤ªå¤šï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘åŠ ç­å•¦ã€‚</p><p>ps:  fuckdb.jsonæ–‡ä»¶å¿…é¡»åœ¨æ“ä½œç›®å½•ä¸‹ã€‚</p><p>æ¬¢è¿è¯•ç”¨&amp;åé¦ˆ&amp;Contributeã€‚ä»£ç åœ°å€ï¼š<a href="https://github.com/hantmac/fuckdb" target="_blank" rel="noopener">https://github.com/hantmac/fuckdb</a></p><hr><pre><code>å®˜æ–¹èµ„è®¯*æœ€æ–°æŠ€æœ¯*ç‹¬å®¶è§£è¯»</code></pre><p><img src="https://user-gold-cdn.xitu.io/2020/4/6/1714cfed71ef0758?w=227&amp;h=227&amp;f=jpeg&amp;s=24842" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      fuckdb Lite, å¸®åŠ©ä½ æ›´å¿«åœ°ç”Ÿæˆgo structä»£ç 
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>Proposals for Go 1.15(è¯‘)</title>
    <link href="https://cloudsjhan.github.io/2020/02/01/Proposals-for-Go-1-15-%E8%AF%91/"/>
    <id>https://cloudsjhan.github.io/2020/02/01/Proposals-for-Go-1-15-è¯‘/</id>
    <published>2020-02-01T02:48:54.000Z</published>
    <updated>2020-04-01T09:03:03.550Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h2 id="Proposals-for-Go-1-15-è¯‘"><a href="#Proposals-for-Go-1-15-è¯‘" class="headerlink" title="Proposals for Go 1.15(è¯‘)"></a><a href="https://blog.golang.org/go1.15-proposals" target="_blank" rel="noopener">Proposals for Go 1.15</a>(è¯‘)</h2><hr><p><em>æœ¬æ–‡æ˜¯Golangå®˜æ–¹å¯¹äºGoè¿‘æœŸç‰ˆæœ¬çš„ç°çŠ¶æ€»ç»“ä»¥åŠGo 1.15ç‰ˆæœ¬çš„ä¸€äº›ææ¡ˆï¼ŒåŸæ–‡å‘å¸ƒäº The Go Blog</em></p><p><em>Robert Griesemer, for the Go team</em><br>        <em>28 January 2020</em></p><h2 id="ç°çŠ¶"><a href="#ç°çŠ¶" class="headerlink" title="ç°çŠ¶"></a>ç°çŠ¶</h2><p>Go 1.14çš„RC1ç‰ˆæœ¬å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¦‚æœä¸€åˆ‡é¡ºåˆ©ï¼ŒGo 1.14è®¡åˆ’å°†äºä»Šå¹´2æœˆä»½å‘å¸ƒã€‚æŒ‰ç…§<a href="https://blog.golang.org/go2-here-we-come" target="_blank" rel="noopener">Go 2,here we come!</a>çš„è§„åˆ’ï¼Œåœ¨æˆ‘ä»¬çš„å¼€å‘å‘¨æœŸä¸­åˆåˆ°äº†è¿™æ ·çš„ä¸€ä¸ªæ—¶åˆ»ï¼šè€ƒè™‘ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼ˆæš‚å®šäºå‡ å¹´8æœˆä»½å‘å¸ƒçš„Go 1.15ï¼‰ï¼Œåˆ°åº•è¦æä¾›å“ªäº›Golangæœ¬èº«æˆ–è€…Go libä¸­çš„æ–°ç‰¹æ€§ã€‚</p><p>å½“å‰ç‰ˆæœ¬çš„Goçš„ä¼˜åŒ–ç›®æ ‡ä»ç„¶å›´ç»•ç€è½¯ä»¶åŒ…å’Œç‰ˆæœ¬ç®¡ç†ï¼Œæ›´å¥½çš„é”™è¯¯å¤„ç†æ”¯æŒä»¥åŠæ³›å‹ç‰¹æ€§ã€‚Go Module ç›®å‰ä½¿ç”¨çŠ¶æ€æ¯”è¾ƒå¥½ï¼Œå¹¶ä¸”æ¯å¤©éƒ½åœ¨ä¸æ–­å®Œå–„ï¼Œå¯¹æ³›å‹çš„æ”¯æŒä¹Ÿæœ‰ä¸€äº›æ¨è¿›ï¼ˆä»Šå¹´æ™šäº›æ—¶å€™ä¼šæœ‰æ›´å¤šè¿›å±•ï¼‰ã€‚ä¸ºäº†æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå¤§çº¦åœ¨7ä¸ªæœˆå‰æˆ‘ä»¬æå‡ºäº†<a href="https://golang.org/issue/32437" target="_blank" rel="noopener">try_proposal</a>çš„ææ¡ˆï¼Œæœ‰å°‘éƒ¨åˆ†äººæ”¯æŒè¯¥ææ¡ˆï¼Œä½†æ˜¯å¤§éƒ¨åˆ†è¿˜æ˜¯æŒå¼ºçƒˆçš„åå¯¹æ€åº¦ï¼Œäºæ˜¯æˆ‘ä»¬å†³å®šæ”¾å¼ƒè¿™ä¸ªæƒ³æ³•ã€‚åœ¨æ­¤ä¹‹åï¼Œä¹Ÿæœ‰è®¸å¤šå»ºè®®ï¼Œä½†å®ƒä»¬æœ‰äº›éƒ½æ²¡æœ‰è¶³å¤Ÿçš„è¯´æœåŠ›ï¼Œæœ‰äº›è¿˜ä¸å¦‚<a href="https://golang.org/issue/32437" target="_blank" rel="noopener">try_proposal</a>ã€‚å› æ­¤ï¼Œæˆ‘ä»¬æš‚æ—¶æ²¡æœ‰è¿›ä¸€æ­¥çš„è®¡åˆ’å»æ”¹å–„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œä¹Ÿè®¸æœªæ¥ä¼šå‡ºç°ä¸€äº›æ¯”è¾ƒå¥½çš„ç‚¹å­å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><h2 id="ææ¡ˆ"><a href="#ææ¡ˆ" class="headerlink" title="ææ¡ˆ"></a>ææ¡ˆ</h2><p>é‰´äºGo Moduleå’Œæ³›å‹æ­£åœ¨ç§¯æçš„æ¨è¿›ä¸­ï¼Œä¸”é”™è¯¯å¤„ç†æœºåˆ¶æ²¡æœ‰è¿›ä¸€æ­¥çš„è®¡åˆ’ï¼Œé‚£ä¹ˆè¿˜æœ‰å“ªäº›ç‰¹æ€§å€¼å¾—æˆ‘ä»¬å»å…³æ³¨å‘¢ï¼Ÿå¦‚æœéè¦è¯´æœ‰çš„è¯ï¼Œæœ‰ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­ç»ä¹…ä¸è¡°çš„ç‰¹æ€§ï¼Œä¾‹å¦‚æšä¸¾ç±»å‹å’Œä¸å¯å˜ç±»å‹çš„éœ€æ±‚ï¼Œä½†æ˜¯è¿™äº›ideaè¿˜æ²¡æœ‰è¢«Goå›¢é˜Ÿæ·±å…¥åœ°æ€è€ƒï¼Œæ‰€ä»¥Goå›¢é˜Ÿä¹Ÿæ²¡æœ‰æŠ•å…¥è¿‡å¤šç²¾åŠ›åœ¨å…¶ä¸­ï¼Œå°¤å…¶æ˜¯æ”¹è¿›è¿™äº›è¯­è¨€ç‰¹æ€§éœ€è¦å¾ˆå¤§çš„æˆæœ¬ã€‚</p><p>Go teamä¸å¸Œæœ›åœ¨æ²¡æœ‰é•¿æœŸè®¡åˆ’çš„æƒ…å†µä¸‹å¢æ·»å¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œåœ¨å®¡æ ¸äº†å¤§é‡å¯è¡Œçš„ææ¡ˆä¹‹åï¼ŒGo å›¢é˜Ÿå¾—å‡ºç»“è®ºï¼šè¿™ä¸€æ¬¡ä¸è¿›è¡Œé‡å¤§æ›´æ”¹ã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šé›†ä¸­ç²¾åŠ›åšä¸€äº›æ–°çš„ <code>go vet</code>æ”¯æŒå’Œè¯­è¨€å±‚é¢çš„ä¸€ä¸‹å°è°ƒæ•´ã€‚æˆ‘ä»¬é€‰æ‹©äº†ä»¥ä¸‹ä¸‰ä¸ªææ¡ˆï¼š</p><p><a href="https://golang.org/issue/32479" target="_blank" rel="noopener">#32479</a> <code>go vet</code>ä¸­æ”¯æŒstring(int) è½¬æ¢çš„æ£€æµ‹</p><p>æˆ‘ä»¬åŸè®¡åˆ’åœ¨å³å°†å‘å¸ƒçš„Go 1.14ç‰ˆæœ¬ä¸­å®ç°è¯¥åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æ”¾åœ¨Go 1.15ä¸­è§£å†³ã€‚string(int) è½¬æ¢åœ¨å¾ˆæ—©çš„Goç‰ˆæœ¬ä¸­å°±å·²ç»å¼•å…¥äº†ï¼Œä½†æ˜¯æœ‰äº›ç‰¹æ€§ï¼ˆstring(10)æ˜¯â€\nâ€ï¼Œå¹¶ä¸æ˜¯â€10â€ï¼‰ä¼šè®©Goæ–°æ‰‹è¿·æƒ‘ï¼Œå¹¶ä¸”unicode/utf8åŒ…ä¸­ä¹Ÿå·²ç»æä¾›äº†è¯¥åŠŸèƒ½ã€‚è‡ªä»<a href="https://golang.org/issue/3939" target="_blank" rel="noopener">removing this coversion</a>çš„ææ¡ˆä¸æ˜¯ä¸€ä¸ªå‘åå…¼å®¹çš„æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨<code>go vet</code>ä¸­æä¾›string(int)çš„é”™è¯¯æ£€æµ‹èƒ½åŠ›ã€‚</p><p><a href="https://golang.org/issue/4483" target="_blank" rel="noopener">#4483</a> <code>go vet</code>ä¸­æ”¯æŒé”™è¯¯çš„x.(T)çš„ç±»å‹æ–­è¨€</p><p>å½“å‰ï¼ŒGoå…è®¸ä»»ä½•ç±»å‹æ–­è¨€x.(T)ï¼ˆä»¥åŠç›¸åº”çš„ç±»å‹åˆ‡æ¢æƒ…å†µï¼‰ï¼Œå…¶ä¸­xå’ŒTä¸ºæ¥å£ç±»å‹ã€‚ä½†æ˜¯ï¼Œå¦‚æœxå’ŒTæœ‰ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œä½†æ˜¯ç­¾åä¸åŒï¼Œåˆ™åˆ†é…ç»™xçš„ä»»ä½•å€¼ä¹Ÿä¸èƒ½å®ç°Tï¼ˆè¿™ç§ç±»å‹çš„æ–­è¨€åœ¨è¿è¡Œæ—¶æ€»æ˜¯å¤±è´¥ï¼Œpanicæˆ–evaluate to falseï¼‰ã€‚å› ä¸ºæˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šæŠ¥å‘Šé”™ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘æŠ¥é”™ä¸æ˜¯å‘åå…¼å®¹çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå°†åœ¨<code>go vet</code>ä¸­æ·»åŠ å¯¹è¯¥æƒ…å†µçš„æ£€æŸ¥ã€‚</p><p><a href="https://golang.org/issue/28591" target="_blank" rel="noopener">#28591</a> ä½¿ç”¨å¸¸é‡å­—ç¬¦ä¸²å’Œç´¢å¼•è¿›è¡Œå¸¸é‡æ±‚å€¼çš„ç´¢å¼•å’Œåˆ‡ç‰‡è¡¨è¾¾å¼</p><p>å½“å‰ï¼Œç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå¸¸é‡ç´¢å¼•å¯¹å¸¸é‡å­—ç¬¦ä¸²è¿›è¡Œç´¢å¼•æˆ–åˆ‡ç‰‡ä¼šåˆ†åˆ«äº§ç”Ÿä¸€ä¸ªéå¸¸é‡å­—èŠ‚æˆ–å­—ç¬¦ä¸²å€¼ã€‚ ä½†æ˜¯ï¼Œå¦‚æœæ‰€æœ‰æ“ä½œæ•°éƒ½æ˜¯å¸¸é‡ï¼Œåˆ™ç¼–è¯‘å™¨å¯ä»¥å¯¹è¿™äº›è¡¨è¾¾å¼è¿›è¡Œå¸¸é‡æ±‚å€¼ï¼Œå¹¶ç”Ÿæˆå¸¸é‡ï¼ˆå¯èƒ½æ˜¯æ— ç±»å‹çš„ï¼‰ç»“æœã€‚ è¿™æ˜¯å®Œå…¨å‘åå…¼å®¹çš„æ›´æ”¹ï¼Œæˆ‘ä»¬å°†å¯¹å¼€å‘è§„èŒƒå’Œç¼–è¯‘å™¨è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚</p><h2 id="æ—¶é—´çº¿"><a href="#æ—¶é—´çº¿" class="headerlink" title="æ—¶é—´çº¿"></a>æ—¶é—´çº¿</h2><p>Go teamè®¤ä¸ºè¿™ä¸‰ä¸ªææ¡ˆåº”è¯¥æ˜¯æ²¡æœ‰ä»€ä¹ˆäº‰è®®çš„ï¼Œä½†æ˜¯äººéåœ£è´¤å­°èƒ½æ— è¿‡ï¼Œå› æ­¤æˆ‘ä»¬è®¡åˆ’åœ¨Go 1.15çš„å‘å¸ƒå‘¨æœŸå¼€å‘(Go 1.14å‘å¸ƒæ—¶æˆ–ä¹‹å)å¼€å§‹é‡‡çº³å¼€å‘è€…å¯¹è¯¥ä¸‰ä¸ªææ¡ˆçš„å»ºè®®ï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„æ—¶é—´æ”¶é›†åé¦ˆã€‚åœ¨<a href="https://blog.golang.org/go2-here-we-come" target="_blank" rel="noopener">proposal evalution process</a>ï¼Œæœ€ç»ˆçš„ææ¡ˆå°†åœ¨2020å¹´5æœˆåˆå†³å®šã€‚</p><h2 id="One-more-thingâ€¦"><a href="#One-more-thingâ€¦" class="headerlink" title="One more thingâ€¦"></a>One more thingâ€¦</h2><p>æˆ‘ä»¬æ”¶åˆ°äº†å¤§é‡çš„è¯­è¨€ç‰¹æ€§ä¿®æ­£çš„ææ¡ˆ(<a href="https://github.com/golang/go/labels/LanguageChange" target="_blank" rel="noopener">issue label LanguageChange</a>)ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰æ—¶é—´å»ä»”ç»†åœ°å½»åº•åœ°è¯„ä¼°ã€‚ä¸¾ä¸ªæ —å­ï¼Œå•æ˜¯å…³äºé”™è¯¯å¤„ç†æœºåˆ¶çš„ææ¡ˆï¼Œå°±æœ‰57ä¸ªissueï¼Œåˆ°ç›®å‰ä¸ºæ­¢è¿˜æœ‰5ä¸ªå¤„äºopençš„çŠ¶æ€ã€‚ç”±äºè¿›è¡Œè¯­è¨€æ›´æ”¹çš„æˆæœ¬ï¼Œæ— è®ºå¤§å°å¦‚ä½•ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´å…¶å®éƒ½å¾ˆé«˜ï¼Œè€Œä¸”æ”¶ç›Šå¾€å¾€å¾ˆå°ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è°¨æ…è¡Œäº‹ã€‚ç”±äºå¤§å¤šæ•°ææ¡ˆåé¦ˆçš„äººæ•°å¾ˆå°‘ï¼Œè¿™äº›ææ¡ˆéƒ½ä¼šé­åˆ°æ‹’ç»ã€‚ä½†æ˜¯æœ‰äº›å¼€å‘è€…èŠ±è´¹äº†å¤§é‡æ—¶é—´å»å†™ææ¡ˆçš„ç»†èŠ‚ï¼Œåˆ°å¤´æ¥è¿˜æ˜¯è¢«æ‹’ï¼›å¦ä¸€æ–¹é¢ï¼Œç”±äºæ€»ä½“ææ¡ˆæµç¨‹æ¯”è¾ƒç®€å•ï¼Œå› æ­¤æäº¤ä¸€äº›æ— å…³ç´§è¦çš„è¯­è¨€å˜æ›´ææ¡ˆéå¸¸å®¹æ˜“ï¼Œä»è€Œç»™å®¡æ ¸å§”å‘˜ä¼šå¸¦æ¥å¤§é‡ä¸å¿…è¦çš„å·¥ä½œï¼Œä¹Ÿæœ‰å¯èƒ½åŸ‹æ²¡æ¯”è¾ƒå¥½çš„ææ¡ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬æ–°å¢äº†ä¸€ä¸ªå…³äºGoææ¡ˆçš„<a href="https://github.com/golang/proposal/blob/master/go2-language-changes.md" target="_blank" rel="noopener">é—®å·</a>ï¼šå¡«å†™è¯¥æ¨¡æ¿å°†æœ‰åŠ©äºå®¡æ ¸è€…æ›´æœ‰æ•ˆåœ°è¯„ä¼°ææ¡ˆï¼Œå› ä¸ºä»–ä»¬æ— éœ€å°è¯•è‡ªå·±å›ç­”è¿™äº›é—®é¢˜ã€‚ å®ƒèƒ½ä»ä¸€å¼€å§‹å°±è®¾å®šä¸€äº›é™åˆ¶ï¼Œä»è€Œä¸ºæè®®è€…æä¾›æ›´å¥½çš„æŒ‡å¯¼ã€‚ è¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§çš„å°è¯•ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®éœ€è¦éšç€æ—¶é—´çš„æ¨ç§»è¿›è¡Œå®Œå–„ã€‚</p><p>æ„Ÿè°¢æ‚¨å¸®åŠ©æˆ‘ä»¬æ”¹å–„Goçš„ä½“éªŒï¼</p><hr><p>åŸæ–‡åœ°å€ï¼š<a href="https://blog.golang.org/go1.15-proposals" target="_blank" rel="noopener">https://blog.golang.org/go1.15-proposals</a></p><hr>]]></content>
    
    <summary type="html">
    
      æœ¬æ–‡æ˜¯Golangå®˜æ–¹å¯¹äºGoè¿‘æœŸç‰ˆæœ¬çš„ç°çŠ¶æ€»ç»“ä»¥åŠGo 1.15ç‰ˆæœ¬çš„ä¸€äº›ææ¡ˆï¼ŒåŸæ–‡å‘å¸ƒäº The Go Blog
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Go GC 20é—®</title>
    <link href="https://cloudsjhan.github.io/2020/01/06/Go-GC-20%E9%97%AE/"/>
    <id>https://cloudsjhan.github.io/2020/01/06/Go-GC-20é—®/</id>
    <published>2020-01-06T06:05:44.000Z</published>
    <updated>2020-01-06T13:18:19.500Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h2 id="Go-GC-20-é—®"><a href="#Go-GC-20-é—®" class="headerlink" title="Go GC 20 é—®"></a>Go GC 20 é—®</h2><p>åŸåˆ›ï¼š æ¬§é•¿å¤ ç å†œæ¡ƒèŠ±æº <a href="https://mp.weixin.qq.com/s/o2oMMh0PF5ZSoYD0XOBY2Q" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/o2oMMh0PF5ZSoYD0XOBY2Q</a></p><p>æœ¬æ–‡ä½œè€…æ¬§é•¿å¤ï¼Œå¾·å›½æ…•å°¼é»‘å¤§å­¦åœ¨è¯»åšå£«ï¼ŒGo/etcd/Tensorflow contributorï¼Œå¼€æºä¹¦ç±ã€ŠGo è¯­è¨€åŸæœ¬ã€‹ä½œè€…ï¼Œã€ŠGo å¤œè¯»ã€‹SIG æˆå‘˜/è®²å¸ˆï¼Œå¯¹ Go æœ‰å¾ˆæ·±çš„ç ”ç©¶ã€‚Githubï¼š@changkunï¼Œ<a href="https://changkun.deã€‚" target="_blank" rel="noopener">https://changkun.deã€‚</a></p><p>æœ¬æ–‡é¦–å‘äº Github å¼€æºé¡¹ç›® ã€ŠGo-Questionsã€‹ï¼Œç‚¹å‡»é˜…è¯»åŸæ–‡ç›´è¾¾ã€‚å…¨æ–‡ä¸è®¡ä»£ç ï¼Œå…± 1.7w+ å­—ï¼Œå»ºè®®æ”¶è—åç²¾è¯»ã€‚å¦å¤–ï¼Œæœ¬æ–‡ç»“å°¾æœ‰å½©è›‹ã€‚</p><p>æŒ‰æƒ¯ä¾‹ï¼Œè´´ä¸Šæœ¬æ–‡çš„ç›®å½•ï¼š</p><p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1gan2vk1a5ej30u00ojad2.jpg" alt="img"></p><blockquote><p>æœ¬æ–‡å†™äº Go 1.14 beta1ï¼Œå½“æ–‡ä¸­æåŠç›®å‰ã€ç›®å‰ç‰ˆæœ¬ç­‰å­—çœ¼æ—¶å‡æŒ‡ Go 1.14ï¼Œæ­¤å¤–ï¼Œæ–‡ä¸­æ‰€æœ‰ go å‘½ä»¤ç‰ˆæœ¬å‡ä¸º Go 1.14ã€‚</p></blockquote><h1 id="GC-çš„è®¤è¯†"><a href="#GC-çš„è®¤è¯†" class="headerlink" title="GC çš„è®¤è¯†"></a>GC çš„è®¤è¯†</h1><h2 id="1-ä»€ä¹ˆæ˜¯-GCï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ"><a href="#1-ä»€ä¹ˆæ˜¯-GCï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ" class="headerlink" title="1. ä»€ä¹ˆæ˜¯ GCï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ"></a>1. ä»€ä¹ˆæ˜¯ GCï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</h2><p><code>GC</code>ï¼Œå…¨ç§° <code>Garbage Collection</code>ï¼Œå³åƒåœ¾å›æ”¶ï¼Œæ˜¯ä¸€ç§è‡ªåŠ¨å†…å­˜ç®¡ç†çš„æœºåˆ¶ã€‚</p><p>å½“ç¨‹åºå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜ä¸å†éœ€è¦æ—¶ï¼Œåƒåœ¾å›æ”¶ä¸»åŠ¨å°†å…¶å›æ”¶å¹¶ä¾›å…¶ä»–ä»£ç è¿›è¡Œå†…å­˜ç”³è¯·æ—¶å€™å¤ç”¨ï¼Œæˆ–è€…å°†å…¶å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™ç§é’ˆå¯¹å†…å­˜çº§åˆ«èµ„æºçš„è‡ªåŠ¨å›æ”¶è¿‡ç¨‹ï¼Œå³ä¸ºåƒåœ¾å›æ”¶ã€‚è€Œè´Ÿè´£åƒåœ¾å›æ”¶çš„ç¨‹åºç»„ä»¶ï¼Œå³ä¸ºåƒåœ¾å›æ”¶å™¨ã€‚</p><p>åƒåœ¾å›æ”¶å…¶å®ä¸€ä¸ªå®Œç¾çš„ â€œSimplicity is Complicatedâ€ çš„ä¾‹å­ã€‚ä¸€æ–¹é¢ï¼Œç¨‹åºå‘˜å—ç›Šäº GCï¼Œæ— éœ€æ“å¿ƒã€ä¹Ÿä¸å†éœ€è¦å¯¹å†…å­˜è¿›è¡Œæ‰‹åŠ¨çš„ç”³è¯·å’Œé‡Šæ”¾æ“ä½œï¼ŒGC åœ¨ç¨‹åºè¿è¡Œæ—¶è‡ªåŠ¨é‡Šæ”¾æ®‹ç•™çš„å†…å­˜ã€‚å¦ä¸€æ–¹é¢ï¼ŒGC å¯¹ç¨‹åºå‘˜å‡ ä¹ä¸å¯è§ï¼Œä»…åœ¨ç¨‹åºéœ€è¦è¿›è¡Œç‰¹æ®Šä¼˜åŒ–æ—¶ï¼Œé€šè¿‡æä¾›å¯è°ƒæ§çš„ APIï¼Œå¯¹ GC çš„è¿è¡Œæ—¶æœºã€è¿è¡Œå¼€é”€è¿›è¡ŒæŠŠæ§çš„æ—¶å€™æ‰å¾—ä»¥ç°èº«ã€‚</p><p>é€šå¸¸ï¼Œåƒåœ¾å›æ”¶å™¨çš„æ‰§è¡Œè¿‡ç¨‹è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªåŠç‹¬ç«‹çš„ç»„ä»¶ï¼š</p><ul><li>èµ‹å€¼å™¨ï¼ˆMutatorï¼‰ï¼šè¿™ä¸€åç§°æœ¬è´¨ä¸Šæ˜¯åœ¨æŒ‡ä»£ç”¨æˆ·æ€çš„ä»£ç ã€‚å› ä¸ºå¯¹åƒåœ¾å›æ”¶å™¨è€Œè¨€ï¼Œç”¨æˆ·æ€çš„ä»£ç ä»…ä»…åªæ˜¯åœ¨ä¿®æ”¹å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯¹è±¡å›¾ï¼ˆå¯¹è±¡ä¹‹é—´å¼•ç”¨å…³ç³»çš„ä¸€ä¸ªæœ‰å‘å›¾ï¼‰ä¸Šè¿›è¡Œæ“ä½œã€‚</li><li>å›æ”¶å™¨ï¼ˆCollectorï¼‰ï¼šè´Ÿè´£æ‰§è¡Œåƒåœ¾å›æ”¶çš„ä»£ç ã€‚</li></ul><h2 id="2-æ ¹å¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#2-æ ¹å¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="2. æ ¹å¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ"></a>2. æ ¹å¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æ ¹å¯¹è±¡åœ¨åƒåœ¾å›æ”¶çš„æœ¯è¯­ä¸­åˆå«åšæ ¹é›†åˆï¼Œå®ƒæ˜¯åƒåœ¾å›æ”¶å™¨åœ¨æ ‡è®°è¿‡ç¨‹æ—¶æœ€å…ˆæ£€æŸ¥çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ï¼š</p><ol><li>å…¨å±€å˜é‡ï¼šç¨‹åºåœ¨ç¼–è¯‘æœŸå°±èƒ½ç¡®å®šçš„é‚£äº›å­˜åœ¨äºç¨‹åºæ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å˜é‡ã€‚</li><li>æ‰§è¡Œæ ˆï¼šæ¯ä¸ª goroutine éƒ½åŒ…å«è‡ªå·±çš„æ‰§è¡Œæ ˆï¼Œè¿™äº›æ‰§è¡Œæ ˆä¸ŠåŒ…å«æ ˆä¸Šçš„å˜é‡åŠæŒ‡å‘åˆ†é…çš„å †å†…å­˜åŒºå—çš„æŒ‡é’ˆã€‚</li><li>å¯„å­˜å™¨ï¼šå¯„å­˜å™¨çš„å€¼å¯èƒ½è¡¨ç¤ºä¸€ä¸ªæŒ‡é’ˆï¼Œå‚ä¸è®¡ç®—çš„è¿™äº›æŒ‡é’ˆå¯èƒ½æŒ‡å‘æŸäº›èµ‹å€¼å™¨åˆ†é…çš„å †å†…å­˜åŒºå—ã€‚</li></ol><h2 id="3-å¸¸è§çš„-GC-å®ç°æ–¹å¼æœ‰å“ªäº›ï¼ŸGo-è¯­è¨€çš„-GC-ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#3-å¸¸è§çš„-GC-å®ç°æ–¹å¼æœ‰å“ªäº›ï¼ŸGo-è¯­è¨€çš„-GC-ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="3. å¸¸è§çš„ GC å®ç°æ–¹å¼æœ‰å“ªäº›ï¼ŸGo è¯­è¨€çš„ GC ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ"></a>3. å¸¸è§çš„ GC å®ç°æ–¹å¼æœ‰å“ªäº›ï¼ŸGo è¯­è¨€çš„ GC ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>æ‰€æœ‰çš„ GC ç®—æ³•å…¶å­˜åœ¨å½¢å¼å¯ä»¥å½’ç»“ä¸ºè¿½è¸ªï¼ˆTracingï¼‰å’Œå¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰è¿™ä¸¤ç§å½¢å¼çš„æ··åˆè¿ç”¨ã€‚</p><ul><li><p>è¿½è¸ªå¼ GC </p><p>ä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œæ ¹æ®å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ä¿¡æ¯ï¼Œä¸€æ­¥æ­¥æ¨è¿›ç›´åˆ°æ‰«æå®Œæ¯•æ•´ä¸ªå †å¹¶ç¡®å®šéœ€è¦ä¿ç•™çš„å¯¹è±¡ï¼Œä»è€Œå›æ”¶æ‰€æœ‰å¯å›æ”¶çš„å¯¹è±¡ã€‚Goã€ Javaã€V8 å¯¹ JavaScript çš„å®ç°ç­‰å‡ä¸ºè¿½è¸ªå¼ GCã€‚</p></li><li><p>å¼•ç”¨è®¡æ•°å¼ GC</p><p>æ¯ä¸ªå¯¹è±¡è‡ªèº«åŒ…å«ä¸€ä¸ªè¢«å¼•ç”¨çš„è®¡æ•°å™¨ï¼Œå½“è®¡æ•°å™¨å½’é›¶æ—¶è‡ªåŠ¨å¾—åˆ°å›æ”¶ã€‚å› ä¸ºæ­¤æ–¹æ³•ç¼ºé™·è¾ƒå¤šï¼Œåœ¨è¿½æ±‚é«˜æ€§èƒ½æ—¶é€šå¸¸ä¸è¢«åº”ç”¨ã€‚Pythonã€Objective-C ç­‰å‡ä¸ºå¼•ç”¨è®¡æ•°å¼ GCã€‚</p></li></ul><p>ç›®å‰æ¯”è¾ƒå¸¸è§çš„ GC å®ç°æ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li>è¿½è¸ªå¼ï¼Œåˆ†ä¸ºå¤šç§ä¸åŒç±»å‹ï¼Œä¾‹å¦‚ï¼š<ul><li>æ ‡è®°æ¸…æ‰«ï¼šä»æ ¹å¯¹è±¡å‡ºå‘ï¼Œå°†ç¡®å®šå­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œå¹¶æ¸…æ‰«å¯ä»¥å›æ”¶çš„å¯¹è±¡ã€‚</li><li>æ ‡è®°æ•´ç†ï¼šä¸ºäº†è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜è€Œæå‡ºï¼Œåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå°†å¯¹è±¡å°½å¯èƒ½æ•´ç†åˆ°ä¸€å—è¿ç»­çš„å†…å­˜ä¸Šã€‚</li><li>å¢é‡å¼ï¼šå°†æ ‡è®°ä¸æ¸…æ‰«çš„è¿‡ç¨‹åˆ†æ‰¹æ‰§è¡Œï¼Œæ¯æ¬¡æ‰§è¡Œå¾ˆå°çš„éƒ¨åˆ†ï¼Œä»è€Œå¢é‡çš„æ¨è¿›åƒåœ¾å›æ”¶ï¼Œè¾¾åˆ°è¿‘ä¼¼å®æ—¶ã€å‡ ä¹æ— åœé¡¿çš„ç›®çš„ã€‚</li><li>å¢é‡æ•´ç†ï¼šåœ¨å¢é‡å¼çš„åŸºç¡€ä¸Šï¼Œå¢åŠ å¯¹å¯¹è±¡çš„æ•´ç†è¿‡ç¨‹ã€‚</li><li>åˆ†ä»£å¼ï¼šå°†å¯¹è±¡æ ¹æ®å­˜æ´»æ—¶é—´çš„é•¿çŸ­è¿›è¡Œåˆ†ç±»ï¼Œå­˜æ´»æ—¶é—´å°äºæŸä¸ªå€¼çš„ä¸ºå¹´è½»ä»£ï¼Œå­˜æ´»æ—¶é—´å¤§äºæŸä¸ªå€¼çš„ä¸ºè€å¹´ä»£ï¼Œæ°¸è¿œä¸ä¼šå‚ä¸å›æ”¶çš„å¯¹è±¡ä¸ºæ°¸ä¹…ä»£ã€‚å¹¶æ ¹æ®åˆ†ä»£å‡è®¾ï¼ˆå¦‚æœä¸€ä¸ªå¯¹è±¡å­˜æ´»æ—¶é—´ä¸é•¿åˆ™å€¾å‘äºè¢«å›æ”¶ï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å·²ç»å­˜æ´»å¾ˆé•¿æ—¶é—´åˆ™å€¾å‘äºå­˜æ´»æ›´é•¿æ—¶é—´ï¼‰å¯¹å¯¹è±¡è¿›è¡Œå›æ”¶ã€‚</li></ul></li><li>å¼•ç”¨è®¡æ•°ï¼šæ ¹æ®å¯¹è±¡è‡ªèº«çš„å¼•ç”¨è®¡æ•°æ¥å›æ”¶ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶ç«‹å³å›æ”¶ã€‚</li></ul><p>å…³äºå„ç±»æ–¹æ³•çš„è¯¦ç»†ä»‹ç»åŠå…¶å®ç°ä¸åœ¨æœ¬æ–‡ä¸­è¯¦ç»†è®¨è®ºã€‚å¯¹äº Go è€Œè¨€ï¼ŒGo çš„ GC ç›®å‰ä½¿ç”¨çš„æ˜¯æ— åˆ†ä»£ï¼ˆå¯¹è±¡æ²¡æœ‰ä»£é™…ä¹‹åˆ†ï¼‰ã€ä¸æ•´ç†ï¼ˆå›æ”¶è¿‡ç¨‹ä¸­ä¸å¯¹å¯¹è±¡è¿›è¡Œç§»åŠ¨ä¸æ•´ç†ï¼‰ã€å¹¶å‘ï¼ˆä¸ç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼‰çš„ä¸‰è‰²æ ‡è®°æ¸…æ‰«ç®—æ³•ã€‚<a href="https://groups.google.com/d/msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ" target="_blank" rel="noopener">åŸå› </a>åœ¨äºï¼š</p><ol><li>å¯¹è±¡æ•´ç†çš„ä¼˜åŠ¿æ˜¯è§£å†³å†…å­˜ç¢ç‰‡é—®é¢˜ä»¥åŠâ€œå…è®¸â€ä½¿ç”¨é¡ºåºå†…å­˜åˆ†é…å™¨ã€‚ä½† Go è¿è¡Œæ—¶çš„åˆ†é…ç®—æ³•åŸºäº tcmallocï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰ç¢ç‰‡é—®é¢˜ã€‚ å¹¶ä¸”é¡ºåºå†…å­˜åˆ†é…å™¨åœ¨å¤šçº¿ç¨‹çš„åœºæ™¯ä¸‹å¹¶ä¸é€‚ç”¨ã€‚Go ä½¿ç”¨çš„æ˜¯åŸºäº tcmalloc çš„ç°ä»£å†…å­˜åˆ†é…ç®—æ³•ï¼Œå¯¹å¯¹è±¡è¿›è¡Œæ•´ç†ä¸ä¼šå¸¦æ¥å®è´¨æ€§çš„æ€§èƒ½æå‡ã€‚</li><li>åˆ†ä»£ GC ä¾èµ–åˆ†ä»£å‡è®¾ï¼Œå³ GC å°†ä¸»è¦çš„å›æ”¶ç›®æ ‡æ”¾åœ¨æ–°åˆ›å»ºçš„å¯¹è±¡ä¸Šï¼ˆå­˜æ´»æ—¶é—´çŸ­ï¼Œæ›´å€¾å‘äºè¢«å›æ”¶ï¼‰ï¼Œè€Œéé¢‘ç¹æ£€æŸ¥æ‰€æœ‰å¯¹è±¡ã€‚ä½† Go çš„ç¼–è¯‘å™¨ä¼šé€šè¿‡<strong>é€ƒé€¸åˆ†æ</strong>å°†å¤§éƒ¨åˆ†æ–°ç”Ÿå¯¹è±¡å­˜å‚¨åœ¨æ ˆä¸Šï¼ˆæ ˆç›´æ¥è¢«å›æ”¶ï¼‰ï¼Œåªæœ‰é‚£äº›éœ€è¦é•¿æœŸå­˜åœ¨çš„å¯¹è±¡æ‰ä¼šè¢«åˆ†é…åˆ°éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶çš„å †ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†ä»£ GC å›æ”¶çš„é‚£äº›å­˜æ´»æ—¶é—´çŸ­çš„å¯¹è±¡åœ¨ Go ä¸­æ˜¯ç›´æ¥è¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œå½“ goroutine æ­»äº¡åæ ˆä¹Ÿä¼šè¢«ç›´æ¥å›æ”¶ï¼Œä¸éœ€è¦ GC çš„å‚ä¸ï¼Œè¿›è€Œåˆ†ä»£å‡è®¾å¹¶æ²¡æœ‰å¸¦æ¥ç›´æ¥ä¼˜åŠ¿ã€‚å¹¶ä¸” Go çš„åƒåœ¾å›æ”¶å™¨ä¸ç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼Œä½¿å¾— STW çš„æ—¶é—´ä¸å¯¹è±¡çš„ä»£é™…ã€å¯¹è±¡çš„ size æ²¡æœ‰å…³ç³»ã€‚Go å›¢é˜Ÿæ›´å…³æ³¨äºå¦‚ä½•æ›´å¥½åœ°è®© GC ä¸ç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼ˆä½¿ç”¨é€‚å½“çš„ CPU æ¥æ‰§è¡Œåƒåœ¾å›æ”¶ï¼‰ï¼Œè€Œéå‡å°‘åœé¡¿æ—¶é—´è¿™ä¸€å•ä¸€ç›®æ ‡ä¸Šã€‚</li></ol><h2 id="4-ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#4-ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="4. ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä»€ä¹ˆï¼Ÿ"></a>4. ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ç†è§£<strong>ä¸‰è‰²æ ‡è®°æ³•</strong>çš„å…³é”®æ˜¯ç†è§£å¯¹è±¡çš„<strong>ä¸‰è‰²æŠ½è±¡</strong>ä»¥åŠ<strong>æ³¢é¢ï¼ˆwavefrontï¼‰æ¨è¿›</strong>è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚ä¸‰è‰²æŠ½è±¡åªæ˜¯ä¸€ç§æè¿°è¿½è¸ªå¼å›æ”¶å™¨çš„æ–¹æ³•ï¼Œåœ¨å®è·µä¸­å¹¶æ²¡æœ‰å®é™…å«ä¹‰ï¼Œå®ƒçš„é‡è¦ä½œç”¨åœ¨äºä»é€»è¾‘ä¸Šä¸¥å¯†æ¨å¯¼æ ‡è®°æ¸…ç†è¿™ç§åƒåœ¾å›æ”¶æ–¹æ³•çš„æ­£ç¡®æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è°ˆåŠä¸‰è‰²æ ‡è®°æ³•æ—¶ï¼Œé€šå¸¸æŒ‡æ ‡è®°æ¸…æ‰«çš„åƒåœ¾å›æ”¶ã€‚</p><p>ä»åƒåœ¾å›æ”¶å™¨çš„è§†è§’æ¥çœ‹ï¼Œä¸‰è‰²æŠ½è±¡è§„å®šäº†ä¸‰ç§ä¸åŒç±»å‹çš„å¯¹è±¡ï¼Œå¹¶ç”¨ä¸åŒçš„é¢œè‰²ç›¸ç§°ï¼š</p><ul><li>ç™½è‰²å¯¹è±¡ï¼ˆå¯èƒ½æ­»äº¡ï¼‰ï¼šæœªè¢«å›æ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ã€‚åœ¨å›æ”¶å¼€å§‹é˜¶æ®µï¼Œæ‰€æœ‰å¯¹è±¡å‡ä¸ºç™½è‰²ï¼Œå½“å›æ”¶ç»“æŸåï¼Œç™½è‰²å¯¹è±¡å‡ä¸å¯è¾¾ã€‚</li><li>ç°è‰²å¯¹è±¡ï¼ˆæ³¢é¢ï¼‰ï¼šå·²è¢«å›æ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œä½†å›æ”¶å™¨éœ€è¦å¯¹å…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡é’ˆè¿›è¡Œæ‰«æï¼Œå› ä¸ºä»–ä»¬å¯èƒ½è¿˜æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚</li><li>é»‘è‰²å¯¹è±¡ï¼ˆç¡®å®šå­˜æ´»ï¼‰ï¼šå·²è¢«å›æ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œå…¶ä¸­æ‰€æœ‰å­—æ®µéƒ½å·²è¢«æ‰«æï¼Œé»‘è‰²å¯¹è±¡ä¸­ä»»ä½•ä¸€ä¸ªæŒ‡é’ˆéƒ½ä¸å¯èƒ½ç›´æ¥æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚</li></ul><p>è¿™æ ·ä¸‰ç§ä¸å˜æ€§æ‰€å®šä¹‰çš„å›æ”¶è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ª<strong>æ³¢é¢</strong>ä¸æ–­å‰è¿›çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªæ³¢é¢åŒæ—¶ä¹Ÿæ˜¯é»‘è‰²å¯¹è±¡å’Œç™½è‰²å¯¹è±¡çš„è¾¹ç•Œï¼Œç°è‰²å¯¹è±¡å°±æ˜¯è¿™ä¸ªæ³¢é¢ã€‚</p><p>å½“åƒåœ¾å›æ”¶å¼€å§‹æ—¶ï¼Œåªæœ‰ç™½è‰²å¯¹è±¡ã€‚éšç€æ ‡è®°è¿‡ç¨‹å¼€å§‹è¿›è¡Œæ—¶ï¼Œç°è‰²å¯¹è±¡å¼€å§‹å‡ºç°ï¼ˆç€è‰²ï¼‰ï¼Œè¿™æ—¶å€™æ³¢é¢ä¾¿å¼€å§‹æ‰©å¤§ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å­èŠ‚ç‚¹å‡å®Œæˆæ‰«ææ—¶ï¼Œä¼šè¢«ç€è‰²ä¸ºé»‘è‰²ã€‚å½“æ•´ä¸ªå †éå†å®Œæˆæ—¶ï¼Œåªå‰©ä¸‹é»‘è‰²å’Œç™½è‰²å¯¹è±¡ï¼Œè¿™æ—¶çš„é»‘è‰²å¯¹è±¡ä¸ºå¯è¾¾å¯¹è±¡ï¼Œå³å­˜æ´»ï¼›è€Œç™½è‰²å¯¹è±¡ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³æ­»äº¡ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥è§†ä¸ºä»¥ç°è‰²å¯¹è±¡ä¸ºæ³¢é¢ï¼Œå°†é»‘è‰²å¯¹è±¡å’Œç™½è‰²å¯¹è±¡åˆ†ç¦»ï¼Œä½¿æ³¢é¢ä¸æ–­å‘å‰æ¨è¿›ï¼Œç›´åˆ°æ‰€æœ‰å¯è¾¾çš„ç°è‰²å¯¹è±¡éƒ½å˜ä¸ºé»‘è‰²å¯¹è±¡ä¸ºæ­¢çš„è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://user-images.githubusercontent.com/7698088/70995777-505fc800-210c-11ea-9f6d-3549f884ff46.png" alt="ä¸‰è‰²æ ‡è®°æ³•å…¨è²Œ"></p><p>å›¾ä¸­å±•ç¤ºäº†æ ¹å¯¹è±¡ã€å¯è¾¾å¯¹è±¡ã€ä¸å¯è¾¾å¯¹è±¡ï¼Œé»‘ã€ç°ã€ç™½å¯¹è±¡ä»¥åŠæ³¢é¢ä¹‹é—´çš„å…³ç³»ã€‚</p><h2 id="5-STW-æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"><a href="#5-STW-æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ" class="headerlink" title="5. STW æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ"></a>5. STW æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ</h2><p><code>STW</code> æ˜¯ <code>Stop the World</code> çš„ç¼©å†™ï¼Œå³ä¸‡ç‰©é™æ­¢ï¼Œæ˜¯æŒ‡åœ¨åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ä¸ºäº†ä¿è¯å®ç°çš„æ­£ç¡®æ€§ã€é˜²æ­¢æ— æ­¢å¢ƒçš„å†…å­˜å¢é•¿ç­‰é—®é¢˜è€Œä¸å¯é¿å…çš„éœ€è¦åœæ­¢èµ‹å€¼å™¨è¿›ä¸€æ­¥æ“ä½œå¯¹è±¡å›¾çš„ä¸€æ®µè¿‡ç¨‹ã€‚</p><p>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ•´ä¸ªç”¨æˆ·ä»£ç è¢«åœæ­¢æˆ–è€…æ”¾ç¼“æ‰§è¡Œï¼Œ <code>STW</code> è¶Šé•¿ï¼Œå¯¹ç”¨æˆ·ä»£ç é€ æˆçš„å½±å“ï¼ˆä¾‹å¦‚å»¶è¿Ÿï¼‰å°±è¶Šå¤§ï¼Œæ—©æœŸ Go å¯¹åƒåœ¾å›æ”¶å™¨çš„å®ç°ä¸­ <code>STW</code> é•¿è¾¾å‡ ç™¾æ¯«ç§’ï¼Œå¯¹æ—¶é—´æ•æ„Ÿçš„å®æ—¶é€šä¿¡ç­‰åº”ç”¨ç¨‹åºä¼šé€ æˆå·¨å¤§çš„å½±å“ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">time.Sleep(time.Millisecond)</span><br><span class="line">runtime.GC()</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"OK"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„è¿™ä¸ªç¨‹åºåœ¨ Go 1.14 ä»¥å‰æ°¸è¿œéƒ½ä¸ä¼šè¾“å‡º <code>OK</code>ï¼Œå…¶ç½ªé­ç¥¸é¦–æ˜¯ STW æ— é™åˆ¶çš„è¢«å»¶é•¿ã€‚</p><p>å°½ç®¡ STW å¦‚ä»Šå·²ç»ä¼˜åŒ–åˆ°äº†åŠæ¯«ç§’çº§åˆ«ä»¥ä¸‹ï¼Œä½†è¿™ä¸ªç¨‹åºè¢«å¡æ­»åŸå› åœ¨äºä»ç„¶æ˜¯ STW å¯¼è‡´çš„ã€‚åŸå› åœ¨äºï¼ŒGC åœ¨è¿›å…¥ STW æ—¶ï¼Œéœ€è¦ç­‰å¾…è®©æ‰€æœ‰çš„ç”¨æˆ·æ€ä»£ç åœæ­¢ï¼Œä½†æ˜¯ <code>for {}</code> æ‰€åœ¨çš„ goroutine æ°¸è¿œéƒ½ä¸ä¼šè¢«ä¸­æ–­ï¼Œä»è€Œåœç•™åœ¨ STW é˜¶æ®µã€‚å®é™…å®è·µä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå½“ç¨‹åºçš„æŸä¸ª goroutine é•¿æ—¶é—´å¾—ä¸åˆ°åœæ­¢ï¼Œå¼ºè¡Œæ‹–æ…¢ STWï¼Œè¿™ç§æƒ…å†µä¸‹é€ æˆçš„å½±å“ï¼ˆå¡æ­»ï¼‰æ˜¯éå¸¸å¯æ€•çš„ã€‚å¥½åœ¨è‡ª Go 1.14 ä¹‹åï¼Œè¿™ç±» goroutine èƒ½å¤Ÿè¢«å¼‚æ­¥åœ°æŠ¢å ï¼Œä»è€Œä½¿å¾— STW çš„æ—¶é—´å¦‚åŒæ™®é€šç¨‹åºé‚£æ ·ï¼Œä¸ä¼šè¶…è¿‡åŠä¸ªæ¯«ç§’ï¼Œç¨‹åºä¹Ÿä¸ä¼šå› ä¸ºä»…ä»…ç­‰å¾…ä¸€ä¸ª goroutine çš„åœæ­¢è€Œåœé¡¿åœ¨ STW é˜¶æ®µã€‚</p><h2 id="6-å¦‚ä½•è§‚å¯Ÿ-Go-GCï¼Ÿ"><a href="#6-å¦‚ä½•è§‚å¯Ÿ-Go-GCï¼Ÿ" class="headerlink" title="6. å¦‚ä½•è§‚å¯Ÿ Go GCï¼Ÿ"></a>6. å¦‚ä½•è§‚å¯Ÿ Go GCï¼Ÿ</h2><p>æˆ‘ä»¬ä»¥ä¸‹é¢çš„ç¨‹åºä¸ºä¾‹ï¼Œå…ˆä½¿ç”¨å››ç§ä¸åŒçš„æ–¹å¼æ¥ä»‹ç»å¦‚ä½•è§‚å¯Ÿ GCï¼Œå¹¶åœ¨åé¢çš„é—®é¢˜ä¸­é€šè¿‡å‡ ä¸ªè¯¦ç»†çš„ä¾‹å­å†æ¥è®¨è®ºå¦‚ä½•ä¼˜åŒ– GCã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">allocate</span><span class="params">()</span></span> &#123;</span><br><span class="line">_ = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> n := <span class="number">1</span>; n &lt; <span class="number">100000</span>; n++ &#123;</span><br><span class="line">allocate()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹å¼1ï¼šGODEBUG-gctrace-1"><a href="#æ–¹å¼1ï¼šGODEBUG-gctrace-1" class="headerlink" title="æ–¹å¼1ï¼šGODEBUG=gctrace=1"></a>æ–¹å¼1ï¼š<code>GODEBUG=gctrace=1</code></h3><p>æˆ‘ä»¬é¦–å…ˆå¯ä»¥é€šè¿‡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o main</span><br><span class="line">$ GODEBUG=gctrace=1 ./main</span><br><span class="line"></span><br><span class="line">gc 1 @0.000s 2%: 0.009+0.23+0.004 ms clock, 0.11+0.083/0.019/0.14+0.049 ms cpu, 4-&gt;6-&gt;2 MB, 5 MB goal, 12 P</span><br><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB)</span><br><span class="line">gc 2 @0.001s 2%: 0.018+1.1+0.029 ms clock, 0.22+0.047/0.074/0.048+0.34 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P</span><br><span class="line">scvg: inuse: 3, idle: 60, sys: 63, released: 56, consumed: 7 (MB)</span><br><span class="line">gc 3 @0.003s 2%: 0.018+0.59+0.011 ms clock, 0.22+0.073/0.008/0.042+0.13 ms cpu, 5-&gt;6-&gt;1 MB, 6 MB goal, 12 P</span><br><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 2, idle: 61, sys: 63, released: 56, consumed: 7 (MB)</span><br><span class="line">gc 4 @0.003s 4%: 0.019+0.70+0.054 ms clock, 0.23+0.051/0.047/0.085+0.65 ms cpu, 4-&gt;6-&gt;2 MB, 5 MB goal, 12 P</span><br><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 3, idle: 60, sys: 63, released: 56, consumed: 7 (MB)</span><br><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 4, idle: 59, sys: 63, released: 56, consumed: 7 (MB)</span><br><span class="line">gc 5 @0.004s 12%: 0.021+0.26+0.49 ms clock, 0.26+0.046/0.037/0.11+5.8 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P</span><br><span class="line">scvg: inuse: 5, idle: 58, sys: 63, released: 56, consumed: 7 (MB)</span><br><span class="line">gc 6 @0.005s 12%: 0.020+0.17+0.004 ms clock, 0.25+0.080/0.070/0.053+0.051 ms cpu, 5-&gt;6-&gt;1 MB, 6 MB goal, 12 P</span><br><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 1, idle: 62, sys: 63, released: 56, consumed: 7 (MB)</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªæ—¥å¿—ä¸­å¯ä»¥è§‚å¯Ÿåˆ°ä¸¤ç±»ä¸åŒçš„ä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gc 1 @0.000s 2%: 0.009+0.23+0.004 ms clock, 0.11+0.083/0.019/0.14+0.049 ms cpu, 4-&gt;6-&gt;2 MB, 5 MB goal, 12 P</span><br><span class="line">gc 2 @0.001s 2%: 0.018+1.1+0.029 ms clock, 0.22+0.047/0.074/0.048+0.34 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>ä»¥åŠï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB)</span><br><span class="line">scvg: inuse: 3, idle: 60, sys: 63, released: 56, consumed: 7 (MB)</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å¯¹äºç”¨æˆ·ä»£ç å‘è¿è¡Œæ—¶ç”³è¯·å†…å­˜äº§ç”Ÿçš„åƒåœ¾å›æ”¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gc 2 @0.001s 2%: 0.018+1.1+0.029 ms clock, 0.22+0.047/0.074/0.048+0.34 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P</span><br></pre></td></tr></table></figure><p>å«ä¹‰ç”±ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:left">å­—æ®µ</th><th style="text-align:left">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:left">gc 2</td><td style="text-align:left">ç¬¬äºŒä¸ª GC å‘¨æœŸ</td></tr><tr><td style="text-align:left">0.001</td><td style="text-align:left">ç¨‹åºå¼€å§‹åçš„ 0.001 ç§’</td></tr><tr><td style="text-align:left">2%</td><td style="text-align:left">è¯¥ GC å‘¨æœŸä¸­ CPU çš„ä½¿ç”¨ç‡</td></tr><tr><td style="text-align:left">0.018</td><td style="text-align:left">æ ‡è®°å¼€å§‹æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆwall clockï¼‰</td></tr><tr><td style="text-align:left">1.1</td><td style="text-align:left">æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå¹¶å‘æ ‡è®°æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆwall clockï¼‰</td></tr><tr><td style="text-align:left">0.029</td><td style="text-align:left">æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆwall clockï¼‰</td></tr><tr><td style="text-align:left">0.22</td><td style="text-align:left">æ ‡è®°å¼€å§‹æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰</td></tr><tr><td style="text-align:left">0.047</td><td style="text-align:left">æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œæ ‡è®°è¾…åŠ©æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰</td></tr><tr><td style="text-align:left">0.074</td><td style="text-align:left">æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå¹¶å‘æ ‡è®°æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰</td></tr><tr><td style="text-align:left">0.048</td><td style="text-align:left">æ ‡è®°è¿‡ç¨‹ä¸­ï¼ŒGC ç©ºé—²çš„æ—¶é—´ï¼ˆcpu timeï¼‰</td></tr><tr><td style="text-align:left">0.34</td><td style="text-align:left">æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰</td></tr><tr><td style="text-align:left">4</td><td style="text-align:left">æ ‡è®°å¼€å§‹æ—¶ï¼Œå †çš„å¤§å°çš„å®é™…å€¼</td></tr><tr><td style="text-align:left">7</td><td style="text-align:left">æ ‡è®°ç»“æŸæ—¶ï¼Œå †çš„å¤§å°çš„å®é™…å€¼</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left">æ ‡è®°ç»“æŸæ—¶ï¼Œæ ‡è®°ä¸ºå­˜æ´»çš„å¯¹è±¡å¤§å°</td></tr><tr><td style="text-align:left">5</td><td style="text-align:left">æ ‡è®°ç»“æŸæ—¶ï¼Œå †çš„å¤§å°çš„é¢„æµ‹å€¼</td></tr><tr><td style="text-align:left">12</td><td style="text-align:left">P çš„æ•°é‡</td></tr></tbody></table><blockquote><p>wall clock æ˜¯æŒ‡å¼€å§‹æ‰§è¡Œåˆ°å®Œæˆæ‰€ç»å†çš„å®é™…æ—¶é—´ï¼ŒåŒ…æ‹¬å…¶ä»–ç¨‹åºå’Œæœ¬ç¨‹åºæ‰€æ¶ˆè€—çš„æ—¶é—´ï¼›<br>cpu time æ˜¯æŒ‡ç‰¹å®šç¨‹åºä½¿ç”¨ CPU çš„æ—¶é—´ï¼›<br>ä»–ä»¬å­˜åœ¨ä»¥ä¸‹å…³ç³»ï¼š</p><ul><li>wall clock &lt; cpu time: å……åˆ†åˆ©ç”¨å¤šæ ¸</li><li>wall clock â‰ˆ cpu time: æœªå¹¶è¡Œæ‰§è¡Œ</li><li>wall clock &gt; cpu time: å¤šæ ¸ä¼˜åŠ¿ä¸æ˜æ˜¾</li></ul></blockquote><p>å¯¹äºè¿è¡Œæ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜äº§ç”Ÿçš„åƒåœ¾å›æ”¶ï¼ˆå‘æ“ä½œç³»ç»Ÿå½’è¿˜å¤šä½™çš„å†…å­˜ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB)</span><br></pre></td></tr></table></figure><p>å«ä¹‰ç”±ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:left">å­—æ®µ</th><th style="text-align:left">å«ä¹‰</th></tr></thead><tbody><tr><td style="text-align:left">8 KB released</td><td style="text-align:left">å‘æ“ä½œç³»ç»Ÿå½’è¿˜äº† 8 KB å†…å­˜</td></tr><tr><td style="text-align:left">3</td><td style="text-align:left">å·²ç»åˆ†é…ç»™ç”¨æˆ·ä»£ç ã€æ­£åœ¨ä½¿ç”¨çš„æ€»å†…å­˜å¤§å° (MB)ã€‚MB used or partially used spans</td></tr><tr><td style="text-align:left">60</td><td style="text-align:left">ç©ºé—²ä»¥åŠç­‰å¾…å½’è¿˜ç»™æ“ä½œç³»ç»Ÿçš„æ€»å†…å­˜å¤§å°ï¼ˆMBï¼‰ã€‚MB spans pending scavenging</td></tr><tr><td style="text-align:left">63</td><td style="text-align:left">é€šçŸ¥æ“ä½œç³»ç»Ÿä¸­ä¿ç•™çš„å†…å­˜å¤§å°ï¼ˆMBï¼‰MB mapped from the system</td></tr><tr><td style="text-align:left">57</td><td style="text-align:left">å·²ç»å½’è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ï¼ˆæˆ–è€…è¯´è¿˜æœªæ­£å¼ç”³è¯·ï¼‰çš„å†…å­˜å¤§å°ï¼ˆMBï¼‰ã€‚MB released to the system</td></tr><tr><td style="text-align:left">6</td><td style="text-align:left">å·²ç»ä»æ“ä½œç³»ç»Ÿä¸­ç”³è¯·çš„å†…å­˜å¤§å°ï¼ˆMBï¼‰ã€‚MB allocated from the system</td></tr></tbody></table><h3 id="æ–¹å¼2ï¼šgo-tool-trace"><a href="#æ–¹å¼2ï¼šgo-tool-trace" class="headerlink" title="æ–¹å¼2ï¼šgo tool trace"></a>æ–¹å¼2ï¼š<code>go tool trace</code></h3><p><code>go tool trace</code> çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†ç»Ÿè®¡è€Œæ¥çš„ä¿¡æ¯ä»¥ä¸€ç§å¯è§†åŒ–çš„æ–¹å¼å±•ç¤ºç»™ç”¨æˆ·ã€‚è¦ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ trace APIï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.Create(<span class="string">"trace.out"</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">trace.Start(f)</span><br><span class="line"><span class="keyword">defer</span> trace.Stop()</span><br><span class="line">(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¹¶é€šè¿‡ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go tool trace trace.out</span><br><span class="line">2019/12/30 15:50:33 Parsing trace...</span><br><span class="line">2019/12/30 15:50:38 Splitting trace...</span><br><span class="line">2019/12/30 15:50:45 Opening browser. Trace viewer is listening on http://127.0.0.1:51839</span><br></pre></td></tr></table></figure><p>å‘½ä»¤æ¥å¯åŠ¨å¯è§†åŒ–ç•Œé¢ï¼š</p><p><img src="./assets/gc-trace.png" alt=""></p><p>é€‰æ‹©ç¬¬ä¸€ä¸ªé“¾æ¥å¯ä»¥è·å¾—å¦‚ä¸‹å›¾ç¤ºï¼š</p><p><img src="assets/gc-trace2.png" alt=""></p><p>å³ä¸Šè§’çš„é—®å·å¯ä»¥æ‰“å¼€å¸®åŠ©èœå•ï¼Œä¸»è¦ä½¿ç”¨æ–¹å¼åŒ…æ‹¬ï¼š</p><ul><li>w/s é”®å¯ä»¥ç”¨äºæ”¾å¤§æˆ–è€…ç¼©å°è§†å›¾</li><li>a/d é”®å¯ä»¥ç”¨äºå·¦å³ç§»åŠ¨</li></ul><h3 id="æ–¹å¼3ï¼šdebug-ReadGCStats"><a href="#æ–¹å¼3ï¼šdebug-ReadGCStats" class="headerlink" title="æ–¹å¼3ï¼šdebug.ReadGCStats"></a>æ–¹å¼3ï¼š<code>debug.ReadGCStats</code></h3><p>æ­¤æ–¹å¼å¯ä»¥é€šè¿‡ä»£ç çš„æ–¹å¼æ¥ç›´æ¥å®ç°å¯¹æ„Ÿå…´è¶£æŒ‡æ ‡çš„ç›‘æ§ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸Œæœ›æ¯éš”ä¸€ç§’é’Ÿç›‘æ§ä¸€æ¬¡ GC çš„çŠ¶æ€ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printGCStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.NewTicker(time.Second)</span><br><span class="line">s := debug.GCStats&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">debug.ReadGCStats(&amp;s)</span><br><span class="line">fmt.Printf(<span class="string">"gc %d last@%v, PauseTotal %v\n"</span>, s.NumGC, s.LastGC, s.PauseTotal)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> printGCStats()</span><br><span class="line">(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> run main.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line">gc <span class="number">4954</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">37.505575</span> +<span class="number">0100</span> CET, PauseTotal <span class="number">29.901171</span>ms</span><br><span class="line">gc <span class="number">9195</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">38.50565</span> +<span class="number">0100</span> CET, PauseTotal <span class="number">77.579622</span>ms</span><br><span class="line">gc <span class="number">13502</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">39.505714</span> +<span class="number">0100</span> CET, PauseTotal <span class="number">128.022307</span>ms</span><br><span class="line">gc <span class="number">17555</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">40.505579</span> +<span class="number">0100</span> CET, PauseTotal <span class="number">182.816528</span>ms</span><br><span class="line">gc <span class="number">21838</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">19</span>:<span class="number">41.505595</span> +<span class="number">0100</span> CET, PauseTotal <span class="number">246.618502</span>ms</span><br></pre></td></tr></table></figure><h3 id="æ–¹å¼4ï¼šruntime-ReadMemStats"><a href="#æ–¹å¼4ï¼šruntime-ReadMemStats" class="headerlink" title="æ–¹å¼4ï¼šruntime.ReadMemStats"></a>æ–¹å¼4ï¼š<code>runtime.ReadMemStats</code></h3><p>é™¤äº†ä½¿ç”¨ debug åŒ…æä¾›çš„æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥ç›´æ¥é€šè¿‡è¿è¡Œæ—¶çš„å†…å­˜ç›¸å…³çš„ API è¿›è¡Œç›‘æ§ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printMemStats</span><span class="params">()</span></span> &#123;</span><br><span class="line">t := time.NewTicker(time.Second)</span><br><span class="line">s := runtime.MemStats&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">runtime.ReadMemStats(&amp;s)</span><br><span class="line">fmt.Printf(<span class="string">"gc %d last@%v, next_heap_size@%vMB\n"</span>, s.NumGC, time.Unix(<span class="keyword">int64</span>(time.Duration(s.LastGC).Seconds()), <span class="number">0</span>), s.NextGC/(<span class="number">1</span>&lt;&lt;<span class="number">20</span>))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> printMemStats()</span><br><span class="line">(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="keyword">go</span> run main.<span class="keyword">go</span></span><br><span class="line"></span><br><span class="line">gc <span class="number">4887</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">44</span>:<span class="number">56</span> +<span class="number">0100</span> CET, next_heap_size@<span class="number">4</span>MB</span><br><span class="line">gc <span class="number">10049</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">44</span>:<span class="number">57</span> +<span class="number">0100</span> CET, next_heap_size@<span class="number">4</span>MB</span><br><span class="line">gc <span class="number">15231</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">44</span>:<span class="number">58</span> +<span class="number">0100</span> CET, next_heap_size@<span class="number">4</span>MB</span><br><span class="line">gc <span class="number">20378</span> last@<span class="number">2019</span><span class="number">-12</span><span class="number">-30</span> <span class="number">15</span>:<span class="number">44</span>:<span class="number">59</span> +<span class="number">0100</span> CET, next_heap_size@<span class="number">6</span>MB</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œåä¸¤ç§æ–¹å¼èƒ½å¤Ÿç›‘æ§çš„æŒ‡æ ‡å¾ˆå¤šï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ <a href="https://golang.org/pkg/runtime/debug/#GCStats" target="_blank" rel="noopener"><code>debug.GCStats</code></a> å’Œ<br><a href="https://golang.org/pkg/runtime/#MemStats" target="_blank" rel="noopener"><code>runtime.MemStats</code></a> çš„å­—æ®µï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p><h2 id="7-æœ‰äº†-GCï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Ÿ"><a href="#7-æœ‰äº†-GCï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Ÿ" class="headerlink" title="7. æœ‰äº† GCï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Ÿ"></a>7. æœ‰äº† GCï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Ÿ</h2><p>åœ¨ä¸€ä¸ªå…·æœ‰ GC çš„è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¸¸è¯´çš„å†…å­˜æ³„æ¼ï¼Œç”¨ä¸¥è°¨çš„è¯æ¥è¯´åº”è¯¥æ˜¯ï¼šé¢„æœŸçš„èƒ½å¾ˆå¿«è¢«é‡Šæ”¾çš„å†…å­˜ç”±äºé™„ç€åœ¨äº†é•¿æœŸå­˜æ´»çš„å†…å­˜ä¸Šã€æˆ–ç”Ÿå‘½æœŸæ„å¤–åœ°è¢«å»¶é•¿ï¼Œå¯¼è‡´é¢„è®¡èƒ½å¤Ÿç«‹å³å›æ”¶çš„å†…å­˜è€Œé•¿æ—¶é—´å¾—ä¸åˆ°å›æ”¶ã€‚</p><p>åœ¨ Go ä¸­ï¼Œç”±äº goroutine çš„å­˜åœ¨ï¼Œæ‰€è°“çš„å†…å­˜æ³„æ¼é™¤äº†é™„ç€åœ¨é•¿æœŸå¯¹è±¡ä¸Šä¹‹å¤–ï¼Œè¿˜å­˜åœ¨å¤šç§ä¸åŒçš„å½¢å¼ã€‚</p><h3 id="å½¢å¼1ï¼šé¢„æœŸèƒ½è¢«å¿«é€Ÿé‡Šæ”¾çš„å†…å­˜å› è¢«æ ¹å¯¹è±¡å¼•ç”¨è€Œæ²¡æœ‰å¾—åˆ°è¿…é€Ÿé‡Šæ”¾"><a href="#å½¢å¼1ï¼šé¢„æœŸèƒ½è¢«å¿«é€Ÿé‡Šæ”¾çš„å†…å­˜å› è¢«æ ¹å¯¹è±¡å¼•ç”¨è€Œæ²¡æœ‰å¾—åˆ°è¿…é€Ÿé‡Šæ”¾" class="headerlink" title="å½¢å¼1ï¼šé¢„æœŸèƒ½è¢«å¿«é€Ÿé‡Šæ”¾çš„å†…å­˜å› è¢«æ ¹å¯¹è±¡å¼•ç”¨è€Œæ²¡æœ‰å¾—åˆ°è¿…é€Ÿé‡Šæ”¾"></a>å½¢å¼1ï¼šé¢„æœŸèƒ½è¢«å¿«é€Ÿé‡Šæ”¾çš„å†…å­˜å› è¢«æ ¹å¯¹è±¡å¼•ç”¨è€Œæ²¡æœ‰å¾—åˆ°è¿…é€Ÿé‡Šæ”¾</h3><p>å½“æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡æ—¶ï¼Œå¯èƒ½ä¸ç»æ„é—´å°†æŸä¸ªå˜é‡é™„ç€åœ¨å…¶ä¸Šï¼Œä¸”å¿½ç•¥çš„å°†å…¶è¿›è¡Œé‡Šæ”¾ï¼Œåˆ™è¯¥å†…å­˜æ°¸è¿œä¸ä¼šå¾—åˆ°é‡Šæ”¾ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cache = <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]<span class="keyword">interface</span>&#123;&#125;&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keepalloc</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++ &#123;</span><br><span class="line">m := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1</span>&lt;&lt;<span class="number">10</span>)</span><br><span class="line">cache[i] = m</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å½¢å¼2ï¼šgoroutine-æ³„æ¼"><a href="#å½¢å¼2ï¼šgoroutine-æ³„æ¼" class="headerlink" title="å½¢å¼2ï¼šgoroutine æ³„æ¼"></a>å½¢å¼2ï¼šgoroutine æ³„æ¼</h3><p>Goroutine ä½œä¸ºä¸€ç§é€»è¾‘ä¸Šç†è§£çš„è½»é‡çº§çº¿ç¨‹ï¼Œéœ€è¦ç»´æŠ¤æ‰§è¡Œç”¨æˆ·ä»£ç çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…å­˜æ¥ä¿å­˜è¿™ç±»ä¿¡æ¯ï¼Œè€Œè¿™äº›å†…å­˜åœ¨ç›®å‰ç‰ˆæœ¬çš„ Go ä¸­æ˜¯ä¸ä¼šè¢«é‡Šæ”¾çš„ã€‚å› æ­¤ï¼Œå¦‚æœä¸€ä¸ªç¨‹åºæŒç»­ä¸æ–­åœ°äº§ç”Ÿæ–°çš„ goroutineã€ä¸”ä¸ç»“æŸå·²ç»åˆ›å»ºçš„ goroutine å¹¶å¤ç”¨è¿™éƒ¨åˆ†å†…å­˜ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼çš„ç°è±¡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keepalloc2</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å½¢å¼æ¥è°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"runtime/trace"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.Create(<span class="string">"trace.out"</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">trace.Start(f)</span><br><span class="line"><span class="keyword">defer</span> trace.Stop()</span><br><span class="line">keepalloc()</span><br><span class="line">keepalloc2()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç¨‹åºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run main.go</span><br></pre></td></tr></table></figure><p>ä¼šçœ‹åˆ°ç¨‹åºä¸­ç”Ÿæˆäº† <code>trace.out</code> æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>go tool trace trace.out</code> å‘½ä»¤å¾—åˆ°ä¸‹å›¾ï¼š</p><p><img src="./assets/gc-leak1.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°ï¼Œé€”ä¸­çš„ Heap åœ¨æŒç»­å¢é•¿ï¼Œæ²¡æœ‰å†…å­˜è¢«å›æ”¶ï¼Œäº§ç”Ÿäº†å†…å­˜æ³„æ¼çš„ç°è±¡ã€‚</p><p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç§å½¢å¼çš„ goroutine æ³„æ¼è¿˜å¯èƒ½ç”± channel æ³„æ¼å¯¼è‡´ã€‚è€Œ channel çš„æ³„æ¼æœ¬è´¨ä¸Šä¸ goroutine æ³„æ¼å­˜åœ¨ç›´æ¥è”ç³»ã€‚Channel ä½œä¸ºä¸€ç§åŒæ­¥åŸè¯­ï¼Œä¼šè¿æ¥ä¸¤ä¸ªä¸åŒçš„ goroutineï¼Œå¦‚æœä¸€ä¸ª goroutine å°è¯•å‘ä¸€ä¸ªæ²¡æœ‰æ¥æ”¶æ–¹çš„æ— ç¼“å†² channel å‘é€æ¶ˆæ¯ï¼Œåˆ™è¯¥ goroutine ä¼šè¢«æ°¸ä¹…çš„ä¼‘çœ ï¼Œæ•´ä¸ª goroutine åŠå…¶æ‰§è¡Œæ ˆéƒ½å¾—ä¸åˆ°é‡Šæ”¾ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">keepalloc3</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++ &#123;</span><br><span class="line"><span class="comment">// æ²¡æœ‰æ¥æ”¶æ–¹ï¼Œgoroutine ä¼šä¸€ç›´é˜»å¡</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123; ch &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125; &#125;()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="8-å¹¶å‘æ ‡è®°æ¸…é™¤æ³•çš„éš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#8-å¹¶å‘æ ‡è®°æ¸…é™¤æ³•çš„éš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="8. å¹¶å‘æ ‡è®°æ¸…é™¤æ³•çš„éš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>8. å¹¶å‘æ ‡è®°æ¸…é™¤æ³•çš„éš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åœ¨æ²¡æœ‰ç”¨æˆ·æ€ä»£ç å¹¶å‘ä¿®æ”¹<code>ä¸‰è‰²æŠ½è±¡</code>çš„æƒ…å†µä¸‹ï¼Œå›æ”¶å¯ä»¥æ­£å¸¸ç»“æŸã€‚ä½†æ˜¯å¹¶å‘å›æ”¶çš„æ ¹æœ¬é—®é¢˜åœ¨äºï¼Œç”¨æˆ·æ€ä»£ç åœ¨å›æ”¶è¿‡ç¨‹ä¸­ä¼šå¹¶å‘åœ°æ›´æ–°å¯¹è±¡å›¾ï¼Œä»è€Œé€ æˆèµ‹å€¼å™¨å’Œå›æ”¶å™¨å¯èƒ½å¯¹å¯¹è±¡å›¾çš„ç»“æ„äº§ç”Ÿä¸åŒçš„è®¤çŸ¥ã€‚è¿™æ—¶ä»¥ä¸€ä¸ªå›ºå®šçš„ä¸‰è‰²æ³¢é¢ä½œä¸ºå›æ”¶è¿‡ç¨‹å‰è¿›çš„è¾¹ç•Œåˆ™ä¸å†åˆç†ã€‚</p><p>æˆ‘ä»¬ä¸å¦¨è€ƒè™‘èµ‹å€¼å™¨å†™æ“ä½œçš„ä¾‹å­ï¼š</p><table><thead><tr><th>æ—¶åº</th><th>å›æ”¶å™¨</th><th>èµ‹å€¼å™¨</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>1</td><td>shade(A, gray)</td><td></td><td>å›æ”¶å™¨ï¼šæ ¹å¯¹è±¡çš„å­èŠ‚ç‚¹ç€è‰²ä¸ºç°è‰²å¯¹è±¡</td></tr><tr><td>2</td><td>shade(C, black)</td><td></td><td>å›æ”¶å™¨ï¼šå½“æ‰€æœ‰å­èŠ‚ç‚¹ç€è‰²ä¸ºç°è‰²åï¼Œå°†èŠ‚ç‚¹ç€ä¸ºé»‘è‰²</td></tr><tr><td>3</td><td></td><td>C.ref3 = C.ref2.ref1</td><td>èµ‹å€¼å™¨ï¼šå¹¶å‘çš„ä¿®æ”¹äº† C çš„å­èŠ‚ç‚¹</td></tr><tr><td>4</td><td></td><td>A.ref1 = nil</td><td>èµ‹å€¼å™¨ï¼šå¹¶å‘çš„ä¿®æ”¹äº† A çš„å­èŠ‚ç‚¹</td></tr><tr><td>5</td><td>shade(A.ref1, gray)</td><td></td><td>å›æ”¶å™¨ï¼šè¿›ä¸€æ­¥ç°è‰²å¯¹è±¡çš„å­èŠ‚ç‚¹å¹¶ç€è‰²ä¸ºç°è‰²å¯¹è±¡ï¼Œè¿™æ—¶ç”±äº <code>A.ref1</code> ä¸º <code>nil</code>ï¼Œä»€ä¹ˆäº‹æƒ…ä¹Ÿæ²¡æœ‰å‘ç”Ÿ</td></tr><tr><td>6</td><td>shade(A, black)</td><td></td><td>å›æ”¶å™¨ï¼šç”±äºæ‰€æœ‰å­èŠ‚ç‚¹å‡å·²æ ‡è®°ï¼Œå›æ”¶å™¨ä¹Ÿä¸ä¼šé‡æ–°æ‰«æå·²ç»è¢«æ ‡è®°ä¸ºé»‘è‰²çš„å¯¹è±¡ï¼Œæ­¤æ—¶ A è¢«ç€è‰²ä¸ºé»‘è‰²ï¼Œ<code>scan(A)</code> ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿï¼Œè¿›è€Œ B åœ¨æ­¤æ¬¡å›æ”¶è¿‡ç¨‹ä¸­æ°¸è¿œä¸ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼Œè¿›è€Œé”™è¯¯åœ°è¢«å›æ”¶ã€‚</td></tr></tbody></table><ul><li>åˆå§‹çŠ¶æ€ï¼šå‡è®¾æŸä¸ªé»‘è‰²å¯¹è±¡ C æŒ‡å‘æŸä¸ªç°è‰²å¯¹è±¡ A ï¼Œè€Œ A æŒ‡å‘ç™½è‰²å¯¹è±¡ Bï¼›</li><li><code>C.ref3 = C.ref2.ref1</code>ï¼šèµ‹å€¼å™¨å¹¶å‘åœ°å°†é»‘è‰²å¯¹è±¡ C æŒ‡å‘ï¼ˆref3ï¼‰äº†ç™½è‰²å¯¹è±¡ Bï¼›</li><li><code>A.ref1 = nil</code>ï¼šç§»é™¤ç°è‰²å¯¹è±¡ A å¯¹ç™½è‰²å¯¹è±¡ B çš„å¼•ç”¨ï¼ˆref2ï¼‰ï¼›</li><li>æœ€ç»ˆçŠ¶æ€ï¼šåœ¨ç»§ç»­æ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œç™½è‰²å¯¹è±¡ B æ°¸è¿œä¸ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²å¯¹è±¡äº†ï¼ˆå›æ”¶å™¨ä¸ä¼šé‡æ–°æ‰«æé»‘è‰²å¯¹è±¡ï¼‰ï¼Œè¿›è€Œå¯¹è±¡ B è¢«é”™è¯¯åœ°å›æ”¶ã€‚</li></ul><p><img src="./assets/gc-mutator.png" alt="gc-mutator"></p><p>æ€»è€Œè¨€ä¹‹ï¼Œå¹¶å‘æ ‡è®°æ¸…é™¤ä¸­é¢ä¸´çš„ä¸€ä¸ªæ ¹æœ¬é—®é¢˜å°±æ˜¯å¦‚ä½•ä¿è¯æ ‡è®°ä¸æ¸…é™¤è¿‡ç¨‹çš„æ­£ç¡®æ€§ã€‚</p><h2 id="9-ä»€ä¹ˆæ˜¯å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå¦‚ä½•å®ç°ï¼Ÿ"><a href="#9-ä»€ä¹ˆæ˜¯å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå¦‚ä½•å®ç°ï¼Ÿ" class="headerlink" title="9. ä»€ä¹ˆæ˜¯å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå¦‚ä½•å®ç°ï¼Ÿ"></a>9. ä»€ä¹ˆæ˜¯å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå¦‚ä½•å®ç°ï¼Ÿ</h2><p>è¦è®²æ¸…æ¥šå†™å±éšœï¼Œå°±éœ€è¦ç†è§£ä¸‰è‰²æ ‡è®°æ¸…é™¤ç®—æ³•ä¸­çš„<strong>å¼ºå¼±ä¸å˜æ€§</strong>ä»¥åŠ<strong>èµ‹å€¼å™¨çš„é¢œè‰²</strong>ï¼Œç†è§£ä»–ä»¬éœ€è¦ä¸€å®šçš„æŠ½è±¡æ€ç»´ã€‚å†™å±éšœæ˜¯ä¸€ä¸ªåœ¨å¹¶å‘åƒåœ¾å›æ”¶å™¨ä¸­æ‰ä¼šå‡ºç°çš„æ¦‚å¿µï¼Œåƒåœ¾å›æ”¶å™¨çš„æ­£ç¡®æ€§ä½“ç°åœ¨ï¼š<strong>ä¸åº”å‡ºç°å¯¹è±¡çš„ä¸¢å¤±ï¼Œä¹Ÿä¸åº”é”™è¯¯çš„å›æ”¶è¿˜ä¸éœ€è¦å›æ”¶çš„å¯¹è±¡ã€‚</strong></p><p>å¯ä»¥è¯æ˜ï¼Œå½“ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ä¼šç ´ååƒåœ¾å›æ”¶å™¨çš„æ­£ç¡®æ€§ï¼š</p><ul><li><strong>æ¡ä»¶ 1</strong>: èµ‹å€¼å™¨ä¿®æ”¹å¯¹è±¡å›¾ï¼Œå¯¼è‡´æŸä¸€é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼›</li><li><strong>æ¡ä»¶ 2</strong>: ä»ç°è‰²å¯¹è±¡å‡ºå‘ï¼Œåˆ°è¾¾ç™½è‰²å¯¹è±¡çš„ã€æœªç»è®¿é—®è¿‡çš„è·¯å¾„è¢«èµ‹å€¼å™¨ç ´åã€‚</li></ul><p>åªè¦èƒ½å¤Ÿé¿å…å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œåˆ™ä¸ä¼šå‡ºç°å¯¹è±¡ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºï¼š</p><ul><li>å¦‚æœæ¡ä»¶ 1 è¢«é¿å…ï¼Œåˆ™æ‰€æœ‰ç™½è‰²å¯¹è±¡å‡è¢«ç°è‰²å¯¹è±¡å¼•ç”¨ï¼Œæ²¡æœ‰ç™½è‰²å¯¹è±¡ä¼šè¢«é—æ¼ï¼›</li><li>å¦‚æœæ¡ä»¶ 2 è¢«é¿å…ï¼Œå³ä¾¿ç™½è‰²å¯¹è±¡çš„æŒ‡é’ˆè¢«å†™å…¥åˆ°é»‘è‰²å¯¹è±¡ä¸­ï¼Œä½†ä»ç°è‰²å¯¹è±¡å‡ºå‘ï¼Œæ€»å­˜åœ¨ä¸€æ¡æ²¡æœ‰è®¿é—®è¿‡çš„è·¯å¾„ï¼Œä»è€Œæ‰¾åˆ°åˆ°è¾¾ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œç™½è‰²å¯¹è±¡æœ€ç»ˆä¸ä¼šè¢«é—æ¼ã€‚</li></ul><p>æˆ‘ä»¬ä¸å¦¨å°†ä¸‰è‰²ä¸å˜æ€§æ‰€å®šä¹‰çš„æ³¢é¢æ ¹æ®è¿™ä¸¤ä¸ªæ¡ä»¶è¿›è¡Œå‰Šå¼±ï¼š</p><ul><li>å½“æ»¡è¶³åŸæœ‰çš„ä¸‰è‰²ä¸å˜æ€§å®šä¹‰ï¼ˆæˆ–ä¸Šé¢çš„ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶ï¼‰çš„æƒ…å†µç§°ä¸º<strong>å¼ºä¸‰è‰²ä¸å˜æ€§ï¼ˆstrong tricolor invariantï¼‰</strong><!-- å³ä¸å­˜åœ¨é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡çš„æŒ‡é’ˆï¼› --></li><li>å½“èµ‹å€¼å™¨ä»¤é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡æ—¶ï¼ˆæ»¡è¶³æ¡ä»¶ 1 æ—¶ï¼‰çš„æƒ…å†µç§°ä¸º<strong>å¼±ä¸‰è‰²ä¸å˜æ€§ï¼ˆweak tricolor invariantï¼‰</strong><!-- å³æ‰€æœ‰é»‘è‰²å¯¹è±¡å¼•ç”¨çš„ç™½è‰²å¯¹è±¡éƒ½å¤„äºç°è‰²ä¿æŠ¤çŠ¶æ€ï¼ˆç›´æ¥æˆ–é—´æ¥ä»ç°è‰²å¯¹è±¡å¯è¾¾ï¼‰ã€‚ --></li></ul><p>å½“èµ‹å€¼å™¨è¿›ä¸€æ­¥ç ´åç°è‰²å¯¹è±¡åˆ°è¾¾ç™½è‰²å¯¹è±¡çš„è·¯å¾„æ—¶ï¼ˆè¿›ä¸€æ­¥æ»¡è¶³æ¡ä»¶ 2 æ—¶ï¼‰ï¼Œå³æ‰“ç ´å¼±ä¸‰è‰²ä¸å˜æ€§ï¼Œä¹Ÿå°±ç ´åäº†å›æ”¶å™¨çš„æ­£ç¡®æ€§ï¼›æˆ–è€…è¯´ï¼Œåœ¨ç ´åå¼ºå¼±ä¸‰è‰²ä¸å˜æ€§æ—¶å¿…é¡»å¼•å…¥é¢å¤–çš„è¾…åŠ©æ“ä½œã€‚å¼±ä¸‰è‰²ä¸å˜å½¢çš„å¥½å¤„åœ¨äºï¼š<strong>åªè¦å­˜åœ¨æœªè®¿é—®çš„èƒ½å¤Ÿåˆ°è¾¾ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œå°±å¯ä»¥å°†é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚</strong></p><p>å¦‚æœæˆ‘ä»¬è€ƒè™‘å¹¶å‘çš„ç”¨æˆ·æ€ä»£ç ï¼Œå›æ”¶å™¨ä¸å…è®¸åŒæ—¶åœæ­¢æ‰€æœ‰èµ‹å€¼å™¨ï¼Œå°±æ˜¯æ¶‰åŠäº†å­˜åœ¨çš„å¤šä¸ªä¸åŒçŠ¶æ€çš„èµ‹å€¼å™¨ã€‚ä¸ºäº†å¯¹æ¦‚å¿µåŠ ä»¥æ˜ç¡®ï¼Œè¿˜éœ€è¦æ¢ä¸€ä¸ªè§’åº¦ï¼ŒæŠŠå›æ”¶å™¨è§†ä¸ºå¯¹è±¡ï¼ŒæŠŠèµ‹å€¼å™¨è§†ä¸ºå½±å“å›æ”¶å™¨è¿™ä¸€å¯¹è±¡çš„å®é™…è¡Œä¸ºï¼ˆå³å½±å“ GC å‘¨æœŸçš„é•¿çŸ­ï¼‰ï¼Œä»è€Œå¼•å…¥èµ‹å€¼å™¨çš„é¢œè‰²ï¼š</p><ul><li>é»‘è‰²èµ‹å€¼å™¨ï¼šå·²ç»ç”±å›æ”¶å™¨æ‰«æè¿‡ï¼Œä¸ä¼šå†æ¬¡å¯¹å…¶è¿›è¡Œæ‰«æã€‚</li><li>ç°è‰²èµ‹å€¼å™¨ï¼šå°šæœªè¢«å›æ”¶å™¨æ‰«æè¿‡ï¼Œæˆ–å°½ç®¡å·²ç»æ‰«æè¿‡ä½†ä»éœ€è¦é‡æ–°æ‰«æã€‚</li></ul><p>èµ‹å€¼å™¨çš„é¢œè‰²å¯¹å›æ”¶å‘¨æœŸçš„ç»“æŸäº§ç”Ÿå½±å“ï¼š</p><ul><li>å¦‚æœæŸç§å¹¶å‘å›æ”¶å™¨å…è®¸ç°è‰²èµ‹å€¼å™¨çš„å­˜åœ¨ï¼Œåˆ™å¿…é¡»åœ¨å›æ”¶ç»“æŸä¹‹å‰é‡æ–°æ‰«æå¯¹è±¡å›¾ã€‚</li><li>å¦‚æœé‡æ–°æ‰«æè¿‡ç¨‹ä¸­å‘ç°äº†æ–°çš„ç°è‰²æˆ–ç™½è‰²å¯¹è±¡ï¼Œå›æ”¶å™¨è¿˜éœ€è¦å¯¹æ–°å‘ç°çš„å¯¹è±¡è¿›è¡Œè¿½è¸ªï¼Œä½†æ˜¯åœ¨æ–°è¿½è¸ªçš„è¿‡ç¨‹ä¸­ï¼Œèµ‹å€¼å™¨ä»ç„¶å¯èƒ½åœ¨å…¶æ ¹ä¸­æ’å…¥æ–°çš„éé»‘è‰²çš„å¼•ç”¨ï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°é‡æ–°æ‰«æè¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç°æ–°çš„ç™½è‰²æˆ–ç°è‰²å¯¹è±¡ã€‚</li></ul><p>äºæ˜¯ï¼Œåœ¨å…è®¸ç°è‰²èµ‹å€¼å™¨å­˜åœ¨çš„ç®—æ³•ï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼Œå›æ”¶å™¨åªèƒ½å°†æ‰€æœ‰èµ‹å€¼å™¨çº¿ç¨‹åœæ­¢æ‰èƒ½å®Œæˆå…¶è·Ÿå¯¹è±¡çš„å®Œæ•´æ‰«æï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ STWã€‚</p><p>ä¸ºäº†ç¡®ä¿å¼ºå¼±ä¸‰è‰²ä¸å˜æ€§çš„å¹¶å‘æŒ‡é’ˆæ›´æ–°æ“ä½œï¼Œéœ€è¦é€šè¿‡èµ‹å€¼å™¨å±éšœæŠ€æœ¯æ¥ä¿è¯æŒ‡é’ˆçš„è¯»å†™æ“ä½œä¸€è‡´ã€‚å› æ­¤æˆ‘ä»¬æ‰€è¯´çš„ Go ä¸­çš„å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå…¶å®æ˜¯æŒ‡èµ‹å€¼å™¨çš„å†™å±éšœï¼Œèµ‹å€¼å™¨çš„å†™å±éšœç”¨æ¥ä¿è¯èµ‹å€¼å™¨åœ¨è¿›è¡ŒæŒ‡é’ˆå†™æ“ä½œæ—¶ï¼Œä¸ä¼šç ´åå¼±ä¸‰è‰²ä¸å˜æ€§ã€‚</p><p>æœ‰ä¸¤ç§éå¸¸ç»å…¸çš„å†™å±éšœï¼šDijkstra æ’å…¥å±éšœå’Œ Yuasa åˆ é™¤å±éšœã€‚</p><p>ç°è‰²èµ‹å€¼å™¨çš„ Dijkstra æ’å…¥å±éšœçš„åŸºæœ¬æ€æƒ³æ˜¯é¿å…æ»¡è¶³æ¡ä»¶ 1ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç°è‰²èµ‹å€¼å™¨ Dijkstra æ’å…¥å±éšœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DijkstraWritePointer</span><span class="params">(slot *unsafe.Pointer, ptr unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    shade(ptr)</span><br><span class="line">    *slot = ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é˜²æ­¢é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåº”è¯¥å‡è®¾ <code>*slot</code> å¯èƒ½ä¼šå˜ä¸ºé»‘è‰²ï¼Œä¸ºäº†ç¡®ä¿ <code>ptr</code> ä¸ä¼šåœ¨è¢«èµ‹å€¼åˆ° <code>*slot</code> å‰å˜ä¸ºç™½è‰²ï¼Œ<code>shade(ptr)</code> ä¼šå…ˆå°†æŒ‡é’ˆ <code>ptr</code> æ ‡è®°ä¸ºç°è‰²ï¼Œè¿›è€Œé¿å…äº†æ¡ä»¶ 1ã€‚ä½†æ˜¯ï¼Œç”±äºå¹¶ä¸æ¸…æ¥šèµ‹å€¼å™¨ä»¥åä¼šä¸ä¼šå°†è¿™ä¸ªå¼•ç”¨åˆ é™¤ï¼Œå› æ­¤è¿˜éœ€è¦é‡æ–°æ‰«ææ¥é‡æ–°ç¡®å®šå…³ç³»å›¾ï¼Œè¿™æ—¶éœ€è¦ STWï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><p><img src="./assets/gc-wb-dijkstra.png" alt=""></p><p>Dijkstra æ’å…¥å±éšœçš„å¥½å¤„åœ¨äºå¯ä»¥ç«‹åˆ»å¼€å§‹å¹¶å‘æ ‡è®°ï¼Œä½†ç”±äºäº§ç”Ÿäº†ç°è‰²èµ‹å€¼å™¨ï¼Œç¼ºé™·æ˜¯éœ€è¦æ ‡è®°ç»ˆæ­¢é˜¶æ®µ STW æ—¶è¿›è¡Œé‡æ–°æ‰«æã€‚</p><p>é»‘è‰²èµ‹å€¼å™¨çš„ Yuasa åˆ é™¤å±éšœçš„åŸºæœ¬æ€æƒ³æ˜¯é¿å…æ»¡è¶³æ¡ä»¶ 2ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»‘è‰²èµ‹å€¼å™¨ Yuasa å±éšœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">YuasaWritePointer</span><span class="params">(slot *unsafe.Pointer, ptr unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    shade(*slot)</span><br><span class="line">    *slot = ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†é˜²æ­¢ä¸¢å¤±ä»ç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œåº”è¯¥å‡è®¾ <code>*slot</code> å¯èƒ½ä¼šå˜ä¸ºé»‘è‰²ï¼Œä¸ºäº†ç¡®ä¿ <code>ptr</code> ä¸ä¼šåœ¨è¢«èµ‹å€¼åˆ° <code>*slot</code> å‰å˜ä¸ºç™½è‰²ï¼Œ<code>shade(*slot)</code> ä¼šå…ˆå°† <code>*slot</code> æ ‡è®°ä¸ºç°è‰²ï¼Œè¿›è€Œè¯¥å†™æ“ä½œæ€»æ˜¯åˆ›é€ äº†ä¸€æ¡ç°è‰²åˆ°ç°è‰²æˆ–è€…ç°è‰²åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œè¿›è€Œé¿å…äº†æ¡ä»¶ 2ã€‚</p><p>Yuasa åˆ é™¤å±éšœçš„ä¼˜åŠ¿åˆ™åœ¨äºä¸éœ€è¦æ ‡è®°ç»“æŸé˜¶æ®µçš„é‡æ–°æ‰«æï¼Œç¼ºé™·æ˜¯ä¾ç„¶ä¼šäº§ç”Ÿä¸¢å¤±çš„å¯¹è±¡ï¼Œéœ€è¦åœ¨æ ‡è®°å¼€å§‹å‰å¯¹æ•´ä¸ªå¯¹è±¡å›¾è¿›è¡Œå¿«ç…§ã€‚</p><p><img src="./assets/gc-wb-yuasa.png" alt=""></p><p>Go åœ¨ 1.8 çš„æ—¶å€™ä¸ºäº†ç®€åŒ– GC çš„æµç¨‹ï¼ŒåŒæ—¶å‡å°‘æ ‡è®°ç»ˆæ­¢é˜¶æ®µçš„é‡æ‰«æˆæœ¬ï¼Œå°† Dijkstra æ’å…¥å±éšœå’Œ Yuasa åˆ é™¤å±éšœè¿›è¡Œæ··åˆï¼Œå½¢æˆæ··åˆå†™å±éšœã€‚è¯¥å±éšœæå‡ºæ—¶çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼š<strong>å¯¹æ­£åœ¨è¢«è¦†ç›–çš„å¯¹è±¡è¿›è¡Œç€è‰²ï¼Œä¸”å¦‚æœå½“å‰æ ˆæœªæ‰«æå®Œæˆï¼Œåˆ™åŒæ ·å¯¹æŒ‡é’ˆè¿›è¡Œç€è‰²ã€‚</strong></p><p>ä½†åœ¨æœ€ç»ˆå®ç°æ—¶<a href="https://github.com/golang/proposal/blob/master/design/17503-eliminate-rescan.md" target="_blank" rel="noopener">åŸææ¡ˆ</a>ä¸­å¯¹ <code>ptr</code> çš„ç€è‰²è¿˜é¢å¤–åŒ…å«å¯¹æ‰§è¡Œæ ˆçš„ç€è‰²æ£€æŸ¥ï¼Œä½†ç”±äºæ—¶é—´æœ‰é™ï¼Œå¹¶æœªå®Œæ•´å®ç°è¿‡ï¼Œæ‰€ä»¥æ··åˆå†™å±éšœåœ¨ç›®å‰çš„å®ç°ä¼ªä»£ç æ˜¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ··åˆå†™å±éšœ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">HybridWritePointerSimple</span><span class="params">(slot *unsafe.Pointer, ptr unsafe.Pointer)</span></span> &#123;</span><br><span class="line">    shade(*slot)</span><br><span class="line">  shade(ptr)</span><br><span class="line">    *slot = ptr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªå®ç°ä¸­ï¼Œå¦‚æœæ— æ¡ä»¶å¯¹å¼•ç”¨åŒæ–¹è¿›è¡Œç€è‰²ï¼Œè‡ªç„¶ç»“åˆäº† Dijkstra å’Œ Yuasa å†™å±éšœçš„ä¼˜åŠ¿ï¼Œä½†ç¼ºç‚¹ä¹Ÿéå¸¸æ˜æ˜¾ï¼Œå› ä¸ºç€è‰²æˆæœ¬æ˜¯åŒå€çš„ï¼Œè€Œä¸”ç¼–è¯‘å™¨éœ€è¦æ’å…¥çš„ä»£ç ä¹Ÿæˆå€å¢åŠ ï¼Œéšä¹‹å¸¦æ¥çš„ç»“æœå°±æ˜¯ç¼–è¯‘åçš„äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ä¹Ÿè¿›ä¸€æ­¥å¢åŠ ã€‚ä¸ºäº†é’ˆå¯¹å†™å±éšœçš„æ€§èƒ½è¿›è¡Œä¼˜åŒ–ï¼ŒGo 1.10 å‰åï¼ŒGo å›¢é˜Ÿéšåå®ç°äº†æ‰¹é‡å†™å±éšœæœºåˆ¶ã€‚å…¶åŸºæœ¬æƒ³æ³•æ˜¯å°†éœ€è¦ç€è‰²çš„æŒ‡é’ˆåŒä¸€å†™å…¥ä¸€ä¸ªç¼“å­˜ï¼Œæ¯å½“ç¼“å­˜æ»¡æ—¶ç»Ÿä¸€å¯¹ç¼“å­˜ä¸­çš„æ‰€æœ‰ <code>ptr</code> æŒ‡é’ˆè¿›è¡Œç€è‰²ã€‚</p><h1 id="GC-çš„å®ç°ç»†èŠ‚"><a href="#GC-çš„å®ç°ç»†èŠ‚" class="headerlink" title="GC çš„å®ç°ç»†èŠ‚"></a>GC çš„å®ç°ç»†èŠ‚</h1><h2 id="10-Go-è¯­è¨€ä¸­-GC-çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#10-Go-è¯­è¨€ä¸­-GC-çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="10. Go è¯­è¨€ä¸­ GC çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>10. Go è¯­è¨€ä¸­ GC çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>å½“å‰ç‰ˆæœ¬çš„ Go ä»¥ STW ä¸ºç•Œé™ï¼Œå¯ä»¥å°† GC åˆ’åˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼š</p><table><thead><tr><th style="text-align:center">é˜¶æ®µ</th><th style="text-align:center">è¯´æ˜</th><th style="text-align:center">èµ‹å€¼å™¨çŠ¶æ€</th></tr></thead><tbody><tr><td style="text-align:center">GCMark</td><td style="text-align:center">æ ‡è®°å‡†å¤‡é˜¶æ®µï¼Œä¸ºå¹¶å‘æ ‡è®°åšå‡†å¤‡å·¥ä½œï¼Œå¯åŠ¨å†™å±éšœ</td><td style="text-align:center">STW</td></tr><tr><td style="text-align:center">GCMark</td><td style="text-align:center">æ‰«ææ ‡è®°é˜¶æ®µï¼Œä¸èµ‹å€¼å™¨å¹¶å‘æ‰§è¡Œï¼Œå†™å±éšœå¼€å¯</td><td style="text-align:center">å¹¶å‘</td></tr><tr><td style="text-align:center">GCMarkTermination</td><td style="text-align:center">æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼Œä¿è¯ä¸€ä¸ªå‘¨æœŸå†…æ ‡è®°ä»»åŠ¡å®Œæˆï¼Œåœæ­¢å†™å±éšœ</td><td style="text-align:center">STW</td></tr><tr><td style="text-align:center">GCoff</td><td style="text-align:center">å†…å­˜æ¸…æ‰«é˜¶æ®µï¼Œå°†éœ€è¦å›æ”¶çš„å†…å­˜å½’è¿˜åˆ°å †ä¸­ï¼Œå†™å±éšœå…³é—­</td><td style="text-align:center">å¹¶å‘</td></tr><tr><td style="text-align:center">GCoff</td><td style="text-align:center">å†…å­˜å½’è¿˜é˜¶æ®µï¼Œå°†è¿‡å¤šçš„å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œå†™å±éšœå…³é—­</td><td style="text-align:center">å¹¶å‘</td></tr></tbody></table><p>å…·ä½“è€Œè¨€ï¼Œå„ä¸ªé˜¶æ®µçš„è§¦å‘å‡½æ•°åˆ†åˆ«ä¸ºï¼š</p><p><img src="https://user-images.githubusercontent.com/7698088/71047691-930aba00-2177-11ea-84d5-4e9eac2df723.png" alt="gc-process"></p><h2 id="11-è§¦å‘-GC-çš„æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#11-è§¦å‘-GC-çš„æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="11. è§¦å‘ GC çš„æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ"></a>11. è§¦å‘ GC çš„æ—¶æœºæ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Go è¯­è¨€ä¸­å¯¹ GC çš„è§¦å‘æ—¶æœºå­˜åœ¨ä¸¤ç§å½¢å¼ï¼š  </p><ol><li><p><strong>ä¸»åŠ¨è§¦å‘</strong>ï¼Œé€šè¿‡è°ƒç”¨ runtime.GC æ¥è§¦å‘ GCï¼Œæ­¤è°ƒç”¨é˜»å¡å¼åœ°ç­‰å¾…å½“å‰ GC è¿è¡Œå®Œæ¯•ã€‚</p></li><li><p><strong>è¢«åŠ¨è§¦å‘</strong>ï¼Œåˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼š</p><ul><li><p>ä½¿ç”¨ç³»ç»Ÿç›‘æ§ï¼Œå½“è¶…è¿‡ä¸¤åˆ†é’Ÿæ²¡æœ‰äº§ç”Ÿä»»ä½• GC æ—¶ï¼Œå¼ºåˆ¶è§¦å‘ GCã€‚</p></li><li><p>ä½¿ç”¨æ­¥è°ƒï¼ˆPacingï¼‰ç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯æ§åˆ¶å†…å­˜å¢é•¿çš„æ¯”ä¾‹ã€‚</p></li></ul></li></ol><p>é€šè¿‡ <code>GOGC</code> æˆ–è€… <code>debug.SetGCPercent</code> è¿›è¡Œæ§åˆ¶ï¼ˆä»–ä»¬æ§åˆ¶çš„æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œå³å †çš„å¢é•¿ç‡ $\rho$ï¼‰ã€‚æ•´ä¸ªç®—æ³•çš„è®¾è®¡è€ƒè™‘çš„æ˜¯ä¼˜åŒ–é—®é¢˜ï¼šå¦‚æœè®¾ä¸Šä¸€æ¬¡ GC å®Œæˆæ—¶ï¼Œå†…å­˜çš„æ•°é‡ä¸º $H_m$ï¼ˆheap markedï¼‰ï¼Œä¼°è®¡éœ€è¦è§¦å‘ GC æ—¶çš„å †å¤§å° $H_T$ï¼ˆheap triggerï¼‰ï¼Œä½¿å¾—å®Œæˆ GC æ—¶å€™çš„ç›®æ ‡å †å¤§å° $H_g$ï¼ˆheap goalï¼‰ ä¸å®é™…å®Œæˆæ—¶å€™çš„å †å¤§å° $H_a$ï¼ˆheap actualï¼‰æœ€ä¸ºæ¥è¿‘ï¼Œå³ï¼š $\min |H_g - H_a| = \min|(1+\rho)H_m - H_a|$ã€‚</p><p><img src="https://user-images.githubusercontent.com/7698088/71047935-5e4b3280-2178-11ea-9abd-c86667ac9f88.png" alt="gc-pacing"></p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæ­¥è°ƒç®—æ³•è¿˜éœ€è¦è€ƒè™‘ CPU åˆ©ç”¨ç‡çš„é—®é¢˜ï¼Œæ˜¾ç„¶æˆ‘ä»¬ä¸åº”è¯¥è®©åƒåœ¾å›æ”¶å™¨å ç”¨è¿‡å¤šçš„ CPUï¼Œå³ä¸åº”è¯¥è®©æ¯ä¸ªè´Ÿè´£æ‰§è¡Œç”¨æˆ· goroutine çš„çº¿ç¨‹éƒ½åœ¨æ‰§è¡Œæ ‡è®°è¿‡ç¨‹ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨ç”¨æˆ·ä»£ç æ»¡è½½çš„æ—¶å€™ï¼ŒGC çš„ CPU ä½¿ç”¨ç‡ä¸åº”è¯¥è¶…è¿‡ 25%ï¼Œå³å¦ä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼šå¦‚æœè®¾ $u_g$ä¸ºç›®æ ‡ CPU ä½¿ç”¨ç‡ï¼ˆgoal utilizationï¼‰ï¼Œè€Œ $u_a$ä¸ºå®é™… CPU ä½¿ç”¨ç‡ï¼ˆactual utilizationï¼‰ï¼Œåˆ™ $\min|u_g - u_a|$ã€‚</p><blockquote><p>æ±‚è§£è¿™ä¸¤ä¸ªä¼˜åŒ–é—®é¢˜çš„å…·ä½“æ•°å­¦å»ºæ¨¡è¿‡ç¨‹æˆ‘ä»¬ä¸åœ¨æ­¤åšæ·±å…¥è®¨è®ºï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒä¸¤ä¸ªè®¾è®¡æ–‡æ¡£ï¼š<a href="https://docs.google.com/document/d/1wmjrocXIWTr1JxU-3EQBI6BK6KgtiFArkG47XK73xIQ/edit#" target="_blank" rel="noopener">Go 1.5 concurrent garbage collector pacing</a> å’Œ <a href="https://github.com/golang/proposal/blob/master/design/14951-soft-heap-limit.md" target="_blank" rel="noopener">Separate soft and hard heap size goal</a>ã€‚</p></blockquote><p>è®¡ç®— $H_T$ çš„æœ€ç»ˆç»“è®ºï¼ˆä» Go 1.10 æ—¶å¼€å§‹ $h_t$ å¢åŠ äº†ä¸Šç•Œ $0.95 \rho$ï¼Œä» Go 1.14 å¼€å§‹æ—¶ $h_t$ å¢åŠ äº†ä¸‹ç•Œ 0.6ï¼‰æ˜¯ï¼š</p><ul><li>è®¾ç¬¬ n æ¬¡è§¦å‘ GC æ—¶ (n &gt; 1)ï¼Œä¼°è®¡å¾—åˆ°çš„å †å¢é•¿ç‡ä¸º $h_t^{(n)}$ã€è¿è¡Œè¿‡ç¨‹ä¸­çš„å®é™…å †å¢é•¿ç‡ä¸º $h_a^{(n)}$ï¼Œç”¨æˆ·è®¾ç½®çš„å¢é•¿ç‡ä¸º $\rho = \text{GOGC}/100$ï¼ˆ $\rho &gt; 0$ï¼‰åˆ™ç¬¬ $n+1$ æ¬¡å‡ºè§¦å‘ GC æ—¶å€™ï¼Œä¼°è®¡çš„å †å¢é•¿ç‡ä¸ºï¼š</li></ul><p>$$<br>h_t^{(n+1)} = h_t^{(n)} + 0.5 \left[ \frac{H_g^{(n)} - H_a^{(n)}}{H_a^{(n)}} - h_t^{(n)} - \frac{u_a^{(n)}}{u_g^{(n)}} \left( h_a^{(n)} - h_t^{(n)} \right) \right]<br>$$</p><ul><li><p>ç‰¹åˆ«çš„ï¼Œ$h_t^{(1)} = 7 / 8$ï¼Œ$u_a^{(1)} = 0.25$ï¼Œ$u_g^{(1)} = 0.3$ã€‚ç¬¬ä¸€æ¬¡è§¦å‘ GC æ—¶ï¼Œå¦‚æœå½“å‰çš„å †å°äº $4\rho$ MBï¼Œåˆ™å¼ºåˆ¶è°ƒæ•´åˆ° $4\rho$ MB æ—¶è§¦å‘ GC</p></li><li><p>ç‰¹åˆ«çš„ï¼Œå½“ $h_t^{(n)}&lt;0.6$æ—¶ï¼Œå°†å…¶è°ƒæ•´ä¸º $0.6$ï¼Œå½“ $h_t^{(n)} &gt; 0.95 \rho$ æ—¶ï¼Œå°†å…¶è®¾ç½®ä¸º $0.95 \rho$</p></li><li><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ$\rho = 1$ï¼ˆå³ GOGC = 100ï¼‰ï¼Œç¬¬ä¸€æ¬¡è§¦å‘ GC æ—¶å¼ºåˆ¶è®¾ç½®è§¦å‘ç¬¬ä¸€æ¬¡ GC ä¸º 4MBï¼Œå¯ä»¥å†™å¦‚ä¸‹ç¨‹åºè¿›è¡ŒéªŒè¯ï¼š</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line"><span class="string">"runtime/trace"</span></span><br><span class="line"><span class="string">"sync/atomic"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> stop <span class="keyword">uint64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// é€šè¿‡å¯¹è±¡ P çš„é‡Šæ”¾çŠ¶æ€ï¼Œæ¥ç¡®å®š GC æ˜¯å¦å·²ç»å®Œæˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">gcfinished</span><span class="params">()</span> *<span class="title">int</span></span> &#123;</span><br><span class="line">p := <span class="number">1</span></span><br><span class="line">runtime.SetFinalizer(&amp;p, <span class="function"><span class="keyword">func</span><span class="params">(_ *<span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"gc finished"</span>)</span><br><span class="line">atomic.StoreUint64(&amp;stop, <span class="number">1</span>) <span class="comment">// é€šçŸ¥åœæ­¢åˆ†é…</span></span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">return</span> &amp;p</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">allocate</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// æ¯æ¬¡è°ƒç”¨åˆ†é… 0.25MB</span></span><br><span class="line">_ = <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="keyword">int</span>((<span class="number">1</span>&lt;&lt;<span class="number">20</span>)*<span class="number">0.25</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.Create(<span class="string">"trace.out"</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">trace.Start(f)</span><br><span class="line"><span class="keyword">defer</span> trace.Stop()</span><br><span class="line"></span><br><span class="line">gcfinished()</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“å®Œæˆ GC æ—¶åœæ­¢åˆ†é…</span></span><br><span class="line"><span class="keyword">for</span> n := <span class="number">1</span>; atomic.LoadUint64(&amp;stop) != <span class="number">1</span>; n++ &#123;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"#allocate: "</span>, n)</span><br><span class="line">allocate()</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"terminate"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆæ¥éªŒè¯æœ€ç®€å•çš„ä¸€ç§æƒ…å†µï¼Œå³ç¬¬ä¸€æ¬¡è§¦å‘ GC æ—¶çš„å †å¤§å°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o main</span><br><span class="line">$ GODEBUG=gctrace=1 ./main</span><br><span class="line">#allocate:  1</span><br><span class="line">(...)</span><br><span class="line">#allocate:  20</span><br><span class="line">gc finished</span><br><span class="line">gc 1 @0.001s 3%: 0.016+0.23+0.019 ms clock, 0.20+0.11/0.060/0.13+0.22 ms cpu, 4-&gt;5-&gt;1 MB, 5 MB goal, 12 P</span><br><span class="line">scvg: 8 KB released</span><br><span class="line">scvg: inuse: 1, idle: 62, sys: 63, released: 58, consumed: 5 (MB)</span><br><span class="line">terminate</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ä¸€è¡Œæ•°æ®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gc 1 @0.001s 3%: 0.016+0.23+0.019 ms clock, 0.20+0.11/0.060/0.13+0.22 ms cpu, 4-&gt;5-&gt;1 MB, 5 MB goal, 12 P</span><br></pre></td></tr></table></figure><ol><li>ç¨‹åºåœ¨å®Œæˆç¬¬ä¸€æ¬¡ GC åä¾¿ç»ˆæ­¢äº†ç¨‹åºï¼Œç¬¦åˆæˆ‘ä»¬çš„è®¾æƒ³</li><li>ç¬¬ä¸€æ¬¡ GC å¼€å§‹æ—¶çš„å †å¤§å°ä¸º 4MBï¼Œç¬¦åˆæˆ‘ä»¬çš„è®¾æƒ³</li><li>å½“æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œå †å¤§å°ä¸º 5MBï¼Œæ­¤åå¼€å§‹æ‰§è¡Œæ¸…æ‰«ï¼Œè¿™æ—¶åˆ†é…æ‰§è¡Œåˆ°ç¬¬ 20 æ¬¡ï¼Œå³ 20*0.25 = 5MBï¼Œç¬¦åˆæˆ‘ä»¬çš„è®¾æƒ³</li></ol><p>æˆ‘ä»¬å°†åˆ†é…æ¬¡æ•°è°ƒæ•´åˆ° 50 æ¬¡</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> n := <span class="number">1</span>; n &lt; <span class="number">50</span>; n++ &#123;</span><br><span class="line"><span class="built_in">println</span>(<span class="string">"#allocate: "</span>, n)</span><br><span class="line">allocate()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥éªŒè¯ç¬¬äºŒæ¬¡ GC è§¦å‘æ—¶æ˜¯å¦æ»¡è¶³å…¬å¼æ‰€è®¡ç®—å¾—åˆ°çš„å€¼ï¼ˆä¸º GODEBUG è¿›ä¸€æ­¥è®¾ç½® <code>gcpacertrace=1</code>ï¼‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o main</span><br><span class="line">$ GODEBUG=gctrace=1,gcpacertrace=1 ./main</span><br><span class="line">#allocate:  1</span><br><span class="line">(...)</span><br><span class="line"></span><br><span class="line">pacer: H_m_prev=2236962 h_t=+8.750000e-001 H_T=4194304 h_a=+2.387451e+000 H_a=7577600 h_g=+1.442627e+000 H_g=5464064 u_a=+2.652227e-001 u_g=+3.000000e-001 W_a=152832 goalÎ”=+5.676271e-001 actualÎ”=+1.512451e+000 u_a/u_g=+8.840755e-001</span><br><span class="line">#allocate:  28</span><br><span class="line">gc 1 @0.001s 5%: 0.032+0.32+0.055 ms clock, 0.38+0.068/0.053/0.11+0.67 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P</span><br><span class="line"></span><br><span class="line">(...)</span><br><span class="line">#allocate:  37</span><br><span class="line">pacer: H_m_prev=3307736 h_t=+6.000000e-001 H_T=5292377 h_a=+7.949171e-001 H_a=5937112 h_g=+1.000000e+000 H_g=6615472 u_a=+2.658428e-001 u_g=+3.000000e-001 W_a=154240 goalÎ”=+4.000000e-001 actualÎ”=+1.949171e-001 u_a/u_g=+8.861428e-001</span><br><span class="line">#allocate:  38</span><br><span class="line">gc 2 @0.002s 9%: 0.017+0.26+0.16 ms clock, 0.20+0.079/0.058/0.12+1.9 ms cpu, 5-&gt;5-&gt;0 MB, 6 MB goal, 12 P</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ•°æ®ï¼š</p><ul><li>ç¬¬ä¸€æ¬¡ä¼°è®¡å¾—åˆ°çš„å †å¢é•¿ç‡ä¸º $h_t^{(1)} = 0.875$</li><li>ç¬¬ä¸€æ¬¡çš„è¿è¡Œè¿‡ç¨‹ä¸­çš„å®é™…å †å¢é•¿ç‡ä¸º $h_a^{(1)} = 0.2387451$</li><li>ç¬¬ä¸€æ¬¡å®é™…çš„å †å¤§å°ä¸º $H_a^{(1)}=7577600$</li><li>ç¬¬ä¸€æ¬¡ç›®æ ‡çš„å †å¤§å°ä¸º $H_g^{(1)}=5464064$</li><li>ç¬¬ä¸€æ¬¡çš„ CPU å®é™…ä½¿ç”¨ç‡ä¸º $u_a^{(1)} = 0.2652227$</li><li>ç¬¬ä¸€æ¬¡çš„ CPU ç›®æ ‡ä½¿ç”¨ç‡ä¸º $u_g^{(1)} = 0.3$</li></ul><p>æˆ‘ä»¬æ®æ­¤è®¡ç®—ç¬¬äºŒæ¬¡ä¼°è®¡çš„å †å¢é•¿ç‡ï¼š</p><p>$$<br>\begin{align}<br>h_t^{(2)} &amp;= h_t^{(1)} + 0.5 \left[ \frac{H_g^{(1)} - H_a^{(1)}}{H_a^{(1)}} - h_t^{(1)} - \frac{u_a^{(1)}}{u_g^{(1)}} \left( h_a^{(1)} - h_t^{(1)} \right) \right] \<br>&amp;= 0.875 + 0.5 \left[ \frac{5464064 - 7577600}{5464064} - 0.875 - \frac{0.2652227}{0.3} \left( 0.2387451 - 0.875 \right) \right] \<br>&amp; \approx 0.52534543909 \<br>\end{align}<br>$$</p><p>å› ä¸º $0.52534543909 &lt; 0.6\rho = 0.6$ï¼Œå› æ­¤ä¸‹ä¸€æ¬¡çš„è§¦å‘ç‡ä¸º $h_t^{2} = 0.6$ï¼Œä¸æˆ‘ä»¬å®é™…è§‚å¯Ÿåˆ°çš„ç¬¬äºŒæ¬¡ GC çš„è§¦å‘ç‡ 0.6 å»åˆã€‚</p><h2 id="12-å¦‚æœå†…å­˜åˆ†é…é€Ÿåº¦è¶…è¿‡äº†æ ‡è®°æ¸…é™¤çš„é€Ÿåº¦æ€ä¹ˆåŠï¼Ÿ"><a href="#12-å¦‚æœå†…å­˜åˆ†é…é€Ÿåº¦è¶…è¿‡äº†æ ‡è®°æ¸…é™¤çš„é€Ÿåº¦æ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="12. å¦‚æœå†…å­˜åˆ†é…é€Ÿåº¦è¶…è¿‡äº†æ ‡è®°æ¸…é™¤çš„é€Ÿåº¦æ€ä¹ˆåŠï¼Ÿ"></a>12. å¦‚æœå†…å­˜åˆ†é…é€Ÿåº¦è¶…è¿‡äº†æ ‡è®°æ¸…é™¤çš„é€Ÿåº¦æ€ä¹ˆåŠï¼Ÿ</h2><p>ç›®å‰çš„ Go å®ç°ä¸­ï¼Œå½“ GC è§¦å‘åï¼Œä¼šé¦–å…ˆè¿›å…¥å¹¶å‘æ ‡è®°çš„é˜¶æ®µã€‚å¹¶å‘æ ‡è®°ä¼šè®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œå¹¶åœ¨ mallocgc è°ƒç”¨æ—¶è¿›è¡Œæ£€æŸ¥ã€‚å½“å­˜åœ¨æ–°çš„å†…å­˜åˆ†é…æ—¶ï¼Œä¼šæš‚åœåˆ†é…å†…å­˜è¿‡å¿«çš„é‚£äº› goroutineï¼Œå¹¶å°†å…¶è½¬å»æ‰§è¡Œä¸€äº›è¾…åŠ©æ ‡è®°ï¼ˆMark Assistï¼‰çš„å·¥ä½œï¼Œä»è€Œè¾¾åˆ°æ”¾ç¼“ç»§ç»­åˆ†é…ã€è¾…åŠ© GC çš„æ ‡è®°å·¥ä½œçš„ç›®çš„ã€‚</p><p>ç¼–è¯‘å™¨ä¼šåˆ†æç”¨æˆ·ä»£ç ï¼Œå¹¶åœ¨éœ€è¦åˆ†é…å†…å­˜çš„ä½ç½®ï¼Œå°†ç”³è¯·å†…å­˜çš„æ“ä½œç¿»è¯‘ä¸º <code>mallocgc</code> è°ƒç”¨ï¼Œè€Œ <code>mallocgc</code> çš„å®ç°å†³å®šäº†æ ‡è®°è¾…åŠ©çš„å®ç°ï¼Œå…¶ä¼ªä»£ç æ€è·¯å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">mallocgc</span><span class="params">(t typ.Type, size <span class="keyword">uint64</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> enableMarkAssist &#123;</span><br><span class="line"><span class="comment">// è¿›è¡Œæ ‡è®°è¾…åŠ©ï¼Œæ­¤æ—¶ç”¨æˆ·ä»£ç æ²¡æœ‰å¾—åˆ°æ‰§è¡Œ</span></span><br><span class="line">(...)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰§è¡Œå†…å­˜åˆ†é…</span></span><br><span class="line">(...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="GC-çš„ä¼˜åŒ–é—®é¢˜"><a href="#GC-çš„ä¼˜åŒ–é—®é¢˜" class="headerlink" title="GC çš„ä¼˜åŒ–é—®é¢˜"></a>GC çš„ä¼˜åŒ–é—®é¢˜</h1><h2 id="13-GC-å…³æ³¨çš„æŒ‡æ ‡æœ‰å“ªäº›ï¼Ÿ"><a href="#13-GC-å…³æ³¨çš„æŒ‡æ ‡æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="13. GC å…³æ³¨çš„æŒ‡æ ‡æœ‰å“ªäº›ï¼Ÿ"></a>13. GC å…³æ³¨çš„æŒ‡æ ‡æœ‰å“ªäº›ï¼Ÿ</h2><p>Go çš„ GC è¢«è®¾è®¡ä¸ºæˆæ¯”ä¾‹è§¦å‘ã€å¤§éƒ¨åˆ†å·¥ä½œä¸èµ‹å€¼å™¨å¹¶å‘ã€ä¸åˆ†ä»£ã€æ— å†…å­˜ç§»åŠ¨ä¸”ä¼šä¸»åŠ¨å‘æ“ä½œç³»ç»Ÿå½’è¿˜ç”³è¯·çš„å†…å­˜ã€‚å› æ­¤æœ€ä¸»è¦å…³æ³¨çš„ã€èƒ½å¤Ÿå½±å“èµ‹å€¼å™¨çš„æ€§èƒ½æŒ‡æ ‡æœ‰ï¼š</p><ul><li>CPU åˆ©ç”¨ç‡ï¼šå›æ”¶ç®—æ³•ä¼šåœ¨å¤šå¤§ç¨‹åº¦ä¸Šæ‹–æ…¢ç¨‹åºï¼Ÿæœ‰æ—¶å€™ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡å›æ”¶å ç”¨çš„ CPU æ—¶é—´ä¸å…¶å®ƒ CPU æ—¶é—´çš„ç™¾åˆ†æ¯”æ¥æè¿°çš„ã€‚</li><li>GC åœé¡¿æ—¶é—´ï¼šå›æ”¶å™¨ä¼šé€ æˆå¤šé•¿æ—¶é—´çš„åœé¡¿ï¼Ÿç›®å‰çš„ GC ä¸­éœ€è¦è€ƒè™‘ STW å’Œ Mark Assist ä¸¤ä¸ªéƒ¨åˆ†å¯èƒ½é€ æˆçš„åœé¡¿ã€‚</li><li>GC åœé¡¿é¢‘ç‡ï¼šå›æ”¶å™¨é€ æˆçš„åœé¡¿é¢‘ç‡æ˜¯æ€æ ·çš„ï¼Ÿç›®å‰çš„ GC ä¸­éœ€è¦è€ƒè™‘ STW å’Œ Mark Assist ä¸¤ä¸ªéƒ¨åˆ†å¯èƒ½é€ æˆçš„åœé¡¿ã€‚</li><li>GC å¯æ‰©å±•æ€§ï¼šå½“å †å†…å­˜å˜å¤§æ—¶ï¼Œåƒåœ¾å›æ”¶å™¨çš„æ€§èƒ½å¦‚ä½•ï¼Ÿä½†å¤§éƒ¨åˆ†çš„ç¨‹åºå¯èƒ½å¹¶ä¸ä¸€å®šå…³å¿ƒè¿™ä¸ªé—®é¢˜ã€‚</li></ul><h2 id="14-Go-çš„-GC-å¦‚ä½•è°ƒä¼˜ï¼Ÿ"><a href="#14-Go-çš„-GC-å¦‚ä½•è°ƒä¼˜ï¼Ÿ" class="headerlink" title="14. Go çš„ GC å¦‚ä½•è°ƒä¼˜ï¼Ÿ"></a>14. Go çš„ GC å¦‚ä½•è°ƒä¼˜ï¼Ÿ</h2><p>Go çš„ GC è¢«è®¾è®¡ä¸ºæè‡´ç®€æ´ï¼Œä¸è¾ƒä¸ºæˆç†Ÿçš„ Java GC çš„æ•°åä¸ªå¯æ§å‚æ•°ç›¸æ¯”ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²ï¼ŒGo å¯ä¾›ç”¨æˆ·è°ƒæ•´çš„å‚æ•°åªæœ‰ GOGC ç¯å¢ƒå˜é‡ã€‚å½“æˆ‘ä»¬è°ˆè®º GC è°ƒä¼˜æ—¶ï¼Œé€šå¸¸æ˜¯æŒ‡å‡å°‘ç”¨æˆ·ä»£ç å¯¹ GC äº§ç”Ÿçš„å‹åŠ›ï¼Œè¿™ä¸€æ–¹é¢åŒ…å«äº†å‡å°‘ç”¨æˆ·ä»£ç åˆ†é…å†…å­˜çš„æ•°é‡ï¼ˆå³å¯¹ç¨‹åºçš„ä»£ç è¡Œä¸ºè¿›è¡Œè°ƒä¼˜ï¼‰ï¼Œå¦ä¸€æ–¹é¢åŒ…å«äº†æœ€å°åŒ– Go çš„ GC å¯¹ CPU çš„ä½¿ç”¨ç‡ï¼ˆå³è°ƒæ•´ GOGCï¼‰ã€‚</p><p>GC çš„è°ƒä¼˜æ˜¯åœ¨ç‰¹å®šåœºæ™¯ä¸‹äº§ç”Ÿçš„ï¼Œå¹¶éæ‰€æœ‰ç¨‹åºéƒ½éœ€è¦é’ˆå¯¹ GC è¿›è¡Œè°ƒä¼˜ã€‚åªæœ‰é‚£äº›å¯¹æ‰§è¡Œå»¶è¿Ÿéå¸¸æ•æ„Ÿã€<br>å½“ GC çš„å¼€é”€æˆä¸ºç¨‹åºæ€§èƒ½ç“¶é¢ˆçš„ç¨‹åºï¼Œæ‰éœ€è¦é’ˆå¯¹ GC è¿›è¡Œæ€§èƒ½è°ƒä¼˜ï¼Œå‡ ä¹ä¸å­˜åœ¨äºå®é™…å¼€å‘ä¸­ 99% çš„æƒ…å†µã€‚<br>é™¤æ­¤ä¹‹å¤–ï¼ŒGo çš„ GC ä¹Ÿä»ç„¶æœ‰ä¸€å®šçš„å¯æ”¹è¿›çš„ç©ºé—´ï¼Œä¹Ÿæœ‰éƒ¨åˆ† GC é€ æˆçš„é—®é¢˜ï¼Œç›®å‰ä»å±äº Open Problemã€‚</p><p>æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç°åœ¨çš„å¼€å‘ä¸­å¤„ç†çš„æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š</p><ol><li>å¯¹åœé¡¿æ•æ„Ÿï¼šGC è¿‡ç¨‹ä¸­äº§ç”Ÿçš„é•¿æ—¶é—´åœé¡¿ã€æˆ–ç”±äºéœ€è¦æ‰§è¡Œ GC è€Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå¯¼è‡´éœ€è¦ç«‹å³æ‰§è¡Œçš„ç”¨æˆ·ä»£ç æ‰§è¡Œæ»åã€‚</li><li>å¯¹èµ„æºæ¶ˆè€—æ•æ„Ÿï¼šå¯¹äºé¢‘ç¹åˆ†é…å†…å­˜çš„åº”ç”¨è€Œè¨€ï¼Œé¢‘ç¹åˆ†é…å†…å­˜å¢åŠ  GC çš„å·¥ä½œé‡ï¼ŒåŸæœ¬å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„åº”ç”¨ä¸å¾—ä¸é¢‘ç¹åœ°æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œå½±å“ç”¨æˆ·ä»£ç å¯¹ CPU çš„åˆ©ç”¨ç‡ï¼Œè¿›è€Œå½±å“ç”¨æˆ·ä»£ç çš„æ‰§è¡Œæ•ˆç‡ã€‚</li></ol><p>ä»è¿™ä¸¤ç‚¹æ¥çœ‹ï¼Œæ‰€è°“ GC è°ƒä¼˜çš„æ ¸å¿ƒæ€æƒ³ä¹Ÿå°±æ˜¯å……åˆ†çš„å›´ç»•ä¸Šé¢çš„ä¸¤ç‚¹æ¥å±•å¼€ï¼šä¼˜åŒ–å†…å­˜çš„ç”³è¯·é€Ÿåº¦ï¼Œå°½å¯èƒ½çš„å°‘ç”³è¯·å†…å­˜ï¼Œå¤ç”¨å·²ç”³è¯·çš„å†…å­˜ã€‚æˆ–è€…ç®€å•æ¥è¯´ï¼Œä¸å¤–ä¹è¿™ä¸‰ä¸ªå…³é”®å­—ï¼š<strong>æ§åˆ¶ã€å‡å°‘ã€å¤ç”¨</strong>ã€‚</p><p>æˆ‘ä»¬å°†é€šè¿‡ä¸‰ä¸ªå®é™…ä¾‹å­ä»‹ç»å¦‚ä½•å®šä½ GC çš„å­˜åœ¨çš„é—®é¢˜ï¼Œå¹¶ä¸€æ­¥ä¸€æ­¥è¿›è¡Œæ€§èƒ½è°ƒä¼˜ã€‚å½“ç„¶ï¼Œåœ¨å®é™…æƒ…å†µä¸­é—®é¢˜è¿œæ¯”è¿™äº›ä¾‹å­è¦å¤æ‚ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯è®¨è®ºè°ƒä¼˜çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ›´å¤šçš„æ—¶å€™ä¹Ÿåªèƒ½å…·ä½“é—®é¢˜å…·ä½“åˆ†æã€‚</p><h3 id="ä¾‹1ï¼šåˆç†åŒ–å†…å­˜åˆ†é…çš„é€Ÿåº¦ã€æé«˜èµ‹å€¼å™¨çš„-CPU-åˆ©ç”¨ç‡"><a href="#ä¾‹1ï¼šåˆç†åŒ–å†…å­˜åˆ†é…çš„é€Ÿåº¦ã€æé«˜èµ‹å€¼å™¨çš„-CPU-åˆ©ç”¨ç‡" class="headerlink" title="ä¾‹1ï¼šåˆç†åŒ–å†…å­˜åˆ†é…çš„é€Ÿåº¦ã€æé«˜èµ‹å€¼å™¨çš„ CPU åˆ©ç”¨ç‡"></a>ä¾‹1ï¼šåˆç†åŒ–å†…å­˜åˆ†é…çš„é€Ÿåº¦ã€æé«˜èµ‹å€¼å™¨çš„ CPU åˆ©ç”¨ç‡</h3><p>æˆ‘ä»¬æ¥çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ<code>concat</code> å‡½æ•°è´Ÿè´£æ‹¼æ¥ä¸€äº›é•¿åº¦ä¸ç¡®å®šçš„å­—ç¬¦ä¸²ã€‚å¹¶ä¸”ä¸ºäº†å¿«é€Ÿå®Œæˆä»»åŠ¡ï¼Œå‡ºäºæŸç§åŸå› ï¼Œåœ¨ä¸¤ä¸ªåµŒå¥—çš„ for å¾ªç¯ä¸­ä¸€å£æ°”åˆ›å»ºäº† 800 ä¸ª goroutineã€‚åœ¨ main å‡½æ•°ä¸­ï¼Œå¯åŠ¨äº†ä¸€ä¸ª goroutine å¹¶åœ¨ç¨‹åºç»“æŸå‰ä¸æ–­çš„è§¦å‘ GCï¼Œå¹¶å°è¯•è¾“å‡º GC çš„å¹³å‡æ‰§è¡Œæ—¶é—´ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line"><span class="string">"runtime/trace"</span></span><br><span class="line"><span class="string">"sync/atomic"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">stop  <span class="keyword">int32</span></span><br><span class="line">count <span class="keyword">int64</span></span><br><span class="line">sum   time.Duration</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">for</span> n := <span class="number">0</span>; n &lt; <span class="number">100</span>; n++ &#123;</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">"Go GC"</span></span><br><span class="line">s += <span class="string">" "</span> + <span class="string">"Hello"</span></span><br><span class="line">s += <span class="string">" "</span> + <span class="string">"World"</span></span><br><span class="line">_ = s</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.Create(<span class="string">"trace.out"</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">trace.Start(f)</span><br><span class="line"><span class="keyword">defer</span> trace.Stop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> t time.Time</span><br><span class="line"><span class="keyword">for</span> atomic.LoadInt32(&amp;stop) == <span class="number">0</span> &#123;</span><br><span class="line">t = time.Now()</span><br><span class="line">runtime.GC()</span><br><span class="line">sum += time.Since(t)</span><br><span class="line">count++</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"GC spend avg: %v\n"</span>, time.Duration(<span class="keyword">int64</span>(sum)/count))</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">concat()</span><br><span class="line">atomic.StoreInt32(&amp;stop, <span class="number">1</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªç¨‹åºçš„æ‰§è¡Œç»“æœæ˜¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o main</span><br><span class="line">$ ./main</span><br><span class="line">GC spend avg: 2.583421ms</span><br></pre></td></tr></table></figure><p>GC å¹³å‡æ‰§è¡Œä¸€æ¬¡éœ€è¦é•¿è¾¾ 2ms çš„æ—¶é—´ï¼Œæˆ‘ä»¬å†è¿›ä¸€æ­¥è§‚å¯Ÿ trace çš„ç»“æœï¼š</p><p><img src="./assets/gc-tuning-ex1-1.png" alt=""></p><p>ç¨‹åºçš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­ä»…æ‰§è¡Œäº†ä¸€æ¬¡ GCï¼Œè€Œä¸”ä»… Sweep STW å°±è€—è´¹äº†è¶…è¿‡ 1 msï¼Œéå¸¸åå¸¸ã€‚ç”šè‡³æŸ¥çœ‹èµ‹å€¼å™¨ mutator çš„ CPU åˆ©ç”¨ç‡ï¼Œåœ¨æ•´ä¸ª trace å°ºåº¦ä¸‹è¿ 40% éƒ½ä¸åˆ°ï¼š</p><p><img src="./assets/gc-tuning-ex1-2.png" alt=""></p><p>ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨æŸ¥çœ‹ goroutine çš„åˆ†æï¼š</p><p><img src="./assets/gc-tuning-ex1-3.png" alt=""></p><p>åœ¨è¿™ä¸ªæ¦œå•ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œgoroutine çš„æ‰§è¡Œæ—¶é—´å å…¶ç”Ÿå‘½å‘¨æœŸæ€»æ—¶é—´éå¸¸çŸ­çš„ä¸€éƒ¨åˆ†ï¼Œä½†å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±è´¹åœ¨è°ƒåº¦å™¨çš„ç­‰å¾…ä¸Šäº†ï¼ˆè“è‰²çš„éƒ¨åˆ†ï¼‰ï¼Œè¯´æ˜åŒæ—¶åˆ›å»ºå¤§é‡ goroutine å¯¹è°ƒåº¦å™¨äº§ç”Ÿçš„å‹åŠ›ç¡®å®ä¸å°ï¼Œæˆ‘ä»¬ä¸å¦¨å°†è¿™ä¸€äº§ç”Ÿé€Ÿç‡å‡æ…¢ï¼Œä¸€æ‰¹ä¸€æ‰¹åœ°åˆ›å»º goroutineï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> n := <span class="number">0</span>; n &lt; <span class="number">100</span>; n++ &#123;</span><br><span class="line">wg.Add(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="string">"Go GC"</span></span><br><span class="line">s += <span class="string">" "</span> + <span class="string">"Hello"</span></span><br><span class="line">s += <span class="string">" "</span> + <span class="string">"World"</span></span><br><span class="line">_ = s</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬å†æ¥çœ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o main</span><br><span class="line">$ ./main</span><br><span class="line">GC spend avg: 328.54Âµs</span><br></pre></td></tr></table></figure><p>GC çš„å¹³å‡æ—¶é—´å°±é™åˆ° 300 å¾®ç§’äº†ã€‚è¿™æ—¶çš„èµ‹å€¼å™¨ CPU ä½¿ç”¨ç‡ä¹Ÿæé«˜åˆ°äº† 60%ï¼Œç›¸å¯¹æ¥è¯´å°±å¾ˆå¯è§‚äº†ï¼š</p><p><img src="./assets/gc-tuning-ex1-4.png" alt=""></p><p>å½“ç„¶ï¼Œè¿™ä¸ªç¨‹åºä»ç„¶æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œä¾‹å¦‚æˆ‘ä»¬å…¶å®æ²¡æœ‰å¿…è¦ç­‰å¾…å¾ˆå¤š goroutine åŒæ—¶æ‰§è¡Œå®Œæ¯•æ‰å»æ‰§è¡Œä¸‹ä¸€ç»„ goroutineã€‚è€Œå¯ä»¥å½“ä¸€ä¸ª goroutine æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œç›´æ¥å¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutineï¼Œä¹Ÿå°±æ˜¯ goroutine æ± çš„ä½¿ç”¨ã€‚<br>æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æ²¿ç€è¿™ä¸ªæ€è·¯è¿›ä¸€æ­¥ä¼˜åŒ–è¿™ä¸ªç¨‹åºä¸­èµ‹å€¼å™¨å¯¹ CPU çš„ä½¿ç”¨ç‡ã€‚</p><h3 id="ä¾‹2ï¼šé™ä½å¹¶å¤ç”¨å·²ç»ç”³è¯·çš„å†…å­˜"><a href="#ä¾‹2ï¼šé™ä½å¹¶å¤ç”¨å·²ç»ç”³è¯·çš„å†…å­˜" class="headerlink" title="ä¾‹2ï¼šé™ä½å¹¶å¤ç”¨å·²ç»ç”³è¯·çš„å†…å­˜"></a>ä¾‹2ï¼šé™ä½å¹¶å¤ç”¨å·²ç»ç”³è¯·çš„å†…å­˜</h3><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªéå¸¸ç®€å•çš„ Web ç¨‹åºæ¥è¯´æ˜å¤ç”¨å†…å­˜çš„é‡è¦æ€§ã€‚åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œæ¯å½“äº§ç”Ÿä¸€ä¸ª <code>/example2</code><br>çš„è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€æ®µå†…å­˜ï¼Œå¹¶ç”¨äºè¿›è¡Œä¸€äº›åç»­çš„å·¥ä½œã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line">_ <span class="string">"net/http/pprof"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newBuf</span><span class="params">()</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">10</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;()</span><br><span class="line">  </span><br><span class="line">http.HandleFunc(<span class="string">"/example2"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">b := newBuf()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿæ‰§è¡Œä¸€äº›å·¥ä½œ</span></span><br><span class="line"><span class="keyword">for</span> idx := <span class="keyword">range</span> b &#123;</span><br><span class="line">b[idx] = <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Fprintf(w, <span class="string">"done, %v"</span>, r.URL.Path[<span class="number">1</span>:])</span><br><span class="line">&#125;)</span><br><span class="line">http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è¿›è¡Œæ€§èƒ½åˆ†æï¼Œæˆ‘ä»¬è¿˜é¢å¤–åˆ›å»ºäº†ä¸€ä¸ªç›‘å¬ 6060 ç«¯å£çš„ goroutineï¼Œç”¨äºä½¿ç”¨ pprof è¿›è¡Œåˆ†æã€‚<br>æˆ‘ä»¬å…ˆè®©æœåŠ¡å™¨è·‘èµ·æ¥ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go build -o main</span><br><span class="line">$ ./main</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™æ¬¡ä½¿ç”¨ pprof çš„ trace æ¥æŸ¥çœ‹ GC åœ¨æ­¤æœåŠ¡å™¨ä¸­é¢å¯¹å¤§é‡è¯·æ±‚æ—¶å€™çš„çŠ¶æ€ï¼Œè¦ä½¿ç”¨ trace å¯ä»¥é€šè¿‡è®¿é—® <code>/debug/pprof/trace</code> è·¯ç”±æ¥è¿›è¡Œï¼Œå…¶ä¸­ <code>seconds</code> å‚æ•°è®¾ç½®ä¸º 20sï¼Œå¹¶å°† trace çš„ç»“æœä¿å­˜ä¸º <code>trace.out</code>:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ wget http://127.0.0.1:6060/debug/pprof/trace\?seconds\=20 -O trace.out</span><br><span class="line">--2020-01-01 22:13:34--  http://127.0.0.1:6060/debug/pprof/trace?seconds=20</span><br><span class="line">Connecting to 127.0.0.1:6060... connected.</span><br><span class="line">HTTP request sent, awaiting response...</span><br></pre></td></tr></table></figure><p>è¿™æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå‹æµ‹å·¥å…· <code>ab</code>ï¼Œæ¥åŒæ—¶äº§ç”Ÿ 500 ä¸ªè¯·æ±‚<br>ï¼ˆ<code>-n</code> ä¸€å…± 500 ä¸ªè¯·æ±‚ï¼Œ<code>-c</code> ä¸€ä¸ªæ—¶åˆ»æ‰§è¡Œè¯·æ±‚çš„æ•°é‡ï¼Œæ¯æ¬¡ 100 ä¸ªå¹¶å‘è¯·æ±‚ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 500 -c 100 http://127.0.0.1:8080/example2</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;<span class="variable">$Revision</span>: 1843412 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 127.0.0.1 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Completed 300 requests</span><br><span class="line">Completed 400 requests</span><br><span class="line">Completed 500 requests</span><br><span class="line">Finished 500 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        </span><br><span class="line">Server Hostname:        127.0.0.1</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /example2</span><br><span class="line">Document Length:        14 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   0.987 seconds</span><br><span class="line">Complete requests:      500</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      65500 bytes</span><br><span class="line">HTML transferred:       7000 bytes</span><br><span class="line">Requests per second:    506.63 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       197.382 [ms] (mean)</span><br><span class="line">Time per request:       1.974 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          64.81 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    1   1.1      0       7</span><br><span class="line">Processing:    13  179  77.5    170     456</span><br><span class="line">Waiting:       10  168  78.8    162     455</span><br><span class="line">Total:         14  180  77.3    171     458</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%    171</span><br><span class="line">  66%    203</span><br><span class="line">  75%    222</span><br><span class="line">  80%    239</span><br><span class="line">  90%    281</span><br><span class="line">  95%    335</span><br><span class="line">  98%    365</span><br><span class="line">  99%    400</span><br><span class="line"> 100%    458 (longest request)</span><br></pre></td></tr></table></figure><p><img src="./assets/gc-tuning-ex2-1.png" alt=""></p><p>GC åå¤è¢«è§¦å‘ï¼Œä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„åŸå› å°±æ˜¯å†…å­˜åˆ†é…è¿‡å¤šã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>go tool pprof</code> æ¥æŸ¥çœ‹ç©¶ç«Ÿæ˜¯è°åˆ†é…äº†å¤§é‡å†…å­˜ï¼ˆä½¿ç”¨ web æŒ‡ä»¤æ¥ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ç»Ÿè®¡ä¿¡æ¯çš„å¯è§†åŒ–å›¾å½¢ï¼‰ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ go tool pprof http://127.0.0.1:6060/debug/pprof/heap</span><br><span class="line">Fetching profile over HTTP from http://localhost:6060/debug/pprof/heap</span><br><span class="line">Saved profile <span class="keyword">in</span> /Users/changkun/pprof/pprof.alloc_objects.alloc_space.inuse_o</span><br><span class="line">bjects.inuse_space.003.pb.gz</span><br><span class="line">Type: inuse_space</span><br><span class="line">Time: Jan 1, 2020 at 11:15pm (CET)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">"help"</span> <span class="keyword">for</span> commands, <span class="string">"o"</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) web</span><br><span class="line">(pprof)</span><br></pre></td></tr></table></figure><p><img src="./assets/gc-tuning-ex2-2.png" alt=""></p><p>å¯è§ <code>newBuf</code> äº§ç”Ÿçš„ç”³è¯·çš„å†…å­˜è¿‡å¤šï¼Œç°åœ¨æˆ‘ä»¬ä½¿ç”¨ sync.Pool æ¥å¤ç”¨ <code>newBuf</code> æ‰€äº§ç”Ÿçš„å¯¹è±¡ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"net/http"</span></span><br><span class="line">_ <span class="string">"net/http/pprof"</span></span><br><span class="line"><span class="string">"sync"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨ sync.Pool å¤ç”¨éœ€è¦çš„ buf</span></span><br><span class="line"><span class="keyword">var</span> bufPool = sync.Pool&#123;</span><br><span class="line">New: <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">interface</span></span>&#123;&#125; &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">10</span>&lt;&lt;<span class="number">20</span>)</span><br><span class="line">&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.ListenAndServe(<span class="string">"localhost:6060"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;()</span><br><span class="line">http.HandleFunc(<span class="string">"/example2"</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">b := bufPool.Get().([]<span class="keyword">byte</span>)</span><br><span class="line"><span class="keyword">for</span> idx := <span class="keyword">range</span> b &#123;</span><br><span class="line">b[idx] = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Fprintf(w, <span class="string">"done, %v"</span>, r.URL.Path[<span class="number">1</span>:])</span><br><span class="line">bufPool.Put(b)</span><br><span class="line">&#125;)</span><br><span class="line">http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ ab è¾“å‡ºçš„ç»Ÿè®¡ç»“æœä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 500 -c 100 http://127.0.0.1:8080/example2</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;<span class="variable">$Revision</span>: 1843412 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 127.0.0.1 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Completed 300 requests</span><br><span class="line">Completed 400 requests</span><br><span class="line">Completed 500 requests</span><br><span class="line">Finished 500 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        </span><br><span class="line">Server Hostname:        127.0.0.1</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /example2</span><br><span class="line">Document Length:        14 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   0.427 seconds</span><br><span class="line">Complete requests:      500</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      65500 bytes</span><br><span class="line">HTML transferred:       7000 bytes</span><br><span class="line">Requests per second:    1171.32 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       85.374 [ms] (mean)</span><br><span class="line">Time per request:       0.854 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          149.85 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    1   1.4      1       9</span><br><span class="line">Processing:     5   75  48.2     66     211</span><br><span class="line">Waiting:        5   72  46.8     63     207</span><br><span class="line">Total:          5   77  48.2     67     211</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%     67</span><br><span class="line">  66%     89</span><br><span class="line">  75%    107</span><br><span class="line">  80%    122</span><br><span class="line">  90%    148</span><br><span class="line">  95%    167</span><br><span class="line">  98%    196</span><br><span class="line">  99%    204</span><br><span class="line"> 100%    211 (longest request)</span><br></pre></td></tr></table></figure><p>ä½†ä» <code>Requests per second</code> æ¯ç§’è¯·æ±‚æ•°æ¥çœ‹ï¼Œä»åŸæ¥çš„ 506.63 å˜ä¸º 1171.32 å¾—åˆ°äº†è¿‘ä¹ä¸€å€çš„æå‡ã€‚ä» trace çš„ç»“æœæ¥çœ‹ï¼ŒGC ä¹Ÿæ²¡æœ‰é¢‘ç¹çš„è¢«è§¦å‘ä»è€Œé•¿æœŸæ¶ˆè€— CPU ä½¿ç”¨ç‡ï¼š</p><p><img src="./assets/gc-tuning-ex2-3.png" alt=""></p><p>sync.Pool æ˜¯å†…å­˜å¤ç”¨çš„ä¸€ä¸ªæœ€ä¸ºæ˜¾è‘—çš„ä¾‹å­ï¼Œä»è¯­è¨€å±‚é¢ä¸Šè¿˜æœ‰å¾ˆå¤šç±»ä¼¼çš„ä¾‹å­ï¼Œä¾‹å¦‚åœ¨ä¾‹ 1 ä¸­ï¼Œ<code>concat</code> å‡½æ•°å¯ä»¥é¢„å…ˆåˆ†é…ä¸€å®šé•¿åº¦çš„ç¼“å­˜ï¼Œè€Œåå†é€šè¿‡ append çš„æ–¹å¼å°†å­—ç¬¦ä¸²å­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">concat</span><span class="params">()</span></span> &#123;</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line"><span class="keyword">for</span> n := <span class="number">0</span>; n &lt; <span class="number">100</span>; n++ &#123;</span><br><span class="line">wg.Add(<span class="number">8</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">8</span>; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">s := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, <span class="number">20</span>)</span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="string">"Go GC"</span>...)</span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="string">' '</span>)</span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="string">"Hello"</span>...)</span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="string">' '</span>)</span><br><span class="line">s = <span class="built_in">append</span>(s, <span class="string">"World"</span>...)</span><br><span class="line">_ = <span class="keyword">string</span>(s)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸå› åœ¨äº <code>+</code> è¿ç®—ç¬¦ä¼šéšç€å­—ç¬¦ä¸²é•¿åº¦çš„å¢åŠ è€Œç”³è¯·æ›´å¤šçš„å†…å­˜ï¼Œå¹¶å°†å†…å®¹ä»åŸæ¥çš„å†…å­˜ä½ç½®æ‹·è´åˆ°æ–°çš„å†…å­˜ä½ç½®ï¼Œé€ æˆå¤§é‡ä¸å¿…è¦çš„å†…å­˜åˆ†é…ï¼Œå…ˆæå‰åˆ†é…å¥½è¶³å¤Ÿçš„å†…å­˜ï¼Œå†æ…¢æ…¢åœ°å¡«å……ï¼Œä¹Ÿæ˜¯ä¸€ç§å‡å°‘å†…å­˜åˆ†é…ã€å¤ç”¨å†…å­˜å½¢å¼çš„ä¸€ç§è¡¨ç°ã€‚</p><h3 id="ä¾‹3ï¼šè°ƒæ•´-GOGC"><a href="#ä¾‹3ï¼šè°ƒæ•´-GOGC" class="headerlink" title="ä¾‹3ï¼šè°ƒæ•´ GOGC"></a>ä¾‹3ï¼šè°ƒæ•´ GOGC</h3><p>æˆ‘ä»¬å·²ç»çŸ¥é“äº† GC çš„è§¦å‘åŸåˆ™æ˜¯ç”±æ­¥è°ƒç®—æ³•æ¥æ§åˆ¶çš„ï¼Œå…¶å…³é”®åœ¨äºä¼°è®¡ä¸‹ä¸€æ¬¡éœ€è¦è§¦å‘ GC æ—¶ï¼Œå †çš„å¤§å°ã€‚å¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æœæˆ‘ä»¬åœ¨é‡åˆ°æµ·é‡è¯·æ±‚çš„æ—¶ï¼Œä¸ºäº†é¿å… GC é¢‘ç¹è§¦å‘ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡å°† GOGC çš„å€¼è®¾ç½®å¾—æ›´å¤§ï¼Œè®© GC è§¦å‘çš„æ—¶é—´å˜å¾—æ›´æ™šï¼Œä»è€Œå‡å°‘å…¶è§¦å‘é¢‘ç‡ï¼Œè¿›è€Œå¢åŠ ç”¨æˆ·ä»£ç å¯¹æœºå™¨çš„ä½¿ç”¨ç‡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚</p><p>æˆ‘ä»¬å¯ä»¥éå¸¸ç®€å•ç²—æš´çš„å°† GOGC è°ƒæ•´ä¸º 1000ï¼Œæ¥æ‰§è¡Œä¸Šä¸€ä¸ªä¾‹å­ä¸­æœªå¤ç”¨å¯¹è±¡ä¹‹å‰çš„ç¨‹åºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ GOGC=1000 ./main</span><br></pre></td></tr></table></figure><p>è¿™æ—¶æˆ‘ä»¬å†é‡æ–°æ‰§è¡Œå‹æµ‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">$ ab -n 500 -c 100 http://127.0.0.1:8080/example2</span><br><span class="line">This is ApacheBench, Version 2.3 &lt;<span class="variable">$Revision</span>: 1843412 $&gt;</span><br><span class="line">Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/</span><br><span class="line">Licensed to The Apache Software Foundation, http://www.apache.org/</span><br><span class="line"></span><br><span class="line">Benchmarking 127.0.0.1 (be patient)</span><br><span class="line">Completed 100 requests</span><br><span class="line">Completed 200 requests</span><br><span class="line">Completed 300 requests</span><br><span class="line">Completed 400 requests</span><br><span class="line">Completed 500 requests</span><br><span class="line">Finished 500 requests</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Server Software:        </span><br><span class="line">Server Hostname:        127.0.0.1</span><br><span class="line">Server Port:            8080</span><br><span class="line"></span><br><span class="line">Document Path:          /example2</span><br><span class="line">Document Length:        14 bytes</span><br><span class="line"></span><br><span class="line">Concurrency Level:      100</span><br><span class="line">Time taken <span class="keyword">for</span> tests:   0.923 seconds</span><br><span class="line">Complete requests:      500</span><br><span class="line">Failed requests:        0</span><br><span class="line">Total transferred:      65500 bytes</span><br><span class="line">HTML transferred:       7000 bytes</span><br><span class="line">Requests per second:    541.61 [<span class="comment">#/sec] (mean)</span></span><br><span class="line">Time per request:       184.636 [ms] (mean)</span><br><span class="line">Time per request:       1.846 [ms] (mean, across all concurrent requests)</span><br><span class="line">Transfer rate:          69.29 [Kbytes/sec] received</span><br><span class="line"></span><br><span class="line">Connection Times (ms)</span><br><span class="line">              min  mean[+/-sd] median   max</span><br><span class="line">Connect:        0    1   1.8      0      20</span><br><span class="line">Processing:     9  171 210.4     66     859</span><br><span class="line">Waiting:        5  158 199.6     62     813</span><br><span class="line">Total:          9  173 210.6     68     860</span><br><span class="line"></span><br><span class="line">Percentage of the requests served within a certain time (ms)</span><br><span class="line">  50%     68</span><br><span class="line">  66%    133</span><br><span class="line">  75%    198</span><br><span class="line">  80%    292</span><br><span class="line">  90%    566</span><br><span class="line">  95%    696</span><br><span class="line">  98%    723</span><br><span class="line">  99%    743</span><br><span class="line"> 100%    860 (longest request)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå‹æµ‹çš„ç»“æœå¾—åˆ°äº†ä¸€å®šå¹…åº¦çš„æ”¹å–„ï¼ˆ<code>Requests per second</code> ä»åŸæ¥çš„ 506.63 æé«˜ä¸ºäº† 541.61ï¼‰ï¼Œ<br>å¹¶ä¸” GC çš„æ‰§è¡Œé¢‘ç‡æ˜æ˜¾é™ä½ï¼š</p><p><img src="./assets/gc-tuning-ex3.png" alt=""></p><p>åœ¨å®é™…å®è·µä¸­å¯è¡¨ç°ä¸ºéœ€è¦ç´§æ€¥å¤„ç†ä¸€äº›ç”± GC å¸¦æ¥çš„ç“¶é¢ˆæ—¶ï¼Œäººä¸ºå°† GOGC è°ƒå¤§ï¼ŒåŠ é’±åŠ å†…å­˜ï¼Œæ‰›è¿‡è¿™ä¸€æ®µå³°å€¼æµé‡æ—¶æœŸã€‚</p><p>å½“ç„¶ï¼Œè¿™ç§åšæ³•å…¶å®æ˜¯æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¹¶æ²¡æœ‰ä»æ ¹æœ¬ä¸Šè§£å†³å†…å­˜åˆ†é…è¿‡äºé¢‘ç¹çš„é—®é¢˜ï¼Œæç«¯æƒ…å†µä¸‹ï¼Œåè€Œä¼šç”±äº GOGC å¤ªå¤§è€Œå¯¼è‡´å›æ”¶ä¸åŠæ—¶è€Œè€—è´¹æ›´å¤šçš„æ—¶é—´æ¥æ¸…ç†äº§ç”Ÿçš„åƒåœ¾ï¼Œè¿™å¯¹æ—¶é—´ä¸ç®—æ•æ„Ÿçš„åº”ç”¨è¿˜å¥½ï¼Œä½†å¯¹å®æ—¶æ€§è¦æ±‚è¾ƒé«˜çš„ç¨‹åºæ¥è¯´å°±æ˜¯è‡´å‘½çš„æ‰“å‡»äº†ã€‚</p><p>å› æ­¤è¿™æ—¶æ›´å¦¥å½“çš„åšæ³•ä»ç„¶æ˜¯ï¼Œå®šä½é—®é¢˜çš„æ‰€åœ¨ï¼Œå¹¶ä»ä»£ç å±‚é¢ä¸Šè¿›è¡Œä¼˜åŒ–ã€‚</p><h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>é€šè¿‡ä¸Šé¢çš„ä¸‰ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ GC è°ƒä¼˜è¿‡ç¨‹ä¸­ <code>go tool pprof</code> å’Œ <code>go tool trace</code> çš„å¼ºå¤§ä½œç”¨æ˜¯å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ GC å¯¼è‡´ç“¶é¢ˆçš„å…·ä½“ä½ç½®ï¼Œä½†è¿™äº›ä¾‹å­ä¸­ä»…ä»…è¦†ç›–äº†å…¶åŠŸèƒ½çš„å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰å¿…è¦å®Œæ•´è¦†ç›–æ‰€æœ‰çš„åŠŸèƒ½ï¼Œå› ä¸ºæ€»æ˜¯å¯ä»¥é€šè¿‡<a href="https://golang.org/pkg/net/http/pprof/" target="_blank" rel="noopener">http pprof å®˜æ–¹æ–‡æ¡£</a>ã€<a href="https://golang.org/pkg/runtime/pprof/" target="_blank" rel="noopener">runtime pprofå®˜æ–¹æ–‡æ¡£</a>ä»¥åŠ<a href="https://golang.org/pkg/runtime/trace/" target="_blank" rel="noopener">trace å®˜æ–¹æ–‡æ¡£</a>æ¥ä¸¾ä¸€åä¸‰ã€‚</p><p>ç°åœ¨æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å‰é¢ä¸‰ä¸ªä¾‹å­ä¸­çš„ä¼˜åŒ–æƒ…å†µï¼š</p><ol><li>æ§åˆ¶å†…å­˜åˆ†é…çš„é€Ÿåº¦ï¼Œé™åˆ¶ goroutine çš„æ•°é‡ï¼Œä»è€Œæé«˜èµ‹å€¼å™¨å¯¹ CPU çš„åˆ©ç”¨ç‡ã€‚</li><li>å‡å°‘å¹¶å¤ç”¨å†…å­˜ï¼Œä¾‹å¦‚ä½¿ç”¨ sync.Pool æ¥å¤ç”¨éœ€è¦é¢‘ç¹åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼Œä¾‹å¦‚æå‰åˆ†é…è¶³å¤Ÿçš„å†…å­˜æ¥é™ä½å¤šä½™çš„æ‹·è´ã€‚</li><li>éœ€è¦æ—¶ï¼Œå¢å¤§ GOGC çš„å€¼ï¼Œé™ä½ GC çš„è¿è¡Œé¢‘ç‡ã€‚</li></ol><p>è¿™ä¸‰ç§æƒ…å†µå‡ ä¹æ¶µç›–äº† GC è°ƒä¼˜ä¸­çš„æ ¸å¿ƒæ€è·¯ï¼Œè™½ç„¶ä»è¯­è¨€ä¸Šè¿˜æœ‰å¾ˆå¤šå°æŠ€å·§å¯è¯´ï¼Œä½†æˆ‘ä»¬å¹¶ä¸ä¼šåœ¨è¿™é‡Œäº‹æ— å·¨ç»†çš„è¿›è¡Œæ€»ç»“ã€‚å®é™…æƒ…å†µä¹Ÿæ˜¯åƒå˜ä¸‡åŒ–ï¼Œæˆ‘ä»¬æ›´åº”è¯¥ç€é‡äºåŸ¹å…»å…·ä½“é—®é¢˜å…·ä½“åˆ†æçš„èƒ½åŠ›ã€‚</p><p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥è°¨è®° <strong>è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æº</strong>è¿™ä¸€è­¦è¯­ï¼Œåœ¨æ²¡æœ‰é‡åˆ°åº”ç”¨çš„çœŸæ­£ç“¶é¢ˆæ—¶ï¼Œå°†å®è´µçš„æ—¶é—´åˆ†é…åœ¨å¼€å‘ä¸­å…¶ä»–ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ä¸Šã€‚</p><h2 id="15-Go-çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ç›¸å…³çš„-APIï¼Ÿå…¶ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#15-Go-çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ç›¸å…³çš„-APIï¼Ÿå…¶ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="15. Go çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ç›¸å…³çš„ APIï¼Ÿå…¶ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>15. Go çš„åƒåœ¾å›æ”¶å™¨æœ‰å“ªäº›ç›¸å…³çš„ APIï¼Ÿå…¶ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>åœ¨ Go ä¸­å­˜åœ¨æ•°é‡æå°‘çš„ä¸ GC ç›¸å…³çš„ APIï¼Œå®ƒä»¬æ˜¯</p><ul><li>runtime.GCï¼šæ‰‹åŠ¨è§¦å‘ GC</li><li>runtime.ReadMemStatsï¼šè¯»å–å†…å­˜ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«éƒ¨åˆ† GC ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯</li><li>debug.FreeOSMemoryï¼šæ‰‹åŠ¨å°†å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ</li><li>debug.ReadGCStatsï¼šè¯»å–å…³äº GC çš„ç›¸å…³ç»Ÿè®¡ä¿¡æ¯</li><li>debug.SetGCPercentï¼šè®¾ç½® GOGC è°ƒæ­¥å˜é‡</li><li>debug.SetMaxHeapï¼ˆå°šæœªå‘å¸ƒï¼‰ï¼šè®¾ç½® Go ç¨‹åºå †çš„ä¸Šé™å€¼<!-- - https://github.com/golang/go/issues/23044 --></li></ul><h1 id="GC-çš„å†å²åŠæ¼”è¿›"><a href="#GC-çš„å†å²åŠæ¼”è¿›" class="headerlink" title="GC çš„å†å²åŠæ¼”è¿›"></a>GC çš„å†å²åŠæ¼”è¿›</h1><h2 id="16-Go-å†å²å„ä¸ªç‰ˆæœ¬åœ¨-GC-æ–¹é¢çš„æ”¹è¿›ï¼Ÿ"><a href="#16-Go-å†å²å„ä¸ªç‰ˆæœ¬åœ¨-GC-æ–¹é¢çš„æ”¹è¿›ï¼Ÿ" class="headerlink" title="16. Go å†å²å„ä¸ªç‰ˆæœ¬åœ¨ GC æ–¹é¢çš„æ”¹è¿›ï¼Ÿ"></a>16. Go å†å²å„ä¸ªç‰ˆæœ¬åœ¨ GC æ–¹é¢çš„æ”¹è¿›ï¼Ÿ</h2><ul><li><p>Go 1ï¼šä¸²è¡Œä¸‰è‰²æ ‡è®°æ¸…æ‰«</p></li><li><p>Go 1.3ï¼šå¹¶è¡Œæ¸…æ‰«ï¼Œæ ‡è®°è¿‡ç¨‹éœ€è¦ STWï¼Œåœé¡¿æ—¶é—´åœ¨çº¦å‡ ç™¾æ¯«ç§’</p></li><li><p>Go 1.5ï¼šå¹¶å‘æ ‡è®°æ¸…æ‰«ï¼Œåœé¡¿æ—¶é—´åœ¨ä¸€ç™¾æ¯«ç§’ä»¥å†…</p></li><li><p>Go 1.6ï¼šä½¿ç”¨ bitmap æ¥è®°å½•å›æ”¶å†…å­˜çš„ä½ç½®ï¼Œå¤§å¹…ä¼˜åŒ–åƒåœ¾å›æ”¶å™¨è‡ªèº«æ¶ˆè€—çš„å†…å­˜ï¼Œåœé¡¿æ—¶é—´åœ¨åæ¯«ç§’ä»¥å†…</p></li><li><p>Go 1.7ï¼šåœé¡¿æ—¶é—´æ§åˆ¶åœ¨ä¸¤æ¯«ç§’ä»¥å†…</p></li><li><p>Go 1.8ï¼šæ··åˆå†™å±éšœï¼Œåœé¡¿æ—¶é—´åœ¨åŠä¸ªæ¯«ç§’å·¦å³</p></li><li><p>Go 1.9ï¼šå½»åº•ç§»é™¤äº†æ ˆçš„é‡æ‰«æè¿‡ç¨‹ </p></li><li><p>Go 1.12ï¼šæ•´åˆäº†ä¸¤ä¸ªé˜¶æ®µçš„ Mark Terminationï¼Œä½†å¼•å…¥äº†ä¸€ä¸ªä¸¥é‡çš„ GC Bug è‡³ä»Šæœªä¿®ï¼ˆè§é—®é¢˜ 20ï¼‰ï¼Œå°šæ— è¯¥ Bug å¯¹ GC æ€§èƒ½å½±å“çš„æŠ¥å‘Š</p></li><li><p>Go 1.13ï¼šç€æ‰‹è§£å†³å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜çš„ï¼Œæå‡ºäº†æ–°çš„ Scavenger</p></li><li><p>Go 1.14ï¼šæ›¿ä»£äº†ä»…å­˜æ´»äº†ä¸€ä¸ªç‰ˆæœ¬çš„ scavengerï¼Œå…¨æ–°çš„é¡µåˆ†é…å™¨ï¼Œä¼˜åŒ–åˆ†é…å†…å­˜è¿‡ç¨‹çš„é€Ÿç‡ä¸ç°æœ‰çš„æ‰©å±•æ€§é—®é¢˜ï¼Œå¹¶å¼•å…¥äº†å¼‚æ­¥æŠ¢å ï¼Œè§£å†³äº†ç”±äºå¯†é›†å¾ªç¯å¯¼è‡´çš„ STW æ—¶é—´è¿‡é•¿çš„é—®é¢˜</p></li></ul><p>å¯ä»¥ç”¨ä¸‹å›¾ç›´è§‚åœ°è¯´æ˜ GC çš„æ¼”è¿›å†å²ï¼š</p><p><img src="assets/gc1.png" alt=""></p><p>åœ¨ Go 1 åˆšå‘å¸ƒæ—¶çš„ç‰ˆæœ¬ä¸­ï¼Œç”šè‡³æ²¡æœ‰å°† Mark-Sweep çš„è¿‡ç¨‹å¹¶è¡ŒåŒ–ï¼Œå½“éœ€è¦è¿›è¡Œåƒåœ¾å›æ”¶æ—¶ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½å¿…é¡»è¿›å…¥ STW çš„çŠ¶æ€ã€‚è€Œåˆ°äº† Go 1.1 æ—¶ï¼Œå®˜æ–¹è¿…é€Ÿåœ°å°†æ¸…æ‰«è¿‡ç¨‹è¿›è¡Œäº†å¹¶è¡ŒåŒ–çš„å¤„ç†ï¼Œå³ä»…åœ¨æ ‡è®°é˜¶æ®µè¿›å…¥ STWã€‚</p><p>è¿™ä¸€æƒ³æ³•å¾ˆè‡ªç„¶ï¼Œå› ä¸ºå¹¶è¡ŒåŒ–å¯¼è‡´ç®—æ³•ç»“æœä¸ä¸€è‡´çš„æƒ…å†µä»…ä»…å‘ç”Ÿåœ¨æ ‡è®°é˜¶æ®µï¼Œè€Œå½“æ—¶çš„åƒåœ¾å›æ”¶å™¨æ²¡æœ‰é’ˆå¯¹å¹¶è¡Œç»“æœçš„ä¸€è‡´æ€§è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼Œå› æ­¤æ‰éœ€è¦åœ¨æ ‡è®°é˜¶æ®µè¿›å…¥ STWã€‚å¯¹äº Scavenger è€Œè¨€ï¼Œæ—©æœŸçš„ç‰ˆæœ¬ä¸­ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å®šæœŸå°†å¤šä½™çš„å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚</p><p><img src="assets/gc2.png" alt=""></p><p>è€Œåˆ°äº† Go 1.5 åï¼ŒGo å›¢é˜ŸèŠ±è´¹äº†ç›¸å½“å¤§çš„åŠ›æ°”ï¼Œé€šè¿‡å¼•å…¥å†™å±éšœçš„æœºåˆ¶æ¥ä¿è¯ç®—æ³•çš„ä¸€è‡´æ€§ï¼Œæ‰å¾—ä»¥å°†æ•´ä¸ª GC æ§åˆ¶åœ¨å¾ˆå°çš„ STW å†…ï¼Œè€Œåˆ°äº† 1.8 æ—¶ï¼Œç”±äºæ–°çš„æ··åˆå±éšœçš„å‡ºç°ï¼Œæ¶ˆé™¤äº†å¯¹æ ˆæœ¬èº«çš„é‡æ–°æ‰«æï¼ŒSTW çš„æ—¶é—´è¿›ä¸€æ­¥ç¼©å‡ã€‚</p><p>ä»è¿™ä¸ªæ—¶å€™å¼€å§‹ï¼ŒScavenger å·²ç»ä»ç‹¬ç«‹çº¿ç¨‹ä¸­ç§»é™¤ï¼Œå¹¶åˆå¹¶è‡³ç³»ç»Ÿç›‘æ§è¿™ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œå¹¶å‘¨æœŸæ€§åœ°å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜ï¼Œä½†ä»ç„¶ä¼šæœ‰å†…å­˜æº¢å‡ºè¿™ç§æ¯”è¾ƒæç«¯çš„æƒ…å†µå‡ºç°ï¼Œå› ä¸ºç¨‹åºå¯èƒ½åœ¨çŸ­æ—¶é—´å†…åº”å¯¹çªå‘æ€§çš„å†…å­˜ç”³è¯·éœ€æ±‚æ—¶ï¼Œå†…å­˜è¿˜æ²¡æ¥å¾—åŠå½’è¿˜æ“ä½œç³»ç»Ÿï¼Œå¯¼è‡´å †ä¸æ–­å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œä»è€Œå‡ºç°å†…å­˜æº¢å‡ºã€‚</p><p><img src="assets/gc3.png" alt=""></p><p>åˆ°äº† Go 1.13ï¼Œå®šæœŸå½’è¿˜æ“ä½œç³»ç»Ÿçš„é—®é¢˜å¾—ä»¥è§£å†³ï¼ŒGo å›¢é˜Ÿå¼€å§‹å°†å‘¨æœŸæ€§çš„ Scavenger è½¬åŒ–ä¸ºå¯è¢«è°ƒåº¦çš„ goroutineï¼Œå¹¶å°†å…¶ä¸ç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œã€‚è€Œåˆ°äº† Go 1.14ï¼Œè¿™ä¸€å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜çš„æ“ä½œæ—¶é—´è¿›ä¸€æ­¥å¾—åˆ°ç¼©å‡ã€‚</p><h2 id="17-Go-GC-åœ¨æ¼”åŒ–è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨å“ªäº›å…¶ä»–è®¾è®¡ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é‡‡ç”¨ï¼Ÿ"><a href="#17-Go-GC-åœ¨æ¼”åŒ–è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨å“ªäº›å…¶ä»–è®¾è®¡ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é‡‡ç”¨ï¼Ÿ" class="headerlink" title="17. Go GC åœ¨æ¼”åŒ–è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨å“ªäº›å…¶ä»–è®¾è®¡ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é‡‡ç”¨ï¼Ÿ"></a>17. Go GC åœ¨æ¼”åŒ–è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨å“ªäº›å…¶ä»–è®¾è®¡ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é‡‡ç”¨ï¼Ÿ</h2><h3 id="å¹¶å‘æ ˆé‡æ‰«"><a href="#å¹¶å‘æ ˆé‡æ‰«" class="headerlink" title="å¹¶å‘æ ˆé‡æ‰«"></a>å¹¶å‘æ ˆé‡æ‰«</h3><p>æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´ï¼Œå…è®¸ç°è‰²èµ‹å€¼å™¨å­˜åœ¨çš„åƒåœ¾å›æ”¶å™¨éœ€è¦å¼•å…¥é‡æ‰«è¿‡ç¨‹æ¥ä¿è¯ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œé™¤äº†å¼•å…¥æ··åˆå±éšœæ¥æ¶ˆé™¤é‡æ‰«è¿™ä¸€è¿‡ç¨‹å¤–ï¼Œæœ‰å¦ä¸€ç§åšæ³•å¯ä»¥æé«˜é‡æ‰«è¿‡ç¨‹çš„æ€§èƒ½ï¼Œé‚£å°±æ˜¯å°†é‡æ‰«çš„è¿‡ç¨‹å¹¶å‘æ‰§è¡Œã€‚ç„¶è€Œè¿™ä¸€<a href="https://github.com/golang/proposal/blob/master/design/17505-concurrent-rescan.md" target="_blank" rel="noopener">æ–¹æ¡ˆ</a>å¹¶æ²¡æœ‰å¾—ä»¥å®ç°ï¼ŒåŸå› å¾ˆç®€å•ï¼šå®ç°è¿‡ç¨‹ç›¸æ¯”å¼•å…¥æ··åˆå±éšœè€Œè¨€ååˆ†å¤æ‚ï¼Œè€Œä¸”å¼•å…¥æ··åˆå±éšœèƒ½å¤Ÿæ¶ˆé™¤é‡æ‰«è¿™ä¸€è¿‡ç¨‹ï¼Œå°†ç®€åŒ–åƒåœ¾å›æ”¶çš„æ­¥éª¤ã€‚</p><h3 id="ROC"><a href="#ROC" class="headerlink" title="ROC"></a>ROC</h3><p>ROC çš„å…¨ç§°æ˜¯<a href="https://docs.google.com/document/d/1gCsFxXamW8RRvOe5hECz98Ftk-tcRRJcDFANj2VwCB0/edit" target="_blank" rel="noopener">é¢å‘è¯·æ±‚çš„å›æ”¶å™¨</a>ï¼ˆRequest Oriented Collectorï¼‰ï¼Œå®ƒå…¶å®ä¹Ÿæ˜¯åˆ†ä»£ GC çš„ä¸€ç§é‡æ–°å™è¿°ã€‚å®ƒæå‡ºäº†ä¸€ä¸ªè¯·æ±‚å‡è®¾ï¼ˆRequest Hypothesisï¼‰ï¼šä¸ä¸€ä¸ªå®Œæ•´è¯·æ±‚ã€ä¼‘çœ  goroutine æ‰€å…³è”çš„å¯¹è±¡æ¯”å…¶ä»–å¯¹è±¡æ›´å®¹æ˜“æ­»äº¡ã€‚è¿™ä¸ªå‡è®¾å¬èµ·æ¥éå¸¸ç¬¦åˆç›´è§‰ï¼Œä½†åœ¨å®ç°ä¸Šï¼Œç”±äºåƒåœ¾å›æ”¶å™¨å¿…é¡»ç¡®ä¿æ˜¯å¦æœ‰ goroutine ç§æœ‰æŒ‡é’ˆè¢«å†™å…¥å…¬å…±å¯¹è±¡ï¼Œå› æ­¤å†™å±éšœå¿…é¡»ä¸€ç›´æ‰“å¼€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†è¯¥æ–¹æ³•çš„è‡´å‘½ç¼ºç‚¹ï¼šæ˜‚è´µçš„å†™å±éšœåŠå…¶å¸¦æ¥çš„ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸€è®¾è®¡æœ€ç»ˆæ²¡æœ‰è¢«é‡‡ç”¨çš„ä¸»è¦åŸå› ã€‚</p><h3 id="ä¼ ç»Ÿåˆ†ä»£-GC"><a href="#ä¼ ç»Ÿåˆ†ä»£-GC" class="headerlink" title="ä¼ ç»Ÿåˆ†ä»£ GC"></a>ä¼ ç»Ÿåˆ†ä»£ GC</h3><p>åœ¨å‘ç° ROC æ€§èƒ½ä¸è¡Œä¹‹åï¼Œä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼ŒGo å›¢é˜Ÿè¿˜å°è¯•äº†å®ç°<a href="https://go-review.googlesource.com/c/go/+/137476/12" target="_blank" rel="noopener">ä¼ ç»Ÿçš„åˆ†ä»£å¼ GC</a>ã€‚ä½†æœ€ç»ˆåŒæ ·å‘ç°åˆ†ä»£å‡è®¾å¹¶ä¸é€‚ç”¨äº Go çš„è¿è¡Œæ ˆæœºåˆ¶ï¼Œå¹´è½»ä»£å¯¹è±¡åœ¨æ ˆä¸Šå°±å·²ç»æ­»äº¡ï¼Œæ‰«ææœ¬å°±è¯¥å›æ”¶çš„æ‰§è¡Œæ ˆå¹¶æ²¡æœ‰ä¸ºç”±äºåˆ†ä»£å‡è®¾å¸¦æ¥æ˜æ˜¾çš„æ€§èƒ½æå‡ã€‚è¿™ä¹Ÿæ˜¯è¿™ä¸€è®¾è®¡æœ€ç»ˆæ²¡æœ‰è¢«é‡‡ç”¨çš„ä¸»è¦åŸå› ã€‚</p><h2 id="18-ç›®å‰æä¾›-GC-çš„è¯­è¨€ä»¥åŠä¸æä¾›-GC-çš„è¯­è¨€æœ‰å“ªäº›ï¼ŸGC-å’Œ-No-GC-å„è‡ªçš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#18-ç›®å‰æä¾›-GC-çš„è¯­è¨€ä»¥åŠä¸æä¾›-GC-çš„è¯­è¨€æœ‰å“ªäº›ï¼ŸGC-å’Œ-No-GC-å„è‡ªçš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="18. ç›®å‰æä¾› GC çš„è¯­è¨€ä»¥åŠä¸æä¾› GC çš„è¯­è¨€æœ‰å“ªäº›ï¼ŸGC å’Œ No GC å„è‡ªçš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ"></a>18. ç›®å‰æä¾› GC çš„è¯­è¨€ä»¥åŠä¸æä¾› GC çš„è¯­è¨€æœ‰å“ªäº›ï¼ŸGC å’Œ No GC å„è‡ªçš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>ä»åŸç†ä¸Šè€Œè¨€ï¼Œæ‰€æœ‰çš„è¯­è¨€éƒ½èƒ½å¤Ÿè‡ªè¡Œå®ç° GCã€‚ä»è¯­è¨€è¯ç”Ÿä¹‹åˆå°±æä¾› GC çš„è¯­è¨€ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Python</li><li>JavaScript</li><li>Java</li><li>Objective-C</li><li>Swift</li></ul><p>è€Œä¸ä»¥ GC ä¸ºç›®æ ‡ï¼Œè¢«ç›´æ¥è®¾è®¡ä¸ºæ‰‹åŠ¨ç®¡ç†å†…å­˜ã€ä½†å¯ä»¥è‡ªè¡Œå®ç° GC çš„è¯­è¨€æœ‰ï¼š</p><ul><li>C</li><li>C++</li></ul><p>ä¹Ÿæœ‰ä¸€äº›è¯­è¨€å¯ä»¥åœ¨ç¼–è¯‘æœŸï¼Œä¾é ç¼–è¯‘å™¨æ’å…¥æ¸…ç†ä»£ç çš„æ–¹å¼ï¼Œå®ç°ç²¾å‡†çš„æ¸…ç†ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Rust</li></ul><p>åƒåœ¾å›æ”¶ä½¿ç¨‹åºå‘˜æ— éœ€æ‰‹åŠ¨å¤„ç†å†…å­˜é‡Šæ”¾ï¼Œä»è€Œèƒ½å¤Ÿæ¶ˆé™¤ä¸€äº›éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜æ‰ä¼šå‡ºç°çš„è¿è¡Œæ—¶é”™è¯¯ï¼š</p><ol><li>åœ¨ä»ç„¶æœ‰æŒ‡å‘å†…å­˜åŒºå—çš„æŒ‡é’ˆçš„æƒ…å†µä¸‹é‡Šæ”¾è¿™å—å†…å­˜æ—¶ï¼Œä¼šäº§ç”Ÿæ‚¬æŒ‚æŒ‡é’ˆï¼Œä»è€Œåç»­å¯èƒ½é”™è¯¯çš„è®¿é—®å·²ç»ç”¨äºä»–ç”¨çš„å†…å­˜åŒºåŸŸã€‚</li><li>å¤šé‡é‡Šæ”¾åŒä¸€å—ç”³è¯·çš„å†…å­˜åŒºåŸŸå¯èƒ½å¯¼è‡´ä¸å¯çŸ¥çš„å†…å­˜æŸåã€‚</li></ol><p>å½“ç„¶ï¼Œåƒåœ¾å›æ”¶ä¹Ÿä¼šä¼´éšä¸€äº›ç¼ºé™·ï¼Œè¿™ä¹Ÿå°±é€ å°±äº†æ²¡æœ‰ GC çš„ä¸€äº›ä¼˜åŠ¿ï¼š</p><ol><li>æ²¡æœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€</li><li>ç²¾å‡†çš„æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œæè‡´çš„åˆ©ç”¨æœºå™¨çš„æ€§èƒ½</li></ol><h2 id="19-Go-å¯¹æ¯”-Javaã€V8-ä¸­-JavaScript-çš„-GC-æ€§èƒ½å¦‚ä½•ï¼Ÿ"><a href="#19-Go-å¯¹æ¯”-Javaã€V8-ä¸­-JavaScript-çš„-GC-æ€§èƒ½å¦‚ä½•ï¼Ÿ" class="headerlink" title="19. Go å¯¹æ¯” Javaã€V8 ä¸­ JavaScript çš„ GC æ€§èƒ½å¦‚ä½•ï¼Ÿ"></a>19. Go å¯¹æ¯” Javaã€V8 ä¸­ JavaScript çš„ GC æ€§èƒ½å¦‚ä½•ï¼Ÿ</h2><p>æ— è®ºæ˜¯ Java è¿˜æ˜¯ JavaScript ä¸­çš„ GC å‡ä¸ºåˆ†ä»£å¼ GCã€‚åˆ†ä»£å¼ GC çš„ä¸€ä¸ªæ ¸å¿ƒå‡è®¾å°±æ˜¯åˆ†ä»£å‡è¯´ï¼šå°†å¯¹è±¡ä¾æ®å­˜æ´»æ—¶é—´åˆ†é…åˆ°ä¸åŒçš„åŒºåŸŸï¼Œæ¯æ¬¡å›æ”¶åªå›æ”¶å…¶ä¸­çš„ä¸€ä¸ªåŒºåŸŸã€‚</p><h3 id="V8-çš„-GC"><a href="#V8-çš„-GC" class="headerlink" title="V8 çš„ GC"></a>V8 çš„ GC</h3><p>åœ¨ V8 ä¸­ä¸»è¦å°†å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ã€‚æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒçŸ­çš„å¯¹è±¡ï¼Œè€ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒé•¿ã€å¸¸é©»å†…å­˜ã€å ç”¨å†…å­˜è¾ƒå¤§çš„å¯¹è±¡ï¼š</p><ol><li>æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸»è¦é€šè¿‡å‰¯åƒåœ¾å›æ”¶å™¨è¿›è¡Œå›æ”¶ã€‚è¯¥å›æ”¶è¿‡ç¨‹æ˜¯ä¸€ç§é‡‡ç”¨å¤åˆ¶çš„æ–¹å¼å®ç°çš„åƒåœ¾å›æ”¶ç®—æ³•ï¼Œå®ƒå°†å †å†…å­˜ä¸€åˆ†ä¸ºäºŒï¼Œè¿™ä¸¤ä¸ªç©ºé—´ä¸­åªæœ‰ä¸€ä¸ªå¤„äºä½¿ç”¨ä¸­ï¼Œå¦ä¸€ä¸ªåˆ™å¤„äºé—²ç½®çŠ¶æ€ã€‚å¤„äºä½¿ç”¨çŠ¶æ€çš„ç©ºé—´ç§°ä¸º From ç©ºé—´ï¼Œå¤„äºé—²ç½®çš„ç©ºé—´ç§°ä¸º To ç©ºé—´ã€‚åˆ†é…å¯¹è±¡æ—¶ï¼Œå…ˆæ˜¯åœ¨ From ç©ºé—´ä¸­è¿›è¡Œåˆ†é…ï¼Œå½“å¼€å§‹åƒåœ¾å›æ”¶æ—¶ï¼Œä¼šæ£€æŸ¥ From ç©ºé—´ä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° To ç©ºé—´ä¸­ï¼Œè€Œéå­˜æ´»å¯¹è±¡å ç”¨çš„ç©ºé—´è¢«é‡Šæ”¾ã€‚å®Œæˆå¤åˆ¶åï¼ŒFrom ç©ºé—´å’Œ To ç©ºé—´çš„è§’è‰²äº’æ¢ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡å°†å­˜æ´»å¯¹è±¡åœ¨ä¸¤ä¸ªç©ºé—´ä¸­è¿›è¡Œå¤åˆ¶ã€‚</li><li>è€ç”Ÿä»£åˆ™ç”±ä¸»åƒåœ¾å›æ”¶å™¨è´Ÿè´£ã€‚å®ƒå®ç°çš„æ˜¯æ ‡è®°æ¸…æ‰«è¿‡ç¨‹ï¼Œä½†ç•¥æœ‰ä¸åŒä¹‹å¤„åœ¨äºå®ƒè¿˜ä¼šåœ¨æ¸…æ‰«å®Œæˆåå¯¹å†…å­˜ç¢ç‰‡è¿›è¡Œæ•´ç†ï¼Œè¿›è€Œæ˜¯ä¸€ç§æ ‡è®°æ•´ç†çš„å›æ”¶å™¨ã€‚</li></ol><h3 id="Java-çš„-GC"><a href="#Java-çš„-GC" class="headerlink" title="Java çš„ GC"></a>Java çš„ GC</h3><p>Java çš„ GC ç§°ä¹‹ä¸º G1ï¼Œå¹¶å°†æ•´ä¸ªå †åˆ†ä¸ºå¹´è½»ä»£ã€è€å¹´ä»£å’Œæ°¸ä¹…ä»£ã€‚åŒ…æ‹¬å››ç§ä¸åŒçš„æ”¶é›†æ“ä½œï¼Œä»ä¸Šå¾€ä¸‹çš„è¿™å‡ ä¸ªé˜¶æ®µä¼šé€‰æ‹©æ€§åœ°æ‰§è¡Œï¼Œè§¦å‘æ¡ä»¶æ˜¯ç”¨æˆ·çš„é…ç½®å’Œå®é™…ä»£ç è¡Œä¸ºçš„é¢„æµ‹ã€‚</p><ol><li>å¹´è½»ä»£æ”¶é›†å‘¨æœŸï¼šåªå¯¹å¹´è½»ä»£å¯¹è±¡è¿›è¡Œæ”¶é›†ä¸æ¸…ç†</li><li>è€å¹´ä»£æ”¶é›†å‘¨æœŸï¼šåªå¯¹è€å¹´ä»£å¯¹è±¡è¿›è¡Œæ”¶é›†ä¸æ¸…ç†</li><li>æ··åˆå¼æ”¶é›†å‘¨æœŸï¼šåŒæ—¶å¯¹å¹´è½»ä»£å’Œè€å¹´ä»£è¿›è¡Œæ”¶é›†ä¸æ¸…ç†</li><li>å®Œæ•´ GC å‘¨æœŸï¼šå®Œæ•´çš„å¯¹æ•´ä¸ªå †è¿›è¡Œæ”¶é›†ä¸æ¸…ç†</li></ol><p>åœ¨å›æ”¶è¿‡ç¨‹ä¸­ï¼ŒG1 ä¼šå¯¹åœé¡¿æ—¶é—´è¿›è¡Œé¢„æµ‹ï¼Œç«­å°½æ‰€èƒ½åœ°è°ƒæ•´ GC çš„ç­–ç•¥ä»è€Œè¾¾åˆ°ç”¨æˆ·ä»£ç é€šè¿‡ç³»ç»Ÿå‚æ•°ï¼ˆ<code>-XX:MaxGCPauseMillis</code>ï¼‰æ‰€é…ç½®çš„å¯¹åœé¡¿æ—¶é—´çš„è¦æ±‚ã€‚</p><p>è¿™å››ä¸ªå‘¨æœŸçš„æ‰§è¡Œæˆæœ¬é€æ¸ä¸Šå‡ï¼Œä¼˜åŒ–å¾—å½“çš„ç¨‹åºå¯ä»¥å®Œå…¨é¿å…å®Œæ•´ GC å‘¨æœŸã€‚</p><h3 id="æ€§èƒ½æ¯”è¾ƒ"><a href="#æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="æ€§èƒ½æ¯”è¾ƒ"></a>æ€§èƒ½æ¯”è¾ƒ</h3><p>åœ¨ Goã€Java å’Œ V8 JavaScript ä¹‹é—´æ¯”è¾ƒ GC çš„æ€§èƒ½æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸åˆ‡å®é™…çš„é—®é¢˜ã€‚å¦‚å‰é¢æ‰€è¯´ï¼Œåƒåœ¾å›æ”¶å™¨çš„è®¾è®¡æƒè¡¡äº†å¾ˆå¤šæ–¹é¢çš„å› ç´ ï¼ŒåŒæ—¶è¿˜å—è¯­è¨€è‡ªèº«è®¾è®¡çš„å½±å“ï¼Œå› ä¸ºè¯­è¨€çš„è®¾è®¡ä¹Ÿç›´æ¥å½±å“äº†ç¨‹åºå‘˜ç¼–å†™ä»£ç çš„å½¢å¼ï¼Œä¹Ÿå°±è‡ªç„¶å½±å“äº†äº§ç”Ÿåƒåœ¾çš„æ–¹å¼ã€‚</p><p>ä½†æ€»çš„æ¥è¯´ï¼Œä»–ä»¬ä¸‰è€…å¯¹åƒåœ¾å›æ”¶çš„å®ç°éƒ½éœ€è¦ STWï¼Œå¹¶å‡å·²è¾¾åˆ°äº†ç”¨æˆ·ä»£ç å‡ ä¹æ— æ³•æ„ŸçŸ¥åˆ°çš„çŠ¶æ€ï¼ˆæ® Go GC ä½œè€… Austin å®£ç§° <a href="https://groups.google.com/d/msg/golang-dev/Ab1sFeoZg_8/_DaL0E8fAwAJ" target="_blank" rel="noopener">STW å°äº 100 å¾®ç§’</a>ï¼‰ã€‚å½“ç„¶ï¼Œéšç€ STW çš„å‡å°‘ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šå¢åŠ  CPU çš„ä½¿ç”¨ç‡ï¼Œè¿™ä¹Ÿæ˜¯ç¨‹åºå‘˜åœ¨ç¼–å†™ä»£ç æ—¶éœ€è¦æ‰‹åŠ¨è¿›è¡Œä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œå³å……åˆ†è€ƒè™‘å†…å­˜åˆ†é…çš„å¿…è¦æ€§ï¼Œå‡å°‘è¿‡å¤šç”³è¯·å†…å­˜å¸¦ç»™åƒåœ¾å›æ”¶å™¨çš„å‹åŠ›ã€‚</p><h2 id="20-ç›®å‰-Go-è¯­è¨€çš„-GC-è¿˜å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ"><a href="#20-ç›®å‰-Go-è¯­è¨€çš„-GC-è¿˜å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ" class="headerlink" title="20. ç›®å‰ Go è¯­è¨€çš„ GC è¿˜å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ"></a>20. ç›®å‰ Go è¯­è¨€çš„ GC è¿˜å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿ</h2><p>å°½ç®¡ Go å›¢é˜Ÿå®£ç§° STW åœé¡¿æ—¶é—´å¾—ä»¥ä¼˜åŒ–åˆ° 100 å¾®ç§’çº§åˆ«ï¼Œä½†è¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å–èˆã€‚åŸæœ¬çš„ STW æŸç§æ„ä¹‰ä¸Šæ¥è¯´å…¶å®è½¬ç§»åˆ°äº†å¯èƒ½å¯¼è‡´ç”¨æˆ·ä»£ç åœé¡¿çš„å‡ ä¸ªä½ç½®ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºè¿è¡Œæ—¶è°ƒåº¦å™¨çš„å®ç°æ–¹å¼ï¼ŒåŒæ ·å¯¹ GC å­˜åœ¨ä¸€å®šç¨‹åº¦çš„å½±å“ã€‚</p><p>ç›®å‰ Go ä¸­çš„ GC ä»ç„¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><h3 id="1-Mark-Assist-åœé¡¿æ—¶é—´è¿‡é•¿"><a href="#1-Mark-Assist-åœé¡¿æ—¶é—´è¿‡é•¿" class="headerlink" title="1. Mark Assist åœé¡¿æ—¶é—´è¿‡é•¿"></a>1. Mark Assist åœé¡¿æ—¶é—´è¿‡é•¿</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"runtime"</span></span><br><span class="line"><span class="string">"runtime/trace"</span></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">windowSize = <span class="number">200000</span></span><br><span class="line">msgCount   = <span class="number">1000000</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">best    time.Duration = time.Second</span><br><span class="line">bestAt  time.Time</span><br><span class="line">worst   time.Duration</span><br><span class="line">worstAt time.Time</span><br><span class="line"></span><br><span class="line">start = time.Now()</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">f, _ := os.Create(<span class="string">"trace.out"</span>)</span><br><span class="line"><span class="keyword">defer</span> f.Close()</span><br><span class="line">trace.Start(f)</span><br><span class="line"><span class="keyword">defer</span> trace.Stop()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5</span>; i++ &#123;</span><br><span class="line">measure()</span><br><span class="line">worst = <span class="number">0</span></span><br><span class="line">best = time.Second</span><br><span class="line">runtime.GC()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">measure</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> c channel</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; msgCount; i++ &#123;</span><br><span class="line">c.sendMsg(i)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Printf(<span class="string">"Best send delay %v at %v, worst send delay: %v at %v. Wall clock: %v \n"</span>, best, bestAt.Sub(start), worst, worstAt.Sub(start), time.Since(start))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> channel [windowSize][]<span class="keyword">byte</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *channel)</span> <span class="title">sendMsg</span><span class="params">(id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">start := time.Now()</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¨¡æ‹Ÿå‘é€</span></span><br><span class="line">(*c)[id%windowSize] = newMsg(id)</span><br><span class="line"></span><br><span class="line">end := time.Now()</span><br><span class="line">elapsed := end.Sub(start)</span><br><span class="line"><span class="keyword">if</span> elapsed &gt; worst &#123;</span><br><span class="line">worst = elapsed</span><br><span class="line">worstAt = end</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> elapsed &lt; best &#123;</span><br><span class="line">best = elapsed</span><br><span class="line">bestAt = end</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">newMsg</span><span class="params">(n <span class="keyword">int</span>)</span> []<span class="title">byte</span></span> &#123;</span><br><span class="line">m := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">1024</span>)</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> m &#123;</span><br><span class="line">m[i] = <span class="keyword">byte</span>(n)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> m</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ­¤ç¨‹åºæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ go run main.go</span><br><span class="line"></span><br><span class="line">Best send delay 330ns at 773.037956ms, worst send delay: 7.127915ms at 579.835487ms. Wall clock: 831.066632ms </span><br><span class="line">Best send delay 331ns at 873.672966ms, worst send delay: 6.731947ms at 1.023969626s. Wall clock: 1.515295559s </span><br><span class="line">Best send delay 330ns at 1.812141567s, worst send delay: 5.34028ms at 2.193858359s. Wall clock: 2.199921749s </span><br><span class="line">Best send delay 338ns at 2.722161771s, worst send delay: 7.479482ms at 2.665355216s. Wall clock: 2.920174197s </span><br><span class="line">Best send delay 337ns at 3.173649445s, worst send delay: 6.989577ms at 3.361716121s. Wall clock: 3.615079348s</span><br></pre></td></tr></table></figure><p><img src="./assets/gc-mark-assist.png" alt=""></p><p>åœ¨è¿™ä¸ªç»“æœä¸­ï¼Œç¬¬ä¸€æ¬¡çš„æœ€åå»¶è¿Ÿæ—¶é—´é«˜è¾¾ 7.12 æ¯«ç§’ï¼Œå‘ç”Ÿåœ¨ç¨‹åºè¿è¡Œ 578 æ¯«ç§’å·¦å³ã€‚é€šè¿‡ <code>go tool trace</code> å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæ—¶é—´æ®µä¸­ï¼ŒMark Assist æ‰§è¡Œäº† 7112312nsï¼Œçº¦ä¸º 7.127915msï¼›å¯è§ï¼Œæ­¤æ—¶æœ€åæƒ…å†µä¸‹ï¼Œæ ‡è®°è¾…åŠ©æ‹–æ…¢äº†ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œæ˜¯é€ æˆ 7 æ¯«ç§’å»¶è¿Ÿçš„åŸå› ã€‚</p><!-- https://github.com/golang/go/issues/27732 --><!-- https://github.com/golang/go/issues/27410 --><h3 id="2-Sweep-åœé¡¿æ—¶é—´è¿‡é•¿"><a href="#2-Sweep-åœé¡¿æ—¶é—´è¿‡é•¿" class="headerlink" title="2. Sweep åœé¡¿æ—¶é—´è¿‡é•¿"></a>2. Sweep åœé¡¿æ—¶é—´è¿‡é•¿</h3><p>åŒæ ·è¿˜æ˜¯åˆšæ‰çš„ä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿ Mark Assist åå‘ç”Ÿçš„ Sweep é˜¶æ®µï¼Œç«Ÿç„¶å¯¹ç”¨æˆ·ä»£ç çš„å½±å“é•¿è¾¾çº¦ 30msï¼Œæ ¹æ®è°ƒç”¨æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ Sweep è¿‡ç¨‹å‘ç”Ÿåœ¨å†…å­˜åˆ†é…é˜¶æ®µï¼š</p><p><img src="./assets/gc-mark-sweep.png" alt=""></p><!-- https://github.com/golang/go/issues/18155 --><h3 id="3-ç”±äº-GC-ç®—æ³•çš„ä¸æ­£ç¡®æ€§å¯¼è‡´-GC-å‘¨æœŸè¢«è¿«é‡æ–°æ‰§è¡Œ"><a href="#3-ç”±äº-GC-ç®—æ³•çš„ä¸æ­£ç¡®æ€§å¯¼è‡´-GC-å‘¨æœŸè¢«è¿«é‡æ–°æ‰§è¡Œ" class="headerlink" title="3. ç”±äº GC ç®—æ³•çš„ä¸æ­£ç¡®æ€§å¯¼è‡´ GC å‘¨æœŸè¢«è¿«é‡æ–°æ‰§è¡Œ"></a>3. ç”±äº GC ç®—æ³•çš„ä¸æ­£ç¡®æ€§å¯¼è‡´ GC å‘¨æœŸè¢«è¿«é‡æ–°æ‰§è¡Œ</h3><p>æ­¤é—®é¢˜å¾ˆéš¾å¤ç°ï¼Œä½†æ˜¯ä¸€ä¸ªå·²çŸ¥çš„é—®é¢˜ï¼Œæ ¹æ® Go å›¢é˜Ÿçš„æè¿°ï¼Œ<a href="https://github.com/golang/go/issues/27993#issuecomment-441719687" target="_blank" rel="noopener">èƒ½å¤Ÿåœ¨ 1334 æ¬¡æ„å»ºä¸­å‘ç”Ÿä¸€æ¬¡</a>ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºå…¶è§¦å‘æ¦‚ç‡çº¦ä¸º 0.0007496251874ã€‚è™½ç„¶å‘ç”Ÿæ¦‚ç‡å¾ˆä½ï¼Œä½†ä¸€æ—¦å‘ç”Ÿï¼ŒGC éœ€è¦è¢«é‡æ–°æ‰§è¡Œï¼Œéå¸¸ä¸å¹¸ã€‚</p><!-- https://github.com/golang/go/issues/27993 --><h3 id="4-åˆ›å»ºå¤§é‡-Goroutine-åå¯¼è‡´-GC-æ¶ˆè€—æ›´å¤šçš„-CPU"><a href="#4-åˆ›å»ºå¤§é‡-Goroutine-åå¯¼è‡´-GC-æ¶ˆè€—æ›´å¤šçš„-CPU" class="headerlink" title="4. åˆ›å»ºå¤§é‡ Goroutine åå¯¼è‡´ GC æ¶ˆè€—æ›´å¤šçš„ CPU"></a>4. åˆ›å»ºå¤§é‡ Goroutine åå¯¼è‡´ GC æ¶ˆè€—æ›´å¤šçš„ CPU</h3><p>è¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡ä»¥ä¸‹ç¨‹åºè¿›è¡ŒéªŒè¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BenchmarkGCLargeGs</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line">wg := sync.WaitGroup&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> ng := <span class="number">100</span>; ng &lt;= <span class="number">1000000</span>; ng *= <span class="number">10</span> &#123;</span><br><span class="line">b.Run(fmt.Sprintf(<span class="string">"#g-%d"</span>, ng), <span class="function"><span class="keyword">func</span><span class="params">(b *testing.B)</span></span> &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºå¤§é‡ goroutineï¼Œç”±äºæ¯æ¬¡åˆ›å»ºçš„ goroutine ä¼šä¼‘çœ </span></span><br><span class="line"><span class="comment">// ä»è€Œè¿è¡Œæ—¶ä¸ä¼šå¤ç”¨æ­£åœ¨ä¼‘çœ çš„ goroutineï¼Œè¿›è€Œä¸æ–­åˆ›å»ºæ–°çš„ g</span></span><br><span class="line">wg.Add(ng)</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; ng; i++ &#123;</span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">time.Sleep(<span class="number">100</span> * time.Millisecond)</span><br><span class="line">wg.Done()</span><br><span class="line">&#125;()</span><br><span class="line">&#125;</span><br><span class="line">wg.Wait()</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç°è¿è¡Œä¸€æ¬¡ GC æ¥æä¾›ä¸€è‡´çš„å†…å­˜ç¯å¢ƒ</span></span><br><span class="line">runtime.GC()</span><br><span class="line"></span><br><span class="line"><span class="comment">// è®°å½•è¿è¡Œ b.N æ¬¡ GC éœ€è¦çš„æ—¶é—´</span></span><br><span class="line">b.ResetTimer()</span><br><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; b.N; i++ &#123;</span><br><span class="line">runtime.GC()</span><br><span class="line">&#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ç»“æœå¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤æ¥è·å¾—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go <span class="built_in">test</span> -bench=BenchmarkGCLargeGs -run=^$ -count=5 -v . | tee 4.txt</span></span><br><span class="line"><span class="meta">$</span><span class="bash"> benchstat 4.txt</span></span><br><span class="line">name                     time/op</span><br><span class="line">GCLargeGs/#g-100-12       192Âµs Â± 5%</span><br><span class="line">GCLargeGs/#g-1000-12      331Âµs Â± 1%</span><br><span class="line">GCLargeGs/#g-10000-12    1.22ms Â± 1%</span><br><span class="line">GCLargeGs/#g-100000-12   10.9ms Â± 3%</span><br><span class="line">GCLargeGs/#g-1000000-12  32.5ms Â± 4%</span><br></pre></td></tr></table></figure><p>è¿™ç§æƒ…å†µé€šå¸¸å‘ç”Ÿäºå³°å€¼æµé‡åï¼Œå¤§é‡ goroutine ç”±äºä»»åŠ¡ç­‰å¾…è¢«ä¼‘çœ ï¼Œä»è€Œè¿è¡Œæ—¶ä¸æ–­åˆ›å»ºæ–°çš„ goroutineï¼Œ<br>æ—§çš„ goroutine ç”±äºä¼‘çœ æœªè¢«é”€æ¯ä¸”å¾—ä¸åˆ°å¤ç”¨ï¼Œå¯¼è‡´ GC éœ€è¦æ‰«æçš„æ‰§è¡Œæ ˆè¶Šæ¥è¶Šå¤šï¼Œè¿›è€Œå®Œæˆ GC æ‰€éœ€çš„æ—¶é—´è¶Šæ¥è¶Šé•¿ã€‚<br>ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯ä½¿ç”¨ goroutine æ± æ¥é™åˆ¶åˆ›å»ºçš„ goroutine æ•°é‡ã€‚</p><!-- https://github.com/golang/go/issues/34457 --><h1 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h1><p>GC æ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿå·¥ç¨‹ï¼Œæœ¬æ–‡è®¨è®ºçš„äºŒåä¸ªé—®é¢˜å°½ç®¡å·²ç»å±•ç°äº†ä¸€ä¸ªç›¸å¯¹å…¨é¢çš„ Go GCã€‚ä½†å®ƒä»¬ä»ç„¶åªæ˜¯ GC è¿™ä¸€å®è§‚é—®é¢˜çš„ä¸€äº›è¾ƒä¸ºé‡è¦çš„éƒ¨åˆ†ï¼Œè¿˜æœ‰éå¸¸å¤šçš„ç»†ææœ«èŠ‚ã€ç ”ç©¶è¿›å±•æ— æ³•åœ¨æœ‰é™çš„ç¯‡å¹…å†…å®Œæ•´è®¨è®ºã€‚</p><p>ä» Go è¯ç”Ÿä¹‹åˆï¼ŒGo å›¢é˜Ÿå°±ä¸€ç›´åœ¨å¯¹ GC çš„è¡¨ç°è¿›è¡Œå®éªŒä¸ä¼˜åŒ–ï¼Œä½†ä»ç„¶æœ‰è¯¸å¤šæœªè§£å†³çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸å¦¨å¯¹ GC æœªæ¥çš„æ”¹è¿›æ‹­ç›®ä»¥å¾…ã€‚</p><h1 id="æ¨èé˜…è¯»"><a href="#æ¨èé˜…è¯»" class="headerlink" title="æ¨èé˜…è¯»"></a>æ¨èé˜…è¯»</h1><p>ã€Why golang garbage-collector not implement Generational and Compact gc?ã€‘<a href="https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ" target="_blank" rel="noopener">https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ</a></p><p>ã€å†™ä¸€ä¸ªå†…å­˜åˆ†é…å™¨ã€‘<a href="http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/#more-3590" target="_blank" rel="noopener">http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/#more-3590</a></p><p>ã€è§‚å¯Ÿ GCã€‘<a href="https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html" target="_blank" rel="noopener">https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html</a></p><p>ã€ç…é±¼ Go debugã€‘<a href="https://segmentfault.com/a/1190000020255157" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020255157</a></p><p>ã€ç…é±¼ go tool traceã€‘<a href="https://eddycjy.gitbook.io/golang/di-9-ke-gong-ju/go-tool-trace" target="_blank" rel="noopener">https://eddycjy.gitbook.io/golang/di-9-ke-gong-ju/go-tool-trace</a></p><p>ã€trace è®²è§£ã€‘<a href="https://www.itcodemonkey.com/article/5419.html" target="_blank" rel="noopener">https://www.itcodemonkey.com/article/5419.html</a></p><p>ã€An Introduction to go tool traceã€‘<a href="https://about.sourcegraph.com/go/an-introduction-to-go-tool-trace-rhys-hiltner" target="_blank" rel="noopener">https://about.sourcegraph.com/go/an-introduction-to-go-tool-trace-rhys-hiltner</a></p><p>ã€http pprof å®˜æ–¹æ–‡æ¡£ã€‘<a href="https://golang.org/pkg/net/http/pprof/" target="_blank" rel="noopener">https://golang.org/pkg/net/http/pprof/</a></p><p>ã€runtime pprof å®˜æ–¹æ–‡æ¡£ã€‘<a href="https://golang.org/pkg/runtime/pprof/" target="_blank" rel="noopener">https://golang.org/pkg/runtime/pprof/</a></p><p>ã€trace å®˜æ–¹æ–‡æ¡£ã€‘<a href="https://golang.org/pkg/runtime/trace/" target="_blank" rel="noopener">https://golang.org/pkg/runtime/trace/</a></p><h1 id="æ¨èé˜…è¯»-1"><a href="#æ¨èé˜…è¯»-1" class="headerlink" title="æ¨èé˜…è¯»"></a><strong>æ¨èé˜…è¯»</strong></h1><p>ã€Why golang garbage-collector not implement Generational and Compact gc?ã€‘<a href="https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ" target="_blank" rel="noopener">https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ</a></p><p>ã€å†™ä¸€ä¸ªå†…å­˜åˆ†é…å™¨ã€‘<a href="http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/#more-3590" target="_blank" rel="noopener">http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/#more-3590</a></p><p>ã€è§‚å¯Ÿ GCã€‘<a href="https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html" target="_blank" rel="noopener">https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html</a></p><p>ã€ç…é±¼ Go debugã€‘<a href="https://segmentfault.com/a/1190000020255157" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020255157</a></p><p>ã€ç…é±¼ go tool traceã€‘<a href="https://eddycjy.gitbook.io/golang/di-9-ke-gong-ju/go-tool-trace" target="_blank" rel="noopener">https://eddycjy.gitbook.io/golang/di-9-ke-gong-ju/go-tool-trace</a></p><p>ã€trace è®²è§£ã€‘<a href="https://www.itcodemonkey.com/article/5419.html" target="_blank" rel="noopener">https://www.itcodemonkey.com/article/5419.html</a></p><p>ã€An Introduction to go tool traceã€‘<a href="https://about.sourcegraph.com/go/an-introduction-to-go-tool-trace-rhys-hiltner" target="_blank" rel="noopener">https://about.sourcegraph.com/go/an-introduction-to-go-tool-trace-rhys-hiltner</a></p><p>ã€http pprof å®˜æ–¹æ–‡æ¡£ã€‘<a href="https://golang.org/pkg/net/http/pprof/" target="_blank" rel="noopener">https://golang.org/pkg/net/http/pprof/</a></p><p>ã€runtime pprof å®˜æ–¹æ–‡æ¡£ã€‘<a href="https://golang.org/pkg/runtime/pprof/" target="_blank" rel="noopener">https://golang.org/pkg/runtime/pprof/</a></p><p>ã€trace å®˜æ–¹æ–‡æ¡£ã€‘<a href="https://golang.org/pkg/runtime/trace/" target="_blank" rel="noopener">https://golang.org/pkg/runtime/trace/</a></p><hr>]]></content>
    
    <summary type="html">
    
      Go GC 20é—®
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>golangè‡ªåŠ¨ç”Ÿæˆå¯¹åº”MySQLæ•°æ®åº“è¡¨çš„structå®šä¹‰</title>
    <link href="https://cloudsjhan.github.io/2020/01/01/golang%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E5%AF%B9%E5%BA%94MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84struct%E5%AE%9A%E4%B9%89/"/>
    <id>https://cloudsjhan.github.io/2020/01/01/golangè‡ªåŠ¨ç”Ÿæˆå¯¹åº”MySQLæ•°æ®åº“è¡¨çš„structå®šä¹‰/</id>
    <published>2020-01-01T14:37:14.000Z</published>
    <updated>2020-01-01T15:16:15.693Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><p>åœ¨golangçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ormçš„æ—¶å€™ï¼Œå¸¸å¸¸éœ€è¦å°†æ•°æ®åº“è¡¨å¯¹åº”åˆ°golangçš„ä¸€ä¸ªstructï¼Œè¿™äº›structä¼šæºå¸¦ormå¯¹åº”çš„<code>tag</code>,å°±åƒä¸‹é¢çš„structå®šä¹‰ä¸€æ ·ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> InsInfo <span class="keyword">struct</span> &#123;</span><br><span class="line">Connections  <span class="keyword">string</span>    <span class="string">`gorm:"column:connections"`</span></span><br><span class="line">CPU          <span class="keyword">int</span>       <span class="string">`gorm:"column:cpu"`</span></span><br><span class="line">CreateTime   time.Time <span class="string">`gorm:"column:create_time"`</span></span><br><span class="line">Env          <span class="keyword">int</span>       <span class="string">`gorm:"column:env"`</span></span><br><span class="line">ID           <span class="keyword">int64</span>     <span class="string">`gorm:"column:id;primary_key"`</span></span><br><span class="line">IP           <span class="keyword">string</span>    <span class="string">`gorm:"column:ip"`</span></span><br><span class="line">Organization <span class="keyword">string</span>    <span class="string">`gorm:"column:organization"`</span></span><br><span class="line">Pass         <span class="keyword">string</span>    <span class="string">`gorm:"column:pass"`</span></span><br><span class="line">Port         <span class="keyword">string</span>    <span class="string">`gorm:"column:port"`</span></span><br><span class="line">RegionId     <span class="keyword">string</span>    <span class="string">`gorm:"column:regionid"`</span></span><br><span class="line">ServerIP     <span class="keyword">string</span>    <span class="string">`gorm:"column:server_ip"`</span></span><br><span class="line">Status       <span class="keyword">int</span>       <span class="string">`gorm:"column:status"`</span></span><br><span class="line">Type         <span class="keyword">string</span>    <span class="string">`gorm:"column:type"`</span></span><br><span class="line">UUID         <span class="keyword">string</span>    <span class="string">`gorm:"column:uuid"`</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯gormå¯¹åº”çš„æ•°æ®åº“è¡¨çš„structæ˜ å°„ï¼Œå³ä½¿æ•°æ®è¡¨çš„å­—æ®µä¸å¤šï¼Œå¦‚æœæ˜¯æ‰‹åŠ¨å†™èµ·æ¥ä¹Ÿæ˜¯ä¸€äº›é‡å¤æ€§çš„å·¥ä½œã€‚åƒMySQLè¿™ç§å…³ç³»å‹æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ormå»æ“ä½œæ•°æ®åº“ï¼Œäºæ˜¯å°±æƒ³ï¼Œmysqlçš„æ•°æ®è¡¨èƒ½ä¸èƒ½æ¥è‡ªåŠ¨ç”Ÿæˆgolang çš„structå®šä¹‰ã€‚æˆ‘ä»¬çŸ¥é“mysqlæœ‰ä¸ªè‡ªå¸¦çš„æ•°æ®åº“<code>information_schema</code>ï¼Œæœ‰ä¸€å¼ è¡¨<code>COLUMNS</code>ï¼Œå®ƒçš„å­—æ®µåŒ…å«æ•°æ®åº“åã€è¡¨åã€å­—æ®µåã€å­—æ®µç±»å‹ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¡¨çš„æ•°æ®ï¼ŒæŠŠå¯¹åº”çš„è¡¨çš„å­—æ®µä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œç„¶åå†æ ¹æ®golangçš„è¯­æ³•è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„structã€‚<br>    è°ƒç ”äº†ä¸€ä¸‹ç›®å‰æœ‰ä¸€äº›å‘½ä»¤è¡Œå·¥å…·åƒ db2structç­‰ï¼Œæ„Ÿè§‰ç”¨èµ·æ¥æ¯”è¾ƒç¹çï¼Œåœ¨æƒ³èƒ½ä¸èƒ½æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„ç¯å¢ƒï¼Œæä¾›webç•Œé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼Œå°±å¯ä»¥ä¸€é”®ç”Ÿæˆå¯¹åº”çš„ORMçš„structï¼Œäºæ˜¯å°±è¯ç”Ÿäº†è¿™ä¸ªé¡¹ç›®ï¼š<a href="https://github.com/hantmac/fuckdb" target="_blank" rel="noopener">https://github.com/hantmac/fuckdb</a></p><p>å¦‚æœä½ çš„æ•°æ®åº“åœ¨æœ¬åœ°ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œ <code>docker-compose up -d</code>ï¼Œè®¿é—®<code>localhost:8088</code>ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç•Œé¢ï¼š</p><p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1g9w1ru6tl4j31wb0u0aft.jpg" alt=""></p><p>å¦‚æœä½ çš„æ•°æ®åº“åœ¨å†…ç½‘æœåŠ¡å™¨ä¸Šï¼Œä½ éœ€è¦å…ˆä¿®æ”¹åç«¯æ¥å£çš„ip:port,ç„¶åé‡æ–°build Dockeré•œåƒï¼Œpushåˆ°è‡ªå·±çš„é•œåƒä»“åº“ï¼Œç„¶åä¿®æ”¹docker-compose.yamlï¼Œå†æ‰§è¡Œ<code>docker-compose up -d</code>ã€‚ä¿®æ”¹çš„ä½ç½®æ˜¯ï¼š<code>fuckdb/frontend/src/config/index.js</code>.</p><p><img src="https://tva1.sinaimg.cn/large/006tNbRwgy1gahgtkjlraj31000hkada.jpg" alt=""></p><p>åªéœ€è¦å¡«å…¥æ•°æ®åº“ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠä½ æƒ³å¾—åˆ°çš„golangä»£ç çš„<code>package name</code>ã€<code>struct name</code>,ç„¶åç‚¹å‡»ç”Ÿæˆï¼Œå°±å¯ä»¥å¾—åˆ°gormå¯¹åº”çš„ç»“æ„ä½“æ˜ å°„ï¼š</p><p><img src="https://tva1.sinaimg.cn/large/006tNbRwly1g9w531osobj31u90u0jzq.jpg" alt=""></p><p>ä½ åªéœ€è¦æ‹·è´ä½ çš„ä»£ç åˆ°é¡¹ç›®ä¸­å³å¯ã€‚æˆ‘ä»¬éƒ½çŸ¥é“golangçš„structçš„tagæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œè¿™é‡Œä¹Ÿæä¾›äº†å¾ˆå¤štagçš„å¯é€‰é¡¹ï¼Œæ¯”å¦‚<code>json</code>,<code>xml</code>ç­‰ï¼Œåé¢ä¼šæ›¾åŠ æ›´å¤šçš„tagå¯é€‰é¡¹æ”¯æŒã€‚</p><p><img src="http://static.vue2.net/db.gif" alt=""></p><p>ä¸Šé¢çš„GIFå±•ç¤ºäº†å¢åŠ äº†ç¼“å­˜åŠŸèƒ½çš„ç‰ˆæœ¬ï¼Œè®°å¿†ä½ ä¹‹å‰å¡«å†™è¿‡çš„æ•°æ®åº“ä¿¡æ¯ï¼Œçœå»äº†å¤§é‡é‡å¤çš„æ“ä½œï¼Œä½ ä¸ç”¨å†å¡«å†™ç¹ççš„æ•°æ®åº“åï¼Œè¡¨åï¼Œç­‰ç­‰ï¼Œåªéœ€ä¸€é”®ï¼Œå°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å•Šã€‚ps:ç›®å‰æ•°æ®åº“ä¿¡æ¯æ²¡æœ‰åšåŠ å¯†ï¼Œæ‰€ä»¥ä¸æ–¹ä¾¿æ”¾åˆ°å…¬ç½‘ä¸Šä½¿ç”¨ï¼Œä»…é™äºå†…ç½‘ï¼Œåé¢ä¼šè¿›è¡Œç›¸åº”çš„å¼€å‘æ”¯æŒã€‚ç›®å‰è¿™ä¸ªå·¥å…·åœ¨æˆ‘ä»¬ç»„å†…å·²ç»å¼€å§‹ä½¿ç”¨ï¼Œåé¦ˆæ¯”è¾ƒå¥½ï¼ŒèŠ‚çœäº†å¾ˆå¤šé‡å¤çš„å·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨å¼€å‘çš„æ—¶å€™ç”¨åˆ°åŒä¸€ä¸ªåº“çš„å¤šå¼ è¡¨ï¼Œå¾ˆå¿«å°±å¯ä»¥å®Œæˆæ•°æ®åº“è¡¨-&gt;strcutçš„æ˜ å°„ã€‚</p><p>æ¬¢è¿è¯•ç”¨&amp;åé¦ˆ&amp;Contributeã€‚ä»£ç åœ°å€ï¼š<a href="https://github.com/hantmac/fuckdb" target="_blank" rel="noopener">https://github.com/hantmac/fuckdb</a></p><hr>]]></content>
    
    <summary type="html">
    
      golangè‡ªåŠ¨ç”Ÿæˆå¯¹åº”MySQLæ•°æ®åº“è¡¨çš„structå®šä¹‰
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>viperé…ç½®è¯¦è§£</title>
    <link href="https://cloudsjhan.github.io/2019/12/23/viper%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"/>
    <id>https://cloudsjhan.github.io/2019/12/23/viperé…ç½®è¯¦è§£/</id>
    <published>2019-12-23T02:31:52.000Z</published>
    <updated>2019-12-23T02:33:51.501Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h1 id="viper-è¯»å–é…ç½®æ–‡ä»¶"><a href="#viper-è¯»å–é…ç½®æ–‡ä»¶" class="headerlink" title="viper è¯»å–é…ç½®æ–‡ä»¶"></a>viper è¯»å–é…ç½®æ–‡ä»¶</h1><blockquote><p>viper</p><p>é¡¹ç›®åœ°å€ ï¼šgithub.com/spf13/viper</p></blockquote><h2 id="viper-æ˜¯ä»€ä¹ˆ"><a href="#viper-æ˜¯ä»€ä¹ˆ" class="headerlink" title="viper æ˜¯ä»€ä¹ˆ"></a>viper æ˜¯ä»€ä¹ˆ</h2><ul><li>go å¼€å‘å·¥å…·ï¼Œä¸»è¦æ˜¯ç”¨äºå¤„ç†å„ç§æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç®€åŒ–ç¨‹åºé…ç½®çš„è¯»å–é—®é¢˜</li><li>viper æ”¯æŒï¼š<ul><li>è®¾ç½®é»˜è®¤é…ç½®</li><li>æ”¯æŒè¯»å– JSON TOML YAML HCL å’Œ Java å±æ€§é…ç½®æ–‡ä»¶</li><li>ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå®æ—¶è¯»å–è¯»å–é…ç½®æ–‡ä»¶å†…å®¹</li><li>è¯»å–ç¯å¢ƒå˜é‡å€¼</li><li>è¯»å–è¿œç¨‹é…ç½®ç³»ç»Ÿ (etcd Consul) å’Œç›‘æ§é…ç½®å˜åŒ–</li><li>è¯»å–å‘½ä»¤ Flag å€¼</li><li>è¯»å– buffer å€¼</li><li>è¯»å–ç¡®åˆ‡å€¼</li></ul></li></ul><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/fsnotify/fsnotify</span><br><span class="line">go get github.com/spf13/viper</span><br></pre></td></tr></table></figure><h2 id="viper-çš„åŸºæœ¬ç”¨æ³•"><a href="#viper-çš„åŸºæœ¬ç”¨æ³•" class="headerlink" title="viper çš„åŸºæœ¬ç”¨æ³•"></a>viper çš„åŸºæœ¬ç”¨æ³•</h2><h3 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h3><ul><li><p>json é…ç½®æ–‡ä»¶ (config.json)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="string">"port"</span>: 10666,</span><br><span class="line"><span class="string">"mysql"</span>: &#123;</span><br><span class="line">  <span class="string">"url"</span>: <span class="string">"(127.0.0.1:3306)/biezhi"</span>,</span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">  <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"redis"</span>: [<span class="string">"127.0.0.1:6377"</span>, <span class="string">"127.0.0.1:6378"</span>, <span class="string">"127.0.0.1:6379"</span>],</span><br><span class="line"><span class="string">"smtp"</span>: &#123;</span><br><span class="line">  <span class="string">"enable"</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="string">"addr"</span>: <span class="string">"mail_addr"</span>,</span><br><span class="line">  <span class="string">"username"</span>: <span class="string">"mail_user"</span>,</span><br><span class="line">  <span class="string">"password"</span>: <span class="string">"mail_password"</span>,</span><br><span class="line">  <span class="string">"to"</span>: [<span class="string">"xxx@gmail.com"</span>, <span class="string">"xxx@163.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>yaml é…ç½®æ–‡ä»¶ (config1.yaml)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">port: 10666</span><br><span class="line">mysql:</span><br><span class="line">url: <span class="string">"(127.0.0.1:3306)/biezhi"</span></span><br><span class="line">username: root</span><br><span class="line">password: 123456</span><br><span class="line">redis:</span><br><span class="line">- 127.0.0.1:6377</span><br><span class="line">- 127.0.0.1:6378</span><br><span class="line">- 127.0.0.1:6379</span><br><span class="line">smtp:</span><br><span class="line"><span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">addr: mail_addr</span><br><span class="line">username: mail_user</span><br><span class="line">password: mail_password</span><br><span class="line">to: </span><br><span class="line">- xxx@gmail.com</span><br><span class="line">- xxx@163.com</span><br></pre></td></tr></table></figure></li></ul><h3 id="æœ¬åœ°é…ç½®æ–‡ä»¶è¯»å–æ–¹å¼"><a href="#æœ¬åœ°é…ç½®æ–‡ä»¶è¯»å–æ–¹å¼" class="headerlink" title="æœ¬åœ°é…ç½®æ–‡ä»¶è¯»å–æ–¹å¼"></a>æœ¬åœ°é…ç½®æ–‡ä»¶è¯»å–æ–¹å¼</h3><ul><li>å°†ä¸Šè¿°ä¸¤ä¸ªé…ç½®æ–‡ä»¶å’Œä¸‹é¢çš„ main.go æ”¾åœ¨ç»Ÿä¸€ç›®å½•ä¹‹ä¸‹ï¼Œå³å¯å®ç°è¯»å–é…ç½®æ–‡ä»¶</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/spf13/viper"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">init</span></span>() &#123;</span><br><span class="line">    // viper.SetConfigName(<span class="string">"config1"</span>) // è¯»å–yamlé…ç½®æ–‡ä»¶</span><br><span class="line">    viper.SetConfigName(<span class="string">"config"</span>) // è¯»å–jsoné…ç½®æ–‡ä»¶</span><br><span class="line">    //viper.AddConfigPath(<span class="string">"/etc/appname/"</span>)   //è®¾ç½®é…ç½®æ–‡ä»¶çš„æœç´¢ç›®å½•</span><br><span class="line">    //viper.AddConfigPath(<span class="string">"<span class="variable">$HOME</span>/.appname"</span>)  // è®¾ç½®é…ç½®æ–‡ä»¶çš„æœç´¢ç›®å½•</span><br><span class="line">    viper.AddConfigPath(<span class="string">"."</span>)      // è®¾ç½®é…ç½®æ–‡ä»¶å’Œå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶åœ¨ç”¨ä¸€ä¸ªç›®å½•</span><br><span class="line">    <span class="keyword">if</span> err := viper.ReadInConfig(); err != nil &#123;</span><br><span class="line">        <span class="keyword">if</span> _, ok := err.(viper.ConfigFileNotFoundError); ok &#123;</span><br><span class="line">            // Config file not found; ignore error <span class="keyword">if</span> desired</span><br><span class="line">            log.Println(<span class="string">"no such config file"</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            // Config file was found but another error was produced</span><br><span class="line">            log.Println(<span class="string">"read config error"</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        log.Fatal(err) // è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥è‡´å‘½é”™è¯¯</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„port"</span>, viper.GetInt(<span class="string">"port"</span>))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.url"</span>, viper.GetString(`mysql.url`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.username"</span>, viper.GetString(`mysql.username`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.password"</span>, viper.GetString(`mysql.password`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„redis"</span>, viper.GetStringSlice(<span class="string">"redis"</span>))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„smtp"</span>, viper.GetStringMap(<span class="string">"smtp"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä»£ç è¯¦è§£<ul><li>viper.SetConfigName (â€œconfigâ€) è®¾ç½®é…ç½®æ–‡ä»¶åä¸º config, ä¸éœ€è¦é…ç½®æ–‡ä»¶æ‰©å±•åï¼Œé…ç½®æ–‡ä»¶çš„ç±»å‹ viper ä¼šè‡ªåŠ¨æ ¹æ®æ‰©å±•åè‡ªåŠ¨åŒ¹é….</li><li>viper.AddConfigPath (â€œ.â€) è®¾ç½®é…ç½®æ–‡ä»¶æœç´¢çš„ç›®å½•ï¼Œ. è¡¨ç¤ºå’Œå½“å‰ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨åŒä¸€ä¸ªç›®å½•ã€‚å¯ä»¥æ·»åŠ å¤šä¸ªé…ç½®æ–‡ä»¶ç›®å½•ï¼Œå¦‚åœ¨ç¬¬ä¸€ä¸ªç›®å½•ä¸­æ‰¾åˆ°å°±ä¸ä¸ç»§ç»­åˆ°å…¶ä»–ç›®å½•ä¸­æŸ¥æ‰¾.</li><li>viper.ReadInConfig () åŠ è½½é…ç½®æ–‡ä»¶å†…å®¹</li><li>viper.Get*** è·å–é…ç½®æ–‡ä»¶ä¸­é…ç½®é¡¹çš„ä¿¡æ¯</li></ul></li></ul><h3 id="viper-çš„ä¸€äº›é«˜çº§ç”¨æ³•"><a href="#viper-çš„ä¸€äº›é«˜çº§ç”¨æ³•" class="headerlink" title="viper çš„ä¸€äº›é«˜çº§ç”¨æ³•"></a>viper çš„ä¸€äº›é«˜çº§ç”¨æ³•</h3><ul><li>viper è®¾ç½®é…ç½®é¡¹çš„é»˜è®¤å€¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// <span class="built_in">set</span> default config</span><br><span class="line">viper.SetDefault(<span class="string">"ContentDir"</span>, <span class="string">"content"</span>)</span><br><span class="line">viper.SetDefault(<span class="string">"LayoutDir"</span>, <span class="string">"layouts"</span>)</span><br><span class="line">viper.SetDefault(<span class="string">"Taxonomies"</span>, map[string]string&#123;<span class="string">"tag"</span>: <span class="string">"tags"</span>, <span class="string">"category"</span>: <span class="string">"categories"</span>&#125;)</span><br><span class="line"></span><br><span class="line">fmt.Println(viper.GetBool(<span class="string">"ContentDir"</span>))</span><br><span class="line">fmt.Println(viper.GetString(<span class="string">"LayoutDir"</span>))</span><br><span class="line">fmt.Println(viper.GetStringMapString(<span class="string">"Taxonomies"</span>))</span><br></pre></td></tr></table></figure><ul><li>ç›‘å¬å’Œé‡æ–°è¯»å–é…ç½®æ–‡ä»¶<ul><li>import â€œgithub.com/fsnotify/fsnotifyâ€</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">viper.WatchConfig()</span><br><span class="line">viper.OnConfigChange(func(e fsnotify.Event) &#123;</span><br><span class="line">    //viperé…ç½®å‘ç”Ÿå˜åŒ–äº† æ‰§è¡Œå“åº”çš„æ“ä½œ</span><br><span class="line">    fmt.Println(<span class="string">"Config file changed:"</span>, e.Name)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="ä»ç¯å¢ƒå˜é‡å˜é‡ä¸­è¯»å–"><a href="#ä»ç¯å¢ƒå˜é‡å˜é‡ä¸­è¯»å–" class="headerlink" title="ä»ç¯å¢ƒå˜é‡å˜é‡ä¸­è¯»å–"></a>ä»ç¯å¢ƒå˜é‡å˜é‡ä¸­è¯»å–</h3><ul><li>ä¸»è¦ç”¨åˆ°çš„æ˜¯ä¸‹é¢ä¸‰ä¸ªä¸ªæ–¹æ³•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// AutomaticEnv has Viper check ENV variables <span class="keyword">for</span> all.</span><br><span class="line">// keys <span class="built_in">set</span> <span class="keyword">in</span> config, default &amp; flags</span><br><span class="line">AutomaticEnv()</span><br><span class="line"></span><br><span class="line">// BindEnv binds a Viper key to a ENV variable.</span><br><span class="line">// ENV variables are <span class="keyword">case</span> sensitive.</span><br><span class="line">// If only a key is provided, it will use the env key matching the key, uppercased.</span><br><span class="line">// EnvPrefix will be used when <span class="built_in">set</span> when env name is not provided.</span><br><span class="line">BindEnv(stringâ€¦) : error</span><br><span class="line"></span><br><span class="line">// SetEnvPrefix defines a prefix that ENVIRONMENT variables will use.</span><br><span class="line">// E.g. <span class="keyword">if</span> your prefix is <span class="string">"spf"</span>, the env registry will look <span class="keyword">for</span> env</span><br><span class="line">// variables that start with <span class="string">"SPF_"</span>.</span><br><span class="line">SetEnvPrefix(string)</span><br></pre></td></tr></table></figure><ul><li>ç®€å•çš„ä½¿ç”¨ demo å¦‚ä¸‹æ‰€ç¤º</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">package main </span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"os"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/spf13/viper"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    prefix := <span class="string">"PROJECTNAME"</span></span><br><span class="line">    envs := map[string]string&#123;</span><br><span class="line">        <span class="string">"LOG_LEVEL"</span>:      <span class="string">"INFO"</span>,</span><br><span class="line">        <span class="string">"MODE"</span>:           <span class="string">"DEV"</span>,</span><br><span class="line">        <span class="string">"MYSQL_USERNAME"</span>: <span class="string">"root"</span>,</span><br><span class="line">        <span class="string">"MYSQL_PASSWORD"</span>: <span class="string">"xxxx"</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> k, v := range envs &#123;</span><br><span class="line">        os.Setenv(fmt.Sprintf(<span class="string">"%s_%s"</span>, prefix, k), v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    v := viper.New()</span><br><span class="line">    v.SetEnvPrefix(prefix)</span><br><span class="line">    v.AutomaticEnv()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k, _ := range envs &#123;</span><br><span class="line">        fmt.Printf(<span class="string">"env `%s` = %s\n"</span>, k, v.GetString(k))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è·å–è¿œç¨‹é…ç½®"><a href="#è·å–è¿œç¨‹é…ç½®" class="headerlink" title="è·å–è¿œç¨‹é…ç½®"></a>è·å–è¿œç¨‹é…ç½®</h3><ul><li><p>ä½¿ç”¨ github.com/spf13/viper/remote åŒ… import _ â€œgithub.com/spf13/viper/remoteâ€</p></li><li><p>Viper å¯ä»¥ä»ä¾‹å¦‚ etcdã€Consul çš„è¿œç¨‹ Key/Value å­˜å‚¨ç³»ç»Ÿçš„ä¸€ä¸ªè·¯å¾„ä¸Šï¼Œè¯»å–ä¸€ä¸ªé…ç½®å­—ç¬¦ä¸²ï¼ˆJSON, TOML, YAML æˆ– HCL æ ¼å¼ï¼‰. è¿™äº›å€¼ä¼˜å…ˆäºé»˜è®¤å€¼ï¼Œä½†ä¼šè¢«ä»ç£ç›˜æ–‡ä»¶ã€å‘½ä»¤è¡Œ flagã€ç¯å¢ƒå˜é‡çš„é…ç½®æ‰€è¦†ç›–.</p></li><li><p>æœ¬äººå¯¹ consul æ¯”è¾ƒç†Ÿæ‚‰ï¼Œç”¨å®ƒæ¥åšä¾‹å­</p><ul><li><p>é¦–å…ˆåœ¨æœ¬åœ°å¯åŠ¨ consul</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consul agent -dev</span><br></pre></td></tr></table></figure></li><li><p>å¹¶åœ¨ consul ä¸Šè®¾ç½®åä¸º config çš„ json é…ç½®æ–‡ä»¶</p><p><a href="https://cdn.learnku.com/uploads/images/201909/12/48679/ILyDXtfCXG.png!large" target="_blank" rel="noopener"><img src="https://cdn.learnku.com/uploads/images/201909/12/48679/ILyDXtfCXG.png!large" alt="viper"></a></p></li></ul></li></ul><ul><li><p>ä»£ç å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"log"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/spf13/viper"</span></span><br><span class="line">    _ <span class="string">"github.com/spf13/viper/remote"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    v := viper.New()</span><br><span class="line">    v.AddRemoteProvider(<span class="string">"consul"</span>, <span class="string">"localhost:8500"</span>, <span class="string">"config"</span>)</span><br><span class="line">    v.SetConfigType(<span class="string">"json"</span>) // Need to explicitly <span class="built_in">set</span> this to json</span><br><span class="line">    <span class="keyword">if</span> err := v.ReadRemoteConfig(); err != nil &#123;</span><br><span class="line">          log.Println(err)</span><br><span class="line">          <span class="built_in">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„port"</span>, v.GetInt(<span class="string">"port"</span>))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.url"</span>, v.GetString(`mysql.url`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.username"</span>, v.GetString(`mysql.username`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.password"</span>, v.GetString(`mysql.password`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„redis"</span>, v.GetStringSlice(<span class="string">"redis"</span>))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„smtp"</span>, v.GetStringMap(<span class="string">"smtp"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="ä»-io-Reader-ä¸­è¯»å–é…ç½®ä¿¡æ¯"><a href="#ä»-io-Reader-ä¸­è¯»å–é…ç½®ä¿¡æ¯" class="headerlink" title="ä» io.Reader ä¸­è¯»å–é…ç½®ä¿¡æ¯"></a>ä» io.Reader ä¸­è¯»å–é…ç½®ä¿¡æ¯</h3><ul><li>é¦–å…ˆç»™å¤§å®¶æ¥æ®µä¾‹å­</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    <span class="string">"bytes"</span></span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line">    <span class="string">"github.com/spf13/viper"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">    v := viper.New()</span><br><span class="line">    v.SetConfigType(<span class="string">"json"</span>) // è®¾ç½®é…ç½®æ–‡ä»¶çš„ç±»å‹</span><br><span class="line"></span><br><span class="line">    // é…ç½®æ–‡ä»¶å†…å®¹</span><br><span class="line">    var jsonExample = []byte(`</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"port"</span>: 10666,</span><br><span class="line">  <span class="string">"mysql"</span>: &#123;</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"(127.0.0.1:3306)/biezhi"</span>,</span><br><span class="line">    <span class="string">"username"</span>: <span class="string">"root"</span>,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"redis"</span>: [<span class="string">"127.0.0.1:6377"</span>, <span class="string">"127.0.0.1:6378"</span>, <span class="string">"127.0.0.1:6379"</span>],</span><br><span class="line">  <span class="string">"smtp"</span>: &#123;</span><br><span class="line">    <span class="string">"enable"</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">"addr"</span>: <span class="string">"mail_addr"</span>,</span><br><span class="line">    <span class="string">"username"</span>: <span class="string">"mail_user"</span>,</span><br><span class="line">    <span class="string">"password"</span>: <span class="string">"mail_password"</span>,</span><br><span class="line">    <span class="string">"to"</span>: [<span class="string">"xxx@gmail.com"</span>, <span class="string">"xxx@163.com"</span>]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">`)</span><br><span class="line">    //åˆ›å»ºio.Reader</span><br><span class="line">    v.ReadConfig(bytes.NewBuffer(jsonExample))</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„port"</span>, v.GetInt(<span class="string">"port"</span>))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.url"</span>, v.GetString(`mysql.url`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.username"</span>, v.GetString(`mysql.username`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„mysql.password"</span>, v.GetString(`mysql.password`))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„redis"</span>, v.GetStringSlice(<span class="string">"redis"</span>))</span><br><span class="line">    fmt.Println(<span class="string">"è·å–é…ç½®æ–‡ä»¶çš„smtp"</span>, v.GetStringMap(<span class="string">"smtp"</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿™ä¸ªåŠŸèƒ½æ—¥å¸¸çš„ä½¿ç”¨æƒ…å†µè¾ƒå°‘ï¼Œä¾‹å¦‚è¿™æ ·çš„ä¸€ä¸ªæƒ…æ™¯ï¼š<ul><li>é…ç½®æ–‡ä»¶æ”¾åœ¨ oss ä¸Šæˆ–è€… github æŸä¸ªç§æœ‰ä»“åº“ä¸Šï¼Œviper å¹¶æ²¡æœ‰æä¾›ç›´æ¥çš„æ¥å£å»è·å–ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åŸºäºç¬¬ä¸‰æ–¹æ‰˜ç®¡å¹³å°çš„ sdk å†™ä¸€å¥—è·å–é…ç½®æ–‡ä»¶ bytes çš„å·¥å…·ï¼Œå°†ç»“æœæ”¾å…¥ io.Reader ä¸­ï¼Œå†è¿›è¡Œé…ç½®æ–‡ä»¶çš„è§£æã€‚</li></ul></li><li>ä¸Šè¿°æµç¨‹æ„Ÿè§‰å¥½åƒæ¯”è¾ƒé¸¡è‚‹ï¼Œå¤æ‚äº†æ•´ä¸ªæµç¨‹ï¼šæˆ‘æ—¢ç„¶å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹çš„ sdk ç›´æ¥æ‹¿åˆ° bytesï¼Œä¸ºä½•ä¸è‡ªå·±ç›´æ¥è¿›è¡Œè§£æå‘¢ï¼Ÿè€Œè¦å€ŸåŠ© viper æ¥è§£æã€‚å¯èƒ½æœ‰äººä¼šè¯´ï¼Œé…ç½®æ–‡ä»¶å¦‚æœæ ¼å¼ä¸åŒå‘¢ï¼Ÿç¡®å®ï¼Œviper çš„å‡ºç°å°±æ˜¯ä¸ºäº†é’ˆå¯¹å¤šç§æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯åœ¨æ­£å¼çš„é¡¹ç›®ä¸­ï¼Œé…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸€èˆ¬ä¸ä¼šå˜ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€å¥—è§£æçš„å·¥å…·ï¼Œä¹Ÿå°±æ²¡æœ‰ä½¿ç”¨ viper çš„éœ€æ±‚äº†ã€‚è€Œä¸”å¯¹äºæŸä¸€ç§ç‰¹å®šæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼ˆJSONï¼ŒYAMLâ€¦ï¼‰ï¼ŒGolang å·²ç»æœ‰è¶³å¤Ÿå¼ºå¤§çš„åŒ…æ¥è¿›è¡Œè§£æäº†ã€‚</li><li>ä½†æ˜¯ä¸å¾—ä¸æ‰¿è®¤ viper çš„å®ç°ç¡®å®æ˜¯å¾ˆæµå¼Šçš„ã€‚åœ¨ä¸€èˆ¬çš„å¿«é€Ÿå¼€å‘è¿‡ç¨‹ä¸­ï¼Œç›´æ¥ä½¿ç”¨ viper ç¡®å®å¯ä»¥å¸®åŠ©æˆ‘ä»¬çœå»å¾ˆå¤šçš„éº»çƒ¦ï¼Œè®©æˆ‘ä»¬é›†ä¸­ç²¾åŠ›é’ˆå¯¹äºä¸šåŠ¡é€»è¾‘çš„å®ç°ã€‚</li><li>ä¸ªäººè§‰å¾—å¯ä»¥æ ¹æ®å®é™…éœ€æ±‚åœ¨ viper å†è¿›è¡Œä¸€å±‚å°è£…ï¼Œæ¥å…¥ä¸€äº›å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹å¹³å°çš„ sdkï¼ˆgithubï¼Œaliyun ossâ€¦ï¼‰, è¿™æ ·å³å¯ä»¥è¯»å–æœ¬åœ°é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è¯»å–è¿œç«¯çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥å®ç° dev æ¨¡å¼å’Œ deploy æ¨¡å¼çš„åˆ‡æ¢ã€‚</li></ul><hr>]]></content>
    
    <summary type="html">
    
      golangé…ç½®æ–‡ä»¶viperè¯¦è§£
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨swaggoè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£</title>
    <link href="https://cloudsjhan.github.io/2019/12/10/%E4%BD%BF%E7%94%A8swaggo%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90API%E6%96%87%E6%A1%A3/"/>
    <id>https://cloudsjhan.github.io/2019/12/10/ä½¿ç”¨swaggoè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£/</id>
    <published>2019-12-10T07:16:23.000Z</published>
    <updated>2019-12-10T07:19:03.588Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><p>æœ¬æ–‡è½¬è½½è‡ªï¼š <a href="https://razeencheng.com/post/go-swagger.html" target="_blank" rel="noopener">https://razeencheng.com/post/go-swagger.html</a></p><p>ç›¸ä¿¡å¾ˆå¤šç¨‹åºçŒ¿å’Œæˆ‘ä¸€æ ·ä¸å–œæ¬¢å†™APIæ–‡æ¡£ã€‚å†™ä»£ç å¤šèˆ’æœï¼Œå†™æ–‡æ¡£ä¸ä»…è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´ï¼Œæœ‰æ—¶å€™è¿˜ä¸èƒ½åšåˆ°é¢é¢å…·å…¨ã€‚ä½†APIæ–‡æ¡£æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œç›¸ä¿¡å…¶é‡è¦æ€§å°±ä¸ç”¨æˆ‘è¯´äº†ï¼Œä¸€ä»½å«ç³Šçš„æ–‡æ¡£ç”šè‡³èƒ½è®©å‰åç«¯äººå‘˜æ‰“èµ·æ¥ã€‚ è€Œä»Šå¤©è¿™ç¯‡åšå®¢ä»‹ç»çš„swaggoå°±æ˜¯è®©ä½ åªéœ€è¦ä¸“æ³¨äºä»£ç å°±å¯ä»¥ç”Ÿæˆå®Œç¾APIæ–‡æ¡£çš„å·¥å…·ã€‚åºŸè¯è¯´çš„æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬ç›´æ¥çœ‹æ–‡ç« ã€‚</p><p>å¤§æ¦‚æœ€åæ–‡æ¡£æ•ˆæœæ˜¯è¿™æ ·çš„ï¼š</p><h3 id="å…³äºSwaggo"><a href="#å…³äºSwaggo" class="headerlink" title="å…³äºSwaggo"></a>å…³äºSwaggo</h3><p>æˆ–è®¸ä½ ä½¿ç”¨è¿‡<a href="https://swagger.io/" target="_blank" rel="noopener">Swagger</a>, è€Œ swaggoå°±æ˜¯ä»£æ›¿äº†ä½ æ‰‹åŠ¨ç¼–å†™yamlçš„éƒ¨åˆ†ã€‚åªè¦é€šè¿‡ä¸€ä¸ªå‘½ä»¤å°±å¯ä»¥å°†æ³¨é‡Šè½¬æ¢æˆæ–‡æ¡£ï¼Œè¿™è®©æˆ‘ä»¬å¯ä»¥æ›´åŠ ä¸“æ³¨äºä»£ç ã€‚</p><p>ç›®å‰swaggoä¸»è¦å®ç°äº†swagger 2.0 çš„ä»¥ä¸‹éƒ¨åˆ†åŠŸèƒ½ï¼š</p><ul><li><p>åŸºæœ¬ç»“æ„ï¼ˆBasic Structureï¼‰</p></li><li><p>API åœ°å€ä¸åŸºæœ¬è·¯å¾„ï¼ˆAPI Host and Base Pathï¼‰</p></li><li><p>è·¯å¾„ä¸æ“ä½œ ï¼ˆPaths and Operationsï¼‰</p></li><li><p>å‚æ•°æè¿°ï¼ˆDescribing Parametersï¼‰</p></li><li><p>è¯·æ±‚å‚æ•°æè¿°ï¼ˆDescribing Request Bodyï¼‰</p></li><li><p>è¿”å›æè¿°ï¼ˆDescribing Responsesï¼‰</p></li><li><p>MIME ç±»å‹ï¼ˆMIME Typesï¼‰</p></li><li><p>è®¤è¯ï¼ˆAuthenticationï¼‰</p><ul><li>Basic Authentication</li><li>API Keys</li></ul></li><li><p>æ·»åŠ å®ä¾‹ï¼ˆAdding Examplesï¼‰</p></li><li><p>æ–‡ä»¶ä¸Šä¼ ï¼ˆFile Uploadï¼‰</p></li><li><p>æšä¸¾ï¼ˆEnumsï¼‰</p></li><li><p>æŒ‰æ ‡ç­¾åˆ†ç»„ï¼ˆGrouping Operations With Tagsï¼‰</p></li><li><p>æ‰©å±•ï¼ˆSwagger Extensionsï¼‰</p></li></ul><p><em>ä¸‹æ–‡å†…å®¹å‡ä»¥gin-swaggoä¸ºä¾‹</em></p><p><em><a href="https://github.com/razeencheng/demo-go/tree/master/swaggo-gin" target="_blank" rel="noopener">è¿™é‡Œæ˜¯demoåœ°å€</a></em></p><h3 id="ä½¿ç”¨"><a href="#ä½¿ç”¨" class="headerlink" title="ä½¿ç”¨"></a>ä½¿ç”¨</h3><h4 id="å®‰è£…swag-cli-åŠä¸‹è½½ç›¸å…³åŒ…"><a href="#å®‰è£…swag-cli-åŠä¸‹è½½ç›¸å…³åŒ…" class="headerlink" title="å®‰è£…swag cli åŠä¸‹è½½ç›¸å…³åŒ…"></a>å®‰è£…<code>swag cli</code> åŠä¸‹è½½ç›¸å…³åŒ…</h4><p>è¦ä½¿ç”¨swaggo,é¦–å…ˆéœ€è¦å®‰è£…<code>swag cli</code>ã€‚</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u github.com/swaggo/swag/cmd/swag</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬è¿˜éœ€è¦ä¸¤ä¸ªåŒ…ã€‚</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># gin-swagger ä¸­é—´ä»¶</span><br><span class="line">go get github.com/swaggo/gin-swagger</span><br><span class="line"># swagger å†…ç½®æ–‡ä»¶</span><br><span class="line">go get github.com/swaggo/gin-swagger/swaggerFiles</span><br></pre></td></tr></table></figure><h4 id="åœ¨main-goå†…æ·»åŠ æ³¨é‡Š"><a href="#åœ¨main-goå†…æ·»åŠ æ³¨é‡Š" class="headerlink" title="åœ¨main.goå†…æ·»åŠ æ³¨é‡Š"></a>åœ¨<code>main.go</code>å†…æ·»åŠ æ³¨é‡Š</h4><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;github.com/gin-gonic/gin&quot;</span><br><span class="line">ginSwagger &quot;github.com/swaggo/gin-swagger&quot;</span><br><span class="line">&quot;github.com/swaggo/gin-swagger/swaggerFiles&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// @title Swagger Example API</span><br><span class="line">// @version 1.0</span><br><span class="line">// @description This is a sample server celler server.</span><br><span class="line">// @termsOfService https://razeen.me</span><br><span class="line"></span><br><span class="line">// @contact.name Razeen</span><br><span class="line">// @contact.url https://razeen.me</span><br><span class="line">// @contact.email me@razeen.me</span><br><span class="line"></span><br><span class="line">// @license.name Apache 2.0</span><br><span class="line">// @license.url http://www.apache.org/licenses/LICENSE-2.0.html</span><br><span class="line"></span><br><span class="line">// @host 127.0.0.1:8080</span><br><span class="line">// @BasePath /api/v1</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">r := gin.Default()</span><br><span class="line">    store := sessions.NewCookieStore([]byte(&quot;secret&quot;))</span><br><span class="line">r.Use(sessions.Sessions(&quot;mysession&quot;, store))</span><br><span class="line"></span><br><span class="line">r.GET(&quot;/swagger/*any&quot;, ginSwagger.WrapHandler(swaggerFiles.Handler))</span><br><span class="line"></span><br><span class="line">v1 := r.Group(&quot;/api/v1&quot;)</span><br><span class="line">&#123;</span><br><span class="line">v1.GET(&quot;/hello&quot;, HandleHello)</span><br><span class="line">v1.POST(&quot;/login&quot;, HandleLogin)</span><br><span class="line">v1Auth := r.Use(HandleAuth)</span><br><span class="line">&#123;</span><br><span class="line">v1Auth.POST(&quot;/upload&quot;, HandleUpload)</span><br><span class="line">v1Auth.GET(&quot;/list&quot;, HandleList)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.Run(&quot;:8080&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ginSwagger &quot;github.com/swaggo/gin-swagger&quot;</span><br><span class="line">&quot;github.com/swaggo/gin-swagger/swaggerFiles&quot;</span><br></pre></td></tr></table></figure><p>åŒæ—¶ï¼Œæ·»åŠ æ³¨é‡Šã€‚å…¶ä¸­ï¼š</p><ul><li><code>titile</code>: æ–‡æ¡£æ ‡é¢˜</li><li><code>version</code>: ç‰ˆæœ¬</li><li><code>description,termsOfService,contact ...</code> è¿™äº›éƒ½æ˜¯ä¸€äº›å£°æ˜ï¼Œå¯ä¸å†™ã€‚</li><li><code>license.name</code> é¢ï¼Œè¿™ä¸ªæ˜¯å¿…é¡»çš„ã€‚</li><li><code>host</code>,<code>BasePath</code>: å¦‚æœä½ æƒ³ç›´æ¥swaggerè°ƒè¯•APIï¼Œè¿™ä¸¤é¡¹éœ€è¦å¡«å†™æ­£ç¡®ã€‚å‰è€…ä¸ºæœåŠ¡æ–‡æ¡£çš„ç«¯å£ï¼Œipã€‚åè€…ä¸ºåŸºç¡€è·¯å¾„ï¼Œåƒæˆ‘è¿™é‡Œå°±æ˜¯â€œ/api/v1â€ã€‚</li><li>åœ¨åŸæ–‡æ¡£ä¸­è¿˜æœ‰<code>securityDefinitions.basic</code>,<code>securityDefinitions.apikey</code>ç­‰ï¼Œè¿™äº›éƒ½æ˜¯ç”¨æ¥åšè®¤è¯çš„ï¼Œæˆ‘è¿™é‡Œæš‚ä¸å±•å¼€ã€‚</li></ul><p>åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨<code>mian.go</code>åŒç›®å½•ä¸‹æ‰§è¡Œ<code>swag init</code>å°±å¯ä»¥è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ï¼Œå¦‚ä¸‹ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ  swaggo-gin git:(master) âœ— swag init</span><br><span class="line">2019/01/12 21:29:14 Generate swagger docs....</span><br><span class="line">2019/01/12 21:29:14 Generate general API Info</span><br><span class="line">2019/01/12 21:29:14 create docs.go at  docs/docs.go</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å¯¼å…¥è¿™ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„<code>docs</code>åŒ…ï¼Œè¿è¡Œï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;github.com/gin-gonic/gin&quot;</span><br><span class="line">ginSwagger &quot;github.com/swaggo/gin-swagger&quot;</span><br><span class="line">&quot;github.com/swaggo/gin-swagger/swaggerFiles&quot;</span><br><span class="line"></span><br><span class="line">_ &quot;github.com/razeencheng/demo-go/swaggo-gin/docs&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// @title Swagger Example API</span><br><span class="line">// @version 1.0</span><br><span class="line">// ...</span><br></pre></td></tr></table></figure><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">âœ  swaggo-gin git:(master) âœ— go build</span><br><span class="line">âœ  swaggo-gin git:(master) âœ— ./swaggo-gin</span><br><span class="line">[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.</span><br><span class="line"></span><br><span class="line">[GIN-debug] [WARNING] Running in &quot;debug&quot; mode. Switch to &quot;release&quot; mode in production.</span><br><span class="line"> - using env:   export GIN_MODE=release</span><br><span class="line"> - using code:  gin.SetMode(gin.ReleaseMode)</span><br><span class="line"></span><br><span class="line">[GIN-debug] GET    /api/v1/hello             --&gt; main.HandleHello (3 handlers)</span><br><span class="line">[GIN-debug] POST   /api/v1/login             --&gt; main.HandleLogin (3 handlers)</span><br><span class="line">[GIN-debug] POST   /upload                   --&gt; main.HandleUpload (4 handlers)</span><br><span class="line">[GIN-debug] GET    /list                     --&gt; main.HandleList (4 handlers)</span><br><span class="line">[GIN-debug] GET    /swagger/*any             --&gt; github.com/swaggo/gin-swagger.WrapHandler.func1 (4 handlers)</span><br><span class="line">[GIN-debug] Listening and serving HTTP on :8080</span><br></pre></td></tr></table></figure><p>æµè§ˆå™¨æ‰“å¼€<a href="http://127.0.0.1:8080/swagger/index.html" target="_blank" rel="noopener">http://127.0.0.1:8080/swagger/index.html</a>, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ–‡æ¡£æ ‡é¢˜å·²ç»ç”Ÿæˆã€‚</p><p><img src="https://st.razeen.cn/bcj/201901/jietu20190112-213823.png" alt="img"></p><h4 id="åœ¨Handleå‡½æ•°ä¸Šæ·»åŠ æ³¨é‡Š"><a href="#åœ¨Handleå‡½æ•°ä¸Šæ·»åŠ æ³¨é‡Š" class="headerlink" title="åœ¨Handleå‡½æ•°ä¸Šæ·»åŠ æ³¨é‡Š"></a>åœ¨Handleå‡½æ•°ä¸Šæ·»åŠ æ³¨é‡Š</h4><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªè·¯ç”±å¤„ç†å‡½æ•°ä¸ŠåŠ ä¸Šæ³¨é‡Šï¼Œå¦‚ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// @Summary æµ‹è¯•SayHello</span><br><span class="line">// @Description å‘ä½ è¯´Hello</span><br><span class="line">// @Tags æµ‹è¯•</span><br><span class="line">// @Accept mpfd</span><br><span class="line">// @Produce json</span><br><span class="line">// @Param who query string true &quot;äººå&quot;</span><br><span class="line">// @Success 200 &#123;string&#125; json &quot;&#123;&quot;msg&quot;: &quot;hello Razeen&quot;&#125;&quot;</span><br><span class="line">// @Failure 400 &#123;string&#125; json &quot;&#123;&quot;msg&quot;: &quot;who are you&quot;&#125;&quot;</span><br><span class="line">// @Router /hello [get]</span><br><span class="line">func HandleHello(c *gin.Context) &#123;</span><br><span class="line">who := c.Query(&quot;who&quot;)</span><br><span class="line"></span><br><span class="line">if who == &quot;&quot; &#123;</span><br><span class="line">c.JSON(http.StatusBadRequest, gin.H&#123;&quot;msg&quot;: &quot;who are u?&quot;&#125;)</span><br><span class="line">return</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c.JSON(http.StatusOK, gin.H&#123;&quot;msg&quot;: &quot;hello &quot; + who&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å†æ¬¡<code>swag init</code>, è¿è¡Œä¸€ä¸‹ã€‚</p><p><img src="https://st.razeen.cn/bcj/201901/jietu20190112-220025.png" alt="img"></p><p>æ­¤æ—¶ï¼Œè¯¥APIçš„ç›¸å…³æè¿°å·²ç»ç”Ÿæˆäº†ï¼Œæˆ‘ä»¬ç‚¹å‡»<code>Try it out</code>è¿˜å¯ä»¥ç›´æ¥æµ‹è¯•è¯¥APIã€‚</p><p><img src="https://st.razeen.cn/bcj/201901/jietu20190112-220515.png" alt="img"></p><p>æ˜¯ä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œå½“ç„¶è¿™å¹¶æ²¡æœ‰ç»“æŸï¼Œè¿™äº›æ³¨é‡Šå­—æ®µï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªè§£é‡Šã€‚</p><p><img src="https://st.razeen.cn/bcj/201901/jietu20190112-223012.png" alt="img"></p><p>è¿™äº›æ³¨é‡Šå¯¹åº”å‡ºç°åœ¨APIæ–‡æ¡£çš„ä½ç½®ï¼Œæˆ‘åœ¨ä¸Šå›¾ä¸­å·²ç»æ ‡å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è¯¦ç»†è¯´è¯´ä¸‹é¢å‚æ•°ï¼š</p><h5 id="Tags"><a href="#Tags" class="headerlink" title="Tags"></a>Tags</h5><p>Tags æ˜¯ç”¨æ¥ç»™APIåˆ†ç»„çš„ã€‚</p><h5 id="Accept"><a href="#Accept" class="headerlink" title="Accept"></a>Accept</h5><p>æ¥æ”¶çš„å‚æ•°ç±»å‹ï¼Œæ”¯æŒè¡¨å•(<code>mpfd</code>) å’Œ JSON(<code>json</code>)</p><h5 id="Produce"><a href="#Produce" class="headerlink" title="Produce"></a>Produce</h5><p>è¿”å›çš„æ•°æ®ç»“æ„ï¼Œä¸€èˆ¬éƒ½æ˜¯<code>json</code>, å…¶ä»–æ”¯æŒå¦‚ä¸‹è¡¨ï¼š</p><table><thead><tr><th style="text-align:left">Mime Type</th><th style="text-align:left">å£°æ˜</th></tr></thead><tbody><tr><td style="text-align:left">application/json</td><td style="text-align:left">json</td></tr><tr><td style="text-align:left">text/xml</td><td style="text-align:left">xml</td></tr><tr><td style="text-align:left">text/plain</td><td style="text-align:left">plain</td></tr><tr><td style="text-align:left">html</td><td style="text-align:left">html</td></tr><tr><td style="text-align:left">multipart/form-data</td><td style="text-align:left">mpfd</td></tr><tr><td style="text-align:left">application/x-www-form-urlencoded</td><td style="text-align:left">x-www-form-urlencoded</td></tr><tr><td style="text-align:left">application/vnd.api+json</td><td style="text-align:left">json-api</td></tr><tr><td style="text-align:left">application/x-json-stream</td><td style="text-align:left">json-stream</td></tr><tr><td style="text-align:left">application/octet-stream</td><td style="text-align:left">octet-stream</td></tr><tr><td style="text-align:left">image/png</td><td style="text-align:left">png</td></tr><tr><td style="text-align:left">image/jpeg</td><td style="text-align:left">jpeg</td></tr><tr><td style="text-align:left">image/gif</td><td style="text-align:left">gif</td></tr></tbody></table><h5 id="Param"><a href="#Param" class="headerlink" title="Param"></a>Param</h5><p>å‚æ•°ï¼Œä»å‰å¾€ååˆ†åˆ«æ˜¯ï¼š</p><blockquote><p>@Param <code>1.å‚æ•°å</code> <code>2.å‚æ•°ç±»å‹</code> <code>3.å‚æ•°æ•°æ®ç±»å‹</code> <code>4.æ˜¯å¦å¿…é¡»</code> <code>5.å‚æ•°æè¿°</code> <code>6.å…¶ä»–å±æ€§</code></p></blockquote><ul><li><p>1.å‚æ•°å</p><p>å‚æ•°åå°±æ˜¯æˆ‘ä»¬è§£é‡Šå‚æ•°çš„åå­—ã€‚</p></li><li><p>2.å‚æ•°ç±»å‹</p><p>å‚æ•°ç±»å‹ä¸»è¦æœ‰å››ç§ï¼š</p><ul><li><p><code>path</code> è¯¥ç±»å‹å‚æ•°ç›´æ¥æ‹¼æ¥åœ¨URLä¸­ï¼Œå¦‚<a href="https://github.com/razeencheng/demo-go/blob/master/swaggo-gin/handle.go" target="_blank" rel="noopener">Demo</a>ä¸­<code>HandleGetFile</code>ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Param id path integer true &quot;æ–‡ä»¶ID&quot;</span><br></pre></td></tr></table></figure></li><li><p><code>query</code> è¯¥ç±»å‹å‚æ•°ä¸€èˆ¬æ˜¯ç»„åˆåœ¨URLä¸­çš„ï¼Œå¦‚<a href="https://github.com/razeencheng/demo-go/blob/master/swaggo-gin/handle.go" target="_blank" rel="noopener">Demo</a>ä¸­<code>HandleHello</code></p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Param who query string true &quot;äººå&quot;</span><br></pre></td></tr></table></figure></li><li><p><code>formData</code> è¯¥ç±»å‹å‚æ•°ä¸€èˆ¬æ˜¯<code>POST,PUT</code>æ–¹æ³•æ‰€ç”¨ï¼Œå¦‚<a href="https://github.com/razeencheng/demo-go/blob/master/swaggo-gin/handle.go" target="_blank" rel="noopener">Demo</a>ä¸­<code>HandleLogin</code></p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Param user formData string true &quot;ç”¨æˆ·å&quot; default(admin)</span><br></pre></td></tr></table></figure></li></ul></li><li><p><code>body</code> å½“<code>Accept</code>æ˜¯<code>JSON</code>æ ¼å¼æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨è¯¥å­—æ®µæŒ‡å®šæ¥æ”¶çš„JSONç±»å‹</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Param param body main.JSONParams true &quot;éœ€è¦ä¸Šä¼ çš„JSON&quot;</span><br></pre></td></tr></table></figure></li><li><p>3.å‚æ•°æ•°æ®ç±»å‹</p><p>æ•°æ®ç±»å‹ä¸»è¦æ”¯æŒä¸€ä¸‹å‡ ç§ï¼š</p><ul><li>string (string)</li><li>integer (int, uint, uint32, uint64)</li><li>number (float32)</li><li>boolean (bool)</li></ul><p>æ³¨æ„ï¼Œå¦‚æœä½ æ˜¯ä¸Šä¼ æ–‡ä»¶å¯ä»¥ä½¿ç”¨<code>file</code>, ä½†å‚æ•°ç±»å‹ä¸€å®šæ˜¯<code>formData</code>, å¦‚ä¸‹ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Param file formData file true &quot;æ–‡ä»¶&quot;</span><br></pre></td></tr></table></figure></li><li><p>4.æ˜¯å¦æ˜¯å¿…é¡»</p><p>è¡¨æ˜è¯¥å‚æ•°æ˜¯å¦æ˜¯å¿…é¡»éœ€è¦çš„ï¼Œå¿…é¡»çš„åœ¨æ–‡æ¡£ä¸­ä¼šé»‘ä½“æ ‡å‡ºï¼Œæµ‹è¯•æ—¶å¿…é¡»å¡«å†™ã€‚</p></li><li><p>5.å‚æ•°æè¿°</p><p>å°±æ˜¯å‚æ•°çš„ä¸€äº›è¯´æ˜</p></li><li><p>6.å…¶ä»–å±æ€§</p><p>é™¤äº†ä¸Šé¢è¿™äº›å±æ€§å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸ºè¯¥å‚æ•°å¡«å†™ä¸€äº›é¢å¤–çš„å±æ€§ï¼Œå¦‚æšä¸¾ï¼Œé»˜è®¤å€¼ï¼Œå€¼èŒƒå›´ç­‰ã€‚å¦‚ä¸‹ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">æšä¸¾</span><br><span class="line">// @Param enumstring query string false &quot;string enums&quot; Enums(A, B, C)</span><br><span class="line">// @Param enumint query int false &quot;int enums&quot; Enums(1, 2, 3)</span><br><span class="line">// @Param enumnumber query number false &quot;int enums&quot; Enums(1.1, 1.2, 1.3)</span><br><span class="line"></span><br><span class="line">å€¼æ·»åŠ èŒƒå›´</span><br><span class="line">// @Param string query string false &quot;string valid&quot; minlength(5) maxlength(10)</span><br><span class="line">// @Param int query int false &quot;int valid&quot; mininum(1) maxinum(10)</span><br><span class="line"></span><br><span class="line">è®¾ç½®é»˜è®¤å€¼</span><br><span class="line">// @Param default query string false &quot;string default&quot; default(A)</span><br></pre></td></tr></table></figure><p>è€Œä¸”è¿™äº›å‚æ•°æ˜¯å¯ä»¥ç»„åˆä½¿ç”¨çš„ï¼Œå¦‚ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Param enumstring query string false &quot;string enums&quot; Enums(A, B, C) default(A)</span><br></pre></td></tr></table></figure></li></ul><h5 id="Success"><a href="#Success" class="headerlink" title="Success"></a>Success</h5><p>æŒ‡å®šæˆåŠŸå“åº”çš„æ•°æ®ã€‚æ ¼å¼ä¸ºï¼š</p><blockquote><p>// @Success <code>1.HTTPå“åº”ç </code> <code>{2.å“åº”å‚æ•°ç±»å‹}</code> <code>3.å“åº”æ•°æ®ç±»å‹</code> <code>4.å…¶ä»–æè¿°</code></p></blockquote><ul><li><p>1.HTTPå“åº”ç </p><p>ä¹Ÿå°±æ˜¯200ï¼Œ400ï¼Œ500é‚£äº›ã€‚</p></li><li><p>2.å“åº”å‚æ•°ç±»å‹ / 3.å“åº”æ•°æ®ç±»å‹</p><p>è¿”å›çš„æ•°æ®ç±»å‹ï¼Œå¯ä»¥æ˜¯è‡ªå®šä¹‰ç±»å‹ï¼Œå¯ä»¥æ˜¯jsonã€‚</p><ul><li>è‡ªå®šä¹‰ç±»å‹</li></ul><p>åœ¨å¹³å¸¸çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘éƒ½ä¼šè¿”å›ä¸€äº›æŒ‡å®šçš„æ¨¡å‹åºåˆ—åŒ–JSONçš„æ•°æ®ï¼Œè¿™æ—¶ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Success 200 &#123;object&#125; main.File</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œæ¨¡å‹ç›´æ¥ç”¨<code>åŒ…å.æ¨¡å‹</code>å³å¯ã€‚ä½ ä¼šè¯´ï¼Œå‡å¦‚æˆ‘è¿”å›æ¨¡å‹æ•°ç»„æ€ä¹ˆåŠï¼Ÿè¿™æ—¶ä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Success 200 &#123;anrry&#125; main.File</span><br></pre></td></tr></table></figure><ul><li>json</li></ul><p>å°†å¦‚ä½ åªæ˜¯è¿”å›å…¶ä»–çš„jsonæ•°æ®å¯å¦‚ä¸‹å†™ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// @Success 200 &#123;string&#125; json &quot;&quot;</span><br></pre></td></tr></table></figure></li><li><p>4.å…¶ä»–æè¿°</p><p>å¯ä»¥æ·»åŠ ä¸€äº›è¯´æ˜ã€‚</p></li></ul><h5 id="Failure"><a href="#Failure" class="headerlink" title="Failure"></a>Failure</h5><p> åŒSuccessã€‚</p><h5 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h5><p> æŒ‡å®šè·¯ç”±ä¸HTTPæ–¹æ³•ã€‚æ ¼å¼ä¸ºï¼š</p><blockquote><p>// @Router <code>/path/to/handle</code> [<code>HTTPæ–¹æ³•</code>]</p></blockquote><p> ä¸ç”¨åŠ åŸºç¡€è·¯å¾„å“¦ã€‚</p><h3 id="ç”Ÿæˆæ–‡æ¡£ä¸æµ‹è¯•"><a href="#ç”Ÿæˆæ–‡æ¡£ä¸æµ‹è¯•" class="headerlink" title="ç”Ÿæˆæ–‡æ¡£ä¸æµ‹è¯•"></a>ç”Ÿæˆæ–‡æ¡£ä¸æµ‹è¯•</h3><p>å…¶å®ä¸Šé¢å·²ç»ç©¿æ’çš„ä»‹ç»äº†ã€‚</p><p>åœ¨<code>main.go</code>ä¸‹è¿è¡Œ<code>swag init</code>å³å¯ç”Ÿæˆå’Œæ›´æ–°æ–‡æ¡£ã€‚</p><p>ç‚¹å‡»æ–‡æ¡£ä¸­çš„<code>Try it out</code>å³å¯æµ‹è¯•ã€‚ å¦‚æœéƒ¨åˆ†APIéœ€è¦ç™»é™†ï¼Œå¯ä»¥Tryç™»é™†æ¥å£å³å¯ã€‚</p><h3 id="ä¼˜åŒ–"><a href="#ä¼˜åŒ–" class="headerlink" title="ä¼˜åŒ–"></a>ä¼˜åŒ–</h3><p>çœ‹åˆ°è¿™é‡Œï¼ŒåŸºæœ¬å¯ä»¥ä½¿ç”¨äº†ã€‚ä½†æ–‡æ¡£ä¸€èˆ¬åªæ˜¯æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™éœ€è¦ï¼Œå½“æˆ‘çš„äº§å“ä¸Šçº¿åï¼Œæ¥å£æ–‡æ¡£æ˜¯ä¸åº”è¯¥ç»™ç”¨æˆ·çš„ï¼Œè€Œä¸”å¸¦æœ‰æ¥å£æ–‡æ¡£çš„åŒ…ä¹Ÿä¼šå¤§å¾ˆå¤šï¼ˆswaggoæ˜¯ç›´æ¥buildåˆ°äºŒè¿›åˆ¶é‡Œçš„ï¼‰ã€‚</p><p>æƒ³è¦å¤„ç†è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼˜åŒ–ä¸€ä¸‹ï¼Œå¦‚åˆ©ç”¨<code>build tag</code>æ¥æ§åˆ¶æ˜¯å¦ç¼–è¯‘æ–‡æ¡£ã€‚</p><p>åœ¨<code>main.go</code>å£°æ˜<code>swagHandler</code>,å¹¶åœ¨è¯¥å‚æ•°ä¸ä¸ºç©ºæ—¶æ‰åŠ å…¥è·¯ç”±ï¼š</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">//...</span><br><span class="line"></span><br><span class="line">var swagHandler gin.HandlerFunc</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">    // ...</span><br><span class="line">    </span><br><span class="line">    if swagHandler != nil &#123;</span><br><span class="line">r.GET(&quot;/swagger/*any&quot;, swagHandler)</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    //...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ—¶,æˆ‘ä»¬å°†è¯¥å‚æ•°åœ¨å¦å¤–åŠ äº†<code>build tag</code>çš„åŒ…ä¸­åˆå§‹åŒ–ã€‚</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// +build doc</span><br><span class="line"></span><br><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">_ &quot;github.com/razeencheng/demo-go/swaggo-gin/docs&quot;</span><br><span class="line"></span><br><span class="line">ginSwagger &quot;github.com/swaggo/gin-swagger&quot;</span><br><span class="line">&quot;github.com/swaggo/gin-swagger/swaggerFiles&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func init() &#123;</span><br><span class="line">swagHandler = ginSwagger.WrapHandler(swaggerFiles.Handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹åæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>go build -tags &quot;doc&quot;</code>æ¥æ‰“åŒ…å¸¦æ–‡æ¡£çš„åŒ…ï¼Œç›´æ¥<code>go build</code>æ¥æ‰“åŒ…ä¸å¸¦æ–‡æ¡£çš„åŒ…ã€‚</p><p>ä½ ä¼šå‘ç°ï¼Œå³ä½¿æˆ‘è¿™ä¹ˆå°çš„Demo,ç¼–è¯‘åçš„å¤§å°ä¹Ÿè¦ç›¸å·®19M !</p><p>å¤åˆ¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">âœ  swaggo-gin git:(master) âœ— go build</span><br><span class="line">âœ  swaggo-gin git:(master) âœ— ll swaggo-gin</span><br><span class="line">-rwxr-xr-x  1 xxx  staff    15M Jan 13 00:23 swaggo-gin</span><br><span class="line">âœ  swaggo-gin git:(master) âœ— go build -tags &quot;doc&quot;</span><br><span class="line">âœ  swaggo-gin git:(master) âœ— ll swaggo-gin</span><br><span class="line">-rwxr-xr-x  1 xxx  staff    34M Jan 13 00:24 swaggo-gin</span><br></pre></td></tr></table></figure><p>æ–‡ç« åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ï¼Œå®Œæ•´çš„<a href="https://github.com/razeencheng/demo-go/tree/master/swaggo-gin" target="_blank" rel="noopener">Demoåœ°å€åœ¨è¿™é‡Œ</a>ã€‚</p><p>ç›¸å…³é“¾æ¥</p><ul><li><a href="https://github.com/swaggo/swag" target="_blank" rel="noopener">Swaggo Github</a></li><li><a href="https://swagger.io/" target="_blank" rel="noopener">Swagger</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      ä½¿ç”¨swaggoè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
      <category term="swagger" scheme="https://cloudsjhan.github.io/tags/swagger/"/>
    
  </entry>
  
  <entry>
    <title>golangå¼€å‘æ•ˆç‡ç¥å¥‡æ±‡æ€»</title>
    <link href="https://cloudsjhan.github.io/2019/12/06/golang%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87%E7%A5%9E%E5%A5%87%E6%B1%87%E6%80%BB/"/>
    <id>https://cloudsjhan.github.io/2019/12/06/golangå¼€å‘æ•ˆç‡ç¥å¥‡æ±‡æ€»/</id>
    <published>2019-12-06T09:46:58.000Z</published>
    <updated>2019-12-06T11:03:09.961Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>ä¸€. å¼€å‘å·¥å…·<br>1)sql2go<br>ç”¨äºå°† sql è¯­å¥è½¬æ¢ä¸º golang çš„ struct. ä½¿ç”¨ ddl è¯­å¥å³å¯ã€‚<br>ä¾‹å¦‚å¯¹äºåˆ›å»ºè¡¨çš„è¯­å¥: show create table xxx. å°†è¾“å‡ºçš„è¯­å¥ï¼Œç›´æ¥ç²˜è´´è¿›å»å°±è¡Œã€‚<br><a href="http://stming.cn/tool/sql2go.html" target="_blank" rel="noopener">http://stming.cn/tool/sql2go.html</a></p><p>2)toml2go<br>ç”¨äºå°†ç¼–ç åçš„ toml æ–‡æœ¬è½¬æ¢é—® golang çš„ struct.<br><a href="https://xuri.me/toml-to-go/" target="_blank" rel="noopener">https://xuri.me/toml-to-go/</a></p><p>3)curl2go<br>ç”¨æ¥å°† curl å‘½ä»¤è½¬åŒ–ä¸ºå…·ä½“çš„ golang ä»£ç .<br><a href="https://mholt.github.io/curl-to-go/" target="_blank" rel="noopener">https://mholt.github.io/curl-to-go/</a></p><p>4)json2go<br>ç”¨äºå°† json æ–‡æœ¬è½¬æ¢ä¸º struct.<br><a href="https://mholt.github.io/json-to-go/" target="_blank" rel="noopener">https://mholt.github.io/json-to-go/</a></p><p>5)mysql è½¬ ES å·¥å…·<br><a href="http://www.ischoolbar.com/EsParser/" target="_blank" rel="noopener">http://www.ischoolbar.com/EsParser/</a></p><p>6)golang<br>æ¨¡æ‹Ÿæ¨¡æ¿çš„å·¥å…·ï¼Œåœ¨æ”¯æŒæ³›å‹ä¹‹å‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ã€‚<br><a href="https://github.com/cheekybits/genny" target="_blank" rel="noopener">https://github.com/cheekybits/genny</a></p><p>7)æŸ¥çœ‹æŸä¸€ä¸ªåº“çš„ä¾èµ–æƒ…å†µï¼Œç±»ä¼¼äº go list åŠŸèƒ½<br><a href="https://github.com/KyleBanks/depth" target="_blank" rel="noopener">https://github.com/KyleBanks/depth</a></p><p>8)ä¸€ä¸ªå¥½ç”¨çš„æ–‡ä»¶å‹ç¼©å’Œè§£å‹å·¥å…·ï¼Œé›†æˆäº† zipï¼Œtar ç­‰å¤šç§åŠŸèƒ½ï¼Œä¸»è¦è¿˜æœ‰è·¨å¹³å°ã€‚<br><a href="https://github.com/mholt/archiver" target="_blank" rel="noopener">https://github.com/mholt/archiver</a></p><p>9)go å†…ç½®å‘½ä»¤<br>go list å¯ä»¥æŸ¥çœ‹æŸä¸€ä¸ªåŒ…çš„ä¾èµ–å…³ç³».<br>go vet å¯ä»¥æ£€æŸ¥ä»£ç ä¸ç¬¦åˆ golang è§„èŒƒçš„åœ°æ–¹ã€‚</p><p>10)çƒ­ç¼–è¯‘å·¥å…·<br><a href="https://github.com/silenceper/gowatch" target="_blank" rel="noopener">https://github.com/silenceper/gowatch</a></p><p>11)revive<br>golang ä»£ç è´¨é‡æ£€æµ‹å·¥å…·<br><a href="https://github.com/mgechev/revive" target="_blank" rel="noopener">https://github.com/mgechev/revive</a></p><p>12)Go Callvis<br>golang çš„ä»£ç è°ƒç”¨é“¾å›¾å·¥å…·<br><a href="https://github.com/TrueFurby/go-callvis" target="_blank" rel="noopener">https://github.com/TrueFurby/go-callvis</a></p><p>13)Realize<br>å¼€å‘æµç¨‹æ”¹è¿›å·¥å…·<br><a href="https://github.com/oxequa/realize" target="_blank" rel="noopener">https://github.com/oxequa/realize</a></p><p>14)Gotests<br>è‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹å·¥å…·<br><a href="https://github.com/cweill/gotests" target="_blank" rel="noopener">https://github.com/cweill/gotests</a></p><p>äºŒ.è°ƒè¯•å·¥å…·<br>1)perf<br>ä»£ç†å·¥å…·ï¼Œæ”¯æŒå†…å­˜ï¼Œcpuï¼Œå †æ ˆæŸ¥çœ‹ï¼Œå¹¶æ”¯æŒç«ç„°å›¾.<br>perf å·¥å…·å’Œ go-torch å·¥å…·ï¼Œå¿«æ·å®šä½ç¨‹åºé—®é¢˜.<br><a href="https://github.com/uber-archive/go-torch" target="_blank" rel="noopener">https://github.com/uber-archive/go-torch</a><br><a href="https://github.com/google/gops" target="_blank" rel="noopener">https://github.com/google/gops</a></p><p>2)dlv è¿œç¨‹è°ƒè¯•<br>åŸºäº goland+dlv å¯ä»¥å®ç°è¿œç¨‹è°ƒå¼çš„èƒ½åŠ›.<br><a href="https://github.com/go-delve/delve" target="_blank" rel="noopener">https://github.com/go-delve/delve</a><br>æä¾›äº†å¯¹ golang åŸç”Ÿçš„æ”¯æŒï¼Œç›¸æ¯” gdb è°ƒè¯•ï¼Œç®€å•å¤ªå¤šã€‚</p><p>3)ç½‘ç»œä»£ç†å·¥å…·<br>goproxy ä»£ç†ï¼Œæ”¯æŒå¤šç§åè®®ï¼Œæ”¯æŒ ssh ç©¿é€å’Œ kcp åè®®.<br><a href="https://github.com/snail007/goproxy" target="_blank" rel="noopener">https://github.com/snail007/goproxy</a></p><p>4)æŠ“åŒ…å·¥å…·<br>go-sniffer å·¥å…·ï¼Œå¯æ‰©å±•çš„æŠ“åŒ…å·¥å…·ï¼Œå¯ä»¥å¼€å‘è‡ªå®šä¹‰åè®®çš„å·¥å…·åŒ…. ç°åœ¨åªæ”¯æŒäº† httpï¼Œmysqlï¼Œredisï¼Œmongodb.<br>åŸºäºè¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬å¼€å‘äº† qapp åè®®çš„æŠ“åŒ…ã€‚<br><a href="https://github.com/40t/go-sniffer" target="_blank" rel="noopener">https://github.com/40t/go-sniffer</a></p><p>5)åå‘ä»£ç†å·¥å…·ï¼Œå¿«æ·å¼€æ”¾å†…ç½‘ç«¯å£ä¾›å¤–éƒ¨ä½¿ç”¨ã€‚<br>ngrok å¯ä»¥è®©å†…ç½‘æœåŠ¡å¤–éƒ¨è°ƒç”¨<br><a href="https://ngrok.com/" target="_blank" rel="noopener">https://ngrok.com/</a><br><a href="https://github.com/inconshreveable/ngrok" target="_blank" rel="noopener">https://github.com/inconshreveable/ngrok</a></p><p>6)é…ç½®åŒ–ç”Ÿæˆè¯ä¹¦<br>ä»æ ¹è¯ä¹¦ï¼Œåˆ°ä¸šåŠ¡ä¾§è¯ä¹¦ä¸€é”®ç”Ÿæˆ.<br><a href="https://github.com/cloudflare/cfssl" target="_blank" rel="noopener">https://github.com/cloudflare/cfssl</a></p><p>7)å…è´¹çš„è¯ä¹¦è·å–å·¥å…·<br>åŸºäº acme åè®®ï¼Œä» letsencrypt ç”Ÿæˆå…è´¹çš„è¯ä¹¦ï¼Œæœ‰æ•ˆæœŸ 1 å¹´ï¼Œå¯è‡ªåŠ¨ç»­æœŸã€‚<br><a href="https://github.com/Neilpang/acme.sh" target="_blank" rel="noopener">https://github.com/Neilpang/acme.sh</a></p><p>8)å¼€å‘ç¯å¢ƒç®¡ç†å·¥å…·ï¼Œå•æœºæ­å»ºå¯ç§»æ¤å·¥å…·çš„åˆ©å™¨ã€‚æ”¯æŒå¤šç§è™šæ‹Ÿæœºåç«¯ã€‚<br>vagrantå¸¸è¢«æ‹¿æ¥åŒ docker ç›¸æ¯”ï¼Œå€¼å¾—æ‹¥æœ‰ã€‚<br><a href="https://github.com/hashicorp/vagrant" target="_blank" rel="noopener">https://github.com/hashicorp/vagrant</a></p><p>9)è½»é‡çº§å®¹å™¨è°ƒåº¦å·¥å…·<br>nomad å¯ä»¥éå¸¸æ–¹ä¾¿çš„ç®¡ç†å®¹å™¨å’Œä¼ ç»Ÿåº”ç”¨ï¼Œç›¸æ¯” k8s æ¥è¯´ï¼Œç®€å•ä¸è¦å¤ªå¤š.<br><a href="https://github.com/hashicorp/nomad" target="_blank" rel="noopener">https://github.com/hashicorp/nomad</a></p><p>10)æ•æ„Ÿä¿¡æ¯å’Œå¯†é’¥ç®¡ç†å·¥å…·<br><a href="https://github.com/hashicorp/vault" target="_blank" rel="noopener">https://github.com/hashicorp/vault</a></p><p>11)é«˜åº¦å¯é…ç½®åŒ–çš„ http è½¬å‘å·¥å…·ï¼ŒåŸºäº etcd é…ç½®ã€‚<br><a href="https://github.com/gojek/weaver" target="_blank" rel="noopener">https://github.com/gojek/weaver</a></p><p>12)è¿›ç¨‹ç›‘æ§å·¥å…· supervisor<br><a href="https://www.jianshu.com/p/39b476e808d8" target="_blank" rel="noopener">https://www.jianshu.com/p/39b476e808d8</a></p><p>13)åŸºäºprocFileè¿›ç¨‹ç®¡ç†å·¥å…·. ç›¸æ¯” supervisor æ›´åŠ ç®€å•ã€‚<br><a href="https://github.com/ddollar/foreman" target="_blank" rel="noopener">https://github.com/ddollar/foreman</a></p><p>14)åŸºäº httpï¼Œhttpsï¼Œwebsocket çš„è°ƒè¯•ä»£ç†å·¥å…·ï¼Œé…ç½®åŠŸèƒ½ä¸°å¯Œã€‚åœ¨çº¿æ•™è‚²çš„ nohost web è°ƒè¯•å·¥å…·ï¼ŒåŸºäºæ­¤å¼€å‘.<br><a href="https://github.com/avwo/whistle" target="_blank" rel="noopener">https://github.com/avwo/whistle</a></p><p>15)åˆ†å¸ƒå¼è°ƒåº¦å·¥å…·<br><a href="https://github.com/shunfei/cronsun/blob/master/README_ZH.md" target="_blank" rel="noopener">https://github.com/shunfei/cronsun/blob/master/README_ZH.md</a><br><a href="https://github.com/ouqiang/gocron" target="_blank" rel="noopener">https://github.com/ouqiang/gocron</a></p><p>16)è‡ªåŠ¨åŒ–è¿ç»´å¹³å° Gaia<br><a href="https://github.com/gaia-pipeline/gaia" target="_blank" rel="noopener">https://github.com/gaia-pipeline/gaia</a></p><p>ä¸‰. ç½‘ç»œå·¥å…·</p><p>å››. å¸¸ç”¨ç½‘ç«™<br>go ç™¾ç§‘å…¨ä¹¦: <a href="https://awesome-go.com/" target="_blank" rel="noopener">https://awesome-go.com/</a></p><p>json è§£æ: <a href="https://www.json.cn/" target="_blank" rel="noopener">https://www.json.cn/</a></p><p>å‡ºå£ IP: <a href="https://ipinfo.io/" target="_blank" rel="noopener">https://ipinfo.io/</a></p><p>redis å‘½ä»¤: <a href="http://doc.redisfans.com/" target="_blank" rel="noopener">http://doc.redisfans.com/</a></p><p>ES å‘½ä»¤é¦–é¡µ:</p><p><a href="https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html</a></p><p>UrlEncode: <a href="http://tool.chinaz.com/Tools/urlencode.aspx" target="_blank" rel="noopener">http://tool.chinaz.com/Tools/urlencode.aspx</a></p><p>Base64: <a href="https://tool.oschina.net/encrypt?type=3" target="_blank" rel="noopener">https://tool.oschina.net/encrypt?type=3</a></p><p>Guid: <a href="https://www.guidgen.com/" target="_blank" rel="noopener">https://www.guidgen.com/</a></p><p>å¸¸ç”¨å·¥å…·: <a href="http://www.ofmonkey.com/" target="_blank" rel="noopener">http://www.ofmonkey.com/</a></p><p>äº”. golang å¸¸ç”¨åº“<br>æ—¥å¿—<br><a href="https://github.com/Sirupsen/logrus" target="_blank" rel="noopener">https://github.com/Sirupsen/logrus</a><br><a href="https://github.com/uber-go/zap" target="_blank" rel="noopener">https://github.com/uber-go/zap</a></p><p>é…ç½®<br>å…¼å®¹ jsonï¼Œtomlï¼Œyamlï¼Œhcl ç­‰æ ¼å¼çš„æ—¥å¿—åº“.<br><a href="https://github.com/spf13/viper" target="_blank" rel="noopener">https://github.com/spf13/viper</a></p><p>å­˜å‚¨<br>mysql: <a href="https://github.com/go-xorm/xorm" target="_blank" rel="noopener">https://github.com/go-xorm/xorm</a><br>es: <a href="https://github.com/elastic/elasticsearch" target="_blank" rel="noopener">https://github.com/elastic/elasticsearch</a><br>redis: <a href="https://github.com/gomodule/redigo" target="_blank" rel="noopener">https://github.com/gomodule/redigo</a><br>mongo: <a href="https://github.com/mongodb/mongo-go-driver" target="_blank" rel="noopener">https://github.com/mongodb/mongo-go-driver</a><br>kafka: <a href="https://github.com/Shopify/sarama" target="_blank" rel="noopener">https://github.com/Shopify/sarama</a></p><p>æ•°æ®ç»“æ„<br><a href="https://github.com/emirpasic/gods" target="_blank" rel="noopener">https://github.com/emirpasic/gods</a></p><p>å‘½ä»¤è¡Œ<br><a href="https://github.com/spf13/cobra" target="_blank" rel="noopener">https://github.com/spf13/cobra</a></p><p>æ¡†æ¶<br><a href="https://github.com/grpc/grpc-go" target="_blank" rel="noopener">https://github.com/grpc/grpc-go</a><br><a href="https://github.com/gin-gonic/gin" target="_blank" rel="noopener">https://github.com/gin-gonic/gin</a></p><p>å¹¶å‘<br><a href="https://github.com/Jeffail/tunny" target="_blank" rel="noopener">https://github.com/Jeffail/tunny</a><br><a href="https://github.com/benmanns/goworker" target="_blank" rel="noopener">https://github.com/benmanns/goworker</a><br>ç°åœ¨æˆ‘ä»¬æ¡†æ¶åœ¨ç”¨çš„ï¼Œè™½ç„¶ star ä¸å¤šï¼Œä½†æ˜¯ç¡®å®å¥½ç”¨ï¼Œå½“ç„¶è¿˜å¯ä»¥æ›´å¥½ç”¨.<br><a href="https://github.com/rafaeldias/async" target="_blank" rel="noopener">https://github.com/rafaeldias/async</a></p><p>å·¥å…·<br>å®šä¹‰äº†å®ç”¨çš„åˆ¤å®šç±»ï¼Œä»¥åŠé’ˆå¯¹ç»“æ„ä½“çš„æ ¡éªŒé€»è¾‘ï¼Œé¿å…ä¸šåŠ¡ä¾§å†™å¤æ‚çš„ä»£ç .<br><a href="https://github.com/asaskevich/govalidator" target="_blank" rel="noopener">https://github.com/asaskevich/govalidator</a><br><a href="https://github.com/bytedance/go-tagexpr" target="_blank" rel="noopener">https://github.com/bytedance/go-tagexpr</a></p><p>protobuf æ–‡ä»¶åŠ¨æ€è§£æçš„æ¥å£ï¼Œå¯ä»¥å®ç°åå°„ç›¸å…³çš„èƒ½åŠ›ã€‚<br><a href="https://github.com/jhump/protoreflect" target="_blank" rel="noopener">https://github.com/jhump/protoreflect</a></p><p>è¡¨è¾¾å¼å¼•æ“å·¥å…·<br><a href="https://github.com/Knetic/govaluate" target="_blank" rel="noopener">https://github.com/Knetic/govaluate</a><br><a href="https://github.com/google/cel-go" target="_blank" rel="noopener">https://github.com/google/cel-go</a></p><p>å­—ç¬¦ä¸²å¤„ç†<br><a href="https://github.com/huandu/xstrings" target="_blank" rel="noopener">https://github.com/huandu/xstrings</a></p><p>ratelimit å·¥å…·<br><a href="https://github.com/uber-go/ratelimit" target="_blank" rel="noopener">https://github.com/uber-go/ratelimit</a><br><a href="https://blog.csdn.net/chenchongg/article/details/85342086" target="_blank" rel="noopener">https://blog.csdn.net/chenchongg/article/details/85342086</a><br><a href="https://github.com/juju/ratelimit" target="_blank" rel="noopener">https://github.com/juju/ratelimit</a></p><p>golang ç†”æ–­çš„åº“<br>ç†”æ–­é™¤äº†è€ƒè™‘é¢‘ç‡é™åˆ¶ï¼Œè¿˜è¦è€ƒè™‘ qpsï¼Œå‡ºé”™ç‡ç­‰å…¶ä»–ä¸œè¥¿.<br><a href="https://github.com/afex/hystrix-go" target="_blank" rel="noopener">https://github.com/afex/hystrix-go</a><br><a href="https://github.com/sony/gobreaker" target="_blank" rel="noopener">https://github.com/sony/gobreaker</a></p><p>è¡¨æ ¼<br><a href="https://github.com/chenjiandongx/go-echarts" target="_blank" rel="noopener">https://github.com/chenjiandongx/go-echarts</a></p><p>tail å·¥å…·åº“<br><a href="https://github.com/hpcloud/taglshi" target="_blank" rel="noopener">https://github.com/hpcloud/taglshi</a></p><hr>]]></content>
    
    <summary type="html">
    
      &lt;p class=&quot;description&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://&quot; alt=&quot;&quot; style=&quot;width:100%&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>golangè®¾è®¡æ¨¡å¼ä¹‹è£…é¥°å™¨æ¨¡å¼</title>
    <link href="https://cloudsjhan.github.io/2019/11/30/golang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F/"/>
    <id>https://cloudsjhan.github.io/2019/11/30/golangè®¾è®¡æ¨¡å¼ä¹‹è£…é¥°å™¨æ¨¡å¼/</id>
    <published>2019-11-30T07:21:30.000Z</published>
    <updated>2019-11-30T07:34:02.841Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h3 id="è£…é¥°å™¨"><a href="#è£…é¥°å™¨" class="headerlink" title="è£…é¥°å™¨"></a>è£…é¥°å™¨</h3><p>è£…é¥°å™¨ç»“æ„æ¨¡å¼å…è®¸åŠ¨æ€åœ°æ‰©å±•ç°æœ‰å¯¹è±¡çš„åŠŸèƒ½ï¼Œè€Œä¸æ”¹å˜å…¶å†…éƒ¨ç»“æ„ã€‚</p><p>è£…é¥°å™¨æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹æ³•æ¥æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ã€‚</p><h3 id="golang-å®ç°"><a href="#golang-å®ç°" class="headerlink" title="golang å®ç°"></a>golang å®ç°</h3><p>ä¸‹é¢çš„LogDecorateç”¨signature funcï¼ˆintï¼‰intä¿®é¥°å‡½æ•°ï¼Œè¯¥å‡½æ•°æ“ä½œæ•´æ•°å¹¶æ·»åŠ è¾“å…¥/è¾“å‡ºæ—¥å¿—è®°å½•åŠŸèƒ½ã€‚</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Object <span class="function"><span class="keyword">func</span><span class="params">(<span class="keyword">int</span>)</span> <span class="title">int</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">func</span> <span class="title">LogDecorate</span><span class="params">(fn Object)</span> <span class="title">Object</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">log.Println(<span class="string">"Starting the execution with the integer"</span>, n)</span><br><span class="line"></span><br><span class="line">result := fn(n)</span><br><span class="line"></span><br><span class="line">log.Println(<span class="string">"Execution is completed with the result"</span>, result)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Double</span><span class="params">(n <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> n*<span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line">f := LogDecorate(Double)</span><br><span class="line">f(<span class="number">5</span>)</span><br><span class="line"><span class="comment">//å‚æ•°ä¸º5ï¼Œå¼€å§‹æ‰§è¡Œ</span></span><br><span class="line"><span class="comment">//æ‰§è¡Œçš„ç»“æœæ˜¯10</span></span><br></pre></td></tr></table></figure><h3 id="ç»éªŒ"><a href="#ç»éªŒ" class="headerlink" title="ç»éªŒ"></a>ç»éªŒ</h3><ul><li><p>ä¸é€‚é…å™¨æ¨¡å¼ä¸åŒï¼Œè¦ä¿®é¥°çš„å¯¹è±¡æ˜¯é€šè¿‡æ³¨å…¥è·å¾—çš„ã€‚</p></li><li><p>è£…é¥°å™¨ä¸åº”æ›´æ”¹å¯¹è±¡çš„æ¥å£ã€‚</p></li></ul><hr>]]></content>
    
    <summary type="html">
    
      golangè®¾è®¡æ¨¡å¼ä¹‹è£…é¥°å™¨æ¨¡å¼
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://cloudsjhan.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>github&amp;Daocloudæ¼”è®²ç¨¿æ•´ç†ä¸æ€»ç»“</title>
    <link href="https://cloudsjhan.github.io/2019/11/23/githubXDaocloud%E6%BC%94%E8%AE%B2%E7%A8%BF%E6%95%B4%E7%90%86%E4%B8%8E%E6%80%BB%E7%BB%93-md/"/>
    <id>https://cloudsjhan.github.io/2019/11/23/githubXDaocloudæ¼”è®²ç¨¿æ•´ç†ä¸æ€»ç»“-md/</id>
    <published>2019-11-23T14:27:40.000Z</published>
    <updated>2019-11-23T14:37:12.828Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><p>å¤§å®¶ä¸‹åˆå¥½ï¼Œä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„åˆ†äº«ä¸»é¢˜æ˜¯ golang çš„å†…å­˜åˆ†æä»¥åŠä¼˜åŒ–ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†å†…å®¹ï¼Œä¸€æ˜¯ ä»¥å¼€æºé¡¹ç›®crawlabçš„å†…å­˜åˆ†æä¸ä¼˜åŒ–ä¸ºä¾‹ï¼Œè®²è§£golangå†…å­˜è°ƒä¼˜çš„ä¸€äº›å·¥å…·å’Œåˆ†æçš„è¿‡ç¨‹ï¼›</p><p>ç¬¬äºŒéƒ¨åˆ†æ˜¯ä»‹ç»å¹³æ—¶å¼€å‘ä¸­å®¹æ˜“å¿½ç•¥çš„å’Œå®¹æ˜“å¸¦æ¥æ€§èƒ½é—®é¢˜çš„ç‚¹ï¼Œä»¥åŠå¦‚ä½•å»ä¼˜åŒ–ã€‚</p><p>å½“æ—¶è¿™ä¸ªè¯é¢˜çš„çµæ„Ÿæ¥è‡ªä¸€ä¸ªå¼€æºé¡¹ç›® crawlab, crawlabæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œè¿™é‡Œä¸å±•å¼€è¯¦ç»†è§£é‡Šäº†ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥åˆ°GitHubä¸»é¡µçœ‹ä¸€ä¸‹ï¼Œ<a href="https://github.com/crawlab-team/crawlab" target="_blank" rel="noopener">https://github.com/crawlab-team/crawlab</a></p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98bvonxkzj305k05kmx1.jpg" alt="crawlab_pic"></p><p>å½“æ—¶æ˜¯æœ‰ç”¨æˆ·æŠ¥å‡ºcrawlabå¯åŠ¨ä¸€æ®µæ—¶é—´åï¼Œä¸»èŠ‚ç‚¹æœºå™¨ä¼šå‡ºç°å†…å­˜å ç”¨è¿‡é«˜çš„é—®é¢˜ï¼Œä¸€å°4Gå†…å­˜çš„æœåŠ¡å™¨åœ¨è¿è¡Œcrawlabåç«Ÿç„¶èƒ½å ç”¨3Gä»¥çš„å†…å­˜ï¼Œç„¶åæ•´ä¸ªmasterå°±ä¼šdownæ‰ï¼Œäºæ˜¯æˆ‘å¼€å§‹å¯¹crawlabçš„åç«¯æœåŠ¡è¿›è¡Œæ€§èƒ½çš„åˆ†æï¼Œä¸‹é¢å°†å¸¦å¤§å®¶å›é¡¾è¿™ä¸€è¿‡ç¨‹ã€‚</p><p>é¦–å…ˆä»‹ç»ï¼ŒGolangçš„æ€§èƒ½åˆ†æä¸»è¦åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼Œ<img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98ckayzwxj323f0u0wui.jpg" alt="æˆªå±2019-11-2322.14.47"></p><p>ä¸€ç§æ˜¯é€šè¿‡æ–‡ä»¶æ–¹å¼è¾“å‡ºprofileï¼Œç‰¹ç‚¹æ˜¯çµæ´»æ€§é«˜ï¼Œé€‚ç”¨äºç‰¹å®šä»£ç ç‰‡æ®µçš„åˆ†æï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨/runtimeåŒ…ä¸­çš„/pprofçš„APIç”Ÿæˆç›¸åº”çš„pprofæ–‡ä»¶ï¼Œç„¶åä½¿ç”¨ pprofå°±å¯ä»¥è¿›å…¥ç±»ä¼¼GDBçš„çª—å£ã€‚åœ¨è¿™ä¸ªçª—å£ä¸­ä½ å°±å¯ä»¥ç”¨top,list functionç­‰å‘½ä»¤å»æŸ¥çœ‹cpu,memoryçš„çŠ¶å†µä»¥åŠgoroutineè¿è¡Œæƒ…å†µã€‚</p><p>ç¬¬äºŒç§æ–¹å¼å°±æ˜¯é€šè¿‡HTTPè¾“å‡ºprofileï¼Œ</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98ckr5ve9j31cz0u07h2.jpg" alt="æˆªå±2019-11-2322.17.33"></p><p>è¿™ç§æ–¹å¼å°±é€‚åˆäºä½ è¿˜ä¸æ¸…æ¥šåˆ°åº•å“ªä¸€æ®µä»£ç å‡ºç°é—®é¢˜ï¼Œè€Œä¸”ä½ çš„åº”ç”¨è¦æŒç»­è¿è¡Œçš„æƒ…å†µã€‚åœ¨åˆ†æcrawlabçš„æ—¶å€™ï¼Œé‡‡ç”¨çš„æ˜¯è¿™ç§æ–¹å¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨crawlabé¡¹ç›®ä¸­åµŒå…¥å¦‚ä¸‹å‡ è¡Œä»£ç ï¼Œå°†crawlabåç«¯æœåŠ¡å¯åŠ¨åï¼Œæµè§ˆå™¨ä¸­è¾“å…¥<a href="http://ip:8899/debug/pprof/å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œç‚¹å‡»heapï¼Œåœ¨æ±‡æ€»åˆ†æé¡µé¢çš„æœ€ä¸Šæ–¹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ" target="_blank" rel="noopener">http://ip:8899/debug/pprof/å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œç‚¹å‡»heapï¼Œåœ¨æ±‡æ€»åˆ†æé¡µé¢çš„æœ€ä¸Šæ–¹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ</a></p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98cjvmammj311k06w0t6.jpg" alt="heap_server"></p><p>çº¢è‰²ç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯å½“å‰å·²ç»ä½¿ç”¨çš„å †å†…å­˜æ˜¯25M,ï¼åœ¨æˆ‘åªä¸Šä¼ ä¸€ä¸ªçˆ¬è™«æ–‡ä»¶ï¼Œè€Œä¸”è¿™ä¸ªæ–‡ä»¶è¿˜ä¸æ˜¯ç‰¹åˆ«æ‰“å¤§çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåç«¯æœåŠ¡æ‰€ç”¨çš„å†…å­˜ä½¿ç”¨ç«Ÿç„¶èƒ½è¾¾åˆ°25Mã€‚</p><p>æˆ‘ä»¬å†ç”¨è¿™ä¸ªå‘½ä»¤è¿›å…¥å‘½ä»¤è¡Œè¯¦ç»†çœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤è¿›å…¥åï¼Œè¾“å…¥topå‘½ä»¤å¯ä»¥æ˜¾ç¤ºå‰10çš„å†…å­˜åˆ†é…ï¼Œflatæ˜¯å †æ ˆä¸­å½“å‰å±‚çš„inuseå†…å­˜å€¼ï¼Œcumæ˜¯å †æ ˆä¸­æœ¬å±‚çº§çš„ç´¯è®¡inuseå†…å­˜å€¼ã€‚</p><p>å¯ä»¥çœ‹åˆ°ï¼Œbytes.makeSliceè¿™ä¸ªå†…ç½®æ–¹æ³•ç«Ÿç„¶ä½¿ç”¨äº†24Må†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è€ƒè™‘è°ä¼šç”¨åˆ°makesliceå‘¢ï¼Œ<img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c5dze47j31fq0mu79j.jpg" alt="heap_gdb"></p><p>ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ReadFromè¿™ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸‹æºç ï¼Œå‘ç° ioutil.ReadAll() é‡Œä¼šè°ƒç”¨ bytes.Buffer.ReadFrom, </p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c67o6udj30hi0b40ur.jpg" alt="image-20191123222106249"></p><p>è€Œ ReadFrom ä¼šè¿›è¡Œ makeSliceã€‚è®©æˆ‘ä»¬å†å›å¤´çœ‹ä¸€ä¸‹readAllçš„ä»£ç å®ç°ï¼š</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c6oud5sj30i709zq57.jpg" alt="image-20191123222129984"></p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯ä» io.Reader é‡Œè¯»å–çš„æ•°æ®æ”¾å…¥ buffer ä¸­ï¼Œå¦‚æœ buffer ç©ºé—´ä¸å¤Ÿï¼Œå°±æŒ‰ç…§æ¯æ¬¡ 2x æ‰€è¯»å–å†…å®¹çš„å¤§å°+ MinRead çš„ç®—æ³•é€’å¢ï¼Œè¿™é‡Œ MinRead çš„å¤§å°æ˜¯ 512 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ€§è¯»å–çš„å†…å®¹è¿‡å¤§ï¼Œå°±ä¼šå¯¼è‡´æ‰€ä½¿ç”¨çš„å†…å­˜å€å¢ï¼Œå‡è®¾æˆ‘ä»¬çš„æ‰€æœ‰ä»»åŠ¡æ–‡ä»¶æ€»å…±æœ‰500M,é‚£ä¹ˆæ‰€ç”¨çš„å†…å­˜å°±æœ‰500M * 2 + 512Bï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†æå¾ˆå¯èƒ½æ˜¯è¿™ä¸ªåŸå› å¯¼è‡´çš„ï¼Œé‚£çœ‹çœ‹crawlabæºç ä¸­æ˜¯å“ªä¸€æ®µä½¿ç”¨ReadAllè¯»äº†æ–‡ä»¶ï¼Œå®šä½åˆ°äº†è¿™é‡Œ</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c734tyjj30hq07dtae.jpg" alt="image-20191123222147655">     </p><p>è¿™æ®µä»£ç ç›´æ¥å°†å…¨éƒ¨çš„æ–‡ä»¶å†…å®¹ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¯»äº†è¿›æ¥ï¼Œå¯¼è‡´å†…å­˜å€å¢ï¼Œä»¤äººçª’æ¯çš„æ“ä½œã€‚è‡³æ­¤ï¼Œé—®é¢˜å·²ç»å‘ç°ï¼Œé‚£ä¹ˆå¦‚ä½•å»ä¼˜åŒ–å‘¢ï¼Œå…¶å®åœ¨è¯»å¤§æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»åˆ°å†…å­˜ï¼Œç›´æ¥å°±ç¿»è½¦äº†ï¼Œæ­£ç¡®æ˜¯å¤„ç†æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æµå¼å¤„ç† ï¼Œå¦‚ä»£ç æ‰€ç¤º</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c74vzzdj30dp09zwfp.jpg" alt="image-20191123222203534"></p><p>ç¬¬äºŒç§æ–¹æ¡ˆå°±æ˜¯åˆ†ç‰‡å¤„ç†ï¼Œå½“è¯»å–çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰æ¢è¡Œç¬¦çš„æ—¶å€™ï¼Œä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒåˆé€‚ã€‚</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c7fsg21j30cx09z0u6.jpg" alt="image-20191123222215908"></p><p>æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨çš„ç¬¬äºŒç§æ–¹å¼æ¥ä¼˜åŒ–ï¼Œä¼˜åŒ–åå†æ¥çœ‹ä¸‹å†…å­˜å ç”¨æƒ…å†µ</p><p>æˆ‘ä»¬é‡‡æ ·ç¨‹åºè¿è¡Œ30sçš„å¹³å‡å†…å­˜ï¼Œå¹¶ä¸”åœ¨æ­¤æœŸé—´è®¿é—®ä¸Šä¼ æ–‡ä»¶çš„æ¥å£åï¼Œçœ‹åˆ°å†…å­˜å ç”¨å·²ç»é™åˆ°æ­£å¸¸çš„æ°´å¹³äº†ã€‚</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c7uw1iij30ou09f77c.jpg" alt="image-20191123222231369">v</p><p>åˆšåˆšæˆ‘ç”¨ä¸€ä¸ªå®é™…æ¡ˆä¾‹ä»‹ç»äº†å¦‚ä½•å»ä¸€æ­¥ä¸€æ­¥çš„åˆ†æåŠä¼˜åŒ–goç¨‹åºçš„å†…å­˜é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥åœ¨å¹³æ—¶å¼€å‘ä¸­å¤šå»æ¢ç´¢ï¼Œå¤šä½¿ç”¨ã€‚</p><p>æ¥ä¸‹æ¥ä»‹ç»ä¸€äº›go å¼€å‘ä¸­çš„å°æŠ€å·§ï¼Œä»ç»†èŠ‚ä¸Šæé«˜ä½ çš„golangåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚</p><p>ä¼—æ‰€å‘¨çŸ¥Json ä½œä¸ºä¸€ç§é‡è¦çš„æ•°æ®æ ¼å¼ï¼Œå¤§å®¶å¼€å‘è€…ç»å¸¸ç”¨åˆ°ã€‚Go è¯­è¨€é‡Œé¢åŸç”Ÿæ”¯æŒäº†jsonçš„åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–ï¼Œå†…éƒ¨ä½¿ç”¨åå°„æœºåˆ¶å®ç°ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåå°„çš„æ€§èƒ½æœ‰ç‚¹å·®ï¼Œåœ¨é«˜åº¦ä¾èµ– json è§£æçš„æ¥å£é‡Œï¼Œè¿™å¾€å¾€ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œå¥½åœ¨å·²æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹åº“å¸®æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¿™ä¹ˆå¤šåº“ï¼Œåˆ°åº•è¦æ€ä¹ˆé€‰æ‹©å‘¢ï¼Œä¸‹é¢å°±ç»™å¤§å®¶æ¥ä¸€ä¸€åˆ†æä¸€ä¸‹ï¼Œè¿™é‡Œä»‹ç»4ä¸ªjsonåºåˆ—åŒ–ååºåˆ—åŒ–çš„åº“,</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c8lsud5j31uo0u0h6c.jpg" alt="æˆªå±2019-11-2322.23.03"></p><p>çœ‹å®Œè¿™äº›ä½ å¯èƒ½ä¸çŸ¥é“åˆ°åº•è¯¥ç”¨å“ªä¸€ä¸ªï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹benchmark.</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98c8l87rlj30qo07m776.jpg" alt="image-20191123222330976"></p><ul><li><p>â€‹    â€¢easyjson æ— è®ºæ˜¯åºåˆ—åŒ–è¿˜æ˜¯ååºåˆ—åŒ–éƒ½æ˜¯æœ€ä¼˜çš„ï¼Œåºåˆ—åŒ–æå‡äº†1å€ï¼Œååºåˆ—åŒ–æå‡äº†3å€</p></li><li><p>â€‹    â€¢jsoniter æ€§èƒ½ä¹Ÿå¾ˆå¥½ï¼Œæ¥è¿‘äºeasyjsonï¼Œå…³é”®æ˜¯æ²¡æœ‰é¢„ç¼–è¯‘è¿‡ç¨‹ï¼Œ100%å…¼å®¹åŸç”Ÿåº“</p></li><li><p>â€‹    â€¢ffjson çš„åºåˆ—åŒ–æå‡å¹¶ä¸æ˜æ˜¾ï¼Œååºåˆ—åŒ–æå‡äº†1å€</p></li><li><p>æ‰€ä»¥ç»¼åˆè€ƒè™‘ï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨ jsoniterï¼Œå¦‚æœè¿½æ±‚æè‡´çš„æ€§èƒ½ï¼Œè€ƒè™‘ easyjson</p><p>å­—ç¬¦ä¸²æ‹¼æ¥åœ¨å¼€å‘ä¸­è‚¯å®šæ˜¯ç»å¸¸ç”¨åˆ°çš„ï¼Œå½“ä½ çš„åº”ç”¨ä¸­çš„æŸä¸€éƒ¨åˆ†å¤§é‡ç”¨åˆ°å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œä½ æœ€å¥½ç•™æ„ä¸€ä¸‹ä¸‹é¢çš„å†…å®¹ã€‚æˆ‘ä»¬åˆ—ä¸¾4ä¸­å­—ç¬¦ä¸²æ‹¼æ¥çš„æ–¹å¼ï¼Œçœ‹çœ‹ä½ ç»å¸¸ç”¨çš„æ˜¯å“ªä¸ªï¼Ÿ</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98cab6m7nj31n30u0tmk.jpg" alt="æˆªå±2019-11-2322.24.48"></p></li></ul><p>ç¬¬ä¸€ç§ + å·è¿ç®—ç¬¦ï¼Œç¬¬äºŒç§æ˜¯golangç‰¹æœ‰çš„ä¸€ç§æ–¹å¼ï¼Œç¬¬ä¸‰ä¸­æ˜¯ strings.builder, æœ€åä¸€ç§æ˜¯strings.bufferã€‚</p><p>çœ‹ä¸‹benchmarkä½ å°±ä¼šåšå‡ºä½ æœ€ç»ˆçš„é€‰æ‹©ã€‚æ€§èƒ½æœ€å¥½çš„æ˜¯strings.builder,è€Œsprintfæ€§èƒ½æœ€å·®ï¼Œ+ å·è¿ç®—ç¬¦ä¹Ÿæ²¡å¥½åˆ°å“ªé‡Œå»ã€‚</p><p><img src="https://tva1.sinaimg.cn/large/006y8mN6gy1g98cabpls3j30qo07y764.jpg" alt="image-20191123222511309"></p><p>ä»¥ä¸Šå°±æ˜¯æˆ‘ä»Šå¤©åˆ†äº«çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼Œä¸‹é¢æ˜¯æˆ‘çš„è”ç³»æ–¹å¼ï¼Œæœ‰é—®é¢˜çš„å¯ä»¥çº¿ä¸‹ç»§ç»­äº¤æµã€‚è°¢è°¢ï¼</p><hr>]]></content>
    
    <summary type="html">
    
      github&amp;Daocloudæ¼”è®²æ€»ç»“
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
      <category term="ç”Ÿæ´»" scheme="https://cloudsjhan.github.io/tags/%E7%94%9F%E6%B4%BB/"/>
    
  </entry>
  
  <entry>
    <title>golang cronä½¿ç”¨</title>
    <link href="https://cloudsjhan.github.io/2019/10/29/golang-cron%E4%BD%BF%E7%94%A8/"/>
    <id>https://cloudsjhan.github.io/2019/10/29/golang-cronä½¿ç”¨/</id>
    <published>2019-10-29T11:10:03.000Z</published>
    <updated>2019-10-29T11:12:04.488Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h1 id="Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£"><a href="#Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£" class="headerlink" title="Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£"></a>Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£</h1><p> æ›´æ–°æ—¶é—´ï¼š2018å¹´01æœˆ11æ—¥ 10:51:02  ä½œè€…ï¼šéª‘å¤´çŒªé€›è¡—  <a href="https://www.jb51.net/article/132655.htm#comments" target="_blank" rel="noopener"><img src="https://www.jb51.net/skin/2018/images/text-message.png" alt="img"> æˆ‘è¦è¯„è®º</a></p><p>æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£ï¼Œå°ç¼–è§‰å¾—æŒºä¸é”™çš„ï¼Œç°åœ¨åˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿç»™å¤§å®¶åšä¸ªå‚è€ƒã€‚ä¸€èµ·è·Ÿéšå°ç¼–è¿‡æ¥çœ‹çœ‹å§</p><p><strong>cronæ˜¯ä»€ä¹ˆ</strong></p><p>cronçš„æ„æ€å°±æ˜¯ï¼šè®¡åˆ’ä»»åŠ¡ï¼Œè¯´ç™½äº†å°±æ˜¯å®šæ—¶ä»»åŠ¡ã€‚æˆ‘å’Œç³»ç»Ÿçº¦ä¸ªæ—¶é—´ï¼Œä½ åœ¨å‡ ç‚¹å‡ åˆ†å‡ ç§’æˆ–è€…æ¯éš”å‡ åˆ†é’Ÿè·‘ä¸€ä¸ªä»»åŠ¡(job)ï¼Œå°±é‚£ä¹ˆç®€å•ã€‚</p><p><strong>cronè¡¨è¾¾å¼</strong>ã€€ã€€</p><p>cronè¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œè¿™ä¸ªä¸œè¥¿ä¸ä»…Javaçš„quartZèƒ½ç”¨åˆ°ï¼ŒGoè¯­è¨€ä¸­ä¹Ÿå¯ä»¥ç”¨åˆ°ã€‚æˆ‘æ²¡æœ‰ç”¨è¿‡Linuxçš„cronï¼Œä½†ç½‘ä¸Šè¯´Linuxä¹Ÿæ˜¯å¯ä»¥ç”¨crontab -e å‘½ä»¤æ¥é…ç½®å®šæ—¶ä»»åŠ¡ã€‚Goè¯­è¨€å’ŒJavaä¸­éƒ½æ˜¯å¯ä»¥ç²¾ç¡®åˆ°ç§’çš„ï¼Œä½†æ˜¯Linuxä¸­ä¸è¡Œã€‚</p><p>cronè¡¨è¾¾å¼ä»£è¡¨ä¸€ä¸ªæ—¶é—´çš„é›†åˆï¼Œä½¿ç”¨6ä¸ªç©ºæ ¼åˆ†éš”çš„å­—æ®µè¡¨ç¤ºï¼š</p><table><thead><tr><th>å­—æ®µå</th><th>æ˜¯å¦å¿…é¡»</th><th>å…è®¸çš„å€¼</th><th>å…è®¸çš„ç‰¹å®šå­—ç¬¦</th></tr></thead><tbody><tr><td>ç§’(Seconds)</td><td>æ˜¯</td><td>0-59</td><td>* / , -</td></tr><tr><td>åˆ†(Minute)</td><td>æ˜¯</td><td>0-59</td><td>* / , -</td></tr><tr><td>æ—¶(Hours)</td><td>æ˜¯</td><td>0-23</td><td>* / , -</td></tr><tr><td>æ—¥(Day of month)</td><td>æ˜¯</td><td>1-31</td><td>* / , - ?</td></tr><tr><td>æœˆ(Month)</td><td>æ˜¯</td><td>1-12 æˆ– JAN-DEC</td><td>* / , -</td></tr><tr><td>æ˜ŸæœŸ(Day of week)</td><td>å¦</td><td>0-6 æˆ– SUM-SAT</td><td>* / , - ?</td></tr></tbody></table><p>1.æœˆ(Month)å’Œæ˜ŸæœŸ(Day of week)å­—æ®µçš„å€¼ä¸åŒºåˆ†å¤§å°å†™ï¼Œå¦‚ï¼šSUNã€Sun å’Œ sun æ˜¯ä¸€æ ·çš„ã€‚</p><p>2.æ˜ŸæœŸ(Day of week)å­—æ®µå¦‚æœæ²¡æä¾›ï¼Œç›¸å½“äºæ˜¯ *</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ min (0 - 59)``# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)``# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)``# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12)``# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of week (0 - 6) (0 to 6 are Sunday to``# â”‚ â”‚ â”‚ â”‚ â”‚     Saturday, or use names; 7 is also Sunday)``# â”‚ â”‚ â”‚ â”‚ â”‚``# â”‚ â”‚ â”‚ â”‚ â”‚``# * * * * * command to execute`</span><br></pre></td></tr></table></figure><p>cronç‰¹å®šå­—ç¬¦è¯´æ˜</p><p>1ï¼‰æ˜Ÿå·(*)</p><p>è¡¨ç¤º cron è¡¨è¾¾å¼èƒ½åŒ¹é…è¯¥å­—æ®µçš„æ‰€æœ‰å€¼ã€‚å¦‚åœ¨ç¬¬5ä¸ªå­—æ®µä½¿ç”¨æ˜Ÿå·(month)ï¼Œè¡¨ç¤ºæ¯ä¸ªæœˆ</p><p>2ï¼‰æ–œçº¿(/)</p><p>è¡¨ç¤ºå¢é•¿é—´éš”ï¼Œå¦‚ç¬¬1ä¸ªå­—æ®µ(minutes) å€¼æ˜¯ 3-59/15ï¼Œè¡¨ç¤ºæ¯å°æ—¶çš„ç¬¬3åˆ†é’Ÿå¼€å§‹æ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åæ¯éš” 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆå³ 3ã€18ã€33ã€48 è¿™äº›æ—¶é—´ç‚¹æ‰§è¡Œï¼‰ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºï¼š3/15</p><p>3ï¼‰é€—å·(,)</p><p>ç”¨äºæšä¸¾å€¼ï¼Œå¦‚ç¬¬6ä¸ªå­—æ®µå€¼æ˜¯ MON,WED,FRIï¼Œè¡¨ç¤º æ˜ŸæœŸä¸€ã€ä¸‰ã€äº” æ‰§è¡Œ</p><p>4ï¼‰è¿å­—å·(-)</p><p>è¡¨ç¤ºä¸€ä¸ªèŒƒå›´ï¼Œå¦‚ç¬¬3ä¸ªå­—æ®µçš„å€¼ä¸º 9-17 è¡¨ç¤º 9am åˆ° 5pm ç›´æ¥æ¯ä¸ªå°æ—¶ï¼ˆåŒ…æ‹¬9å’Œ17ï¼‰</p><p>5ï¼‰é—®å·(?)</p><p>åªç”¨äº æ—¥(Day of month) å’Œ æ˜ŸæœŸ(Day of week)ï¼Œè¡¨ç¤ºä¸æŒ‡å®šå€¼ï¼Œå¯ä»¥ç”¨äºä»£æ›¿ *</p><p>6ï¼‰Lï¼ŒWï¼Œ#</p><p>Goä¸­æ²¡æœ‰Lï¼ŒWï¼Œ#çš„ç”¨æ³•ï¼Œä¸‹æ–‡ä½œè§£é‡Šã€‚</p><p><strong>cronä¸¾ä¾‹è¯´æ˜</strong></p><p>æ¯éš”5ç§’æ‰§è¡Œä¸€æ¬¡ï¼š<em>/5 </em> <em> </em> * ?</p><p>æ¯éš”1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼š0 <em>/1 </em> <em> </em> ?</p><p>æ¯å¤©23ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼š0 0 23 <em> </em> ?</p><p>æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼š0 0 1 <em> </em> ?</p><p>æ¯æœˆ1å·å‡Œæ™¨1ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼š0 0 1 1 * ?</p><p>åœ¨26åˆ†ã€29åˆ†ã€33åˆ†æ‰§è¡Œä¸€æ¬¡ï¼š0 26,29,33 <em> </em> * ?</p><p>æ¯å¤©çš„0ç‚¹ã€13ç‚¹ã€18ç‚¹ã€21ç‚¹éƒ½æ‰§è¡Œä¸€æ¬¡ï¼š0 0 0,13,18,21 <em> </em> ?</p><p><strong>ä¸‹è½½å®‰è£…</strong></p><p>æ§åˆ¶å°è¾“å…¥ <code>go get github.com/robfig/cron</code>å»ä¸‹è½½å®šæ—¶ä»»åŠ¡çš„GoåŒ…ï¼Œå‰ææ˜¯ä½ çš„<code>$GOPATH</code>å·²ç»é…ç½®å¥½</p><p>æºç è§£æ</p><p>æ–‡ä»¶ç›®å½•è®²è§£ã€€</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`constantdelay.go  #ä¸€ä¸ªæœ€ç®€å•çš„ç§’çº§åˆ«å®šæ—¶ç³»ç»Ÿã€‚ä¸cronæ— å…³``constantdelay_test.go #æµ‹è¯•``cron.go    #Cronç³»ç»Ÿã€‚ç®¡ç†ä¸€ç³»åˆ—çš„cronå®šæ—¶ä»»åŠ¡ï¼ˆSchedule Jobï¼‰``cron_test.go   #æµ‹è¯•``doc.go    #è¯´æ˜æ–‡æ¡£``LICENSE    #æˆæƒä¹¦ ``parser.go    #è§£æå™¨ï¼Œè§£æcronæ ¼å¼å­—ç¬¦ä¸²åŸä¸€ä¸ªå…·ä½“çš„å®šæ—¶å™¨ï¼ˆScheduleï¼‰``parser_test.go  #æµ‹è¯•``README.md    #README``spec.go    #å•ä¸ªå®šæ—¶å™¨ï¼ˆScheduleï¼‰ç»“æ„ä½“ã€‚å¦‚ä½•è®¡ç®—è‡ªå·±çš„ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´``spec_test.go   #æµ‹è¯•`</span><br></pre></td></tr></table></figure><p><strong>cron.go</strong></p><p>ç»“æ„ä½“ï¼š</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`// Cron keeps track of any number of entries, invoking the associated func as``// specified by the schedule. It may be started, stopped, and the entries may``// be inspected while running. ``// Cronä¿æŒä»»æ„æ•°é‡çš„æ¡ç›®çš„è½¨é“ï¼Œè°ƒç”¨ç›¸å…³çš„funcæ—¶é—´è¡¨æŒ‡å®šã€‚å®ƒå¯ä»¥è¢«å¯åŠ¨ï¼Œåœæ­¢å’Œæ¡ç›®ï¼Œå¯è¿è¡Œçš„åŒæ—¶è¿›è¡Œæ£€æŸ¥ã€‚``type Cron struct &#123;`` ``entries []*Entry ã€€ã€€ã€€ã€€// ä»»åŠ¡`` ``stop  chan struct&#123;&#125;  // å«åœæ­¢çš„é€”å¾„`` ``add  chan *Entry  // æ·»åŠ æ–°ä»»åŠ¡çš„æ–¹å¼`` ``snapshot chan []*Entry  // è¯·æ±‚è·å–ä»»åŠ¡å¿«ç…§çš„æ–¹å¼`` ``running bool    // æ˜¯å¦åœ¨è¿è¡Œ`` ``ErrorLog *log.Logger  // å‡ºé”™æ—¥å¿—(æ–°å¢å±æ€§)`` ``location *time.Location  // æ‰€åœ¨åœ°åŒº(æ–°å¢å±æ€§)  ``&#125;`</span><br></pre></td></tr></table></figure><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`// Entry consists of a schedule and the func to execute on that schedule.``// å…¥å£åŒ…æ‹¬æ—¶é—´è¡¨å’Œå¯åœ¨æ—¶é—´è¡¨ä¸Šæ‰§è¡Œçš„func``type Entry struct &#123;``  ``// è®¡æ—¶å™¨`` ``Schedule Schedule`` ``// ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´`` ``Next time.Time`` ``// ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´`` ``Prev time.Time`` ``// ä»»åŠ¡`` ``Job Job``&#125;`</span><br></pre></td></tr></table></figure><p>å…³é”®æ–¹æ³•ï¼š</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`// å¼€å§‹ä»»åŠ¡``// Start the cron scheduler in its own go-routine, or no-op if already started.``func (c *Cron) Start() &#123;`` ``if c.running &#123;``  ``return`` ``&#125;`` ``c.running = true`` ``go c.run()``&#125;``// ç»“æŸä»»åŠ¡``// Stop stops the cron scheduler if it is running; otherwise it does nothing.``func (c *Cron) Stop() &#123;`` ``if !c.running &#123;``  ``return`` ``&#125;`` ``c.stop &lt;- struct&#123;&#125;&#123;&#125;`` ``c.running = false``&#125;` `// æ‰§è¡Œå®šæ—¶ä»»åŠ¡``// Run the scheduler.. this is private just due to the need to synchronize``// access to the &apos;running&apos; state variable.``func (c *Cron) run() &#123;`` ``// Figure out the next activation times for each entry.`` ``now := time.Now().In(c.location)`` ``for _, entry := range c.entries &#123;``  ``entry.Next = entry.Schedule.Next(now)`` ``&#125;``  ``// æ— é™å¾ªç¯`` ``for &#123;``   ``//é€šè¿‡å¯¹ä¸‹ä¸€ä¸ªæ‰§è¡Œæ—¶é—´è¿›è¡Œæ’åºï¼Œåˆ¤æ–­é‚£äº›ä»»åŠ¡æ˜¯ä¸‹ä¸€æ¬¡è¢«æ‰§è¡Œçš„ï¼Œé˜²åœ¨é˜Ÿåˆ—çš„å‰é¢.sortæ˜¯ç”¨æ¥åšæ’åºçš„``  ``sort.Sort(byTime(c.entries))` `  ``var effective time.Time``  ``if len(c.entries) == 0 || c.entries[0].Next.IsZero() &#123;``   ``// If there are no entries yet, just sleep - it still handles new entries``   ``// and stop requests.``   ``effective = now.AddDate(10, 0, 0)``  ``&#125; else &#123;``   ``effective = c.entries[0].Next``  ``&#125;` `  ``timer := time.NewTimer(effective.Sub(now))``  ``select &#123;``  ``case now = &lt;-timer.C: // æ‰§è¡Œå½“å‰ä»»åŠ¡``   ``now = now.In(c.location)``   ``// Run every entry whose next time was this effective time.``   ``for _, e := range c.entries &#123;``    ``if e.Next != effective &#123;``     ``break``    ``&#125;``    ``go c.runWithRecovery(e.Job)``    ``e.Prev = e.Next``    ``e.Next = e.Schedule.Next(now)``   ``&#125;``   ``continue` `  ``case newEntry := &lt;-c.add: // æ·»åŠ æ–°çš„ä»»åŠ¡``   ``c.entries = append(c.entries, newEntry)``   ``newEntry.Next = newEntry.Schedule.Next(time.Now().In(c.location))` `  ``case &lt;-c.snapshot: // è·å–å¿«ç…§``   ``c.snapshot &lt;- c.entrySnapshot()` `  ``case &lt;-c.stop: // åœæ­¢ä»»åŠ¡``   ``timer.Stop()``   ``return``  ``&#125;` `  ``// &apos;now&apos; should be updated after newEntry and snapshot cases.``  ``now = time.Now().In(c.location)``  ``timer.Stop()`` ``&#125;``&#125;`</span><br></pre></td></tr></table></figure><p>spec.go</p><p>ç»“æ„ä½“åŠå…³é”®æ–¹æ³•ï¼š</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`// SpecSchedule specifies a duty cycle (to the second granularity), based on a``// traditional crontab specification. It is computed initially and stored as bit sets.``type SpecSchedule struct &#123;`` ``// è¡¨è¾¾å¼ä¸­é”è¡¨æ˜çš„ï¼Œç§’ï¼Œåˆ†ï¼Œæ—¶ï¼Œæ—¥ï¼Œæœˆï¼Œå‘¨ï¼Œæ¯ä¸ªéƒ½æ˜¯uint64`` ``// Dom:Day of Month,Dow:Day of week`` ``Second, Minute, Hour, Dom, Month, Dow uint64``&#125;` `// bounds provides a range of acceptable values (plus a map of name to value).``// å®šä¹‰äº†è¡¨è¾¾å¼çš„ç»“æ„ä½“``type bounds struct &#123;`` ``min, max uint`` ``names map[string]uint``&#125;` `// The bounds for each field.``// è¿™æ ·å°±èƒ½çœ‹å‡ºå„ä¸ªè¡¨è¾¾å¼çš„èŒƒå›´``var (``  ``seconds = bounds&#123;0, 59, nil&#125;``  ``minutes = bounds&#123;0, 59, nil&#125;``  ``hours = bounds&#123;0, 23, nil&#125;``  ``dom  = bounds&#123;1, 31, nil&#125;``  ``months = bounds&#123;1, 12, map[string]uint&#123;``    ``&quot;jan&quot;: 1,``    ``&quot;feb&quot;: 2,``    ``&quot;mar&quot;: 3,``    ``&quot;apr&quot;: 4,``    ``&quot;may&quot;: 5,``    ``&quot;jun&quot;: 6,``    ``&quot;jul&quot;: 7,``    ``&quot;aug&quot;: 8,``    ``&quot;sep&quot;: 9,``    ``&quot;oct&quot;: 10,``    ``&quot;nov&quot;: 11,``    ``&quot;dec&quot;: 12,``  ``&#125;&#125;``  ``dow = bounds&#123;0, 6, map[string]uint&#123;``    ``&quot;sun&quot;: 0,``    ``&quot;mon&quot;: 1,``    ``&quot;tue&quot;: 2,``    ``&quot;wed&quot;: 3,``    ``&quot;thu&quot;: 4,``    ``&quot;fri&quot;: 5,``    ``&quot;sat&quot;: 6,``  ``&#125;&#125;``)` `const (``  ``// Set the top bit if a star was included in the expression.``  ``starBit = 1 &lt;&lt; 63``)`</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸Šé¢çš„ä¸œè¥¿è‚¯å®šæœ‰äººç–‘æƒ‘ä¸ºä»€ä¹ˆç§’åˆ†æ—¶è¿™äº›éƒ½æ˜¯å®šä¹‰äº†unit64,ä»¥åŠå®šä¹‰äº†ä¸€ä¸ªå¸¸é‡starBit = 1 &lt;&lt; 63è¿™ç§å†™æ³•ï¼Œè¿™æ˜¯é€»è¾‘è¿ç®—ç¬¦ã€‚è¡¨ç¤ºäºŒè¿›åˆ¶1å‘å·¦ç§»åŠ¨63ä½ã€‚åŸå› å¦‚ä¸‹ï¼š</p><p>cronè¡¨è¾¾å¼æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ç³»åˆ—æ—¶é—´çš„ï¼Œè€Œæ—¶é—´æ˜¯æ— æ³•é€ƒè„±è‡ªå·±çš„åŒºé—´çš„ ï¼Œ åˆ†ï¼Œç§’ 0 - 59 ï¼Œ æ—¶ 0 - 23 ï¼Œ å¤©/æœˆ 0 - 31 ï¼Œ å¤©/å‘¨ 0 - 6 ï¼Œ æœˆ0 - 11 ã€‚ è¿™äº›æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªç‚¹é›†åˆï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ªæ•´æ•°åŒºé—´ã€‚ é‚£ä¹ˆå¯¹äºä»»æ„çš„æ•´æ•°åŒºé—´ ï¼Œ å¯ä»¥æè¿°cronçš„å¦‚ä¸‹éƒ¨åˆ†è§„åˆ™ã€‚</p><ol><li>* | ? ä»»æ„ ï¼Œ å¯¹åº”åŒºé—´ä¸Šçš„æ‰€æœ‰ç‚¹ã€‚ ï¼ˆ é¢å¤–æ³¨æ„ æ—¥/å‘¨ ï¼Œ æ—¥ / æœˆ çš„ç›¸äº’å¹²æ‰°ã€‚ï¼‰</li><li>çº¯æ•°å­— ï¼Œ å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç‚¹ã€‚</li><li>/ åˆ†å‰²çš„ä¸¤ä¸ªæ•°å­— a , bï¼Œ åŒºé—´ä¸Šç¬¦åˆ a + n * b çš„æ‰€æœ‰ç‚¹ ï¼ˆ n &gt;= 0 )ã€‚</li><li>- åˆ†å‰²çš„ä¸¤ä¸ªæ•°å­—ï¼Œ å¯¹åº”è¿™ä¸¤ä¸ªæ•°å­—å†³å®šçš„åŒºé—´å†…çš„æ‰€æœ‰ç‚¹ã€‚</li><li>L | W éœ€è¦å¯¹äºç‰¹å®šçš„æ—¶é—´ç‰¹æ®Šåˆ¤æ–­ï¼Œ æ— æ³•é€šç”¨çš„å¯¹åº”åˆ°åŒºé—´ä¸Šçš„ç‚¹ã€‚</li></ol><p>è‡³æ­¤ï¼Œ robfig/cronä¸ºä»€ä¹ˆä¸æ”¯æŒ L | Wçš„åŸå› å·²ç»æ˜äº†äº†ã€‚å»é™¤è¿™ä¸¤æ¡è§„åˆ™åï¼Œ å…¶ä½™çš„è§„åˆ™å…¶å®å®Œå…¨å¯ä»¥ä½¿ç”¨ç‚¹çš„ç©·ä¸¾æ¥é€šç”¨è¡¨ç¤ºã€‚ è€ƒè™‘åˆ°æœ€å¤§çš„åŒºé—´ä¹Ÿä¸è¿‡æ˜¯60ä¸ªç‚¹ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸€ä¸ªuint64çš„æ•´æ•°çš„æ¯ä¸€ä½æ¥è¡¨ç¤ºä¸€ä¸ªç‚¹ä¾¿å¾ˆåˆé€‚äº†ã€‚æ‰€ä»¥å®šä¹‰unit64ä¸ä¸ºè¿‡</p><p>ä¸‹é¢æ˜¯goä¸­cronè¡¨è¾¾å¼çš„æ–¹æ³•ï¼š</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`/* `` ``------------------------------------------------------------`` ``ç¬¬64ä½æ ‡è®°ä»»æ„ ï¼Œ ç”¨äº æ—¥/å‘¨ ï¼Œ æ—¥ / æœˆ çš„ç›¸äº’å¹²æ‰°ã€‚`` ``63 - 0 ä¸º è¡¨ç¤ºåŒºé—´ [63 , 0] çš„ æ¯ä¸€ä¸ªç‚¹ã€‚`` ``------------------------------------------------------------` ` ``å‡è®¾åŒºé—´æ˜¯ 0 - 63 ï¼Œ åˆ™æœ‰å¦‚ä¸‹çš„ä¾‹å­ ï¼š` ` ``æ¯”å¦‚ 0/3 çš„è¡¨ç¤ºå¦‚ä¸‹ ï¼š (è¡¨ç¤ºæ¯éš”ä¸¤ä½ä¸º1)`` ``* / ?  `` ``+---+--------------------------------------------------------+`` ``| 0 | 1 0 0 1 0 0 1 ~~ ~~     1 0 0 1 0 0 1 |`` ``+---+--------------------------------------------------------+ ``  ``63 ~ ~           ~~ 0` ` ``æ¯”å¦‚ 2-5 çš„è¡¨ç¤ºå¦‚ä¸‹ ï¼š (è¡¨ç¤ºä»å³å¾€å·¦2-5ä½ä¸Šéƒ½æ˜¯1)`` ``* / ?  `` ``+---+--------------------------------------------------------+`` ``| 0 | 0 0 0 0 ~ ~  ~~   ~ 0 0 0 1 1 1 1 0 0 |`` ``+---+--------------------------------------------------------+ ``  ``63 ~ ~           ~~ 0` ` ``æ¯”å¦‚ * çš„è¡¨ç¤ºå¦‚ä¸‹ ï¼š (è¡¨ç¤ºæ‰€æœ‰ä½ç½®ä¸Šéƒ½ä¸º1)`` ``* / ?  `` ``+---+--------------------------------------------------------+`` ``| 1 | 1 1 1 1 1 ~ ~     ~ 1 1 1 1 1 1 1 1 1 |`` ``+---+--------------------------------------------------------+ ``  ``63 ~ ~           ~~ 0 ``*/`</span><br></pre></td></tr></table></figure><p>parser.go</p><p>å°†å­—ç¬¦ä¸²è§£æä¸ºSpecScheduleçš„ç±»ã€‚</p><p><a href="https://www.jb51.net/article/132655.htm#" target="_blank" rel="noopener">?</a></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`package cron` `import (`` ``&quot;fmt&quot;`` ``&quot;math&quot;`` ``&quot;strconv&quot;`` ``&quot;strings&quot;`` ``&quot;time&quot;``)` `// Configuration options for creating a parser. Most options specify which``// fields should be included, while others enable features. If a field is not``// included the parser will assume a default value. These options do not change``// the order fields are parse in.``type ParseOption int` `const (`` ``Second  ParseOption = 1 &lt;&lt; iota // Seconds field, default 0`` ``Minute        // Minutes field, default 0`` ``Hour        // Hours field, default 0`` ``Dom         // Day of month field, default *`` ``Month        // Month field, default *`` ``Dow         // Day of week field, default *`` ``DowOptional       // Optional day of week field, default *`` ``Descriptor       // Allow descriptors such as @monthly, @weekly, etc.``)` `var places = []ParseOption&#123;`` ``Second,`` ``Minute,`` ``Hour,`` ``Dom,`` ``Month,`` ``Dow,``&#125;` `var defaults = []string&#123;`` ``&quot;0&quot;,`` ``&quot;0&quot;,`` ``&quot;0&quot;,`` ``&quot;*&quot;,`` ``&quot;*&quot;,`` ``&quot;*&quot;,``&#125;` `// A custom Parser that can be configured.``type Parser struct &#123;`` ``options ParseOption`` ``optionals int``&#125;` `// Creates a custom Parser with custom options.``//``// // Standard parser without descriptors``// specParser := NewParser(Minute | Hour | Dom | Month | Dow)``// sched, err := specParser.Parse(&quot;0 0 15 */3 *&quot;)``//``// // Same as above, just excludes time fields``// subsParser := NewParser(Dom | Month | Dow)``// sched, err := specParser.Parse(&quot;15 */3 *&quot;)``//``// // Same as above, just makes Dow optional``// subsParser := NewParser(Dom | Month | DowOptional)``// sched, err := specParser.Parse(&quot;15 */3&quot;)``//``func NewParser(options ParseOption) Parser &#123;`` ``optionals := 0`` ``if options&amp;DowOptional &gt; 0 &#123;``  ``options |= Dow``  ``optionals++`` ``&#125;`` ``return Parser&#123;options, optionals&#125;``&#125;` `// Parse returns a new crontab schedule representing the given spec.``// It returns a descriptive error if the spec is not valid.``// It accepts crontab specs and features configured by NewParser.``// å°†å­—ç¬¦ä¸²è§£ææˆä¸ºSpecSchedule ã€‚ SpecScheduleç¬¦åˆScheduleæ¥å£` `func (p Parser) Parse(spec string) (Schedule, error) &#123;``ã€€ã€€// ç›´æ¥å¤„ç†ç‰¹æ®Šçš„ç‰¹æ®Šçš„å­—ç¬¦ä¸²`` ``if spec[0] == &apos;@&apos; &amp;&amp; p.options&amp;Descriptor &gt; 0 &#123;``  ``return parseDescriptor(spec)`` ``&#125;` ` ``// Figure out how many fields we need`` ``max := 0`` ``for _, place := range places &#123;``  ``if p.options&amp;place &gt; 0 &#123;``   ``max++``  ``&#125;`` ``&#125;`` ``min := max - p.optionals` ` ``// cronåˆ©ç”¨ç©ºç™½æ‹†è§£å‡ºç‹¬ç«‹çš„itemsã€‚`` ``fields := strings.Fields(spec)` ` ``// éªŒè¯è¡¨è¾¾å¼å–å€¼èŒƒå›´`` ``if count := len(fields); count &lt; min || count &gt; max &#123;``  ``if min == max &#123;``   ``return nil, fmt.Errorf(&quot;Expected exactly %d fields, found %d: %s&quot;, min, count, spec)``  ``&#125;``  ``return nil, fmt.Errorf(&quot;Expected %d to %d fields, found %d: %s&quot;, min, max, count, spec)`` ``&#125;` ` ``// Fill in missing fields`` ``fields = expandFields(fields, p.options)` ` ``var err error`` ``field := func(field string, r bounds) uint64 &#123;``  ``if err != nil &#123;``   ``return 0``  ``&#125;``  ``var bits uint64``  ``bits, err = getField(field, r)``  ``return bits`` ``&#125;` ` ``var (``  ``second  = field(fields[0], seconds)``  ``minute  = field(fields[1], minutes)``  ``hour  = field(fields[2], hours)``  ``dayofmonth = field(fields[3], dom)``  ``month  = field(fields[4], months)``  ``dayofweek = field(fields[5], dow)`` ``)`` ``if err != nil &#123;``  ``return nil, err`` ``&#125;`` ``// è¿”å›æ‰€éœ€è¦çš„SpecSchedule`` ``return &amp;SpecSchedule&#123;``  ``Second: second,``  ``Minute: minute,``  ``Hour: hour,``  ``Dom: dayofmonth,``  ``Month: month,``  ``Dow: dayofweek,`` ``&#125;, nil``&#125;` `func expandFields(fields []string, options ParseOption) []string &#123;`` ``n := 0`` ``count := len(fields)`` ``expFields := make([]string, len(places))`` ``copy(expFields, defaults)`` ``for i, place := range places &#123;``  ``if options&amp;place &gt; 0 &#123;``   ``expFields[i] = fields[n]``   ``n++``  ``&#125;``  ``if n == count &#123;``   ``break``  ``&#125;`` ``&#125;`` ``return expFields``&#125;` `var standardParser = NewParser(`` ``Minute | Hour | Dom | Month | Dow | Descriptor,``)` `// ParseStandard returns a new crontab schedule representing the given standardSpec``// (https://en.wikipedia.org/wiki/Cron). It differs from Parse requiring to always``// pass 5 entries representing: minute, hour, day of month, month and day of week,``// in that order. It returns a descriptive error if the spec is not valid.``//``// It accepts``// - Standard crontab specs, e.g. &quot;* * * * ?&quot;``// - Descriptors, e.g. &quot;@midnight&quot;, &quot;@every 1h30m&quot;``// è¿™é‡Œè¡¨ç¤ºä¸ä»…å¯ä»¥ä½¿ç”¨cronè¡¨è¾¾å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨@midnight @everyç­‰æ–¹æ³•` `func ParseStandard(standardSpec string) (Schedule, error) &#123;`` ``return standardParser.Parse(standardSpec)``&#125;` `var defaultParser = NewParser(`` ``Second | Minute | Hour | Dom | Month | DowOptional | Descriptor,``)` `// Parse returns a new crontab schedule representing the given spec.``// It returns a descriptive error if the spec is not valid.``//``// It accepts``// - Full crontab specs, e.g. &quot;* * * * * ?&quot;``// - Descriptors, e.g. &quot;@midnight&quot;, &quot;@every 1h30m&quot;``func Parse(spec string) (Schedule, error) &#123;`` ``return defaultParser.Parse(spec)``&#125;` `// getField returns an Int with the bits set representing all of the times that``// the field represents or error parsing field value. A &quot;field&quot; is a comma-separated``// list of &quot;ranges&quot;.``func getField(field string, r bounds) (uint64, error) &#123;`` ``var bits uint64`` ``ranges := strings.FieldsFunc(field, func(r rune) bool &#123; return r == &apos;,&apos; &#125;)`` ``for _, expr := range ranges &#123;``  ``bit, err := getRange(expr, r)``  ``if err != nil &#123;``   ``return bits, err``  ``&#125;``  ``bits |= bit`` ``&#125;`` ``return bits, nil``&#125;` `// getRange returns the bits indicated by the given expression:``// number | number &quot;-&quot; number [ &quot;/&quot; number ]``// or error parsing range.``func getRange(expr string, r bounds) (uint64, error) &#123;`` ``var (``  ``start, end, step uint``  ``rangeAndStep  = strings.Split(expr, &quot;/&quot;)``  ``lowAndHigh  = strings.Split(rangeAndStep[0], &quot;-&quot;)``  ``singleDigit  = len(lowAndHigh) == 1``  ``err    error`` ``)` ` ``var extra uint64`` ``if lowAndHigh[0] == &quot;*&quot; || lowAndHigh[0] == &quot;?&quot; &#123;``  ``start = r.min``  ``end = r.max``  ``extra = starBit`` ``&#125; else &#123;``  ``start, err = parseIntOrName(lowAndHigh[0], r.names)``  ``if err != nil &#123;``   ``return 0, err``  ``&#125;``  ``switch len(lowAndHigh) &#123;``  ``case 1:``   ``end = start``  ``case 2:``   ``end, err = parseIntOrName(lowAndHigh[1], r.names)``   ``if err != nil &#123;``    ``return 0, err``   ``&#125;``  ``default:``   ``return 0, fmt.Errorf(&quot;Too many hyphens: %s&quot;, expr)``  ``&#125;`` ``&#125;` ` ``switch len(rangeAndStep) &#123;`` ``case 1:``  ``step = 1`` ``case 2:``  ``step, err = mustParseInt(rangeAndStep[1])``  ``if err != nil &#123;``   ``return 0, err``  ``&#125;` `  ``// Special handling: &quot;N/step&quot; means &quot;N-max/step&quot;.``  ``if singleDigit &#123;``   ``end = r.max``  ``&#125;`` ``default:``  ``return 0, fmt.Errorf(&quot;Too many slashes: %s&quot;, expr)`` ``&#125;` ` ``if start &lt; r.min &#123;``  ``return 0, fmt.Errorf(&quot;Beginning of range (%d) below minimum (%d): %s&quot;, start, r.min, expr)`` ``&#125;`` ``if end &gt; r.max &#123;``  ``return 0, fmt.Errorf(&quot;End of range (%d) above maximum (%d): %s&quot;, end, r.max, expr)`` ``&#125;`` ``if start &gt; end &#123;``  ``return 0, fmt.Errorf(&quot;Beginning of range (%d) beyond end of range (%d): %s&quot;, start, end, expr)`` ``&#125;`` ``if step == 0 &#123;``  ``return 0, fmt.Errorf(&quot;Step of range should be a positive number: %s&quot;, expr)`` ``&#125;` ` ``return getBits(start, end, step) | extra, nil``&#125;` `// parseIntOrName returns the (possibly-named) integer contained in expr.``func parseIntOrName(expr string, names map[string]uint) (uint, error) &#123;`` ``if names != nil &#123;``  ``if namedInt, ok := names[strings.ToLower(expr)]; ok &#123;``   ``return namedInt, nil``  ``&#125;`` ``&#125;`` ``return mustParseInt(expr)``&#125;` `// mustParseInt parses the given expression as an int or returns an error.``func mustParseInt(expr string) (uint, error) &#123;`` ``num, err := strconv.Atoi(expr)`` ``if err != nil &#123;``  ``return 0, fmt.Errorf(&quot;Failed to parse int from %s: %s&quot;, expr, err)`` ``&#125;`` ``if num &lt; 0 &#123;``  ``return 0, fmt.Errorf(&quot;Negative number (%d) not allowed: %s&quot;, num, expr)`` ``&#125;` ` ``return uint(num), nil``&#125;` `// getBits sets all bits in the range [min, max], modulo the given step size.``func getBits(min, max, step uint) uint64 &#123;`` ``var bits uint64` ` ``// If step is 1, use shifts.`` ``if step == 1 &#123;``  ``return ^(math.MaxUint64 &lt;&lt; (max + 1)) &amp; (math.MaxUint64 &lt;&lt; min)`` ``&#125;` ` ``// Else, use a simple loop.`` ``for i := min; i &lt;= max; i += step &#123;``  ``bits |= 1 &lt;&lt; i`` ``&#125;`` ``return bits``&#125;` `// all returns all bits within the given bounds. (plus the star bit)``func all(r bounds) uint64 &#123;`` ``return getBits(r.min, r.max, 1) | starBit``&#125;` `// parseDescriptor returns a predefined schedule for the expression, or error if none matches.``func parseDescriptor(descriptor string) (Schedule, error) &#123;`` ``switch descriptor &#123;`` ``case &quot;@yearly&quot;, &quot;@annually&quot;:``  ``return &amp;SpecSchedule&#123;``   ``Second: 1 &lt;&lt; seconds.min,``   ``Minute: 1 &lt;&lt; minutes.min,``   ``Hour: 1 &lt;&lt; hours.min,``   ``Dom: 1 &lt;&lt; dom.min,``   ``Month: 1 &lt;&lt; months.min,``   ``Dow: all(dow),``  ``&#125;, nil` ` ``case &quot;@monthly&quot;:``  ``return &amp;SpecSchedule&#123;``   ``Second: 1 &lt;&lt; seconds.min,``   ``Minute: 1 &lt;&lt; minutes.min,``   ``Hour: 1 &lt;&lt; hours.min,``   ``Dom: 1 &lt;&lt; dom.min,``   ``Month: all(months),``   ``Dow: all(dow),``  ``&#125;, nil` ` ``case &quot;@weekly&quot;:``  ``return &amp;SpecSchedule&#123;``   ``Second: 1 &lt;&lt; seconds.min,``   ``Minute: 1 &lt;&lt; minutes.min,``   ``Hour: 1 &lt;&lt; hours.min,``   ``Dom: all(dom),``   ``Month: all(months),``   ``Dow: 1 &lt;&lt; dow.min,``  ``&#125;, nil` ` ``case &quot;@daily&quot;, &quot;@midnight&quot;:``  ``return &amp;SpecSchedule&#123;``   ``Second: 1 &lt;&lt; seconds.min,``   ``Minute: 1 &lt;&lt; minutes.min,``   ``Hour: 1 &lt;&lt; hours.min,``   ``Dom: all(dom),``   ``Month: all(months),``   ``Dow: all(dow),``  ``&#125;, nil` ` ``case &quot;@hourly&quot;:``  ``return &amp;SpecSchedule&#123;``   ``Second: 1 &lt;&lt; seconds.min,``   ``Minute: 1 &lt;&lt; minutes.min,``   ``Hour: all(hours),``   ``Dom: all(dom),``   ``Month: all(months),``   ``Dow: all(dow),``  ``&#125;, nil`` ``&#125;` ` ``const every = &quot;@every &quot;`` ``if strings.HasPrefix(descriptor, every) &#123;``  ``duration, err := time.ParseDuration(descriptor[len(every):])``  ``if err != nil &#123;``   ``return nil, fmt.Errorf(&quot;Failed to parse duration %s: %s&quot;, descriptor, err)``  ``&#125;``  ``return Every(duration), nil`` ``&#125;` ` ``return nil, fmt.Errorf(&quot;Unrecognized descriptor: %s&quot;, descriptor)``&#125;`</span><br></pre></td></tr></table></figure><p>é¡¹ç›®ä¸­åº”ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`package main``import (`` ``&quot;github.com/robfig/cron&quot;`` ``&quot;log&quot;``)` `func main() &#123;`` ``i := 0`` ``c := cron.New()`` ``spec := &quot;*/5 * * * * ?&quot;`` ``c.AddFunc(spec, func() &#123;``  ``i++``  ``log.Println(&quot;cron running:&quot;, i)`` ``&#125;)`` ``c.AddFunc(&quot;@every 1h1m&quot;, func() &#123;``  ``i++``  ``log.Println(&quot;cron running:&quot;, i)`` ``&#125;)`` ``c.Start()``&#125;`</span><br></pre></td></tr></table></figure><p>æ³¨ï¼š @every ç”¨æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œè¿™æ˜¯Goé‡Œé¢æ¯”è¾ƒç‰¹è‰²çš„ç”¨æ³•ã€‚åŒæ ·çš„è¿˜æœ‰ @yearly @annually @monthly @weekly @daily @midnight @hourly è¿™é‡Œé¢å°±ä¸ä¸€ä¸€èµ˜è¿°äº†ã€‚å¸Œæœ›å¤§å®¶èƒ½å¤Ÿè‡ªå·±æ¢ç´¢ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Docker compose ç½‘ç»œè®¾ç½®</title>
    <link href="https://cloudsjhan.github.io/2019/10/27/Docker-compose-%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE/"/>
    <id>https://cloudsjhan.github.io/2019/10/27/Docker-compose-ç½‘ç»œè®¾ç½®/</id>
    <published>2019-10-27T12:00:22.000Z</published>
    <updated>2019-10-27T12:21:28.385Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h1 id="Docker-Compose-ç½‘ç»œè®¾ç½®"><a href="#Docker-Compose-ç½‘ç»œè®¾ç½®" class="headerlink" title="Docker Compose ç½‘ç»œè®¾ç½®"></a>Docker Compose ç½‘ç»œè®¾ç½®</h1><h3 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ"></a>åŸºæœ¬æ¦‚å¿µ</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒComposeä¼šä¸ºæˆ‘ä»¬çš„åº”ç”¨åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒæœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½ä¼šåŠ å…¥è¯¥ç½‘ç»œä¸­ã€‚è¿™æ ·ï¼Œå®¹å™¨å°±å¯è¢«è¯¥ç½‘ç»œä¸­çš„å…¶ä»–å®¹å™¨è®¿é—®ï¼Œä¸ä»…å¦‚æ­¤ï¼Œè¯¥å®¹å™¨è¿˜èƒ½ä»¥æœåŠ¡åç§°ä½œä¸ºhostnameè¢«å…¶ä»–å®¹å™¨è®¿é—®ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºçš„ç½‘ç»œåç§°åŸºäºComposeçš„å·¥ç¨‹åç§°ï¼Œè€Œé¡¹ç›®åç§°åŸºäºdocker-compose.ymlæ‰€åœ¨ç›®å½•çš„åç§°ã€‚å¦‚éœ€ä¿®æ”¹å·¥ç¨‹åç§°ï¼Œå¯ä½¿ç”¨â€“project-nameæ ‡è¯†æˆ–COMPOSE_PORJECT_NAMEç¯å¢ƒå˜é‡ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åºåœ¨åä¸ºmyappçš„ç›®å½•ä¸­ï¼Œå¹¶ä¸”docker-compose.ymlå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8000:8000&quot;</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è¿è¡Œdocker-compose upæ—¶ï¼Œå°†ä¼šæ‰§è¡Œä»¥ä¸‹å‡ æ­¥ï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªåä¸ºmyapp_defaultçš„ç½‘ç»œï¼›</li><li>ä½¿ç”¨webæœåŠ¡çš„é…ç½®åˆ›å»ºå®¹å™¨ï¼Œå®ƒä»¥â€œwebâ€è¿™ä¸ªåç§°åŠ å…¥ç½‘ç»œmyapp_defaultï¼›</li><li>ä½¿ç”¨dbæœåŠ¡çš„é…ç½®åˆ›å»ºå®¹å™¨ï¼Œå®ƒä»¥â€œdbâ€è¿™ä¸ªåç§°åŠ å…¥ç½‘ç»œmyapp_defaultã€‚</li></ul><p>å®¹å™¨é—´å¯ä½¿ç”¨æœåŠ¡åç§°ï¼ˆwebæˆ–dbï¼‰ä½œä¸ºhostnameç›¸äº’è®¿é—®ã€‚ä¾‹å¦‚ï¼Œwebè¿™ä¸ªæœåŠ¡å¯ä½¿ç”¨<code>postgres://db:5432</code> è®¿é—®dbå®¹å™¨ã€‚</p><h3 id="æ›´æ–°å®¹å™¨"><a href="#æ›´æ–°å®¹å™¨" class="headerlink" title="æ›´æ–°å®¹å™¨"></a>æ›´æ–°å®¹å™¨</h3><p>å½“æœåŠ¡çš„é…ç½®å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œå¯ä½¿ç”¨docker-compose upå‘½ä»¤æ›´æ–°é…ç½®ã€‚</p><p>æ­¤æ—¶ï¼ŒComposeä¼šåˆ é™¤æ—§å®¹å™¨å¹¶åˆ›å»ºæ–°å®¹å™¨ã€‚æ–°å®¹å™¨ä¼šä»¥ä¸åŒçš„IPåœ°å€åŠ å…¥ç½‘ç»œï¼Œåç§°ä¿æŒä¸å˜ã€‚ä»»ä½•æŒ‡å‘æ—§å®¹å™¨çš„è¿æ¥éƒ½ä¼šè¢«å…³é—­ï¼Œå®¹å™¨ä¼šé‡æ–°æ‰¾åˆ°æ–°å®¹å™¨å¹¶è¿æ¥ä¸Šå»ã€‚</p><h3 id="links"><a href="#links" class="headerlink" title="links"></a>links</h3><p>å‰æ–‡è®²è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡ä¹‹é—´å¯ä½¿ç”¨æœåŠ¡åç§°ç›¸äº’è®¿é—®ã€‚linkså…è®¸æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåˆ«åï¼Œä»è€Œä½¿ç”¨è¯¥åˆ«åè®¿é—®å…¶ä»–æœåŠ¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    links:</span><br><span class="line">      - &quot;db:database&quot;</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br></pre></td></tr></table></figure><p>è¿™æ ·webæœåŠ¡å°±å¯ä½¿ç”¨dbæˆ–databaseä½œä¸ºhostnameè®¿é—®dbæœåŠ¡äº†ã€‚</p><h3 id="æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œ"><a href="#æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œ" class="headerlink" title="æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œ"></a>æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œ</h3><p>ä¸€äº›åœºæ™¯ä¸‹ï¼Œé»˜è®¤çš„ç½‘ç»œé…ç½®æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä½¿ç”¨networkså‘½ä»¤è‡ªå®šä¹‰ç½‘ç»œã€‚networkså‘½ä»¤å…è®¸æˆ‘ä»¬åˆ›å»ºæ›´åŠ å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘å¹¶æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œé©±åŠ¨å’Œé€‰é¡¹ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä½¿ç”¨networkså°†æœåŠ¡è¿æ¥åˆ°ä¸æ˜¯ç”±Composeç®¡ç†çš„ã€å¤–éƒ¨åˆ›å»ºçš„ç½‘ç»œã€‚</p><p>å¦‚ä¸‹ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªè‡ªå®šä¹‰ç½‘ç»œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  proxy:</span><br><span class="line">    build: ./proxy</span><br><span class="line">    networks:</span><br><span class="line">      - front</span><br><span class="line">  app:</span><br><span class="line">    build: ./app</span><br><span class="line">    networks:</span><br><span class="line">      - front</span><br><span class="line">      - back</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br><span class="line">    networks:</span><br><span class="line">      - back</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  front:</span><br><span class="line">    # Use a custom driver</span><br><span class="line">    driver: custom-driver-1</span><br><span class="line">  back:</span><br><span class="line">    # Use a custom driver which takes special options</span><br><span class="line">    driver: custom-driver-2</span><br><span class="line">    driver_opts:</span><br><span class="line">      foo: &quot;1&quot;</span><br><span class="line">      bar: &quot;2&quot;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒproxyæœåŠ¡ä¸dbæœåŠ¡éš”ç¦»ï¼Œä¸¤è€…åˆ†åˆ«ä½¿ç”¨è‡ªå·±çš„ç½‘ç»œï¼›appæœåŠ¡å¯ä¸ä¸¤è€…é€šä¿¡ã€‚</p><p>ç”±æœ¬ä¾‹ä¸éš¾å‘ç°ï¼Œä½¿ç”¨networkså‘½ä»¤ï¼Œå³å¯æ–¹ä¾¿å®ç°æœåŠ¡é—´çš„ç½‘ç»œéš”ç¦»ä¸è¿æ¥ã€‚</p><h3 id="é…ç½®é»˜è®¤ç½‘ç»œ"><a href="#é…ç½®é»˜è®¤ç½‘ç»œ" class="headerlink" title="é…ç½®é»˜è®¤ç½‘ç»œ"></a>é…ç½®é»˜è®¤ç½‘ç»œ</h3><p>é™¤è‡ªå®šä¹‰ç½‘ç»œå¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä¸ºé»˜è®¤ç½‘ç»œè‡ªå®šä¹‰é…ç½®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">version: &apos;2&apos;</span><br><span class="line"></span><br><span class="line">services:</span><br><span class="line">  web:</span><br><span class="line">    build: .</span><br><span class="line">    ports:</span><br><span class="line">      - &quot;8000:8000&quot;</span><br><span class="line">  db:</span><br><span class="line">    image: postgres</span><br><span class="line"></span><br><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">    # Use a custom driver</span><br><span class="line">    driver: custom-driver-1</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œå°±å¯ä¸ºè¯¥åº”ç”¨æŒ‡å®šè‡ªå®šä¹‰çš„ç½‘ç»œé©±åŠ¨ã€‚</p><h3 id="ä½¿ç”¨å·²å­˜åœ¨çš„ç½‘ç»œ"><a href="#ä½¿ç”¨å·²å­˜åœ¨çš„ç½‘ç»œ" class="headerlink" title="ä½¿ç”¨å·²å­˜åœ¨çš„ç½‘ç»œ"></a>ä½¿ç”¨å·²å­˜åœ¨çš„ç½‘ç»œ</h3><p>ä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åˆ›å»ºæ–°çš„ç½‘ç»œï¼Œè€Œåªéœ€åŠ å…¥å·²å­˜åœ¨çš„ç½‘ç»œï¼Œæ­¤æ—¶å¯ä½¿ç”¨externalé€‰é¡¹ã€‚ç¤ºä¾‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">networks:</span><br><span class="line">  default:</span><br><span class="line">    external:</span><br><span class="line">      name: my-pre-existing-network</span><br></pre></td></tr></table></figure><h3 id="Docker-Compose-é“¾æ¥å¤–éƒ¨å®¹å™¨çš„å‡ ç§æ–¹å¼"><a href="#Docker-Compose-é“¾æ¥å¤–éƒ¨å®¹å™¨çš„å‡ ç§æ–¹å¼" class="headerlink" title="Docker Compose é“¾æ¥å¤–éƒ¨å®¹å™¨çš„å‡ ç§æ–¹å¼"></a>Docker Compose é“¾æ¥å¤–éƒ¨å®¹å™¨çš„å‡ ç§æ–¹å¼</h3><p>åœ¨Dockerä¸­ï¼Œå®¹å™¨ä¹‹é—´çš„é“¾æ¥æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ“ä½œï¼šå®ƒæä¾›äº†è®¿é—®å…¶ä¸­çš„æŸä¸ªå®¹å™¨çš„ç½‘ç»œæœåŠ¡è€Œä¸éœ€è¦å°†æ‰€éœ€çš„ç«¯å£æš´éœ²ç»™Docker Hostä¸»æœºçš„åŠŸèƒ½ã€‚Docker Composeä¸­å¯¹è¯¥ç‰¹æ€§çš„æ”¯æŒåŒæ ·æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ç„¶è€Œï¼Œå¦‚æœéœ€è¦é“¾æ¥çš„å®¹å™¨æ²¡æœ‰å®šä¹‰åœ¨åŒä¸€ä¸ª<code>docker-compose.yml</code>ä¸­çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™å°±ç¨å¾®éº»çƒ¦å¤æ‚äº†ç‚¹ã€‚</p><p>åœ¨ä¸ä½¿ç”¨Docker Composeçš„æ—¶å€™ï¼Œå°†ä¸¤ä¸ªå®¹å™¨é“¾æ¥èµ·æ¥ä½¿ç”¨<code>â€”link</code>å‚æ•°ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œä»¥<code>nginx</code>é•œåƒä¸ºä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run --rm --name test1 -d nginx  #å¼€å¯ä¸€ä¸ªå®ä¾‹test1</span><br><span class="line">docker run --rm --name test2 --link test1 -d nginx #å¼€å¯ä¸€ä¸ªå®ä¾‹test2å¹¶ä¸test1å»ºç«‹é“¾æ¥</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œ<code>test2</code>ä¸<code>test1</code>ä¾¿å»ºç«‹äº†é“¾æ¥ï¼Œå°±å¯ä»¥åœ¨<code>test2</code>ä¸­ä½¿ç”¨è®¿é—®<code>test1</code>ä¸­çš„æœåŠ¡äº†ã€‚</p><p>å¦‚æœä½¿ç”¨Docker Composeï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹æƒ…å°±æ›´ç®€å•äº†ï¼Œè¿˜æ˜¯ä»¥ä¸Šé¢çš„<code>nginx</code>é•œåƒä¸ºä¾‹å­ï¼Œç¼–è¾‘<code>docker-compose.yml</code>æ–‡ä»¶ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  test2:</span><br><span class="line">    image: nginx</span><br><span class="line">    depends_on:</span><br><span class="line">      - test1</span><br><span class="line">    links:</span><br><span class="line">      - test1</span><br><span class="line">  test1:</span><br><span class="line">    image: nginx</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆæ•ˆæœä¸ä½¿ç”¨æ™®é€šçš„Dockerå‘½ä»¤<code>docker run xxxx</code>å»ºç«‹çš„é“¾æ¥å¹¶æ— åŒºåˆ«ã€‚è¿™åªæ˜¯ä¸€ç§æœ€ä¸ºç†æƒ³çš„æƒ…å†µã€‚</p><ol><li>å¦‚æœå®¹å™¨æ²¡æœ‰å®šä¹‰åœ¨åŒä¸€ä¸ª<code>docker-compose.yml</code>æ–‡ä»¶ä¸­ï¼Œåº”è¯¥å¦‚ä½•é“¾æ¥å®ƒä»¬å‘¢ï¼Ÿ</li><li>åˆå¦‚æœå®šä¹‰åœ¨<code>docker-compose.yml</code>æ–‡ä»¶ä¸­çš„å®¹å™¨éœ€è¦ä¸<code>docker run xxx</code>å¯åŠ¨çš„å®¹å™¨é“¾æ¥ï¼Œéœ€è¦å¦‚ä½•å¤„ç†ï¼Ÿ</li></ol><p>é’ˆå¯¹è¿™ä¸¤ç§å…¸å‹çš„æƒ…å†µï¼Œä¸‹é¢ç»™å‡ºæˆ‘ä¸ªäººæµ‹è¯•å¯è¡Œçš„åŠæ³•ï¼š</p><h3 id="æ–¹å¼ä¸€ï¼šè®©éœ€è¦é“¾æ¥çš„å®¹å™¨åŒå±ä¸€ä¸ªå¤–éƒ¨ç½‘ç»œ"><a href="#æ–¹å¼ä¸€ï¼šè®©éœ€è¦é“¾æ¥çš„å®¹å™¨åŒå±ä¸€ä¸ªå¤–éƒ¨ç½‘ç»œ" class="headerlink" title="æ–¹å¼ä¸€ï¼šè®©éœ€è¦é“¾æ¥çš„å®¹å™¨åŒå±ä¸€ä¸ªå¤–éƒ¨ç½‘ç»œ"></a>æ–¹å¼ä¸€ï¼šè®©éœ€è¦é“¾æ¥çš„å®¹å™¨åŒå±ä¸€ä¸ªå¤–éƒ¨ç½‘ç»œ</h3><p>æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨nginxé•œåƒæ¥æ¨¡æ‹Ÿè¿™æ ·çš„ä¸€ä¸ªæƒ…æ™¯ï¼šå‡è®¾æˆ‘ä»¬éœ€è¦å°†ä¸¤ä¸ªä½¿ç”¨Docker Composeç®¡ç†çš„nignxå®¹å™¨ï¼ˆ<code>test1</code>å’Œ<code>test2</code>ï¼‰é“¾æ¥èµ·æ¥ï¼Œä½¿å¾—<code>test2</code>èƒ½å¤Ÿè®¿é—®<code>test1</code>ä¸­æä¾›çš„æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥èƒ½pingé€šä¸ºå‡†ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰å®¹å™¨<code>test1</code>çš„<code>docker-compose.yml</code>æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  test2:</span><br><span class="line">    image: nginx</span><br><span class="line">    container_name: test1</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - app_net</span><br><span class="line">networks:</span><br><span class="line">  app_net:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure><p>å®¹å™¨<code>test2</code>å†…å®¹ä¸<code>test1</code>åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ª<code>external_links</code>,éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼š<strong>æœ€è¿‘å‘å¸ƒçš„Dockerç‰ˆæœ¬å·²ç»ä¸éœ€è¦ä½¿ç”¨external_linksæ¥é“¾æ¥å®¹å™¨ï¼Œå®¹å™¨çš„DNSæœåŠ¡å¯ä»¥æ­£ç¡®çš„ä½œå‡ºåˆ¤æ–­</strong>ï¼Œå› æ­¤å¦‚æœä½ ä½ éœ€è¦å…¼å®¹è¾ƒè€ç‰ˆæœ¬çš„Dockerçš„è¯ï¼Œé‚£ä¹ˆå®¹å™¨<code>test2</code>çš„<code>docker-compose.yml</code>æ–‡ä»¶å†…å®¹ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  test2:</span><br><span class="line">    image: nginx</span><br><span class="line">    networks:</span><br><span class="line">      - default</span><br><span class="line">      - app_net</span><br><span class="line">    external_links:</span><br><span class="line">      - test1</span><br><span class="line">    container_name: test2</span><br><span class="line">networks:</span><br><span class="line">  app_net:</span><br><span class="line">    external: true</span><br></pre></td></tr></table></figure><p>å¦åˆ™çš„è¯ï¼Œ<code>test2</code>çš„<code>docker-compose.yml</code>å’Œ<code>test1</code>çš„å®šä¹‰å®Œå…¨ä¸€è‡´ï¼Œä¸éœ€è¦é¢å¤–å¤šæŒ‡å®šä¸€ä¸ª<code>external_links</code>ã€‚ç›¸å…³çš„é—®é¢˜è¯·å‚è§stackoverflowä¸Šçš„ç›¸å…³é—®é¢˜ï¼š<a href="https://stackoverflow.com/questions/39067295/docker-compose-external-container" target="_blank" rel="noopener">docker-compose + external container</a></p><p>æ­£å¦‚ä½ çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™é‡Œä¸¤ä¸ªå®¹å™¨çš„å®šä¹‰é‡Œéƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªå¤–éƒ¨ç½‘ç»œ<code>app_net</code>,å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ä¹‹å‰é€šè¿‡ä»¥ä¸‹å‘½ä»¤å†åˆ›å»ºå¤–éƒ¨ç½‘ç»œï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create app_net</span><br></pre></td></tr></table></figure><p>ä¹‹åï¼Œé€šè¿‡<code>docker-compose up -d</code>å‘½ä»¤å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ï¼Œç„¶åæ‰§è¡Œ<code>docker exec -it test2 ping test1</code>,ä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it test2 ping test1</span><br><span class="line">PING test1 (172.18.0.2): 56 data bytes</span><br><span class="line">64 bytes from 172.18.0.2: icmp_seq=0 ttl=64 time=0.091 ms</span><br><span class="line">64 bytes from 172.18.0.2: icmp_seq=1 ttl=64 time=0.146 ms</span><br><span class="line">64 bytes from 172.18.0.2: icmp_seq=2 ttl=64 time=0.150 ms</span><br><span class="line">64 bytes from 172.18.0.2: icmp_seq=3 ttl=64 time=0.145 ms</span><br><span class="line">64 bytes from 172.18.0.2: icmp_seq=4 ttl=64 time=0.126 ms</span><br><span class="line">64 bytes from 172.18.0.2: icmp_seq=5 ttl=64 time=0.147 ms</span><br></pre></td></tr></table></figure><p>è¯æ˜è¿™ä¸¤ä¸ªå®¹å™¨æ˜¯æˆåŠŸé“¾æ¥äº†ï¼Œåè¿‡æ¥åœ¨<code>test1</code>ä¸­ping<code>test2</code>ä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸pingé€šçš„ã€‚</p><p>å¦‚æœæˆ‘ä»¬é€šè¿‡<code>docker run --rm --name test3 -d nginx</code>è¿™ç§æ–¹å¼æ¥å…ˆå¯åŠ¨äº†ä¸€ä¸ªå®¹å™¨(<code>test3</code>)å¹¶ä¸”æ²¡æœ‰æŒ‡å®šå®ƒæ‰€å±çš„å¤–éƒ¨ç½‘ç»œï¼Œè€Œéœ€è¦å°†å…¶ä¸<code>test1</code>æˆ–è€…<code>test2</code>é“¾æ¥çš„è¯ï¼Œè¿™ä¸ªæ—¶å€™æ‰‹åŠ¨é“¾æ¥å¤–éƒ¨ç½‘ç»œå³å¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network connect app_net test3</span><br></pre></td></tr></table></figure><p>è¿™æ ·ï¼Œä¸‰ä¸ªå®¹å™¨éƒ½å¯ä»¥ç›¸äº’è®¿é—®äº†ã€‚</p><h3 id="æ–¹å¼äºŒï¼šæ›´æ”¹éœ€è¦é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼"><a href="#æ–¹å¼äºŒï¼šæ›´æ”¹éœ€è¦é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼" class="headerlink" title="æ–¹å¼äºŒï¼šæ›´æ”¹éœ€è¦é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼"></a>æ–¹å¼äºŒï¼šæ›´æ”¹éœ€è¦é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼</h3><p>é€šè¿‡æ›´æ”¹ä½ æƒ³è¦ç›¸äº’é“¾æ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ä¸º<code>bridge</code>,å¹¶æŒ‡å®šéœ€è¦é“¾æ¥çš„å¤–éƒ¨å®¹å™¨ï¼ˆ<code>external_links</code>)å³å¯ã€‚ä¸åŒå±å¤–éƒ¨ç½‘ç»œçš„å®¹å™¨å¯ä»¥ç›¸äº’è®¿é—®çš„é“¾æ¥æ–¹å¼ä¸€ä¸åŒï¼Œè¿™ç§æ–¹å¼çš„è®¿é—®æ˜¯å•å‘çš„ã€‚</p><p>è¿˜æ˜¯ä»¥nginxå®¹å™¨é•œåƒä¸ºä¾‹å­ï¼Œå¦‚æœå®¹å™¨å®ä¾‹<code>nginx1</code>éœ€è¦è®¿é—®å®¹å™¨å®ä¾‹<code>nginx2</code>ï¼Œé‚£ä¹ˆ<code>nginx2</code>çš„<code>doker-compose.yml</code>å®šä¹‰ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  nginx2:</span><br><span class="line">    image: nginx</span><br><span class="line">    container_name: nginx2</span><br><span class="line">    network_mode: bridge</span><br></pre></td></tr></table></figure><p>ä¸å…¶å¯¹åº”çš„ï¼Œ<code>nginx1</code>çš„<code>docker-compose.yml</code>å®šä¹‰ä¸ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">version: &quot;3&quot;</span><br><span class="line">services:</span><br><span class="line">  nginx1:</span><br><span class="line">    image: nginx</span><br><span class="line">    external_links:</span><br><span class="line">      - nginx2</span><br><span class="line">    container_name: nginx1</span><br><span class="line">    network_mode: bridge</span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯ï¼Œè¿™é‡Œçš„<code>external_links</code>æ˜¯ä¸èƒ½çœç•¥çš„ï¼Œè€Œä¸”<code>nginx1</code>çš„å¯åŠ¨å¿…é¡»è¦åœ¨<code>nginx2</code>ä¹‹åï¼Œå¦åˆ™å¯èƒ½ä¼šæŠ¥æ‰¾ä¸åˆ°å®¹å™¨<code>nginx2</code>çš„é”™è¯¯ã€‚</p></blockquote><p>æ¥ç€æˆ‘ä»¬ä½¿ç”¨pingæ¥æµ‹è¯•ä¸‹è¿é€šæ€§ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ docker exec -it nginx1 ping nginx2  # nginx1 to nginx2</span><br><span class="line">PING nginx2 (172.17.0.4): 56 data bytes</span><br><span class="line">64 bytes from 172.17.0.4: icmp_seq=0 ttl=64 time=0.141 ms</span><br><span class="line">64 bytes from 172.17.0.4: icmp_seq=1 ttl=64 time=0.139 ms</span><br><span class="line">64 bytes from 172.17.0.4: icmp_seq=2 ttl=64 time=0.145 ms</span><br><span class="line"></span><br><span class="line">$ docker exec -it nginx2 ping nginx1 #nginx2 to nginx1</span><br><span class="line">ping: unknown host</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¹Ÿèƒ½å……åˆ†è¯æ˜è¿™ç§æ–¹å¼æ˜¯å±äºå•å‘è”é€šçš„ã€‚</p><p>åœ¨å®é™…åº”ç”¨ä¸­æ ¹æ®è‡ªå·±çš„éœ€è¦çµæ´»çš„é€‰æ‹©è¿™ä¸¤ç§é“¾æ¥æ–¹å¼ï¼Œå¦‚æœæƒ³å·æ‡’çš„è¯ï¼Œå¤§å¯é€‰æ‹©ç¬¬äºŒç§ã€‚ä¸è¿‡æˆ‘æ›´æ¨èç¬¬ä¸€ç§ï¼Œä¸éš¾çœ‹å‡ºæ— è®ºæ˜¯è”é€šæ€§è¿˜æ˜¯çµæ´»æ€§ï¼Œç¬¬ä¸€ç§éƒ½æ¯”è¾ƒå¥½ã€‚</p><p>é™„docker-compose.ymlæ–‡ä»¶è¯¦è§£</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br></pre></td><td class="code"><pre><span class="line">Composeå’ŒDockerå…¼å®¹æ€§ï¼š</span><br><span class="line">    Compose æ–‡ä»¶æ ¼å¼æœ‰3ä¸ªç‰ˆæœ¬,åˆ†åˆ«ä¸º1, 2.x å’Œ 3.x</span><br><span class="line">    ç›®å‰ä¸»æµçš„ä¸º 3.x å…¶æ”¯æŒ docker 1.13.0 åŠå…¶ä»¥ä¸Šçš„ç‰ˆæœ¬</span><br><span class="line"></span><br><span class="line">å¸¸ç”¨å‚æ•°ï¼š</span><br><span class="line">    version           # æŒ‡å®š compose æ–‡ä»¶çš„ç‰ˆæœ¬</span><br><span class="line">    services          # å®šä¹‰æ‰€æœ‰çš„ service ä¿¡æ¯, services ä¸‹é¢çš„ç¬¬ä¸€çº§åˆ«çš„ key æ˜¯ä¸€ä¸ª service çš„åç§°</span><br><span class="line"></span><br><span class="line">        build                 # æŒ‡å®šåŒ…å«æ„å»ºä¸Šä¸‹æ–‡çš„è·¯å¾„, æˆ–ä½œä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…·æœ‰ context å’ŒæŒ‡å®šçš„ dockerfile æ–‡ä»¶ä»¥åŠ args å‚æ•°å€¼</span><br><span class="line">            context               # context: æŒ‡å®š Dockerfile æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„</span><br><span class="line">            dockerfile            # dockerfile: æŒ‡å®š context æŒ‡å®šçš„ç›®å½•ä¸‹é¢çš„ Dockerfile çš„åç§°(é»˜è®¤ä¸º Dockerfile)</span><br><span class="line">            args                  # args: Dockerfile åœ¨ build è¿‡ç¨‹ä¸­éœ€è¦çš„å‚æ•° (ç­‰åŒäº docker container build --build-arg çš„ä½œç”¨)</span><br><span class="line">            cache_from            # v3.2ä¸­æ–°å¢çš„å‚æ•°, æŒ‡å®šç¼“å­˜çš„é•œåƒåˆ—è¡¨ (ç­‰åŒäº docker container build --cache_from çš„ä½œç”¨)</span><br><span class="line">            labels                # v3.3ä¸­æ–°å¢çš„å‚æ•°, è®¾ç½®é•œåƒçš„å…ƒæ•°æ® (ç­‰åŒäº docker container build --labels çš„ä½œç”¨)</span><br><span class="line">            shm_size              # v3.5ä¸­æ–°å¢çš„å‚æ•°, è®¾ç½®å®¹å™¨ /dev/shm åˆ†åŒºçš„å¤§å° (ç­‰åŒäº docker container build --shm-size çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        command               # è¦†ç›–å®¹å™¨å¯åŠ¨åé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤, æ”¯æŒ shell æ ¼å¼å’Œ [] æ ¼å¼</span><br><span class="line"></span><br><span class="line">        configs               # ä¸çŸ¥é“æ€ä¹ˆç”¨</span><br><span class="line"></span><br><span class="line">        cgroup_parent         # ä¸çŸ¥é“æ€ä¹ˆç”¨</span><br><span class="line"></span><br><span class="line">        container_name        # æŒ‡å®šå®¹å™¨çš„åç§° (ç­‰åŒäº docker run --name çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        credential_spec       # ä¸çŸ¥é“æ€ä¹ˆç”¨</span><br><span class="line"></span><br><span class="line">        deploy                # v3 ç‰ˆæœ¬ä»¥ä¸Š, æŒ‡å®šä¸éƒ¨ç½²å’Œè¿è¡ŒæœåŠ¡ç›¸å…³çš„é…ç½®, deploy éƒ¨åˆ†æ˜¯ docker stack ä½¿ç”¨çš„, docker stack ä¾èµ– docker swarm</span><br><span class="line">            endpoint_mode         # v3.3 ç‰ˆæœ¬ä¸­æ–°å¢çš„åŠŸèƒ½, æŒ‡å®šæœåŠ¡æš´éœ²çš„æ–¹å¼</span><br><span class="line">                vip                   # Docker ä¸ºè¯¥æœåŠ¡åˆ†é…äº†ä¸€ä¸ªè™šæ‹Ÿ IP(VIP), ä½œä¸ºå®¢æˆ·ç«¯çš„è®¿é—®æœåŠ¡çš„åœ°å€</span><br><span class="line">                dnsrr                 # DNSè½®è¯¢, Docker ä¸ºè¯¥æœåŠ¡è®¾ç½® DNS æ¡ç›®, ä½¿å¾—æœåŠ¡åç§°çš„ DNS æŸ¥è¯¢è¿”å›ä¸€ä¸ª IP åœ°å€åˆ—è¡¨, å®¢æˆ·ç«¯ç›´æ¥è®¿é—®å…¶ä¸­çš„ä¸€ä¸ªåœ°å€</span><br><span class="line">            labels                # æŒ‡å®šæœåŠ¡çš„æ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾ä»…åœ¨æœåŠ¡ä¸Šè®¾ç½®</span><br><span class="line">            mode                  # æŒ‡å®š deploy çš„æ¨¡å¼</span><br><span class="line">                global                # æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹éƒ½åªæœ‰ä¸€ä¸ªå®¹å™¨</span><br><span class="line">                replicated            # ç”¨æˆ·å¯ä»¥æŒ‡å®šé›†ç¾¤ä¸­å®¹å™¨çš„æ•°é‡(é»˜è®¤)</span><br><span class="line">            placement             # ä¸çŸ¥é“æ€ä¹ˆç”¨</span><br><span class="line">            replicas              # deploy çš„ mode ä¸º replicated æ—¶, æŒ‡å®šå®¹å™¨å‰¯æœ¬çš„æ•°é‡</span><br><span class="line">            resources             # èµ„æºé™åˆ¶</span><br><span class="line">                limits                # è®¾ç½®å®¹å™¨çš„èµ„æºé™åˆ¶</span><br><span class="line">                    cpus: &quot;0.5&quot;           # è®¾ç½®è¯¥å®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ 50% çš„ CPU </span><br><span class="line">                    memory: 50M           # è®¾ç½®è¯¥å®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ 50M çš„å†…å­˜ç©ºé—´ </span><br><span class="line">                reservations          # è®¾ç½®ä¸ºå®¹å™¨é¢„ç•™çš„ç³»ç»Ÿèµ„æº(éšæ—¶å¯ç”¨)</span><br><span class="line">                    cpus: &quot;0.2&quot;           # ä¸ºè¯¥å®¹å™¨ä¿ç•™ 20% çš„ CPU</span><br><span class="line">                    memory: 20M           # ä¸ºè¯¥å®¹å™¨ä¿ç•™ 20M çš„å†…å­˜ç©ºé—´</span><br><span class="line">            restart_policy        # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥, ç”¨äºä»£æ›¿ restart å‚æ•°</span><br><span class="line">                condition             # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥(æ¥å—ä¸‰ä¸ªå‚æ•°)</span><br><span class="line">                    none                  # ä¸å°è¯•é‡å¯</span><br><span class="line">                    on-failure            # åªæœ‰å½“å®¹å™¨å†…éƒ¨åº”ç”¨ç¨‹åºå‡ºç°é—®é¢˜æ‰ä¼šé‡å¯</span><br><span class="line">                    any                   # æ— è®ºå¦‚ä½•éƒ½ä¼šå°è¯•é‡å¯(é»˜è®¤)</span><br><span class="line">                delay                 # å°è¯•é‡å¯çš„é—´éš”æ—¶é—´(é»˜è®¤ä¸º 0s)</span><br><span class="line">                max_attempts          # å°è¯•é‡å¯æ¬¡æ•°(é»˜è®¤ä¸€ç›´å°è¯•é‡å¯)</span><br><span class="line">                window                # æ£€æŸ¥é‡å¯æ˜¯å¦æˆåŠŸä¹‹å‰çš„ç­‰å¾…æ—¶é—´(å³å¦‚æœå®¹å™¨å¯åŠ¨äº†, éš”å¤šå°‘ç§’ä¹‹åå»æ£€æµ‹å®¹å™¨æ˜¯å¦æ­£å¸¸, é»˜è®¤ 0s)</span><br><span class="line">            update_config         # ç”¨äºé…ç½®æ»šåŠ¨æ›´æ–°é…ç½®</span><br><span class="line">                parallelism           # ä¸€æ¬¡æ€§æ›´æ–°çš„å®¹å™¨æ•°é‡</span><br><span class="line">                delay                 # æ›´æ–°ä¸€ç»„å®¹å™¨ä¹‹é—´çš„é—´éš”æ—¶é—´</span><br><span class="line">                failure_action        # å®šä¹‰æ›´æ–°å¤±è´¥çš„ç­–ç•¥</span><br><span class="line">                    continue              # ç»§ç»­æ›´æ–°</span><br><span class="line">                    rollback              # å›æ»šæ›´æ–°</span><br><span class="line">                    pause                 # æš‚åœæ›´æ–°(é»˜è®¤)</span><br><span class="line">                monitor               # æ¯æ¬¡æ›´æ–°åçš„æŒç»­æ—¶é—´ä»¥ç›‘è§†æ›´æ–°æ˜¯å¦å¤±è´¥(å•ä½: ns|us|ms|s|m|h) (é»˜è®¤ä¸º0)</span><br><span class="line">                max_failure_ratio     # å›æ»šæœŸé—´å®¹å¿çš„å¤±è´¥ç‡(é»˜è®¤å€¼ä¸º0)</span><br><span class="line">                order                 # v3.4 ç‰ˆæœ¬ä¸­æ–°å¢çš„å‚æ•°, å›æ»šæœŸé—´çš„æ“ä½œé¡ºåº</span><br><span class="line">                    stop-first            #æ—§ä»»åŠ¡åœ¨å¯åŠ¨æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢(é»˜è®¤)</span><br><span class="line">                    start-first           #é¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡, å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚æ—¶é‡å </span><br><span class="line">            rollback_config       # v3.7 ç‰ˆæœ¬ä¸­æ–°å¢çš„å‚æ•°, ç”¨äºå®šä¹‰åœ¨ update_config æ›´æ–°å¤±è´¥çš„å›æ»šç­–ç•¥</span><br><span class="line">                parallelism           # ä¸€æ¬¡å›æ»šçš„å®¹å™¨æ•°, å¦‚æœè®¾ç½®ä¸º0, åˆ™æ‰€æœ‰å®¹å™¨åŒæ—¶å›æ»š</span><br><span class="line">                delay                 # æ¯ä¸ªç»„å›æ»šä¹‹é—´çš„æ—¶é—´é—´éš”(é»˜è®¤ä¸º0)</span><br><span class="line">                failure_action        # å®šä¹‰å›æ»šå¤±è´¥çš„ç­–ç•¥</span><br><span class="line">                    continue              # ç»§ç»­å›æ»š</span><br><span class="line">                    pause                 # æš‚åœå›æ»š</span><br><span class="line">                monitor               # æ¯æ¬¡å›æ»šä»»åŠ¡åçš„æŒç»­æ—¶é—´ä»¥ç›‘è§†å¤±è´¥(å•ä½: ns|us|ms|s|m|h) (é»˜è®¤ä¸º0)</span><br><span class="line">                max_failure_ratio     # å›æ»šæœŸé—´å®¹å¿çš„å¤±è´¥ç‡(é»˜è®¤å€¼0)</span><br><span class="line">                order                 # å›æ»šæœŸé—´çš„æ“ä½œé¡ºåº</span><br><span class="line">                    stop-first            # æ—§ä»»åŠ¡åœ¨å¯åŠ¨æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢(é»˜è®¤)</span><br><span class="line">                    start-first           # é¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡, å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚æ—¶é‡å </span><br><span class="line"></span><br><span class="line">            æ³¨æ„ï¼š</span><br><span class="line">                æ”¯æŒ docker-compose up å’Œ docker-compose run ä½†ä¸æ”¯æŒ docker stack deploy çš„å­é€‰é¡¹</span><br><span class="line">                security_opt  container_name  devices  tmpfs  stop_signal  links    cgroup_parent</span><br><span class="line">                network_mode  external_links  restart  build  userns_mode  sysctls</span><br><span class="line"></span><br><span class="line">        devices               # æŒ‡å®šè®¾å¤‡æ˜ å°„åˆ—è¡¨ (ç­‰åŒäº docker run --device çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        depends_on            # å®šä¹‰å®¹å™¨å¯åŠ¨é¡ºåº (æ­¤é€‰é¡¹è§£å†³äº†å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œ æ­¤é€‰é¡¹åœ¨ v3 ç‰ˆæœ¬ä¸­ ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line">            ç¤ºä¾‹ï¼š</span><br><span class="line">                docker-compose up ä»¥ä¾èµ–é¡ºåºå¯åŠ¨æœåŠ¡ï¼Œä¸‹é¢ä¾‹å­ä¸­ redis å’Œ db æœåŠ¡åœ¨ web å¯åŠ¨å‰å¯åŠ¨</span><br><span class="line">                é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ docker-compose up web è¿™æ ·çš„æ–¹å¼å¯åŠ¨ web æœåŠ¡æ—¶ï¼Œä¹Ÿä¼šå¯åŠ¨ redis å’Œ db ä¸¤ä¸ªæœåŠ¡ï¼Œå› ä¸ºåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†ä¾èµ–å…³ç³»</span><br><span class="line">                version: &apos;3&apos;</span><br><span class="line">                services:</span><br><span class="line">                    web:</span><br><span class="line">                        build: .</span><br><span class="line">                        depends_on:</span><br><span class="line">                            - db      </span><br><span class="line">                            - redis  </span><br><span class="line">                    redis:</span><br><span class="line">                        image: redis</span><br><span class="line">                    db:</span><br><span class="line">                        image: postgres                             </span><br><span class="line"></span><br><span class="line">        dns                   # è®¾ç½® DNS åœ°å€(ç­‰åŒäº docker run --dns çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        dns_search            # è®¾ç½® DNS æœç´¢åŸŸ(ç­‰åŒäº docker run --dns-search çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        tmpfs                 # v2 ç‰ˆæœ¬ä»¥ä¸Š, æŒ‚è½½ç›®å½•åˆ°å®¹å™¨ä¸­, ä½œä¸ºå®¹å™¨çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ(ç­‰åŒäº docker run --tmpfs çš„ä½œç”¨, åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        entrypoint            # è¦†ç›–å®¹å™¨çš„é»˜è®¤ entrypoint æŒ‡ä»¤ (ç­‰åŒäº docker run --entrypoint çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        env_file              # ä»æŒ‡å®šæ–‡ä»¶ä¸­è¯»å–å˜é‡è®¾ç½®ä¸ºå®¹å™¨ä¸­çš„ç¯å¢ƒå˜é‡, å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–è€…ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨, å¦‚æœå¤šä¸ªæ–‡ä»¶ä¸­çš„å˜é‡é‡ååˆ™åé¢çš„å˜é‡è¦†ç›–å‰é¢çš„å˜é‡, environment çš„å€¼è¦†ç›– env_file çš„å€¼</span><br><span class="line">            æ–‡ä»¶æ ¼å¼ï¼š</span><br><span class="line">                RACK_ENV=development </span><br><span class="line"></span><br><span class="line">        environment           # è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œ environment çš„å€¼å¯ä»¥è¦†ç›– env_file çš„å€¼ (ç­‰åŒäº docker run --env çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        expose                # æš´éœ²ç«¯å£, ä½†æ˜¯ä¸èƒ½å’Œå®¿ä¸»æœºå»ºç«‹æ˜ å°„å…³ç³», ç±»ä¼¼äº Dockerfile çš„ EXPOSE æŒ‡ä»¤</span><br><span class="line"></span><br><span class="line">        external_links        # è¿æ¥ä¸åœ¨ docker-compose.yml ä¸­å®šä¹‰çš„å®¹å™¨æˆ–è€…ä¸åœ¨ compose ç®¡ç†çš„å®¹å™¨(docker run å¯åŠ¨çš„å®¹å™¨, åœ¨ v3 ç‰ˆæœ¬ä¸­ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        extra_hosts           # æ·»åŠ  host è®°å½•åˆ°å®¹å™¨ä¸­çš„ /etc/hosts ä¸­ (ç­‰åŒäº docker run --add-host çš„ä½œç”¨)</span><br><span class="line"></span><br><span class="line">        healthcheck           # v2.1 ä»¥ä¸Šç‰ˆæœ¬, å®šä¹‰å®¹å™¨å¥åº·çŠ¶æ€æ£€æŸ¥, ç±»ä¼¼äº Dockerfile çš„ HEALTHCHECK æŒ‡ä»¤</span><br><span class="line">            test                  # æ£€æŸ¥å®¹å™¨æ£€æŸ¥çŠ¶æ€çš„å‘½ä»¤, è¯¥é€‰é¡¹å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…åˆ—è¡¨, ç¬¬ä¸€é¡¹å¿…é¡»æ˜¯ NONE, CMD æˆ– CMD-SHELL, å¦‚æœå…¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ™ç›¸å½“äº CMD-SHELL åŠ è¯¥å­—ç¬¦ä¸²</span><br><span class="line">                NONE                  # ç¦ç”¨å®¹å™¨çš„å¥åº·çŠ¶æ€æ£€æµ‹</span><br><span class="line">                CMD                   # test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;]</span><br><span class="line">                CMD-SHELL             # test: [&quot;CMD-SHELL&quot;, &quot;curl -f http://localhost || exit 1&quot;] æˆ–è€…ã€€test: curl -f https://localhost || exit 1</span><br><span class="line">            interval: 1m30s       # æ¯æ¬¡æ£€æŸ¥ä¹‹é—´çš„é—´éš”æ—¶é—´</span><br><span class="line">            timeout: 10s          # è¿è¡Œå‘½ä»¤çš„è¶…æ—¶æ—¶é—´</span><br><span class="line">            retries: 3            # é‡è¯•æ¬¡æ•°</span><br><span class="line">            start_period: 40s     # v3.4 ä»¥ä¸Šæ–°å¢çš„é€‰é¡¹, å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶é—´é—´éš”</span><br><span class="line">            disable: true         # true æˆ– false, è¡¨ç¤ºæ˜¯å¦ç¦ç”¨å¥åº·çŠ¶æ€æ£€æµ‹å’Œã€€test: NONE ç›¸åŒ</span><br><span class="line"></span><br><span class="line">        image                 # æŒ‡å®š docker é•œåƒ, å¯ä»¥æ˜¯è¿œç¨‹ä»“åº“é•œåƒã€æœ¬åœ°é•œåƒ</span><br><span class="line"></span><br><span class="line">        init                  # v3.7 ä¸­æ–°å¢çš„å‚æ•°, true æˆ– false è¡¨ç¤ºæ˜¯å¦åœ¨å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ª init, å®ƒæ¥æ”¶ä¿¡å·å¹¶ä¼ é€’ç»™è¿›ç¨‹</span><br><span class="line"></span><br><span class="line">        isolation             # éš”ç¦»å®¹å™¨æŠ€æœ¯, åœ¨ Linux ä¸­ä»…æ”¯æŒ default å€¼</span><br><span class="line"></span><br><span class="line">        labels                # ä½¿ç”¨ Docker æ ‡ç­¾å°†å…ƒæ•°æ®æ·»åŠ åˆ°å®¹å™¨, ä¸ Dockerfile ä¸­çš„ LABELS ç±»ä¼¼</span><br><span class="line"></span><br><span class="line">        links                 # é“¾æ¥åˆ°å…¶å®ƒæœåŠ¡ä¸­çš„å®¹å™¨, è¯¥é€‰é¡¹æ˜¯ docker å†å²é—ç•™çš„é€‰é¡¹, ç›®å‰å·²è¢«ç”¨æˆ·è‡ªå®šä¹‰ç½‘ç»œåç§°ç©ºé—´å–ä»£, æœ€ç»ˆæœ‰å¯èƒ½è¢«åºŸå¼ƒ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        logging               # è®¾ç½®å®¹å™¨æ—¥å¿—æœåŠ¡</span><br><span class="line">            driver                # æŒ‡å®šæ—¥å¿—è®°å½•é©±åŠ¨ç¨‹åº, é»˜è®¤ json-file (ç­‰åŒäº docker run --log-driver çš„ä½œç”¨)</span><br><span class="line">            options               # æŒ‡å®šæ—¥å¿—çš„ç›¸å…³å‚æ•° (ç­‰åŒäº docker run --log-opt çš„ä½œç”¨)</span><br><span class="line">                max-size              # è®¾ç½®å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°, å½“åˆ°è¾¾è¿™ä¸ªå€¼åä¼šè¿›è¡Œæ—¥å¿—æ»šåŠ¨æ“ä½œ</span><br><span class="line">                max-file              # æ—¥å¿—æ–‡ä»¶ä¿ç•™çš„æ•°é‡</span><br><span class="line"></span><br><span class="line">        network_mode          # æŒ‡å®šç½‘ç»œæ¨¡å¼ (ç­‰åŒäº docker run --net çš„ä½œç”¨, åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)         </span><br><span class="line"></span><br><span class="line">        networks              # å°†å®¹å™¨åŠ å…¥æŒ‡å®šç½‘ç»œ (ç­‰åŒäº docker network connect çš„ä½œç”¨), networks å¯ä»¥ä½äº compose æ–‡ä»¶é¡¶çº§é”®å’Œ services é”®çš„äºŒçº§é”®</span><br><span class="line">            aliases               # åŒä¸€ç½‘ç»œä¸Šçš„å®¹å™¨å¯ä»¥ä½¿ç”¨æœåŠ¡åç§°æˆ–åˆ«åè¿æ¥åˆ°å…¶ä¸­ä¸€ä¸ªæœåŠ¡çš„å®¹å™¨</span><br><span class="line">            ipv4_address      # IP V4 æ ¼å¼</span><br><span class="line">            ipv6_address      # IP V6 æ ¼å¼</span><br><span class="line"></span><br><span class="line">            ç¤ºä¾‹:</span><br><span class="line">                version: &apos;3.7&apos;</span><br><span class="line">                services: </span><br><span class="line">                    test: </span><br><span class="line">                        image: nginx:1.14-alpine</span><br><span class="line">                        container_name: mynginx</span><br><span class="line">                        command: ifconfig</span><br><span class="line">                        networks: </span><br><span class="line">                            app_net:                                # è°ƒç”¨ä¸‹é¢ networks å®šä¹‰çš„ app_net ç½‘ç»œ</span><br><span class="line">                            ipv4_address: 172.16.238.10</span><br><span class="line">                networks:</span><br><span class="line">                    app_net:</span><br><span class="line">                        driver: bridge</span><br><span class="line">                        ipam:</span><br><span class="line">                            driver: default</span><br><span class="line">                            config:</span><br><span class="line">                                - subnet: 172.16.238.0/24</span><br><span class="line"></span><br><span class="line">        pid: &apos;host&apos;           # å…±äº«å®¿ä¸»æœºçš„ è¿›ç¨‹ç©ºé—´(PID)</span><br><span class="line"></span><br><span class="line">        ports                 # å»ºç«‹å®¿ä¸»æœºå’Œå®¹å™¨ä¹‹é—´çš„ç«¯å£æ˜ å°„å…³ç³», ports æ”¯æŒä¸¤ç§è¯­æ³•æ ¼å¼</span><br><span class="line">            SHORT è¯­æ³•æ ¼å¼ç¤ºä¾‹:</span><br><span class="line">                - &quot;3000&quot;                            # æš´éœ²å®¹å™¨çš„ 3000 ç«¯å£, å®¿ä¸»æœºçš„ç«¯å£ç”± docker éšæœºæ˜ å°„ä¸€ä¸ªæ²¡æœ‰è¢«å ç”¨çš„ç«¯å£</span><br><span class="line">                - &quot;3000-3005&quot;                       # æš´éœ²å®¹å™¨çš„ 3000 åˆ° 3005 ç«¯å£, å®¿ä¸»æœºçš„ç«¯å£ç”± docker éšæœºæ˜ å°„æ²¡æœ‰è¢«å ç”¨çš„ç«¯å£</span><br><span class="line">                - &quot;8000:8000&quot;                       # å®¹å™¨çš„ 8000 ç«¯å£å’Œå®¿ä¸»æœºçš„ 8000 ç«¯å£å»ºç«‹æ˜ å°„å…³ç³»</span><br><span class="line">                - &quot;9090-9091:8080-8081&quot;</span><br><span class="line">                - &quot;127.0.0.1:8001:8001&quot;             # æŒ‡å®šæ˜ å°„å®¿ä¸»æœºçš„æŒ‡å®šåœ°å€çš„</span><br><span class="line">                - &quot;127.0.0.1:5000-5010:5000-5010&quot;   </span><br><span class="line">                - &quot;6060:6060/udp&quot;                   # æŒ‡å®šåè®®</span><br><span class="line"></span><br><span class="line">            LONG è¯­æ³•æ ¼å¼ç¤ºä¾‹:(v3.2 æ–°å¢çš„è¯­æ³•æ ¼å¼)</span><br><span class="line">                ports:</span><br><span class="line">                    - target: 80                    # å®¹å™¨ç«¯å£</span><br><span class="line">                      published: 8080               # å®¿ä¸»æœºç«¯å£</span><br><span class="line">                      protocol: tcp                 # åè®®ç±»å‹</span><br><span class="line">                      mode: host                    # host åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå‘å¸ƒä¸»æœºç«¯å£,  ingress å¯¹äºç¾¤æ¨¡å¼ç«¯å£è¿›è¡Œè´Ÿè½½å‡è¡¡</span><br><span class="line"></span><br><span class="line">        secrets               # ä¸çŸ¥é“æ€ä¹ˆç”¨</span><br><span class="line"></span><br><span class="line">        security_opt          # ä¸ºæ¯ä¸ªå®¹å™¨è¦†ç›–é»˜è®¤çš„æ ‡ç­¾ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        stop_grace_period     # æŒ‡å®šåœ¨å‘é€äº† SIGTERM ä¿¡å·ä¹‹å, å®¹å™¨ç­‰å¾…å¤šå°‘ç§’ä¹‹åé€€å‡º(é»˜è®¤ 10s)</span><br><span class="line"></span><br><span class="line">        stop_signal           # æŒ‡å®šåœæ­¢å®¹å™¨å‘é€çš„ä¿¡å· (é»˜è®¤ä¸º SIGTERM ç›¸å½“äº kill PID; SIGKILL ç›¸å½“äº kill -9 PID; åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        sysctls               # è®¾ç½®å®¹å™¨ä¸­çš„å†…æ ¸å‚æ•° (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        ulimits               # è®¾ç½®å®¹å™¨çš„ limit</span><br><span class="line"></span><br><span class="line">        userns_mode           # å¦‚æœDockerå®ˆæŠ¤ç¨‹åºé…ç½®äº†ç”¨æˆ·åç§°ç©ºé—´, åˆ™ç¦ç”¨æ­¤æœåŠ¡çš„ç”¨æˆ·åç§°ç©ºé—´ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹)</span><br><span class="line"></span><br><span class="line">        volumes               # å®šä¹‰å®¹å™¨å’Œå®¿ä¸»æœºçš„å·æ˜ å°„å…³ç³», å…¶å’Œ networks ä¸€æ ·å¯ä»¥ä½äº services é”®çš„äºŒçº§é”®å’Œ compose é¡¶çº§é”®, å¦‚æœéœ€è¦è·¨æœåŠ¡é—´ä½¿ç”¨åˆ™åœ¨é¡¶çº§é”®å®šä¹‰, åœ¨ services ä¸­å¼•ç”¨</span><br><span class="line">            SHORT è¯­æ³•æ ¼å¼ç¤ºä¾‹:</span><br><span class="line">                volumes:</span><br><span class="line">                    - /var/lib/mysql                # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœºçš„ä¸€ä¸ªéšæœºç›®å½•ä¸­</span><br><span class="line">                    - /opt/data:/var/lib/mysql      # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœºçš„ /opt/data</span><br><span class="line">                    - ./cache:/tmp/cache            # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœº compose æ–‡ä»¶æ‰€åœ¨çš„ä½ç½®</span><br><span class="line">                    - ~/configs:/etc/configs/:ro    # æ˜ å°„å®¹å™¨å®¿ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­å», æƒé™åªè¯»</span><br><span class="line">                    - datavolume:/var/lib/mysql     # datavolume ä¸º volumes é¡¶çº§é”®å®šä¹‰çš„ç›®å½•, åœ¨æ­¤å¤„ç›´æ¥è°ƒç”¨</span><br><span class="line"></span><br><span class="line">            LONG è¯­æ³•æ ¼å¼ç¤ºä¾‹:(v3.2 æ–°å¢çš„è¯­æ³•æ ¼å¼)</span><br><span class="line">                version: &quot;3.2&quot;</span><br><span class="line">                services:</span><br><span class="line">                    web:</span><br><span class="line">                        image: nginx:alpine</span><br><span class="line">                        ports:</span><br><span class="line">                            - &quot;80:80&quot;</span><br><span class="line">                        volumes:</span><br><span class="line">                            - type: volume                  # mount çš„ç±»å‹, å¿…é¡»æ˜¯ bindã€volume æˆ– tmpfs</span><br><span class="line">                                source: mydata              # å®¿ä¸»æœºç›®å½•</span><br><span class="line">                                target: /data               # å®¹å™¨ç›®å½•</span><br><span class="line">                                volume:                     # é…ç½®é¢å¤–çš„é€‰é¡¹, å…¶ key å¿…é¡»å’Œ type çš„å€¼ç›¸åŒ</span><br><span class="line">                                    nocopy: true                # volume é¢å¤–çš„é€‰é¡¹, åœ¨åˆ›å»ºå·æ—¶ç¦ç”¨ä»å®¹å™¨å¤åˆ¶æ•°æ®</span><br><span class="line">                            - type: bind                    # volume æ¨¡å¼åªæŒ‡å®šå®¹å™¨è·¯å¾„å³å¯, å®¿ä¸»æœºè·¯å¾„éšæœºç”Ÿæˆ; bind éœ€è¦æŒ‡å®šå®¹å™¨å’Œæ•°æ®æœºçš„æ˜ å°„è·¯å¾„</span><br><span class="line">                                source: ./static</span><br><span class="line">                                target: /opt/app/static</span><br><span class="line">                                read_only: true             # è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸ºåªè¯»æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="line">                volumes:</span><br><span class="line">                    mydata:                                 # å®šä¹‰åœ¨ volume, å¯åœ¨æ‰€æœ‰æœåŠ¡ä¸­è°ƒç”¨</span><br><span class="line"></span><br><span class="line">        restart               # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥(åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹, åœ¨ swarm ä½¿ç”¨ restart_policy ä»£æ›¿ restart)</span><br><span class="line">            no                    # ç¦æ­¢è‡ªåŠ¨é‡å¯å®¹å™¨(é»˜è®¤)</span><br><span class="line">            always                # æ— è®ºå¦‚ä½•å®¹å™¨éƒ½ä¼šé‡å¯</span><br><span class="line">            on-failure            # å½“å‡ºç° on-failure æŠ¥é”™æ—¶, å®¹å™¨é‡æ–°å¯åŠ¨</span><br><span class="line"></span><br><span class="line">        å…¶ä»–é€‰é¡¹ï¼š</span><br><span class="line">            domainname, hostname, ipc, mac_address, privileged, read_only, shm_size, stdin_open, tty, user, working_dir</span><br><span class="line">            ä¸Šé¢è¿™äº›é€‰é¡¹éƒ½åªæ¥å—å•ä¸ªå€¼å’Œ docker run çš„å¯¹åº”å‚æ•°ç±»ä¼¼</span><br><span class="line"></span><br><span class="line">        å¯¹äºå€¼ä¸ºæ—¶é—´çš„å¯æ¥å—çš„å€¼ï¼š</span><br><span class="line">            2.5s</span><br><span class="line">            10s</span><br><span class="line">            1m30s</span><br><span class="line">            2h32m</span><br><span class="line">            5h34m56s</span><br><span class="line">            æ—¶é—´å•ä½: us, ms, s, mï¼Œ h</span><br><span class="line">        å¯¹äºå€¼ä¸ºå¤§å°çš„å¯æ¥å—çš„å€¼ï¼š</span><br><span class="line">            2b</span><br><span class="line">            1024kb</span><br><span class="line">            2048k</span><br><span class="line">            300m</span><br><span class="line">            1gb</span><br><span class="line">            å•ä½: b, k, m, g æˆ–è€… kb, mb, gb</span><br><span class="line">    networks          # å®šä¹‰ networks ä¿¡æ¯</span><br><span class="line">        driver                # æŒ‡å®šç½‘ç»œæ¨¡å¼, å¤§å¤šæ•°æƒ…å†µä¸‹, å®ƒ bridge äºå•ä¸ªä¸»æœºå’Œ overlay Swarm ä¸Š</span><br><span class="line">            bridge                # Docker é»˜è®¤ä½¿ç”¨ bridge è¿æ¥å•ä¸ªä¸»æœºä¸Šçš„ç½‘ç»œ</span><br><span class="line">            overlay               # overlay é©±åŠ¨ç¨‹åºåˆ›å»ºä¸€ä¸ªè·¨å¤šä¸ªèŠ‚ç‚¹å‘½åçš„ç½‘ç»œ</span><br><span class="line">            host                  # å…±äº«ä¸»æœºç½‘ç»œåç§°ç©ºé—´(ç­‰åŒäº docker run --net=host)</span><br><span class="line">            none                  # ç­‰åŒäº docker run --net=none</span><br><span class="line">        driver_opts           # v3.2ä»¥ä¸Šç‰ˆæœ¬, ä¼ é€’ç»™é©±åŠ¨ç¨‹åºçš„å‚æ•°, è¿™äº›å‚æ•°å–å†³äºé©±åŠ¨ç¨‹åº</span><br><span class="line">        attachable            # driver ä¸º overlay æ—¶ä½¿ç”¨, å¦‚æœè®¾ç½®ä¸º true åˆ™é™¤äº†æœåŠ¡ä¹‹å¤–ï¼Œç‹¬ç«‹å®¹å™¨ä¹Ÿå¯ä»¥é™„åŠ åˆ°è¯¥ç½‘ç»œ; å¦‚æœç‹¬ç«‹å®¹å™¨è¿æ¥åˆ°è¯¥ç½‘ç»œï¼Œåˆ™å®ƒå¯ä»¥ä¸å…¶ä»– Docker å®ˆæŠ¤è¿›ç¨‹è¿æ¥åˆ°çš„è¯¥ç½‘ç»œçš„æœåŠ¡å’Œç‹¬ç«‹å®¹å™¨è¿›è¡Œé€šä¿¡</span><br><span class="line">        ipam                  # è‡ªå®šä¹‰ IPAM é…ç½®. è¿™æ˜¯ä¸€ä¸ªå…·æœ‰å¤šä¸ªå±æ€§çš„å¯¹è±¡, æ¯ä¸ªå±æ€§éƒ½æ˜¯å¯é€‰çš„</span><br><span class="line">            driver                # IPAM é©±åŠ¨ç¨‹åº, bridge æˆ–è€… default</span><br><span class="line">            config                # é…ç½®é¡¹</span><br><span class="line">                subnet                # CIDRæ ¼å¼çš„å­ç½‘ï¼Œè¡¨ç¤ºè¯¥ç½‘ç»œçš„ç½‘æ®µ</span><br><span class="line">        external              # å¤–éƒ¨ç½‘ç»œ, å¦‚æœè®¾ç½®ä¸º true åˆ™ docker-compose up ä¸ä¼šå°è¯•åˆ›å»ºå®ƒ, å¦‚æœå®ƒä¸å­˜åœ¨åˆ™å¼•å‘é”™è¯¯</span><br><span class="line">        name                  # v3.5 ä»¥ä¸Šç‰ˆæœ¬, ä¸ºæ­¤ç½‘ç»œè®¾ç½®åç§°</span><br><span class="line">æ–‡ä»¶æ ¼å¼ç¤ºä¾‹ï¼š</span><br><span class="line">    version: &quot;3&quot;</span><br><span class="line">    services:</span><br><span class="line">      redis:</span><br><span class="line">        image: redis:alpine</span><br><span class="line">        ports:</span><br><span class="line">          - &quot;6379&quot;</span><br><span class="line">        networks:</span><br><span class="line">          - frontend</span><br><span class="line">        deploy:</span><br><span class="line">          replicas: 2</span><br><span class="line">          update_config:</span><br><span class="line">            parallelism: 2</span><br><span class="line">            delay: 10s</span><br><span class="line">          restart_policy:</span><br><span class="line">            condition: on-failure</span><br><span class="line">      db:</span><br><span class="line">        image: postgres:9.4</span><br><span class="line">        volumes:</span><br><span class="line">          - db-data:/var/lib/postgresql/data</span><br><span class="line">        networks:</span><br><span class="line">          - backend</span><br><span class="line">        deploy:</span><br><span class="line">          placement:</span><br><span class="line">            constraints: [node.role == manager]</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      Docker compose ç½‘ç»œè®¾ç½®ä»¥æ‰“é€šåŒä¸€å®¿ä¸»æœºçš„å¤šä¸ªå®¹å™¨
    
    </summary>
    
      <category term="Docker" scheme="https://cloudsjhan.github.io/categories/Docker/"/>
    
    
      <category term="Docker" scheme="https://cloudsjhan.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>python withçš„åŸç†åŠåœ¨å¼‚å¸¸å¤„ç†ä¸­çš„åº”ç”¨</title>
    <link href="https://cloudsjhan.github.io/2019/09/11/python-with%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%9C%A8%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/"/>
    <id>https://cloudsjhan.github.io/2019/09/11/python-withçš„åŸç†åŠåœ¨å¼‚å¸¸å¤„ç†ä¸­çš„åº”ç”¨/</id>
    <published>2019-09-11T03:37:54.000Z</published>
    <updated>2019-09-11T03:39:08.498Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><p>åªè¦å¯¹è±¡å†…å®ç° <strong>enter</strong>() å’Œ <strong>exit</strong>() æ–¹æ³•ï¼Œå°±èƒ½å…¼å®¹ with è¯­å¥ï¼Œè§¦å‘ä¸Šä¸‹æ–‡ç®¡ç†ã€‚ </p><p>ä¸€ã€ä¸Šä¸‹æ–‡ç®¡ç†çš„ç®€å•æ‰§è¡Œæµç¨‹<br>with å·¥ä½œåŸç† ï¼ˆï¼‘ï¼‰ç´§è·Ÿwithåé¢çš„è¯­å¥è¢«æ±‚å€¼åï¼Œè¿”å›å¯¹è±¡çš„â€œ<strong>enter</strong>()â€æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼å°†è¢«èµ‹å€¼ç»™asåé¢çš„å˜é‡ï¼› ï¼ˆï¼’ï¼‰å½“withåé¢çš„ä»£ç å—å…¨éƒ¨è¢«æ‰§è¡Œå®Œä¹‹åï¼Œå°†è°ƒç”¨å‰é¢è¿”å›å¯¹è±¡çš„â€œ<strong>exit</strong>()â€æ–¹æ³•ã€‚</p><p>class Sample:<br>    def <strong>enter</strong>(self):<br>        print â€œin <strong>enter</strong>â€œ<br>        return â€œFooâ€<br>    def <strong>exit</strong>(self, exc_type, exc_val, exc_tb):<br>        â€˜â€™â€™<br>        è‹¥åœ¨æ‰§è¡Œæµç¨‹ä¸­å› ä¸ºé”™è¯¯è€Œé€€å‡ºï¼Œè°ƒç”¨exitæ—¶ï¼Œä¼šè‡ªåŠ¨æ•è·é”™è¯¯ä¿¡æ¯<br>        exc_typeï¼šã€€é”™è¯¯çš„ç±»å‹(å¼‚å¸¸ç±»å‹)<br>        exc_valï¼šã€€é”™è¯¯ç±»å‹å¯¹åº”çš„å€¼ (å¼‚å¸¸å€¼)<br>        exc_tbï¼šã€€ä»£ç ä¸­é”™è¯¯å‘ç”Ÿçš„ä½ç½® (é”™è¯¯æ ˆ)<br>        â€˜â€™â€™<br>        print â€œin <strong>exit</strong>â€œ</p><p>def get_sample():<br>    return Sample()</p><p>with get_sample() as sample:<br>    print â€œSample: â€œ, sample<br>â€˜â€™â€™<br>æµç¨‹æ€»ç»“ï¼š<br>1- æ‰§è¡Œget_sample()å‡½æ•°<br>2- å‡½æ•°å†…å®ä¾‹åŒ–Sampleå¯¹è±¡ï¼Œæ‰§è¡Œ<strong>enter</strong>è¿”å›å­—ç¬¦ä¸²èµ‹äºˆsampleå˜é‡<br>3- æ‰§è¡Œwithå†…çš„ä»£ç å—ï¼Œè¾“å‡ºsampleå˜é‡å€¼<br>4- æ‰§è¡ŒSampleå¯¹è±¡å†…çš„<strong>exit</strong>æ–¹æ³•<br>â€˜â€™â€™<br>äºŒã€é”™è¯¯æ‰§è¡Œæµç¨‹<br>class Sample():<br>    def <strong>enter</strong>(self):<br>        print(â€˜in enterâ€™)<br>        return self</p><pre><code>def __exit__(self, exc_type, exc_val, exc_tb):    print &quot;type: &quot;, exc_type    print &quot;val: &quot;, exc_val    print &quot;tb: &quot;, exc_tbdef do_something(self):    bar = 1 / 0    return bar + 10</code></pre><p>with Sample() as sample:<br>    sample.do_something()</p><p>â€˜â€™â€™<br>in enter<br>Traceback (most recent call last):<br>type:  <type 'exceptions.zerodivisionerror'=""><br>val:  integer division or modulo by zero<br>  File â€œ/home/user/cltdevelop/Code/TF_Practice_2017_06_06/with_test.pyâ€, line 36, in <module><br>tb:  <traceback object="" at="" 0x7f9e13fc6050=""><br>    sample.do_something()<br>  File â€œ/home/user/cltdevelop/Code/TF_Practice_2017_06_06/with_test.pyâ€, line 32, in do_something<br>    bar = 1 / 0<br>ZeroDivisionError: integer division or modulo by zero</traceback></module></type></p><p>Process finished with exit code 1</p><p>â€˜â€™â€™<br>ä¸‰ã€å¼‚å¸¸å¤„ç† with åº”ç”¨<br>å¼‚å¸¸å¤„ç†é€»è¾‘å¤ªå¤šï¼Œä»¥è‡³äºæ‰°ä¹±äº†ä»£ç æ ¸å¿ƒé€»è¾‘ã€‚å…·ä½“è¡¨ç°å°±æ˜¯ï¼Œä»£ç é‡Œå……æ–¥ç€å¤§é‡çš„ tryã€exceptã€raise è¯­å¥ï¼Œè®©æ ¸å¿ƒé€»è¾‘å˜å¾—éš¾ä»¥è¾¨è¯†ã€‚</p><p>def upload_avatar(request):<br>    â€œâ€â€ç”¨æˆ·ä¸Šä¼ æ–°å¤´åƒâ€â€â€<br>    try:<br>        avatar_file = request.FILES[â€˜avatarâ€™]<br>    except KeyError:<br>        raise error_codes.AVATAR_FILE_NOT_PROVIDED</p><pre><code>try:   resized_avatar_file = resize_avatar(avatar_file)except FileTooLargeError as e:    raise error_codes.AVATAR_FILE_TOO_LARGEexcept ResizeAvatarError as e:    raise error_codes.AVATAR_FILE_INVALIDtry:    request.user.avatar = resized_avatar_file    request.user.save()except Exception:    raise error_codes.INTERNAL_SERVER_ERRORreturn HttpResponse({})</code></pre><p>è¿™æ˜¯ä¸€ä¸ªå¤„ç†ç”¨æˆ·ä¸Šä¼ å¤´åƒçš„è§†å›¾å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å†…åšäº†ä¸‰ä»¶äº‹æƒ…ï¼Œå¹¶ä¸”é’ˆå¯¹æ¯ä»¶äº‹éƒ½åšäº†å¼‚å¸¸æ•è·ã€‚å¦‚æœåšæŸä»¶äº‹æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå°±è¿”å›å¯¹ç”¨æˆ·å‹å¥½çš„é”™è¯¯åˆ°å‰ç«¯ã€‚</p><p>è¿™æ ·çš„å¤„ç†æµç¨‹çºµç„¶åˆç†ï¼Œä½†æ˜¯æ˜¾ç„¶ä»£ç é‡Œçš„å¼‚å¸¸å¤„ç†é€»è¾‘æœ‰ç‚¹â€œå–§å®¾å¤ºä¸»â€äº†ã€‚ä¸€çœ¼çœ‹è¿‡å»å…¨æ˜¯ä»£ç ç¼©è¿›ï¼Œå¾ˆéš¾æç‚¼å‡ºä»£ç çš„æ ¸å¿ƒé€»è¾‘ã€‚</p><p>æ—©åœ¨ 2.5 ç‰ˆæœ¬æ—¶ï¼ŒPython è¯­è¨€å°±å·²ç»æä¾›äº†å¯¹ä»˜è¿™ç±»åœºæ™¯çš„å·¥å…·ï¼šâ€œä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆcontext managerï¼‰â€ã€‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ˜¯ä¸€ç§é…åˆ with è¯­å¥ä½¿ç”¨çš„ç‰¹æ®Š Python å¯¹è±¡ï¼Œé€šè¿‡å®ƒï¼Œå¯ä»¥è®©å¼‚å¸¸å¤„ç†å·¥ä½œå˜å¾—æ›´æ–¹ä¾¿ã€‚</p><p>class raise_api_error:<br>    â€œâ€â€<br>    captures specified exception and raise ApiErrorCode instead<br>    æ•è·æŒ‡å®šçš„å¼‚å¸¸å¹¶æ”¹ä¸ºå¼•å‘ApiErrorCode<br>    :raises: AttributeError if code_name is not valid<br>    â€œâ€â€<br>    def <strong>init</strong>(self, captures, code_name):<br>        self.captures = captures<br>        self.code = getattr(error_codes, code_name)</p><pre><code>def __enter__(self):    # åˆšæ–¹æ³•å°†åœ¨è¿›å…¥ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨    return selfdef __exit__(self, exc_type, exc_val, exc_tb):    # è¯¥æ–¹æ³•å°†åœ¨é€€å‡ºä¸Šä¸‹æ–‡æ—¶è°ƒç”¨    # exc_type, exc_val, exc_tb åˆ†åˆ«è¡¨ç¤ºè¯¥ä¸Šä¸‹æ–‡å†…æŠ›å‡ºçš„    # å¼‚å¸¸ç±»å‹ã€å¼‚å¸¸å€¼ã€é”™è¯¯æ ˆ    if exc_type is None:        return False    if exc_type == self.captures:        raise self.code from exc_val    return False</code></pre><p>åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º raise_api_error çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒåœ¨è¿›å…¥ä¸Šä¸‹æ–‡æ—¶ä»€ä¹ˆä¹Ÿä¸åšã€‚ä½†æ˜¯åœ¨é€€å‡ºä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰ä¸Šä¸‹æ–‡ä¸­æ˜¯å¦æŠ›å‡ºäº†ç±»å‹ä¸º self.captures çš„å¼‚å¸¸ï¼Œå¦‚æœæœ‰ï¼Œå°±ç”¨ APIErrorCode å¼‚å¸¸ç±»æ›¿ä»£å®ƒã€‚</p><p>ä½¿ç”¨è¯¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨åï¼Œæ•´ä¸ªå‡½æ•°å¯ä»¥å˜å¾—æ›´æ¸…æ™°ç®€æ´ï¼š</p><p>def upload_avatar(request):<br>    â€œâ€â€ç”¨æˆ·ä¸Šä¼ æ–°å¤´åƒâ€â€â€<br>    with raise_api_error(KeyError, â€˜AVATAR_FILE_NOT_PROVIDEDâ€™):<br>        avatar_file = request.FILES[â€˜avatarâ€™]</p><pre><code>with raise_api_error(ResizeAvatarError, &apos;AVATAR_FILE_INVALID&apos;),\        raise_api_error(FileTooLargeError, &apos;AVATAR_FILE_TOO_LARGE&apos;):    resized_avatar_file = resize_avatar(avatar_file)with raise_api_error(Exception, &apos;INTERNAL_SERVER_ERROR&apos;):    request.user.avatar = resized_avatar_file    request.user.save()return HttpResponse({})</code></pre><p>å››ã€raies å’Œ raiseâ€¦â€¦from çš„åŒºåˆ«</p><blockquote><blockquote><blockquote><p>try:<br>â€¦     print(1 / 0)<br>â€¦ except:<br>â€¦     raise RuntimeError(â€œSomething bad happenedâ€)<br>â€¦</p></blockquote></blockquote></blockquote><p>Traceback (most recent call last):<br>  File â€œ<stdin>â€œ, line 2, in <module><br>ZeroDivisionError: division by zero</module></stdin></p><h1 id="åœ¨å¤„ç†ä¸Šè¿°å¼‚å¸¸æœŸé—´ï¼Œå‘ç”Ÿäº†å¦ä¸€ä¸ªå¼‚å¸¸ï¼š"><a href="#åœ¨å¤„ç†ä¸Šè¿°å¼‚å¸¸æœŸé—´ï¼Œå‘ç”Ÿäº†å¦ä¸€ä¸ªå¼‚å¸¸ï¼š" class="headerlink" title="åœ¨å¤„ç†ä¸Šè¿°å¼‚å¸¸æœŸé—´ï¼Œå‘ç”Ÿäº†å¦ä¸€ä¸ªå¼‚å¸¸ï¼š"></a>åœ¨å¤„ç†ä¸Šè¿°å¼‚å¸¸æœŸé—´ï¼Œå‘ç”Ÿäº†å¦ä¸€ä¸ªå¼‚å¸¸ï¼š</h1><p>During handling of the above exception, another exception occurred:</p><p>Traceback (most recent call last):<br>  File â€œ<stdin>â€œ, line 4, in <module><br>RuntimeError: Something bad happened</module></stdin></p><blockquote><blockquote><blockquote><p>try:<br>â€¦     print(1 / 0)<br>â€¦ except Exception as exc:<br>â€¦     raise RuntimeError(â€œSomething bad happenedâ€) from exc<br>â€¦</p></blockquote></blockquote></blockquote><p>Traceback (most recent call last):<br>  File â€œ<stdin>â€œ, line 2, in <module><br>ZeroDivisionError: division by zero</module></stdin></p><h1 id="ä¸Šè¿°å¼‚å¸¸æ˜¯ä»¥ä¸‹å¼‚å¸¸çš„ç›´æ¥åŸå› ï¼š"><a href="#ä¸Šè¿°å¼‚å¸¸æ˜¯ä»¥ä¸‹å¼‚å¸¸çš„ç›´æ¥åŸå› ï¼š" class="headerlink" title="ä¸Šè¿°å¼‚å¸¸æ˜¯ä»¥ä¸‹å¼‚å¸¸çš„ç›´æ¥åŸå› ï¼š"></a>ä¸Šè¿°å¼‚å¸¸æ˜¯ä»¥ä¸‹å¼‚å¸¸çš„ç›´æ¥åŸå› ï¼š</h1><p>The above exception was the direct cause of the following exception:</p><p>Traceback (most recent call last):<br>  File â€œ<stdin>â€œ, line 4, in <module><br>RuntimeError: Something bad happened<br>ä¸åŒä¹‹å¤„åœ¨äºï¼Œfrom ä¼šä¸ºå¼‚å¸¸å¯¹è±¡è®¾ç½® <em>cause</em> å±æ€§è¡¨æ˜å¼‚å¸¸çš„æ˜¯ç”±è°ç›´æ¥å¼•èµ·çš„ã€‚</module></stdin></p><p>å¤„ç†å¼‚å¸¸æ—¶å‘ç”Ÿäº†æ–°çš„å¼‚å¸¸ï¼Œåœ¨ä¸ä½¿ç”¨ from æ—¶æ›´å€¾å‘äºæ–°å¼‚å¸¸ä¸æ­£åœ¨å¤„ç†çš„å¼‚å¸¸æ²¡æœ‰å…³è”ã€‚è€Œ from åˆ™æ˜¯èƒ½æŒ‡å‡ºæ–°å¼‚å¸¸æ˜¯å› æ—§å¼‚å¸¸ç›´æ¥å¼•èµ·çš„ã€‚è¿™æ ·çš„å¼‚å¸¸ä¹‹é—´çš„å…³è”æœ‰åŠ©äºåç»­å¯¹å¼‚å¸¸çš„åˆ†æå’Œæ’æŸ¥ã€‚from è¯­æ³•ä¼šæœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯ç¬¬äºŒä¸ªè¡¨è¾¾å¼å¿…é¡»æ˜¯å¦ä¸€ä¸ªå¼‚å¸¸ç±»æˆ–å®ä¾‹ã€‚</p><p>å¦‚æœåœ¨å¼‚å¸¸å¤„ç†ç¨‹åºæˆ– finally å—ä¸­å¼•å‘å¼‚å¸¸ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¼‚å¸¸æœºåˆ¶ä¼šéšå¼å·¥ä½œä¼šå°†å…ˆå‰çš„å¼‚å¸¸é™„åŠ ä¸ºæ–°å¼‚å¸¸çš„ _context _å±æ€§ã€‚</p><p>å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ with_traceback() æ–¹æ³•ä¸ºå¼‚å¸¸è®¾ç½®ä¸Šä¸‹æ–‡ <em>context</em> å±æ€§ï¼Œè¿™ä¹Ÿèƒ½åœ¨ traceback æ›´å¥½çš„æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      python withçš„åŸç†åŠåœ¨å¼‚å¸¸å¤„ç†ä¸­çš„åº”ç”¨
    
    </summary>
    
      <category term="Python" scheme="https://cloudsjhan.github.io/categories/Python/"/>
    
    
      <category term="Python" scheme="https://cloudsjhan.github.io/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>TCP/IPè¯¦è§£--TCPè¿æ¥ä¸­time_waitçŠ¶æ€è¿‡å¤š</title>
    <link href="https://cloudsjhan.github.io/2019/09/10/TCP-IP%E8%AF%A6%E8%A7%A3-TCP%E8%BF%9E%E6%8E%A5%E4%B8%ADtime-wait%E7%8A%B6%E6%80%81%E8%BF%87%E5%A4%9A/"/>
    <id>https://cloudsjhan.github.io/2019/09/10/TCP-IPè¯¦è§£-TCPè¿æ¥ä¸­time-waitçŠ¶æ€è¿‡å¤š/</id>
    <published>2019-09-10T06:00:46.000Z</published>
    <updated>2019-09-10T06:02:48.381Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><p>æœ¬æ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/yusiguyuan/article/details/21445883" target="_blank" rel="noopener">https://blog.csdn.net/yusiguyuan/article/details/21445883</a><br>TIMEWAITçŠ¶æ€æœ¬èº«å’Œåº”ç”¨å±‚çš„å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨æ˜¯æ²¡æœ‰å…³ç³»çš„ã€‚ä»…ä»…æ˜¯ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œåœ¨ä½¿ç”¨FIN|ACK|FIN|ACKå››åˆ†ç»„æ­£å¸¸å…³é—­TCPè¿æ¥çš„æ—¶å€™ä¼šå‡ºç°è¿™ä¸ªTIMEWAITã€‚æœåŠ¡å™¨åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æœä½ çš„ç¨‹åºè®¾è®¡ä¸ºæœåŠ¡å™¨ä¸»åŠ¨å…³é—­ï¼Œé‚£ä¹ˆä½ æ‰æœ‰å¯èƒ½éœ€è¦å…³æ³¨è¿™ä¸ªTIMEWAITçŠ¶æ€è¿‡å¤šçš„é—®é¢˜ã€‚å¦‚æœä½ çš„æœåŠ¡å™¨è®¾è®¡ä¸ºè¢«åŠ¨å…³é—­ï¼Œé‚£ä¹ˆä½ é¦–å…ˆè¦å…³æ³¨çš„æ˜¯CLOSE_WAITã€‚</p><p>åŸåˆ™<br>TIMEWAITå¹¶ä¸æ˜¯å¤šä½™çš„ã€‚åœ¨TCPåè®®è¢«åˆ›é€ ï¼Œç»å†äº†å¤§é‡çš„å®é™…åœºæ™¯å®è·µä¹‹åï¼ŒTIMEWAITå‡ºç°äº†ï¼Œå› ä¸ºTCPä¸»åŠ¨å…³é—­è¿æ¥çš„ä¸€æ–¹éœ€è¦TIMEWAITçŠ¶æ€ï¼Œå®ƒæ˜¯æˆ‘ä»¬çš„æœ‹å‹ã€‚è¿™æ˜¯ã€ŠUNIXç½‘ç»œç¼–ç¨‹ã€‹çš„ä½œè€…â€”-Stevenå¯¹TIMEWAITçš„æ€åº¦ã€‚</p><p>TIMEWAITæ˜¯å‹å¥½çš„<br>    TCPè¦ä¿è¯åœ¨æ‰€æœ‰å¯èƒ½çš„æƒ…å†µä¸‹ä½¿å¾—æ‰€æœ‰çš„æ•°æ®éƒ½èƒ½å¤Ÿè¢«æ­£ç¡®é€è¾¾ã€‚å½“ä½ å…³é—­ä¸€ä¸ªsocketæ—¶ï¼Œä¸»åŠ¨å…³é—­ä¸€ç«¯çš„socketå°†è¿›å…¥TIME_WAITçŠ¶æ€ï¼Œè€Œè¢«åŠ¨å…³é—­ä¸€æ–¹åˆ™è½¬å…¥CLOSEDçŠ¶æ€ï¼Œè¿™çš„ç¡®èƒ½å¤Ÿä¿è¯æ‰€æœ‰çš„æ•°æ®éƒ½è¢«ä¼ è¾“ã€‚å½“ä¸€ä¸ªsocketå…³é—­çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡ä¸¤ç«¯å››æ¬¡æ¡æ‰‹å®Œæˆçš„ï¼Œå½“ä¸€ç«¯è°ƒç”¨close()æ—¶ï¼Œå°±è¯´æ˜æœ¬ç«¯æ²¡æœ‰æ•°æ®è¦å‘é€äº†ã€‚è¿™å¥½ä¼¼çœ‹æ¥åœ¨æ¡æ‰‹å®Œæˆä»¥åï¼Œsocketå°±éƒ½å¯ä»¥å¤„äºåˆå§‹çš„CLOSEDçŠ¶æ€äº†ï¼Œå…¶å®ä¸ç„¶ã€‚åŸå› æ˜¯è¿™æ ·å®‰æ’çŠ¶æ€æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œ é¦–å…ˆï¼Œæˆ‘ä»¬æ²¡æœ‰ä»»ä½•æœºåˆ¶ä¿è¯æœ€åçš„ä¸€ä¸ªACKèƒ½å¤Ÿæ­£å¸¸ä¼ è¾“ï¼Œç¬¬äºŒï¼Œç½‘ç»œä¸Šä»ç„¶æœ‰å¯èƒ½æœ‰æ®‹ä½™çš„æ•°æ®åŒ…(wandering duplicates)ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»èƒ½å¤Ÿæ­£å¸¸å¤„ç†ã€‚<br>TIMEWAITå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜è€Œç”Ÿçš„ã€‚<br>1.å‡è®¾æœ€åä¸€ä¸ªACKä¸¢å¤±äº†ï¼Œè¢«åŠ¨å…³é—­ä¸€æ–¹ä¼šé‡å‘å®ƒçš„FINã€‚ä¸»åŠ¨å…³é—­ä¸€æ–¹å¿…é¡»ç»´æŒä¸€ä¸ªæœ‰æ•ˆçŠ¶æ€ä¿¡æ¯ï¼ˆTIMEWAITçŠ¶æ€ä¸‹ç»´æŒï¼‰ï¼Œä»¥ä¾¿èƒ½å¤Ÿé‡å‘ACKã€‚å¦‚æœä¸»åŠ¨å…³é—­çš„socketä¸ç»´æŒè¿™ç§çŠ¶æ€è€Œè¿›å…¥CLOSEDçŠ¶æ€ï¼Œé‚£ä¹ˆä¸»åŠ¨å…³é—­çš„socketåœ¨å¤„äºCLOSEDçŠ¶æ€æ—¶ï¼Œæ¥æ”¶åˆ°FINåå°†ä¼šå“åº”ä¸€ä¸ªRSTã€‚è¢«åŠ¨å…³é—­ä¸€æ–¹æ¥æ”¶åˆ°RSTåä¼šè®¤ä¸ºå‡ºé”™äº†ã€‚å¦‚æœTCPåè®®æƒ³è¦æ­£å¸¸å®Œæˆå¿…è¦çš„æ“ä½œè€Œç»ˆæ­¢åŒæ–¹çš„æ•°æ®æµä¼ è¾“ï¼Œå°±å¿…é¡»å®Œå…¨æ­£ç¡®çš„ä¼ è¾“å››æ¬¡æ¡æ‰‹çš„å››ä¸ªèŠ‚ï¼Œä¸èƒ½æœ‰ä»»ä½•çš„ä¸¢å¤±ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆsocketåœ¨å…³é—­åï¼Œä»ç„¶å¤„äºTIME_WAITçŠ¶æ€çš„ç¬¬ä¸€ä¸ªåŸå› ï¼Œå› ä¸ºä»–è¦ç­‰å¾…ä»¥ä¾¿é‡å‘ACKã€‚</p><p>2.å‡è®¾ç›®å‰è¿æ¥çš„é€šä¿¡åŒæ–¹éƒ½å·²ç»è°ƒç”¨äº†close()ï¼ŒåŒæ–¹åŒæ—¶è¿›å…¥CLOSEDçš„ç»ˆç»“çŠ¶æ€ï¼Œè€Œæ²¡æœ‰èµ°TIME_WAITçŠ¶æ€ã€‚ä¼šå‡ºç°å¦‚ä¸‹é—®é¢˜ï¼Œç°åœ¨æœ‰ä¸€ä¸ªæ–°çš„è¿æ¥è¢«å»ºç«‹èµ·æ¥ï¼Œä½¿ç”¨çš„IPåœ°å€ä¸ç«¯å£ä¸å…ˆå‰çš„å®Œå…¨ç›¸åŒï¼Œåå»ºç«‹çš„è¿æ¥æ˜¯åŸå…ˆè¿æ¥çš„ä¸€ä¸ªå®Œå…¨å¤ç”¨ã€‚è¿˜å‡å®šåŸå…ˆçš„è¿æ¥ä¸­æœ‰æ•°æ®æŠ¥æ®‹å­˜äºç½‘ç»œä¹‹ä¸­ï¼Œè¿™æ ·æ–°çš„è¿æ¥æ”¶åˆ°çš„æ•°æ®æŠ¥ä¸­æœ‰å¯èƒ½æ˜¯å…ˆå‰è¿æ¥çš„æ•°æ®æŠ¥ã€‚ä¸ºäº†é˜²æ­¢è¿™ä¸€ç‚¹ï¼ŒTCPä¸å…è®¸æ–°è¿æ¥å¤ç”¨TIME_WAITçŠ¶æ€ä¸‹çš„socketã€‚å¤„äºTIME_WAITçŠ¶æ€çš„socketåœ¨ç­‰å¾…ä¸¤å€çš„MSLæ—¶é—´ä»¥åï¼ˆä¹‹æ‰€ä»¥æ˜¯ä¸¤å€çš„MSLï¼Œæ˜¯ç”±äºMSLæ˜¯ä¸€ä¸ªæ•°æ®æŠ¥åœ¨ç½‘ç»œä¸­å•å‘å‘å‡ºåˆ°è®¤å®šä¸¢å¤±çš„æ—¶é—´ï¼Œä¸€ä¸ªæ•°æ®æŠ¥æœ‰å¯èƒ½åœ¨å‘é€é€”ä¸­æˆ–æ˜¯å…¶å“åº”è¿‡ç¨‹ä¸­æˆä¸ºæ®‹ä½™æ•°æ®æŠ¥ï¼Œç¡®è®¤ä¸€ä¸ªæ•°æ®æŠ¥åŠå…¶å“åº”çš„ä¸¢å¼ƒçš„éœ€è¦ä¸¤å€çš„MSLï¼‰ï¼Œå°†ä¼šè½¬å˜ä¸ºCLOSEDçŠ¶æ€ã€‚è¿™å°±æ„å‘³ç€ï¼Œä¸€ä¸ªæˆåŠŸå»ºç«‹çš„è¿æ¥ï¼Œå¿…ç„¶ä½¿å¾—å…ˆå‰ç½‘ç»œä¸­æ®‹ä½™çš„æ•°æ®æŠ¥éƒ½ä¸¢å¤±äº†ã€‚</p><p>å¤§é‡TIMEWAITåœ¨æŸäº›åœºæ™¯ä¸­å¯¼è‡´çš„ä»¤äººå¤´ç–¼çš„ä¸šåŠ¡é—®é¢˜<br>å¤§é‡TIMEWAITå‡ºç°ï¼Œå¹¶ä¸”éœ€è¦è§£å†³çš„åœºæ™¯<br>      åœ¨é«˜å¹¶å‘çŸ­è¿æ¥çš„TCPæœåŠ¡å™¨ä¸Šï¼Œå½“æœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚åç«‹åˆ»æŒ‰ç…§ä¸»åŠ¨æ­£å¸¸å…³é—­è¿æ¥ã€‚ã€‚ã€‚è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä¼šå‡ºç°å¤§é‡socketå¤„äºTIMEWAITçŠ¶æ€ã€‚å¦‚æœå®¢æˆ·ç«¯çš„å¹¶å‘é‡æŒç»­å¾ˆé«˜ï¼Œæ­¤æ—¶éƒ¨åˆ†å®¢æˆ·ç«¯å°±ä¼šæ˜¾ç¤ºè¿æ¥ä¸ä¸Šã€‚<br>æˆ‘æ¥è§£é‡Šä¸‹è¿™ä¸ªåœºæ™¯ã€‚ä¸»åŠ¨æ­£å¸¸å…³é—­TCPè¿æ¥ï¼Œéƒ½ä¼šå‡ºç°TIMEWAITã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å…³æ³¨è¿™ä¸ªé«˜å¹¶å‘çŸ­è¿æ¥å‘¢ï¼Ÿæœ‰ä¸¤ä¸ªæ–¹é¢éœ€è¦æ³¨æ„ï¼š</p><ol><li>é«˜å¹¶å‘å¯ä»¥è®©æœåŠ¡å™¨åœ¨çŸ­æ—¶é—´èŒƒå›´å†…åŒæ—¶å ç”¨å¤§é‡ç«¯å£ï¼Œè€Œç«¯å£æœ‰ä¸ª0~65535çš„èŒƒå›´ï¼Œå¹¶ä¸æ˜¯å¾ˆå¤šï¼Œåˆ¨é™¤ç³»ç»Ÿå’Œå…¶ä»–æœåŠ¡è¦ç”¨çš„ï¼Œå‰©ä¸‹çš„å°±æ›´å°‘äº†ã€‚</li><li>åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒçŸ­è¿æ¥è¡¨ç¤ºâ€œä¸šåŠ¡å¤„ç†+ä¼ è¾“æ•°æ®çš„æ—¶é—´ è¿œè¿œå°äº TIMEWAITè¶…æ—¶çš„æ—¶é—´â€çš„è¿æ¥ã€‚è¿™é‡Œæœ‰ä¸ªç›¸å¯¹é•¿çŸ­çš„æ¦‚å¿µï¼Œæ¯”å¦‚ï¼Œå–ä¸€ä¸ªwebé¡µé¢ï¼Œ1ç§’é’Ÿçš„httpçŸ­è¿æ¥å¤„ç†å®Œä¸šåŠ¡ï¼Œåœ¨å…³é—­è¿æ¥ä¹‹åï¼Œè¿™ä¸ªä¸šåŠ¡ç”¨è¿‡çš„ç«¯å£ä¼šåœç•™åœ¨TIMEWAITçŠ¶æ€å‡ åˆ†é’Ÿï¼Œè€Œè¿™å‡ åˆ†é’Ÿï¼Œå…¶ä»–HTTPè¯·æ±‚æ¥ä¸´çš„æ—¶å€™æ˜¯æ— æ³•å ç”¨æ­¤ç«¯å£çš„ã€‚å•ç”¨è¿™ä¸ªä¸šåŠ¡è®¡ç®—æœåŠ¡å™¨çš„åˆ©ç”¨ç‡ä¼šå‘ç°ï¼ŒæœåŠ¡å™¨å¹²æ­£ç»äº‹çš„æ—¶é—´å’Œç«¯å£ï¼ˆèµ„æºï¼‰è¢«æŒ‚ç€æ— æ³•è¢«ä½¿ç”¨çš„æ—¶é—´çš„æ¯”ä¾‹æ˜¯ 1ï¼šå‡ ç™¾ï¼ŒæœåŠ¡å™¨èµ„æºä¸¥é‡æµªè´¹ã€‚ï¼ˆè¯´ä¸ªé¢˜å¤–è¯ï¼Œä»è¿™ä¸ªæ„ä¹‰å‡ºå‘æ¥è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½è°ƒä¼˜çš„è¯ï¼Œé•¿è¿æ¥ä¸šåŠ¡çš„æœåŠ¡å°±ä¸éœ€è¦è€ƒè™‘TIMEWAITçŠ¶æ€ã€‚åŒæ—¶ï¼Œå‡å¦‚ä½ å¯¹æœåŠ¡å™¨ä¸šåŠ¡åœºæ™¯éå¸¸ç†Ÿæ‚‰ï¼Œä½ ä¼šå‘ç°ï¼Œåœ¨å®é™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸€èˆ¬é•¿è¿æ¥å¯¹åº”çš„ä¸šåŠ¡çš„å¹¶å‘é‡å¹¶ä¸ä¼šå¾ˆé«˜ï¼‰<br>ç»¼åˆè¿™ä¸¤ä¸ªæ–¹é¢ï¼ŒæŒç»­çš„åˆ°è¾¾ä¸€å®šé‡çš„é«˜å¹¶å‘çŸ­è¿æ¥ï¼Œä¼šä½¿æœåŠ¡å™¨å› ç«¯å£èµ„æºä¸è¶³è€Œæ‹’ç»ä¸ºä¸€éƒ¨åˆ†å®¢æˆ·æœåŠ¡ã€‚åŒæ—¶ï¼Œè¿™äº›ç«¯å£éƒ½æ˜¯æœåŠ¡å™¨ä¸´æ—¶åˆ†é…ï¼Œæ— æ³•ç”¨SO_REUSEADDRé€‰é¡¹è§£å†³è¿™ä¸ªé—®é¢˜:(</li></ol><p>ä¸€å¯¹çŸ›ç›¾<br>TIMEWAITæ—¢å‹å¥½ï¼Œåˆä»¤äººå¤´ç–¼ã€‚<br>ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è¦æŠ±ç€ä¸€ä¸ªå‹å¥½çš„æ€åº¦æ¥çœ‹å¾…å®ƒï¼Œå› ä¸ºå®ƒå°½å®ƒçš„èƒ½åŠ›ä¿è¯äº†æœåŠ¡å™¨çš„å¥å£®æ€§ã€‚</p><p>å¯è¡Œè€Œä¸”å¿…é¡»å­˜åœ¨ï¼Œä½†æ˜¯ä¸ç¬¦åˆåŸåˆ™çš„è§£å†³æ–¹å¼</p><ol><li>linuxæ²¡æœ‰åœ¨sysctlæˆ–è€…procæ–‡ä»¶ç³»ç»Ÿæš´éœ²ä¿®æ”¹è¿™ä¸ªTIMEWAITè¶…æ—¶æ—¶é—´çš„æ¥å£ï¼Œå¯ä»¥ä¿®æ”¹å†…æ ¸åè®®æ ˆä»£ç ä¸­å…³äºè¿™ä¸ªTIMEWAITçš„è¶…æ—¶æ—¶é—´å‚æ•°ï¼Œé‡ç¼–å†…æ ¸ï¼Œè®©å®ƒç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼ŒåŠ å¿«å›æ”¶ï¼›</li><li>åˆ©ç”¨SO_LINGERé€‰é¡¹çš„å¼ºåˆ¶å…³é—­æ–¹å¼ï¼Œå‘RSTè€Œä¸æ˜¯FINï¼Œæ¥è¶Šè¿‡TIMEWAITçŠ¶æ€ï¼Œç›´æ¥è¿›å…¥CLOSEDçŠ¶æ€ã€‚è¯¦è§æˆ‘çš„åšæ–‡ã€ŠTCPä¹‹é€‰é¡¹SO_LINGERã€‹ã€‚</li></ol><p>æˆ‘å¦‚ä½•çœ‹å¾…è¿™ä¸ªé—®é¢˜<br>ä¸ºä»€ä¹ˆè¯´ä¸Šè¿°ä¸¤ç§è§£å†³æ–¹å¼æˆ‘è§‰å¾—å¯è¡Œï¼Œä½†æ˜¯ä¸ç¬¦åˆåŸåˆ™ï¼Ÿ<br>æˆ‘é¦–å…ˆè®¤ä¸ºï¼Œæˆ‘è¦ä¾é TIMEWAITçŠ¶æ€æ¥ä¿è¯æˆ‘çš„æœåŠ¡å™¨ç¨‹åºå¥å£®ï¼Œç½‘ç»œä¸Šå‘ç”Ÿçš„ä¹±ä¸ƒå…«ç³Ÿçš„é—®é¢˜å¤ªå¤šäº†ï¼Œæˆ‘å…ˆè¦æœåŠ¡åŠŸèƒ½æ­£å¸¸ã€‚<br>é‚£æ˜¯ä¸æ˜¯å°±ä¸è¦æ€§èƒ½äº†å‘¢ï¼Ÿå¹¶ä¸æ˜¯ã€‚å¦‚æœæœåŠ¡å™¨ä¸Šè·‘çš„çŸ­è¿æ¥ä¸šåŠ¡é‡åˆ°äº†æˆ‘çœŸçš„å¿…é¡»å¤„ç†è¿™ä¸ªTIMEWAITçŠ¶æ€è¿‡å¤šçš„é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘çš„åŸåˆ™æ˜¯å°½é‡å¤„ç†ï¼Œè€Œä¸æ˜¯è·ŸTIMEWAITå¹²ä¸Šï¼Œéå…ˆé™¤ä¹‹è€Œåå¿«ï¼šï¼‰å¦‚æœå°½é‡å¤„ç†äº†ï¼Œè¿˜æ˜¯è§£å†³ä¸äº†é—®é¢˜ï¼Œä»ç„¶æ‹’ç»æœåŠ¡éƒ¨åˆ†è¯·æ±‚ï¼Œé‚£æˆ‘ä¼šé‡‡å–åˆ†æœºå™¨çš„æ–¹æ³•ï¼Œè®©å¤šå°æœºå™¨æ¥æŠ—è¿™äº›é«˜å¹¶å‘çš„çŸ­è¯·æ±‚ã€‚æŒç»­åä¸‡å¹¶å‘çš„çŸ­è¿æ¥è¯·æ±‚ï¼Œä¸¤å°æœºå™¨ï¼Œæ¯å°5ä¸‡ä¸ªï¼Œåº”è¯¥å¤Ÿç”¨äº†å§ã€‚ä¸€èˆ¬çš„ä¸šåŠ¡é‡ä»¥åŠå›½å†…å¤§éƒ¨åˆ†ç½‘ç«™å…¶å®å¹¶ä¸éœ€è¦å…³æ³¨è¿™ä¸ªé—®é¢˜ï¼Œä¸€å¥è¯ï¼Œè¾¾ä¸åˆ°éœ€è¦å…³æ³¨è¿™ä¸ªé—®é¢˜çš„è®¿é—®é‡ã€‚<br>çœŸæ­£åœ°å¿…é¡»ä½¿ç”¨ä¸Šè¿°æˆ‘è®¤ä¸ºä¸åˆç†çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„åœºæ™¯æœ‰æ²¡æœ‰å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ã€‚<br>åƒæ·˜å®ã€ç™¾åº¦ã€æ–°æµªã€äº¬ä¸œå•†åŸè¿™æ ·çš„ç«™ç‚¹ï¼Œç”±äºæœ‰å¾ˆå¤šé™æ€å°å›¾ç‰‡ä¸šåŠ¡ï¼Œå¦‚æœè¿‡åº¦åˆ†æœä¼šå¯¼è‡´éœ€è¦ä¸Šçº¿å¤§é‡æœºå™¨ï¼Œå¤šä¹°æœºå™¨å¤šèŠ±é’±ï¼Œå¾—å¤šé…æœºæˆ¿ï¼Œå¤šé…å¤‡è¿ç»´å·¥ç¨‹å¸ˆæ¥å®ˆæŠ¤è¿™äº›æœºå™¨ï¼Œæˆæœ¬å¢é•¿éå¸¸ä¸¥é‡ã€‚ã€‚ã€‚è¿™ä¸ªæ—¶å€™å°±è¦å°½ä¸€åˆ‡å¯èƒ½å»ä¼˜åŒ–ã€‚<br>é¢˜å¤–è¯ï¼ŒæœåŠ¡å™¨ä¸Šçš„æŠ€æœ¯é—®é¢˜æ²¡æœ‰ç»å¯¹ï¼Œä¸€åˆ‡éƒ½æ˜¯ä¸ºä¸šåŠ¡éœ€æ±‚æœåŠ¡çš„ã€‚</p><p>å¦‚ä½•å°½é‡å¤„ç†TIMEWAITè¿‡å¤š<br>sysctlæ”¹ä¸¤ä¸ªå†…æ ¸å‚æ•°å°±è¡Œäº†ï¼Œå¦‚ä¸‹ï¼š<br>net.ipv4.tcp_tw_reuse = 1<br>net.ipv4.tcp_tw_recycle = 1<br>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ‰“å¼€ç³»ç»Ÿçš„TIMEWAITé‡ç”¨å’Œå¿«é€Ÿå›æ”¶ï¼Œè‡³äºæ€ä¹ˆé‡ç”¨å’Œå¿«é€Ÿå›æ”¶ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘æ²¡æœ‰æ·±ç©¶ï¼Œå®é™…åœºæ™¯ä¸­è¿™ä¹ˆåšç¡®å®æœ‰æ•ˆæœã€‚ç”¨netstatæˆ–è€…ssè§‚å¯Ÿå°±èƒ½å¾—å‡ºç»“è®ºã€‚<br>è¿˜æœ‰äº›æœ‹å‹åŒæ—¶ä¹Ÿä¼šæ‰“å¼€syncookiesè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼š<br>net.ipv4.tcp_syncookies = 1<br>æ‰“å¼€è¿™ä¸ªsyncookiesçš„ç›®çš„å®é™…ä¸Šæ˜¯ï¼šâ€œåœ¨æœåŠ¡å™¨èµ„æºï¼ˆå¹¶éå•æŒ‡ç«¯å£èµ„æºï¼Œæ‹’ç»æœåŠ¡æœ‰å¾ˆå¤šç§èµ„æºä¸è¶³çš„æƒ…å†µï¼‰ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä¸è¦æ‹’ç»TCPçš„synï¼ˆè¿æ¥ï¼‰è¯·æ±‚ï¼Œå°½é‡æŠŠsynè¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œç•™ç€è¿‡ä¼šå„¿æœ‰èƒ½åŠ›çš„æ—¶å€™å¤„ç†è¿™äº›TCPçš„è¿æ¥è¯·æ±‚â€ã€‚<br>å¦‚æœå¹¶å‘é‡çœŸçš„éå¸¸éå¸¸é«˜ï¼Œæ‰“å¼€è¿™ä¸ªå…¶å®ç”¨å¤„ä¸å¤§ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      TCP/IPè¯¦è§£--TCPè¿æ¥ä¸­time_waitçŠ¶æ€è¿‡å¤š
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="https://cloudsjhan.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="https://cloudsjhan.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
      <category term="TCP/IP" scheme="https://cloudsjhan.github.io/tags/TCP-IP/"/>
    
  </entry>
  
  <entry>
    <title>crawlabçš„golangåç«¯å†…å­˜åˆ†æåŠä¼˜åŒ–-åŸºäºgo pprof</title>
    <link href="https://cloudsjhan.github.io/2019/08/20/crawlab%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96-%E5%9F%BA%E4%BA%8Ego-pprof/"/>
    <id>https://cloudsjhan.github.io/2019/08/20/crawlabçš„å†…å­˜åˆ†æåŠä¼˜åŒ–-åŸºäºgo-pprof/</id>
    <published>2019-08-20T11:09:59.000Z</published>
    <updated>2019-08-20T12:12:46.921Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>Crawlabå‘å¸ƒå‡ ä¸ªæœˆä»¥æ¥ï¼Œå…¶ä¸­ç»å†è¿‡å¤šæ¬¡è¿­ä»£ï¼Œåœ¨ä½¿ç”¨è€…ä»¬çš„ç§¯æåé¦ˆä¸‹ï¼Œcrawlabçˆ¬è™«å¹³å°é€æ¸ç¨³å®šï¼Œä½†æ˜¯æœ€è¿‘æœ‰ç”¨æˆ·æŠ¥å‡ºcrawlabå¯åŠ¨ä¸€æ®µæ—¶é—´åï¼Œä¸»èŠ‚ç‚¹æœºå™¨ä¼šå‡ºç°å†…å­˜å ç”¨è¿‡é«˜çš„é—®é¢˜ï¼Œä¸€å°4Gå†…å­˜çš„æœºå™¨åœ¨è¿è¡Œcrawlabåç«Ÿç„¶èƒ½å ç”¨3.5Gä»¥ä¸Šï¼Œå‡ ä¹å¯ä»¥è‚¯å®šåç«¯æœåŠ¡çš„æŸä¸ªæ¥å£ç”±äºä»£ç ä¸è§„èŒƒå¯¼è‡´å†…å­˜å ç”¨ï¼Œäºæ˜¯å†³å®šå¯¹crawlabè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†æã€‚</p><h3 id="2-åˆ†æ"><a href="#2-åˆ†æ" class="headerlink" title="2. åˆ†æ"></a>2. åˆ†æ</h3><p>åˆ†æå†…å­˜å…‰é æ‰‹æ’•ä»£ç æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæ€»è¦å€ŸåŠ©ä¸€äº›å·¥å…·ã€‚Golang pprofæ˜¯Goå®˜æ–¹çš„profilingå·¥å…·ï¼Œéå¸¸å¼ºå¤§ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚</p><p>é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨crawlabé¡¹ç›®ä¸­åµŒå…¥å¦‚ä¸‹å‡ è¡Œä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_ <span class="string">"net/http/pprof"</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">http.ListenAndServe(<span class="string">"0.0.0.0:8888"</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>å°†crawlabåç«¯æœåŠ¡å¯åŠ¨åï¼Œæµè§ˆå™¨ä¸­è¾“å…¥<code>http://ip:8899/debug/pprof/</code>å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">/debug/pprof/</span><br><span class="line"></span><br><span class="line">profiles:</span><br><span class="line"><span class="number">0</span>    block</span><br><span class="line"><span class="number">32</span>    goroutine</span><br><span class="line"><span class="number">552</span>    heap</span><br><span class="line"><span class="number">0</span>    mutex</span><br><span class="line"><span class="number">51</span>    threadcreate</span><br><span class="line"></span><br><span class="line">full goroutine stack dump</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»heapï¼Œåœ¨æ±‡æ€»åˆ†æé¡µé¢çš„æœ€ä¸Šæ–¹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯å½“å‰å·²ç»ä½¿ç”¨çš„å †å†…å­˜æ˜¯25M,amazingï¼åœ¨æˆ‘åªä¸Šä¼ ä¸€ä¸ªçˆ¬è™«æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåç«¯æœåŠ¡æ‰€ç”¨çš„å†…å­˜ç«Ÿç„¶èƒ½è¾¾åˆ°25M</p><p><img src="https://s2.ax1x.com/2019/08/20/mYnJuF.jpg" alt="mYnJuF.jpg"></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©<code>go tool pprof</code>æ¥åˆ†æï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> tool pprof -inuse_space http:<span class="comment">//æœ¬æœºIp:8888/debug/pprof/heap</span></span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤è¿›å…¥åï¼Œæ˜¯ä¸€ä¸ªç±»ä¼¼<code>gdb</code>çš„äº¤äº’å¼ç•Œé¢ï¼Œè¾“å…¥<code>top</code>å‘½ä»¤å¯ä»¥å‰10å¤§çš„å†…å­˜åˆ†é…ï¼Œ<code>flat</code>æ˜¯å †æ ˆä¸­å½“å‰å±‚çš„inuseå†…å­˜å€¼ï¼Œcumæ˜¯å †æ ˆä¸­æœ¬å±‚çº§çš„ç´¯è®¡inuseå†…å­˜å€¼ï¼ˆåŒ…æ‹¬è°ƒç”¨çš„å‡½æ•°çš„inuseå†…å­˜å€¼ï¼Œä¸Šé¢çš„å±‚çº§ï¼‰</p><p><a href="https://imgchr.com/i/mYMF91" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/20/mYMF91.png" alt="mYMF91.png"></a></p><p>å¯ä»¥çœ‹åˆ°ï¼Œbytes.makeSliceè¿™ä¸ªå†…ç½®æ–¹æ³•ç«Ÿç„¶ä½¿ç”¨äº†24Må†…å­˜ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ReadFromè¿™ä¸ªæ–¹æ³•ï¼Œæœäº†ä¸€ä¸‹ï¼Œå‘ç° <code>ioutil.ReadAll()</code> é‡Œä¼šè°ƒç”¨ <code>bytes.Buffer.ReadFrom</code>, è€Œ <code>bytes.Buffer.ReadFrom</code> ä¼šè¿›è¡Œ <code>makeSlice</code>ã€‚å†å›å¤´çœ‹ä¸€ä¸‹io/ioutil.readAllçš„ä»£ç å®ç°ï¼Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">readAll</span><span class="params">(r io.Reader, capacity <span class="keyword">int64</span>)</span> <span class="params">(b []<span class="keyword">byte</span>, err error)</span></span> &#123;</span><br><span class="line">    buf := bytes.NewBuffer(<span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">0</span>, capacity))</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        e := <span class="built_in">recover</span>()</span><br><span class="line">        <span class="keyword">if</span> e == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123;</span><br><span class="line">            err = panicErr</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">panic</span>(e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    _, err = buf.ReadFrom(r)</span><br><span class="line">    <span class="keyword">return</span> buf.Bytes(), err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// bytes.MinRead = 512</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadAll</span><span class="params">(r io.Reader)</span> <span class="params">([]<span class="keyword">byte</span>, error)</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> readAll(r, bytes.MinRead)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>ioutil.ReadAll</code> æ¯æ¬¡éƒ½ä¼šåˆ†é…åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸º <code>bytes.MinRead</code> çš„ buffer ï¼Œ<code>bytes.MinRead</code> åœ¨ Golang é‡Œæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º <code>512</code> ã€‚å°±æ˜¯è¯´æ¯æ¬¡è°ƒç”¨ <code>ioutil.ReadAll</code> éƒ½ä¼šåˆ†é…ä¸€å—å¤§å°ä¸º 512 å­—èŠ‚çš„å†…å­˜ï¼Œçœ‹èµ·æ¥æ˜¯æ­£å¸¸çš„ï¼Œä½†æˆ‘ä»¬å†çœ‹ä¸€ä¸‹<code>ReadFrom</code>çš„å®ç°ï¼Œ</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReadFrom reads data from r until EOF and appends it to the buffer, growing</span></span><br><span class="line"><span class="comment">// the buffer as needed. The return value n is the number of bytes read. Any</span></span><br><span class="line"><span class="comment">// error except io.EOF encountered during the read is also returned. If the</span></span><br><span class="line"><span class="comment">// buffer becomes too large, ReadFrom will panic with ErrTooLarge.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(b *Buffer)</span> <span class="title">ReadFrom</span><span class="params">(r io.Reader)</span> <span class="params">(n <span class="keyword">int64</span>, err error)</span></span> &#123;</span><br><span class="line">    b.lastRead = opInvalid</span><br><span class="line">    <span class="comment">// If buffer is empty, reset to recover space.</span></span><br><span class="line">    <span class="keyword">if</span> b.off &gt;= <span class="built_in">len</span>(b.buf) &#123;</span><br><span class="line">        b.Truncate(<span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> free := <span class="built_in">cap</span>(b.buf) - <span class="built_in">len</span>(b.buf); free &lt; MinRead &#123;</span><br><span class="line">            <span class="comment">// not enough space at end</span></span><br><span class="line">            newBuf := b.buf</span><br><span class="line">            <span class="keyword">if</span> b.off+free &lt; MinRead &#123;</span><br><span class="line">                <span class="comment">// not enough space using beginning of buffer;</span></span><br><span class="line">                <span class="comment">// double buffer capacity</span></span><br><span class="line">                newBuf = makeSlice(<span class="number">2</span>*<span class="built_in">cap</span>(b.buf) + MinRead)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">copy</span>(newBuf, b.buf[b.off:])</span><br><span class="line">            b.buf = newBuf[:<span class="built_in">len</span>(b.buf)-b.off]</span><br><span class="line">            b.off = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        m, e := r.Read(b.buf[<span class="built_in">len</span>(b.buf):<span class="built_in">cap</span>(b.buf)])</span><br><span class="line">        b.buf = b.buf[<span class="number">0</span> : <span class="built_in">len</span>(b.buf)+m]</span><br><span class="line">        n += <span class="keyword">int64</span>(m)</span><br><span class="line">        <span class="keyword">if</span> e == io.EOF &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> e != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> n, e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> n, <span class="literal">nil</span> <span class="comment">// err is EOF, so return nil explicitly</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯ä» <code>io.Reader</code> é‡Œè¯»å–çš„æ•°æ®æ”¾å…¥ buffer ä¸­ï¼Œå¦‚æœ buffer ç©ºé—´ä¸å¤Ÿï¼Œå°±æŒ‰ç…§æ¯æ¬¡ <code>2x + MinRead</code> çš„ç®—æ³•é€’å¢ï¼Œè¿™é‡Œ <code>MinRead</code> çš„å¤§å°ä¹Ÿæ˜¯ 512 Bytes ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœæˆ‘ä»¬ä¸€æ¬¡æ€§è¯»å–çš„æ–‡ä»¶è¿‡å¤§ï¼Œå°±ä¼šå¯¼è‡´æ‰€ä½¿ç”¨çš„å†…å­˜å€å¢ï¼Œå‡è®¾æˆ‘ä»¬çš„çˆ¬è™«æ–‡ä»¶æ€»å…±æœ‰500M,é‚£ä¹ˆæ‰€ç”¨çš„å†…å­˜å°±æœ‰500M * 2 + 512Bï¼Œå†µä¸”çˆ¬è™«æ–‡ä»¶ä¸­è¿˜å¸¦äº†é‚£ä¹ˆå¤šlogæ–‡ä»¶ï¼Œé‚£çœ‹çœ‹crawlabæºç ä¸­æ˜¯å“ªä¸€æ®µä½¿ç”¨<code>ioutil.ReadAll</code>è¯»äº†çˆ¬è™«æ–‡ä»¶ï¼Œå®šä½åˆ°äº†è¿™é‡Œï¼š</p><p><a href="https://imgchr.com/i/mYQTWn" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/20/mYQTWn.jpg" alt="mYQTWn.jpg"></a></p><p>è¿™é‡Œç›´æ¥å°†å…¨éƒ¨çš„æ–‡ä»¶å†…å®¹ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¯»äº†è¿›æ¥ï¼Œå¯¼è‡´å†…å­˜å€å¢ï¼Œä»¤äººçª’æ¯çš„æ“ä½œã€‚</p><p>å…¶å®åœ¨è¯»å¤§æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»åˆ°å†…å­˜ï¼Œç›´æ¥å°±ç¿»è½¦äº†ï¼Œæ­£ç¡®æ˜¯å¤„ç†æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æµå¼å¤„ç†ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadFile</span><span class="params">(filePath <span class="keyword">string</span>, handle <span class="keyword">func</span>(<span class="keyword">string</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">    f, err := os.Open(filePath)</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    buf := bufio.NewReader(f)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        line, err := buf.ReadLine(<span class="string">"\n"</span>)</span><br><span class="line">        line = strings.TrimSpace(line)</span><br><span class="line">        handle(line)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> err == io.EOF&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> err</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§æ–¹æ¡ˆå°±æ˜¯åˆ†ç‰‡å¤„ç†ï¼Œå½“è¯»å–çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰æ¢è¡Œç¬¦çš„æ—¶å€™ï¼Œä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒåˆé€‚ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ReadBigFile</span><span class="params">(fileName <span class="keyword">string</span>, handle <span class="keyword">func</span>([]<span class="keyword">byte</span>)</span>) <span class="title">error</span></span> &#123;</span><br><span class="line">    f, err := os.Open(fileName)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">"can't opened this file"</span>)</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> f.Close()</span><br><span class="line">    s := <span class="built_in">make</span>([]<span class="keyword">byte</span>, <span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> nr, err := f.Read(s[:]); <span class="literal">true</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> nr &lt; <span class="number">0</span>:</span><br><span class="line">            fmt.Fprintf(os.Stderr, <span class="string">"cat: error reading: %s\n"</span>, err.Error())</span><br><span class="line">            os.Exit(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">case</span> nr == <span class="number">0</span>: <span class="comment">// EOF</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">case</span> nr &gt; <span class="number">0</span>:</span><br><span class="line">            handle(s[<span class="number">0</span>:nr])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿™ç±»é‡‡ç”¨çš„ç¬¬äºŒç§æ–¹å¼æ¥ä¼˜åŒ–ï¼Œä¼˜åŒ–åå†æ¥çœ‹ä¸‹å†…å­˜åˆ†æï¼š</p><p><a href="https://imgchr.com/i/mYltYj" target="_blank" rel="noopener"><img src="https://s2.ax1x.com/2019/08/20/mYltYj.png" alt="mYltYj.png"></a></p><p>å ç”¨1Må†…å­˜ï¼Œè¿™æ‰æ˜¯ä¸€ä¸ªæ­£å¸¸åç«¯æœåŠ¡è¯¥æœ‰çš„å†…å­˜å¤§å°ï¼Œæºç å·²pushåˆ°crawlabï¼Œå¯ä»¥åœ¨GitHubé¡¹ç›®æºç ä¸­é˜…è¯»ã€‚</p><p>æœ€åé™„ä¸Šé¡¹ç›®é“¾æ¥ï¼Œ<a href="https://github.com/tikazyq/crawlabï¼Œä¸ºcrawlabæ‰“ç”µè¯ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·è´¡çŒ®ï¼Œè®©crawlabå˜å¾—æ›´å¥½ç”¨ï¼" target="_blank" rel="noopener">https://github.com/tikazyq/crawlabï¼Œä¸ºcrawlabæ‰“ç”µè¯ï¼Œæ¬¢è¿å¤§å®¶ä¸€èµ·è´¡çŒ®ï¼Œè®©crawlabå˜å¾—æ›´å¥½ç”¨ï¼</a></p><hr>]]></content>
    
    <summary type="html">
    
      crawlabçš„golangåç«¯å†…å­˜åˆ†æåŠä¼˜åŒ–-åŸºäºgo pprof
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>Pythonä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„ç¯è§†åŠŸèƒ½</title>
    <link href="https://cloudsjhan.github.io/2019/08/16/Python%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E7%8E%AF%E8%A7%86%E5%8A%9F%E8%83%BD/"/>
    <id>https://cloudsjhan.github.io/2019/08/16/Pythonä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„ç¯è§†åŠŸèƒ½/</id>
    <published>2019-08-16T05:28:30.000Z</published>
    <updated>2019-08-16T05:30:21.477Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><h2 id="ä»€ä¹ˆæ˜¯ç¯è§†"><a href="#ä»€ä¹ˆæ˜¯ç¯è§†" class="headerlink" title="ä»€ä¹ˆæ˜¯ç¯è§†"></a>ä»€ä¹ˆæ˜¯ç¯è§†</h2><p>ç¯è§†åªæ˜¯è¿›è¡Œå­è¡¨è¾¾å¼çš„åŒ¹é…ï¼Œå¹¶ä¸å å­—ç¬¦ï¼ŒåŒ¹é…åˆ°çš„å†…å®¹ä¸ä¿å­˜ï¼Œå› æ­¤ä¹Ÿå«åšé›¶å®½æ–­è¨€ï¼Œç¯è§†æœ€ç»ˆçš„åŒ¹é…ç»“æœå°±æ˜¯ä¸€ä¸ªä½ç½®ã€‚</p><p>ç¯è§†æŒ‰ç…§æ–¹å‘å¯ä»¥åˆ†ä¸ºé¡ºåºç¯è§†å’Œé€†åºç¯è§†ä¸¤ç§ï¼ŒæŒ‰æ˜¯å¦è¿›è¡ŒåŒ¹é…åˆ†ä¸ºè‚¯å®šå’Œå¦å®šä¸¤ç§ï¼Œç»„åˆèµ·æ¥å°±æ˜¯å››ç§æ¨¡å¼ã€‚</p><table><thead><tr><th>ç¯è§†è¡¨è¾¾å¼</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>(?=expression)</td><td>é¡ºåºè‚¯å®šç¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å³ä¾§èƒ½åŒ¹é…expression</td></tr><tr><td>(?!rexpression)</td><td>é¡ºåºå¦å®šç¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å³ä¾§ä¸åŒ¹é…expression</td></tr><tr><td>(?&lt;=expression)</td><td>é€†åºè‚¯å®šç¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å·¦ä¾§èƒ½åŒ¹é…expression</td></tr><tr><td>(?&lt;!expression)</td><td>é€†åºå¦å®šç¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å·¦ä¾§ä¸åŒ¹é…expression</td></tr></tbody></table><p>åªè¯´æ¦‚å¿µå¯èƒ½æœ‰äº›æŠ½è±¡ï¼Œåˆ†åˆ«ä¸¾ä¾‹å­æ¥æ¼”ç¤ºä¸€ä¸‹å…·ä½“çš„ä½¿ç”¨åœºæ™¯ã€‚</p><h3 id="ä¸€äº›ç¤ºä¾‹"><a href="#ä¸€äº›ç¤ºä¾‹" class="headerlink" title="ä¸€äº›ç¤ºä¾‹"></a>ä¸€äº›ç¤ºä¾‹</h3><ol><li>é¡ºåºè‚¯å®šç¯è§†</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s = 'xiaomi9iphone8iphone7',éœ€è¦åœ¨æ¯ä¸ªæ‰‹æœºå‹å·åé¢åŠ ä¸Šé€—å·ï¼Œå˜æˆ s= 'xiaomi9,iphone8,iphone7'</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">print(re.sub(<span class="string">r'(?=iphone)'</span>,<span class="string">','</span>,s))</span><br><span class="line"><span class="comment"># é¡ºåºè‚¯å®šç¯è§†ï¼Œæ‰€ç¡®å®šçš„ä½ç½®å³è¾¹æ˜¯å­—ç¬¦ä¸²iPhoneï¼Œåœ¨æ­¤ä½ç½®å³å¯æ·»åŠ é€—å·</span></span><br></pre></td></tr></table></figure><ol start="2"><li>é€†åºè‚¯å®šç¯è§†</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s = 'Takes Reservations:No Delivery:No Take-out:Yes Accepts Credit Cards:Yes Good for Groups:No'</span></span><br><span class="line"><span class="comment"># éœ€æ±‚æ˜¯è¦åœ¨Yesï¼Œå’ŒNoçš„åé¢åŠ ä¸Šé€—å·ï¼Œä½¿ä¹‹å˜æˆ</span></span><br><span class="line"><span class="comment"># s = 'Takes Reservations:No, Delivery:No, Take-out:Yes, Accepts Credit Cards:Yes, Good for Groups:No'</span></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line">re.sub(<span class="string">r"(?&lt;=(No))(?=(\s+))|(?&lt;=(Yes))(?=(\s+))"</span>,<span class="string">','</span>,s)</span><br><span class="line"><span class="comment"># é€†åºè‚¯å®šç¯è§†ï¼Œæ‰€è¦ç¡®å®šçš„ä½å·¦è¾¹å¿…é¡»èƒ½åŒ¹é…ä¸ŠNo,æˆ–è€…Yes</span></span><br></pre></td></tr></table></figure><ol start="3"><li>é¡ºåºå¦å®šç¯è§†</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># s = '123aaa',å°†så­—ç¬¦ä¸²å˜æˆ s='123,a,a,a,'</span></span><br><span class="line"><span class="comment"># åˆ†æä¸€ä¸‹ï¼Œå°±æ˜¯åœ¨å­—ç¬¦ä¸²å³ä¾§éæ•°å­—çš„ä½ç½®ï¼Œæ·»åŠ é€—å·ï¼Œå³ä½¿ç”¨é¡ºåºå¦å®šç¯è§†ï¼ŒåŒ¹é…å³ä¾§éæ•°å­—ä½ç½®</span></span><br><span class="line">s = <span class="string">'123aaa'</span></span><br><span class="line">re.sub(<span class="string">r'(?!\d+)'</span>,<span class="string">','</span>,s)</span><br></pre></td></tr></table></figure><ol start="4"><li>é€†åºå¦å®šç¯è§†</li></ol><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°† s= 'aaa123'å˜æˆ s=  ',a,a,a,123'</span></span><br><span class="line"><span class="comment"># åˆ†æä¸€ä¸‹ï¼Œå°±æ˜¯åœ¨éæ•°å­—å·¦ä¾§çš„ä½ç½®åŠ é€—å·ï¼Œä½¿ç”¨é€†åºå¦å®šç¯è§†ï¼ŒåŒ¹é…å·¦ä¾§éæ•°å­—çš„ä½ç½®</span></span><br><span class="line">s= <span class="string">'aaa123'</span></span><br><span class="line">re.sub(<span class="string">r'(?&lt;!\d)'</span>,<span class="string">','</span>,b)</span><br></pre></td></tr></table></figure><p>æœ‰äº›ä¾‹å­ä¸æ˜¯å¾ˆåˆç†ï¼Œå°½é‡èƒ½è¡¨è¾¾æ¸…æ¥šç¯è§†çš„å«ä¹‰å³å¯ã€‚</p><p>æ€»ç»“ï¼š</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç¯è§†çš„åŠŸèƒ½éå¸¸å¼ºå¤§ï¼Œä¹Ÿæ˜¯æ­£åˆ™ä¸­çš„ä¸€ä¸ªéš¾ç‚¹ï¼Œå¯¹äºç¯è§†çš„ç†è§£ï¼Œå¯ä»¥ä»åº”ç”¨å’ŒåŸç†ä¸¤ä¸ªè§’åº¦ç†è§£ï¼Œå¦‚æœæƒ³ç†è§£å¾—æ›´æ¸…æ™°ã€æ·±å…¥ä¸€äº›ï¼Œè¿˜æ˜¯ä»åŸç†çš„è§’åº¦ç†è§£å¥½ä¸€äº›ï¼Œæ­£åˆ™åŒ¹é…åŸºæœ¬åŸç†å‚è€ƒ NFAå¼•æ“åŒ¹é…åŸç†</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      æ­£åˆ™è¡¨è¾¾å¼ä¸­çš„ç¯è§†åŠŸèƒ½è§£æä»¥åŠåœ¨Pythonä¸­çš„ä½¿ç”¨
    
    </summary>
    
      <category term="æ­£åˆ™è¡¨è¾¾å¼" scheme="https://cloudsjhan.github.io/categories/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
    
      <category term="æ­£åˆ™è¡¨è¾¾å¼" scheme="https://cloudsjhan.github.io/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>centos7 ç¼–è¯‘ã€å®‰è£…ã€é…ç½®ã€å¯åŠ¨redis</title>
    <link href="https://cloudsjhan.github.io/2019/08/02/centos7-%E7%BC%96%E8%AF%91%E3%80%81%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE%E3%80%81%E5%90%AF%E5%8A%A8reds/"/>
    <id>https://cloudsjhan.github.io/2019/08/02/centos7-ç¼–è¯‘ã€å®‰è£…ã€é…ç½®ã€å¯åŠ¨reds/</id>
    <published>2019-08-02T09:00:22.000Z</published>
    <updated>2019-08-16T06:17:00.636Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><ol><li><p>ä¸‹è½½Redisçš„å®‰è£…åŒ…</p><p>wget <a href="http://download.redis.io/releases/redis-4.0.6.tar.gz" target="_blank" rel="noopener">http://download.redis.io/releases/redis-4.0.6.tar.gz</a></p></li><li><p>è§£å‹</p><p>tar -zxvf redis-4.0.6.tar.gz</p></li><li><p>cd redis-4.0.6</p></li><li><p>ç¼–è¯‘</p><p>make MALLOC=libc</p></li><li><p>ç¯å¢ƒé…ç½®ï¼Œå°†é…ç½®æ–‡ä»¶ä»¥ä½ æƒ³æš´éœ²çš„Redisä¸ºåï¼Œå¤åˆ¶åˆ°/etc/redis</p><p>mkdir /etc/redis(éœ€è¦rootæƒé™)</p><p>cp redis.conf /etc/redis/6379.conf</p></li><li><p>cd utils &amp; vim redis_init_script</p><p>ä¿®æ”¹ redis_init_scriptä¸­å¦‚å›¾æ‰€ç¤ºçš„éƒ¨åˆ†</p><p><a href="http://ww1.sinaimg.cn/large/006tNc79gy1g5lgb221p3j316w0j619h.jpg" target="_blank" rel="noopener"></a></p><p>é…ç½®chkconfigæ˜¯ä¸ºäº†å¼€æœºé…ç½®å¼€æœºè‡ªå¯Redisï¼Œä¸‹é¢çš„æ¨ªçº¿éƒ¨åˆ†æ¢æˆä½ è‡ªå·±çš„Rediså®‰è£…è·¯å¾„ï¼Œå¯é€‰æ‹©è‡ªå·±æƒ³è¦æš´éœ²çš„ç«¯å£</p></li><li><p>å°†ä¿®æ”¹åçš„redis_init_scriptæ‹·è´è‡³å¼€æœºå¯åŠ¨ç›®å½•ï¼Œå¹¶ä¿®æ”¹æ–‡ä»¶åä¸ºredisd, ä¸€èˆ¬åå°æœåŠ¡éƒ½å·²dç»“å°¾</p><p>cp redis_init_script /etc/init.d/redisd</p></li><li><p>è®¾ç½®å¼€æœºå¯åŠ¨</p><p>chkconfig redisd on</p><p>å¦‚æœä¹‹å‰æ²¡æœ‰åœ¨redis_init_scriptä¸­æ·»åŠ chkconfig,å°±ä¼šæç¤ºä¸æ”¯æŒè¯¥å‘½ä»¤</p></li><li><p>service redisd start å¯åŠ¨Redis</p></li><li><p>åå°å¯åŠ¨çš„è¯ï¼Œservice redis start &amp;</p></li></ol><hr>]]></content>
    
    <summary type="html">
    
      centos7 ç¼–è¯‘ï¼Œå®‰è£…ï¼Œé…ç½®ï¼Œå¯åŠ¨Redis
    
    </summary>
    
      <category term="redis" scheme="https://cloudsjhan.github.io/categories/redis/"/>
    
    
      <category term="redis" scheme="https://cloudsjhan.github.io/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>mysqlæ•°æ®å»é‡</title>
    <link href="https://cloudsjhan.github.io/2019/07/01/mysql%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D/"/>
    <id>https://cloudsjhan.github.io/2019/07/01/mysqlæ•°æ®å»é‡/</id>
    <published>2019-07-01T07:40:05.000Z</published>
    <updated>2019-07-01T07:44:23.308Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><img src="https://" alt="" style="width:100%"><p></p><a id="more"></a><p>ä»excelä¸­å¯¼å…¥äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ°mysqlä¸­ï¼Œæœ‰å¾ˆå¤šæ•°æ®æ˜¯é‡å¤çš„ï¼Œè€Œä¸”æ²¡æœ‰ä¸»é”®ï¼Œéœ€è¦æŒ‰ç…§å…¶ä¸­å·²ç»å­˜åœ¨æŸä¸€åˆ—å¯¹æ•°æ®è¿›è¡Œå»é‡ã€‚</p><h2 id="æ·»åŠ ä¸»é”®"><a href="#æ·»åŠ ä¸»é”®" class="headerlink" title="æ·»åŠ ä¸»é”®"></a>æ·»åŠ ä¸»é”®</h2><p>ç”±äºä¹‹å‰çš„å­—æ®µä¸­æ²¡æœ‰ä¸»é”®ï¼Œæ‰€ä»¥éœ€è¦æ–°å¢ä¸€ä¸ªå­—æ®µï¼Œå¹¶ä¸”å°†å…¶ä½œä¸ºä¸»é”®ã€‚</p><p>æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µidï¼Œå¯¹idä¸­çš„å€¼è¿›è¡Œé€’å¢æ“ä½œï¼Œç„¶åå†è®¾ç½®ä¸ºä¸»é”®ã€‚</p><p>å¯¹idå­—æ®µè¿›è¡Œé€’å¢çš„èµ‹å€¼æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @r:=0;</span><br><span class="line">UPDATE table SET id=(@r:=@r+1);</span><br></pre></td></tr></table></figure><p>ç„¶åè®¾ç½®ä¸ºä¸»é”®å³å¯ã€‚</p><h2 id="å»é‡"><a href="#å»é‡" class="headerlink" title="å»é‡"></a>å»é‡</h2><p>æ·»åŠ é€’å¢çš„idå­—æ®µåï¼Œå°±å¯ä»¥å¯¹æ•°æ®æ ¹æ®æŸä¸ªå­—æ®µè¿›è¡Œå»é‡æ“ä½œï¼Œç­–ç•¥å°±æ˜¯ä¿å­˜idæœ€å°çš„é‚£æ¡æ•°æ®ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM `table`</span><br><span class="line">WHERE</span><br><span class="line">`å»é‡å­—æ®µå` IN (</span><br><span class="line">    SELECT x FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT `å»é‡å­—æ®µå` AS x </span><br><span class="line">        FROM `table` </span><br><span class="line">        GROUP BY `å»é‡å­—æ®µå` </span><br><span class="line">        HAVING COUNT(`å»é‡å­—æ®µå`) &gt; 1</span><br><span class="line">    ) tmp0</span><br><span class="line">)</span><br><span class="line">AND </span><br><span class="line">`é€’å¢ä¸»é”®å` NOT IN (</span><br><span class="line">    SELECT y FROM</span><br><span class="line">    (</span><br><span class="line">        SELECT min(`é€’å¢ä¸»é”®å`) AS y </span><br><span class="line">        FROM `table` </span><br><span class="line">        GROUP BY `å»é‡å­—æ®µå` </span><br><span class="line">        HAVING COUNT(`å»é‡å­—æ®µå`) &gt; 1</span><br><span class="line">    ) tmp1</span><br><span class="line">)</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      mysqlæ•°æ®å»é‡
    
    </summary>
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>dokcer.service æç¤ºç¼ºå¤±bridgeç½‘ç»œï¼Œå¯¼è‡´Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</title>
    <link href="https://cloudsjhan.github.io/2019/06/04/dokcer-service-%E6%8F%90%E7%A4%BA%E7%BC%BA%E5%A4%B1bridge%E7%BD%91%E7%BB%9C%EF%BC%8C%E5%AF%BC%E8%87%B4Cannot-connect-to-the-Docker-daemon-at-unix-var-run-docker-sock-Is-the-docker-daemon-running/"/>
    <id>https://cloudsjhan.github.io/2019/06/04/dokcer-service-æç¤ºç¼ºå¤±bridgeç½‘ç»œï¼Œå¯¼è‡´Cannot-connect-to-the-Docker-daemon-at-unix-var-run-docker-sock-Is-the-docker-daemon-running/</id>
    <published>2019-06-04T07:25:01.000Z</published>
    <updated>2019-06-06T08:39:54.660Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æ“ä½œè¿‡ç¨‹ï¼š</p><ol><li><p>ä¸ºCentOS7å®‰è£…Dockerï¼Œå®‰è£…æˆåŠŸåï¼Œå¯ä»¥æ‰§è¡Œ<code>docker</code>ï¼Œä½†æ˜¯<code>docker ps</code>ç­‰å‘½ä»¤ä¼šæŠ¥é”™ï¼š</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</span><br></pre></td></tr></table></figure></li></ol><p>åˆ†æï¼š</p><p>ä¸€èˆ¬è¿™ç§é”™è¯¯éƒ½æ˜¯ç”±äºæ“ä½œè€…æ²¡æœ‰rootæƒé™ï¼Œä½†æ˜¯ä½¿ç”¨<code>sudo</code>æ‰§è¡Œä¹Ÿæ˜¯åŒæ ·çš„é—®é¢˜ï¼Œè¿™å°±çº³é—·äº†ï¼Œæ²¡å…³ç³»ï¼Œçœ‹ä¸€ä¸‹<code>docker.service</code>çš„æ‰§è¡Œæ—¥å¿—ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl status docker.service</span><br></pre></td></tr></table></figure><p>å‘ç°æœ‰ä¸€å¥å¾ˆé‡è¦çš„è¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error starting daemon: Error initializing network controller: list bridge addresses failed: no available network</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ç”±äºå¯åŠ¨Dockerçš„æ—¶å€™ï¼Œé»˜è®¤çš„ç½‘ç»œæ¨¡å¼æ˜¯æ¡¥æ¥æ¨¡å¼ï¼Œè¿™å°±éœ€è¦å‘æ“ä½œç³»ç»Ÿå‘é€ä¿¡å·ï¼Œè®©å®ƒå¸®æˆ‘ä»¬å»ºç«‹ä¸€ä¸ª<code>bridge</code>ç½‘ç»œå‘½åä¸º<code>docker0</code>, å¹¶ä¸”åˆ†é…<code>172.17.0.1/16</code>ã€‚ä½†æ˜¯å‡ºäºæŸç§åŸå› ï¼Œè¯¥ç½‘ç»œæ²¡æœ‰å»ºç«‹èµ·æ¥ï¼Œæˆ‘ä»¬åªè¦æ‰‹åŠ¨æ‰§è¡Œè¿™ä¸€ç³»åˆ—æ“ä½œå°±å¯ä»¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip link add name docker0 type bridge</span><br><span class="line"></span><br><span class="line">ip addr add dev docker0 172.17.0.1/16</span><br></pre></td></tr></table></figure><p>æœ€åé‡å¯<code>docker</code>:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemclt restart docker</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      dokcer.service æç¤ºç¼ºå¤±bridgeç½‘ç»œï¼Œå¯¼è‡´Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?
    
    </summary>
    
      <category term="docker" scheme="https://cloudsjhan.github.io/categories/docker/"/>
    
    
      <category term="docker" scheme="https://cloudsjhan.github.io/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>python æ­£åˆ™è¡¨è¾¾å¼åŠreè¯¦è§£</title>
    <link href="https://cloudsjhan.github.io/2019/04/28/python-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8F%8Are%E8%AF%A6%E8%A7%A3/"/>
    <id>https://cloudsjhan.github.io/2019/04/28/python-æ­£åˆ™è¡¨è¾¾å¼åŠreè¯¦è§£/</id>
    <published>2019-04-28T06:52:31.000Z</published>
    <updated>2019-04-28T08:15:06.233Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h1 id="Python-æ­£åˆ™è¡¨è¾¾å¼-re-æ¨¡å—"><a href="#Python-æ­£åˆ™è¡¨è¾¾å¼-re-æ¨¡å—" class="headerlink" title="Python æ­£åˆ™è¡¨è¾¾å¼ re æ¨¡å—"></a>Python æ­£åˆ™è¡¨è¾¾å¼ re æ¨¡å—</h1><h1 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h1><p><strong>æ­£åˆ™è¡¨è¾¾å¼ï¼ˆregular expressionï¼‰</strong>æ˜¯å¯ä»¥åŒ¹é…æ–‡æœ¬ç‰‡æ®µçš„æ¨¡å¼ã€‚æœ€ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼å°±æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œå¯ä»¥åŒ¹é…å…¶è‡ªèº«ã€‚æ¯”å¦‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼ â€˜helloâ€™ å¯ä»¥åŒ¹é…å­—ç¬¦ä¸² â€˜helloâ€™ã€‚</p><p>è¦æ³¨æ„çš„æ˜¯ï¼Œæ­£åˆ™è¡¨è¾¾å¼å¹¶ä¸æ˜¯ä¸€ä¸ªç¨‹åºï¼Œè€Œæ˜¯ç”¨äºå¤„ç†å­—ç¬¦ä¸²çš„ä¸€ç§æ¨¡å¼ï¼Œå¦‚æœä½ æƒ³ç”¨å®ƒæ¥å¤„ç†å­—ç¬¦ä¸²ï¼Œå°±å¿…é¡»ä½¿ç”¨æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„å·¥å…·ï¼Œæ¯”å¦‚ Linux ä¸­çš„ awk, sed, grepï¼Œæˆ–è€…ç¼–ç¨‹è¯­è¨€ Perl, Python, Java ç­‰ç­‰ã€‚</p><p>æ­£åˆ™è¡¨è¾¾å¼æœ‰å¤šç§ä¸åŒçš„é£æ ¼ï¼Œä¸‹è¡¨åˆ—å‡ºäº†é€‚ç”¨äº Python æˆ– Perl ç­‰ç¼–ç¨‹è¯­è¨€çš„éƒ¨åˆ†<strong>å…ƒå­—ç¬¦</strong>ä»¥åŠè¯´æ˜ï¼š</p><p><a href="https://ofaatpail.qnssl.com/re.png" target="_blank" rel="noopener"><img src="https://ofaatpail.qnssl.com/re.png" alt="img"></a></p><h1 id="re-æ¨¡å—"><a href="#re-æ¨¡å—" class="headerlink" title="re æ¨¡å—"></a>re æ¨¡å—</h1><p>åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…ç½®çš„ re æ¨¡å—æ¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚</p><p>æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨ <code>\</code> å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”å¦‚ï¼Œä¸ºäº†åŒ¹é…å­—ç¬¦ä¸² â€˜python.orgâ€™ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ <code>&#39;python\.org&#39;</code>ï¼Œè€Œ Python çš„å­—ç¬¦ä¸²æœ¬èº«ä¹Ÿç”¨ <code>\</code> è½¬ä¹‰ï¼Œæ‰€ä»¥ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼åœ¨ Python ä¸­åº”è¯¥å†™æˆ <code>&#39;python\\.org&#39;</code>ï¼Œè¿™ä¼šå¾ˆå®¹æ˜“é™·å…¥ <code>\</code> çš„å›°æ‰°ä¸­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ Python çš„åŸå§‹å­—ç¬¦ä¸²ï¼Œåªéœ€åŠ ä¸€ä¸ª r å‰ç¼€ï¼Œä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥å†™æˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">r&apos;python\.org&apos;</span><br></pre></td></tr></table></figure><p>re æ¨¡å—æä¾›äº†ä¸å°‘æœ‰ç”¨çš„å‡½æ•°ï¼Œç”¨ä»¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ï¼š</p><ul><li>compile å‡½æ•°</li><li>match å‡½æ•°</li><li>search å‡½æ•°</li><li>findall å‡½æ•°</li><li>finditer å‡½æ•°</li><li>split å‡½æ•°</li><li>sub å‡½æ•°</li><li>subn å‡½æ•°</li></ul><p>re æ¨¡å—çš„ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>ä½¿ç”¨ compile å‡½æ•°å°†æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å½¢å¼ç¼–è¯‘ä¸ºä¸€ä¸ª Pattern å¯¹è±¡</li><li>é€šè¿‡ Pattern å¯¹è±¡æä¾›çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼Œè·å¾—åŒ¹é…ç»“æœï¼ˆä¸€ä¸ª Match å¯¹è±¡ï¼‰</li><li>æœ€åä½¿ç”¨ Match å¯¹è±¡æä¾›çš„å±æ€§å’Œæ–¹æ³•è·å¾—ä¿¡æ¯ï¼Œæ ¹æ®éœ€è¦è¿›è¡Œå…¶ä»–çš„æ“ä½œ</li></ul><h1 id="compile-å‡½æ•°"><a href="#compile-å‡½æ•°" class="headerlink" title="compile å‡½æ•°"></a>compile å‡½æ•°</h1><p><strong>compile å‡½æ•°ç”¨äºç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”Ÿæˆä¸€ä¸ª Pattern å¯¹è±¡</strong>ï¼Œå®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.compile(pattern[, flag])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œpattern æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œflag æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œè¡¨ç¤ºåŒ¹é…æ¨¡å¼ï¼Œæ¯”å¦‚å¿½ç•¥å¤§å°å†™ï¼Œå¤šè¡Œæ¨¡å¼ç­‰ã€‚</p><p>ä¸‹é¢ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¾‹å­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"># å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆ Pattern å¯¹è±¡ </span><br><span class="line">pattern = re.compile(r&apos;\d+&apos;)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å·²å°†ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆ Pattern å¯¹è±¡ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ pattern çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾äº†ã€‚Pattern å¯¹è±¡çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•ä¸»è¦æœ‰ï¼š</p><ul><li>match æ–¹æ³•</li><li>search æ–¹æ³•</li><li>findall æ–¹æ³•</li><li>finditer æ–¹æ³•</li><li>split æ–¹æ³•</li><li>sub æ–¹æ³•</li><li>subn æ–¹æ³•</li></ul><h2 id="match-æ–¹æ³•"><a href="#match-æ–¹æ³•" class="headerlink" title="match æ–¹æ³•"></a>match æ–¹æ³•</h2><p>match æ–¹æ³•ç”¨äºæŸ¥æ‰¾å­—ç¬¦ä¸²çš„å¤´éƒ¨ï¼ˆä¹Ÿå¯ä»¥æŒ‡å®šèµ·å§‹ä½ç½®ï¼‰ï¼Œå®ƒæ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æœå°±è¿”å›ï¼Œè€Œä¸æ˜¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç»“æœã€‚å®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match(string[, pos[, endpos]])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚å› æ­¤ï¼Œ<strong>å½“ä½ ä¸æŒ‡å®š pos å’Œ endpos æ—¶ï¼Œmatch æ–¹æ³•é»˜è®¤åŒ¹é…å­—ç¬¦ä¸²çš„å¤´éƒ¨</strong>ã€‚</p><p>å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ª Match å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™è¿”å› Noneã€‚</p><p>çœ‹çœ‹ä¾‹å­ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re</span><br><span class="line">&gt;&gt;&gt; pattern = re.compile(r&apos;\d+&apos;)                    # ç”¨äºåŒ¹é…è‡³å°‘ä¸€ä¸ªæ•°å­—</span><br><span class="line">&gt;&gt;&gt; m = pattern.match(&apos;one12twothree34four&apos;)        # æŸ¥æ‰¾å¤´éƒ¨ï¼Œæ²¡æœ‰åŒ¹é…</span><br><span class="line">&gt;&gt;&gt; print m</span><br><span class="line">None</span><br><span class="line">&gt;&gt;&gt; m = pattern.match(&apos;one12twothree34four&apos;, 2, 10) # ä»&apos;e&apos;çš„ä½ç½®å¼€å§‹åŒ¹é…ï¼Œæ²¡æœ‰åŒ¹é…</span><br><span class="line">&gt;&gt;&gt; print m</span><br><span class="line">None</span><br><span class="line">&gt;&gt;&gt; m = pattern.match(&apos;one12twothree34four&apos;, 3, 10) # ä»&apos;1&apos;çš„ä½ç½®å¼€å§‹åŒ¹é…ï¼Œæ­£å¥½åŒ¹é…</span><br><span class="line">&gt;&gt;&gt; print m                                         # è¿”å›ä¸€ä¸ª Match å¯¹è±¡</span><br><span class="line">&lt;_sre.SRE_Match object at 0x10a42aac0&gt;</span><br><span class="line">&gt;&gt;&gt; m.group(0)   # å¯çœç•¥ 0</span><br><span class="line">&apos;12&apos;</span><br><span class="line">&gt;&gt;&gt; m.start(0)   # å¯çœç•¥ 0</span><br><span class="line">3</span><br><span class="line">&gt;&gt;&gt; m.end(0)     # å¯çœç•¥ 0</span><br><span class="line">5</span><br><span class="line">&gt;&gt;&gt; m.span(0)    # å¯çœç•¥ 0</span><br><span class="line">(3, 5)</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢ï¼Œå½“åŒ¹é…æˆåŠŸæ—¶è¿”å›ä¸€ä¸ª Match å¯¹è±¡ï¼Œå…¶ä¸­ï¼š</p><ul><li><code>group([group1, â€¦])</code> æ–¹æ³•ç”¨äºè·å¾—ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†ç»„åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œå½“è¦è·å¾—æ•´ä¸ªåŒ¹é…çš„å­ä¸²æ—¶ï¼Œå¯ç›´æ¥ä½¿ç”¨ <code>group()</code> æˆ– <code>group(0)</code>ï¼›</li><li><code>start([group])</code> æ–¹æ³•ç”¨äºè·å–åˆ†ç»„åŒ¹é…çš„å­ä¸²åœ¨æ•´ä¸ªå­—ç¬¦ä¸²ä¸­çš„èµ·å§‹ä½ç½®ï¼ˆå­ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•ï¼‰ï¼Œå‚æ•°é»˜è®¤å€¼ä¸º 0ï¼›</li><li><code>end([group])</code> æ–¹æ³•ç”¨äºè·å–åˆ†ç»„åŒ¹é…çš„å­ä¸²åœ¨æ•´ä¸ªå­—ç¬¦ä¸²ä¸­çš„ç»“æŸä½ç½®ï¼ˆå­ä¸²æœ€åä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•+1ï¼‰ï¼Œå‚æ•°é»˜è®¤å€¼ä¸º 0ï¼›</li><li><code>span([group])</code> æ–¹æ³•è¿”å› <code>(start(group), end(group))</code>ã€‚</li></ul><p>å†çœ‹çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re</span><br><span class="line">&gt;&gt;&gt; pattern = re.compile(r&apos;([a-z]+) ([a-z]+)&apos;, re.I)   # re.I è¡¨ç¤ºå¿½ç•¥å¤§å°å†™</span><br><span class="line">&gt;&gt;&gt; m = pattern.match(&apos;Hello World Wide Web&apos;)</span><br><span class="line">&gt;&gt;&gt; print m                               # åŒ¹é…æˆåŠŸï¼Œè¿”å›ä¸€ä¸ª Match å¯¹è±¡</span><br><span class="line">&lt;_sre.SRE_Match object at 0x10bea83e8&gt;</span><br><span class="line">&gt;&gt;&gt; m.group(0)                            # è¿”å›åŒ¹é…æˆåŠŸçš„æ•´ä¸ªå­ä¸²</span><br><span class="line">&apos;Hello World&apos;</span><br><span class="line">&gt;&gt;&gt; m.span(0)                             # è¿”å›åŒ¹é…æˆåŠŸçš„æ•´ä¸ªå­ä¸²çš„ç´¢å¼•</span><br><span class="line">(0, 11)</span><br><span class="line">&gt;&gt;&gt; m.group(1)                            # è¿”å›ç¬¬ä¸€ä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²</span><br><span class="line">&apos;Hello&apos;</span><br><span class="line">&gt;&gt;&gt; m.span(1)                             # è¿”å›ç¬¬ä¸€ä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²çš„ç´¢å¼•</span><br><span class="line">(0, 5)</span><br><span class="line">&gt;&gt;&gt; m.group(2)                            # è¿”å›ç¬¬äºŒä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²</span><br><span class="line">&apos;World&apos;</span><br><span class="line">&gt;&gt;&gt; m.span(2)                             # è¿”å›ç¬¬äºŒä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²</span><br><span class="line">(6, 11)</span><br><span class="line">&gt;&gt;&gt; m.groups()                            # ç­‰ä»·äº (m.group(1), m.group(2), ...)</span><br><span class="line">(&apos;Hello&apos;, &apos;World&apos;)</span><br><span class="line">&gt;&gt;&gt; m.group(3)                            # ä¸å­˜åœ¨ç¬¬ä¸‰ä¸ªåˆ†ç»„</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">IndexError: no such group</span><br></pre></td></tr></table></figure><h2 id="search-æ–¹æ³•"><a href="#search-æ–¹æ³•" class="headerlink" title="search æ–¹æ³•"></a>search æ–¹æ³•</h2><p>search æ–¹æ³•ç”¨äºæŸ¥æ‰¾å­—ç¬¦ä¸²çš„ä»»ä½•ä½ç½®ï¼Œå®ƒä¹Ÿæ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æœå°±è¿”å›ï¼Œè€Œä¸æ˜¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç»“æœï¼Œå®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">search(string[, pos[, endpos]])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚</p><p>å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›ä¸€ä¸ª Match å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™è¿”å› Noneã€‚</p><p>è®©æˆ‘ä»¬çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; import re</span><br><span class="line">&gt;&gt;&gt; pattern = re.compile(&apos;\d+&apos;)</span><br><span class="line">&gt;&gt;&gt; m = pattern.search(&apos;one12twothree34four&apos;)  # è¿™é‡Œå¦‚æœä½¿ç”¨ match æ–¹æ³•åˆ™ä¸åŒ¹é…</span><br><span class="line">&gt;&gt;&gt; m</span><br><span class="line">&lt;_sre.SRE_Match object at 0x10cc03ac0&gt;</span><br><span class="line">&gt;&gt;&gt; m.group()</span><br><span class="line">&apos;12&apos;</span><br><span class="line">&gt;&gt;&gt; m = pattern.search(&apos;one12twothree34four&apos;, 10, 30)  # æŒ‡å®šå­—ç¬¦ä¸²åŒºé—´</span><br><span class="line">&gt;&gt;&gt; m</span><br><span class="line">&lt;_sre.SRE_Match object at 0x10cc03b28&gt;</span><br><span class="line">&gt;&gt;&gt; m.group()</span><br><span class="line">&apos;34&apos;</span><br><span class="line">&gt;&gt;&gt; m.span()</span><br><span class="line">(13, 15)</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line"> </span><br><span class="line"># å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆ Pattern å¯¹è±¡</span><br><span class="line">pattern = re.compile(r&apos;\d+&apos;) </span><br><span class="line"> </span><br><span class="line"># ä½¿ç”¨ search() æŸ¥æ‰¾åŒ¹é…çš„å­ä¸²ï¼Œä¸å­˜åœ¨åŒ¹é…çš„å­ä¸²æ—¶å°†è¿”å› None </span><br><span class="line"># è¿™é‡Œä½¿ç”¨ match() æ— æ³•æˆåŠŸåŒ¹é… </span><br><span class="line">m = pattern.search(&apos;hello 123456 789&apos;) </span><br><span class="line"> </span><br><span class="line">if m: </span><br><span class="line">    # ä½¿ç”¨ Match è·å¾—åˆ†ç»„ä¿¡æ¯ </span><br><span class="line">    print &apos;matching string:&apos;,m.group()</span><br><span class="line">    print &apos;position:&apos;,m.span()</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">matching string: 123456</span><br><span class="line">position: (6, 12)</span><br></pre></td></tr></table></figure><h2 id="findall-æ–¹æ³•"><a href="#findall-æ–¹æ³•" class="headerlink" title="findall æ–¹æ³•"></a>findall æ–¹æ³•</h2><p>ä¸Šé¢çš„ match å’Œ search æ–¹æ³•éƒ½æ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æœå°±è¿”å›ã€‚ç„¶è€Œï¼Œåœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æœç´¢æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œè·å¾—æ‰€æœ‰åŒ¹é…çš„ç»“æœã€‚</p><p>findall æ–¹æ³•çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">findall(string[, pos[, endpos]])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚</p><p>findall ä»¥åˆ—è¡¨å½¢å¼è¿”å›å…¨éƒ¨èƒ½åŒ¹é…çš„å­ä¸²ï¼Œå¦‚æœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"> </span><br><span class="line">pattern = re.compile(r&apos;\d+&apos;)   # æŸ¥æ‰¾æ•°å­—</span><br><span class="line">result1 = pattern.findall(&apos;hello 123456 789&apos;)</span><br><span class="line">result2 = pattern.findall(&apos;one1two2three3four4&apos;, 0, 10)</span><br><span class="line"> </span><br><span class="line">print result1</span><br><span class="line">print result2</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[&apos;123456&apos;, &apos;789&apos;]</span><br><span class="line">[&apos;1&apos;, &apos;2&apos;]</span><br></pre></td></tr></table></figure><h2 id="finditer-æ–¹æ³•"><a href="#finditer-æ–¹æ³•" class="headerlink" title="finditer æ–¹æ³•"></a>finditer æ–¹æ³•</h2><p>finditer æ–¹æ³•çš„è¡Œä¸ºè·Ÿ findall çš„è¡Œä¸ºç±»ä¼¼ï¼Œä¹Ÿæ˜¯æœç´¢æ•´ä¸ªå­—ç¬¦ä¸²ï¼Œè·å¾—æ‰€æœ‰åŒ¹é…çš„ç»“æœã€‚ä½†å®ƒè¿”å›ä¸€ä¸ªé¡ºåºè®¿é—®æ¯ä¸€ä¸ªåŒ¹é…ç»“æœï¼ˆMatch å¯¹è±¡ï¼‰çš„è¿­ä»£å™¨ã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line"> </span><br><span class="line">pattern = re.compile(r&apos;\d+&apos;)</span><br><span class="line"></span><br><span class="line">result_iter1 = pattern.finditer(&apos;hello 123456 789&apos;)</span><br><span class="line">result_iter2 = pattern.finditer(&apos;one1two2three3four4&apos;, 0, 10)</span><br><span class="line"></span><br><span class="line">print type(result_iter1)</span><br><span class="line">print type(result_iter2)</span><br><span class="line"></span><br><span class="line">print &apos;result1...&apos;</span><br><span class="line">for m1 in result_iter1:   # m1 æ˜¯ Match å¯¹è±¡</span><br><span class="line">    print &apos;matching string: &#123;&#125;, position: &#123;&#125;&apos;.format(m1.group(), m1.span())</span><br><span class="line"></span><br><span class="line">print &apos;result2...&apos;</span><br><span class="line">for m2 in result_iter2:</span><br><span class="line">    print &apos;matching string: &#123;&#125;, position: &#123;&#125;&apos;.format(m2.group(), m2.span())</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;type &apos;callable-iterator&apos;&gt;</span><br><span class="line">&lt;type &apos;callable-iterator&apos;&gt;</span><br><span class="line">result1...</span><br><span class="line">matching string: 123456, position: (6, 12)</span><br><span class="line">matching string: 789, position: (13, 16)</span><br><span class="line">result2...</span><br><span class="line">matching string: 1, position: (3, 4)</span><br><span class="line">matching string: 2, position: (7, 8)</span><br></pre></td></tr></table></figure><h2 id="split-æ–¹æ³•"><a href="#split-æ–¹æ³•" class="headerlink" title="split æ–¹æ³•"></a>split æ–¹æ³•</h2><p>split æ–¹æ³•æŒ‰ç…§èƒ½å¤ŸåŒ¹é…çš„å­ä¸²å°†å­—ç¬¦ä¸²åˆ†å‰²åè¿”å›åˆ—è¡¨ï¼Œå®ƒçš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">split(string[, maxsplit])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œmaxsplit ç”¨äºæŒ‡å®šæœ€å¤§åˆ†å‰²æ¬¡æ•°ï¼Œä¸æŒ‡å®šå°†å…¨éƒ¨åˆ†å‰²ã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"> </span><br><span class="line">p = re.compile(r&apos;[\s\,\;]+&apos;)</span><br><span class="line">print p.split(&apos;a,b;; c   d&apos;)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;a&apos;, &apos;b&apos;, &apos;c&apos;, &apos;d&apos;]</span><br></pre></td></tr></table></figure><h2 id="sub-æ–¹æ³•"><a href="#sub-æ–¹æ³•" class="headerlink" title="sub æ–¹æ³•"></a>sub æ–¹æ³•</h2><p>sub æ–¹æ³•ç”¨äºæ›¿æ¢ã€‚å®ƒçš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub(repl, string[, count])</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œrepl å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š</p><ul><li>å¦‚æœ repl æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ä¼šä½¿ç”¨ repl å»æ›¿æ¢å­—ç¬¦ä¸²æ¯ä¸€ä¸ªåŒ¹é…çš„å­ä¸²ï¼Œå¹¶è¿”å›æ›¿æ¢åçš„å­—ç¬¦ä¸²ï¼Œå¦å¤–ï¼Œrepl è¿˜å¯ä»¥ä½¿ç”¨ <code>\id</code> çš„å½¢å¼æ¥å¼•ç”¨åˆ†ç»„ï¼Œä½†ä¸èƒ½ä½¿ç”¨ç¼–å· 0ï¼›</li><li>å¦‚æœ repl æ˜¯å‡½æ•°ï¼Œè¿™ä¸ªæ–¹æ³•åº”å½“åªæ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆMatch å¯¹è±¡ï¼‰ï¼Œå¹¶è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ç”¨äºæ›¿æ¢ï¼ˆè¿”å›çš„å­—ç¬¦ä¸²ä¸­ä¸èƒ½å†å¼•ç”¨åˆ†ç»„ï¼‰ã€‚</li></ul><p>count ç”¨äºæŒ‡å®šæœ€å¤šæ›¿æ¢æ¬¡æ•°ï¼Œä¸æŒ‡å®šæ—¶å…¨éƒ¨æ›¿æ¢ã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"> </span><br><span class="line">p = re.compile(r&apos;(\w+) (\w+)&apos;)</span><br><span class="line">s = &apos;hello 123, hello 456&apos;</span><br><span class="line"></span><br><span class="line">def func(m):</span><br><span class="line">    return &apos;hi&apos; + &apos; &apos; + m.group(2)</span><br><span class="line"></span><br><span class="line">print p.sub(r&apos;hello world&apos;, s)  # ä½¿ç”¨ &apos;hello world&apos; æ›¿æ¢ &apos;hello 123&apos; å’Œ &apos;hello 456&apos;</span><br><span class="line">print p.sub(r&apos;\2 \1&apos;, s)        # å¼•ç”¨åˆ†ç»„</span><br><span class="line">print p.sub(func, s)</span><br><span class="line">print p.sub(func, s, 1)         # æœ€å¤šæ›¿æ¢ä¸€æ¬¡</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">hello world, hello world</span><br><span class="line">123 hello, 456 hello</span><br><span class="line">hi 123, hi 456</span><br><span class="line">hi 123, hello 456</span><br></pre></td></tr></table></figure><h2 id="subn-æ–¹æ³•"><a href="#subn-æ–¹æ³•" class="headerlink" title="subn æ–¹æ³•"></a>subn æ–¹æ³•</h2><p>subn æ–¹æ³•è·Ÿ sub æ–¹æ³•çš„è¡Œä¸ºç±»ä¼¼ï¼Œä¹Ÿç”¨äºæ›¿æ¢ã€‚å®ƒçš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">subn(repl, string[, count])</span><br></pre></td></tr></table></figure><p>å®ƒè¿”å›ä¸€ä¸ªå…ƒç»„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(sub(repl, string[, count]), æ›¿æ¢æ¬¡æ•°)</span><br></pre></td></tr></table></figure><p>å…ƒç»„æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä½¿ç”¨ sub æ–¹æ³•çš„ç»“æœï¼Œç¬¬äºŒä¸ªå…ƒç´ è¿”å›åŸå­—ç¬¦ä¸²è¢«æ›¿æ¢çš„æ¬¡æ•°ã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"> </span><br><span class="line">p = re.compile(r&apos;(\w+) (\w+)&apos;)</span><br><span class="line">s = &apos;hello 123, hello 456&apos;</span><br><span class="line"></span><br><span class="line">def func(m):</span><br><span class="line">    return &apos;hi&apos; + &apos; &apos; + m.group(2)</span><br><span class="line"></span><br><span class="line">print p.subn(r&apos;hello world&apos;, s)</span><br><span class="line">print p.subn(r&apos;\2 \1&apos;, s)</span><br><span class="line">print p.subn(func, s)</span><br><span class="line">print p.subn(func, s, 1)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">(&apos;hello world, hello world&apos;, 2)</span><br><span class="line">(&apos;123 hello, 456 hello&apos;, 2)</span><br><span class="line">(&apos;hi 123, hi 456&apos;, 2)</span><br><span class="line">(&apos;hi 123, hello 456&apos;, 1)</span><br></pre></td></tr></table></figure><h1 id="å…¶ä»–å‡½æ•°"><a href="#å…¶ä»–å‡½æ•°" class="headerlink" title="å…¶ä»–å‡½æ•°"></a>å…¶ä»–å‡½æ•°</h1><p>äº‹å®ä¸Šï¼Œä½¿ç”¨ compile å‡½æ•°ç”Ÿæˆçš„ Pattern å¯¹è±¡çš„ä¸€ç³»åˆ—æ–¹æ³•è·Ÿ re æ¨¡å—çš„å¤šæ•°å‡½æ•°æ˜¯å¯¹åº”çš„ï¼Œä½†åœ¨ä½¿ç”¨ä¸Šæœ‰ç»†å¾®å·®åˆ«ã€‚</p><h2 id="match-å‡½æ•°"><a href="#match-å‡½æ•°" class="headerlink" title="match å‡½æ•°"></a>match å‡½æ•°</h2><p>match å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.match(pattern, string[, flags]):</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œpattern æ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œæ¯”å¦‚ <code>\d+</code>, <code>[a-z]+</code>ã€‚</p><p>è€Œ Pattern å¯¹è±¡çš„ match æ–¹æ³•ä½¿ç”¨å½¢å¼æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">match(string[, pos[, endpos]])</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œmatch å‡½æ•°ä¸èƒ½æŒ‡å®šå­—ç¬¦ä¸²çš„åŒºé—´ï¼Œå®ƒåªèƒ½æœç´¢å¤´éƒ¨ï¼Œçœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">m1 = re.match(r&apos;\d+&apos;, &apos;One12twothree34four&apos;)</span><br><span class="line">if m1:</span><br><span class="line">    print &apos;matching string:&apos;,m1.group()</span><br><span class="line">else:</span><br><span class="line">    print &apos;m1 is:&apos;,m1</span><br><span class="line">    </span><br><span class="line">m2 = re.match(r&apos;\d+&apos;, &apos;12twothree34four&apos;)</span><br><span class="line">if m2:</span><br><span class="line">    print &apos;matching string:&apos;, m2.group()</span><br><span class="line">else:</span><br><span class="line">    print &apos;m2 is:&apos;,m2</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m1 is: None</span><br><span class="line">matching string: 12</span><br></pre></td></tr></table></figure><h2 id="search-å‡½æ•°"><a href="#search-å‡½æ•°" class="headerlink" title="search å‡½æ•°"></a>search å‡½æ•°</h2><p>search å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.search(pattern, string[, flags])</span><br></pre></td></tr></table></figure><p>search å‡½æ•°ä¸èƒ½æŒ‡å®šå­—ç¬¦ä¸²çš„æœç´¢åŒºé—´ï¼Œç”¨æ³•è·Ÿ Pattern å¯¹è±¡çš„ search æ–¹æ³•ç±»ä¼¼ã€‚</p><h2 id="findall-å‡½æ•°"><a href="#findall-å‡½æ•°" class="headerlink" title="findall å‡½æ•°"></a>findall å‡½æ•°</h2><p>findall å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.findall(pattern, string[, flags])</span><br></pre></td></tr></table></figure><p>findall å‡½æ•°ä¸èƒ½æŒ‡å®šå­—ç¬¦ä¸²çš„æœç´¢åŒºé—´ï¼Œç”¨æ³•è·Ÿ Pattern å¯¹è±¡çš„ findall æ–¹æ³•ç±»ä¼¼ã€‚</p><p>çœ‹çœ‹ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">print re.findall(r&apos;\d+&apos;, &apos;hello 12345 789&apos;)</span><br><span class="line"></span><br><span class="line"># è¾“å‡º</span><br><span class="line">[&apos;12345&apos;, &apos;789&apos;]</span><br></pre></td></tr></table></figure><h2 id="finditer-å‡½æ•°"><a href="#finditer-å‡½æ•°" class="headerlink" title="finditer å‡½æ•°"></a>finditer å‡½æ•°</h2><p>finditer å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•è·Ÿ Pattern çš„ finditer æ–¹æ³•ç±»ä¼¼ï¼Œå½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.finditer(pattern, string[, flags])</span><br></pre></td></tr></table></figure><h2 id="split-å‡½æ•°"><a href="#split-å‡½æ•°" class="headerlink" title="split å‡½æ•°"></a>split å‡½æ•°</h2><p>split å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.split(pattern, string[, maxsplit])</span><br></pre></td></tr></table></figure><h2 id="sub-å‡½æ•°"><a href="#sub-å‡½æ•°" class="headerlink" title="sub å‡½æ•°"></a>sub å‡½æ•°</h2><p>sub å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.sub(pattern, repl, string[, count])</span><br></pre></td></tr></table></figure><h2 id="subn-å‡½æ•°"><a href="#subn-å‡½æ•°" class="headerlink" title="subn å‡½æ•°"></a>subn å‡½æ•°</h2><p>subn å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">re.subn(pattern, repl, string[, count])</span><br></pre></td></tr></table></figure><h1 id="åˆ°åº•ç”¨å“ªç§æ–¹å¼"><a href="#åˆ°åº•ç”¨å“ªç§æ–¹å¼" class="headerlink" title="åˆ°åº•ç”¨å“ªç§æ–¹å¼"></a>åˆ°åº•ç”¨å“ªç§æ–¹å¼</h1><p>ä»ä¸Šæ–‡å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ re æ¨¡å—æœ‰ä¸¤ç§æ–¹å¼ï¼š</p><ul><li>ä½¿ç”¨ re.compile å‡½æ•°ç”Ÿæˆä¸€ä¸ª Pattern å¯¹è±¡ï¼Œç„¶åä½¿ç”¨ Pattern å¯¹è±¡çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼›</li><li>ç›´æ¥ä½¿ç”¨ re.match, re.search å’Œ re.findall ç­‰å‡½æ•°ç›´æ¥å¯¹æ–‡æœ¬åŒ¹é…æŸ¥æ‰¾ï¼›</li></ul><p>ä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­å±•ç¤ºè¿™ä¸¤ç§æ–¹æ³•ã€‚</p><p>å…ˆçœ‹ç¬¬ 1 ç§ç”¨æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line"># å°†æ­£åˆ™è¡¨è¾¾å¼å…ˆç¼–è¯‘æˆ Pattern å¯¹è±¡</span><br><span class="line">pattern = re.compile(r&apos;\d+&apos;)</span><br><span class="line"></span><br><span class="line">print pattern.match(&apos;123, 123&apos;)</span><br><span class="line">print pattern.search(&apos;234, 234&apos;)</span><br><span class="line">print pattern.findall(&apos;345, 345&apos;)</span><br></pre></td></tr></table></figure><p>å†çœ‹ç¬¬ 2 ç§ç”¨æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">print re.match(r&apos;\d+&apos;, &apos;123, 123&apos;)</span><br><span class="line">print re.search(r&apos;\d+&apos;, &apos;234, 234&apos;)</span><br><span class="line">print re.findall(r&apos;\d+&apos;, &apos;345, 345&apos;)</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼éœ€è¦ç”¨åˆ°å¤šæ¬¡ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ <code>\d+</code>ï¼‰ï¼Œåœ¨å¤šç§åœºåˆç»å¸¸éœ€è¦è¢«ç”¨åˆ°ï¼Œå‡ºäºæ•ˆç‡çš„è€ƒè™‘ï¼Œæˆ‘ä»¬åº”è¯¥é¢„å…ˆç¼–è¯‘è¯¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”Ÿæˆä¸€ä¸ª Pattern å¯¹è±¡ï¼Œå†ä½¿ç”¨è¯¥å¯¹è±¡çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹éœ€è¦åŒ¹é…çš„æ–‡ä»¶è¿›è¡ŒåŒ¹é…ï¼›è€Œå¦‚æœç›´æ¥ä½¿ç”¨ re.match, re.search ç­‰å‡½æ•°ï¼Œæ¯æ¬¡ä¼ å…¥ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒéƒ½ä¼šè¢«ç¼–è¯‘ä¸€æ¬¡ï¼Œæ•ˆç‡å°±ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ç¬¬ 1 ç§ç”¨æ³•ã€‚</p><h1 id="åŒ¹é…ä¸­æ–‡"><a href="#åŒ¹é…ä¸­æ–‡" class="headerlink" title="åŒ¹é…ä¸­æ–‡"></a>åŒ¹é…ä¸­æ–‡</h1><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³åŒ¹é…æ–‡æœ¬ä¸­çš„æ±‰å­—ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<a href="http://blog.oasisfeng.com/2006/10/19/full-cjk-unicode-range/" target="_blank" rel="noopener">ä¸­æ–‡çš„ unicode ç¼–ç èŒƒå›´</a> ä¸»è¦åœ¨ <code>[\u4e00-\u9fa5]</code>ï¼Œè¿™é‡Œè¯´ä¸»è¦æ˜¯å› ä¸ºè¿™ä¸ªèŒƒå›´å¹¶ä¸å®Œæ•´ï¼Œæ¯”å¦‚æ²¡æœ‰åŒ…æ‹¬å…¨è§’ï¼ˆä¸­æ–‡ï¼‰æ ‡ç‚¹ï¼Œä¸è¿‡ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯å¤Ÿç”¨çš„ã€‚</p><p>å‡è®¾ç°åœ¨æƒ³æŠŠå­—ç¬¦ä¸² <code>title = u&#39;ä½ å¥½ï¼Œhelloï¼Œä¸–ç•Œ&#39;</code> ä¸­çš„ä¸­æ–‡æå–å‡ºæ¥ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"></span><br><span class="line">import re</span><br><span class="line"></span><br><span class="line">title = u&apos;ä½ å¥½ï¼Œhelloï¼Œä¸–ç•Œ&apos;</span><br><span class="line">pattern = re.compile(ur&apos;[\u4e00-\u9fa5]+&apos;)</span><br><span class="line">result = pattern.findall(title)</span><br><span class="line"></span><br><span class="line">print result</span><br></pre></td></tr></table></figure><p>æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬åœ¨æ­£åˆ™è¡¨è¾¾å¼å‰é¢åŠ ä¸Šäº†ä¸¤ä¸ªå‰ç¼€ <code>ur</code>ï¼Œå…¶ä¸­ <code>r</code> è¡¨ç¤ºä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²ï¼Œ<code>u</code> è¡¨ç¤ºæ˜¯ unicode å­—ç¬¦ä¸²ã€‚</p><p>æ‰§è¡Œç»“æœ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[u&apos;\u4f60\u597d&apos;, u&apos;\u4e16\u754c&apos;]</span><br></pre></td></tr></table></figure><h1 id="è´ªå©ªåŒ¹é…"><a href="#è´ªå©ªåŒ¹é…" class="headerlink" title="è´ªå©ªåŒ¹é…"></a>è´ªå©ªåŒ¹é…</h1><p>åœ¨ Python ä¸­ï¼Œæ­£åˆ™åŒ¹é…é»˜è®¤æ˜¯<strong>è´ªå©ªåŒ¹é…</strong>ï¼ˆåœ¨å°‘æ•°è¯­è¨€ä¸­å¯èƒ½æ˜¯éè´ªå©ªï¼‰ï¼Œä¹Ÿå°±æ˜¯<strong>åŒ¹é…å°½å¯èƒ½å¤šçš„å­—ç¬¦</strong>ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³æ‰¾å‡ºå­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ <code>div</code> å—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;aa&lt;div&gt;test1&lt;/div&gt;bb&lt;div&gt;test2&lt;/div&gt;cc&apos;</span><br><span class="line">pattern = re.compile(r&apos;&lt;div&gt;.*&lt;/div&gt;&apos;)</span><br><span class="line">result = pattern.findall(content)</span><br><span class="line"></span><br><span class="line">print result</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;&lt;div&gt;test1&lt;/div&gt;bb&lt;div&gt;test2&lt;/div&gt;&apos;]</span><br></pre></td></tr></table></figure><p>ç”±äºæ­£åˆ™åŒ¹é…æ˜¯è´ªå©ªåŒ¹é…ï¼Œä¹Ÿå°±æ˜¯å°½å¯èƒ½å¤šçš„åŒ¹é…ï¼Œå› æ­¤ï¼Œåœ¨æˆåŠŸåŒ¹é…åˆ°ç¬¬ä¸€ä¸ª <code>&lt;/div&gt;</code> æ—¶ï¼Œå®ƒè¿˜ä¼šå‘å³å°è¯•åŒ¹é…ï¼ŒæŸ¥çœ‹æ˜¯å¦è¿˜æœ‰æ›´é•¿çš„å¯ä»¥æˆåŠŸåŒ¹é…çš„å­ä¸²ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³éè´ªå©ªåŒ¹é…ï¼Œå¯ä»¥åŠ ä¸€ä¸ª <code>?</code>ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">import re</span><br><span class="line"></span><br><span class="line">content = &apos;aa&lt;div&gt;test1&lt;/div&gt;bb&lt;div&gt;test2&lt;/div&gt;cc&apos;</span><br><span class="line">pattern = re.compile(r&apos;&lt;div&gt;.*?&lt;/div&gt;&apos;)    # åŠ ä¸Š ?</span><br><span class="line">result = pattern.findall(content)</span><br><span class="line"></span><br><span class="line">print result</span><br></pre></td></tr></table></figure><p>ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[&apos;&lt;div&gt;test1&lt;/div&gt;&apos;, &apos;&lt;div&gt;test2&lt;/div&gt;&apos;]</span><br></pre></td></tr></table></figure><h1 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h1><ul><li>re æ¨¡å—çš„ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š<ul><li>ä½¿ç”¨ compile å‡½æ•°å°†æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å½¢å¼ç¼–è¯‘ä¸ºä¸€ä¸ª Pattern å¯¹è±¡ï¼›</li><li>é€šè¿‡ Pattern å¯¹è±¡æä¾›çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼Œè·å¾—åŒ¹é…ç»“æœï¼ˆä¸€ä¸ª Match å¯¹è±¡ï¼‰ï¼›</li><li>æœ€åä½¿ç”¨ Match å¯¹è±¡æä¾›çš„å±æ€§å’Œæ–¹æ³•è·å¾—ä¿¡æ¯ï¼Œæ ¹æ®éœ€è¦è¿›è¡Œå…¶ä»–çš„æ“ä½œï¼›</li></ul></li><li>Python çš„æ­£åˆ™åŒ¹é…é»˜è®¤æ˜¯è´ªå©ªåŒ¹é…ã€‚</li></ul><hr>]]></content>
    
    <summary type="html">
    
      pythonæ­£åˆ™è¡¨è¾¾å¼åŠreæ¨¡å—è¯¦è§£
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>vimå¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§(ä¸å®šæœŸæ›´æ–°).md</title>
    <link href="https://cloudsjhan.github.io/2019/04/21/vim%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E6%8A%80%E5%B7%A7-md/"/>
    <id>https://cloudsjhan.github.io/2019/04/21/vimå¸¸ç”¨å‘½ä»¤ä¸æŠ€å·§-md/</id>
    <published>2019-04-21T13:38:14.000Z</published>
    <updated>2019-04-21T14:37:49.394Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h2 id="Vimå¸¸ç”¨çš„å‘½ä»¤ä¸æŠ€å·§æ€»ç»“ï¼š"><a href="#Vimå¸¸ç”¨çš„å‘½ä»¤ä¸æŠ€å·§æ€»ç»“ï¼š" class="headerlink" title="Vimå¸¸ç”¨çš„å‘½ä»¤ä¸æŠ€å·§æ€»ç»“ï¼š"></a>Vimå¸¸ç”¨çš„å‘½ä»¤ä¸æŠ€å·§æ€»ç»“ï¼š</h2><ol><li>åœ¨æ¯è¡Œè¡Œé¦–æ·»åŠ ç›¸åŒçš„å†…å®¹ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%s/^/è¦æ·»åŠ çš„å†…å®¹</span><br></pre></td></tr></table></figure><ol start="2"><li>åœ¨æ¯è¡Œè¡Œå°¾æ·»åŠ ç›¸åŒçš„å†…å®¹ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:%s/$/è¦æ·»åŠ çš„å†…å®¹</span><br></pre></td></tr></table></figure><ol start="3"><li>åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ é™¤ä»£ç æ®µæ¯è¡Œçš„è¡Œå·</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">:%s/^\s*[0-9]*\s*//gc</span><br><span class="line"></span><br><span class="line">å…¶ä¸­ï¼Œ^è¡¨ç¤ºè¡Œé¦–ï¼Œ$è¡¨ç¤ºè¡Œå°¾ï¼Œ\sè¡¨ç¤ºç©ºæ ¼ï¼Œ[0-9]è¡¨ç¤º0~9çš„æ•°å­—ï¼Œ*è¡¨ç¤º0æˆ–å¤šä¸ªï¼Œ%s/^\s*[0-9]*\s*//gcçš„æ„æ€æ˜¯å°†æ¯è¡Œä»¥0æˆ–å¤šä¸ªç©ºæ ¼å¼€å§‹ä¸­é—´åŒ…å«0æˆ–å¤šä¸ªæ•°å­—å¹¶ä»¥0æˆ–å¤šä¸ªç©ºæ ¼ç»“æŸçš„å­—ç¬¦ä¸²æ›¿æ¢ä¸ºç©ºã€‚</span><br></pre></td></tr></table></figure><ol start="4"><li>æŒ‡å®šè¡Œé¦–æ·»åŠ â€#â€</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:447,945 s/^/#</span><br><span class="line">447-945è¡Œçš„è¡Œé¦–æ·»åŠ  #</span><br></pre></td></tr></table></figure><ol start="5"><li>åˆ é™¤æ¯è¡Œå‰é¢çš„å†…å®¹</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:10,15 s/^/#//gc</span><br></pre></td></tr></table></figure><ol start="6"><li>ç»Ÿè®¡måˆ°nè¡Œä¸­â€å­—ç¬¦ä¸²â€å‡ºç°çš„æ¬¡æ•°</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">:m,n s/å­—ç¬¦ä¸²//gn</span><br></pre></td></tr></table></figure><ol start="7"><li><p>ç»Ÿè®¡â€å­—ç¬¦ä¸²â€åœ¨å½“å‰ç¼–è¾‘æ–‡ä»¶å‡ºç°çš„æ¬¡æ•°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">: %s/å­—ç¬¦ä¸²/ng</span><br></pre></td></tr></table></figure></li><li><p>ç»Ÿè®¡è¯è¯­åœ¨æ–‡ä»¶ä¸­å‡ºç°çš„è¡Œæ•°:</p></li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat file|grep -i å­—ç¬¦ä¸² |wc -l</span><br></pre></td></tr></table></figure><ol start="9"><li>pycharmä¸­vimæ’ä»¶æ‰¹é‡ç¼©è¿›ï¼š</li></ol><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:m,n &gt;</span><br><span class="line">//å‘å³ç¼©è¿›4ç©ºæ ¼</span><br><span class="line"></span><br><span class="line">:m,n &lt; </span><br><span class="line">//å‘å·¦ç¼©è¿›4ç©ºæ ¼</span><br></pre></td></tr></table></figure><ol start="10"><li>è·³è½¬åˆ°è¡Œé¦–: ^</li><li>è·³è½¬åˆ°è¡Œå°¾:$</li><li>è·³è½¬åˆ°æ–‡ä»¶å¼€å¤´: gg</li><li>è·³è½¬åˆ°è¡Œå°¾ï¼šG</li></ol><hr>]]></content>
    
    <summary type="html">
    
      vimå¸¸ç”¨çš„å‘½ä»¤ä¸æŠ€å·§æ€»ç»“
    
    </summary>
    
      <category term="vim" scheme="https://cloudsjhan.github.io/categories/vim/"/>
    
    
      <category term="vim" scheme="https://cloudsjhan.github.io/tags/vim/"/>
    
  </entry>
  
  <entry>
    <title>IRCå¸¸ç”¨å‘½ä»¤</title>
    <link href="https://cloudsjhan.github.io/2019/04/19/IRC%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4/"/>
    <id>https://cloudsjhan.github.io/2019/04/19/IRCå¸¸ç”¨å‘½ä»¤/</id>
    <published>2019-04-19T02:38:29.000Z</published>
    <updated>2019-04-19T02:44:55.593Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>ä¸‹é¢æ˜¯å¸¸ç”¨å‘½ä»¤</p><p>/åœ¨ä¸å¼•èµ·æ··æ·†çš„æƒ…å†µä¸‹ï¼ŒIRCå‘½ä»¤å…è®¸ç®€å†™ã€‚ä¾‹å¦‚ï¼Œ/join å‘½ä»¤å¯ä»¥ç®€å†™ä¸º/jï¼Œ/joæˆ–è€…/joiã€‚ </p><p>/nick</p><p>æ›´æ”¹æ˜µç§°çš„åŸºæœ¬æ–¹æ³•æ˜¯ï¼š/n(ick) æ–°çš„æ˜µç§°</p><p>æ‚¨çš„æ˜µç§°å¯ä»¥åŒ…å«è‹±æ–‡å­—æ¯ï¼Œæ•°å­—ï¼Œæ±‰å­—åŠä¸‹åˆ’çº¿ç­‰ã€‚ä½†æ˜¯ï¼Œæ˜µç§°ä¸èƒ½è¶…è¿‡50ä¸ªï¼ˆæ¯ä¸ªå­—ç¬¦å’Œæ±‰å­—éƒ½ç®—ä¸€ä¸ªå­—ï¼‰ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«$ï¼Œ+ï¼Œï¼å’Œç©ºæ ¼ã€‚</p><p>/nick å‘½ä»¤ç­‰ä»·äºå·¥å…·æŒ‰é’®ä¸­çš„â€œæ”¹å˜åˆ«åâ€ã€‚</p><p>/join</p><p>/joinå‘½ä»¤çš„æ ¼å¼æ˜¯ï¼š/j(oin) èŠå¤©å®¤å</p><p>å¦‚æœèŠå¤©å®¤å·²ç»å­˜åœ¨ï¼Œæ‚¨å°±è¿›å…¥è¯¥èŠå¤©å®¤ã€‚æ­¤æ—¶ï¼Œ/join å‘½ä»¤ç­‰ä»·äºèŠå¤©å®¤åˆ—è¡¨å·¥å…·æŒ‰é’®ä¸­çš„â€œè¿›å…¥â€ã€‚</p><p>å¦‚æœèŠå¤©å®¤ä¸å­˜åœ¨ï¼Œæ‚¨å°±å»ºç«‹äº†ä¸€ä¸ªæ–°çš„èŠå¤©å®¤å¹¶è¿›å…¥ã€‚æ­¤æ—¶ï¼Œ/join å‘½ä»¤ç­‰ä»·äºå·¥å…·æŒ‰é’®ä¸­çš„â€œå»ºèŠå¤©å®¤â€ã€‚</p><p>èŠå¤©å®¤çš„åå­—å¯ä»¥åŒ…å«è‹±æ–‡å­—æ¯ï¼Œæ•°å­—ï¼Œæ±‰å­—åŠä¸‹åˆ’çº¿ç­‰ã€‚ä½†æ˜¯ï¼Œä¸èƒ½è¶…è¿‡50ä¸ªå­—ï¼ˆæ¯ä¸ªå­—ç¬¦å’Œæ±‰å­—éƒ½ç®—ä¸€ä¸ªå­—ï¼‰ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«$ï¼Œ+ï¼Œï¼å’Œç©ºæ ¼ã€‚</p><p>/mode +(-)i</p><p>/mode +(-)i å‘½ä»¤å¯ä»¥ç”¨æ¥é”ä½ï¼ˆè§£é”ï¼‰ç”¨æˆ·è‡ªå»ºçš„èŠå¤©å®¤ï¼ˆç§äººèŠå¤©å®¤ï¼‰ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯:/m(ode)</p><p>+i æˆ– /m(ode) -i</p><p>åªæœ‰ç”¨æˆ·è‡ªå»ºçš„èŠå¤©å®¤æ‰èƒ½åŠ é”ã€‚</p><p>æœªç»ç®¡ç†å‘˜é‚€è¯·ï¼Œå…¶ä»–ç”¨æˆ·ä¸èƒ½è¿›å…¥ç§äººèŠå¤©å®¤ã€‚</p><p>/mode +(-)o</p><p>/mode +(-)o å‘½ä»¤å¯ä»¥è®©èŠå¤©å®¤ç®¡ç†å‘˜èµ‹äºˆæˆ–è€…å‰¥å¤ºå…¶ä»–ç”¨æˆ·çš„ç®¡ç†å‘˜èº«ä»½ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯ï¼š/m(ode)</p><p>+o ç”¨æˆ·æ˜µç§°æˆ–/m(ode)-oç”¨æˆ·æ˜µç§°åªæœ‰èŠå¤©å®¤ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚</p><p>/knock</p><p>/knock å‘½ä»¤å¯ä»¥è®©æ‚¨è¯¢é—®ç§äººèŠå¤©å®¤ç®¡ç†å‘˜æ˜¯å¦å¯ä»¥è¿›å…¥è¯¥ç§äººèŠå¤©å®¤ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯ï¼š/k(nock) æˆ¿é—´å</p><p>æ¶ˆæ¯]</p><p>/invite</p><p>/invite å‘½ä»¤å¯ä»¥è®©èŠå¤©å®¤ç®¡ç†å‘˜é‚€è¯·å…¶ä»–ç”¨æˆ·è¿›å…¥ç§äººèŠå¤©å®¤ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯:/i(nvite) ç”¨æˆ·æ˜µç§°</p><p>åªæœ‰ç§äººèŠå¤©å®¤çš„ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚</p><p>/privmsg</p><p>/privmsg å‘½ä»¤ç”¨æ¥å‘åœ¨åŒä¸€é—´èŠå¤©å®¤çš„æŸä¸ªç”¨æˆ·å‘é€ç§äººæ¶ˆæ¯ï¼ˆæ‚„æ‚„è¯ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨çš„æ¶ˆæ¯åªé€ç»™æŒ‡å®šçš„äººï¼Œè€Œä¸ä¼šæ˜¾ç¤ºç»™å…¶ä»–ç”¨æˆ·ã€‚</p><p>/privmsg å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š /p(rivmsg) ç”¨æˆ·æ˜µç§° æ¶ˆæ¯</p><p>æ¥å—æ‚¨çš„ç§äººæ¶ˆæ¯çš„ç”¨æˆ·å¿…é¡»å’Œæ‚¨åœ¨åŒä¸€é—´èŠå¤©å®¤ã€‚</p><p>â€œç”¨æˆ·æ˜µç§°â€å’Œâ€œæ¶ˆæ¯â€è¿™ä¸¤ä¸ªå‚æ•°æ˜¯ä¸èƒ½çœç•¥çš„ã€‚</p><p>å¦‚æœæŸä¸ªç”¨æˆ·çš„æ˜µç§°å¤ªé•¿ï¼Œåœ¨ä¸ä¼šäº§ç”Ÿæ··æ·†çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åªè¾“å…¥ç”¨æˆ·æ˜µç§°çš„å¤´å‡ ä¸ªå­—æ¯ï¼Œç³»ç»Ÿä¼šè¿›è¡Œè‡ªåŠ¨åŒ¹é…ã€‚</p><p>ä¾‹å¦‚ï¼šèŠå¤©å®¤é‡Œé™¤äº†æ‚¨ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªç”¨æˆ·ï¼Œä»–ä»¬çš„æ˜µç§°åˆ†åˆ«æ˜¯xiaobaoå’Œsoftmanã€‚æ‚¨è‹¥æƒ³ç»™softmanå‘é€æ‚„æ‚„è¯ï¼Œå¯ä»¥åœ¨è¾“å…¥æ¡†é‡Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š</p><p>/p s Have you etanged today?</p><p>ç”±äºxiaobaoå’Œsoftmançš„ç¬¬ä¸€ä¸ªå­—æ¯å°±ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šæŠŠæ‚¨è¾“å…¥çš„æ˜µç§°â€œsâ€è‡ªåŠ¨åŒ¹é…ä¸ºâ€œsoftmanâ€ã€‚å¦å¤–ï¼Œâ€œ/pâ€æ˜¯â€œ/privmsgâ€çš„ç¼©å†™ã€‚</p><p>/ignore</p><p>/ignore å‘½ä»¤ç”¨æ¥æŠŠæŸä¸ªç”¨æˆ·åŠ å…¥æ‚¨çš„â€œåäººé»‘åå•â€ã€‚ä¸€æ—¦æŸä¸ªç”¨æˆ·è¿›å…¥äº†æ‚¨çš„é»‘åå•ï¼Œä»–è¯´çš„ä»»ä½•è¯éƒ½å°†ä¸ä¼šæ˜¾ç¤ºåœ¨æ‚¨çš„ç»ˆç«¯ä¸Šã€‚</p><p>/ignore å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/ig(nore) ç”¨æˆ·æ˜µç§°</p><p>ç”¨æˆ·æ˜µç§°æ‰€ä»£è¡¨çš„ç”¨æˆ·å¿…é¡»å’Œæ‚¨åœ¨åŒä¸€ä¸ªèŠå¤©å®¤ã€‚</p><p>/ignore å‘½ä»¤ç­‰ä»·äºç”¨æˆ·åˆ—è¡¨å·¥å…·æŒ‰é’®ä¸­çš„â€œå¿½ç•¥â€ã€‚</p><p>å¦‚æœæŸä¸ªç”¨æˆ·çš„æ˜µç§°å¤ªé•¿ï¼Œåœ¨ä¸ä¼šäº§ç”Ÿæ··æ·†çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åªè¾“å…¥ç”¨æˆ·æ˜µç§°çš„å¤´å‡ ä¸ªå­—æ¯ï¼Œç³»ç»Ÿä¼šè¿›è¡Œè‡ªåŠ¨åŒ¹é…ã€‚</p><p>åœ¨æ‚¨çš„ç”¨æˆ·åˆ—è¡¨ä¸­ï¼Œå¦‚æœæŸä¸ªç”¨æˆ·æ˜µç§°å‰æœ‰ä¸€ä¸ª#ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·å·²ç»è¢«æ‚¨åˆ—å…¥é»‘åå•ã€‚</p><p>å¦‚æœä¸€ä¸ªç”¨æˆ·å·²ç»åœ¨æ‚¨çš„é»‘åå•ä¸­ï¼Œæ‚¨å¯ä»¥ç”¨ /ignore ç”¨æˆ·æ˜µç§° æŠŠä»–ä»é»‘åå•ä¸­å»æ‰ã€‚</p><p>/away</p><p>/away å‘½ä»¤ç”¨æ¥æŠŠè‡ªå·±è®¾ä¸ºâ€œæš‚æ—¶ç¦»å¼€â€çŠ¶æ€ï¼Œå¹¶å¯ä»¥ç•™è¨€ç»™å…¶ä»–ç”¨æˆ·ã€‚å½“å…¶ä»–ç”¨æˆ·å’Œæ‚¨è¯´æ‚„æ‚„è¯æ—¶ï¼Œæ‚¨é¢„å…ˆè®¾ç½®çš„ç•™è¨€ä¼šè‡ªåŠ¨å›å¤ç»™å…¶ä»–ç”¨æˆ·ã€‚</p><p>/away å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/a(way) [ç•™è¨€]</p><p>â€œç•™è¨€â€è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚å¦‚æœæœ‰è¿™ä¸ªå‚æ•°ï¼Œæ‚¨çš„çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºâ€œæš‚æ—¶ç¦»å¼€â€ã€‚å¦åˆ™ï¼Œæ‚¨çš„çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºâ€œæˆ‘å›æ¥äº†â€ã€‚</p><p>å½“æ‚¨æš‚æ—¶ç¦»å¼€èŠå¤©å®¤æ—¶ï¼Œç”¨æˆ·åˆ—è¡¨ä¸­æ‚¨çš„æ˜µç§°å‰ä¼šå‡ºç°ä¸€ä¸ª?ï¼Œè¡¨ç¤ºæ‚¨å¤„äºâ€œç¦»å¼€â€çŠ¶æ€ã€‚å·¥å…·æŒ‰é’®ä¸­çš„â€œæš‚æ—¶ç¦»å¼€â€ä¹Ÿä¼šå˜ä¸ºâ€œæˆ‘å›æ¥äº†â€ã€‚</p><p>å½“æ‚¨å›æ¥ç»§ç»­èŠå¤©æ—¶ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»å·¥å…·æŒ‰é’®ä¸­çš„â€œæˆ‘å›æ¥äº†â€ï¼Œæˆ–è€…åœ¨è¾“å…¥æ¡†é‡Œè¾“å…¥ /away å‘½ä»¤ï¼Œå°†è‡ªå·±è®¾ç½®ä¸ºæ­£å¸¸çŠ¶æ€ã€‚</p><p>/away å‘½ä»¤ç­‰ä»·äºå·¥å…·æŒ‰é’®ä¸­çš„â€œæš‚æ—¶ç¦»å¼€â€</p><p>/whois</p><p>/whois å‘½ä»¤ç”¨æ¥æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„äº¿å”IDï¼ŒIPåœ°å€ï¼Œç›®å‰æ‰€åœ¨çš„èŠå¤©å®¤å’Œå‘å‘†æ—¶é—´ã€‚</p><p>/whois å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/w(hois) ç”¨æˆ·æ˜µç§°</p><p>/whoiså‘½ä»¤ç­‰ä»·äºç”¨æˆ·åˆ—è¡¨å·¥å…·æŒ‰é’®ä¸­çš„â€œæŸ¥è¯¢â€ã€‚</p><p>/names</p><p>/names å‘½ä»¤ç”¨æ¥æŸ¥çœ‹å½“å‰æ‰€æœ‰ï¼ˆæˆ–æŸä¸ªèŠå¤©å®¤å†…ï¼‰çš„åœ¨çº¿èŠå¤©ç”¨æˆ·ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯ï¼š/na(mes) [èŠå¤©å®¤]</p><p>/topic</p><p>/topic å‘½ä»¤ç”¨æ¥è®¾å®šå½“å‰èŠå¤©å®¤çš„ä¸»é¢˜ã€‚</p><p>/topic å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/t(opic) èŠå¤©å®¤ä¸»é¢˜</p><p>åªæœ‰å½“å‰èŠå¤©å®¤çš„ç®¡ç†å‘˜ï¼ˆopï¼‰æ‰æœ‰æƒåˆ©è®¾å®šèŠå¤©å®¤ä¸»é¢˜ã€‚</p><p>èŠå¤©å®¤çš„åˆ›å»ºè€…å°±æ˜¯è¯¥èŠå¤©å®¤çš„ç®¡ç†å‘˜ã€‚</p><p>ç®¡ç†å‘˜æƒé™å¯ä»¥é€šè¿‡ /mode +o å‘½ä»¤è½¬äº¤ã€‚</p><p>/kick</p><p>/kick å‘½ä»¤ç”¨æ¥æŠŠæŸä¸ªç”¨æˆ·è¸¢å‡ºå½“å‰èŠå¤©å®¤ã€‚</p><p>/kick å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/ki(ck) ç”¨æˆ·æ˜µç§° [æ¶ˆæ¯]</p><p>åªæœ‰å½“å‰èŠå¤©å®¤çš„ç®¡ç†å‘˜ï¼ˆopï¼‰æ‰æœ‰æƒåˆ©æŠŠå…¶ä»–ç”¨æˆ·è¸¢å‡ºå½“å‰èŠå¤©å®¤ã€‚</p><p>èŠå¤©å®¤çš„åˆ›å»ºè€…å°±æ˜¯è¯¥èŠå¤©å®¤çš„ç®¡ç†å‘˜ã€‚</p><p>ç®¡ç†å‘˜æƒé™å¯ä»¥é€šè¿‡/mode +oå‘½ä»¤è½¬äº¤ã€‚</p><p>è¯·è¯¸ä½ç½‘å‹æ…ç”¨è¿™ä¸ªå‘½ä»¤ã€‚â€œå›å­åŠ¨å£ä¸åŠ¨æ‰‹â€å˜›ï¼</p><p>/quit</p><p>/quit å‘½ä»¤ç”¨æ¥é€€å‡ºèŠå¤©å®¤ã€‚</p><p>/quit å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/q(uit) [æ¶ˆæ¯]</p><p>â€œæ¶ˆæ¯â€è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚å¦‚æœæ‚¨æŒ‡å®šé€€å‡ºæ—¶çš„æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯ä¼šå‘é€ç»™å½“å‰èŠå¤©å®¤ä¸­çš„å…¶ä»–ç”¨æˆ·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¶ˆæ¯å‘å…¶ä»–ç”¨æˆ·é“åˆ«ã€‚</p><p>/quit å‘½ä»¤ç­‰ä»·äºå·¥å…·æŒ‰é’®ä¸­çš„â€œç»“æŸèŠå¤©â€ </p><ul><li>è¯¦æƒ…å¯å‚è€ƒï¼š<a href="https://www.cnblogs.com/z-books/p/5197840.html" target="_blank" rel="noopener">https://www.cnblogs.com/z-books/p/5197840.html</a> </li></ul><hr>]]></content>
    
    <summary type="html">
    
      IRCå¸¸ç”¨å‘½ä»¤
    
    </summary>
    
      <category term="IRC" scheme="https://cloudsjhan.github.io/categories/IRC/"/>
    
    
      <category term="IRC" scheme="https://cloudsjhan.github.io/tags/IRC/"/>
    
  </entry>
  
  <entry>
    <title>golangé¢è¯•é—®é¢˜æ±‡æ€»</title>
    <link href="https://cloudsjhan.github.io/2019/04/12/golang%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"/>
    <id>https://cloudsjhan.github.io/2019/04/12/golangé¢è¯•é—®é¢˜æ±‡æ€»/</id>
    <published>2019-04-12T02:01:08.000Z</published>
    <updated>2019-04-12T02:02:41.696Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æœ¬æ–‡è½¬è½½è‡ªï¼š<a href="https://github.com/KeKe-Li/golang-interview-questions" target="_blank" rel="noopener">https://github.com/KeKe-Li/golang-interview-questions</a></p><h3 id="Golangé¢è¯•é—®é¢˜æ±‡æ€»"><a href="#Golangé¢è¯•é—®é¢˜æ±‡æ€»" class="headerlink" title="Golangé¢è¯•é—®é¢˜æ±‡æ€»"></a>Golangé¢è¯•é—®é¢˜æ±‡æ€»</h3><p>é€šå¸¸æˆ‘ä»¬å»é¢è¯•è‚¯å®šä¼šæœ‰äº›ä¸é”™çš„Golangçš„é¢è¯•é¢˜ç›®çš„ï¼Œæ‰€ä»¥æ€»ç»“ä¸‹ï¼Œè®©å…¶ä»–Golangå¼€å‘è€…ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥æ£€æµ‹è‡ªå·±çš„èƒ½åŠ›å’Œæé†’è‡ªå·±çš„ä¸è¶³ä¹‹å¤„,æ¬¢è¿å¤§å®¶è¡¥å……å’Œæäº¤æ–°çš„é¢è¯•é¢˜ç›®.</p><p>Golangé¢è¯•é—®é¢˜æ±‡æ€»:</p><h4 id="1-Golangä¸­é™¤äº†åŠ Mutexé”ä»¥å¤–è¿˜æœ‰å“ªäº›æ–¹å¼å®‰å…¨è¯»å†™å…±äº«å˜é‡ï¼Ÿ"><a href="#1-Golangä¸­é™¤äº†åŠ Mutexé”ä»¥å¤–è¿˜æœ‰å“ªäº›æ–¹å¼å®‰å…¨è¯»å†™å…±äº«å˜é‡ï¼Ÿ" class="headerlink" title="1. Golangä¸­é™¤äº†åŠ Mutexé”ä»¥å¤–è¿˜æœ‰å“ªäº›æ–¹å¼å®‰å…¨è¯»å†™å…±äº«å˜é‡ï¼Ÿ"></a>1. Golangä¸­é™¤äº†åŠ Mutexé”ä»¥å¤–è¿˜æœ‰å“ªäº›æ–¹å¼å®‰å…¨è¯»å†™å…±äº«å˜é‡ï¼Ÿ</h4><p>Golangä¸­Goroutine å¯ä»¥é€šè¿‡ Channel è¿›è¡Œå®‰å…¨è¯»å†™å…±äº«å˜é‡ã€‚</p><h4 id="2-æ— ç¼“å†²-Chan-çš„å‘é€å’Œæ¥æ”¶æ˜¯å¦åŒæ­¥"><a href="#2-æ— ç¼“å†²-Chan-çš„å‘é€å’Œæ¥æ”¶æ˜¯å¦åŒæ­¥" class="headerlink" title="2. æ— ç¼“å†² Chan çš„å‘é€å’Œæ¥æ”¶æ˜¯å¦åŒæ­¥?"></a>2. æ— ç¼“å†² Chan çš„å‘é€å’Œæ¥æ”¶æ˜¯å¦åŒæ­¥?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ch := make(chan int)    æ— ç¼“å†²çš„channelç”±äºæ²¡æœ‰ç¼“å†²å‘é€å’Œæ¥æ”¶éœ€è¦åŒæ­¥.</span><br><span class="line">ch := make(chan int, 2) æœ‰ç¼“å†²channelä¸è¦æ±‚å‘é€å’Œæ¥æ”¶æ“ä½œåŒæ­¥.</span><br></pre></td></tr></table></figure><ul><li>channelæ— ç¼“å†²æ—¶ï¼Œå‘é€é˜»å¡ç›´åˆ°æ•°æ®è¢«æ¥æ”¶ï¼Œæ¥æ”¶é˜»å¡ç›´åˆ°è¯»åˆ°æ•°æ®ã€‚</li><li>channelæœ‰ç¼“å†²æ—¶ï¼Œå½“ç¼“å†²æ»¡æ—¶å‘é€é˜»å¡ï¼Œå½“ç¼“å†²ç©ºæ—¶æ¥æ”¶é˜»å¡ã€‚</li></ul><h4 id="3-goè¯­è¨€çš„å¹¶å‘æœºåˆ¶ä»¥åŠå®ƒæ‰€ä½¿ç”¨çš„CSPå¹¶å‘æ¨¡å‹ï¼"><a href="#3-goè¯­è¨€çš„å¹¶å‘æœºåˆ¶ä»¥åŠå®ƒæ‰€ä½¿ç”¨çš„CSPå¹¶å‘æ¨¡å‹ï¼" class="headerlink" title="3. goè¯­è¨€çš„å¹¶å‘æœºåˆ¶ä»¥åŠå®ƒæ‰€ä½¿ç”¨çš„CSPå¹¶å‘æ¨¡å‹ï¼"></a>3. goè¯­è¨€çš„å¹¶å‘æœºåˆ¶ä»¥åŠå®ƒæ‰€ä½¿ç”¨çš„CSPå¹¶å‘æ¨¡å‹ï¼</h4><p>CSPæ¨¡å‹æ˜¯ä¸Šä¸ªä¸–çºªä¸ƒåå¹´ä»£æå‡ºçš„,ä¸åŒäºä¼ ç»Ÿçš„å¤šçº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼ŒCSPè®²ç©¶çš„æ˜¯â€œä»¥é€šä¿¡çš„æ–¹å¼æ¥å…±äº«å†…å­˜â€ã€‚ç”¨äºæè¿°ä¸¤ä¸ªç‹¬ç«‹çš„å¹¶å‘å®ä½“é€šè¿‡å…±äº«çš„é€šè®¯ channel(ç®¡é“)è¿›è¡Œé€šä¿¡çš„å¹¶å‘æ¨¡å‹ã€‚ CSPä¸­channelæ˜¯ç¬¬ä¸€ç±»å¯¹è±¡ï¼Œå®ƒä¸å…³æ³¨å‘é€æ¶ˆæ¯çš„å®ä½“ï¼Œè€Œå…³æ³¨ä¸å‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨çš„channelã€‚</p><p>Golangä¸­channel æ˜¯è¢«å•ç‹¬åˆ›å»ºå¹¶ä¸”å¯ä»¥åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ï¼Œå®ƒçš„é€šä¿¡æ¨¡å¼ç±»ä¼¼äº boss-worker æ¨¡å¼çš„ï¼Œä¸€ä¸ªå®ä½“é€šè¿‡å°†æ¶ˆæ¯å‘é€åˆ°channel ä¸­ï¼Œç„¶ååˆç›‘å¬è¿™ä¸ª channel çš„å®ä½“å¤„ç†ï¼Œä¸¤ä¸ªå®ä½“ä¹‹é—´æ˜¯åŒ¿åçš„ï¼Œè¿™ä¸ªå°±å®ç°å®ä½“ä¸­é—´çš„è§£è€¦ï¼Œå…¶ä¸­ channel æ˜¯åŒæ­¥çš„ä¸€ä¸ªæ¶ˆæ¯è¢«å‘é€åˆ° channel ä¸­ï¼Œæœ€ç»ˆæ˜¯ä¸€å®šè¦è¢«å¦å¤–çš„å®ä½“æ¶ˆè´¹æ‰çš„ï¼Œåœ¨å®ç°åŸç†ä¸Šå…¶å®ç±»ä¼¼ä¸€ä¸ªé˜»å¡çš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚</p><p>Goroutine æ˜¯Golangå®é™…å¹¶å‘æ‰§è¡Œçš„å®ä½“ï¼Œå®ƒåº•å±‚æ˜¯ä½¿ç”¨åç¨‹(coroutine)å®ç°å¹¶å‘ï¼Œcoroutineæ˜¯ä¸€ç§è¿è¡Œåœ¨ç”¨æˆ·æ€çš„ç”¨æˆ·çº¿ç¨‹ï¼Œç±»ä¼¼äº greenthreadï¼Œgoåº•å±‚é€‰æ‹©ä½¿ç”¨coroutineçš„å‡ºå‘ç‚¹æ˜¯å› ä¸ºï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š</p><ul><li>ç”¨æˆ·ç©ºé—´ é¿å…äº†å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢å¯¼è‡´çš„æˆæœ¬ã€‚</li><li>å¯ä»¥ç”±è¯­è¨€å’Œæ¡†æ¶å±‚è¿›è¡Œè°ƒåº¦ã€‚</li><li>æ›´å°çš„æ ˆç©ºé—´å…è®¸åˆ›å»ºå¤§é‡çš„å®ä¾‹ã€‚</li></ul><p>Golangä¸­çš„Goroutineçš„ç‰¹æ€§:</p><p>Golangå†…éƒ¨æœ‰ä¸‰ä¸ªå¯¹è±¡ï¼š På¯¹è±¡(processor) ä»£è¡¨ä¸Šä¸‹æ–‡ï¼ˆæˆ–è€…å¯ä»¥è®¤ä¸ºæ˜¯cpuï¼‰ï¼ŒM(work thread)ä»£è¡¨å·¥ä½œçº¿ç¨‹ï¼ŒGå¯¹è±¡ï¼ˆgoroutineï¼‰.</p><p>æ­£å¸¸æƒ…å†µä¸‹ä¸€ä¸ªcpuå¯¹è±¡å¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¯¹è±¡ï¼Œçº¿ç¨‹å»æ£€æŸ¥å¹¶æ‰§è¡Œgoroutineå¯¹è±¡ã€‚ç¢°åˆ°goroutineå¯¹è±¡é˜»å¡çš„æ—¶å€™ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œä»¥å……åˆ†åˆ©ç”¨cpuèµ„æºã€‚ æ‰€æœ‰æœ‰æ—¶å€™çº¿ç¨‹å¯¹è±¡ä¼šæ¯”å¤„ç†å™¨å¯¹è±¡å¤šå¾ˆå¤š.</p><p>æˆ‘ä»¬ç”¨å¦‚ä¸‹å›¾åˆ†åˆ«è¡¨ç¤ºPã€Mã€G:</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/59.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/59.jpg" alt="img"></a></p><p>Gï¼ˆGoroutineï¼‰ ï¼šæˆ‘ä»¬æ‰€è¯´çš„åç¨‹ï¼Œä¸ºç”¨æˆ·çº§çš„è½»é‡çº§çº¿ç¨‹ï¼Œæ¯ä¸ªGoroutineå¯¹è±¡ä¸­çš„schedä¿å­˜ç€å…¶ä¸Šä¸‹æ–‡ä¿¡æ¯.</p><p>Mï¼ˆMachineï¼‰ ï¼šå¯¹å†…æ ¸çº§çº¿ç¨‹çš„å°è£…ï¼Œæ•°é‡å¯¹åº”çœŸå®çš„CPUæ•°ï¼ˆçœŸæ­£å¹²æ´»çš„å¯¹è±¡ï¼‰.</p><p>Pï¼ˆProcessorï¼‰ ï¼šå³ä¸ºGå’ŒMçš„è°ƒåº¦å¯¹è±¡ï¼Œç”¨æ¥è°ƒåº¦Gå’ŒMä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå…¶æ•°é‡å¯é€šè¿‡GOMAXPROCS()æ¥è®¾ç½®ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒæ•°.</p><p>åœ¨å•æ ¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰Goroutineè¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆM0ï¼‰ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆPï¼‰ï¼Œä»»ä½•æ—¶åˆ»ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­åªæœ‰ä¸€ä¸ªGoroutineï¼Œå…¶ä»–Goroutineåœ¨runqueueä¸­ç­‰å¾…ã€‚</p><p>ä¸€ä¸ªGoroutineè¿è¡Œå®Œè‡ªå·±çš„æ—¶é—´ç‰‡åï¼Œè®©å‡ºä¸Šä¸‹æ–‡ï¼Œè‡ªå·±å›åˆ°runqueueä¸­ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚</p><p>å½“æ­£åœ¨è¿è¡Œçš„G0é˜»å¡çš„æ—¶å€™ï¼ˆå¯ä»¥éœ€è¦IOï¼‰ï¼Œä¼šå†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ˆM1ï¼‰ï¼ŒPè½¬åˆ°æ–°çš„çº¿ç¨‹ä¸­å»è¿è¡Œã€‚</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/60.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/60.jpg" alt="img"></a></p><p>å½“M0è¿”å›æ—¶ï¼Œå®ƒä¼šå°è¯•ä»å…¶ä»–çº¿ç¨‹ä¸­â€œå·â€ä¸€ä¸ªä¸Šä¸‹æ–‡è¿‡æ¥ï¼Œå¦‚æœæ²¡æœ‰å·åˆ°ï¼Œä¼šæŠŠGoroutineæ”¾åˆ°Global runqueueä¸­å»ï¼Œç„¶åæŠŠè‡ªå·±æ”¾å…¥çº¿ç¨‹ç¼“å­˜ä¸­ã€‚ ä¸Šä¸‹æ–‡ä¼šå®šæ—¶æ£€æŸ¥Global runqueueã€‚</p><p>Golangæ˜¯ä¸ºå¹¶å‘è€Œç”Ÿçš„è¯­è¨€ï¼ŒGoè¯­è¨€æ˜¯ä¸ºæ•°ä¸å¤šçš„åœ¨è¯­è¨€å±‚é¢å®ç°å¹¶å‘çš„è¯­è¨€ï¼›ä¹Ÿæ­£æ˜¯Goè¯­è¨€çš„å¹¶å‘ç‰¹æ€§ï¼Œå¸å¼•äº†å…¨çƒæ— æ•°çš„å¼€å‘è€…ã€‚</p><p>Golangçš„CSPå¹¶å‘æ¨¡å‹ï¼Œæ˜¯é€šè¿‡Goroutineå’ŒChannelæ¥å®ç°çš„ã€‚</p><p>Goroutine æ˜¯Goè¯­è¨€ä¸­å¹¶å‘çš„æ‰§è¡Œå•ä½ã€‚æœ‰ç‚¹æŠ½è±¡ï¼Œå…¶å®å°±æ˜¯å’Œä¼ ç»Ÿæ¦‚å¿µä¸Šçš„â€çº¿ç¨‹â€œç±»ä¼¼ï¼Œå¯ä»¥ç†è§£ä¸ºâ€çº¿ç¨‹â€œã€‚ Channelæ˜¯Goè¯­è¨€ä¸­å„ä¸ªå¹¶å‘ç»“æ„ä½“(Goroutine)ä¹‹å‰çš„é€šä¿¡æœºåˆ¶ã€‚é€šå¸¸Channelï¼Œæ˜¯å„ä¸ªGoroutineä¹‹é—´é€šä¿¡çš„â€ç®¡é“â€œï¼Œæœ‰ç‚¹ç±»ä¼¼äºLinuxä¸­çš„ç®¡é“ã€‚</p><p>é€šä¿¡æœºåˆ¶channelä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œä¼ æ•°æ®ç”¨channel &lt;- dataï¼Œå–æ•°æ®ç”¨&lt;-channelã€‚</p><p>åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¼ æ•°æ®channel &lt;- dataå’Œå–æ•°æ®&lt;-channelå¿…ç„¶ä¼šæˆå¯¹å‡ºç°ï¼Œå› ä¸ºè¿™è¾¹ä¼ ï¼Œé‚£è¾¹å–ï¼Œä¸¤ä¸ªgoroutineä¹‹é—´æ‰ä¼šå®ç°é€šä¿¡ã€‚</p><p>è€Œä¸”ä¸ç®¡ä¼ è¿˜æ˜¯å–ï¼Œå¿…é˜»å¡ï¼Œç›´åˆ°å¦å¤–çš„goroutineä¼ æˆ–è€…å–ä¸ºæ­¢ã€‚</p><h4 id="4-Golang-ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡å‹ï¼Ÿ"><a href="#4-Golang-ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡å‹ï¼Ÿ" class="headerlink" title="4. Golang ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡å‹ï¼Ÿ"></a>4. Golang ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡å‹ï¼Ÿ</h4><p>Golang ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡å‹æœ‰ä¸‰ç§:</p><ul><li>é€šè¿‡channelé€šçŸ¥å®ç°å¹¶å‘æ§åˆ¶</li></ul><p>æ— ç¼“å†²çš„é€šé“æŒ‡çš„æ˜¯é€šé“çš„å¤§å°ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ç§ç±»å‹çš„é€šé“åœ¨æ¥æ”¶å‰æ²¡æœ‰èƒ½åŠ›ä¿å­˜ä»»ä½•å€¼ï¼Œå®ƒè¦æ±‚å‘é€ goroutine å’Œæ¥æ”¶ goroutine åŒæ—¶å‡†å¤‡å¥½ï¼Œæ‰å¯ä»¥å®Œæˆå‘é€å’Œæ¥æ”¶æ“ä½œã€‚</p><p>ä»ä¸Šé¢æ— ç¼“å†²çš„é€šé“å®šä¹‰æ¥çœ‹ï¼Œå‘é€ goroutine å’Œæ¥æ”¶ gouroutine å¿…é¡»æ˜¯åŒæ­¥çš„ï¼ŒåŒæ—¶å‡†å¤‡åï¼Œå¦‚æœæ²¡æœ‰åŒæ—¶å‡†å¤‡å¥½çš„è¯ï¼Œå…ˆæ‰§è¡Œçš„æ“ä½œå°±ä¼šé˜»å¡ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªç›¸å¯¹åº”çš„æ“ä½œå‡†å¤‡å¥½ä¸ºæ­¢ã€‚è¿™ç§æ— ç¼“å†²çš„é€šé“æˆ‘ä»¬ä¹Ÿç§°ä¹‹ä¸ºåŒæ­¥é€šé“ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    ch := make(chan struct&#123;&#125;)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        fmt.Println(&quot;start working&quot;)</span><br><span class="line">        time.Sleep(time.Second * 1)</span><br><span class="line">        ch &lt;- struct&#123;&#125;&#123;&#125;</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    &lt;-ch</span><br><span class="line"></span><br><span class="line">    fmt.Println(&quot;finished&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ä¸» goroutine è¿è¡Œåˆ° &lt;-ch æ¥å— channel çš„å€¼çš„æ—¶å€™ï¼Œå¦‚æœè¯¥ channel ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´é˜»å¡ç­‰å¾…ï¼Œç›´åˆ°æœ‰å€¼ã€‚ è¿™æ ·å°±å¯ä»¥ç®€å•å®ç°å¹¶å‘æ§åˆ¶</p><ul><li>é€šè¿‡syncåŒ…ä¸­çš„WaitGroupå®ç°å¹¶å‘æ§åˆ¶</li></ul><p>Goroutineæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæœ‰çš„æ—¶å€™ä¸ºäº†é˜²æ­¢åœ¨ç»“æŸmianå‡½æ•°çš„æ—¶å€™ç»“æŸæ‰Goroutineï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥ç­‰å¾…ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨ WaitGroupäº†ï¼Œåœ¨ sync åŒ…ä¸­ï¼Œæä¾›äº† WaitGroup ï¼Œå®ƒä¼šç­‰å¾…å®ƒæ”¶é›†çš„æ‰€æœ‰ goroutine ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚åœ¨WaitGroupé‡Œä¸»è¦æœ‰ä¸‰ä¸ªæ–¹æ³•:</p><ul><li>Add, å¯ä»¥æ·»åŠ æˆ–å‡å°‘ goroutineçš„æ•°é‡.</li><li>Done, ç›¸å½“äºAdd(-1).</li><li>Wait, æ‰§è¡Œåä¼šå µå¡ä¸»çº¿ç¨‹ï¼Œç›´åˆ°WaitGroup é‡Œçš„å€¼å‡è‡³0.</li></ul><p>åœ¨ä¸» goroutine ä¸­ Add(delta int) ç´¢è¦ç­‰å¾…goroutine çš„æ•°é‡ã€‚ åœ¨æ¯ä¸€ä¸ª goroutine å®Œæˆå Done() è¡¨ç¤ºè¿™ä¸€ä¸ªgoroutine å·²ç»å®Œæˆï¼Œå½“æ‰€æœ‰çš„ goroutine éƒ½å®Œæˆåï¼Œåœ¨ä¸» goroutine ä¸­ WaitGroup è¿”å›è¿”å›ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">func main()&#123;</span><br><span class="line">    var wg sync.WaitGroup</span><br><span class="line">    var urls = []string&#123;</span><br><span class="line">        &quot;http://www.golang.org/&quot;,</span><br><span class="line">        &quot;http://www.google.com/&quot;,</span><br><span class="line">    &#125;</span><br><span class="line">    for _, url := range urls &#123;</span><br><span class="line">        wg.Add(1)</span><br><span class="line">        go func(url string) &#123;</span><br><span class="line">            defer wg.Done()</span><br><span class="line">            http.Get(url)</span><br><span class="line">        &#125;(url)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨Golangå®˜ç½‘ä¸­å¯¹äºWaitGroupä»‹ç»æ˜¯<code>A WaitGroup must not be copied after first use</code>,åœ¨ WaitGroup ç¬¬ä¸€æ¬¡ä½¿ç”¨åï¼Œä¸èƒ½è¢«æ‹·è´</p><p>åº”ç”¨ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">func main()&#123;</span><br><span class="line"> wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">    for i := 0; i &lt; 5; i++ &#123;</span><br><span class="line">        wg.Add(1)</span><br><span class="line">        go func(wg sync.WaitGroup, i int) &#123;</span><br><span class="line">            fmt.Printf(&quot;i:%d&quot;, i)</span><br><span class="line">            wg.Done()</span><br><span class="line">        &#125;(wg, i)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(&quot;exit&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">i:1i:3i:2i:0i:4fatal error: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine 1 [semacquire]:</span><br><span class="line">sync.runtime_Semacquire(0xc000094018)</span><br><span class="line">        /home/keke/soft/go/src/runtime/sema.go:56 +0x39</span><br><span class="line">sync.(*WaitGroup).Wait(0xc000094010)</span><br><span class="line">        /home/keke/soft/go/src/sync/waitgroup.go:130 +0x64</span><br><span class="line">main.main()</span><br><span class="line">        /home/keke/go/Test/wait.go:17 +0xab</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure><p>å®ƒæç¤ºæ‰€æœ‰çš„ goroutine éƒ½å·²ç»ç¡çœ äº†ï¼Œå‡ºç°äº†æ­»é”ã€‚è¿™æ˜¯å› ä¸º wg ç»™æ‹·è´ä¼ é€’åˆ°äº† goroutine ä¸­ï¼Œå¯¼è‡´åªæœ‰ Add æ“ä½œï¼Œå…¶å® Doneæ“ä½œæ˜¯åœ¨ wg çš„å‰¯æœ¬æ‰§è¡Œçš„ã€‚</p><p>å› æ­¤ Wait å°±æ­»é”äº†ã€‚</p><p>è¿™ä¸ªç¬¬ä¸€ä¸ªä¿®æ”¹æ–¹å¼:å°†åŒ¿åå‡½æ•°ä¸­ wg çš„ä¼ å…¥ç±»å‹æ”¹ä¸º *sync.WaitGrou,è¿™æ ·å°±èƒ½å¼•ç”¨åˆ°æ­£ç¡®çš„WaitGroupäº†ã€‚ è¿™ä¸ªç¬¬äºŒä¸ªä¿®æ”¹æ–¹å¼:å°†åŒ¿åå‡½æ•°ä¸­çš„ wg çš„ä¼ å…¥å‚æ•°å»æ‰ï¼Œå› ä¸ºGoæ”¯æŒé—­åŒ…ç±»å‹ï¼Œåœ¨åŒ¿åå‡½æ•°ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨å¤–é¢çš„ wg å˜é‡</p><ul><li>åœ¨Go 1.7 ä»¥åå¼•è¿›çš„å¼ºå¤§çš„Contextä¸Šä¸‹æ–‡ï¼Œå®ç°å¹¶å‘æ§åˆ¶</li></ul><p>é€šå¸¸,åœ¨ä¸€äº›ç®€å•åœºæ™¯ä¸‹ä½¿ç”¨ channel å’Œ WaitGroup å·²ç»è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å½“é¢ä¸´ä¸€äº›å¤æ‚å¤šå˜çš„ç½‘ç»œå¹¶å‘åœºæ™¯ä¸‹ channel å’Œ WaitGroup æ˜¾å¾—æœ‰äº›åŠ›ä¸ä»å¿ƒäº†ã€‚ æ¯”å¦‚ä¸€ä¸ªç½‘ç»œè¯·æ±‚ Requestï¼Œæ¯ä¸ª Request éƒ½éœ€è¦å¼€å¯ä¸€ä¸ª goroutine åšä¸€äº›äº‹æƒ…ï¼Œè¿™äº› goroutine åˆå¯èƒ½ä¼šå¼€å¯å…¶ä»–çš„ goroutineï¼Œæ¯”å¦‚æ•°æ®åº“å’ŒRPCæœåŠ¡ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§å¯ä»¥è·Ÿè¸ª goroutine çš„æ–¹æ¡ˆï¼Œæ‰å¯ä»¥è¾¾åˆ°æ§åˆ¶ä»–ä»¬çš„ç›®çš„ï¼Œè¿™å°±æ˜¯Goè¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„ Contextï¼Œç§°ä¹‹ä¸ºä¸Šä¸‹æ–‡éå¸¸è´´åˆ‡ï¼Œå®ƒå°±æ˜¯goroutine çš„ä¸Šä¸‹æ–‡ã€‚ å®ƒæ˜¯åŒ…æ‹¬ä¸€ä¸ªç¨‹åºçš„è¿è¡Œç¯å¢ƒã€ç°åœºå’Œå¿«ç…§ç­‰ã€‚æ¯ä¸ªç¨‹åºè¦è¿è¡Œæ—¶ï¼Œéƒ½éœ€è¦çŸ¥é“å½“å‰ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œé€šå¸¸Go å°†è¿™äº›å°è£…åœ¨ä¸€ä¸ª Context é‡Œï¼Œå†å°†å®ƒä¼ ç»™è¦æ‰§è¡Œçš„ goroutine ã€‚</p><p>context åŒ…ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†å¤šä¸ª goroutine ä¹‹é—´å…±äº«æ•°æ®ï¼ŒåŠå¤šä¸ª goroutine çš„ç®¡ç†ã€‚</p><p>context åŒ…çš„æ ¸å¿ƒæ˜¯ struct Contextï¼Œæ¥å£å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">// A Context carries a deadline, cancelation signal, and request-scoped values</span><br><span class="line">// across API boundaries. Its methods are safe for simultaneous use by multiple</span><br><span class="line">// goroutines.</span><br><span class="line">type Context interface &#123;</span><br><span class="line">    // Done returns a channel that is closed when this `Context` is canceled</span><br><span class="line">    // or times out.</span><br><span class="line">    Done() &lt;-chan struct&#123;&#125;</span><br><span class="line"></span><br><span class="line">    // Err indicates why this Context was canceled, after the Done channel</span><br><span class="line">    // is closed.</span><br><span class="line">    Err() error</span><br><span class="line"></span><br><span class="line">    // Deadline returns the time when this Context will be canceled, if any.</span><br><span class="line">    Deadline() (deadline time.Time, ok bool)</span><br><span class="line"></span><br><span class="line">    // Value returns the value associated with key or nil if none.</span><br><span class="line">    Value(key interface&#123;&#125;) interface&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Done() è¿”å›ä¸€ä¸ªåªèƒ½æ¥å—æ•°æ®çš„channelç±»å‹ï¼Œå½“è¯¥contextå…³é—­æˆ–è€…è¶…æ—¶æ—¶é—´åˆ°äº†çš„æ—¶å€™ï¼Œè¯¥channelå°±ä¼šæœ‰ä¸€ä¸ªå–æ¶ˆä¿¡å·</p><p>Err() åœ¨Done() ä¹‹åï¼Œè¿”å›context å–æ¶ˆçš„åŸå› ã€‚</p><p>Deadline() è®¾ç½®è¯¥context cancelçš„æ—¶é—´ç‚¹</p><p>Value() æ–¹æ³•å…è®¸ Context å¯¹è±¡æºå¸¦requestä½œç”¨åŸŸçš„æ•°æ®ï¼Œè¯¥æ•°æ®å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>Context å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½ å¯ä»¥æŠŠä¸€ä¸ª Context å¯¹è±¡ä¼ é€’ç»™ä»»æ„ä¸ªæ•°çš„ gorotuineï¼Œå¯¹å®ƒæ‰§è¡Œ å–æ¶ˆ æ“ä½œæ—¶ï¼Œæ‰€æœ‰ goroutine éƒ½ä¼šæ¥æ”¶åˆ°å–æ¶ˆä¿¡å·ã€‚</p><p>ä¸€ä¸ª Context ä¸èƒ½æ‹¥æœ‰ Cancel æ–¹æ³•ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªèƒ½ Done channel æ¥æ”¶æ•°æ®ã€‚ å…¶ä¸­çš„åŸå› æ˜¯ä¸€è‡´çš„ï¼šæ¥æ”¶å–æ¶ˆä¿¡å·çš„å‡½æ•°å’Œå‘é€ä¿¡å·çš„å‡½æ•°é€šå¸¸ä¸æ˜¯ä¸€ä¸ªã€‚ å…¸å‹çš„åœºæ™¯æ˜¯ï¼šçˆ¶æ“ä½œä¸ºå­æ“ä½œæ“ä½œå¯åŠ¨ goroutineï¼Œå­æ“ä½œä¹Ÿå°±ä¸èƒ½å–æ¶ˆçˆ¶æ“ä½œã€‚</p><h4 id="5-JSON-æ ‡å‡†åº“å¯¹-nil-slice-å’Œ-ç©º-slice-çš„å¤„ç†æ˜¯ä¸€è‡´çš„å—ï¼Ÿ"><a href="#5-JSON-æ ‡å‡†åº“å¯¹-nil-slice-å’Œ-ç©º-slice-çš„å¤„ç†æ˜¯ä¸€è‡´çš„å—ï¼Ÿ" class="headerlink" title="5. JSON æ ‡å‡†åº“å¯¹ nil slice å’Œ ç©º slice çš„å¤„ç†æ˜¯ä¸€è‡´çš„å—ï¼Ÿã€€"></a>5. JSON æ ‡å‡†åº“å¯¹ nil slice å’Œ ç©º slice çš„å¤„ç†æ˜¯ä¸€è‡´çš„å—ï¼Ÿã€€</h4><p>é¦–å…ˆJSON æ ‡å‡†åº“å¯¹ nil slice å’Œ ç©º slice çš„å¤„ç†æ˜¯ä¸ä¸€è‡´.</p><p>é€šå¸¸é”™è¯¯çš„ç”¨æ³•ï¼Œä¼šæŠ¥æ•°ç»„è¶Šç•Œçš„é”™è¯¯ï¼Œå› ä¸ºåªæ˜¯å£°æ˜äº†sliceï¼Œå´æ²¡æœ‰ç»™å®ä¾‹åŒ–çš„å¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var slice []int</span><br><span class="line">slice[1] = 0</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶sliceçš„å€¼æ˜¯nilï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç”¨äºéœ€è¦è¿”å›sliceçš„å‡½æ•°ï¼Œå½“å‡½æ•°å‡ºç°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¿è¯å‡½æ•°ä¾ç„¶ä¼šæœ‰nilçš„è¿”å›å€¼ã€‚</p><p>empty slice æ˜¯æŒ‡sliceä¸ä¸ºnilï¼Œä½†æ˜¯sliceæ²¡æœ‰å€¼ï¼Œsliceçš„åº•å±‚çš„ç©ºé—´æ˜¯ç©ºçš„ï¼Œæ­¤æ—¶çš„å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">slice := make([]int,0ï¼‰</span><br><span class="line">slice := []int&#123;&#125;</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬æŸ¥è¯¢æˆ–è€…å¤„ç†ä¸€ä¸ªç©ºçš„åˆ—è¡¨çš„æ—¶å€™ï¼Œè¿™éå¸¸æœ‰ç”¨ï¼Œå®ƒä¼šå‘Šè¯‰æˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œä½†æ˜¯åˆ—è¡¨å†…æ²¡æœ‰ä»»ä½•å€¼ã€‚</p><p>æ€»ä¹‹ï¼Œnil slice å’Œ empty sliceæ˜¯ä¸åŒçš„ä¸œè¥¿,éœ€è¦æˆ‘ä»¬åŠ ä»¥åŒºåˆ†çš„.</p><h4 id="6-åç¨‹ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹çš„åŒºåˆ«ã€‚"><a href="#6-åç¨‹ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹çš„åŒºåˆ«ã€‚" class="headerlink" title="6. åç¨‹ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹çš„åŒºåˆ«ã€‚"></a>6. åç¨‹ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹çš„åŒºåˆ«ã€‚</h4><ul><li>è¿›ç¨‹</li></ul><p>è¿›ç¨‹æ˜¯å…·æœ‰ä¸€å®šç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºå…³äºæŸä¸ªæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨,è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹é€šè¿‡è¿›ç¨‹é—´é€šä¿¡æ¥é€šä¿¡ã€‚ç”±äºè¿›ç¨‹æ¯”è¾ƒé‡é‡ï¼Œå æ®ç‹¬ç«‹çš„å†…å­˜ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡è¿›ç¨‹é—´çš„åˆ‡æ¢å¼€é”€ï¼ˆæ ˆã€å¯„å­˜å™¨ã€è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶å¥æŸ„ç­‰ï¼‰æ¯”è¾ƒå¤§ï¼Œä½†ç›¸å¯¹æ¯”è¾ƒç¨³å®šå®‰å…¨ã€‚</p><ul><li>çº¿ç¨‹</li></ul><p>çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®ä½“,æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½,å®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½.çº¿ç¨‹è‡ªå·±åŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æº,åªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æº(å¦‚ç¨‹åºè®¡æ•°å™¨,ä¸€ç»„å¯„å­˜å™¨å’Œæ ˆ),ä½†æ˜¯å®ƒå¯ä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çš„çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æºã€‚çº¿ç¨‹é—´é€šä¿¡ä¸»è¦é€šè¿‡å…±äº«å†…å­˜ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¾ˆå¿«ï¼Œèµ„æºå¼€é”€è¾ƒå°‘ï¼Œä½†ç›¸æ¯”è¿›ç¨‹ä¸å¤Ÿç¨³å®šå®¹æ˜“ä¸¢å¤±æ•°æ®ã€‚</p><ul><li>åç¨‹</li></ul><p>åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éå¸¸å¿«ã€‚</p><h4 id="7-äº’æ–¥é”ï¼Œè¯»å†™é”ï¼Œæ­»é”é—®é¢˜æ˜¯æ€ä¹ˆè§£å†³ã€‚"><a href="#7-äº’æ–¥é”ï¼Œè¯»å†™é”ï¼Œæ­»é”é—®é¢˜æ˜¯æ€ä¹ˆè§£å†³ã€‚" class="headerlink" title="7. äº’æ–¥é”ï¼Œè¯»å†™é”ï¼Œæ­»é”é—®é¢˜æ˜¯æ€ä¹ˆè§£å†³ã€‚"></a>7. äº’æ–¥é”ï¼Œè¯»å†™é”ï¼Œæ­»é”é—®é¢˜æ˜¯æ€ä¹ˆè§£å†³ã€‚</h4><ul><li>äº’æ–¥é”</li></ul><p>äº’æ–¥é”å°±æ˜¯äº’æ–¥å˜é‡mutexï¼Œç”¨æ¥é”ä½ä¸´ç•ŒåŒºçš„.</p><p>æ¡ä»¶é”å°±æ˜¯æ¡ä»¶å˜é‡ï¼Œå½“è¿›ç¨‹çš„æŸäº›èµ„æºè¦æ±‚ä¸æ»¡è¶³æ—¶å°±è¿›å…¥ä¼‘çœ ï¼Œä¹Ÿå°±æ˜¯é”ä½äº†ã€‚å½“èµ„æºè¢«åˆ†é…åˆ°äº†ï¼Œæ¡ä»¶é”æ‰“å¼€ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œï¼›è¯»å†™é”ï¼Œä¹Ÿç±»ä¼¼ï¼Œç”¨äºç¼“å†²åŒºç­‰ä¸´ç•Œèµ„æºèƒ½äº’æ–¥è®¿é—®çš„ã€‚</p><ul><li>è¯»å†™é”</li></ul><p>é€šå¸¸æœ‰äº›å…¬å…±æ•°æ®ä¿®æ”¹çš„æœºä¼šå¾ˆå°‘ï¼Œä½†å…¶è¯»çš„æœºä¼šå¾ˆå¤šã€‚å¹¶ä¸”åœ¨è¯»çš„è¿‡ç¨‹ä¸­ä¼šä¼´éšç€æŸ¥æ‰¾ï¼Œç»™è¿™ç§ä»£ç åŠ é”ä¼šé™ä½æˆ‘ä»¬çš„ç¨‹åºæ•ˆç‡ã€‚è¯»å†™é”å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/61.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/61.jpg" alt="img"></a></p><p>æ³¨æ„ï¼šå†™ç‹¬å ï¼Œè¯»å…±äº«ï¼Œå†™é”ä¼˜å…ˆçº§é«˜</p><ul><li>æ­»é”</li></ul><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœåŒä¸€ä¸ªçº¿ç¨‹å…ˆåä¸¤æ¬¡è°ƒç”¨lockï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ï¼Œç”±äºé”å·²ç»è¢«å ç”¨ï¼Œè¯¥çº¿ç¨‹ä¼šæŒ‚èµ·ç­‰å¾…åˆ«çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œç„¶è€Œé”æ­£æ˜¯è¢«è‡ªå·±å ç”¨ç€çš„ï¼Œè¯¥çº¿ç¨‹åˆè¢«æŒ‚èµ·è€Œæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå› æ­¤å°±æ°¸è¿œå¤„äºæŒ‚èµ·ç­‰å¾…çŠ¶æ€äº†ï¼Œè¿™å«åšæ­»é”ï¼ˆDeadlockï¼‰ã€‚ å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ï¼šè‹¥çº¿ç¨‹Aè·å¾—äº†é”1ï¼Œçº¿ç¨‹Bè·å¾—äº†é”2ï¼Œè¿™æ—¶çº¿ç¨‹Aè°ƒç”¨lockè¯•å›¾è·å¾—é”2ï¼Œç»“æœæ˜¯éœ€è¦æŒ‚èµ·ç­‰å¾…çº¿ç¨‹Bé‡Šæ”¾é”2ï¼Œè€Œè¿™æ—¶çº¿ç¨‹Bä¹Ÿè°ƒç”¨lockè¯•å›¾è·å¾—é”1ï¼Œç»“æœæ˜¯éœ€è¦æŒ‚èµ·ç­‰å¾…çº¿ç¨‹Aé‡Šæ”¾é”1ï¼Œäºæ˜¯çº¿ç¨‹Aå’ŒBéƒ½æ°¸è¿œå¤„äºæŒ‚èµ·çŠ¶æ€äº†ã€‚</p><p>æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶:</p><ol><li>äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨</li><li>è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚</li><li>ä¸å‰¥å¤ºæ¡ä»¶:è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚</li><li>å¾ªç¯ç­‰å¾…æ¡ä»¶:è‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚ è¿™å››ä¸ªæ¡ä»¶æ˜¯æ­»é”çš„å¿…è¦æ¡ä»¶ï¼Œåªè¦ç³»ç»Ÿå‘ç”Ÿæ­»é”ï¼Œè¿™äº›æ¡ä»¶å¿…ç„¶æˆç«‹ï¼Œè€Œåªè¦ä¸Šè¿°æ¡ä»¶ä¹‹ä¸€ä¸æ»¡è¶³ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚</li></ol><p>a. é¢„é˜²æ­»é”</p><p>å¯ä»¥æŠŠèµ„æºä¸€æ¬¡æ€§åˆ†é…ï¼šï¼ˆç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼‰</p><p>ç„¶åå‰¥å¤ºèµ„æºï¼šå³å½“æŸè¿›ç¨‹æ–°çš„èµ„æºæœªæ»¡è¶³æ—¶ï¼Œé‡Šæ”¾å·²å æœ‰çš„èµ„æºï¼ˆç ´åä¸å¯å‰¥å¤ºæ¡ä»¶ï¼‰</p><p>èµ„æºæœ‰åºåˆ†é…æ³•ï¼šç³»ç»Ÿç»™æ¯ç±»èµ„æºèµ‹äºˆä¸€ä¸ªç¼–å·ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹æŒ‰ç¼–å·é€’å¢çš„é¡ºåºè¯·æ±‚èµ„æºï¼Œé‡Šæ”¾åˆ™ç›¸åï¼ˆç ´åç¯è·¯ç­‰å¾…æ¡ä»¶ï¼‰</p><p>b. é¿å…æ­»é”</p><p>é¢„é˜²æ­»é”çš„å‡ ç§ç­–ç•¥ï¼Œä¼šä¸¥é‡åœ°æŸå®³ç³»ç»Ÿæ€§èƒ½ã€‚å› æ­¤åœ¨é¿å…æ­»é”æ—¶ï¼Œè¦æ–½åŠ è¾ƒå¼±çš„é™åˆ¶ï¼Œä»è€Œè·å¾— è¾ƒæ»¡æ„çš„ç³»ç»Ÿæ€§èƒ½ã€‚ç”±äºåœ¨é¿å…æ­»é”çš„ç­–ç•¥ä¸­ï¼Œå…è®¸è¿›ç¨‹åŠ¨æ€åœ°ç”³è¯·èµ„æºã€‚å› è€Œï¼Œç³»ç»Ÿåœ¨è¿›è¡Œèµ„æºåˆ†é…ä¹‹å‰é¢„å…ˆè®¡ç®—èµ„æºåˆ†é…çš„å®‰å…¨æ€§ã€‚è‹¥æ­¤æ¬¡åˆ†é…ä¸ä¼šå¯¼è‡´ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œåˆ™å°†èµ„æºåˆ†é…ç»™è¿›ç¨‹ï¼›å¦åˆ™ï¼Œè¿›ç¨‹ç­‰å¾…ã€‚å…¶ä¸­æœ€å…·æœ‰ä»£è¡¨æ€§çš„é¿å…æ­»é”ç®—æ³•æ˜¯é“¶è¡Œå®¶ç®—æ³•ã€‚</p><p>c. æ£€æµ‹æ­»é”</p><p>é¦–å…ˆä¸ºæ¯ä¸ªè¿›ç¨‹å’Œæ¯ä¸ªèµ„æºæŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„å·ç ,ç„¶åå»ºç«‹èµ„æºåˆ†é…è¡¨å’Œè¿›ç¨‹ç­‰å¾…è¡¨.</p><p>d. è§£é™¤æ­»é”</p><p>å½“å‘ç°æœ‰è¿›ç¨‹æ­»é”åï¼Œä¾¿åº”ç«‹å³æŠŠå®ƒä»æ­»é”çŠ¶æ€ä¸­è§£è„±å‡ºæ¥ï¼Œå¸¸é‡‡ç”¨çš„æ–¹æ³•æœ‰.</p><p>e. å‰¥å¤ºèµ„æº</p><p>ä»å…¶å®ƒè¿›ç¨‹å‰¥å¤ºè¶³å¤Ÿæ•°é‡çš„èµ„æºç»™æ­»é”è¿›ç¨‹ï¼Œä»¥è§£é™¤æ­»é”çŠ¶æ€.</p><p>f. æ’¤æ¶ˆè¿›ç¨‹</p><p>å¯ä»¥ç›´æ¥æ’¤æ¶ˆæ­»é”è¿›ç¨‹æˆ–æ’¤æ¶ˆä»£ä»·æœ€å°çš„è¿›ç¨‹ï¼Œç›´è‡³æœ‰è¶³å¤Ÿçš„èµ„æºå¯ç”¨ï¼Œæ­»é”çŠ¶æ€.æ¶ˆé™¤ä¸ºæ­¢.æ‰€è°“ä»£ä»·æ˜¯æŒ‡ä¼˜å…ˆçº§ã€è¿è¡Œä»£ä»·ã€è¿›ç¨‹çš„é‡è¦æ€§å’Œä»·å€¼ç­‰ã€‚</p><h4 id="8-Golangçš„å†…å­˜æ¨¡å‹ï¼Œä¸ºä»€ä¹ˆå°å¯¹è±¡å¤šäº†ä¼šé€ æˆgcå‹åŠ›ã€‚"><a href="#8-Golangçš„å†…å­˜æ¨¡å‹ï¼Œä¸ºä»€ä¹ˆå°å¯¹è±¡å¤šäº†ä¼šé€ æˆgcå‹åŠ›ã€‚" class="headerlink" title="8. Golangçš„å†…å­˜æ¨¡å‹ï¼Œä¸ºä»€ä¹ˆå°å¯¹è±¡å¤šäº†ä¼šé€ æˆgcå‹åŠ›ã€‚"></a>8. Golangçš„å†…å­˜æ¨¡å‹ï¼Œä¸ºä»€ä¹ˆå°å¯¹è±¡å¤šäº†ä¼šé€ æˆgcå‹åŠ›ã€‚</h4><p>é€šå¸¸å°å¯¹è±¡è¿‡å¤šä¼šå¯¼è‡´GCä¸‰è‰²æ³•æ¶ˆè€—è¿‡å¤šçš„GPUã€‚ä¼˜åŒ–æ€è·¯æ˜¯ï¼Œå‡å°‘å¯¹è±¡åˆ†é….</p><h4 id="9-Data-Raceé—®é¢˜æ€ä¹ˆè§£å†³ï¼Ÿèƒ½ä¸èƒ½ä¸åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ"><a href="#9-Data-Raceé—®é¢˜æ€ä¹ˆè§£å†³ï¼Ÿèƒ½ä¸èƒ½ä¸åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ" class="headerlink" title="9. Data Raceé—®é¢˜æ€ä¹ˆè§£å†³ï¼Ÿèƒ½ä¸èƒ½ä¸åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ"></a>9. Data Raceé—®é¢˜æ€ä¹ˆè§£å†³ï¼Ÿèƒ½ä¸èƒ½ä¸åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</h4><p>åŒæ­¥è®¿é—®å…±äº«æ•°æ®æ˜¯å¤„ç†æ•°æ®ç«äº‰çš„ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•.golangåœ¨1.1ä¹‹åå¼•å…¥äº†ç«äº‰æ£€æµ‹æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ go run -race æˆ–è€… go build -raceæ¥è¿›è¡Œé™æ€æ£€æµ‹ã€‚ å…¶åœ¨å†…éƒ¨çš„å®ç°æ˜¯,å¼€å¯å¤šä¸ªåç¨‹æ‰§è¡ŒåŒä¸€ä¸ªå‘½ä»¤ï¼Œ å¹¶ä¸”è®°å½•ä¸‹æ¯ä¸ªå˜é‡çš„çŠ¶æ€.</p><p>ç«äº‰æ£€æµ‹å™¨åŸºäºC/C++çš„ThreadSanitizer è¿è¡Œæ—¶åº“ï¼Œè¯¥åº“åœ¨Googleå†…éƒ¨ä»£ç åŸºåœ°å’ŒChromiumæ‰¾åˆ°è®¸å¤šé”™è¯¯ã€‚è¿™ä¸ªæŠ€æœ¯åœ¨2012å¹´ä¹æœˆé›†æˆåˆ°Goä¸­ï¼Œä»é‚£æ—¶å¼€å§‹ï¼Œå®ƒå·²ç»åœ¨æ ‡å‡†åº“ä¸­æ£€æµ‹åˆ°42ä¸ªç«äº‰æ¡ä»¶ã€‚ç°åœ¨ï¼Œå®ƒå·²ç»æ˜¯æˆ‘ä»¬æŒç»­æ„å»ºè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå½“ç«äº‰æ¡ä»¶å‡ºç°æ—¶ï¼Œå®ƒä¼šç»§ç»­æ•æ‰åˆ°è¿™äº›é”™è¯¯ã€‚</p><p>ç«äº‰æ£€æµ‹å™¨å·²ç»å®Œå…¨é›†æˆåˆ°Goå·¥å…·é“¾ä¸­ï¼Œä»…ä»…æ·»åŠ -raceæ ‡å¿—åˆ°å‘½ä»¤è¡Œå°±ä½¿ç”¨äº†æ£€æµ‹å™¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ go test -race mypkg    // æµ‹è¯•åŒ…</span><br><span class="line">$ go run -race mysrc.go  // ç¼–è¯‘å’Œè¿è¡Œç¨‹åº</span><br><span class="line">$ go build -race mycmd   // æ„å»ºç¨‹åº</span><br><span class="line">$ go install -race mypkg // å®‰è£…ç¨‹åº</span><br></pre></td></tr></table></figure><p>è¦æƒ³è§£å†³æ•°æ®ç«äº‰çš„é—®é¢˜å¯ä»¥ä½¿ç”¨äº’æ–¥é”sync.Mutex,è§£å†³æ•°æ®ç«äº‰(Data race),ä¹Ÿå¯ä»¥ä½¿ç”¨ç®¡é“è§£å†³,ä½¿ç”¨ç®¡é“çš„æ•ˆç‡è¦æ¯”äº’æ–¥é”é«˜.</p><h4 id="10-ä»€ä¹ˆæ˜¯channelï¼Œä¸ºä»€ä¹ˆå®ƒå¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨ï¼Ÿ"><a href="#10-ä»€ä¹ˆæ˜¯channelï¼Œä¸ºä»€ä¹ˆå®ƒå¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨ï¼Ÿ" class="headerlink" title="10. ä»€ä¹ˆæ˜¯channelï¼Œä¸ºä»€ä¹ˆå®ƒå¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨ï¼Ÿ"></a>10. ä»€ä¹ˆæ˜¯channelï¼Œä¸ºä»€ä¹ˆå®ƒå¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨ï¼Ÿ</h4><p>Channelæ˜¯Goä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»å‹ï¼Œå¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªç®¡é“ï¼Œé€šè¿‡å®ƒå¹¶å‘æ ¸å¿ƒå•å…ƒå°±å¯ä»¥å‘é€æˆ–è€…æ¥æ”¶æ•°æ®è¿›è¡Œé€šè®¯(communication),Channelä¹Ÿå¯ä»¥ç†è§£æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œé€šè¿‡ç®¡é“è¿›è¡Œé€šä¿¡ã€‚</p><p>Golangçš„Channel,å‘é€ä¸€ä¸ªæ•°æ®åˆ°Channel å’Œ ä»Channelæ¥æ”¶ä¸€ä¸ªæ•°æ® éƒ½æ˜¯ åŸå­æ€§çš„ã€‚è€Œä¸”Goçš„è®¾è®¡æ€æƒ³å°±æ˜¯:ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼Œå‰è€…å°±æ˜¯ä¼ ç»Ÿçš„åŠ é”ï¼Œåè€…å°±æ˜¯Channelã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¾è®¡Channelçš„ä¸»è¦ç›®çš„å°±æ˜¯åœ¨å¤šä»»åŠ¡é—´ä¼ é€’æ•°æ®çš„ï¼Œè¿™å½“ç„¶æ˜¯å®‰å…¨çš„ã€‚</p><h4 id="11-EpollåŸç†"><a href="#11-EpollåŸç†" class="headerlink" title="11. EpollåŸç†."></a>11. EpollåŸç†.</h4><p>å¼€å‘é«˜æ€§èƒ½ç½‘ç»œç¨‹åºæ—¶ï¼Œwindowså¼€å‘è€…ä»¬è¨€å¿…ç§°Iocpï¼Œlinuxå¼€å‘è€…ä»¬åˆ™è¨€å¿…ç§°Epollã€‚å¤§å®¶éƒ½æ˜ç™½Epollæ˜¯ä¸€ç§IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå¯ä»¥éå¸¸é«˜æ•ˆçš„å¤„ç†æ•°ä»¥ç™¾ä¸‡è®¡çš„Socketå¥æŸ„ï¼Œæ¯”èµ·ä»¥å‰çš„Selectå’ŒPollæ•ˆç‡æé«˜äº†å¾ˆå¤šã€‚</p><p>å…ˆç®€å•äº†è§£ä¸‹å¦‚ä½•ä½¿ç”¨Cåº“å°è£…çš„3ä¸ªepollç³»ç»Ÿè°ƒç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int epoll_create(int size);  </span><br><span class="line">int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event);  </span><br><span class="line">int epoll_wait(int epfd, struct epoll_event *events,int maxevents, int timeout);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨èµ·æ¥å¾ˆæ¸…æ™°ï¼Œé¦–å…ˆè¦è°ƒç”¨<code>epoll_create</code>å»ºç«‹ä¸€ä¸ªepollå¯¹è±¡ã€‚å‚æ•°sizeæ˜¯å†…æ ¸ä¿è¯èƒ½å¤Ÿæ­£ç¡®å¤„ç†çš„æœ€å¤§å¥æŸ„æ•°ï¼Œå¤šäºè¿™ä¸ªæœ€å¤§æ•°æ—¶å†…æ ¸å¯ä¸ä¿è¯æ•ˆæœã€‚ epoll_ctlå¯ä»¥æ“ä½œä¸Šé¢å»ºç«‹çš„epollï¼Œä¾‹å¦‚ï¼Œå°†åˆšå»ºç«‹çš„<code>socket</code>åŠ å…¥åˆ°epollä¸­è®©å…¶ç›‘æ§ï¼Œæˆ–è€…æŠŠ epollæ­£åœ¨ç›‘æ§çš„æŸä¸ªsocketå¥æŸ„ç§»å‡ºepollï¼Œä¸å†ç›‘æ§å®ƒç­‰ç­‰ã€‚</p><p><code>epoll_wait</code>åœ¨è°ƒç”¨æ—¶ï¼Œåœ¨ç»™å®šçš„timeoutæ—¶é—´å†…ï¼Œå½“åœ¨ç›‘æ§çš„æ‰€æœ‰å¥æŸ„ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±è¿”å›ç”¨æˆ·æ€çš„è¿›ç¨‹ã€‚</p><p>ä»è°ƒç”¨æ–¹å¼å°±å¯ä»¥çœ‹åˆ°epollç›¸æ¯”select/pollçš„ä¼˜è¶Šä¹‹å¤„æ˜¯,å› ä¸ºåè€…æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¦ä¼ é€’ä½ æ‰€è¦ç›‘æ§çš„æ‰€æœ‰socketç»™select/pollç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ„å‘³ç€éœ€è¦å°†ç”¨æˆ·æ€çš„socketåˆ—è¡¨copyåˆ°å†…æ ¸æ€ï¼Œå¦‚æœä»¥ä¸‡è®¡çš„å¥æŸ„ä¼šå¯¼è‡´æ¯æ¬¡éƒ½è¦copyå‡ åå‡ ç™¾KBçš„å†…å­˜åˆ°å†…æ ¸æ€ï¼Œéå¸¸ä½æ•ˆã€‚è€Œæˆ‘ä»¬è°ƒç”¨<code>epoll_wait</code>æ—¶å°±ç›¸å½“äºä»¥å¾€è°ƒç”¨select/pollï¼Œä½†æ˜¯è¿™æ—¶å´ä¸ç”¨ä¼ é€’socketå¥æŸ„ç»™å†…æ ¸ï¼Œå› ä¸ºå†…æ ¸å·²ç»åœ¨epoll_ctlä¸­æ‹¿åˆ°äº†è¦ç›‘æ§çš„å¥æŸ„åˆ—è¡¨ã€‚</p><p>æ‰€ä»¥ï¼Œå®é™…ä¸Šåœ¨ä½ è°ƒç”¨<code>epoll_create</code>åï¼Œå†…æ ¸å°±å·²ç»åœ¨å†…æ ¸æ€å¼€å§‹å‡†å¤‡å¸®ä½ å­˜å‚¨è¦ç›‘æ§çš„å¥æŸ„äº†ï¼Œæ¯æ¬¡è°ƒç”¨<code>epoll_ctl</code>åªæ˜¯åœ¨å¾€å†…æ ¸çš„æ•°æ®ç»“æ„é‡Œå¡å…¥æ–°çš„socketå¥æŸ„ã€‚</p><p>åœ¨å†…æ ¸é‡Œï¼Œä¸€åˆ‡çš†æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œepollå‘å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºå­˜å‚¨ä¸Šè¿°çš„è¢«ç›‘æ§socketã€‚å½“ä½ è°ƒç”¨epoll_createæ—¶ï¼Œå°±ä¼šåœ¨è¿™ä¸ªè™šæ‹Ÿçš„epollæ–‡ä»¶ç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªfileç»“ç‚¹ã€‚å½“ç„¶è¿™ä¸ªfileä¸æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå®ƒåªæœåŠ¡äºepollã€‚</p><p>epollåœ¨è¢«å†…æ ¸åˆå§‹åŒ–æ—¶ï¼ˆæ“ä½œç³»ç»Ÿå¯åŠ¨ï¼‰ï¼ŒåŒæ—¶ä¼šå¼€è¾Ÿå‡ºepollè‡ªå·±çš„å†…æ ¸é«˜é€ŸcacheåŒºï¼Œç”¨äºå®‰ç½®æ¯ä¸€ä¸ªæˆ‘ä»¬æƒ³ç›‘æ§çš„socketï¼Œè¿™äº›socketä¼šä»¥çº¢é»‘æ ‘çš„å½¢å¼ä¿å­˜åœ¨å†…æ ¸cacheé‡Œï¼Œä»¥æ”¯æŒå¿«é€Ÿçš„æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ã€‚è¿™ä¸ªå†…æ ¸é«˜é€ŸcacheåŒºï¼Œå°±æ˜¯å»ºç«‹è¿ç»­çš„ç‰©ç†å†…å­˜é¡µï¼Œç„¶ååœ¨ä¹‹ä¸Šå»ºç«‹slabå±‚ï¼Œé€šå¸¸æ¥è®²ï¼Œå°±æ˜¯ç‰©ç†ä¸Šåˆ†é…å¥½ä½ æƒ³è¦çš„sizeçš„å†…å­˜å¯¹è±¡ï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶éƒ½æ˜¯ä½¿ç”¨ç©ºé—²çš„å·²åˆ†é…å¥½çš„å¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static int __init eventpoll_init(void)  &#123;  </span><br><span class="line">    ... ...  </span><br><span class="line">  </span><br><span class="line">    /* Allocates slab cache used to allocate &quot;struct epitem&quot; items */  </span><br><span class="line">    epi_cache = kmem_cache_create(&quot;eventpoll_epi&quot;, sizeof(struct epitem),  </span><br><span class="line">            0, SLAB_HWCACHE_ALIGN|EPI_SLAB_DEBUG|SLAB_PANIC,  </span><br><span class="line">            NULL, NULL);  </span><br><span class="line">  </span><br><span class="line">    /* Allocates slab cache used to allocate &quot;struct eppoll_entry&quot; */  </span><br><span class="line">    pwq_cache = kmem_cache_create(&quot;eventpoll_pwq&quot;,  </span><br><span class="line">            sizeof(struct eppoll_entry), 0,  </span><br><span class="line">            EPI_SLAB_DEBUG|SLAB_PANIC, NULL, NULL);  </span><br><span class="line"> ... ...  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>epollçš„é«˜æ•ˆå°±åœ¨äºï¼Œå½“æˆ‘ä»¬è°ƒç”¨<code>epoll_ctl</code>å¾€é‡Œå¡å…¥ç™¾ä¸‡ä¸ªå¥æŸ„æ—¶ï¼Œ<code>epoll_wait</code>ä»ç„¶å¯ä»¥é£å¿«çš„è¿”å›ï¼Œå¹¶æœ‰æ•ˆçš„å°†å‘ç”Ÿäº‹ä»¶çš„å¥æŸ„ç»™æˆ‘ä»¬ç”¨æˆ·ã€‚è¿™æ˜¯ç”±äºæˆ‘ä»¬åœ¨è°ƒç”¨<code>epoll_create</code>æ—¶ï¼Œå†…æ ¸é™¤äº†å¸®æˆ‘ä»¬åœ¨epollæ–‡ä»¶ç³»ç»Ÿé‡Œå»ºäº†ä¸ªfileç»“ç‚¹ï¼Œåœ¨å†…æ ¸cacheé‡Œå»ºäº†ä¸ªçº¢é»‘æ ‘ç”¨äºå­˜å‚¨ä»¥åepoll_ctlä¼ æ¥çš„socketå¤–ï¼Œè¿˜ä¼šå†å»ºç«‹ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ï¼Œå½“epoll_waitè°ƒç”¨æ—¶ï¼Œä»…ä»…è§‚å¯Ÿè¿™ä¸ªlisté“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®å³å¯ã€‚æœ‰æ•°æ®å°±è¿”å›ï¼Œæ²¡æœ‰æ•°æ®å°±sleepï¼Œç­‰åˆ°timeoutæ—¶é—´åˆ°åå³ä½¿é“¾è¡¨æ²¡æ•°æ®ä¹Ÿè¿”å›ã€‚æ‰€ä»¥ï¼Œepoll_waitéå¸¸é«˜æ•ˆã€‚</p><p>è€Œä¸”ï¼Œé€šå¸¸æƒ…å†µä¸‹å³ä½¿æˆ‘ä»¬è¦ç›‘æ§ç™¾ä¸‡è®¡çš„å¥æŸ„ï¼Œå¤§å¤šä¸€æ¬¡ä¹Ÿåªè¿”å›å¾ˆå°‘é‡çš„å‡†å¤‡å°±ç»ªå¥æŸ„è€Œå·²ï¼Œæ‰€ä»¥ï¼Œepoll_waitä»…éœ€è¦ä»å†…æ ¸æ€copyå°‘é‡çš„å¥æŸ„åˆ°ç”¨æˆ·æ€è€Œå·²ï¼Œå› æ­¤å°±ä¼šéå¸¸çš„é«˜æ•ˆï¼</p><p>ç„¶è€Œ,è¿™ä¸ªå‡†å¤‡å°±ç»ªlisté“¾è¡¨æ˜¯æ€ä¹ˆç»´æŠ¤çš„å‘¢ï¼Ÿå½“æˆ‘ä»¬æ‰§è¡Œepoll_ctlæ—¶ï¼Œé™¤äº†æŠŠsocketæ”¾åˆ°epollæ–‡ä»¶ç³»ç»Ÿé‡Œfileå¯¹è±¡å¯¹åº”çš„çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜ä¼šç»™å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‘Šè¯‰å†…æ ¸ï¼Œå¦‚æœè¿™ä¸ªå¥æŸ„çš„ä¸­æ–­åˆ°äº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°å‡†å¤‡å°±ç»ªlisté“¾è¡¨é‡Œã€‚æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åå°±æ¥æŠŠsocketæ’å…¥åˆ°å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œäº†ã€‚</p><p>å¦‚æ­¤ï¼Œä¸€ä¸ªçº¢é»‘æ ‘ï¼Œä¸€å¼ å‡†å¤‡å°±ç»ªå¥æŸ„é“¾è¡¨ï¼Œå°‘é‡çš„å†…æ ¸cacheï¼Œå°±å¸®æˆ‘ä»¬è§£å†³äº†å¤§å¹¶å‘ä¸‹çš„socketå¤„ç†é—®é¢˜ã€‚æ‰§è¡Œ<code>epoll_create</code>æ—¶ï¼Œåˆ›å»ºäº†çº¢é»‘æ ‘å’Œå°±ç»ªé“¾è¡¨ï¼Œæ‰§è¡Œepoll_ctlæ—¶ï¼Œå¦‚æœå¢åŠ socketå¥æŸ„ï¼Œåˆ™æ£€æŸ¥åœ¨çº¢é»‘æ ‘ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ç«‹å³è¿”å›ï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°æ ‘å¹²ä¸Šï¼Œç„¶åå‘å†…æ ¸æ³¨å†Œå›è°ƒå‡½æ•°ï¼Œç”¨äºå½“ä¸­æ–­äº‹ä»¶æ¥ä¸´æ—¶å‘å‡†å¤‡å°±ç»ªé“¾è¡¨ä¸­æ’å…¥æ•°æ®ã€‚æ‰§è¡Œepoll_waitæ—¶ç«‹åˆ»è¿”å›å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œçš„æ•°æ®å³å¯ã€‚</p><p>æœ€åçœ‹çœ‹epollç‹¬æœ‰çš„ä¸¤ç§æ¨¡å¼LTå’ŒETã€‚æ— è®ºæ˜¯LTå’ŒETæ¨¡å¼ï¼Œéƒ½é€‚ç”¨äºä»¥ä¸Šæ‰€è¯´çš„æµç¨‹ã€‚åŒºåˆ«æ˜¯ï¼ŒLTæ¨¡å¼ä¸‹ï¼Œåªè¦ä¸€ä¸ªå¥æŸ„ä¸Šçš„äº‹ä»¶ä¸€æ¬¡æ²¡æœ‰å¤„ç†å®Œï¼Œä¼šåœ¨ä»¥åè°ƒç”¨epoll_waitæ—¶æ¯æ¬¡è¿”å›è¿™ä¸ªå¥æŸ„ï¼Œè€ŒETæ¨¡å¼ä»…åœ¨ç¬¬ä¸€æ¬¡è¿”å›ã€‚</p><p>å½“ä¸€ä¸ªsocketå¥æŸ„ä¸Šæœ‰äº‹ä»¶æ—¶ï¼Œå†…æ ¸ä¼šæŠŠè¯¥å¥æŸ„æ’å…¥ä¸Šé¢æ‰€è¯´çš„å‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œè¿™æ—¶æˆ‘ä»¬è°ƒç”¨<code>epoll_wait</code>ï¼Œä¼šæŠŠå‡†å¤‡å°±ç»ªçš„socketæ‹·è´åˆ°ç”¨æˆ·æ€å†…å­˜ï¼Œç„¶åæ¸…ç©ºå‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œæœ€åï¼Œ<code>epoll_wait</code>éœ€è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æ£€æŸ¥è¿™äº›socketï¼Œå¦‚æœä¸æ˜¯ETæ¨¡å¼ï¼ˆå°±æ˜¯LTæ¨¡å¼çš„å¥æŸ„äº†ï¼‰ï¼Œå¹¶ä¸”è¿™äº›socketä¸Šç¡®å®æœ‰æœªå¤„ç†çš„äº‹ä»¶æ—¶ï¼ŒåˆæŠŠè¯¥å¥æŸ„æ”¾å›åˆ°åˆšåˆšæ¸…ç©ºçš„å‡†å¤‡å°±ç»ªé“¾è¡¨äº†ã€‚æ‰€ä»¥ï¼ŒéETçš„å¥æŸ„ï¼Œåªè¦å®ƒä¸Šé¢è¿˜æœ‰äº‹ä»¶ï¼Œepoll_waitæ¯æ¬¡éƒ½ä¼šè¿”å›ã€‚è€ŒETæ¨¡å¼çš„å¥æŸ„ï¼Œé™¤éæœ‰æ–°ä¸­æ–­åˆ°ï¼Œå³ä½¿socketä¸Šçš„äº‹ä»¶æ²¡æœ‰å¤„ç†å®Œï¼Œä¹Ÿæ˜¯ä¸ä¼šæ¯æ¬¡ä»epoll_waitè¿”å›çš„ã€‚</p><p>å› æ­¤epollæ¯”selectçš„æé«˜å®é™…ä¸Šæ˜¯ä¸€ä¸ªç”¨ç©ºé—´æ¢æ—¶é—´æ€æƒ³çš„å…·ä½“åº”ç”¨.å¯¹æ¯”é˜»å¡IOçš„å¤„ç†æ¨¡å‹, å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†å¤šè·¯å¤ç”¨IOä¹‹å, ç¨‹åºå¯ä»¥è‡ªç”±çš„è¿›è¡Œè‡ªå·±é™¤äº†IOæ“ä½œä¹‹å¤–çš„å·¥ä½œ, åªæœ‰åˆ°IOçŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ç”±å¤šè·¯å¤ç”¨IOè¿›è¡Œé€šçŸ¥, ç„¶åå†é‡‡å–ç›¸åº”çš„æ“ä½œ, è€Œä¸ç”¨ä¸€ç›´é˜»å¡ç­‰å¾…IOçŠ¶æ€å‘ç”Ÿå˜åŒ–,æé«˜æ•ˆç‡.</p><h4 id="12-Golang-GC-æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ"><a href="#12-Golang-GC-æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ" class="headerlink" title="12. Golang GC æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ?"></a>12. Golang GC æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ?</h4><p>é¦–å…ˆæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹åƒåœ¾å›æ”¶.ä»€ä¹ˆæ˜¯åƒåœ¾å›æ”¶ï¼Ÿ</p><p>å†…å­˜ç®¡ç†æ˜¯ç¨‹åºå‘˜å¼€å‘åº”ç”¨çš„ä¸€å¤§éš¾é¢˜ã€‚ä¼ ç»Ÿçš„ç³»ç»Ÿçº§ç¼–ç¨‹è¯­è¨€ï¼ˆä¸»è¦æŒ‡C/C++ï¼‰ä¸­ï¼Œç¨‹åºå¼€å‘è€…å¿…é¡»å¯¹å†…å­˜å°å¿ƒçš„è¿›è¡Œç®¡ç†æ“ä½œï¼Œæ§åˆ¶å†…å­˜çš„ç”³è¯·åŠé‡Šæ”¾ã€‚å› ä¸ºç¨æœ‰ä¸æ…ï¼Œå°±å¯èƒ½äº§ç”Ÿå†…å­˜æ³„éœ²é—®é¢˜ï¼Œè¿™ç§é—®é¢˜ä¸æ˜“å‘ç°å¹¶ä¸”éš¾ä»¥å®šä½ï¼Œä¸€ç›´æˆä¸ºå›°æ‰°ç¨‹åºå¼€å‘è€…çš„å™©æ¢¦ã€‚å¦‚ä½•è§£å†³è¿™ä¸ªå¤´ç–¼çš„é—®é¢˜å‘¢ï¼Ÿ</p><p>è¿‡å»ä¸€èˆ¬é‡‡ç”¨ä¸¤ç§åŠæ³•ï¼š</p><ul><li>å†…å­˜æ³„éœ²æ£€æµ‹å·¥å…·ã€‚è¿™ç§å·¥å…·çš„åŸç†ä¸€èˆ¬æ˜¯é™æ€ä»£ç æ‰«æï¼Œé€šè¿‡æ‰«æç¨‹åºæ£€æµ‹å¯èƒ½å‡ºç°å†…å­˜æ³„éœ²çš„ä»£ç æ®µã€‚ç„¶è€Œæ£€æµ‹å·¥å…·éš¾å…æœ‰ç–æ¼å’Œä¸è¶³ï¼Œåªèƒ½èµ·åˆ°è¾…åŠ©ä½œç”¨ã€‚</li><li>æ™ºèƒ½æŒ‡é’ˆã€‚è¿™æ˜¯ c++ ä¸­å¼•å…¥çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æ–¹æ³•ï¼Œé€šè¿‡æ‹¥æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†åŠŸèƒ½çš„æŒ‡é’ˆå¯¹è±¡æ¥å¼•ç”¨å¯¹è±¡ï¼Œæ˜¯ç¨‹åºå‘˜ä¸ç”¨å¤ªå…³æ³¨å†…å­˜çš„é‡Šæ”¾ï¼Œè€Œè¾¾åˆ°å†…å­˜è‡ªåŠ¨é‡Šæ”¾çš„ç›®çš„ã€‚è¿™ç§æ–¹æ³•æ˜¯é‡‡ç”¨æœ€å¹¿æ³›çš„åšæ³•ï¼Œä½†æ˜¯å¯¹ç¨‹åºå¼€å‘è€…æœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬ï¼ˆå¹¶éè¯­è¨€å±‚é¢çš„åŸç”Ÿæ”¯æŒï¼‰ï¼Œè€Œä¸”ä¸€æ—¦æœ‰å¿˜è®°ä½¿ç”¨çš„åœºæ™¯ä¾ç„¶æ— æ³•é¿å…å†…å­˜æ³„éœ²ã€‚</li></ul><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåæ¥å¼€å‘å‡ºæ¥çš„å‡ ä¹æ‰€æœ‰æ–°è¯­è¨€ï¼ˆjavaï¼Œpythonï¼Œphpç­‰ç­‰ï¼‰éƒ½å¼•å…¥äº†è¯­è¨€å±‚é¢çš„è‡ªåŠ¨å†…å­˜ç®¡ç† â€“ ä¹Ÿå°±æ˜¯è¯­è¨€çš„ä½¿ç”¨è€…åªç”¨å…³æ³¨å†…å­˜çš„ç”³è¯·è€Œä¸å¿…å…³å¿ƒå†…å­˜çš„é‡Šæ”¾ï¼Œå†…å­˜é‡Šæ”¾ç”±è™šæ‹Ÿæœºï¼ˆvirtual machineï¼‰æˆ–è¿è¡Œæ—¶ï¼ˆruntimeï¼‰æ¥è‡ªåŠ¨è¿›è¡Œç®¡ç†ã€‚è€Œè¿™ç§å¯¹ä¸å†ä½¿ç”¨çš„å†…å­˜èµ„æºè¿›è¡Œè‡ªåŠ¨å›æ”¶çš„è¡Œä¸ºå°±è¢«ç§°ä¸ºåƒåœ¾å›æ”¶ã€‚</p><p>å¸¸ç”¨çš„åƒåœ¾å›æ”¶çš„æ–¹æ³•:</p><ul><li>å¼•ç”¨è®¡æ•°ï¼ˆreference countingï¼‰</li></ul><p>è¿™æ˜¯æœ€ç®€å•çš„ä¸€ç§åƒåœ¾å›æ”¶ç®—æ³•ï¼Œå’Œä¹‹å‰æåˆ°çš„æ™ºèƒ½æŒ‡é’ˆå¼‚æ›²åŒå·¥ã€‚å¯¹æ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è¯¥å¯¹è±¡çš„å¯¹è±¡è¢«é”€æ¯æˆ–æ›´æ–°æ—¶è¢«å¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è‡ªåŠ¨å‡ä¸€ï¼Œå½“è¢«å¼•ç”¨å¯¹è±¡è¢«åˆ›å»ºæˆ–è¢«èµ‹å€¼ç»™å…¶ä»–å¯¹è±¡æ—¶å¼•ç”¨è®¡æ•°è‡ªåŠ¨åŠ ä¸€ã€‚å½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶åˆ™ç«‹å³å›æ”¶å¯¹è±¡ã€‚</p><p>è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯å®ç°ç®€å•ï¼Œå¹¶ä¸”å†…å­˜çš„å›æ”¶å¾ˆåŠæ—¶ã€‚è¿™ç§ç®—æ³•åœ¨å†…å­˜æ¯”è¾ƒç´§å¼ å’Œå®æ—¶æ€§æ¯”è¾ƒé«˜çš„ç³»ç»Ÿä¸­ä½¿ç”¨çš„æ¯”è¾ƒå¹¿æ³›ï¼Œå¦‚ios cocoaæ¡†æ¶ï¼Œphpï¼Œpythonç­‰ã€‚</p><p>ä½†æ˜¯ç®€å•å¼•ç”¨è®¡æ•°ç®—æ³•ä¹Ÿæœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼š</p><ol><li>é¢‘ç¹æ›´æ–°å¼•ç”¨è®¡æ•°é™ä½äº†æ€§èƒ½ã€‚</li></ol><p>ä¸€ç§ç®€å•çš„è§£å†³æ–¹æ³•å°±æ˜¯ç¼–è¯‘å™¨å°†ç›¸é‚»çš„å¼•ç”¨è®¡æ•°æ›´æ–°æ“ä½œåˆå¹¶åˆ°ä¸€æ¬¡æ›´æ–°ï¼›è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯é’ˆå¯¹é¢‘ç¹å‘ç”Ÿçš„ä¸´æ—¶å˜é‡å¼•ç”¨ä¸è¿›è¡Œè®¡æ•°ï¼Œè€Œæ˜¯åœ¨å¼•ç”¨è¾¾åˆ°0æ—¶é€šè¿‡æ‰«æå †æ ˆç¡®è®¤æ˜¯å¦è¿˜æœ‰ä¸´æ—¶å¯¹è±¡å¼•ç”¨è€Œå†³å®šæ˜¯å¦é‡Šæ”¾ã€‚ç­‰ç­‰è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œã€‚</p><ol><li>å¾ªç¯å¼•ç”¨ã€‚</li></ol><p>å½“å¯¹è±¡é—´å‘ç”Ÿå¾ªç¯å¼•ç”¨æ—¶å¼•ç”¨é“¾ä¸­çš„å¯¹è±¡éƒ½æ— æ³•å¾—åˆ°é‡Šæ”¾ã€‚æœ€æ˜æ˜¾çš„è§£å†³åŠæ³•æ˜¯é¿å…äº§ç”Ÿå¾ªç¯å¼•ç”¨ï¼Œå¦‚cocoaå¼•å…¥äº†strongæŒ‡é’ˆå’ŒweakæŒ‡é’ˆä¸¤ç§æŒ‡é’ˆç±»å‹ã€‚æˆ–è€…ç³»ç»Ÿæ£€æµ‹å¾ªç¯å¼•ç”¨å¹¶ä¸»åŠ¨æ‰“ç ´å¾ªç¯é“¾ã€‚å½“ç„¶è¿™ä¹Ÿå¢åŠ äº†åƒåœ¾å›æ”¶çš„å¤æ‚åº¦ã€‚</p><ul><li>æ ‡è®°-æ¸…é™¤ï¼ˆmark and sweepï¼‰</li></ul><p>æ ‡è®°-æ¸…é™¤ï¼ˆmark and sweepï¼‰åˆ†ä¸ºä¸¤æ­¥ï¼Œæ ‡è®°ä»æ ¹å˜é‡å¼€å§‹è¿­ä»£å¾—éå†æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå¯¹èƒ½å¤Ÿé€šè¿‡åº”ç”¨éå†è®¿é—®åˆ°çš„å¯¹è±¡éƒ½è¿›è¡Œæ ‡è®°ä¸ºâ€œè¢«å¼•ç”¨â€ï¼›æ ‡è®°å®Œæˆåè¿›è¡Œæ¸…é™¤æ“ä½œï¼Œå¯¹æ²¡æœ‰æ ‡è®°è¿‡çš„å†…å­˜è¿›è¡Œå›æ”¶ï¼ˆå›æ”¶åŒæ—¶å¯èƒ½ä¼´æœ‰ç¢ç‰‡æ•´ç†æ“ä½œï¼‰ã€‚è¿™ç§æ–¹æ³•è§£å†³äº†å¼•ç”¨è®¡æ•°çš„ä¸è¶³ï¼Œä½†æ˜¯ä¹Ÿæœ‰æ¯”è¾ƒæ˜æ˜¾çš„é—®é¢˜ï¼šæ¯æ¬¡å¯åŠ¨åƒåœ¾å›æ”¶éƒ½ä¼šæš‚åœå½“å‰æ‰€æœ‰çš„æ­£å¸¸ä»£ç æ‰§è¡Œï¼Œå›æ”¶æ˜¯ç³»ç»Ÿå“åº”èƒ½åŠ›å¤§å¤§é™ä½ï¼å½“ç„¶åç»­ä¹Ÿå‡ºç°äº†å¾ˆå¤šmark&amp;sweepç®—æ³•çš„å˜ç§ï¼ˆå¦‚ä¸‰è‰²æ ‡è®°æ³•ï¼‰ä¼˜åŒ–äº†è¿™ä¸ªé—®é¢˜ã€‚</p><ul><li>åˆ†ä»£æœé›†ï¼ˆgenerationï¼‰</li></ul><p>javaçš„jvm å°±ä½¿ç”¨çš„åˆ†ä»£å›æ”¶çš„æ€è·¯ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œç»å¤§å¤šæ•°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸéƒ½éå¸¸çŸ­ã€‚åˆ†ä»£æ”¶é›†çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå°†å †åˆ’åˆ†ä¸ºä¸¤ä¸ªæˆ–å¤šä¸ªç§°ä¸ºä»£ï¼ˆgenerationï¼‰çš„ç©ºé—´ã€‚æ–°åˆ›å»ºçš„å¯¹è±¡å­˜æ”¾åœ¨ç§°ä¸ºæ–°ç”Ÿä»£ï¼ˆyoung generationï¼‰ä¸­ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ–°ç”Ÿä»£çš„å¤§å°ä¼šæ¯” è€å¹´ä»£å°å¾ˆå¤šï¼‰ï¼Œéšç€åƒåœ¾å›æ”¶çš„é‡å¤æ‰§è¡Œï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡ä¼šè¢«æå‡ï¼ˆpromotionï¼‰åˆ°è€å¹´ä»£ä¸­ï¼ˆè¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªåˆ†ç±»çš„æ€è·¯ï¼Œè¿™ä¸ªæ˜¯ä¹Ÿæ˜¯ç§‘å­¦æ€è€ƒçš„ä¸€ä¸ªåŸºæœ¬æ€è·¯ï¼‰ã€‚</p><p>å› æ­¤ï¼Œæ–°ç”Ÿä»£åƒåœ¾å›æ”¶å’Œè€å¹´ä»£åƒåœ¾å›æ”¶ä¸¤ç§ä¸åŒçš„åƒåœ¾å›æ”¶æ–¹å¼åº”è¿è€Œç”Ÿï¼Œåˆ†åˆ«ç”¨äºå¯¹å„è‡ªç©ºé—´ä¸­çš„å¯¹è±¡æ‰§è¡Œåƒåœ¾å›æ”¶ã€‚æ–°ç”Ÿä»£åƒåœ¾å›æ”¶çš„é€Ÿåº¦éå¸¸å¿«ï¼Œæ¯”è€å¹´ä»£å¿«å‡ ä¸ªæ•°é‡çº§ï¼Œå³ä½¿æ–°ç”Ÿä»£åƒåœ¾å›æ”¶çš„é¢‘ç‡æ›´é«˜ï¼Œæ‰§è¡Œæ•ˆç‡ä¹Ÿä»ç„¶æ¯”è€å¹´ä»£åƒåœ¾å›æ”¶å¼ºï¼Œè¿™æ˜¯å› ä¸ºå¤§å¤šæ•°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸéƒ½å¾ˆçŸ­ï¼Œæ ¹æœ¬æ— éœ€æå‡åˆ°è€å¹´ä»£ã€‚</p><p>Golang GC æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ?</p><p>Golang 1.5åï¼Œé‡‡å–çš„æ˜¯â€œéåˆ†ä»£çš„ã€éç§»åŠ¨çš„ã€å¹¶å‘çš„ã€ä¸‰è‰²çš„â€æ ‡è®°æ¸…é™¤åƒåœ¾å›æ”¶ç®—æ³•ã€‚</p><p>golang ä¸­çš„ gc åŸºæœ¬ä¸Šæ˜¯æ ‡è®°æ¸…é™¤çš„è¿‡ç¨‹ï¼š</p><p><a href="https://github.com/KeKe-Li/For-learning-Go-Tutorial/blob/master/src/images/2.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/For-learning-Go-Tutorial/raw/master/src/images/2.jpg" alt="img"></a></p><p>gcçš„è¿‡ç¨‹ä¸€å…±åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š</p><ol><li>æ ˆæ‰«æï¼ˆå¼€å§‹æ—¶STWï¼‰</li><li>ç¬¬ä¸€æ¬¡æ ‡è®°ï¼ˆå¹¶å‘ï¼‰</li><li>ç¬¬äºŒæ¬¡æ ‡è®°ï¼ˆSTWï¼‰</li><li>æ¸…é™¤ï¼ˆå¹¶å‘ï¼‰</li></ol><p>æ•´ä¸ªè¿›ç¨‹ç©ºé—´é‡Œç”³è¯·æ¯ä¸ªå¯¹è±¡å æ®çš„å†…å­˜å¯ä»¥è§†ä¸ºä¸€ä¸ªå›¾ï¼Œåˆå§‹çŠ¶æ€ä¸‹æ¯ä¸ªå†…å­˜å¯¹è±¡éƒ½æ˜¯ç™½è‰²æ ‡è®°ã€‚</p><ol><li>å…ˆSTWï¼Œåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ enable write barrierã€‚ç„¶åå–æ¶ˆSTWï¼Œå°†æ‰«æä»»åŠ¡ä½œä¸ºå¤šä¸ªå¹¶å‘çš„goroutineç«‹å³å…¥é˜Ÿç»™è°ƒåº¦å™¨ï¼Œè¿›è€Œè¢«CPUå¤„ç†</li><li>ç¬¬ä¸€è½®å…ˆæ‰«ærootå¯¹è±¡ï¼ŒåŒ…æ‹¬å…¨å±€æŒ‡é’ˆå’Œ goroutine æ ˆä¸Šçš„æŒ‡é’ˆï¼Œæ ‡è®°ä¸ºç°è‰²æ”¾å…¥é˜Ÿåˆ—</li><li>ç¬¬äºŒè½®å°†ç¬¬ä¸€æ­¥é˜Ÿåˆ—ä¸­çš„å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ç½®ä¸ºç°è‰²åŠ å…¥é˜Ÿåˆ—ï¼Œä¸€ä¸ªå¯¹è±¡å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡éƒ½ç½®ç°å¹¶åŠ å…¥é˜Ÿåˆ—åï¼Œè¿™ä¸ªå¯¹è±¡æ‰èƒ½ç½®ä¸ºé»‘è‰²å¹¶ä»é˜Ÿåˆ—ä¹‹ä¸­å–å‡ºã€‚å¾ªç¯å¾€å¤ï¼Œæœ€åé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ•´ä¸ªå›¾å‰©ä¸‹çš„ç™½è‰²å†…å­˜ç©ºé—´å³ä¸å¯åˆ°è¾¾çš„å¯¹è±¡ï¼Œå³æ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼›</li><li>ç¬¬ä¸‰è½®å†æ¬¡STWï¼Œå°†ç¬¬äºŒè½®è¿‡ç¨‹ä¸­æ–°å¢å¯¹è±¡ç”³è¯·çš„å†…å­˜è¿›è¡Œæ ‡è®°ï¼ˆç°è‰²ï¼‰ï¼Œè¿™é‡Œä½¿ç”¨äº†write barrierï¼ˆå†™å±éšœï¼‰å»è®°å½•</li></ol><p>Golang gc ä¼˜åŒ–çš„æ ¸å¿ƒå°±æ˜¯å°½é‡ä½¿å¾— STW(Stop The World) çš„æ—¶é—´è¶Šæ¥è¶ŠçŸ­ã€‚</p><p>è¯¦ç»†çš„Golangçš„GCä»‹ç»å¯ä»¥å‚çœ‹<a href="https://github.com/KeKe-Li/For-learning-Go-Tutorial/blob/master/src/spec/02.0.md" target="_blank" rel="noopener">Golangåƒåœ¾å›æ”¶</a>.</p><h4 id="13-Golang-ä¸­-Goroutine-å¦‚ä½•è°ƒåº¦"><a href="#13-Golang-ä¸­-Goroutine-å¦‚ä½•è°ƒåº¦" class="headerlink" title="13. Golang ä¸­ Goroutine å¦‚ä½•è°ƒåº¦?"></a>13. Golang ä¸­ Goroutine å¦‚ä½•è°ƒåº¦?</h4><p>goroutineæ˜¯Golangè¯­è¨€ä¸­æœ€ç»å…¸çš„è®¾è®¡ï¼Œä¹Ÿæ˜¯å…¶é­…åŠ›æ‰€åœ¨ï¼Œgoroutineçš„æœ¬è´¨æ˜¯åç¨‹ï¼Œæ˜¯å®ç°å¹¶è¡Œè®¡ç®—çš„æ ¸å¿ƒã€‚ goroutineä½¿ç”¨æ–¹å¼éå¸¸çš„ç®€å•ï¼Œåªéœ€ä½¿ç”¨goå…³é”®å­—å³å¯å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”å®ƒæ˜¯å¤„äºå¼‚æ­¥æ–¹å¼è¿è¡Œï¼Œä½ ä¸éœ€è¦ç­‰å®ƒè¿è¡Œå®Œæˆä»¥ååœ¨æ‰§è¡Œä»¥åçš„ä»£ç ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go func()//é€šè¿‡goå…³é”®å­—å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥è¿è¡Œå‡½æ•°</span><br></pre></td></tr></table></figure><p>åç¨‹:</p><p>åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›æ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚ å› æ­¤ï¼Œåç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼ˆå³æ‰€æœ‰å±€éƒ¨çŠ¶æ€çš„ä¸€ä¸ªç‰¹å®šç»„åˆï¼‰ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ï¼Œæ¢ç§è¯´æ³•ï¼šè¿›å…¥ä¸Šä¸€æ¬¡ç¦»å¼€æ—¶æ‰€å¤„é€»è¾‘æµçš„ä½ç½®ã€‚ çº¿ç¨‹å’Œè¿›ç¨‹çš„æ“ä½œæ˜¯ç”±ç¨‹åºè§¦å‘ç³»ç»Ÿæ¥å£ï¼Œæœ€åçš„æ‰§è¡Œè€…æ˜¯ç³»ç»Ÿï¼›åç¨‹çš„æ“ä½œæ‰§è¡Œè€…åˆ™æ˜¯ç”¨æˆ·è‡ªèº«ç¨‹åºï¼Œgoroutineä¹Ÿæ˜¯åç¨‹ã€‚</p><p>groutineèƒ½æ‹¥æœ‰å¼ºå¤§çš„å¹¶å‘å®ç°æ˜¯é€šè¿‡GPMè°ƒåº¦æ¨¡å‹å®ç°.</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/59.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/59.jpg" alt="img"></a></p><p>Goçš„è°ƒåº¦å™¨å†…éƒ¨æœ‰å››ä¸ªé‡è¦çš„ç»“æ„ï¼šMï¼ŒPï¼ŒSï¼ŒSchedï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ˆSchedæœªç»™å‡ºï¼‰.</p><ul><li>M:Mä»£è¡¨å†…æ ¸çº§çº¿ç¨‹ï¼Œä¸€ä¸ªMå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œgoroutineå°±æ˜¯è·‘åœ¨Mä¹‹ä¸Šçš„ï¼›Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æ„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éå¸¸å¤šçš„ä¿¡æ¯</li><li>G:ä»£è¡¨ä¸€ä¸ªgoroutineï¼Œå®ƒæœ‰è‡ªå·±çš„æ ˆï¼Œinstruction pointerå’Œå…¶ä»–ä¿¡æ¯ï¼ˆæ­£åœ¨ç­‰å¾…çš„channelç­‰ç­‰ï¼‰ï¼Œç”¨äºè°ƒåº¦ã€‚</li><li>P:På…¨ç§°æ˜¯Processorï¼Œå¤„ç†å™¨ï¼Œå®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œgoroutineçš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªgoroutineé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰éœ€è¦å®ƒæ¥æ‰§è¡Œçš„goroutine</li><li>Schedï¼šä»£è¡¨è°ƒåº¦å™¨ï¼Œå®ƒç»´æŠ¤æœ‰å­˜å‚¨Må’ŒGçš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚</li></ul><p>è°ƒåº¦å®ç°:</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/65.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/65.jpg" alt="img"></a></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰2ä¸ªç‰©ç†çº¿ç¨‹Mï¼Œæ¯ä¸€ä¸ªMéƒ½æ‹¥æœ‰ä¸€ä¸ªå¤„ç†å™¨Pï¼Œæ¯ä¸€ä¸ªä¹Ÿéƒ½æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineã€‚Pçš„æ•°é‡å¯ä»¥é€šè¿‡GOMAXPROCS()æ¥è®¾ç½®ï¼Œå®ƒå…¶å®ä¹Ÿå°±ä»£è¡¨äº†çœŸæ­£çš„å¹¶å‘åº¦ï¼Œå³æœ‰å¤šå°‘ä¸ªgoroutineå¯ä»¥åŒæ—¶è¿è¡Œã€‚</p><p>å›¾ä¸­ç°è‰²çš„é‚£äº›goroutineå¹¶æ²¡æœ‰è¿è¡Œï¼Œè€Œæ˜¯å‡ºäºreadyçš„å°±ç»ªæ€ï¼Œæ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚Pç»´æŠ¤ç€è¿™ä¸ªé˜Ÿåˆ—ï¼ˆç§°ä¹‹ä¸ºrunqueueï¼‰ï¼ŒGoè¯­è¨€é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªgoroutineå¾ˆå®¹æ˜“ï¼šgo function å°±è¡Œï¼Œæ‰€ä»¥æ¯æœ‰ä¸€ä¸ªgoè¯­å¥è¢«æ‰§è¡Œï¼Œrunqueueé˜Ÿåˆ—å°±åœ¨å…¶æœ«å°¾åŠ å…¥ä¸€ä¸ªgoroutineï¼Œåœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦ç‚¹ï¼Œå°±ä»runqueueä¸­å–å‡ºï¼ˆå¦‚ä½•å†³å®šå–å“ªä¸ªgoroutineï¼Ÿï¼‰ä¸€ä¸ªgoroutineæ‰§è¡Œã€‚</p><p>å½“ä¸€ä¸ªOSçº¿ç¨‹M0é™·å…¥é˜»å¡æ—¶ï¼ŒPè½¬è€Œåœ¨è¿è¡ŒM1ï¼Œå›¾ä¸­çš„M1å¯èƒ½æ˜¯æ­£è¢«åˆ›å»ºï¼Œæˆ–è€…ä»çº¿ç¨‹ç¼“å­˜ä¸­å–å‡ºã€‚</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/60.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/60.jpg" alt="img"></a></p><p>å½“MOè¿”å›æ—¶ï¼Œå®ƒå¿…é¡»å°è¯•å–å¾—ä¸€ä¸ªPæ¥è¿è¡Œgoroutineï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒä¼šä»å…¶ä»–çš„OSçº¿ç¨‹é‚£é‡Œæ‹¿ä¸€ä¸ªPè¿‡æ¥ï¼Œ å¦‚æœæ²¡æœ‰æ‹¿åˆ°çš„è¯ï¼Œå®ƒå°±æŠŠgoroutineæ”¾åœ¨ä¸€ä¸ªglobal runqueueé‡Œï¼Œç„¶åè‡ªå·±ç¡çœ ï¼ˆæ”¾å…¥çº¿ç¨‹ç¼“å­˜é‡Œï¼‰ã€‚æ‰€æœ‰çš„Pä¹Ÿä¼šå‘¨æœŸæ€§çš„æ£€æŸ¥global runqueueå¹¶è¿è¡Œå…¶ä¸­çš„goroutineï¼Œå¦åˆ™global runqueueä¸Šçš„goroutineæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚</p><p>å¦ä¸€ç§æƒ…å†µæ˜¯Pæ‰€åˆ†é…çš„ä»»åŠ¡Gå¾ˆå¿«å°±æ‰§è¡Œå®Œäº†ï¼ˆåˆ†é…ä¸å‡ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†è¿™ä¸ªå¤„ç†å™¨På¾ˆå¿™ï¼Œä½†æ˜¯å…¶ä»–çš„Pè¿˜æœ‰ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚æœglobal runqueueæ²¡æœ‰ä»»åŠ¡Gäº†ï¼Œé‚£ä¹ˆPä¸å¾—ä¸ä»å…¶ä»–çš„Pé‡Œæ‹¿ä¸€äº›Gæ¥æ‰§è¡Œã€‚</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/64.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/64.jpg" alt="img"></a></p><p>é€šå¸¸æ¥è¯´ï¼Œå¦‚æœPä»å…¶ä»–çš„Pé‚£é‡Œè¦æ‹¿ä»»åŠ¡çš„è¯ï¼Œä¸€èˆ¬å°±æ‹¿run queueçš„ä¸€åŠï¼Œè¿™å°±ç¡®ä¿äº†æ¯ä¸ªOSçº¿ç¨‹éƒ½èƒ½å……åˆ†çš„ä½¿ç”¨ã€‚</p><h4 id="14-å¹¶å‘ç¼–ç¨‹æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#14-å¹¶å‘ç¼–ç¨‹æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="14. å¹¶å‘ç¼–ç¨‹æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ"></a>14. å¹¶å‘ç¼–ç¨‹æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>å¹¶è¡Œæ˜¯æŒ‡ä¸¤ä¸ªæˆ–è€…å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶åˆ»å‘ç”Ÿï¼›å¹¶å‘æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´é—´éš”å‘ç”Ÿã€‚</p><p>å¹¶è¡Œæ˜¯åœ¨ä¸åŒå®ä½“ä¸Šçš„å¤šä¸ªäº‹ä»¶ï¼Œå¹¶å‘æ˜¯åœ¨åŒä¸€å®ä½“ä¸Šçš„å¤šä¸ªäº‹ä»¶ã€‚åœ¨ä¸€å°å¤„ç†å™¨ä¸Šâ€œåŒæ—¶â€å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œåœ¨å¤šå°å¤„ç†å™¨ä¸ŠåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚å¦‚hadoopåˆ†å¸ƒå¼é›†ç¾¤</p><p>å¹¶å‘åé‡äºå¤šä¸ªä»»åŠ¡äº¤æ›¿æ‰§è¡Œï¼Œè€Œå¤šä¸ªä»»åŠ¡ä¹‹é—´æœ‰å¯èƒ½è¿˜æ˜¯ä¸²è¡Œçš„ã€‚è€Œå¹¶è¡Œæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€œåŒæ—¶æ‰§è¡Œâ€ã€‚</p><p>å¹¶å‘ç¼–ç¨‹æ˜¯æŒ‡åœ¨ä¸€å°å¤„ç†å™¨ä¸Šâ€œåŒæ—¶â€å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚å¹¶å‘æ˜¯åœ¨åŒä¸€å®ä½“ä¸Šçš„å¤šä¸ªäº‹ä»¶ã€‚å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´é—´éš”å‘ç”Ÿã€‚å¹¶å‘ç¼–ç¨‹çš„ç›®æ ‡æ˜¯å……åˆ†çš„åˆ©ç”¨å¤„ç†å™¨çš„æ¯ä¸€ä¸ªæ ¸ï¼Œä»¥è¾¾åˆ°æœ€é«˜çš„å¤„ç†æ€§èƒ½ã€‚</p><h4 id="15-è´Ÿè½½å‡è¡¡åŸç†æ˜¯ä»€ä¹ˆ"><a href="#15-è´Ÿè½½å‡è¡¡åŸç†æ˜¯ä»€ä¹ˆ" class="headerlink" title="15. è´Ÿè½½å‡è¡¡åŸç†æ˜¯ä»€ä¹ˆ?"></a>15. è´Ÿè½½å‡è¡¡åŸç†æ˜¯ä»€ä¹ˆ?</h4><p>è´Ÿè½½å‡è¡¡Load Balanceï¼‰æ˜¯é«˜å¯ç”¨ç½‘ç»œåŸºç¡€æ¶æ„çš„å…³é”®ç»„ä»¶ï¼Œé€šå¸¸ç”¨äºå°†å·¥ä½œè´Ÿè½½åˆ†å¸ƒåˆ°å¤šä¸ªæœåŠ¡å™¨æ¥æé«˜ç½‘ç«™ã€åº”ç”¨ã€æ•°æ®åº“æˆ–å…¶ä»–æœåŠ¡çš„æ€§èƒ½å’Œå¯é æ€§ã€‚è´Ÿè½½å‡è¡¡ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ç½‘ç»œæµé‡åˆ†å‘ï¼Œåˆ†å¾ˆå¤šç»´åº¦ã€‚</p><p>è´Ÿè½½å‡è¡¡ï¼ˆLoad Balanceï¼‰é€šå¸¸æ˜¯åˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šè¿›è¡Œæ‰§è¡Œï¼Œä¾‹å¦‚WebæœåŠ¡å™¨ã€FTPæœåŠ¡å™¨ã€ä¼ä¸šå…³é”®åº”ç”¨æœåŠ¡å™¨å’Œå…¶å®ƒå…³é”®ä»»åŠ¡æœåŠ¡å™¨ç­‰ï¼Œä»è€Œå…±åŒå®Œæˆå·¥ä½œä»»åŠ¡ã€‚</p><p>è´Ÿè½½å‡è¡¡æ˜¯å»ºç«‹åœ¨ç°æœ‰ç½‘ç»œç»“æ„ä¹‹ä¸Šï¼Œå®ƒæä¾›äº†ä¸€ç§å»‰ä»·æœ‰æ•ˆé€æ˜çš„æ–¹æ³•æ‰©å±•ç½‘ç»œè®¾å¤‡å’ŒæœåŠ¡å™¨çš„å¸¦å®½ã€å¢åŠ ååé‡ã€åŠ å¼ºç½‘ç»œæ•°æ®å¤„ç†èƒ½åŠ›ã€æé«˜ç½‘ç»œçš„çµæ´»æ€§å’Œå¯ç”¨æ€§ã€‚</p><p>é€šè¿‡ä¸€ä¸ªä¾‹å­è¯¦ç»†ä»‹ç»:</p><ul><li>æ²¡æœ‰è´Ÿè½½å‡è¡¡ web æ¶æ„</li></ul><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/66.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/66.jpg" alt="img"></a></p><p>åœ¨è¿™é‡Œç”¨æˆ·æ˜¯ç›´è¿åˆ° web æœåŠ¡å™¨ï¼Œå¦‚æœè¿™ä¸ªæœåŠ¡å™¨å®•æœºäº†ï¼Œé‚£ä¹ˆç”¨æˆ·è‡ªç„¶ä¹Ÿå°±æ²¡åŠæ³•è®¿é—®äº†ã€‚ å¦å¤–ï¼Œå¦‚æœåŒæ—¶æœ‰å¾ˆå¤šç”¨æˆ·è¯•å›¾è®¿é—®æœåŠ¡å™¨ï¼Œè¶…è¿‡äº†å…¶èƒ½å¤„ç†çš„æé™ï¼Œå°±ä¼šå‡ºç°åŠ è½½é€Ÿåº¦ç¼“æ…¢æˆ–æ ¹æœ¬æ— æ³•è¿æ¥çš„æƒ…å†µã€‚</p><p>è€Œé€šè¿‡åœ¨åç«¯å¼•å…¥ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨å’Œè‡³å°‘ä¸€ä¸ªé¢å¤–çš„ web æœåŠ¡å™¨ï¼Œå¯ä»¥ç¼“è§£è¿™ä¸ªæ•…éšœã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„åç«¯æœåŠ¡å™¨ä¼šä¿è¯æä¾›ç›¸åŒçš„å†…å®¹ï¼Œä»¥ä¾¿ç”¨æˆ·æ— è®ºå“ªä¸ªæœåŠ¡å™¨å“åº”ï¼Œéƒ½èƒ½æ”¶åˆ°ä¸€è‡´çš„å†…å®¹ã€‚</p><ul><li>æœ‰è´Ÿè½½å‡è¡¡ web æ¶æ„</li></ul><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/67.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/67.jpg" alt="img"></a></p><p>ç”¨æˆ·è®¿é—®è´Ÿè½½å‡è¡¡å™¨ï¼Œå†ç”±è´Ÿè½½å‡è¡¡å™¨å°†è¯·æ±‚è½¬å‘ç»™åç«¯æœåŠ¡å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå•ç‚¹æ•…éšœç°åœ¨è½¬ç§»åˆ°è´Ÿè½½å‡è¡¡å™¨ä¸Šäº†ã€‚ è¿™é‡Œåˆå¯ä»¥é€šè¿‡å¼•å…¥ç¬¬äºŒä¸ªè´Ÿè½½å‡è¡¡å™¨æ¥ç¼“è§£ã€‚</p><p>é‚£ä¹ˆè´Ÿè½½å‡è¡¡å™¨çš„å·¥ä½œæ–¹å¼æ˜¯ä»€ä¹ˆæ ·çš„å‘¢,è´Ÿè½½å‡è¡¡å™¨åˆå¯ä»¥å¤„ç†ä»€ä¹ˆæ ·çš„è¯·æ±‚ï¼Ÿ</p><p>è´Ÿè½½å‡è¡¡å™¨çš„ç®¡ç†å‘˜èƒ½ä¸»è¦ä¸ºä¸‹é¢å››ç§ä¸»è¦ç±»å‹çš„è¯·æ±‚è®¾ç½®è½¬å‘è§„åˆ™ï¼š</p><ul><li>HTTP (ä¸ƒå±‚)</li><li>HTTPS (ä¸ƒå±‚)</li><li>TCP (å››å±‚)</li><li>UDP (å››å±‚)</li></ul><p>è´Ÿè½½å‡è¡¡å™¨å¦‚ä½•é€‰æ‹©è¦è½¬å‘çš„åç«¯æœåŠ¡å™¨ï¼Ÿ</p><p>è´Ÿè½½å‡è¡¡å™¨ä¸€èˆ¬æ ¹æ®ä¸¤ä¸ªå› ç´ æ¥å†³å®šè¦å°†è¯·æ±‚è½¬å‘åˆ°å“ªä¸ªæœåŠ¡å™¨ã€‚é¦–å…ˆï¼Œç¡®ä¿æ‰€é€‰æ‹©çš„æœåŠ¡å™¨èƒ½å¤Ÿå¯¹è¯·æ±‚åšå‡ºå“åº”ï¼Œç„¶åæ ¹æ®é¢„å…ˆé…ç½®çš„è§„åˆ™ä»å¥åº·æœåŠ¡å™¨æ± ï¼ˆhealthy poolï¼‰ä¸­è¿›è¡Œé€‰æ‹©ã€‚</p><p>å› ä¸ºï¼Œè´Ÿè½½å‡è¡¡å™¨åº”å½“åªé€‰æ‹©èƒ½æ­£å¸¸åšå‡ºå“åº”çš„åç«¯æœåŠ¡å™¨ï¼Œå› æ­¤å°±éœ€è¦æœ‰ä¸€ç§åˆ¤æ–­åç«¯æœåŠ¡å™¨æ˜¯å¦å¥åº·çš„æ–¹æ³•ã€‚ä¸ºäº†ç›‘è§†åå°æœåŠ¡å™¨çš„è¿è¡ŒçŠ¶å†µï¼Œè¿è¡ŒçŠ¶æ€æ£€æŸ¥æœåŠ¡ä¼šå®šæœŸå°è¯•ä½¿ç”¨è½¬å‘è§„åˆ™å®šä¹‰çš„åè®®å’Œç«¯å£å»è¿æ¥åç«¯æœåŠ¡å™¨ã€‚ å¦‚æœï¼ŒæœåŠ¡å™¨æ— æ³•é€šè¿‡å¥åº·æ£€æŸ¥ï¼Œå°±ä¼šä»æ± ä¸­å‰”é™¤ï¼Œä¿è¯æµé‡ä¸ä¼šè¢«è½¬å‘åˆ°è¯¥æœåŠ¡å™¨ï¼Œç›´åˆ°å…¶å†æ¬¡é€šè¿‡å¥åº·æ£€æŸ¥ä¸ºæ­¢ã€‚</p><p>è´Ÿè½½å‡è¡¡ç®—æ³•</p><p>è´Ÿè½½å‡è¡¡ç®—æ³•å†³å®šäº†åç«¯çš„å“ªäº›å¥åº·æœåŠ¡å™¨ä¼šè¢«é€‰ä¸­ã€‚ å…¶ä¸­å¸¸ç”¨çš„ç®—æ³•åŒ…æ‹¬ï¼š</p><ul><li>Round Robinï¼ˆè½®è¯¢ï¼‰ï¼šä¸ºç¬¬ä¸€ä¸ªè¯·æ±‚é€‰æ‹©åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç„¶åæŒ‰é¡ºåºå‘ä¸‹ç§»åŠ¨åˆ—è¡¨ç›´åˆ°ç»“å°¾ï¼Œç„¶åå¾ªç¯ã€‚</li><li>Least Connectionsï¼ˆæœ€å°è¿æ¥ï¼‰ï¼šä¼˜å…ˆé€‰æ‹©è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼Œåœ¨æ™®éä¼šè¯è¾ƒé•¿çš„æƒ…å†µä¸‹æ¨èä½¿ç”¨ã€‚</li><li>Sourceï¼šæ ¹æ®è¯·æ±‚æºçš„ IP çš„æ•£åˆ—ï¼ˆhashï¼‰æ¥é€‰æ‹©è¦è½¬å‘çš„æœåŠ¡å™¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ç‰¹å®šç”¨æˆ·èƒ½è¿æ¥åˆ°ç›¸åŒçš„æœåŠ¡å™¨ã€‚</li></ul><p>å¦‚æœä½ çš„åº”ç”¨éœ€è¦å¤„ç†çŠ¶æ€è€Œè¦æ±‚ç”¨æˆ·èƒ½è¿æ¥åˆ°å’Œä¹‹å‰ç›¸åŒçš„æœåŠ¡å™¨ã€‚å¯ä»¥é€šè¿‡ Source ç®—æ³•åŸºäºå®¢æˆ·ç«¯çš„ IP ä¿¡æ¯åˆ›å»ºå…³è”ï¼Œæˆ–è€…ä½¿ç”¨ç²˜æ€§ä¼šè¯ï¼ˆsticky sessionsï¼‰ã€‚</p><p>é™¤æ­¤ä¹‹å¤–ï¼Œæƒ³è¦è§£å†³è´Ÿè½½å‡è¡¡å™¨çš„å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¯ä»¥å°†ç¬¬äºŒä¸ªè´Ÿè½½å‡è¡¡å™¨è¿æ¥åˆ°ç¬¬ä¸€ä¸ªä¸Šï¼Œä»è€Œå½¢æˆä¸€ä¸ªé›†ç¾¤ã€‚</p><h4 id="16-LVSç›¸å…³äº†è§£"><a href="#16-LVSç›¸å…³äº†è§£" class="headerlink" title="16. LVSç›¸å…³äº†è§£."></a>16. LVSç›¸å…³äº†è§£.</h4><p>LVSæ˜¯ Linux Virtual Server çš„ç®€ç§°ï¼Œä¹Ÿå°±æ˜¯Linuxè™šæ‹ŸæœåŠ¡å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªç”±ç« æ–‡åµ©åšå£«å‘èµ·çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒçš„å®˜æ–¹ç½‘ç«™æ˜¯<a href="http://www.linuxvirtualserver.org/" target="_blank" rel="noopener">LinuxVirtualServer</a>ç°åœ¨ LVS å·²ç»æ˜¯ Linux å†…æ ¸æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚ä½¿ç”¨ LVS å¯ä»¥è¾¾åˆ°çš„æŠ€æœ¯ç›®æ ‡æ˜¯ï¼šé€šè¿‡ LVS è¾¾åˆ°çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯å’Œ Linux æ“ä½œç³»ç»Ÿå®ç°ä¸€ä¸ªé«˜æ€§èƒ½é«˜å¯ç”¨çš„ Linux æœåŠ¡å™¨é›†ç¾¤ï¼Œå®ƒå…·æœ‰è‰¯å¥½çš„å¯é æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æ“ä½œæ€§ã€‚ ä»è€Œä»¥ä½å»‰çš„æˆæœ¬å®ç°æœ€ä¼˜çš„æ€§èƒ½ã€‚LVS æ˜¯ä¸€ä¸ªå®ç°è´Ÿè½½å‡è¡¡é›†ç¾¤çš„å¼€æºè½¯ä»¶é¡¹ç›®ï¼ŒLVSæ¶æ„ä»é€»è¾‘ä¸Šå¯åˆ†ä¸ºè°ƒåº¦å±‚ã€Serveré›†ç¾¤å±‚å’Œå…±äº«å­˜å‚¨ã€‚</p><p>LVSçš„åŸºæœ¬å·¥ä½œåŸç†:</p><p><a href="https://github.com/KeKe-Li/golang-interview-questions/blob/master/src/images/68.jpg" target="_blank" rel="noopener"><img src="https://github.com/KeKe-Li/golang-interview-questions/raw/master/src/images/68.jpg" alt="img"></a></p><ol><li>å½“ç”¨æˆ·å‘è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨ï¼ˆDirector Serverï¼‰å‘èµ·è¯·æ±‚ï¼Œè°ƒåº¦å™¨å°†è¯·æ±‚å‘å¾€è‡³å†…æ ¸ç©ºé—´</li><li>PREROUTINGé“¾é¦–å…ˆä¼šæ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œåˆ¤æ–­ç›®æ ‡IPç¡®å®šæ˜¯æœ¬æœºIPï¼Œå°†æ•°æ®åŒ…å‘å¾€INPUTé“¾</li><li>IPVSæ˜¯å·¥ä½œåœ¨INPUTé“¾ä¸Šçš„ï¼Œå½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾INPUTæ—¶ï¼ŒIPVSä¼šå°†ç”¨æˆ·è¯·æ±‚å’Œè‡ªå·±å·²å®šä¹‰å¥½çš„é›†ç¾¤æœåŠ¡è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœç”¨æˆ·è¯·æ±‚çš„å°±æ˜¯å®šä¹‰çš„é›†ç¾¤æœåŠ¡ï¼Œé‚£ä¹ˆæ­¤æ—¶IPVSä¼šå¼ºè¡Œä¿®æ”¹æ•°æ®åŒ…é‡Œçš„ç›®æ ‡IPåœ°å€åŠç«¯å£ï¼Œå¹¶å°†æ–°çš„æ•°æ®åŒ…å‘å¾€POSTROUTINGé“¾</li><li>POSTROUTINGé“¾æ¥æ”¶æ•°æ®åŒ…åå‘ç°ç›®æ ‡IPåœ°å€åˆšå¥½æ˜¯è‡ªå·±çš„åç«¯æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæ­¤æ—¶é€šè¿‡é€‰è·¯ï¼Œå°†æ•°æ®åŒ…æœ€ç»ˆå‘é€ç»™åç«¯çš„æœåŠ¡å™¨</li></ol><p>LVSçš„ç»„æˆ:</p><p>LVS ç”±2éƒ¨åˆ†ç¨‹åºç»„æˆï¼ŒåŒ…æ‹¬ <code>ipvs</code> å’Œ <code>ipvsadm</code>ã€‚</p><ol><li>ipvs(ip virtual server)ï¼šä¸€æ®µä»£ç å·¥ä½œåœ¨å†…æ ¸ç©ºé—´ï¼Œå«ipvsï¼Œæ˜¯çœŸæ­£ç”Ÿæ•ˆå®ç°è°ƒåº¦çš„ä»£ç ã€‚</li><li>ipvsadmï¼šå¦å¤–ä¸€æ®µæ˜¯å·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œå«ipvsadmï¼Œè´Ÿè´£ä¸ºipvså†…æ ¸æ¡†æ¶ç¼–å†™è§„åˆ™ï¼Œå®šä¹‰è°æ˜¯é›†ç¾¤æœåŠ¡ï¼Œè€Œè°æ˜¯åç«¯çœŸå®çš„æœåŠ¡å™¨(Real Server)</li></ol><p>è¯¦ç»†çš„LVSçš„ä»‹ç»å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/liqing1009/p/8763045.html" target="_blank" rel="noopener">LVSè¯¦è§£</a>.</p><h4 id="17-å¾®æœåŠ¡æ¶æ„æ˜¯ä»€ä¹ˆæ ·å­çš„"><a href="#17-å¾®æœåŠ¡æ¶æ„æ˜¯ä»€ä¹ˆæ ·å­çš„" class="headerlink" title="17. å¾®æœåŠ¡æ¶æ„æ˜¯ä»€ä¹ˆæ ·å­çš„?"></a>17. å¾®æœåŠ¡æ¶æ„æ˜¯ä»€ä¹ˆæ ·å­çš„?</h4><p>é€šå¸¸ä¼ ç»Ÿçš„é¡¹ç›®ä½“ç§¯åºå¤§ï¼Œéœ€æ±‚ã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²æµç¨‹å›ºå®šã€‚æ–°åŠŸèƒ½éœ€è¦åœ¨åŸé¡¹ç›®ä¸Šåšä¿®æ”¹ã€‚</p><p>ä½†æ˜¯å¾®æœåŠ¡å¯ä»¥çœ‹åšæ˜¯å¯¹å¤§é¡¹ç›®çš„æ‹†åˆ†ï¼Œæ˜¯åœ¨å¿«é€Ÿè¿­ä»£æ›´æ–°ä¸Šçº¿çš„éœ€æ±‚ä¸‹äº§ç”Ÿçš„ã€‚æ–°çš„åŠŸèƒ½æ¨¡å—ä¼šå‘å¸ƒæˆæ–°çš„æœåŠ¡ç»„ä»¶ï¼Œä¸å…¶ä»–å·²å‘å¸ƒçš„æœåŠ¡ç»„ä»¶ä¸€åŒåä½œã€‚ æœåŠ¡å†…éƒ¨æœ‰å¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œé€šå¸¸ä»¥http restçš„æ–¹å¼è°ƒç”¨ï¼ŒæœåŠ¡æ€»ä½“ä»¥ä¸€ä¸ªï¼ˆæˆ–å‡ ä¸ªï¼‰æœåŠ¡çš„å½¢å¼å‘ˆç°ç»™å®¢æˆ·ä½¿ç”¨ã€‚</p><p>å¾®æœåŠ¡æ¶æ„æ˜¯ä¸€ç§æ€æƒ³å¯¹å¾®æœåŠ¡æ¶æ„æˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªæ˜ç¡®çš„å®šä¹‰ï¼Œä½†ç®€å•æ¥è¯´å¾®æœåŠ¡æ¶æ„æ˜¯ï¼š</p><p>é‡‡ç”¨ä¸€ç»„æœåŠ¡çš„æ–¹å¼æ¥æ„å»ºä¸€ä¸ªåº”ç”¨ï¼ŒæœåŠ¡ç‹¬ç«‹éƒ¨ç½²åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œä¸åŒæœåŠ¡é€šè¿‡ä¸€äº›è½»é‡çº§äº¤äº’æœºåˆ¶æ¥é€šä¿¡ï¼Œä¾‹å¦‚ RPCã€HTTP ç­‰ï¼ŒæœåŠ¡å¯ç‹¬ç«‹æ‰©å±•ä¼¸ç¼©ï¼Œæ¯ä¸ªæœåŠ¡å®šä¹‰äº†æ˜ç¡®çš„è¾¹ç•Œï¼Œä¸åŒçš„æœåŠ¡ç”šè‡³å¯ä»¥é‡‡ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ï¼Œç”±ç‹¬ç«‹çš„å›¢é˜Ÿæ¥ç»´æŠ¤ã€‚</p><p>Golangçš„å¾®æœåŠ¡æ¡†æ¶<a href="https://gokit.io/" target="_blank" rel="noopener">kit</a>ä¸­æœ‰è¯¦ç»†çš„å¾®æœåŠ¡çš„ä¾‹å­,å¯ä»¥å‚è€ƒå­¦ä¹ .</p><p>å¾®æœåŠ¡æ¶æ„è®¾è®¡åŒ…æ‹¬ï¼š</p><ol><li>æœåŠ¡ç†”æ–­é™çº§é™æµæœºåˆ¶ ç†”æ–­é™çº§çš„æ¦‚å¿µ(Rate Limiter é™æµå™¨,Circuit breaker æ–­è·¯å™¨).</li><li>æ¡†æ¶è°ƒç”¨æ–¹å¼è§£è€¦æ–¹å¼ Kit æˆ– Istio æˆ– Micro æœåŠ¡å‘ç°(consul zookeeper kubeneters etcd ) RPCè°ƒç”¨æ¡†æ¶.</li><li>é“¾è·¯ç›‘æ§,zipkinå’Œprometheus.</li><li>å¤šçº§ç¼“å­˜.</li><li>ç½‘å…³ (kong gateway).</li><li>Dockeréƒ¨ç½²ç®¡ç† Kubenetters.</li><li>è‡ªåŠ¨é›†æˆéƒ¨ç½² CI/CD å®è·µ.</li><li>è‡ªåŠ¨æ‰©å®¹æœºåˆ¶è§„åˆ™.</li><li>å‹æµ‹ ä¼˜åŒ–.</li><li>Trasport æ•°æ®ä¼ è¾“(åºåˆ—åŒ–å’Œååºåˆ—åŒ–).</li><li>Logging æ—¥å¿—.</li><li>Metrics æŒ‡é’ˆå¯¹æ¯ä¸ªè¯·æ±‚ä¿¡æ¯çš„ä»ªè¡¨ç›˜åŒ–.</li></ol><p>å¾®æœåŠ¡æ¶æ„ä»‹ç»è¯¦ç»†çš„å¯ä»¥å‚è€ƒ:</p><ul><li><a href="http://www.pst.ifi.lmu.de/Lehre/wise-14-15/mse/microservice-architectures.pdf" target="_blank" rel="noopener">Microservice Architectures</a></li></ul><h4 id="18-åˆ†å¸ƒå¼é”å®ç°åŸç†ï¼Œç”¨è¿‡å—ï¼Ÿ"><a href="#18-åˆ†å¸ƒå¼é”å®ç°åŸç†ï¼Œç”¨è¿‡å—ï¼Ÿ" class="headerlink" title="18. åˆ†å¸ƒå¼é”å®ç°åŸç†ï¼Œç”¨è¿‡å—ï¼Ÿ"></a>18. åˆ†å¸ƒå¼é”å®ç°åŸç†ï¼Œç”¨è¿‡å—ï¼Ÿ</h4><p>åœ¨åˆ†æåˆ†å¸ƒå¼é”çš„ä¸‰ç§å®ç°æ–¹å¼ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶ï¼š</p><ol><li>åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ–¹æ³•åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªæœºå™¨çš„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼›</li><li>é«˜å¯ç”¨çš„è·å–é”ä¸é‡Šæ”¾é”ï¼›</li><li>é«˜æ€§èƒ½çš„è·å–é”ä¸é‡Šæ”¾é”ï¼›</li><li>å…·å¤‡å¯é‡å…¥ç‰¹æ€§ï¼›</li><li>å…·å¤‡é”å¤±æ•ˆæœºåˆ¶ï¼Œé˜²æ­¢æ­»é”ï¼›</li><li>å…·å¤‡éé˜»å¡é”ç‰¹æ€§ï¼Œå³æ²¡æœ‰è·å–åˆ°é”å°†ç›´æ¥è¿”å›è·å–é”å¤±è´¥ã€‚</li></ol><p>åˆ†å¸ƒå¼çš„CAPç†è®ºå‘Šè¯‰æˆ‘ä»¬â€œä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤é¡¹ã€‚â€æ‰€ä»¥ï¼Œå¾ˆå¤šç³»ç»Ÿåœ¨è®¾è®¡ä¹‹åˆå°±è¦å¯¹è¿™ä¸‰è€…åšå‡ºå–èˆã€‚åœ¨äº’è”ç½‘é¢†åŸŸçš„ç»å¤§å¤šæ•°çš„åœºæ™¯ä¸­ï¼Œéƒ½éœ€è¦ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥æ¢å–ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œç³»ç»Ÿå¾€å¾€åªéœ€è¦ä¿è¯â€œæœ€ç»ˆä¸€è‡´æ€§â€ï¼Œåªè¦è¿™ä¸ªæœ€ç»ˆæ—¶é—´æ˜¯åœ¨ç”¨æˆ·å¯ä»¥æ¥å—çš„èŒƒå›´å†…å³å¯ã€‚</p><p>é€šå¸¸åˆ†å¸ƒå¼é”ä»¥å•ç‹¬çš„æœåŠ¡æ–¹å¼å®ç°ï¼Œç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„åˆ†å¸ƒå¼é”å®ç°æœ‰ä¸‰ç§ï¼š</p><ul><li>åŸºäºæ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”ã€‚</li><li>åŸºäºç¼“å­˜ï¼ˆredisï¼Œmemcachedï¼Œtairï¼‰å®ç°åˆ†å¸ƒå¼é”ã€‚</li><li>åŸºäºZookeeperå®ç°åˆ†å¸ƒå¼é”ã€‚</li></ul><p>å°½ç®¡æœ‰è¿™ä¸‰ç§æ–¹æ¡ˆï¼Œä½†æ˜¯ä¸åŒçš„ä¸šåŠ¡ä¹Ÿè¦æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œé€‰å‹ï¼Œä»–ä»¬ä¹‹é—´æ²¡æœ‰æœ€å¥½åªæœ‰æ›´é€‚åˆï¼</p><ul><li>åŸºäºæ•°æ®åº“çš„å®ç°æ–¹å¼</li></ul><p>åŸºäºæ•°æ®åº“çš„å®ç°æ–¹å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè¡¨ï¼Œè¡¨ä¸­åŒ…å«æ–¹æ³•åç­‰å­—æ®µï¼Œå¹¶åœ¨æ–¹æ³•åå­—æ®µä¸Šåˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œæƒ³è¦æ‰§è¡ŒæŸä¸ªæ–¹æ³•ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•åå‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼ŒæˆåŠŸæ’å…¥åˆ™è·å–é”ï¼Œæ‰§è¡Œå®Œæˆååˆ é™¤å¯¹åº”çš„è¡Œæ•°æ®é‡Šæ”¾é”ã€‚</p><p>åˆ›å»ºä¸€ä¸ªè¡¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE IF EXISTS `method_lock`;</span><br><span class="line">CREATE TABLE `method_lock` (</span><br><span class="line">  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &apos;ä¸»é”®&apos;,</span><br><span class="line">  `method_name` varchar(64) NOT NULL COMMENT &apos;é”å®šçš„æ–¹æ³•å&apos;,</span><br><span class="line">  `desc` varchar(255) NOT NULL COMMENT &apos;å¤‡æ³¨ä¿¡æ¯&apos;,</span><br><span class="line">  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">  PRIMARY KEY (`id`),</span><br><span class="line">  UNIQUE KEY `uidx_method_name` (`method_name`) USING BTREE</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COMMENT=&apos;é”å®šä¸­çš„æ–¹æ³•&apos;;</span><br></pre></td></tr></table></figure><p>æƒ³è¦æ‰§è¡ŒæŸä¸ªæ–¹æ³•ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•åå‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO method_lock (method_name, desc) VALUES (&apos;methodName&apos;, &apos;æµ‹è¯•çš„methodName&apos;);</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬å¯¹method_nameåšäº†å”¯ä¸€æ€§çº¦æŸï¼Œè¿™é‡Œå¦‚æœæœ‰å¤šä¸ªè¯·æ±‚åŒæ—¶æäº¤åˆ°æ•°æ®åº“çš„è¯ï¼Œæ•°æ®åº“ä¼šä¿è¯åªæœ‰ä¸€ä¸ªæ“ä½œå¯ä»¥æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºæ“ä½œæˆåŠŸçš„é‚£ä¸ªçº¿ç¨‹è·å¾—äº†è¯¥æ–¹æ³•çš„é”ï¼Œå¯ä»¥æ‰§è¡Œæ–¹æ³•ä½“å†…å®¹ã€‚</p><p>æˆåŠŸæ’å…¥åˆ™è·å–é”ï¼Œæ‰§è¡Œå®Œæˆååˆ é™¤å¯¹åº”çš„è¡Œæ•°æ®é‡Šæ”¾é”ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">delete from method_lock where method_name =&apos;methodName&apos;;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ä½¿ç”¨åŸºäºæ•°æ®åº“çš„ä¸€ç§æ–¹æ³•ï¼Œä½¿ç”¨æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç”¨æ³•å¯ä»¥å®ç°ï¼</p><p>ä½¿ç”¨åŸºäºæ•°æ®åº“çš„è¿™ç§å®ç°æ–¹å¼å¾ˆç®€å•ï¼Œä½†æ˜¯å¯¹äºåˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡çš„æ¡ä»¶æ¥è¯´ï¼Œå®ƒæœ‰ä¸€äº›é—®é¢˜éœ€è¦è§£å†³åŠä¼˜åŒ–ï¼š</p><p>1ã€å› ä¸ºæ˜¯åŸºäºæ•°æ®åº“å®ç°çš„ï¼Œæ•°æ®åº“çš„å¯ç”¨æ€§å’Œæ€§èƒ½å°†ç›´æ¥å½±å“åˆ†å¸ƒå¼é”çš„å¯ç”¨æ€§åŠæ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œæ•°æ®åº“éœ€è¦åŒæœºéƒ¨ç½²ã€æ•°æ®åŒæ­¥ã€ä¸»å¤‡åˆ‡æ¢ï¼›</p><p>2ã€ä¸å…·å¤‡å¯é‡å…¥çš„ç‰¹æ€§ï¼Œå› ä¸ºåŒä¸€ä¸ªçº¿ç¨‹åœ¨é‡Šæ”¾é”ä¹‹å‰ï¼Œè¡Œæ•°æ®ä¸€ç›´å­˜åœ¨ï¼Œæ— æ³•å†æ¬¡æˆåŠŸæ’å…¥æ•°æ®ï¼Œæ‰€ä»¥ï¼Œéœ€è¦åœ¨è¡¨ä¸­æ–°å¢ä¸€åˆ—ï¼Œç”¨äºè®°å½•å½“å‰è·å–åˆ°é”çš„æœºå™¨å’Œçº¿ç¨‹ä¿¡æ¯ï¼Œåœ¨å†æ¬¡è·å–é”çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢è¡¨ä¸­æœºå™¨å’Œçº¿ç¨‹ä¿¡æ¯æ˜¯å¦å’Œå½“å‰æœºå™¨å’Œçº¿ç¨‹ç›¸åŒï¼Œè‹¥ç›¸åŒåˆ™ç›´æ¥è·å–é”ï¼›</p><p>3ã€æ²¡æœ‰é”å¤±æ•ˆæœºåˆ¶ï¼Œå› ä¸ºæœ‰å¯èƒ½å‡ºç°æˆåŠŸæ’å…¥æ•°æ®åï¼ŒæœåŠ¡å™¨å®•æœºäº†ï¼Œå¯¹åº”çš„æ•°æ®æ²¡æœ‰è¢«åˆ é™¤ï¼Œå½“æœåŠ¡æ¢å¤åä¸€ç›´è·å–ä¸åˆ°é”ï¼Œæ‰€ä»¥ï¼Œéœ€è¦åœ¨è¡¨ä¸­æ–°å¢ä¸€åˆ—ï¼Œç”¨äºè®°å½•å¤±æ•ˆæ—¶é—´ï¼Œå¹¶ä¸”éœ€è¦æœ‰å®šæ—¶ä»»åŠ¡æ¸…é™¤è¿™äº›å¤±æ•ˆçš„æ•°æ®ï¼›</p><p>4ã€ä¸å…·å¤‡é˜»å¡é”ç‰¹æ€§ï¼Œè·å–ä¸åˆ°é”ç›´æ¥è¿”å›å¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦ä¼˜åŒ–è·å–é€»è¾‘ï¼Œå¾ªç¯å¤šæ¬¡å»è·å–ã€‚</p><p>5ã€åœ¨å®æ–½çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å„ç§ä¸åŒçš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå®ç°æ–¹å¼å°†ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼›ä¾èµ–æ•°æ®åº“éœ€è¦ä¸€å®šçš„èµ„æºå¼€é”€ï¼Œæ€§èƒ½é—®é¢˜éœ€è¦è€ƒè™‘ã€‚</p><ul><li>åŸºäºRedisçš„å®ç°æ–¹å¼</li></ul><p>é€‰ç”¨Rediså®ç°åˆ†å¸ƒå¼é”åŸå› ï¼š</p><ol><li>Redisæœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼›</li><li>Rediså‘½ä»¤å¯¹æ­¤æ”¯æŒè¾ƒå¥½ï¼Œå®ç°èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿</li></ol><p>ä¸»è¦å®ç°æ–¹å¼:</p><ol><li>SET lock currentTime+expireTime EX 600 NXï¼Œä½¿ç”¨setè®¾ç½®lockå€¼ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º600ç§’ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è·å–é”ï¼›</li><li>è·å–é”åï¼Œå¦‚æœè¯¥èŠ‚ç‚¹æ‰çº¿ï¼Œåˆ™åˆ°è¿‡æœŸæ—¶é—´ockå€¼è‡ªåŠ¨å¤±æ•ˆï¼›</li><li>é‡Šæ”¾é”æ—¶ï¼Œä½¿ç”¨delåˆ é™¤locké”®å€¼ï¼›</li></ol><p>ä½¿ç”¨rediså•æœºæ¥åšåˆ†å¸ƒå¼é”æœåŠ¡ï¼Œå¯èƒ½ä¼šå‡ºç°å•ç‚¹é—®é¢˜ï¼Œå¯¼è‡´æœåŠ¡å¯ç”¨æ€§å·®ï¼Œå› æ­¤åœ¨æœåŠ¡ç¨³å®šæ€§è¦æ±‚é«˜çš„åœºåˆï¼Œå®˜æ–¹å»ºè®®ä½¿ç”¨redisé›†ç¾¤ï¼ˆä¾‹å¦‚5å°ï¼ŒæˆåŠŸè¯·æ±‚é”è¶…è¿‡3å°å°±è®¤ä¸ºè·å–é”ï¼‰ï¼Œæ¥å®ç°redisåˆ†å¸ƒå¼é”ã€‚è¯¦è§RedLockã€‚</p><p>ä¼˜ç‚¹:æ€§èƒ½é«˜ï¼Œrediså¯æŒä¹…åŒ–ï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®ä¸æ˜“ä¸¢å¤±,redisé›†ç¾¤æ–¹å¼æé«˜ç¨³å®šæ€§ã€‚</p><p>ç¼ºç‚¹:ä½¿ç”¨redisä¸»ä»åˆ‡æ¢æ—¶å¯èƒ½ä¸¢å¤±éƒ¨åˆ†æ•°æ®ã€‚</p><ul><li>åŸºäºZooKeeperçš„å®ç°æ–¹å¼</li></ul><p>ZooKeeperæ˜¯ä¸€ä¸ªä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›ä¸€è‡´æ€§æœåŠ¡çš„å¼€æºç»„ä»¶ï¼Œå®ƒå†…éƒ¨æ˜¯ä¸€ä¸ªåˆ†å±‚çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•æ ‘ç»“æ„ï¼Œè§„å®šåŒä¸€ä¸ªç›®å½•ä¸‹åªèƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ–‡ä»¶åã€‚åŸºäºZooKeeperå®ç°åˆ†å¸ƒå¼é”çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>åˆ›å»ºä¸€ä¸ªç›®å½•mylockï¼›</li><li>çº¿ç¨‹Aæƒ³è·å–é”å°±åœ¨mylockç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼›</li><li>è·å–mylockç›®å½•ä¸‹æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç„¶åè·å–æ¯”è‡ªå·±å°çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜å½“å‰çº¿ç¨‹é¡ºåºå·æœ€å°ï¼Œè·å¾—é”ï¼›</li><li>çº¿ç¨‹Bè·å–æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±ä¸æ˜¯æœ€å°èŠ‚ç‚¹ï¼Œè®¾ç½®ç›‘å¬æ¯”è‡ªå·±æ¬¡å°çš„èŠ‚ç‚¹ï¼›</li><li>çº¿ç¨‹Aå¤„ç†å®Œï¼Œåˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹ï¼Œçº¿ç¨‹Bç›‘å¬åˆ°å˜æ›´äº‹ä»¶ï¼Œåˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æœ€å°çš„èŠ‚ç‚¹ï¼Œå¦‚æœæ˜¯åˆ™è·å¾—é”ã€‚</li></ol><p>è¿™é‡Œæ¨èä¸€ä¸ªApacheçš„å¼€æºåº“Curatorï¼Œå®ƒæ˜¯ä¸€ä¸ªZooKeeperå®¢æˆ·ç«¯ï¼ŒCuratoræä¾›çš„InterProcessMutexæ˜¯åˆ†å¸ƒå¼é”çš„å®ç°ï¼Œacquireæ–¹æ³•ç”¨äºè·å–é”ï¼Œreleaseæ–¹æ³•ç”¨äºé‡Šæ”¾é”ã€‚</p><p>ä¼˜ç‚¹ï¼šå…·å¤‡é«˜å¯ç”¨ã€å¯é‡å…¥ã€é˜»å¡é”ç‰¹æ€§ï¼Œå¯è§£å†³å¤±æ•ˆæ­»é”é—®é¢˜ã€‚</p><p>ç¼ºç‚¹ï¼šå› ä¸ºéœ€è¦é¢‘ç¹çš„åˆ›å»ºå’Œåˆ é™¤èŠ‚ç‚¹ï¼Œæ€§èƒ½ä¸Šä¸å¦‚Redisæ–¹å¼ã€‚</p><p>ä¸Šé¢çš„ä¸‰ç§å®ç°æ–¹å¼ï¼Œæ²¡æœ‰åœ¨æ‰€æœ‰åœºåˆéƒ½æ˜¯å®Œç¾çš„ï¼Œæ‰€ä»¥ï¼Œåº”æ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„å®ç°æ–¹å¼ã€‚</p><p>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸­ï¼Œå¯¹èµ„æºè¿›è¡Œä¸Šé”æœ‰æ—¶å€™æ˜¯å¾ˆé‡è¦çš„ï¼Œæ¯”å¦‚æŠ¢è´­æŸä¸€èµ„æºï¼Œè¿™æ—¶å€™ä½¿ç”¨åˆ†å¸ƒå¼é”å°±å¯ä»¥å¾ˆå¥½åœ°æ§åˆ¶èµ„æºã€‚</p><h4 id="19-Etcdæ€ä¹ˆå®ç°åˆ†å¸ƒå¼é”"><a href="#19-Etcdæ€ä¹ˆå®ç°åˆ†å¸ƒå¼é”" class="headerlink" title="19. Etcdæ€ä¹ˆå®ç°åˆ†å¸ƒå¼é”?"></a>19. Etcdæ€ä¹ˆå®ç°åˆ†å¸ƒå¼é”?</h4><p>é¦–å…ˆæ€è€ƒä¸‹Etcdæ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½å¾ˆå¤šäººç¬¬ä¸€ååº”å¯èƒ½æ˜¯ä¸€ä¸ªé”®å€¼å­˜å‚¨ä»“åº“ï¼Œå´æ²¡æœ‰é‡è§†å®˜æ–¹å®šä¹‰çš„ååŠå¥ï¼Œç”¨äºé…ç½®å…±äº«å’ŒæœåŠ¡å‘ç°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A highly-available key value store for shared configuration and service discovery.</span><br></pre></td></tr></table></figure><p>å®é™…ä¸Šï¼Œetcd ä½œä¸ºä¸€ä¸ªå—åˆ° ZooKeeper ä¸ doozer å¯å‘è€Œå‚¬ç”Ÿçš„é¡¹ç›®ï¼Œé™¤äº†æ‹¥æœ‰ä¸ä¹‹ç±»ä¼¼çš„åŠŸèƒ½å¤–ï¼Œæ›´ä¸“æ³¨äºä»¥ä¸‹å››ç‚¹ã€‚</p><ul><li>ç®€å•ï¼šåŸºäº HTTP+JSON çš„ API è®©ä½ ç”¨ curl å°±å¯ä»¥è½»æ¾ä½¿ç”¨ã€‚</li><li>å®‰å…¨ï¼šå¯é€‰ SSL å®¢æˆ·è®¤è¯æœºåˆ¶ã€‚</li><li>å¿«é€Ÿï¼šæ¯ä¸ªå®ä¾‹æ¯ç§’æ”¯æŒä¸€åƒæ¬¡å†™æ“ä½œã€‚</li><li>å¯ä¿¡ï¼šä½¿ç”¨ Raft ç®—æ³•å……åˆ†å®ç°äº†åˆ†å¸ƒå¼ã€‚</li></ul><p>ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬ä¸»è¦è®²è¿°Etcdå¦‚ä½•å®ç°åˆ†å¸ƒå¼é”?</p><p>å› ä¸º Etcd ä½¿ç”¨ Raft ç®—æ³•ä¿æŒäº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼ŒæŸæ¬¡æ“ä½œå­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å€¼å¿…ç„¶æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å®ç°åˆ†å¸ƒå¼é”ã€‚é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æ§åˆ¶æ—¶åºã€‚</p><ul><li>ä¿æŒç‹¬å å³æ‰€æœ‰è·å–é”çš„ç”¨æˆ·æœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥å¾—åˆ°ã€‚etcd ä¸ºæ­¤æä¾›äº†ä¸€å¥—å®ç°åˆ†å¸ƒå¼é”åŸå­æ“ä½œ CASï¼ˆCompareAndSwapï¼‰çš„ APIã€‚é€šè¿‡è®¾ç½®prevExistå€¼ï¼Œå¯ä»¥ä¿è¯åœ¨å¤šä¸ªèŠ‚ç‚¹åŒæ—¶å»åˆ›å»ºæŸä¸ªç›®å½•æ—¶ï¼Œåªæœ‰ä¸€ä¸ªæˆåŠŸã€‚è€Œåˆ›å»ºæˆåŠŸçš„ç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºæ˜¯è·å¾—äº†é”ã€‚</li><li>æ§åˆ¶æ—¶åºï¼Œå³æ‰€æœ‰æƒ³è¦è·å¾—é”çš„ç”¨æˆ·éƒ½ä¼šè¢«å®‰æ’æ‰§è¡Œï¼Œä½†æ˜¯è·å¾—é”çš„é¡ºåºä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ï¼ŒåŒæ—¶å†³å®šäº†æ‰§è¡Œé¡ºåºã€‚etcd ä¸ºæ­¤ä¹Ÿæä¾›äº†ä¸€å¥— APIï¼ˆè‡ªåŠ¨åˆ›å»ºæœ‰åºé”®ï¼‰ï¼Œå¯¹ä¸€ä¸ªç›®å½•å»ºå€¼æ—¶æŒ‡å®šä¸ºPOSTåŠ¨ä½œï¼Œè¿™æ · etcd ä¼šè‡ªåŠ¨åœ¨ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå½“å‰æœ€å¤§çš„å€¼ä¸ºé”®ï¼Œå­˜å‚¨è¿™ä¸ªæ–°çš„å€¼ï¼ˆå®¢æˆ·ç«¯ç¼–å·ï¼‰ã€‚åŒæ—¶è¿˜å¯ä»¥ä½¿ç”¨ API æŒ‰é¡ºåºåˆ—å‡ºæ‰€æœ‰å½“å‰ç›®å½•ä¸‹çš„é”®å€¼ã€‚æ­¤æ—¶è¿™äº›é”®çš„å€¼å°±æ˜¯å®¢æˆ·ç«¯çš„æ—¶åºï¼Œè€Œè¿™äº›é”®ä¸­å­˜å‚¨çš„å€¼å¯ä»¥æ˜¯ä»£è¡¨å®¢æˆ·ç«¯çš„ç¼–å·ã€‚</li></ul><p>åœ¨è¿™é‡ŒEctdå®ç°åˆ†å¸ƒå¼é”åŸºæœ¬å®ç°åŸç†ä¸ºï¼š</p><ol><li>åœ¨ectdç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªkey</li><li>å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œkeyå­˜åœ¨ï¼Œåˆ™ç›‘å¬è¯¥keyçš„å˜åŒ–äº‹ä»¶ï¼Œç›´åˆ°è¯¥keyè¢«åˆ é™¤ï¼Œå›åˆ°1</li><li>å¦‚æœåˆ›å»ºæˆåŠŸï¼Œåˆ™è®¤ä¸ºæˆ‘è·å¾—äº†é”</li></ol><p>åº”ç”¨ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">package etcdsync</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;io&quot;</span><br><span class="line">&quot;os&quot;</span><br><span class="line">&quot;sync&quot;</span><br><span class="line">&quot;time&quot;</span><br><span class="line"></span><br><span class="line">&quot;github.com/coreos/etcd/client&quot;</span><br><span class="line">&quot;github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">defaultTTL = 60</span><br><span class="line">defaultTry = 3</span><br><span class="line">deleteAction = &quot;delete&quot;</span><br><span class="line">expireAction = &quot;expire&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// A Mutex is a mutual exclusion lock which is distributed across a cluster.</span><br><span class="line">type Mutex struct &#123;</span><br><span class="line">key    string</span><br><span class="line">id     string // The identity of the caller</span><br><span class="line">client client.Client</span><br><span class="line">kapi   client.KeysAPI</span><br><span class="line">ctx    context.Context</span><br><span class="line">ttl    time.Duration</span><br><span class="line">mutex  *sync.Mutex</span><br><span class="line">logger io.Writer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// New creates a Mutex with the given key which must be the same</span><br><span class="line">// across the cluster nodes.</span><br><span class="line">// machines are the ectd cluster addresses</span><br><span class="line">func New(key string, ttl int, machines []string) *Mutex &#123;</span><br><span class="line">cfg := client.Config&#123;</span><br><span class="line">Endpoints:               machines,</span><br><span class="line">Transport:               client.DefaultTransport,</span><br><span class="line">HeaderTimeoutPerRequest: time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">c, err := client.New(cfg)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hostname, err := os.Hostname()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if len(key) == 0 || len(machines) == 0 &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if key[0] != &apos;/&apos; &#123;</span><br><span class="line">key = &quot;/&quot; + key</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if ttl &lt; 1 &#123;</span><br><span class="line">ttl = defaultTTL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">return &amp;Mutex&#123;</span><br><span class="line">key:    key,</span><br><span class="line">id:     fmt.Sprintf(&quot;%v-%v-%v&quot;, hostname, os.Getpid(), time.Now().Format(&quot;20060102-15:04:05.999999999&quot;)),</span><br><span class="line">client: c,</span><br><span class="line">kapi:   client.NewKeysAPI(c),</span><br><span class="line">ctx: context.TODO(),</span><br><span class="line">ttl: time.Second * time.Duration(ttl),</span><br><span class="line">mutex:  new(sync.Mutex),</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Lock locks m.</span><br><span class="line">// If the lock is already in use, the calling goroutine</span><br><span class="line">// blocks until the mutex is available.</span><br><span class="line">func (m *Mutex) Lock() (err error) &#123;</span><br><span class="line">m.mutex.Lock()</span><br><span class="line">for try := 1; try &lt;= defaultTry; try++ &#123;</span><br><span class="line">if m.lock() == nil &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m.debug(&quot;Lock node %v ERROR %v&quot;, m.key, err)</span><br><span class="line">if try &lt; defaultTry &#123;</span><br><span class="line">m.debug(&quot;Try to lock node %v again&quot;, m.key, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (m *Mutex) lock() (err error) &#123;</span><br><span class="line">m.debug(&quot;Trying to create a node : key=%v&quot;, m.key)</span><br><span class="line">setOptions := &amp;client.SetOptions&#123;</span><br><span class="line">PrevExist:client.PrevNoExist,</span><br><span class="line">TTL:      m.ttl,</span><br><span class="line">&#125;</span><br><span class="line">resp, err := m.kapi.Set(m.ctx, m.key, m.id, setOptions)</span><br><span class="line">if err == nil &#123;</span><br><span class="line">m.debug(&quot;Create node %v OK [%q]&quot;, m.key, resp)</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">m.debug(&quot;Create node %v failed [%v]&quot;, m.key, err)</span><br><span class="line">e, ok := err.(client.Error)</span><br><span class="line">if !ok &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if e.Code != client.ErrorCodeNodeExist &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Get the already node&apos;s value.</span><br><span class="line">resp, err = m.kapi.Get(m.ctx, m.key, nil)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line">m.debug(&quot;Get node %v OK&quot;, m.key)</span><br><span class="line">watcherOptions := &amp;client.WatcherOptions&#123;</span><br><span class="line">AfterIndex : resp.Index,</span><br><span class="line">Recursive:false,</span><br><span class="line">&#125;</span><br><span class="line">watcher := m.kapi.Watcher(m.key, watcherOptions)</span><br><span class="line">for &#123;</span><br><span class="line">m.debug(&quot;Watching %v ...&quot;, m.key)</span><br><span class="line">resp, err = watcher.Next(m.ctx)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m.debug(&quot;Received an event : %q&quot;, resp)</span><br><span class="line">if resp.Action == deleteAction || resp.Action == expireAction &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// Unlock unlocks m.</span><br><span class="line">// It is a run-time error if m is not locked on entry to Unlock.</span><br><span class="line">//</span><br><span class="line">// A locked Mutex is not associated with a particular goroutine.</span><br><span class="line">// It is allowed for one goroutine to lock a Mutex and then</span><br><span class="line">// arrange for another goroutine to unlock it.</span><br><span class="line">func (m *Mutex) Unlock() (err error) &#123;</span><br><span class="line">defer m.mutex.Unlock()</span><br><span class="line">for i := 1; i &lt;= defaultTry; i++ &#123;</span><br><span class="line">var resp *client.Response</span><br><span class="line">resp, err = m.kapi.Delete(m.ctx, m.key, nil)</span><br><span class="line">if err == nil &#123;</span><br><span class="line">m.debug(&quot;Delete %v OK&quot;, m.key)</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">m.debug(&quot;Delete %v falied: %q&quot;, m.key, resp)</span><br><span class="line">e, ok := err.(client.Error)</span><br><span class="line">if ok &amp;&amp; e.Code == client.ErrorCodeKeyNotFound &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">return err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (m *Mutex) debug(format string, v ...interface&#123;&#125;) &#123;</span><br><span class="line">if m.logger != nil &#123;</span><br><span class="line">m.logger.Write([]byte(m.id))</span><br><span class="line">m.logger.Write([]byte(&quot; &quot;))</span><br><span class="line">m.logger.Write([]byte(fmt.Sprintf(format, v...)))</span><br><span class="line">m.logger.Write([]byte(&quot;\n&quot;))</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (m *Mutex) SetDebugLogger(w io.Writer) &#123;</span><br><span class="line">m.logger = w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®ç±»ä¼¼çš„å®ç°æœ‰å¾ˆå¤šï¼Œä½†ç›®å‰éƒ½å·²ç»è¿‡æ—¶ï¼Œä½¿ç”¨çš„éƒ½æ˜¯è¢«å®˜æ–¹æ ‡è®°ä¸ºdeprecatedçš„é¡¹ç›®ã€‚ä¸”å¤§éƒ¨åˆ†æ¥å£éƒ½ä¸å¦‚ä¸Šè¿°ä»£ç ç®€å•ã€‚ ä½¿ç”¨ä¸Šï¼Œè·ŸGolangå®˜æ–¹syncåŒ…çš„Mutexæ¥å£éå¸¸ç±»ä¼¼ï¼Œå…ˆNew()ï¼Œç„¶åè°ƒç”¨Lock()ï¼Œä½¿ç”¨å®Œåè°ƒç”¨Unlock()ï¼Œå°±ä¸‰ä¸ªæ¥å£ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;github.com/zieckey/etcdsync&quot;</span><br><span class="line">&quot;log&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">//etcdsync.SetDebug(true)</span><br><span class="line">log.SetFlags(log.Ldate|log.Ltime|log.Lshortfile)</span><br><span class="line">m := etcdsync.New(&quot;/etcdsync&quot;, &quot;123&quot;, []string&#123;&quot;http://127.0.0.1:2379&quot;&#125;)</span><br><span class="line">if m == nil &#123;</span><br><span class="line">log.Printf(&quot;etcdsync.NewMutex failed&quot;)</span><br><span class="line">&#125;</span><br><span class="line">err := m.Lock()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">log.Printf(&quot;etcdsync.Lock failed&quot;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">log.Printf(&quot;etcdsync.Lock OK&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">log.Printf(&quot;Get the lock. Do something here.&quot;)</span><br><span class="line"></span><br><span class="line">err = m.Unlock()</span><br><span class="line">if err != nil &#123;</span><br><span class="line">log.Printf(&quot;etcdsync.Unlock failed&quot;)</span><br><span class="line">&#125; else &#123;</span><br><span class="line">log.Printf(&quot;etcdsync.Unlock OK&quot;)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="20-Redisçš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Œä»¥åŠå®ç°åœºæ™¯"><a href="#20-Redisçš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Œä»¥åŠå®ç°åœºæ™¯" class="headerlink" title="20. Redisçš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Œä»¥åŠå®ç°åœºæ™¯?"></a>20. Redisçš„æ•°æ®ç»“æ„æœ‰å“ªäº›ï¼Œä»¥åŠå®ç°åœºæ™¯?</h4><p>Redisçš„æ•°æ®ç»“æ„æœ‰äº”ç§:</p><ul><li>string å­—ç¬¦ä¸²</li></ul><p>String æ•°æ®ç»“æ„æ˜¯ç®€å•çš„ key-value ç±»å‹ï¼Œvalue ä¸ä»…å¯ä»¥æ˜¯ Stringï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å­—ï¼ˆå½“æ•°å­—ç±»å‹ç”¨ Long å¯ä»¥è¡¨ç¤ºçš„æ—¶å€™encoding å°±æ˜¯æ•´å‹ï¼Œå…¶ä»–éƒ½å­˜å‚¨åœ¨ sdshdr å½“åšå­—ç¬¦ä¸²ï¼‰ã€‚ä½¿ç”¨ Strings ç±»å‹ï¼Œå¯ä»¥å®Œå…¨å®ç°ç›®å‰ Memcached çš„åŠŸèƒ½ï¼Œå¹¶ä¸”æ•ˆç‡æ›´é«˜ã€‚è¿˜å¯ä»¥äº«å— Redis çš„å®šæ—¶æŒä¹…åŒ–ï¼ˆå¯ä»¥é€‰æ‹© RDB æ¨¡å¼æˆ–è€… AOF æ¨¡å¼ï¼‰ï¼Œæ“ä½œæ—¥å¿—åŠ Replication ç­‰åŠŸèƒ½ã€‚</p><p>é™¤äº†æä¾›ä¸ Memcached ä¸€æ ·çš„ getã€setã€incrã€decr ç­‰æ“ä½œå¤–ï¼ŒRedis è¿˜æä¾›äº†ä¸‹é¢ä¸€äº›æ“ä½œï¼š</p><ol><li>LEN niushuaiï¼šO(1)è·å–å­—ç¬¦ä¸²é•¿åº¦.</li><li>APPEND niushuai redisï¼šå¾€å­—ç¬¦ä¸² append å†…å®¹ï¼Œè€Œä¸”é‡‡ç”¨æ™ºèƒ½åˆ†é…å†…å­˜ï¼ˆæ¯æ¬¡2å€ï¼‰.</li><li>è®¾ç½®å’Œè·å–å­—ç¬¦ä¸²çš„æŸä¸€æ®µå†…å®¹.</li><li>è®¾ç½®åŠè·å–å­—ç¬¦ä¸²çš„æŸä¸€ä½ï¼ˆbitï¼‰.</li><li>æ‰¹é‡è®¾ç½®ä¸€ç³»åˆ—å­—ç¬¦ä¸²çš„å†…å®¹.</li><li>åŸå­è®¡æ•°å™¨.</li><li>GETSET å‘½ä»¤çš„å¦™ç”¨ï¼Œè¯·äºæ¸…ç©ºæ—§å€¼çš„åŒæ—¶è®¾ç½®ä¸€ä¸ªæ–°å€¼ï¼Œé…åˆåŸå­è®¡æ•°å™¨ä½¿ç”¨.</li></ol><ul><li>Hash å­—å…¸</li></ul><p>åœ¨ Memcached ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸å°†ä¸€äº›ç»“æ„åŒ–çš„ä¿¡æ¯æ‰“åŒ…æˆ hashmapï¼Œåœ¨å®¢æˆ·ç«¯åºåˆ—åŒ–åå­˜å‚¨ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²çš„å€¼ï¼ˆä¸€èˆ¬æ˜¯ JSON æ ¼å¼ï¼‰ï¼Œæ¯”å¦‚ç”¨æˆ·çš„æ˜µç§°ã€å¹´é¾„ã€æ€§åˆ«ã€ç§¯åˆ†ç­‰ã€‚è¿™æ—¶å€™åœ¨éœ€è¦ä¿®æ”¹å…¶ä¸­æŸä¸€é¡¹æ—¶ï¼Œé€šå¸¸éœ€è¦å°†å­—ç¬¦ä¸²ï¼ˆJSONï¼‰å–å‡ºæ¥ï¼Œç„¶åè¿›è¡Œååºåˆ—åŒ–ï¼Œä¿®æ”¹æŸä¸€é¡¹çš„å€¼ï¼Œå†åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼ˆJSONï¼‰å­˜å‚¨å›å»ã€‚ç®€å•ä¿®æ”¹ä¸€ä¸ªå±æ€§å°±å¹²è¿™ä¹ˆå¤šäº‹æƒ…ï¼Œæ¶ˆè€—å¿…å®šæ˜¯å¾ˆå¤§çš„ï¼Œä¹Ÿä¸é€‚ç”¨äºä¸€äº›å¯èƒ½å¹¶å‘æ“ä½œçš„åœºåˆï¼ˆæ¯”å¦‚ä¸¤ä¸ªå¹¶å‘çš„æ“ä½œéƒ½éœ€è¦ä¿®æ”¹ç§¯åˆ†ï¼‰ã€‚è€Œ Redis çš„ Hash ç»“æ„å¯ä»¥ä½¿ä½ åƒåœ¨æ•°æ®åº“ä¸­ Update ä¸€ä¸ªå±æ€§ä¸€æ ·åªä¿®æ”¹æŸä¸€é¡¹å±æ€§å€¼ã€‚</p><p>Hashå¯ä»¥ç”¨æ¥å­˜å‚¨ã€è¯»å–ã€ä¿®æ”¹ç”¨æˆ·å±æ€§ã€‚</p><ul><li>List åˆ—è¡¨</li></ul><p>List è¯´ç™½äº†å°±æ˜¯é“¾è¡¨ï¼ˆredis ä½¿ç”¨åŒç«¯é“¾è¡¨å®ç°çš„ Listï¼‰ï¼Œç›¸ä¿¡å­¦è¿‡æ•°æ®ç»“æ„çŸ¥è¯†çš„äººéƒ½åº”è¯¥èƒ½ç†è§£å…¶ç»“æ„ã€‚ä½¿ç”¨ List ç»“æ„ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®ç°æœ€æ–°æ¶ˆæ¯æ’è¡Œç­‰åŠŸèƒ½ï¼ˆæ¯”å¦‚æ–°æµªå¾®åšçš„ TimeLine ï¼‰ã€‚List çš„å¦ä¸€ä¸ªåº”ç”¨å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥åˆ©ç”¨ List çš„ *PUSH æ“ä½œï¼Œå°†ä»»åŠ¡å­˜åœ¨ List ä¸­ï¼Œç„¶åå·¥ä½œçº¿ç¨‹å†ç”¨ POP æ“ä½œå°†ä»»åŠ¡å–å‡ºè¿›è¡Œæ‰§è¡Œã€‚</p><p>Redis è¿˜æä¾›äº†æ“ä½œ List ä¸­æŸä¸€æ®µå…ƒç´ çš„ APIï¼Œä½ å¯ä»¥ç›´æ¥æŸ¥è¯¢ï¼Œåˆ é™¤ List ä¸­æŸä¸€æ®µçš„å…ƒç´ ã€‚</p><p>List åˆ—è¡¨åº”ç”¨:</p><ol><li>å¾®åš TimeLine.</li><li>æ¶ˆæ¯é˜Ÿåˆ—.</li></ol><ul><li>Set é›†åˆ</li></ul><p>Set å°±æ˜¯ä¸€ä¸ªé›†åˆï¼Œé›†åˆçš„æ¦‚å¿µå°±æ˜¯ä¸€å †ä¸é‡å¤å€¼çš„ç»„åˆã€‚åˆ©ç”¨ Redis æä¾›çš„ Set æ•°æ®ç»“æ„ï¼Œå¯ä»¥å­˜å‚¨ä¸€äº›é›†åˆæ€§çš„æ•°æ®ã€‚æ¯”å¦‚åœ¨å¾®åšåº”ç”¨ä¸­ï¼Œå¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚å› ä¸º Redis éå¸¸äººæ€§åŒ–çš„ä¸ºé›†åˆæä¾›äº†æ±‚äº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥éå¸¸æ–¹ä¾¿çš„å®ç°å¦‚å…±åŒå…³æ³¨ã€å…±åŒå–œå¥½ã€äºŒåº¦å¥½å‹ç­‰åŠŸèƒ½ï¼Œå¯¹ä¸Šé¢çš„æ‰€æœ‰é›†åˆæ“ä½œï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‘½ä»¤é€‰æ‹©å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯è¿˜æ˜¯å­˜é›†åˆ°ä¸€ä¸ªæ–°çš„é›†åˆä¸­ã€‚</p><p>Set é›†åˆåº”ç”¨:</p><ol><li>å…±åŒå¥½å‹ã€äºŒåº¦å¥½å‹</li><li>åˆ©ç”¨å”¯ä¸€æ€§ï¼Œå¯ä»¥ç»Ÿè®¡è®¿é—®ç½‘ç«™çš„æ‰€æœ‰ç‹¬ç«‹ IP.</li><li>å¥½å‹æ¨èçš„æ—¶å€™ï¼Œæ ¹æ® tag æ±‚äº¤é›†ï¼Œå¤§äºæŸä¸ª threshold å°±å¯ä»¥æ¨è.</li></ol><ul><li>Sorted Setæœ‰åºé›†åˆ</li></ul><p>å’ŒSetsç›¸æ¯”ï¼ŒSorted Setsæ˜¯å°† Set ä¸­çš„å…ƒç´ å¢åŠ äº†ä¸€ä¸ªæƒé‡å‚æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ score è¿›è¡Œæœ‰åºæ’åˆ—ï¼Œæ¯”å¦‚ä¸€ä¸ªå­˜å‚¨å…¨ç­åŒå­¦æˆç»©çš„ Sorted Setsï¼Œå…¶é›†åˆ value å¯ä»¥æ˜¯åŒå­¦çš„å­¦å·ï¼Œè€Œ score å°±å¯ä»¥æ˜¯å…¶è€ƒè¯•å¾—åˆ†ï¼Œè¿™æ ·åœ¨æ•°æ®æ’å…¥é›†åˆçš„æ—¶å€™ï¼Œå°±å·²ç»è¿›è¡Œäº†å¤©ç„¶çš„æ’åºã€‚å¦å¤–è¿˜å¯ä»¥ç”¨ Sorted Sets æ¥åšå¸¦æƒé‡çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚æ™®é€šæ¶ˆæ¯çš„ score ä¸º1ï¼Œé‡è¦æ¶ˆæ¯çš„ score ä¸º2ï¼Œç„¶åå·¥ä½œçº¿ç¨‹å¯ä»¥é€‰æ‹©æŒ‰ score çš„å€’åºæ¥è·å–å·¥ä½œä»»åŠ¡ã€‚è®©é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚</p><p>Sorted Setæœ‰åºé›†åˆåº”ç”¨:</p><p>1.å¸¦æœ‰æƒé‡çš„å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ªæ¸¸æˆçš„ç”¨æˆ·å¾—åˆ†æ’è¡Œæ¦œ. 2.æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç»“æ„ï¼Œä¸€èˆ¬ç”¨åˆ°çš„åœºæ™¯ä¸ç®—å¤ªå¤š.</p><p>Redis å…¶ä»–åŠŸèƒ½ä½¿ç”¨åœºæ™¯:</p><ul><li>è®¢é˜…-å‘å¸ƒç³»ç»Ÿ</li></ul><p>Pub/Sub ä»å­—é¢ä¸Šç†è§£å°±æ˜¯å‘å¸ƒï¼ˆPublishï¼‰ä¸è®¢é˜…ï¼ˆSubscribeï¼‰ï¼Œåœ¨ Redis ä¸­ï¼Œä½ å¯ä»¥è®¾å®šå¯¹æŸä¸€ä¸ª key å€¼è¿›è¡Œæ¶ˆæ¯å‘å¸ƒåŠæ¶ˆæ¯è®¢é˜…ï¼Œå½“ä¸€ä¸ª key å€¼ä¸Šè¿›è¡Œäº†æ¶ˆæ¯å‘å¸ƒåï¼Œæ‰€æœ‰è®¢é˜…å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°ç›¸åº”çš„æ¶ˆæ¯ã€‚è¿™ä¸€åŠŸèƒ½æœ€æ˜æ˜¾çš„ç”¨æ³•å°±æ˜¯ç”¨ä½œå®æ—¶æ¶ˆæ¯ç³»ç»Ÿï¼Œæ¯”å¦‚æ™®é€šçš„å³æ—¶èŠå¤©ï¼Œç¾¤èŠç­‰åŠŸèƒ½ã€‚</p><ul><li>äº‹åŠ¡â€”â€”Transactions</li></ul><p>è°è¯´ NoSQL éƒ½ä¸æ”¯æŒäº‹åŠ¡ï¼Œè™½ç„¶ Redis çš„ Transactions æä¾›çš„å¹¶ä¸æ˜¯ä¸¥æ ¼çš„ ACID çš„äº‹åŠ¡ï¼ˆæ¯”å¦‚ä¸€ä¸²ç”¨ EXEC æäº¤æ‰§è¡Œçš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œä¸­æœåŠ¡å™¨å®•æœºï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œäº†ï¼Œå‰©ä¸‹çš„æ²¡æ‰§è¡Œï¼‰ï¼Œä½†æ˜¯è¿™ä¸ª Transactions è¿˜æ˜¯æä¾›äº†åŸºæœ¬çš„å‘½ä»¤æ‰“åŒ…æ‰§è¡Œçš„åŠŸèƒ½ï¼ˆåœ¨æœåŠ¡å™¨ä¸å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¿è¯ä¸€è¿ä¸²çš„å‘½ä»¤æ˜¯é¡ºåºåœ¨ä¸€èµ·æ‰§è¡Œçš„ï¼Œä¸­é—´æœ‰ä¼šæœ‰å…¶å®ƒå®¢æˆ·ç«¯å‘½ä»¤æ’è¿›æ¥æ‰§è¡Œï¼‰ã€‚Redis è¿˜æä¾›äº†ä¸€ä¸ª Watch åŠŸèƒ½ï¼Œä½ å¯ä»¥å¯¹ä¸€ä¸ª key è¿›è¡Œ Watchï¼Œç„¶åå†æ‰§è¡Œ Transactionsï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œå¦‚æœè¿™ä¸ª Watched çš„å€¼è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ª Transactions ä¼šå‘ç°å¹¶æ‹’ç»æ‰§è¡Œã€‚</p><h4 id="21-Mysqlé«˜å¯ç”¨æ–¹æ¡ˆæœ‰å“ªäº›"><a href="#21-Mysqlé«˜å¯ç”¨æ–¹æ¡ˆæœ‰å“ªäº›" class="headerlink" title="21. Mysqlé«˜å¯ç”¨æ–¹æ¡ˆæœ‰å“ªäº›?"></a>21. Mysqlé«˜å¯ç”¨æ–¹æ¡ˆæœ‰å“ªäº›?</h4><p>Mysqlé«˜å¯ç”¨æ–¹æ¡ˆåŒ…æ‹¬:</p><ol><li>ä¸»ä»å¤åˆ¶æ–¹æ¡ˆ</li></ol><p>è¿™æ˜¯MySQLè‡ªèº«æä¾›çš„ä¸€ç§é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œæ•°æ®åŒæ­¥æ–¹æ³•é‡‡ç”¨çš„æ˜¯MySQL replicationæŠ€æœ¯ã€‚MySQL replicationå°±æ˜¯ä»æœåŠ¡å™¨åˆ°ä¸»æœåŠ¡å™¨æ‹‰å–äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åå†å°†æ—¥å¿—æ–‡ä»¶è§£ææˆç›¸åº”çš„SQLåœ¨ä»æœåŠ¡å™¨ä¸Šé‡æ–°æ‰§è¡Œä¸€éä¸»æœåŠ¡å™¨çš„æ“ä½œï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ä¸ºäº†è¾¾åˆ°æ›´é«˜çš„å¯ç”¨æ€§ï¼Œåœ¨å®é™…çš„åº”ç”¨ç¯å¢ƒä¸­ï¼Œä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨MySQL replicationæŠ€æœ¯é…åˆé«˜å¯ç”¨é›†ç¾¤è½¯ä»¶keepalivedæ¥å®ç°è‡ªåŠ¨failoverï¼Œè¿™ç§æ–¹å¼å¯ä»¥å®ç°95.000%çš„SLAã€‚</p><ol><li>MMM/MHAé«˜å¯ç”¨æ–¹æ¡ˆ</li></ol><p>MMMæä¾›äº†MySQLä¸»ä¸»å¤åˆ¶é…ç½®çš„ç›‘æ§ã€æ•…éšœè½¬ç§»å’Œç®¡ç†çš„ä¸€å¥—å¯ä¼¸ç¼©çš„è„šæœ¬å¥—ä»¶ã€‚åœ¨MMMé«˜å¯ç”¨æ–¹æ¡ˆä¸­ï¼Œå…¸å‹çš„åº”ç”¨æ˜¯åŒä¸»å¤šä»æ¶æ„ï¼Œé€šè¿‡MySQL replicationæŠ€æœ¯å¯ä»¥å®ç°ä¸¤ä¸ªæœåŠ¡å™¨äº’ä¸ºä¸»ä»ï¼Œä¸”åœ¨ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥è¢«å†™å…¥ï¼Œé¿å…äº†å¤šç‚¹å†™å…¥çš„æ•°æ®å†²çªã€‚åŒæ—¶ï¼Œå½“å¯å†™çš„ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒMMMå¥—ä»¶å¯ä»¥ç«‹åˆ»ç›‘æ§åˆ°ï¼Œç„¶åå°†æœåŠ¡è‡ªåŠ¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ï¼Œä»è€Œå®ç°MySQLçš„é«˜å¯ç”¨ã€‚</p><ol><li>Heartbeat/SANé«˜å¯ç”¨æ–¹æ¡ˆ</li></ol><p>åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œå¤„ç†failoverçš„æ–¹å¼æ˜¯é«˜å¯ç”¨é›†ç¾¤è½¯ä»¶Heartbeatï¼Œå®ƒç›‘æ§å’Œç®¡ç†å„ä¸ªèŠ‚ç‚¹é—´è¿æ¥çš„ç½‘ç»œï¼Œå¹¶ç›‘æ§é›†ç¾¤æœåŠ¡ï¼Œå½“èŠ‚ç‚¹å‡ºç°æ•…éšœæˆ–è€…æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨åœ¨å…¶ä»–èŠ‚ç‚¹å¯åŠ¨é›†ç¾¤æœåŠ¡ã€‚åœ¨æ•°æ®å…±äº«æ–¹é¢ï¼Œé€šè¿‡SANï¼ˆStorage Area Networkï¼‰å­˜å‚¨æ¥å…±äº«æ•°æ®ï¼Œè¿™ç§æ–¹æ¡ˆå¯ä»¥å®ç°99.990%çš„SLAã€‚</p><ol><li>Heartbeat/DRBDé«˜å¯ç”¨æ–¹æ¡ˆ</li></ol><p>è¿™ä¸ªæ–¹æ¡ˆå¤„ç†failoverçš„æ–¹å¼ä¸Šä¾æ—§é‡‡ç”¨Heartbeatï¼Œä¸åŒçš„æ˜¯ï¼Œåœ¨æ•°æ®å…±äº«æ–¹é¢ï¼Œé‡‡ç”¨äº†åŸºäºå—çº§åˆ«çš„æ•°æ®åŒæ­¥è½¯ä»¶DRBDæ¥å®ç°ã€‚DRBDæ˜¯ä¸€ä¸ªç”¨è½¯ä»¶å®ç°çš„ã€æ— å…±äº«çš„ã€æœåŠ¡å™¨ä¹‹é—´é•œåƒå—è®¾å¤‡å†…å®¹çš„å­˜å‚¨å¤åˆ¶è§£å†³æ–¹æ¡ˆã€‚å’ŒSANç½‘ç»œä¸åŒï¼Œå®ƒå¹¶ä¸å…±äº«å­˜å‚¨ï¼Œè€Œæ˜¯é€šè¿‡æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œå¤åˆ¶æ•°æ®ã€‚</p><ol><li>NDB CLUSTERé«˜å¯ç”¨æ–¹æ¡ˆ</li></ol><p>å›½å†…ç”¨NDBé›†ç¾¤çš„å…¬å¸éå¸¸å°‘ï¼Œè²Œä¼¼æœ‰äº›é“¶è¡Œæœ‰ç”¨ã€‚NDBé›†ç¾¤ä¸éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå…¨éƒ¨éƒ½ä½¿ç”¨å®˜æ–¹ç»„ä»¶ï¼Œèƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŒæŸä¸ªæ•°æ®èŠ‚ç‚¹æŒ‚æ‰ï¼Œå…¶ä»–æ•°æ®èŠ‚ç‚¹ä¾ç„¶å¯ä»¥æä¾›æœåŠ¡ï¼Œç®¡ç†èŠ‚ç‚¹éœ€è¦åšå†—ä½™ä»¥é˜²æŒ‚æ‰ã€‚ç¼ºç‚¹æ˜¯ï¼šç®¡ç†å’Œé…ç½®éƒ½å¾ˆå¤æ‚ï¼Œè€Œä¸”æŸäº›SQLè¯­å¥ä¾‹å¦‚joinè¯­å¥éœ€è¦é¿å…ã€‚</p><h4 id="22-Goè¯­è¨€çš„æ ˆç©ºé—´ç®¡ç†æ˜¯æ€ä¹ˆæ ·çš„"><a href="#22-Goè¯­è¨€çš„æ ˆç©ºé—´ç®¡ç†æ˜¯æ€ä¹ˆæ ·çš„" class="headerlink" title="22. Goè¯­è¨€çš„æ ˆç©ºé—´ç®¡ç†æ˜¯æ€ä¹ˆæ ·çš„?"></a>22. Goè¯­è¨€çš„æ ˆç©ºé—´ç®¡ç†æ˜¯æ€ä¹ˆæ ·çš„?</h4><p>Goè¯­è¨€çš„è¿è¡Œç¯å¢ƒï¼ˆruntimeï¼‰ä¼šåœ¨goroutineéœ€è¦çš„æ—¶å€™åŠ¨æ€åœ°åˆ†é…æ ˆç©ºé—´ï¼Œè€Œä¸æ˜¯ç»™æ¯ä¸ªgoroutineåˆ†é…å›ºå®šå¤§å°çš„å†…å­˜ç©ºé—´ã€‚è¿™æ ·å°±é¿å…äº†éœ€è¦ç¨‹åºå‘˜æ¥å†³å®šæ ˆçš„å¤§å°ã€‚</p><p>åˆ†å—å¼çš„æ ˆæ˜¯æœ€åˆGoè¯­è¨€ç»„ç»‡æ ˆçš„æ–¹å¼ã€‚å½“åˆ›å»ºä¸€ä¸ªgoroutineçš„æ—¶å€™ï¼Œå®ƒä¼šåˆ†é…ä¸€ä¸ª8KBçš„å†…å­˜ç©ºé—´æ¥ç»™goroutineçš„æ ˆä½¿ç”¨ã€‚æˆ‘ä»¬å¯èƒ½ä¼šè€ƒè™‘å½“è¿™8KBçš„æ ˆç©ºé—´è¢«ç”¨å®Œçš„æ—¶å€™è¯¥æ€ä¹ˆåŠ?</p><p>ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œæ¯ä¸ªGoå‡½æ•°çš„å¼€å¤´éƒ½æœ‰ä¸€å°æ®µæ£€æµ‹ä»£ç ã€‚è¿™æ®µä»£ç ä¼šæ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å·²ç»ç”¨å®Œäº†åˆ†é…çš„æ ˆç©ºé—´ã€‚å¦‚æœæ˜¯çš„è¯ï¼Œå®ƒä¼šè°ƒç”¨<code>morestack</code>å‡½æ•°ã€‚<code>morestack</code>å‡½æ•°åˆ†é…ä¸€å—æ–°çš„å†…å­˜ä½œä¸ºæ ˆç©ºé—´ï¼Œå¹¶ä¸”åœ¨è¿™å—æ ˆç©ºé—´çš„åº•éƒ¨å¡«å…¥å„ç§ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„é‚£å—æ ˆåœ°å€ï¼‰ã€‚åœ¨åˆ†é…äº†è¿™å—æ–°çš„æ ˆç©ºé—´ä¹‹åï¼Œå®ƒä¼šé‡è¯•åˆšæ‰é€ æˆæ ˆç©ºé—´ä¸è¶³çš„å‡½æ•°ã€‚è¿™ä¸ªè¿‡ç¨‹å«åšæ ˆåˆ†è£‚ï¼ˆstack splitï¼‰ã€‚</p><p>åœ¨æ–°åˆ†é…çš„æ ˆåº•éƒ¨ï¼Œè¿˜æ’å…¥äº†ä¸€ä¸ªå«åš<code>lessstack</code>çš„å‡½æ•°æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•°è¿˜æ²¡æœ‰è¢«è°ƒç”¨ã€‚è¿™æ ·è®¾ç½®æ˜¯ä¸ºäº†ä»åˆšæ‰é€ æˆæ ˆç©ºé—´ä¸è¶³çš„é‚£ä¸ªå‡½æ•°è¿”å›æ—¶åšå‡†å¤‡çš„ã€‚å½“æˆ‘ä»¬ä»é‚£ä¸ªå‡½æ•°è¿”å›æ—¶ï¼Œå®ƒä¼šè·³è½¬åˆ°<code>lessstack</code>ã€‚<code>lessstack</code>å‡½æ•°ä¼šæŸ¥çœ‹åœ¨æ ˆåº•éƒ¨å­˜æ”¾çš„æ•°æ®ç»“æ„é‡Œçš„ä¿¡æ¯ï¼Œç„¶åè°ƒæ•´æ ˆæŒ‡é’ˆï¼ˆstack pointerï¼‰ã€‚è¿™æ ·å°±å®Œæˆäº†ä»æ–°çš„æ ˆå—åˆ°è€çš„æ ˆå—çš„è·³è½¬ã€‚æ¥ä¸‹æ¥ï¼Œæ–°åˆ†é…çš„è¿™ä¸ªå—æ ˆç©ºé—´å°±å¯ä»¥è¢«é‡Šæ”¾æ‰äº†ã€‚</p><p><code>åˆ†å—å¼çš„æ ˆ</code>è®©æˆ‘ä»¬èƒ½å¤ŸæŒ‰ç…§éœ€æ±‚æ¥æ‰©å±•å’Œæ”¶ç¼©æ ˆçš„å¤§å°ã€‚ Goå¼€å‘è€…ä¸éœ€è¦èŠ±ç²¾åŠ›å»ä¼°è®¡goroutineä¼šç”¨åˆ°å¤šå¤§çš„æ ˆã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineçš„å¼€é”€ä¹Ÿä¸å¤§ã€‚å½“ Goå¼€å‘è€…ä¸çŸ¥é“æ ˆä¼šæ‰©å±•åˆ°å¤šå°‘å¤§æ—¶ï¼Œå®ƒä¹Ÿèƒ½å¾ˆå¥½çš„å¤„ç†è¿™ç§æƒ…å†µã€‚</p><p>è¿™ä¸€ç›´æ˜¯ä¹‹å‰Goè¯­è¨€ç®¡ç†æ ˆçš„çš„æ–¹æ³•ã€‚ä½†è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªé—®é¢˜ã€‚ç¼©å‡æ ˆç©ºé—´æ˜¯ä¸€ä¸ªå¼€é”€ç›¸å¯¹è¾ƒå¤§çš„æ“ä½œã€‚å¦‚æœåœ¨ä¸€ä¸ªå¾ªç¯é‡Œæœ‰æ ˆåˆ†è£‚ï¼Œé‚£ä¹ˆå®ƒçš„å¼€é”€å°±å˜å¾—ä¸å¯å¿½ç•¥äº†ã€‚ä¸€ä¸ªå‡½æ•°ä¼šæ‰©å±•ï¼Œç„¶ååˆ†è£‚æ ˆã€‚å½“å®ƒè¿”å›çš„æ—¶å€™åˆä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„å†…å­˜å—ã€‚å¦‚æœè¿™äº›éƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªå¾ªç¯é‡Œçš„è¯ï¼Œä»£ä»·æ˜¯ç›¸å½“å¤§çš„ã€‚ è¿™å°±æ˜¯æ‰€è°“çš„çƒ­åˆ†è£‚é—®é¢˜ï¼ˆhot split problemï¼‰ã€‚å®ƒæ˜¯Goè¯­è¨€å¼€å‘è€…é€‰æ‹©æ–°çš„æ ˆç®¡ç†æ–¹æ³•çš„ä¸»è¦åŸå› ã€‚æ–°çš„æ–¹æ³•å«åš<code>æ ˆå¤åˆ¶æ³•ï¼ˆstack copyingï¼‰</code>ã€‚</p><p>æ ˆå¤åˆ¶æ³•ä¸€å¼€å§‹å’Œåˆ†å—å¼çš„æ ˆå¾ˆåƒã€‚å½“goroutineè¿è¡Œå¹¶ç”¨å®Œæ ˆç©ºé—´çš„æ—¶å€™ï¼Œä¸ä¹‹å‰çš„æ–¹æ³•ä¸€æ ·ï¼Œæ ˆæº¢å‡ºæ£€æŸ¥ä¼šè¢«è§¦å‘ã€‚ä½†æ˜¯ï¼Œä¸åƒä¹‹å‰çš„æ–¹æ³•é‚£æ ·åˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜å—å¹¶é“¾æ¥åˆ°è€çš„æ ˆå†…å­˜å—ï¼Œæ–°çš„æ–¹æ³•ä¼šåˆ†é…ä¸€ä¸ªä¸¤å€å¤§çš„å†…å­˜å—å¹¶æŠŠè€çš„å†…å­˜å—å†…å®¹å¤åˆ¶åˆ°æ–°çš„å†…å­˜å—é‡Œã€‚è¿™æ ·åšæ„å‘³ç€å½“æ ˆç¼©å‡å›ä¹‹å‰å¤§å°æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…ã€‚æ ˆçš„ç¼©å‡æ²¡æœ‰ä»»ä½•ä»£ä»·ã€‚è€Œä¸”ï¼Œå½“æ ˆå†æ¬¡æ‰©å±•æ—¶ï¼Œè¿è¡Œç¯å¢ƒä¹Ÿä¸éœ€è¦å†åšä»»ä½•äº‹ã€‚å®ƒå¯ä»¥é‡ç”¨ä¹‹å‰åˆ†é…çš„ç©ºé—´ã€‚</p><p>æ ˆçš„å¤åˆ¶å¬èµ·æ¥å¾ˆå®¹æ˜“ï¼Œä½†å®é™…æ“ä½œå¹¶éé‚£ä¹ˆç®€å•ã€‚å­˜å‚¨åœ¨æ ˆä¸Šçš„å˜é‡çš„åœ°å€å¯èƒ½å·²ç»è¢«ä½¿ç”¨åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´ç¨‹åºä½¿ç”¨åˆ°äº†ä¸€äº›æŒ‡å‘æ ˆçš„æŒ‡é’ˆã€‚å½“ç§»åŠ¨æ ˆçš„æ—¶å€™ï¼Œæ‰€æœ‰æŒ‡å‘æ ˆé‡Œå†…å®¹çš„æŒ‡é’ˆéƒ½ä¼šå˜å¾—æ— æ•ˆã€‚ç„¶è€Œï¼ŒæŒ‡å‘æ ˆå†…å®¹çš„æŒ‡é’ˆè‡ªèº«ä¹Ÿå¿…å®šæ˜¯ä¿å­˜åœ¨æ ˆä¸Šçš„ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯å†…å­˜å®‰å…¨çš„å¿…è¦æ¡ä»¶ã€‚å¦åˆ™ä¸€ä¸ªç¨‹åºå°±æœ‰å¯èƒ½è®¿é—®ä¸€æ®µå·²ç»æ— æ•ˆçš„æ ˆç©ºé—´äº†ã€‚</p><p>å› ä¸ºåƒåœ¾å›æ”¶çš„éœ€è¦ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“æ ˆçš„å“ªäº›éƒ¨åˆ†æ˜¯è¢«ç”¨ä½œæŒ‡é’ˆäº†ã€‚å½“æˆ‘ä»¬ç§»åŠ¨æ ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°æ ˆé‡Œçš„æŒ‡é’ˆè®©å®ƒä»¬æŒ‡å‘æ–°çš„åœ°å€ã€‚æ‰€æœ‰ç›¸å…³çš„æŒ‡é’ˆéƒ½ä¼šè¢«æ›´æ–°ã€‚æˆ‘ä»¬ä½¿ç”¨äº†åƒåœ¾å›æ”¶çš„ä¿¡æ¯æ¥å¤åˆ¶æ ˆï¼Œä½†å¹¶ä¸æ˜¯ä»»ä½•ä½¿ç”¨æ ˆçš„å‡½æ•°éƒ½æœ‰è¿™äº›ä¿¡æ¯ã€‚å› ä¸ºå¾ˆå¤§ä¸€éƒ¨åˆ†è¿è¡Œç¯å¢ƒæ˜¯ç”¨Cè¯­è¨€å†™çš„ï¼Œå¾ˆå¤šè¢«è°ƒç”¨çš„è¿è¡Œç¯å¢ƒé‡Œçš„å‡½æ•°å¹¶æ²¡æœ‰æŒ‡é’ˆçš„ä¿¡æ¯ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸èƒ½å¤Ÿè¢«å¤åˆ¶äº†ã€‚å½“é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬åªèƒ½é€€å›åˆ°åˆ†å—å¼çš„æ ˆå¹¶æ”¯ä»˜ç›¸åº”çš„å¼€é”€ã€‚</p><p>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆç°åœ¨è¿è¡Œç¯å¢ƒçš„å¼€å‘è€…æ­£åœ¨ç”¨Goè¯­è¨€é‡å†™è¿è¡Œç¯å¢ƒçš„å¤§éƒ¨åˆ†ä»£ç ã€‚æ— æ³•ç”¨Goè¯­è¨€é‡å†™çš„éƒ¨åˆ†ï¼ˆæ¯”å¦‚è°ƒåº¦å™¨çš„æ ¸å¿ƒä»£ç å’Œåƒåœ¾å›æ”¶å™¨ï¼‰ä¼šåœ¨ç‰¹æ®Šçš„æ ˆä¸Šè¿è¡Œã€‚è¿™ä¸ªç‰¹æ®Šæ ˆçš„å¤§å°ç”±è¿è¡Œç¯å¢ƒçš„å¼€å‘è€…è®¾ç½®ã€‚</p><p>è¿™äº›æ”¹å˜é™¤äº†ä½¿æ ˆå¤åˆ¶æˆä¸ºå¯èƒ½ï¼Œå®ƒä¹Ÿå…è®¸æˆ‘ä»¬åœ¨å°†æ¥å®ç°å¹¶è¡Œåƒåœ¾å›æ”¶ã€‚</p><p>å¦å¤–ä¸€ç§ä¸åŒçš„æ ˆå¤„ç†æ–¹å¼å°±æ˜¯åœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…å¤§å†…å­˜æ®µã€‚ç”±äºç‰©ç†å†…å­˜åªæ˜¯åœ¨çœŸæ­£ä½¿ç”¨æ—¶æ‰ä¼šè¢«åˆ†é…ï¼Œå› æ­¤çœ‹èµ·æ¥å¥½ä¼¼ä½ å¯ä»¥åˆ†é…ä¸€ä¸ªå¤§å†…å­˜æ®µå¹¶è®©æ“ ä½œç³»ç»Ÿå¤„ç†å®ƒã€‚ä¸‹é¢æ˜¯è¿™ç§æ–¹æ³•çš„ä¸€äº›é—®é¢˜</p><p>é¦–å…ˆï¼Œ32ä½ç³»ç»Ÿåªèƒ½æ”¯æŒ4Gå­—èŠ‚è™šæ‹Ÿå†…å­˜ï¼Œå¹¶ä¸”åº”ç”¨åªèƒ½ç”¨åˆ°å…¶ä¸­çš„3Gç©ºé—´ã€‚ç”±äºåŒæ—¶è¿è¡Œç™¾ä¸‡goroutinesçš„æƒ…å†µå¹¶ä¸å°‘è§ï¼Œå› æ­¤ä½ å¾ˆå¯ èƒ½ç”¨å…‰è™šæ‹Ÿå†…å­˜ï¼Œå³ä¾¿æˆ‘ä»¬å‡è®¾æ¯ä¸ªgoroutineçš„stackåªæœ‰8Kã€‚</p><p>ç¬¬äºŒï¼Œç„¶è€Œæˆ‘ä»¬å¯ä»¥åœ¨64ä½ç³»ç»Ÿä¸­åˆ†é…å¤§å†…å­˜ï¼Œå®ƒä¾èµ–äºè¿‡é‡å†…å­˜ä½¿ç”¨ã€‚æ‰€è°“è¿‡é‡ä½¿ç”¨æ˜¯æŒ‡å½“ä½ åˆ†é…çš„å†…å­˜å¤§å°è¶…å‡ºç‰©ç†å†…å­˜å¤§å°æ—¶ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿä¿è¯ åœ¨éœ€è¦æ—¶èƒ½å¤Ÿåˆ†é…å‡ºç‰©ç†å†…å­˜ã€‚ç„¶è€Œï¼Œå…è®¸è¿‡é‡ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é£é™©ã€‚ç”±äºä¸€äº›è¿›ç¨‹åˆ†é…äº†è¶…å‡ºæœºå™¨ç‰©ç†å†…å­˜å¤§å°çš„å†…å­˜ï¼Œå¦‚æœè¿™äº›è¿›ç¨‹ä½¿ç”¨æ›´å¤šå†…å­˜ æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸å¾—ä¸ä¸ºå®ƒä»¬è¡¥å……åˆ†é…å†…å­˜ã€‚è¿™ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿå°†ä¸€äº›å†…å­˜æ®µæ”¾å…¥ç£ç›˜ç¼“å­˜ï¼Œè¿™å¸¸å¸¸ä¼šå¢åŠ ä¸å¯é¢„æµ‹çš„å¤„ç†å»¶è¿Ÿã€‚æ­£æ˜¯è€ƒè™‘åˆ°è¿™ä¸ªåŸå› ï¼Œä¸€ äº›æ–°ç³»ç»Ÿå…³é—­äº†å¯¹è¿‡é‡ä½¿ç”¨çš„æ”¯æŒã€‚</p><h4 id="23-Goroutineå’ŒChannelçš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ"><a href="#23-Goroutineå’ŒChannelçš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ" class="headerlink" title="23. Goroutineå’ŒChannelçš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ?"></a>23. Goroutineå’ŒChannelçš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ?</h4><p>è¿›ç¨‹æ˜¯å†…å­˜èµ„æºç®¡ç†å’Œcpuè°ƒåº¦çš„æ‰§è¡Œå•å…ƒã€‚ä¸ºäº†æœ‰æ•ˆåˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ï¼Œå°†è¿›ç¨‹è¿›ä¸€æ­¥ç»†åˆ†ï¼Œå…è®¸ä¸€ä¸ªè¿›ç¨‹é‡Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å¤šä¸ªçº¿ç¨‹è¿˜æ˜¯å…±äº«åŒä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œä½†cpuè°ƒåº¦çš„æœ€å°å•å…ƒå˜æˆäº†çº¿ç¨‹ã€‚</p><p>é‚£åç¨‹åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œä»¥åŠä¸çº¿ç¨‹çš„å·®å¼‚æ€§??</p><p>åç¨‹ï¼Œå¯ä»¥çœ‹ä½œæ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚ä½†ä¸çº¿ç¨‹ä¸åŒçš„æ˜¯ï¼Œçº¿ç¨‹çš„åˆ‡æ¢æ˜¯ç”±æ“ä½œç³»ç»Ÿæ§åˆ¶çš„ï¼Œè€Œåç¨‹çš„åˆ‡æ¢åˆ™æ˜¯ç”±ç”¨æˆ·æ§åˆ¶çš„ã€‚</p><p>æœ€æ—©æ”¯æŒåç¨‹çš„ç¨‹åºè¯­è¨€åº”è¯¥æ˜¯lispæ–¹è¨€schemeé‡Œçš„continuationï¼ˆç»­å»¶ï¼‰ï¼Œç»­å»¶å…è®¸schemeä¿å­˜ä»»æ„å‡½æ•°è°ƒç”¨çš„ç°åœºï¼Œä¿å­˜èµ·æ¥å¹¶é‡æ–°æ‰§è¡Œã€‚Lua,C#,pythonç­‰è¯­è¨€ä¹Ÿæœ‰è‡ªå·±çš„åç¨‹å®ç°ã€‚</p><p>Goä¸­çš„goroutinueå°±æ˜¯åç¨‹,å¯ä»¥å®ç°å¹¶è¡Œï¼Œå¤šä¸ªåç¨‹å¯ä»¥åœ¨å¤šä¸ªå¤„ç†å™¨åŒæ—¶è·‘ã€‚è€Œåç¨‹åŒä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šè·‘ï¼ˆå¯ä»¥æŠŠå®¿ä¸»è¯­è¨€æƒ³è±¡æˆå•çº¿ç¨‹çš„å°±å¥½äº†ï¼‰ã€‚ ç„¶è€Œ,å¤šä¸ªgoroutineä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡channelï¼Œè€Œåç¨‹çš„é€šä¿¡æ˜¯é€šè¿‡yieldå’Œresume()æ“ä½œã€‚</p><p>goroutineéå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨å‡½æ•°çš„è°ƒç”¨å‰é¢åŠ å…³é”®å­—goå³å¯ï¼Œä¾‹å¦‚:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go elegance()</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯åŠ¨5ä¸ªgoroutinesåˆ†åˆ«æ‰“å°ç´¢å¼•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">for i:=1;i&lt;5;i++ &#123;</span><br><span class="line">go func(i int) &#123;</span><br><span class="line">fmt.Println(i)</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">// åœæ­‡5sï¼Œä¿è¯æ‰“å°å…¨éƒ¨ç»“æŸ</span><br><span class="line">time.Sleep(5*time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨åˆ†ægoroutineæ‰§è¡Œçš„éšæœºæ€§å’Œå¹¶å‘æ€§ï¼Œå¯åŠ¨äº†5ä¸ªgoroutineï¼Œå†åŠ ä¸Šmainå‡½æ•°çš„ä¸»goroutineï¼Œæ€»å…±æœ‰6ä¸ªgoroutinesã€‚ç”±äºgoroutineç±»ä¼¼äºâ€å®ˆæŠ¤çº¿ç¨‹â€œï¼Œå¼‚æ­¥æ‰§è¡Œçš„,å¦‚æœä¸»goroutineä¸ç­‰å¾…ç‰‡åˆ»ï¼Œå¯èƒ½ç¨‹åºå°±æ²¡æœ‰è¾“å‡ºæ‰“å°äº†ã€‚</p><p>åœ¨Golangä¸­channelåˆ™æ˜¯goroutinuesä¹‹é—´è¿›è¡Œé€šä¿¡çš„æ¸ é“ã€‚</p><p>å¯ä»¥æŠŠchannelå½¢è±¡æ¯”å–»ä¸ºå·¥å‚é‡Œçš„ä¼ é€å¸¦,ä¸€å¤´çš„ç”Ÿäº§è€…goroutineå¾€ä¼ è¾“å¸¦æ”¾ä¸œè¥¿,å¦ä¸€å¤´çš„æ¶ˆè´¹è€…goroutinueåˆ™ä»è¾“é€å¸¦å–ä¸œè¥¿ã€‚channelå®é™…ä¸Šæ˜¯ä¸€ä¸ªæœ‰ç±»å‹çš„æ¶ˆæ¯é˜Ÿåˆ—,éµå¾ªå…ˆè¿›å…ˆå‡ºçš„ç‰¹ç‚¹ã€‚</p><ol><li>channelçš„æ“ä½œç¬¦å·</li></ol><p>ch &lt;- data è¡¨ç¤ºdataè¢«å‘é€ç»™channel chï¼›</p><p>data &lt;- ch è¡¨ç¤ºä»channel chå–ä¸€ä¸ªå€¼ï¼Œç„¶åèµ‹ç»™dataã€‚</p><ol><li>é˜»å¡å¼channel</li></ol><p>channelé»˜è®¤æ˜¯æ²¡æœ‰ç¼“å†²åŒºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé€šä¿¡æ˜¯é˜»å¡çš„ã€‚sendæ“ä½œå¿…é¡»ç­‰åˆ°æœ‰æ¶ˆè´¹è€…acceptæ‰ç®—å®Œæˆã€‚</p><p>åº”ç”¨ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">ch1 := make(chan int)</span><br><span class="line">go pump(ch1) // pump hangs</span><br><span class="line">fmt.Println(&lt;-ch1) // prints only 1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func pump(ch chan int) &#123;</span><br><span class="line">for i:= 1; ; i++ &#123;</span><br><span class="line">ch &lt;- i</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‡½æ•°pump()é‡Œçš„channelåœ¨æ¥å—åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ åå°±è¢«é˜»å¡äº†ï¼Œç›´åˆ°ä¸»goroutinueå–èµ°äº†æ•°æ®ã€‚æœ€ç»ˆchannelé˜»å¡åœ¨æ¥å—ç¬¬äºŒä¸ªå…ƒç´ ï¼Œç¨‹åºåªæ‰“å° 1ã€‚</p><p>æ²¡æœ‰ç¼“å†²(buffer)çš„channelåªèƒ½å®¹çº³ä¸€ä¸ªå…ƒç´ ï¼Œè€Œå¸¦æœ‰ç¼“å†²(buffer)channelåˆ™å¯ä»¥éé˜»å¡å®¹çº³Nä¸ªå…ƒç´ ã€‚å‘é€æ•°æ®åˆ°ç¼“å†²(buffer) channelä¸ä¼šè¢«é˜»å¡ï¼Œé™¤échannelå·²æ»¡ï¼›åŒæ ·çš„ï¼Œä»ç¼“å†²(buffer) channelå–æ•°æ®ä¹Ÿä¸ä¼šè¢«é˜»å¡ï¼Œé™¤échannelç©ºäº†ã€‚</p><h4 id="24-æ€ä¹ˆæŸ¥çœ‹Goroutineçš„æ•°é‡"><a href="#24-æ€ä¹ˆæŸ¥çœ‹Goroutineçš„æ•°é‡" class="headerlink" title="24. æ€ä¹ˆæŸ¥çœ‹Goroutineçš„æ•°é‡?"></a>24. æ€ä¹ˆæŸ¥çœ‹Goroutineçš„æ•°é‡?</h4><p>GOMAXPROCSä¸­æ§åˆ¶çš„æ˜¯æœªè¢«é˜»å¡çš„æ‰€æœ‰Goroutine,å¯ä»¥è¢«Multiplexåˆ°å¤šå°‘ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œ,é€šè¿‡GOMAXPROCSå¯ä»¥æŸ¥çœ‹Goroutineçš„æ•°é‡ã€‚</p><h4 id="25-è¯´ä¸‹Goä¸­çš„é”æœ‰å“ªäº›-ä¸‰ç§é”ï¼Œè¯»å†™é”ï¼Œäº’æ–¥é”ï¼Œè¿˜æœ‰mapçš„å®‰å…¨çš„é”"><a href="#25-è¯´ä¸‹Goä¸­çš„é”æœ‰å“ªäº›-ä¸‰ç§é”ï¼Œè¯»å†™é”ï¼Œäº’æ–¥é”ï¼Œè¿˜æœ‰mapçš„å®‰å…¨çš„é”" class="headerlink" title="25. è¯´ä¸‹Goä¸­çš„é”æœ‰å“ªäº›?ä¸‰ç§é”ï¼Œè¯»å†™é”ï¼Œäº’æ–¥é”ï¼Œè¿˜æœ‰mapçš„å®‰å…¨çš„é”?"></a>25. è¯´ä¸‹Goä¸­çš„é”æœ‰å“ªäº›?ä¸‰ç§é”ï¼Œè¯»å†™é”ï¼Œäº’æ–¥é”ï¼Œè¿˜æœ‰mapçš„å®‰å…¨çš„é”?</h4><p>Goä¸­çš„ä¸‰ç§é”åŒ…æ‹¬:äº’æ–¥é”,è¯»å†™é”,sync.Mapçš„å®‰å…¨çš„é”.</p><ul><li>äº’æ–¥é”</li></ul><p>Goå¹¶å‘ç¨‹åºå¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®æ§åˆ¶çš„ä¸»è¦æ‰‹æ®µï¼Œç”±æ ‡å‡†åº“ä»£ç åŒ…ä¸­syncä¸­çš„Mutexç»“æ„ä½“è¡¨ç¤ºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//Mutex æ˜¯äº’æ–¥é”ï¼Œ é›¶å€¼æ˜¯è§£é”çš„äº’æ–¥é”ï¼Œ é¦–æ¬¡ä½¿ç”¨åä¸å¾—å¤åˆ¶äº’æ–¥é”ã€‚</span><br><span class="line">type Mutex struct &#123;</span><br><span class="line">   state int32</span><br><span class="line">   sema  uint32</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sync.MutexåŒ…ä¸­çš„ç±»å‹åªæœ‰ä¸¤ä¸ªå…¬å¼€çš„æŒ‡é’ˆæ–¹æ³•Lockå’ŒUnlockã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//Lockerè¡¨ç¤ºå¯ä»¥é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚</span><br><span class="line">type Locker interface &#123;</span><br><span class="line">   Lock()</span><br><span class="line">   Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//é”å®šå½“å‰çš„äº’æ–¥é‡</span><br><span class="line">//å¦‚æœé”å·²è¢«ä½¿ç”¨ï¼Œåˆ™è°ƒç”¨goroutine</span><br><span class="line">//é˜»å¡ç›´åˆ°äº’æ–¥é”å¯ç”¨ã€‚</span><br><span class="line">func (m *Mutex) Lock() </span><br><span class="line"></span><br><span class="line">//å¯¹å½“å‰äº’æ–¥é‡è¿›è¡Œè§£é”</span><br><span class="line">//å¦‚æœåœ¨è¿›å…¥è§£é”æ—¶æœªé”å®šmï¼Œåˆ™ä¸ºè¿è¡Œæ—¶é”™è¯¯ã€‚</span><br><span class="line">//é”å®šçš„äº’æ–¥é”ä¸ç‰¹å®šçš„goroutineæ— å…³ã€‚</span><br><span class="line">//å…è®¸ä¸€ä¸ªgoroutineé”å®šMutexç„¶åå®‰æ’å¦ä¸€ä¸ªgoroutineæ¥è§£é”å®ƒã€‚</span><br><span class="line">func (m *Mutex) Unlock()</span><br></pre></td></tr></table></figure><p>å£°æ˜ä¸€ä¸ªäº’æ–¥é”ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var mutex sync.Mutex</span><br></pre></td></tr></table></figure><p>ä¸åƒCæˆ–Javaçš„é”ç±»å·¥å…·ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šçŠ¯ä¸€ä¸ªé”™è¯¯ï¼šå¿˜è®°åŠæ—¶è§£å¼€å·²è¢«é”ä½çš„é”ï¼Œä»è€Œå¯¼è‡´æµç¨‹å¼‚å¸¸ã€‚ä½†Goç”±äºå­˜åœ¨deferï¼Œæ‰€ä»¥æ­¤ç±»é—®é¢˜å‡ºç°çš„æ¦‚ç‡æä½ã€‚å…³äºdeferè§£é”çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">var mutex sync.Mutex</span><br><span class="line">func Write()  &#123;</span><br><span class="line">   mutex.Lock()</span><br><span class="line">   defer mutex.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœå¯¹ä¸€ä¸ªå·²ç»ä¸Šé”çš„å¯¹è±¡å†æ¬¡ä¸Šé”ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´è¯¥é”å®šæ“ä½œè¢«é˜»å¡ï¼Œç›´åˆ°è¯¥äº’æ–¥é”å›åˆ°è¢«è§£é”çŠ¶æ€.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">fpackage main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;sync&quot;</span><br><span class="line">&quot;time&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">var mutex sync.Mutex</span><br><span class="line">fmt.Println(&quot;begin lock&quot;)</span><br><span class="line">mutex.Lock()</span><br><span class="line">fmt.Println(&quot;get locked&quot;)</span><br><span class="line">for i := 1; i &lt;= 3; i++ &#123;</span><br><span class="line">go func(i int) &#123;</span><br><span class="line">fmt.Println(&quot;begin lock &quot;, i)</span><br><span class="line">mutex.Lock()</span><br><span class="line">fmt.Println(&quot;get locked &quot;, i)</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">fmt.Println(&quot;Unlock the lock&quot;)</span><br><span class="line">mutex.Unlock()</span><br><span class="line">fmt.Println(&quot;get unlocked&quot;)</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨forå¾ªç¯ä¹‹å‰å¼€å§‹åŠ é”ï¼Œç„¶ååœ¨æ¯ä¸€æ¬¡å¾ªç¯ä¸­åˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œå¹¶å¯¹å…¶åŠ é”ï¼Œä½†æ˜¯ç”±äºä¹‹å‰å·²ç»åŠ é”äº†ï¼Œæ‰€ä»¥è¿™ä¸ªforå¾ªç¯ä¸­çš„åŠ é”ä¼šé™·å…¥é˜»å¡ç›´åˆ°mainä¸­çš„é”è¢«è§£é”ï¼Œ time.Sleep(time.Second) æ˜¯ä¸ºäº†èƒ½è®©ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„æ—¶é—´è¿è¡Œforå¾ªç¯ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&gt; go run mutex.go </span><br><span class="line">begin lock</span><br><span class="line">get locked</span><br><span class="line">begin lock  3</span><br><span class="line">begin lock  1</span><br><span class="line">begin lock  2</span><br><span class="line">Unlock the lock</span><br><span class="line">get unlocked</span><br><span class="line">get locked  3</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°è§£é”åï¼Œä¸‰ä¸ªåç¨‹ä¼šé‡æ–°æŠ¢å¤ºäº’æ–¥é”æƒï¼Œæœ€ç»ˆåç¨‹3è·èƒœã€‚</p><p>äº’æ–¥é”é”å®šæ“ä½œçš„é€†æ“ä½œå¹¶ä¸ä¼šå¯¼è‡´åç¨‹é˜»å¡ï¼Œä½†æ˜¯æœ‰å¯èƒ½å¯¼è‡´å¼•å‘ä¸€ä¸ªæ— æ³•æ¢å¤çš„è¿è¡Œæ—¶çš„panicï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªæœªé”å®šçš„äº’æ–¥é”è¿›è¡Œè§£é”æ—¶å°±ä¼šå‘ç”Ÿpanicã€‚é¿å…è¿™ç§æƒ…å†µçš„æœ€æœ‰æ•ˆæ–¹å¼å°±æ˜¯ä½¿ç”¨deferã€‚</p><p>æˆ‘ä»¬çŸ¥é“å¦‚æœé‡åˆ°panicï¼Œå¯ä»¥ä½¿ç”¨recoveræ–¹æ³•è¿›è¡Œæ¢å¤ï¼Œä½†æ˜¯å¦‚æœå¯¹é‡å¤è§£é”äº’æ–¥é”å¼•å‘çš„panicå´æ˜¯æ— ç”¨çš„ï¼ˆGo 1.8åŠä»¥åï¼‰ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;sync&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">defer func() &#123;</span><br><span class="line">fmt.Println(&quot;Try to recover the panic&quot;)</span><br><span class="line">if p := recover(); p != nil &#123;</span><br><span class="line">fmt.Println(&quot;recover the panic : &quot;, p)</span><br><span class="line">&#125;</span><br><span class="line">&#125;()</span><br><span class="line">var mutex sync.Mutex</span><br><span class="line">fmt.Println(&quot;begin lock&quot;)</span><br><span class="line">mutex.Lock()</span><br><span class="line">fmt.Println(&quot;get locked&quot;)</span><br><span class="line">fmt.Println(&quot;unlock lock&quot;)</span><br><span class="line">mutex.Unlock()</span><br><span class="line">fmt.Println(&quot;lock is unlocked&quot;)</span><br><span class="line">fmt.Println(&quot;unlock lock again&quot;)</span><br><span class="line">mutex.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&gt; go run mutex.go </span><br><span class="line">begin lock</span><br><span class="line">get locked</span><br><span class="line">unlock lock</span><br><span class="line">lock is unlocked</span><br><span class="line">unlock lock again</span><br><span class="line">fatal error: sync: unlock of unlocked mutex</span><br><span class="line"></span><br><span class="line">goroutine 1 [running]:</span><br><span class="line">runtime.throw(0x4bc1a8, 0x1e)</span><br><span class="line">        /home/keke/soft/go/src/runtime/panic.go:617 +0x72 fp=0xc000084ea8 sp=0xc000084e78 pc=0x427ba2</span><br><span class="line">sync.throw(0x4bc1a8, 0x1e)</span><br><span class="line">        /home/keke/soft/go/src/runtime/panic.go:603 +0x35 fp=0xc000084ec8 sp=0xc000084ea8 pc=0x427b25</span><br><span class="line">sync.(*Mutex).Unlock(0xc00001a0c8)</span><br><span class="line">        /home/keke/soft/go/src/sync/mutex.go:184 +0xc1 fp=0xc000084ef0 sp=0xc000084ec8 pc=0x45f821</span><br><span class="line">main.main()</span><br><span class="line">        /home/keke/go/Test/mutex.go:25 +0x25f fp=0xc000084f98 sp=0xc000084ef0 pc=0x486c1f</span><br><span class="line">runtime.main()</span><br><span class="line">        /home/keke/soft/go/src/runtime/proc.go:200 +0x20c fp=0xc000084fe0 sp=0xc000084f98 pc=0x4294ec</span><br><span class="line">runtime.goexit()</span><br><span class="line">        /home/keke/soft/go/src/runtime/asm_amd64.s:1337 +0x1 fp=0xc000084fe8 sp=0xc000084fe0 pc=0x450ad1</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¯•å›¾å¯¹é‡å¤è§£é”å¼•å‘çš„panicè¿›è¡Œrecoverï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°æ“ä½œå¤±è´¥ï¼Œè™½ç„¶äº’æ–¥é”å¯ä»¥è¢«å¤šä¸ªåç¨‹å…±äº«ï¼Œä½†è¿˜æ˜¯å»ºè®®å°†å¯¹åŒä¸€ä¸ªäº’æ–¥é”çš„åŠ é”è§£é”æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªå±‚æ¬¡çš„ä»£ç ä¸­ã€‚</p><ul><li>è¯»å†™é”</li></ul><p>è¯»å†™é”æ˜¯é’ˆå¯¹è¯»å†™æ“ä½œçš„äº’æ–¥é”ï¼Œå¯ä»¥åˆ†åˆ«é’ˆå¯¹è¯»æ“ä½œä¸å†™æ“ä½œè¿›è¡Œé”å®šå’Œè§£é”æ“ä½œ ã€‚</p><p>è¯»å†™é”çš„è®¿é—®æ§åˆ¶è§„åˆ™å¦‚ä¸‹ï¼š</p><p>â‘  å¤šä¸ªå†™æ“ä½œä¹‹é—´æ˜¯äº’æ–¥çš„ â‘¡ å†™æ“ä½œä¸è¯»æ“ä½œä¹‹é—´ä¹Ÿæ˜¯äº’æ–¥çš„ â‘¢ å¤šä¸ªè¯»æ“ä½œä¹‹é—´ä¸æ˜¯äº’æ–¥çš„</p><p>åœ¨è¿™æ ·çš„æ§åˆ¶è§„åˆ™ä¸‹ï¼Œè¯»å†™é”å¯ä»¥å¤§å¤§é™ä½æ€§èƒ½æŸè€—ã€‚</p><p>åœ¨Goçš„æ ‡å‡†åº“ä»£ç åŒ…ä¸­syncä¸­çš„RWMutexç»“æ„ä½“è¡¨ç¤ºä¸º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// RWMutexæ˜¯ä¸€ä¸ªè¯»/å†™äº’æ–¥é”ï¼Œå¯ä»¥ç”±ä»»æ„æ•°é‡çš„è¯»æ“ä½œæˆ–å•ä¸ªå†™æ“ä½œæŒæœ‰ã€‚</span><br><span class="line">// RWMutexçš„é›¶å€¼æ˜¯æœªé”å®šçš„äº’æ–¥é”ã€‚</span><br><span class="line">//é¦–æ¬¡ä½¿ç”¨åï¼Œä¸å¾—å¤åˆ¶RWMutexã€‚</span><br><span class="line">//å¦‚æœgoroutineæŒæœ‰RWMutexè¿›è¡Œè¯»å–è€Œå¦ä¸€ä¸ªgoroutineå¯èƒ½ä¼šè°ƒç”¨Lockï¼Œé‚£ä¹ˆåœ¨é‡Šæ”¾åˆå§‹è¯»é”ä¹‹å‰ï¼Œgoroutineä¸åº”è¯¥æœŸæœ›èƒ½å¤Ÿè·å–è¯»é”å®šã€‚ </span><br><span class="line">//ç‰¹åˆ«æ˜¯ï¼Œè¿™ç§ç¦æ­¢é€’å½’è¯»é”å®šã€‚ è¿™æ˜¯ä¸ºäº†ç¡®ä¿é”æœ€ç»ˆå˜å¾—å¯ç”¨; é˜»æ­¢çš„é”å®šä¼šé˜»æ­¢æ–°è¯»æ“ä½œè·å–é”å®šã€‚</span><br><span class="line">type RWMutex struct &#123;</span><br><span class="line">   w           Mutex  //å¦‚æœæœ‰å¾…å¤„ç†çš„å†™æ“ä½œå°±æŒæœ‰</span><br><span class="line">   writerSem   uint32 // å†™æ“ä½œç­‰å¾…è¯»æ“ä½œå®Œæˆçš„ä¿¡å·é‡</span><br><span class="line">   readerSem   uint32 //è¯»æ“ä½œç­‰å¾…å†™æ“ä½œå®Œæˆçš„ä¿¡å·é‡</span><br><span class="line">   readerCount int32  // å¾…å¤„ç†çš„è¯»æ“ä½œæ•°é‡</span><br><span class="line">   readerWait  int32  // number of departing readers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>syncä¸­çš„RWMutexæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//å¯¹è¯»æ“ä½œçš„é”å®š</span><br><span class="line">func (rw *RWMutex) RLock()</span><br><span class="line">//å¯¹è¯»æ“ä½œçš„è§£é”</span><br><span class="line">func (rw *RWMutex) RUnlock()</span><br><span class="line">//å¯¹å†™æ“ä½œçš„é”å®š</span><br><span class="line">func (rw *RWMutex) Lock()</span><br><span class="line">//å¯¹å†™æ“ä½œçš„è§£é”</span><br><span class="line">func (rw *RWMutex) Unlock()</span><br><span class="line"></span><br><span class="line">//è¿”å›ä¸€ä¸ªå®ç°äº†sync.Lockeræ¥å£ç±»å‹çš„å€¼ï¼Œå®é™…ä¸Šæ˜¯å›è°ƒrw.RLock and rw.RUnlock.</span><br><span class="line">func (rw *RWMutex) RLocker() Locker</span><br></pre></td></tr></table></figure><p>Unlockæ–¹æ³•ä¼šè¯•å›¾å”¤é†’æ‰€æœ‰æƒ³è¿›è¡Œè¯»é”å®šè€Œè¢«é˜»å¡çš„åç¨‹ï¼Œè€Œ RUnlockæ–¹æ³•åªä¼šåœ¨å·²æ— ä»»ä½•è¯»é”å®šçš„æƒ…å†µä¸‹ï¼Œè¯•å›¾å”¤é†’ä¸€ä¸ªå› æ¬²è¿›è¡Œå†™é”å®šè€Œè¢«é˜»å¡çš„åç¨‹ã€‚è‹¥å¯¹ä¸€ä¸ªæœªè¢«å†™é”å®šçš„è¯»å†™é”è¿›è¡Œå†™è§£é”ï¼Œå°±ä¼šå¼•å‘ä¸€ä¸ªä¸å¯æ¢å¤çš„panicï¼ŒåŒç†å¯¹ä¸€ä¸ªæœªè¢«è¯»é”å®šçš„è¯»å†™é”è¿›è¡Œè¯»å†™é”ä¹Ÿä¼šå¦‚æ­¤ã€‚</p><p>ç”±äºè¯»å†™é”æ§åˆ¶ä¸‹çš„å¤šä¸ªè¯»æ“ä½œä¹‹é—´ä¸æ˜¯äº’æ–¥çš„ï¼Œå› æ­¤å¯¹äºè¯»è§£é”æ›´å®¹æ˜“è¢«å¿½è§†ã€‚å¯¹äºåŒä¸€ä¸ªè¯»å†™é”ï¼Œæ·»åŠ å¤šå°‘ä¸ªè¯»é”å®šï¼Œå°±å¿…è¦æœ‰ç­‰é‡çš„è¯»è§£é”ï¼Œè¿™æ ·æ‰èƒ½å…¶ä»–åç¨‹æœ‰æœºä¼šè¿›è¡Œæ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;sync&quot;</span><br><span class="line">&quot;time&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">var rwm sync.RWMutex</span><br><span class="line">for i := 0; i &lt; 5; i++ &#123;</span><br><span class="line">go func(i int) &#123;</span><br><span class="line">fmt.Println(&quot;try to lock read &quot;, i)</span><br><span class="line">rwm.RLock()</span><br><span class="line">fmt.Println(&quot;get locked &quot;, i)</span><br><span class="line">time.Sleep(time.Second * 2)</span><br><span class="line">fmt.Println(&quot;try to unlock for reading &quot;, i)</span><br><span class="line">rwm.RUnlock()</span><br><span class="line">fmt.Println(&quot;unlocked for reading &quot;, i)</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">time.Sleep(time.Millisecond * 1000)</span><br><span class="line">fmt.Println(&quot;try to lock for writing&quot;)</span><br><span class="line">rwm.Lock()</span><br><span class="line">fmt.Println(&quot;locked for writing&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; go run rwmutex.go </span><br><span class="line">try to lock read  0</span><br><span class="line">get locked  0</span><br><span class="line">try to lock read  4</span><br><span class="line">get locked  4</span><br><span class="line">try to lock read  3</span><br><span class="line">get locked  3</span><br><span class="line">try to lock read  1</span><br><span class="line">get locked  1</span><br><span class="line">try to lock read  2</span><br><span class="line">get locked  2</span><br><span class="line">try to lock for writing</span><br><span class="line">try to unlock for reading  0</span><br><span class="line">unlocked for reading  0</span><br><span class="line">try to unlock for reading  2</span><br><span class="line">unlocked for reading  2</span><br><span class="line">try to unlock for reading  1</span><br><span class="line">unlocked for reading  1</span><br><span class="line">try to unlock for reading  3</span><br><span class="line">unlocked for reading  3</span><br><span class="line">try to unlock for reading  4</span><br><span class="line">unlocked for reading  4</span><br><span class="line">locked for writing</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥çœ‹åˆ°åˆ›å»ºäº†äº”ä¸ªåç¨‹ç”¨äºå¯¹è¯»å†™é”çš„è¯»é”å®šä¸è¯»è§£é”æ“ä½œã€‚åœ¨ rwm.Lock()ç§ä¼šå¯¹mainä¸­åç¨‹è¿›è¡Œå†™é”å®šï¼Œä½†æ˜¯forå¾ªç¯ä¸­çš„è¯»è§£é”å°šæœªå®Œæˆï¼Œå› æ­¤ä¼šé€ æˆmianä¸­çš„åç¨‹é˜»å¡ã€‚å½“forå¾ªç¯ä¸­çš„è¯»è§£é”æ“ä½œéƒ½å®Œæˆåå°±ä¼šè¯•å›¾å”¤é†’mainä¸­é˜»å¡çš„åç¨‹ï¼Œmainä¸­çš„å†™é”å®šæ‰ä¼šå®Œæˆã€‚</p><ul><li>sync.Mapå®‰å…¨é”</li></ul><p>golangä¸­çš„sync.Mapæ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œå…¶å®ä¹Ÿå°±æ˜¯syncåŒ…ä¸­golangè‡ªå®šä¹‰çš„ä¸€ä¸ªåå«Mapçš„ç»“æ„ä½“ã€‚</p><p>åº”ç”¨ç¤ºä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">    &quot;sync&quot;</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    //å¼€ç®±å³ç”¨</span><br><span class="line">    var sm sync.Map</span><br><span class="line">    //store æ–¹æ³•,æ·»åŠ å…ƒç´ </span><br><span class="line">    sm.Store(1,&quot;a&quot;)</span><br><span class="line">    //Load æ–¹æ³•ï¼Œè·å¾—value</span><br><span class="line">    if v,ok:=sm.Load(1);ok&#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">    //LoadOrStoreæ–¹æ³•ï¼Œè·å–æˆ–è€…ä¿å­˜</span><br><span class="line">    //å‚æ•°æ˜¯ä¸€å¯¹keyï¼švalueï¼Œå¦‚æœè¯¥keyå­˜åœ¨ä¸”æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤åˆ™è¿”å›åŸå…ˆçš„valueï¼ˆä¸æ›´æ–°ï¼‰å’Œtrueï¼›ä¸å­˜åœ¨åˆ™storeï¼Œè¿”å›è¯¥value å’Œfalse</span><br><span class="line">    if vv,ok:=sm.LoadOrStore(1,&quot;c&quot;);ok&#123;</span><br><span class="line">        fmt.Println(vv)</span><br><span class="line">    &#125;</span><br><span class="line">    if vv,ok:=sm.LoadOrStore(2,&quot;c&quot;);!ok&#123;</span><br><span class="line">        fmt.Println(vv)</span><br><span class="line">    &#125;</span><br><span class="line">    //éå†è¯¥mapï¼Œå‚æ•°æ˜¯ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å‚çš„ä¸¤ä¸ªå‚æ•°æ˜¯éå†è·å¾—çš„keyå’Œvalueï¼Œè¿”å›ä¸€ä¸ªboolå€¼ï¼Œå½“è¿”å›falseæ—¶ï¼Œéå†ç«‹åˆ»ç»“æŸã€‚</span><br><span class="line">    sm.Range(func(k,v interface&#123;&#125;)bool&#123;</span><br><span class="line">        fmt.Print(k)</span><br><span class="line">        fmt.Print(&quot;:&quot;)</span><br><span class="line">        fmt.Print(v)</span><br><span class="line">        fmt.Println()</span><br><span class="line">        return true</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a</span><br><span class="line">a</span><br><span class="line">c</span><br><span class="line">1:a</span><br><span class="line">2:c</span><br></pre></td></tr></table></figure><p>sync.Mapçš„æ•°æ®ç»“æ„:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> type Map struct &#123;</span><br><span class="line">    // è¯¥é”ç”¨æ¥ä¿æŠ¤dirty</span><br><span class="line">    mu Mutex</span><br><span class="line">    // å­˜è¯»çš„æ•°æ®ï¼Œå› ä¸ºæ˜¯atomic.valueç±»å‹ï¼Œåªè¯»ç±»å‹ï¼Œæ‰€ä»¥å®ƒçš„è¯»æ˜¯å¹¶å‘å®‰å…¨çš„</span><br><span class="line">    read atomic.Value // readOnly</span><br><span class="line">    //åŒ…å«æœ€æ–°çš„å†™å…¥çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨å†™çš„æ—¶å€™ï¼Œä¼šæŠŠread ä¸­æœªè¢«åˆ é™¤çš„æ•°æ®æ‹·è´åˆ°è¯¥dirtyä¸­ï¼Œå› ä¸ºæ˜¯æ™®é€šçš„mapå­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ç”¨åˆ°ä¸Šé¢çš„muå­—æ®µã€‚</span><br><span class="line">    dirty map[interface&#123;&#125;]*entry</span><br><span class="line">    // ä»readè¯»æ•°æ®çš„æ—¶å€™ï¼Œä¼šå°†è¯¥å­—æ®µ+1ï¼Œå½“ç­‰äºlenï¼ˆdirtyï¼‰çš„æ—¶å€™ï¼Œä¼šå°†dirtyæ‹·è´åˆ°readä¸­ï¼ˆä»è€Œæå‡è¯»çš„æ€§èƒ½ï¼‰ã€‚</span><br><span class="line">    misses int</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>readçš„æ•°æ®ç»“æ„æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">type readOnly struct &#123;</span><br><span class="line">    m  map[interface&#123;&#125;]*entry</span><br><span class="line">    // å¦‚æœMap.dirtyçš„æ•°æ®å’Œm ä¸­çš„æ•°æ®ä¸ä¸€æ ·æ˜¯ä¸ºtrue</span><br><span class="line">    amended bool </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>entryçš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type entry struct &#123;</span><br><span class="line">    //å¯è§valueæ˜¯ä¸ªæŒ‡é’ˆç±»å‹ï¼Œè™½ç„¶readå’Œdirtyå­˜åœ¨å†—ä½™æƒ…å†µï¼ˆamended=falseï¼‰ï¼Œä½†æ˜¯ç”±äºæ˜¯æŒ‡é’ˆç±»å‹ï¼Œå­˜å‚¨çš„ç©ºé—´åº”è¯¥ä¸æ˜¯é—®é¢˜</span><br><span class="line">    p unsafe.Pointer // *interface&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Delete æ–¹æ³•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">func (m *Map) Delete(key interface&#123;&#125;) &#123;</span><br><span class="line">    read, _ := m.read.Load().(readOnly)</span><br><span class="line">    e, ok := read.m[key]</span><br><span class="line">    //å¦‚æœreadä¸­æ²¡æœ‰ï¼Œå¹¶ä¸”dirtyä¸­æœ‰æ–°å…ƒç´ ï¼Œé‚£ä¹ˆå°±å»dirtyä¸­å»æ‰¾</span><br><span class="line">    if !ok &amp;&amp; read.amended &#123;</span><br><span class="line">        m.mu.Lock()</span><br><span class="line">        //è¿™æ˜¯åŒæ£€æŸ¥ï¼ˆä¸Šé¢çš„ifåˆ¤æ–­å’Œé”ä¸æ˜¯ä¸€ä¸ªåŸå­æ€§æ“ä½œï¼‰</span><br><span class="line">        read, _ = m.read.Load().(readOnly)</span><br><span class="line">        e, ok = read.m[key]</span><br><span class="line">        if !ok &amp;&amp; read.amended &#123;</span><br><span class="line">            //ç›´æ¥åˆ é™¤</span><br><span class="line">            delete(m.dirty, key)</span><br><span class="line">        &#125;</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">    if ok &#123;</span><br><span class="line">    //å¦‚æœreadä¸­å­˜åœ¨è¯¥keyï¼Œåˆ™å°†è¯¥value èµ‹å€¼nilï¼ˆé‡‡ç”¨æ ‡è®°çš„æ–¹å¼åˆ é™¤ï¼ï¼‰</span><br><span class="line">        e.delete()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func (e *entry) delete() (hadValue bool) &#123;</span><br><span class="line">    for &#123;</span><br><span class="line">        p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">        if p == nil || p == expunged &#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">        if atomic.CompareAndSwapPointer(&amp;e.p, p, nil) &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Store æ–¹æ³•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">func (m *Map) Store(key, value interface&#123;&#125;) &#123;</span><br><span class="line">    // å¦‚æœm.readå­˜åœ¨è¿™ä¸ªkeyï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼Œåˆ™å°è¯•æ›´æ–°ã€‚</span><br><span class="line">    read, _ := m.read.Load().(readOnly)</span><br><span class="line">    if e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    // å¦‚æœreadä¸å­˜åœ¨æˆ–è€…å·²ç»è¢«æ ‡è®°åˆ é™¤</span><br><span class="line">    m.mu.Lock()</span><br><span class="line">    read, _ = m.read.Load().(readOnly)</span><br><span class="line">    if e, ok := read.m[key]; ok &#123;</span><br><span class="line">    //å¦‚æœentryè¢«æ ‡è®°expungeï¼Œåˆ™è¡¨æ˜dirtyæ²¡æœ‰keyï¼Œå¯æ·»åŠ å…¥dirtyï¼Œå¹¶æ›´æ–°entry</span><br><span class="line">        if e.unexpungeLocked() &#123; </span><br><span class="line">            //åŠ å…¥dirtyä¸­</span><br><span class="line">            m.dirty[key] = e</span><br><span class="line">        &#125;</span><br><span class="line">        //æ›´æ–°valueå€¼</span><br><span class="line">        e.storeLocked(&amp;value) </span><br><span class="line">        //dirty å­˜åœ¨è¯¥keyï¼Œæ›´æ–°</span><br><span class="line">    &#125; else if e, ok := m.dirty[key]; ok &#123; </span><br><span class="line">        e.storeLocked(&amp;value)</span><br><span class="line">        //read å’Œdirtyéƒ½æ²¡æœ‰ï¼Œæ–°æ·»åŠ ä¸€æ¡</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">     //dirtyä¸­æ²¡æœ‰æ–°çš„æ•°æ®ï¼Œå¾€dirtyä¸­å¢åŠ ç¬¬ä¸€ä¸ªæ–°é”®</span><br><span class="line">        if !read.amended &#123; </span><br><span class="line">            //å°†readä¸­æœªåˆ é™¤çš„æ•°æ®åŠ å…¥åˆ°dirtyä¸­</span><br><span class="line">            m.dirtyLocked() </span><br><span class="line">            m.read.Store(readOnly&#123;m: read.m, amended: true&#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        m.dirty[key] = newEntry(value) </span><br><span class="line">    &#125;</span><br><span class="line">    m.mu.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//å°†readä¸­æœªåˆ é™¤çš„æ•°æ®åŠ å…¥åˆ°dirtyä¸­</span><br><span class="line">func (m *Map) dirtyLocked() &#123;</span><br><span class="line">    if m.dirty != nil &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    read, _ := m.read.Load().(readOnly)</span><br><span class="line">    m.dirty = make(map[interface&#123;&#125;]*entry, len(read.m))</span><br><span class="line">    //readå¦‚æœè¾ƒå¤§çš„è¯ï¼Œå¯èƒ½å½±å“æ€§èƒ½</span><br><span class="line">    for k, e := range read.m &#123;</span><br><span class="line">    //é€šè¿‡æ­¤æ¬¡æ“ä½œï¼Œdirtyä¸­çš„å…ƒç´ éƒ½æ˜¯æœªè¢«åˆ é™¤çš„ï¼Œå¯è§expungeçš„å…ƒç´ ä¸åœ¨dirtyä¸­</span><br><span class="line">        if !e.tryExpungeLocked() &#123;</span><br><span class="line">            m.dirty[k] = e</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//åˆ¤æ–­entryæ˜¯å¦è¢«æ ‡è®°åˆ é™¤ï¼Œå¹¶ä¸”å°†æ ‡è®°ä¸ºnilçš„entryæ›´æ–°æ ‡è®°ä¸ºexpunge</span><br><span class="line">func (e *entry) tryExpungeLocked() (isExpunged bool) &#123;</span><br><span class="line">    p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">    for p == nil &#123;</span><br><span class="line">        // å°†å·²ç»åˆ é™¤æ ‡è®°ä¸ºnilçš„æ•°æ®æ ‡è®°ä¸ºexpunged</span><br><span class="line">        if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">        p = atomic.LoadPointer(&amp;e.p)</span><br><span class="line">    &#125;</span><br><span class="line">    return p == expunged</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//å¯¹entry å°è¯•æ›´æ–°</span><br><span class="line">func (e *entry) tryStore(i *interface&#123;&#125;) bool &#123;</span><br><span class="line">    p := atomic.LoadPointer(&amp;e.p)</span><br><span class="line">    if p == expunged &#123;</span><br><span class="line">        return false</span><br><span class="line">    &#125;</span><br><span class="line">    for &#123;</span><br><span class="line">        if atomic.CompareAndSwapPointer(&amp;e.p, p, unsafe.Pointer(i)) &#123;</span><br><span class="line">            return true</span><br><span class="line">        &#125;</span><br><span class="line">        p = atomic.LoadPointer(&amp;e.p)</span><br><span class="line">        if p == expunged &#123;</span><br><span class="line">            return false</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//readé‡Œ å°†æ ‡è®°ä¸ºexpungeçš„æ›´æ–°ä¸ºnil</span><br><span class="line">func (e *entry) unexpungeLocked() (wasExpunged bool) &#123;</span><br><span class="line">    return atomic.CompareAndSwapPointer(&amp;e.p, expunged, nil)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//æ›´æ–°entry</span><br><span class="line">func (e *entry) storeLocked(i *interface&#123;&#125;) &#123;</span><br><span class="line">    atomic.StorePointer(&amp;e.p, unsafe.Pointer(i))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› æ­¤ï¼Œæ¯æ¬¡æ“ä½œå…ˆæ£€æŸ¥readï¼Œå› ä¸ºread å¹¶å‘å®‰å…¨ï¼Œæ€§èƒ½å¥½äº›ï¼›readä¸æ»¡è¶³ï¼Œåˆ™åŠ é”æ£€æŸ¥dirtyï¼Œä¸€æ—¦æ˜¯æ–°çš„é”®å€¼ï¼Œdirtyä¼šè¢«readæ›´æ–°ã€‚</p><p>Loadæ–¹æ³•:</p><p>Loadæ–¹æ³•æ˜¯ä¸€ä¸ªåŠ è½½æ–¹æ³•ï¼ŒæŸ¥æ‰¾keyã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">func (m *Map) Load(key interface&#123;&#125;) (value interface&#123;&#125;, ok bool) &#123;</span><br><span class="line">    //å› readåªè¯»ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œå…ˆæŸ¥çœ‹æ˜¯å¦æ»¡è¶³æ¡ä»¶</span><br><span class="line">    read, _ := m.read.Load().(readOnly)</span><br><span class="line">    e, ok := read.m[key]</span><br><span class="line">    //å¦‚æœreadæ²¡æœ‰ï¼Œå¹¶ä¸”dirtyæœ‰æ–°æ•°æ®ï¼Œé‚£ä»dirtyä¸­æŸ¥æ‰¾ï¼Œç”±äºdirtyæ˜¯æ™®é€šmapï¼Œçº¿ç¨‹ä¸å®‰å…¨ï¼Œè¿™ä¸ªæ—¶å€™ç”¨åˆ°äº’æ–¥é”äº†</span><br><span class="line">    if !ok &amp;&amp; read.amended &#123;</span><br><span class="line">        m.mu.Lock()</span><br><span class="line">        // åŒé‡æ£€æŸ¥</span><br><span class="line">        read, _ = m.read.Load().(readOnly)</span><br><span class="line">        e, ok = read.m[key]</span><br><span class="line">        // å¦‚æœreadä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œå¹¶ä¸”dirtyä¸­æœ‰æ–°æ•°æ®</span><br><span class="line">        if !ok &amp;&amp; read.amended &#123;</span><br><span class="line">            e, ok = m.dirty[key]</span><br><span class="line">            // mssLockedï¼ˆï¼‰å‡½æ•°æ˜¯æ€§èƒ½æ˜¯sync.Map æ€§èƒ½å¾—ä»¥ä¿è¯çš„é‡è¦å‡½æ•°ï¼Œç›®çš„è®²æœ‰é”çš„dirtyæ•°æ®ï¼Œæ›¿æ¢åˆ°åªè¯»çº¿ç¨‹å®‰å…¨çš„readé‡Œ</span><br><span class="line">            m.missLocked()</span><br><span class="line">        &#125;</span><br><span class="line">        m.mu.Unlock()</span><br><span class="line">    &#125;</span><br><span class="line">    if !ok &#123;</span><br><span class="line">        return nil, false</span><br><span class="line">    &#125;</span><br><span class="line">    return e.load()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//dirty æå‡è‡³read å…³é”®å‡½æ•°ï¼Œå½“misses ç»è¿‡å¤šæ¬¡å› ä¸ºloadä¹‹åï¼Œå¤§å°ç­‰äºlenï¼ˆdirtyï¼‰æ—¶å€™ï¼Œè®²dirtyæ›¿æ¢åˆ°readé‡Œï¼Œä»¥æ­¤è¾¾åˆ°æ€§èƒ½æå‡ã€‚</span><br><span class="line">func (m *Map) missLocked() &#123;</span><br><span class="line">    m.misses++</span><br><span class="line">    if m.misses &lt; len(m.dirty) &#123;</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line">    //åŸå­æ“ä½œï¼Œè€—æ—¶å¾ˆå°</span><br><span class="line">    m.read.Store(readOnly&#123;m: m.dirty&#125;)</span><br><span class="line">    m.dirty = nil</span><br><span class="line">    m.misses = 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sync.Mapæ˜¯é€šè¿‡å†—ä½™çš„ä¸¤ä¸ªæ•°æ®ç»“æ„(readã€dirty),å®ç°æ€§èƒ½çš„æå‡ã€‚ä¸ºäº†æå‡æ€§èƒ½ï¼Œloadã€deleteã€storeç­‰æ“ä½œå°½é‡ä½¿ç”¨åªè¯»çš„readï¼›ä¸ºäº†æé«˜readçš„keyå‡»ä¸­æ¦‚ç‡ï¼Œé‡‡ç”¨åŠ¨æ€è°ƒæ•´ï¼Œå°†dirtyæ•°æ®æå‡ä¸ºreadï¼›å¯¹äºæ•°æ®çš„åˆ é™¤ï¼Œé‡‡ç”¨å»¶è¿Ÿæ ‡è®°åˆ é™¤æ³•ï¼Œåªæœ‰åœ¨æå‡dirtyçš„æ—¶å€™æ‰åˆ é™¤ã€‚</p><h4 id="26-è¯»å†™é”æˆ–è€…äº’æ–¥é”è¯»çš„æ—¶å€™èƒ½å†™å—"><a href="#26-è¯»å†™é”æˆ–è€…äº’æ–¥é”è¯»çš„æ—¶å€™èƒ½å†™å—" class="headerlink" title="26. è¯»å†™é”æˆ–è€…äº’æ–¥é”è¯»çš„æ—¶å€™èƒ½å†™å—?"></a>26. è¯»å†™é”æˆ–è€…äº’æ–¥é”è¯»çš„æ—¶å€™èƒ½å†™å—?</h4><p>Goä¸­è¯»å†™é”åŒ…æ‹¬è¯»é”å’Œå†™é”ï¼Œå¤šä¸ªè¯»çº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®å…±äº«æ•°æ®ï¼›å†™çº¿ç¨‹å¿…é¡»ç­‰å¾…æ‰€æœ‰è¯»çº¿ç¨‹éƒ½é‡Šæ”¾é”ä»¥åï¼Œæ‰èƒ½å–å¾—é”ï¼›åŒæ ·çš„ï¼Œè¯»çº¿ç¨‹å¿…é¡»ç­‰å¾…å†™çº¿ç¨‹é‡Šæ”¾é”åï¼Œæ‰èƒ½å–å¾—é”ï¼Œä¹Ÿå°±æ˜¯è¯´è¯»å†™é”è¦ç¡®ä¿çš„æ˜¯å¦‚ä¸‹äº’æ–¥å…³ç³»ï¼Œå¯ä»¥åŒæ—¶è¯»ï¼Œä½†æ˜¯è¯»-å†™ï¼Œå†™-å†™éƒ½æ˜¯äº’æ–¥çš„ã€‚</p><h4 id="27-æ€ä¹ˆé™åˆ¶Goroutineçš„æ•°é‡"><a href="#27-æ€ä¹ˆé™åˆ¶Goroutineçš„æ•°é‡" class="headerlink" title="27. æ€ä¹ˆé™åˆ¶Goroutineçš„æ•°é‡."></a>27. æ€ä¹ˆé™åˆ¶Goroutineçš„æ•°é‡.</h4><p>åœ¨Golangä¸­ï¼ŒGoroutineè™½ç„¶å¾ˆå¥½ï¼Œä½†æ˜¯æ•°é‡å¤ªå¤šäº†ï¼Œå¾€å¾€ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦ï¼Œæ¯”å¦‚è€—å°½ç³»ç»Ÿèµ„æºå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæˆ–è€…CPUä½¿ç”¨ç‡è¿‡é«˜å¯¼è‡´ç³»ç»Ÿå¿™ä¸è¿‡æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é™åˆ¶ä¸‹Goroutineçš„æ•°é‡,è¿™æ ·å°±éœ€è¦åœ¨æ¯ä¸€æ¬¡æ‰§è¡Œgoä¹‹å‰åˆ¤æ–­goroutineçš„æ•°é‡ï¼Œå¦‚æœæ•°é‡è¶…äº†ï¼Œå°±è¦é˜»å¡goçš„æ‰§è¡Œã€‚ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨é€šé“ã€‚æ¯æ¬¡æ‰§è¡Œçš„goä¹‹å‰å‘é€šé“å†™å…¥å€¼ï¼Œç›´åˆ°é€šé“æ»¡çš„æ—¶å€™å°±é˜»å¡äº†ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">var ch chan  int</span><br><span class="line"></span><br><span class="line">func elegance()&#123;</span><br><span class="line">&lt;-ch</span><br><span class="line">fmt.Println(&quot;the ch value receive&quot;,ch)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">ch = make(chan int,5)</span><br><span class="line">for i:=0;i&lt;10;i++&#123;</span><br><span class="line">ch &lt;-1</span><br><span class="line">fmt.Println(&quot;the ch value send&quot;,ch)</span><br><span class="line">go elegance()</span><br><span class="line">fmt.Println(&quot;the result i&quot;,i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&gt; go run goroutine.go </span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 0</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 1</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 2</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 3</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 4</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 5</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the result i 6</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 7</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 8</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 9</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the result i 10</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 11</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 12</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the result i 13</span><br><span class="line">the ch value send 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">the result i 14</span><br><span class="line">the ch value receive 0xc00009c000</span><br><span class="line">&gt; go run goroutine.go </span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the result i 0</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the result i 1</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the result i 2</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the result i 3</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the ch value receive 0xc00007e000</span><br><span class="line">the result i 4</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the ch value receive 0xc00007e000</span><br><span class="line">the result i 5</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the ch value receive 0xc00007e000</span><br><span class="line">the result i 6</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the result i 7</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the ch value receive 0xc00007e000</span><br><span class="line">the ch value receive 0xc00007e000</span><br><span class="line">the ch value receive 0xc00007e000</span><br><span class="line">the result i 8</span><br><span class="line">the ch value send 0xc00007e000</span><br><span class="line">the result i 9</span><br></pre></td></tr></table></figure><p>è¿™æ ·æ¯æ¬¡åŒæ—¶è¿è¡Œçš„goroutineå°±è¢«é™åˆ¶ä¸º5ä¸ªäº†ã€‚ä½†æ˜¯æ–°çš„é—®é¢˜äºæ˜¯å°±å‡ºç°äº†ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„goroutineéƒ½æ‰§è¡Œå®Œäº†ï¼Œåœ¨mainå‡½æ•°é€€å‡ºä¹‹åï¼Œè¿˜æœ‰ä¸€äº›goroutineæ²¡æœ‰æ‰§è¡Œå®Œå°±è¢«å¼ºåˆ¶ç»“æŸäº†ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°sync.WaitGroupã€‚ä½¿ç”¨WaitGroupç­‰å¾…æ‰€æœ‰çš„goroutineé€€å‡ºã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">&quot;fmt&quot;</span><br><span class="line">&quot;runtime&quot;</span><br><span class="line">&quot;sync&quot;</span><br><span class="line">&quot;time&quot;</span><br><span class="line">)</span><br><span class="line">// Pool Goroutine Pool</span><br><span class="line">type Pool struct &#123;</span><br><span class="line">queue chan int</span><br><span class="line">wg *sync.WaitGroup</span><br><span class="line">&#125;</span><br><span class="line">// New æ–°å»ºä¸€ä¸ªåç¨‹æ± </span><br><span class="line">func NewPool(size int) *Pool&#123;</span><br><span class="line">if size &lt;=0&#123;</span><br><span class="line">size = 1</span><br><span class="line">&#125;</span><br><span class="line">return &amp;Pool&#123;</span><br><span class="line">queue:make(chan int,size),</span><br><span class="line">wg:&amp;sync.WaitGroup&#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">// Add æ–°å¢ä¸€ä¸ªæ‰§è¡Œ</span><br><span class="line">func (p *Pool)Add(delta int)&#123;</span><br><span class="line">// deltaä¸ºæ­£æ•°å°±æ·»åŠ </span><br><span class="line">for i :=0;i&lt;delta;i++&#123;</span><br><span class="line">p.queue &lt;-1</span><br><span class="line">&#125;</span><br><span class="line">// deltaä¸ºè´Ÿæ•°å°±å‡å°‘</span><br><span class="line">for i:=0;i&gt;delta;i--&#123;</span><br><span class="line">&lt;-p.queue</span><br><span class="line">&#125;</span><br><span class="line">p.wg.Add(delta)</span><br><span class="line">&#125;</span><br><span class="line">// Done æ‰§è¡Œå®Œæˆå‡ä¸€</span><br><span class="line">func (p *Pool) Done()&#123;</span><br><span class="line">&lt;-p.queue</span><br><span class="line">p.wg.Done()</span><br><span class="line">&#125;</span><br><span class="line">// Wait ç­‰å¾…Goroutineæ‰§è¡Œå®Œæ¯•</span><br><span class="line">func (p *Pool) Wait()&#123;</span><br><span class="line">p.wg.Wait()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main()&#123;</span><br><span class="line">// è¿™é‡Œé™åˆ¶5ä¸ªå¹¶å‘</span><br><span class="line">pool := NewPool(5)</span><br><span class="line">fmt.Println(&quot;the NumGoroutine begin is:&quot;,runtime.NumGoroutine())</span><br><span class="line">for i:=0;i&lt;20;i++&#123;</span><br><span class="line">pool.Add(1)</span><br><span class="line">go func(i int) &#123;</span><br><span class="line">time.Sleep(time.Second)</span><br><span class="line">fmt.Println(&quot;the NumGoroutine continue is:&quot;,runtime.NumGoroutine())</span><br><span class="line">pool.Done()</span><br><span class="line">&#125;(i)</span><br><span class="line">&#125;</span><br><span class="line">pool.Wait()</span><br><span class="line">fmt.Println(&quot;the NumGoroutine done is:&quot;,runtime.NumGoroutine())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">the NumGoroutine begin is: 1</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 7</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 6</span><br><span class="line">the NumGoroutine continue is: 3</span><br><span class="line">the NumGoroutine continue is: 2</span><br><span class="line">the NumGoroutine done is: 1</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒGoçš„GOMAXPROCSé»˜è®¤å€¼å·²ç»è®¾ç½®ä¸ºCPUçš„æ ¸æ•°ï¼Œ è¿™é‡Œå…è®¸æˆ‘ä»¬çš„Goç¨‹åºå……åˆ†ä½¿ç”¨æœºå™¨çš„æ¯ä¸€ä¸ªCPU,æœ€å¤§ç¨‹åº¦çš„æé«˜æˆ‘ä»¬ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚runtime.NumGoroutineå‡½æ•°åœ¨è¢«è°ƒç”¨åï¼Œä¼šè¿”å›ç³»ç»Ÿä¸­çš„å¤„äºç‰¹å®šçŠ¶æ€çš„Goroutineçš„æ•°é‡ã€‚è¿™é‡Œçš„ç‰¹æŒ‡æ˜¯æŒ‡Grunnable\Gruning\Gsyscall\Gwaitionã€‚å¤„äºè¿™äº›çŠ¶æ€çš„Groutineå³è¢«çœ‹åšæ˜¯æ´»è·ƒçš„æˆ–è€…è¯´æ­£åœ¨è¢«è°ƒåº¦ã€‚</p><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ï¼šåƒåœ¾å›æ”¶æ‰€åœ¨Groutineçš„çŠ¶æ€ä¹Ÿå¤„äºè¿™ä¸ªèŒƒå›´å†…çš„è¯ï¼Œä¹Ÿä¼šè¢«çº³å…¥è¯¥è®¡æ•°å™¨ã€‚</p><h4 id="28-Channelæ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„"><a href="#28-Channelæ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„" class="headerlink" title="28. Channelæ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„."></a>28. Channelæ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„.</h4><p>Channelæ˜¯å¼‚æ­¥è¿›è¡Œçš„ã€‚</p><p>channelå­˜åœ¨3ç§çŠ¶æ€ï¼š</p><ul><li>nilï¼Œæœªåˆå§‹åŒ–çš„çŠ¶æ€ï¼Œåªè¿›è¡Œäº†å£°æ˜ï¼Œæˆ–è€…æ‰‹åŠ¨èµ‹å€¼ä¸ºnil</li><li>activeï¼Œæ­£å¸¸çš„channelï¼Œå¯è¯»æˆ–è€…å¯å†™</li><li>closedï¼Œå·²å…³é—­ï¼Œåƒä¸‡ä¸è¦è¯¯è®¤ä¸ºå…³é—­channelåï¼Œchannelçš„å€¼æ˜¯nil</li></ul><h4 id="29-è¯´ä¸€ä¸‹å¼‚æ­¥å’Œéé˜»å¡çš„åŒºåˆ«"><a href="#29-è¯´ä¸€ä¸‹å¼‚æ­¥å’Œéé˜»å¡çš„åŒºåˆ«" class="headerlink" title="29. è¯´ä¸€ä¸‹å¼‚æ­¥å’Œéé˜»å¡çš„åŒºåˆ«?"></a>29. è¯´ä¸€ä¸‹å¼‚æ­¥å’Œéé˜»å¡çš„åŒºåˆ«?</h4><ul><li>å¼‚æ­¥å’Œéé˜»å¡çš„åŒºåˆ«:</li></ul><ol><li>å¼‚æ­¥ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åï¼Œè¿™ä¸ªè°ƒç”¨å°±ç›´æ¥è¿”å›ï¼Œä¸ç®¡æœ‰æ— ç»“æœï¼›å¼‚æ­¥æ˜¯è¿‡ç¨‹ã€‚</li><li>éé˜»å¡ï¼šå…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æœï¼ˆæ¶ˆæ¯ï¼Œè¿”å›å€¼ï¼‰æ—¶çš„çŠ¶æ€ï¼ŒæŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ã€‚</li></ol><ul><li>åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«ï¼š</li></ul><ol><li>æ­¥ï¼šä¸€ä¸ªæœåŠ¡çš„å®Œæˆéœ€è¦ä¾èµ–å…¶ä»–æœåŠ¡æ—¶ï¼Œåªæœ‰ç­‰å¾…è¢«ä¾èµ–çš„æœåŠ¡å®Œæˆåï¼Œæ‰ç®—å®Œæˆï¼Œè¿™æ˜¯ä¸€ç§å¯é çš„æœåŠ¡åºåˆ—ã€‚è¦ä¹ˆæˆåŠŸéƒ½æˆåŠŸï¼Œå¤±è´¥éƒ½å¤±è´¥ï¼ŒæœåŠ¡çš„çŠ¶æ€å¯ä»¥ä¿æŒä¸€è‡´ã€‚</li><li>å¼‚æ­¥ï¼šä¸€ä¸ªæœåŠ¡çš„å®Œæˆéœ€è¦ä¾èµ–å…¶ä»–æœåŠ¡æ—¶ï¼Œåªé€šçŸ¥å…¶ä»–ä¾èµ–æœåŠ¡å¼€å§‹æ‰§è¡Œï¼Œè€Œä¸éœ€è¦ç­‰å¾…è¢«ä¾èµ–çš„æœåŠ¡å®Œæˆï¼Œæ­¤æ—¶è¯¥æœåŠ¡å°±ç®—å®Œæˆäº†ã€‚è¢«ä¾èµ–çš„æœåŠ¡æ˜¯å¦æœ€ç»ˆå®Œæˆæ— æ³•ç¡®å®šï¼Œä¸€æ¬¡å®ƒæ˜¯ä¸€ä¸ªä¸å¯é çš„æœåŠ¡åºåˆ—ã€‚</li></ol><ul><li>æ¶ˆæ¯é€šçŸ¥ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥ï¼š</li></ul><ol><li>åŒæ­¥ï¼šå½“ä¸€ä¸ªåŒæ­¥è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…è¦ä¸€ç›´ç­‰å¾…è¿”å›æ¶ˆæ¯ï¼ˆæˆ–è€…è°ƒç”¨ç»“æœï¼‰é€šçŸ¥åï¼Œæ‰èƒ½è¿›è¡Œåç»­çš„æ‰§è¡Œã€‚</li><li>å¼‚æ­¥ï¼šå½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°è¿”å›æ¶ˆæ¯ï¼ˆç»“æœï¼‰ã€‚åœ¨è°ƒç”¨ç»“æŸä¹‹åï¼Œé€šè¿‡æ¶ˆæ¯å›è°ƒæ¥é€šçŸ¥è°ƒç”¨è€…æ˜¯å¦è°ƒç”¨æˆåŠŸã€‚</li></ol><ul><li>é˜»å¡ä¸éé˜»å¡çš„åŒºåˆ«ï¼š</li></ul><ol><li>é˜»å¡ï¼šé˜»å¡è°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æœè¿”å›ä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œä¸€ç›´å¤„äºç­‰å¾…æ¶ˆæ¯é€šçŸ¥ï¼Œä¸èƒ½å¤Ÿæ‰§è¡Œå…¶ä»–ä¸šåŠ¡,å‡½æ•°åªæœ‰åœ¨å¾—åˆ°ç»“æœä¹‹åæ‰ä¼šè¿”å›ã€‚</li><li>éé˜»å¡ï¼šéé˜»å¡å’Œé˜»å¡çš„æ¦‚å¿µç›¸å¯¹åº”ï¼ŒæŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æœä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¸ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œè€Œä¼šç«‹åˆ»è¿”å›ã€‚</li></ol><p>åŒæ­¥ä¸å¼‚æ­¥æ˜¯å¯¹åº”çš„ï¼Œå®ƒä»¬æ˜¯çº¿ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´è¦ä¹ˆæ˜¯åŒæ­¥çš„ï¼Œè¦ä¹ˆæ˜¯å¼‚æ­¥çš„ã€‚</p><p>é˜»å¡ä¸éé˜»å¡æ˜¯å¯¹åŒä¸€ä¸ªçº¿ç¨‹æ¥è¯´çš„ï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹è¦ä¹ˆå¤„äºé˜»å¡ï¼Œè¦ä¹ˆå¤„äºéé˜»å¡ã€‚</p><p>é˜»å¡æ˜¯ä½¿ç”¨åŒæ­¥æœºåˆ¶çš„ç»“æœï¼Œéé˜»å¡åˆ™æ˜¯ä½¿ç”¨å¼‚æ­¥æœºåˆ¶çš„ç»“æœã€‚</p><h4 id="30-LogåŒ…çº¿ç¨‹å®‰å…¨å—ï¼Ÿ"><a href="#30-LogåŒ…çº¿ç¨‹å®‰å…¨å—ï¼Ÿ" class="headerlink" title="30. LogåŒ…çº¿ç¨‹å®‰å…¨å—ï¼Ÿ"></a>30. LogåŒ…çº¿ç¨‹å®‰å…¨å—ï¼Ÿ</h4><p>Golangçš„æ ‡å‡†åº“æä¾›äº†logçš„æœºåˆ¶ï¼Œä½†æ˜¯è¯¥æ¨¡å—çš„åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼ˆçœ‹ä¼¼ç®€å•ï¼Œå…¶å®ä»–æœ‰ä»–çš„è®¾è®¡æ€è·¯ï¼‰ã€‚åœ¨è¾“å‡ºçš„ä½ç½®åšäº†çº¿ç¨‹å®‰å…¨çš„ä¿æŠ¤ã€‚</p><h4 id="31-Goroutineå’Œçº¿ç¨‹çš„åŒºåˆ«"><a href="#31-Goroutineå’Œçº¿ç¨‹çš„åŒºåˆ«" class="headerlink" title="31. Goroutineå’Œçº¿ç¨‹çš„åŒºåˆ«?"></a>31. Goroutineå’Œçº¿ç¨‹çš„åŒºåˆ«?</h4><p>ä»è°ƒåº¦ä¸Šçœ‹ï¼Œgoroutineçš„è°ƒåº¦å¼€é”€è¿œè¿œå°äºçº¿ç¨‹è°ƒåº¦å¼€é”€ã€‚</p><p>OSçš„çº¿ç¨‹ç”±OSå†…æ ¸è°ƒåº¦ï¼Œæ¯éš”å‡ æ¯«ç§’ï¼Œä¸€ä¸ªç¡¬ä»¶æ—¶é’Ÿä¸­æ–­å‘åˆ°CPUï¼ŒCPUè°ƒç”¨ä¸€ä¸ªè°ƒåº¦å™¨å†…æ ¸å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æš‚åœå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼ŒæŠŠä»–çš„å¯„å­˜å™¨ä¿¡æ¯ä¿å­˜åˆ°å†…å­˜ä¸­ï¼ŒæŸ¥çœ‹çº¿ç¨‹åˆ—è¡¨å¹¶å†³å®šæ¥ä¸‹æ¥è¿è¡Œå“ªä¸€ä¸ªçº¿ç¨‹ï¼Œå†ä»å†…å­˜ä¸­æ¢å¤çº¿ç¨‹çš„æ³¨å†Œè¡¨ä¿¡æ¯ï¼Œæœ€åç»§ç»­æ‰§è¡Œé€‰ä¸­çš„çº¿ç¨‹ã€‚è¿™ç§çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¸€ä¸ªå®Œæ•´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå³ä¿å­˜ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€åˆ°å†…å­˜ï¼Œå†æ¢å¤å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œæœ€åæ›´æ–°è°ƒåº¦å™¨çš„æ•°æ®ç»“æ„ã€‚æŸç§æ„ä¹‰ä¸Šï¼Œè¿™ç§æ“ä½œè¿˜æ˜¯å¾ˆæ…¢çš„ã€‚</p><p>Goè¿è¡Œçš„æ—¶å€™åŒ…æ¶µä¸€ä¸ªè‡ªå·±çš„è°ƒåº¦å™¨ï¼Œè¿™ä¸ªè°ƒåº¦å™¨ä½¿ç”¨ä¸€ä¸ªç§°ä¸ºä¸€ä¸ªM:Nè°ƒåº¦æŠ€æœ¯ï¼Œmä¸ªgoroutineåˆ°nä¸ªosçº¿ç¨‹ï¼ˆå¯ä»¥ç”¨GOMAXPROCSæ¥æ§åˆ¶nçš„æ•°é‡ï¼‰ï¼ŒGoçš„è°ƒåº¦å™¨ä¸æ˜¯ç”±ç¡¬ä»¶æ—¶é’Ÿæ¥å®šæœŸè§¦å‘çš„ï¼Œè€Œæ˜¯ç”±ç‰¹å®šçš„goè¯­è¨€ç»“æ„æ¥è§¦å‘çš„ï¼Œä»–ä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸è¯­å¢ƒï¼Œæ‰€ä»¥è°ƒåº¦ä¸€ä¸ªgoroutineæ¯”è°ƒåº¦ä¸€ä¸ªçº¿ç¨‹çš„æˆæœ¬ä½å¾ˆå¤šã€‚</p><p>ä»æ ˆç©ºé—´ä¸Šï¼Œgoroutineçš„æ ˆç©ºé—´æ›´åŠ åŠ¨æ€çµæ´»ã€‚</p><p>æ¯ä¸ªOSçš„çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå›ºå®šå¤§å°çš„æ ˆå†…å­˜ï¼Œé€šå¸¸æ˜¯2MBï¼Œæ ˆå†…å­˜ç”¨äºä¿å­˜åœ¨å…¶ä»–å‡½æ•°è°ƒç”¨æœŸé—´å“ªäº›æ­£åœ¨æ‰§è¡Œæˆ–è€…ä¸´æ—¶æš‚åœçš„å‡½æ•°çš„å±€éƒ¨å˜é‡ã€‚è¿™ä¸ªå›ºå®šçš„æ ˆå¤§å°ï¼Œå¦‚æœå¯¹äºgoroutineæ¥è¯´ï¼Œå¯èƒ½æ˜¯ä¸€ç§å·¨å¤§çš„æµªè´¹ã€‚ä½œä¸ºå¯¹æ¯”goroutineåœ¨ç”Ÿå‘½å‘¨æœŸå¼€å§‹åªæœ‰ä¸€ä¸ªå¾ˆå°çš„æ ˆï¼Œå…¸å‹æƒ…å†µæ˜¯2KB, åœ¨goç¨‹åºä¸­ï¼Œä¸€æ¬¡åˆ›å»ºåä¸‡å·¦å³çš„goroutineä¹Ÿä¸ç½•è§ï¼ˆ2KB*100,000=200MBï¼‰ã€‚è€Œä¸”goroutineçš„æ ˆä¸æ˜¯å›ºå®šå¤§å°ï¼Œå®ƒå¯ä»¥æŒ‰éœ€å¢å¤§å’Œç¼©å°ï¼Œæœ€å¤§é™åˆ¶å¯ä»¥åˆ°1GBã€‚</p><p>goroutineæ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„æ ‡è¯†ã€‚</p><p>åœ¨å¤§éƒ¨åˆ†æ”¯æŒå¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€ä¸­ï¼Œçº¿ç¨‹æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„æ ‡è¯†ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–è€…æŒ‡é’ˆï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬æ„å»ºä¸€ä¸ªçº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå…¨å±€çš„mapï¼Œä»¥çº¿ç¨‹çš„æ ‡è¯†ä½œä¸ºé”®ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹ä½¿ç”¨è¿™ä¸ªmapå­˜å‚¨å’Œè·å–å€¼ï¼Œä¸å—å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚</p><p>goroutineä¸­æ²¡æœ‰å¯ä¾›ç¨‹åºå‘˜è®¿é—®çš„æ ‡è¯†ï¼ŒåŸå› æ˜¯ä¸€ç§çº¯å‡½æ•°çš„ç†å¿µï¼Œä¸å¸Œæœ›æ»¥ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨å¯¼è‡´ä¸€ä¸ªä¸å¥åº·çš„è¶…è·ä½œç”¨ï¼Œå³å‡½æ•°çš„è¡Œä¸ºä¸ä»…å–å†³äºå®ƒçš„å‚æ•°ï¼Œè¿˜å–å†³äºè¿è¡Œå®ƒçš„çº¿ç¨‹æ ‡è¯†ã€‚</p><h4 id="32-æ»‘åŠ¨çª—å£çš„æ¦‚å¿µä»¥åŠåº”ç”¨"><a href="#32-æ»‘åŠ¨çª—å£çš„æ¦‚å¿µä»¥åŠåº”ç”¨" class="headerlink" title="32. æ»‘åŠ¨çª—å£çš„æ¦‚å¿µä»¥åŠåº”ç”¨?"></a>32. æ»‘åŠ¨çª—å£çš„æ¦‚å¿µä»¥åŠåº”ç”¨?</h4><p>æ»‘åŠ¨çª—å£æ¦‚å¿µä¸ä»…å­˜åœ¨äºæ•°æ®é“¾è·¯å±‚ï¼Œä¹Ÿå­˜åœ¨äºä¼ è¾“å±‚ï¼Œä¸¤è€…æœ‰ä¸åŒçš„åè®®ï¼Œä½†åŸºæœ¬åŸç†æ˜¯ç›¸è¿‘çš„ã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹äºå¸§çš„ä¼ é€ï¼Œå¦ä¸€ä¸ªæ˜¯å­—èŠ‚æ•°æ®çš„ä¼ é€ã€‚</p><p>æ»‘åŠ¨çª—å£ï¼ˆSliding windowï¼‰æ˜¯ä¸€ç§æµé‡æ§åˆ¶æŠ€æœ¯ã€‚æ—©æœŸçš„ç½‘ç»œé€šä¿¡ä¸­ï¼Œé€šä¿¡åŒæ–¹ä¸ä¼šè€ƒè™‘ç½‘ç»œçš„æ‹¥æŒ¤æƒ…å†µç›´æ¥å‘é€æ•°æ®ã€‚ç”±äºå¤§å®¶ä¸çŸ¥é“ç½‘ç»œæ‹¥å¡çŠ¶å†µï¼ŒåŒæ—¶å‘é€æ•°æ®ï¼Œå¯¼è‡´ä¸­é—´èŠ‚ç‚¹é˜»å¡æ‰åŒ…ï¼Œè°ä¹Ÿå‘ä¸äº†æ•°æ®ï¼Œæ‰€ä»¥å°±æœ‰äº†æ»‘åŠ¨çª—å£æœºåˆ¶æ¥è§£å†³æ­¤é—®é¢˜ã€‚å‚è§æ»‘åŠ¨çª—å£å¦‚ä½•æ ¹æ®ç½‘ç»œæ‹¥å¡å‘é€æ•°æ®ä»¿çœŸè§†é¢‘ã€‚</p><p>æ»‘åŠ¨çª—å£åè®®æ˜¯ç”¨æ¥æ”¹å–„ååé‡çš„ä¸€ç§æŠ€æœ¯ï¼Œå³å®¹è®¸å‘é€æ–¹åœ¨æ¥æ”¶ä»»ä½•åº”ç­”ä¹‹å‰ä¼ é€é™„åŠ çš„åŒ…ã€‚æ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹åœ¨æŸä¸€æ—¶åˆ»èƒ½é€å¤šå°‘åŒ…ï¼ˆç§°çª—å£å°ºå¯¸ï¼‰ã€‚</p><p>CPä¸­é‡‡ç”¨æ»‘åŠ¨çª—å£æ¥è¿›è¡Œä¼ è¾“æ§åˆ¶ï¼Œæ»‘åŠ¨çª—å£çš„å¤§å°æ„å‘³ç€æ¥æ”¶æ–¹è¿˜æœ‰å¤šå¤§çš„ç¼“å†²åŒºå¯ä»¥ç”¨äºæ¥æ”¶æ•°æ®ã€‚å‘é€æ–¹å¯ä»¥é€šè¿‡æ»‘åŠ¨çª—å£çš„å¤§å°æ¥ç¡®å®šåº”è¯¥å‘é€å¤šå°‘å­—èŠ‚çš„æ•°æ®ã€‚å½“æ»‘åŠ¨çª—å£ä¸º0æ—¶ï¼Œå‘é€æ–¹ä¸€èˆ¬ä¸èƒ½å†å‘é€æ•°æ®æŠ¥ï¼Œä½†æœ‰ä¸¤ç§æƒ…å†µé™¤å¤–ï¼Œä¸€ç§æƒ…å†µæ˜¯å¯ä»¥å‘é€ç´§æ€¥æ•°æ®ï¼Œä¾‹å¦‚ï¼Œå…è®¸ç”¨æˆ·ç»ˆæ­¢åœ¨è¿œç«¯æœºä¸Šçš„è¿è¡Œè¿›ç¨‹ã€‚å¦ä¸€ç§æƒ…å†µæ˜¯å‘é€æ–¹å¯ä»¥å‘é€ä¸€ä¸ª1å­—èŠ‚çš„æ•°æ®æŠ¥æ¥é€šçŸ¥æ¥æ”¶æ–¹é‡æ–°å£°æ˜å®ƒå¸Œæœ›æ¥æ”¶çš„ä¸‹ä¸€å­—èŠ‚åŠå‘é€æ–¹çš„æ»‘åŠ¨çª—å£å¤§å°ã€‚</p><h4 id="33-æ€ä¹ˆåšå¼¹æ€§æ‰©ç¼©å®¹ï¼ŒåŸç†æ˜¯ä»€ä¹ˆ"><a href="#33-æ€ä¹ˆåšå¼¹æ€§æ‰©ç¼©å®¹ï¼ŒåŸç†æ˜¯ä»€ä¹ˆ" class="headerlink" title="33. æ€ä¹ˆåšå¼¹æ€§æ‰©ç¼©å®¹ï¼ŒåŸç†æ˜¯ä»€ä¹ˆ?"></a>33. æ€ä¹ˆåšå¼¹æ€§æ‰©ç¼©å®¹ï¼ŒåŸç†æ˜¯ä»€ä¹ˆ?</h4><p>å¼¹æ€§ä¼¸ç¼©ï¼ˆAutoâ€‚Scalingï¼‰æ ¹æ®æ‚¨çš„ä¸šåŠ¡éœ€æ±‚å’Œä¼¸ç¼©ç­–ç•¥ï¼Œä¸ºæ‚¨è‡ªåŠ¨è°ƒæ•´è®¡ç®—èµ„æºã€‚æ‚¨å¯è®¾ç½®å®šæ—¶ã€å‘¨æœŸæˆ–ç›‘æ§ç­–ç•¥ï¼Œæ°åˆ°å¥½å¤„åœ°å¢åŠ æˆ–å‡å°‘CVMå®ä¾‹ï¼Œå¹¶å®Œæˆå®ä¾‹é…ç½®ï¼Œä¿è¯ä¸šåŠ¡å¹³ç¨³å¥åº·è¿è¡Œã€‚åœ¨éœ€æ±‚é«˜å³°æœŸæ—¶ï¼Œå¼¹æ€§ä¼¸ç¼©è‡ªåŠ¨å¢åŠ CVMå®ä¾‹çš„æ•°é‡ï¼Œä»¥ä¿è¯æ€§èƒ½ä¸å—å½±å“ï¼›å½“éœ€æ±‚è¾ƒä½æ—¶ï¼Œåˆ™ä¼šå‡å°‘CVMå®ä¾‹æ•°é‡ä»¥é™ä½æˆæœ¬ã€‚å¼¹æ€§ä¼¸ç¼©æ—¢é€‚åˆéœ€æ±‚ç¨³å®šçš„åº”ç”¨ç¨‹åºï¼ŒåŒæ—¶ä¹Ÿé€‚åˆæ¯å¤©ã€æ¯å‘¨ã€æ¯æœˆä½¿ç”¨é‡ä¸åœæ³¢åŠ¨çš„åº”ç”¨ç¨‹åºã€‚</p><h4 id="34-è®©ä½ è®¾è®¡ä¸€ä¸ªwebæ¡†æ¶ï¼Œä½ è¦æ€ä¹ˆè®¾è®¡ï¼Œè¯´ä¸€ä¸‹æ­¥éª¤"><a href="#34-è®©ä½ è®¾è®¡ä¸€ä¸ªwebæ¡†æ¶ï¼Œä½ è¦æ€ä¹ˆè®¾è®¡ï¼Œè¯´ä¸€ä¸‹æ­¥éª¤" class="headerlink" title="34. è®©ä½ è®¾è®¡ä¸€ä¸ªwebæ¡†æ¶ï¼Œä½ è¦æ€ä¹ˆè®¾è®¡ï¼Œè¯´ä¸€ä¸‹æ­¥éª¤."></a>34. è®©ä½ è®¾è®¡ä¸€ä¸ªwebæ¡†æ¶ï¼Œä½ è¦æ€ä¹ˆè®¾è®¡ï¼Œè¯´ä¸€ä¸‹æ­¥éª¤.</h4><h4 id="35-è¯´ä¸€ä¸‹ä¸­é—´ä»¶åŸç†"><a href="#35-è¯´ä¸€ä¸‹ä¸­é—´ä»¶åŸç†" class="headerlink" title="35. è¯´ä¸€ä¸‹ä¸­é—´ä»¶åŸç†."></a>35. è¯´ä¸€ä¸‹ä¸­é—´ä»¶åŸç†.</h4><p>ä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰æ˜¯åŸºç¡€è½¯ä»¶çš„ä¸€å¤§ç±»ï¼Œå±äºå¯å¤ç”¨è½¯ä»¶çš„èŒƒç•´ã€‚ä¸­é—´ä»¶å¤„äºæ“ä½œç³»ç»Ÿè½¯ä»¶ä¸ç”¨æˆ·çš„åº”ç”¨è½¯ä»¶çš„ä¸­é—´ã€‚ä¸­é—´ä»¶åœ¨æ“ä½œç³»ç»Ÿã€ç½‘ç»œå’Œæ•°æ®åº“ä¹‹ä¸Šï¼Œåº”ç”¨è½¯ä»¶çš„ä¸‹å±‚ï¼Œæ€»çš„ä½œç”¨æ˜¯ä¸ºå¤„äºè‡ªå·±ä¸Šå±‚çš„åº”ç”¨è½¯ä»¶æä¾›è¿è¡Œä¸å¼€å‘çš„ç¯å¢ƒï¼Œå¸®åŠ©ç”¨æˆ·çµæ´»ã€é«˜æ•ˆåœ°å¼€å‘å’Œé›†æˆå¤æ‚çš„åº”ç”¨è½¯ä»¶  IDCçš„å®šä¹‰æ˜¯ï¼šä¸­é—´ä»¶æ˜¯ä¸€ç§ç‹¬ç«‹çš„ç³»ç»Ÿè½¯ä»¶æˆ–æœåŠ¡ç¨‹åºï¼Œåˆ†å¸ƒå¼åº”ç”¨è½¯ä»¶å€ŸåŠ©è¿™ç§è½¯ä»¶åœ¨ä¸åŒçš„æŠ€æœ¯ä¹‹é—´å…±äº«èµ„æºï¼Œä¸­é—´ä»¶ä½äºå®¢æˆ·æœºæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œç®¡ç†è®¡ç®—èµ„æºå’Œç½‘ç»œé€šä¿¡ã€‚</p><p>ä¸­é—´ä»¶è§£å†³çš„é—®é¢˜æ˜¯ï¼š</p><p>åœ¨ä¸­é—´ä»¶äº§ç”Ÿä»¥å‰ï¼Œåº”ç”¨è½¯ä»¶ç›´æ¥ä½¿ç”¨æ“ä½œç³»ç»Ÿã€ç½‘ç»œåè®®å’Œæ•°æ®åº“ç­‰å¼€å‘ï¼Œè¿™äº›éƒ½æ˜¯è®¡ç®—æœºæœ€åº•å±‚çš„ä¸œè¥¿ï¼Œè¶Šåº•å±‚è¶Šå¤æ‚ï¼Œå¼€å‘è€…ä¸å¾—ä¸é¢ä¸´è®¸å¤šå¾ˆæ£˜æ‰‹çš„é—®é¢˜ï¼Œå¦‚æ“ä½œç³»ç»Ÿçš„å¤šæ ·æ€§ï¼Œç¹æ‚çš„ç½‘ç»œç¨‹åºè®¾è®¡ã€ç®¡ç†ï¼Œå¤æ‚å¤šå˜çš„ç½‘ç»œç¯å¢ƒï¼Œæ•°æ®åˆ†æ•£å¤„ç†å¸¦æ¥çš„ä¸ä¸€è‡´æ€§é—®é¢˜ã€æ€§èƒ½å’Œæ•ˆç‡ã€å®‰å…¨ï¼Œç­‰ç­‰ã€‚è¿™äº›ä¸ç”¨æˆ·çš„ä¸šåŠ¡æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œä½†åˆå¿…é¡»è§£å†³ï¼Œè€—è´¹äº†å¤§é‡æœ‰é™çš„æ—¶é—´å’Œç²¾åŠ›ã€‚äºæ˜¯ï¼Œæœ‰äººæå‡ºèƒ½ä¸èƒ½å°†åº”ç”¨è½¯ä»¶æ‰€è¦é¢ä¸´çš„å…±æ€§é—®é¢˜è¿›è¡Œæç‚¼ã€æŠ½è±¡ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šå†å½¢æˆä¸€ä¸ªå¯å¤ç”¨çš„éƒ¨åˆ†ï¼Œä¾›æˆåƒä¸Šä¸‡çš„åº”ç”¨è½¯ä»¶é‡å¤ä½¿ç”¨ã€‚è¿™ä¸€æŠ€æœ¯æ€æƒ³æœ€ç»ˆæ„æˆäº†ä¸­é—´ä»¶è¿™ç±»çš„è½¯ä»¶ã€‚ä¸­é—´ä»¶å±è”½äº†åº•å±‚æ“ä½œç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œä½¿ç¨‹åºå¼€å‘äººå‘˜é¢å¯¹ä¸€ä¸ªç®€å•è€Œç»Ÿä¸€çš„å¼€å‘ç¯å¢ƒï¼Œå‡å°‘ç¨‹åºè®¾è®¡çš„å¤æ‚æ€§ï¼Œå°†æ³¨æ„åŠ›é›†ä¸­åœ¨è‡ªå·±çš„ä¸šåŠ¡ä¸Šï¼Œä¸å¿…å†ä¸ºç¨‹åºåœ¨ä¸åŒç³»ç»Ÿè½¯ä»¶ä¸Šçš„ç§»æ¤è€Œé‡å¤å·¥ä½œï¼Œä»è€Œå¤§å¤§å‡å°‘äº†æŠ€æœ¯ä¸Šçš„è´Ÿæ‹…ã€‚</p><h4 id="36-æ€ä¹ˆè®¾è®¡ormï¼Œè®©ä½ å†™-ä½ ä¼šæ€ä¹ˆå†™"><a href="#36-æ€ä¹ˆè®¾è®¡ormï¼Œè®©ä½ å†™-ä½ ä¼šæ€ä¹ˆå†™" class="headerlink" title="36. æ€ä¹ˆè®¾è®¡ormï¼Œè®©ä½ å†™,ä½ ä¼šæ€ä¹ˆå†™?"></a>36. æ€ä¹ˆè®¾è®¡ormï¼Œè®©ä½ å†™,ä½ ä¼šæ€ä¹ˆå†™?</h4><h4 id="37-ç”¨è¿‡åŸç”Ÿçš„httpåŒ…å—ï¼Ÿ"><a href="#37-ç”¨è¿‡åŸç”Ÿçš„httpåŒ…å—ï¼Ÿ" class="headerlink" title="37. ç”¨è¿‡åŸç”Ÿçš„httpåŒ…å—ï¼Ÿ"></a>37. ç”¨è¿‡åŸç”Ÿçš„httpåŒ…å—ï¼Ÿ</h4><h4 id="38-ä¸€ä¸ªéå¸¸å¤§çš„æ•°ç»„ï¼Œè®©å…¶ä¸­ä¸¤ä¸ªæ•°æƒ³åŠ ç­‰äº1000æ€ä¹ˆç®—"><a href="#38-ä¸€ä¸ªéå¸¸å¤§çš„æ•°ç»„ï¼Œè®©å…¶ä¸­ä¸¤ä¸ªæ•°æƒ³åŠ ç­‰äº1000æ€ä¹ˆç®—" class="headerlink" title="38. ä¸€ä¸ªéå¸¸å¤§çš„æ•°ç»„ï¼Œè®©å…¶ä¸­ä¸¤ä¸ªæ•°æƒ³åŠ ç­‰äº1000æ€ä¹ˆç®—?"></a>38. ä¸€ä¸ªéå¸¸å¤§çš„æ•°ç»„ï¼Œè®©å…¶ä¸­ä¸¤ä¸ªæ•°æƒ³åŠ ç­‰äº1000æ€ä¹ˆç®—?</h4><h4 id="39-å„ä¸ªç³»ç»Ÿå‡ºé—®é¢˜æ€ä¹ˆç›‘æ§æŠ¥è­¦"><a href="#39-å„ä¸ªç³»ç»Ÿå‡ºé—®é¢˜æ€ä¹ˆç›‘æ§æŠ¥è­¦" class="headerlink" title="39. å„ä¸ªç³»ç»Ÿå‡ºé—®é¢˜æ€ä¹ˆç›‘æ§æŠ¥è­¦."></a>39. å„ä¸ªç³»ç»Ÿå‡ºé—®é¢˜æ€ä¹ˆç›‘æ§æŠ¥è­¦.</h4><p>å¯ä»¥ä½¿ç”¨prometheusæ­é…kongç½‘å…³ï¼Œç›‘æ§å„ä¸ªç³»ç»Ÿçš„æ¥å£è½¬å‘å¤„ï¼Œè¿›è¡Œå¤„ç†æŠ¥è­¦ï¼Œç„¶åä¸ŠæŠ¥ä¹‹åï¼Œè®¾ç½®é˜ˆå€¼ï¼ŒæŠ¥è­¦å’Œè‡ªæ¢å¤ç³»ç»Ÿè®¾è®¡ã€‚</p><h4 id="40-å¸¸ç”¨æµ‹è¯•å·¥å…·ï¼Œå‹æµ‹å·¥å…·ï¼Œæ–¹æ³•"><a href="#40-å¸¸ç”¨æµ‹è¯•å·¥å…·ï¼Œå‹æµ‹å·¥å…·ï¼Œæ–¹æ³•" class="headerlink" title="40. å¸¸ç”¨æµ‹è¯•å·¥å…·ï¼Œå‹æµ‹å·¥å…·ï¼Œæ–¹æ³•?"></a>40. å¸¸ç”¨æµ‹è¯•å·¥å…·ï¼Œå‹æµ‹å·¥å…·ï¼Œæ–¹æ³•?</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">goconvey,vegeta</span><br></pre></td></tr></table></figure><h4 id="41-å¤æ‚çš„å•å…ƒæµ‹è¯•æ€ä¹ˆæµ‹è¯•ï¼Œæ¯”å¦‚æœ‰å¤–éƒ¨æ¥å£mysqlæ¥å£çš„æƒ…å†µ"><a href="#41-å¤æ‚çš„å•å…ƒæµ‹è¯•æ€ä¹ˆæµ‹è¯•ï¼Œæ¯”å¦‚æœ‰å¤–éƒ¨æ¥å£mysqlæ¥å£çš„æƒ…å†µ" class="headerlink" title="41. å¤æ‚çš„å•å…ƒæµ‹è¯•æ€ä¹ˆæµ‹è¯•ï¼Œæ¯”å¦‚æœ‰å¤–éƒ¨æ¥å£mysqlæ¥å£çš„æƒ…å†µ"></a>41. å¤æ‚çš„å•å…ƒæµ‹è¯•æ€ä¹ˆæµ‹è¯•ï¼Œæ¯”å¦‚æœ‰å¤–éƒ¨æ¥å£mysqlæ¥å£çš„æƒ…å†µ</h4><h4 id="42-redisé›†ç¾¤ï¼Œå“¨å…µï¼ŒæŒä¹…åŒ–ï¼Œäº‹åŠ¡"><a href="#42-redisé›†ç¾¤ï¼Œå“¨å…µï¼ŒæŒä¹…åŒ–ï¼Œäº‹åŠ¡" class="headerlink" title="42. redisé›†ç¾¤ï¼Œå“¨å…µï¼ŒæŒä¹…åŒ–ï¼Œäº‹åŠ¡"></a>42. redisé›†ç¾¤ï¼Œå“¨å…µï¼ŒæŒä¹…åŒ–ï¼Œäº‹åŠ¡</h4><h4 id="43-mysqlå’ŒredisåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#43-mysqlå’ŒredisåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="43. mysqlå’ŒredisåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ"></a>43. mysqlå’ŒredisåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ</h4><ul><li>mysqlå’Œredisçš„æ•°æ®åº“ç±»å‹</li></ul><p>mysqlæ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œä¸»è¦ç”¨äºå­˜æ”¾æŒä¹…åŒ–æ•°æ®ï¼Œå°†æ•°æ®å­˜å‚¨åœ¨ç¡¬ç›˜ä¸­ï¼Œè¯»å–é€Ÿåº¦è¾ƒæ…¢ã€‚</p><p>redisæ˜¯NOSQLï¼Œå³éå…³ç³»å‹æ•°æ®åº“ï¼Œä¹Ÿæ˜¯ç¼“å­˜æ•°æ®åº“ï¼Œå³å°†æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œç¼“å­˜çš„è¯»å–é€Ÿåº¦å¿«ï¼Œèƒ½å¤Ÿå¤§å¤§çš„æé«˜è¿è¡Œæ•ˆç‡ï¼Œä½†æ˜¯ä¿å­˜æ—¶é—´æœ‰é™ã€‚</p><ul><li>mysqlçš„è¿è¡Œæœºåˆ¶</li></ul><p>mysqlä½œä¸ºæŒä¹…åŒ–å­˜å‚¨çš„å…³ç³»å‹æ•°æ®åº“ï¼Œç›¸å¯¹è–„å¼±çš„åœ°æ–¹åœ¨äºæ¯æ¬¡è¯·æ±‚è®¿é—®æ•°æ®åº“æ—¶ï¼Œéƒ½å­˜åœ¨ç€I/Oæ“ä½œï¼Œå¦‚æœåå¤é¢‘ç¹çš„è®¿é—®æ•°æ®åº“ã€‚ç¬¬ä¸€ï¼šä¼šåœ¨åå¤é“¾æ¥æ•°æ®åº“ä¸ŠèŠ±è´¹å¤§é‡æ—¶é—´ï¼Œä»è€Œå¯¼è‡´è¿è¡Œæ•ˆç‡è¿‡æ…¢ï¼›ç¬¬äºŒï¼šåå¤çš„è®¿é—®æ•°æ®åº“ä¹Ÿä¼šå¯¼è‡´æ•°æ®åº“çš„è´Ÿè½½è¿‡é«˜ï¼Œé‚£ä¹ˆæ­¤æ—¶ç¼“å­˜çš„æ¦‚å¿µå°±è¡ç”Ÿäº†å‡ºæ¥ã€‚</p><ul><li>ç¼“å­˜</li></ul><p>ç¼“å­˜å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼ˆcacheï¼‰ï¼Œå½“æµè§ˆå™¨æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šå¯¹åœ¨ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœå­˜åœ¨ï¼Œå°±è·å–ï¼›å¦åˆ™å°±è®¿é—®æ•°æ®åº“ã€‚</p><p>ç¼“å­˜çš„å¥½å¤„å°±æ˜¯è¯»å–é€Ÿåº¦å¿«ã€‚</p><ul><li>redisæ•°æ®åº“</li></ul><p>redisæ•°æ®åº“å°±æ˜¯ä¸€æ¬¾ç¼“å­˜æ•°æ®åº“ï¼Œç”¨äºå­˜å‚¨ä½¿ç”¨é¢‘ç¹çš„æ•°æ®ï¼Œè¿™æ ·å‡å°‘è®¿é—®æ•°æ®åº“çš„æ¬¡æ•°ï¼Œæé«˜è¿è¡Œæ•ˆç‡ã€‚</p><ul><li>rediså’Œmysqlçš„åŒºåˆ«æ€»ç»“</li></ul><p>ï¼ˆ1ï¼‰ç±»å‹ä¸Š</p><p>ä»ç±»å‹ä¸Šæ¥è¯´ï¼Œmysqlæ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œredisæ˜¯ç¼“å­˜æ•°æ®åº“</p><p>ï¼ˆ2ï¼‰ä½œç”¨ä¸Š</p><p>mysqlç”¨äºæŒä¹…åŒ–çš„å­˜å‚¨æ•°æ®åˆ°ç¡¬ç›˜ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯é€Ÿåº¦è¾ƒæ…¢</p><p>redisç”¨äºå­˜å‚¨ä½¿ç”¨è¾ƒä¸ºé¢‘ç¹çš„æ•°æ®åˆ°ç¼“å­˜ä¸­ï¼Œè¯»å–é€Ÿåº¦å¿«</p><p>ï¼ˆ3ï¼‰éœ€æ±‚ä¸Š</p><p>mysqlå’Œrediså› ä¸ºéœ€æ±‚çš„ä¸åŒï¼Œä¸€èˆ¬éƒ½æ˜¯é…åˆä½¿ç”¨ã€‚</p><h4 id="44-é«˜å¯ç”¨è½¯ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#44-é«˜å¯ç”¨è½¯ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="44. é«˜å¯ç”¨è½¯ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ"></a>44. é«˜å¯ç”¨è½¯ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ</h4><ul><li>Heartbeat</li></ul><p>Heartbeatæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€ç‰Œçš„é›†ç¾¤ç®¡ç†è½¯ä»¶ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯V3.0ï¼Œ ä¹Ÿç§°ä¸ºHeartbeat 3.é€šè¿‡Heartbeatï¼Œå¯ä»¥å®ç°å¯¹æœåŠ¡å™¨èµ„æºï¼ˆipä»¥åŠç¨‹åºæœåŠ¡ç­‰èµ„æºï¼‰çš„ç›‘æ§å’Œç®¡ç†ï¼Œå¹¶åœ¨å‡ºç°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå°†èµ„æºé›†åˆä»ä¸€å°å·²ç»æ•…éšœçš„è®¡ç®—æœºå¿«é€Ÿè½¬ç§»åˆ°å¦ä¸€å°æ­£å¸¸è¿è½¬çš„æœºå™¨ä¸Šç»§ç»­æä¾›æœåŠ¡ã€‚</p><ul><li>Keepalived</li></ul><p>Keepalivedä¹Ÿæ˜¯ä¸€æ¬¾é«˜å¯ç”¨é›†ç¾¤ç®¡ç†è½¯ä»¶ï¼Œå…¶åŸºæœ¬åŠŸèƒ½ä¸Heartbeatéå¸¸ç±»ä¼¼ã€‚</p><p>Keepalivedå®ƒçš„åŠŸèƒ½ä¸»è¦åŒ…æ‹¬ä¸¤æ–¹é¢ï¼š</p><p>1ï¼‰é€šè¿‡IPæ¼‚ç§»ï¼Œå®ç°æœåŠ¡çš„é«˜å¯ç”¨ï¼šæœåŠ¡å™¨é›†ç¾¤å…±äº«ä¸€ä¸ªè™šæ‹ŸIPï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨å æœ‰è™šæ‹ŸIPå¹¶å¯¹å¤–æä¾›æœåŠ¡ï¼Œè‹¥è¯¥æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™è™šæ‹ŸIPæ¼‚ç§»è‡³å¦ä¸€å°æœåŠ¡å™¨å¹¶å¯¹å¤–æä¾›æœåŠ¡ï¼›</p><p>2ï¼‰å¯¹LVSåº”ç”¨æœåŠ¡å±‚çš„åº”ç”¨æœåŠ¡å™¨é›†ç¾¤è¿›è¡ŒçŠ¶æ€ç›‘æ§ï¼šè‹¥åº”ç”¨æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™keepalivedå°†å…¶ä»é›†ç¾¤ä¸­æ‘˜é™¤ï¼Œè‹¥åº”ç”¨æœåŠ¡å™¨æ¢å¤ï¼Œåˆ™keepalivedå°†å…¶é‡æ–°åŠ å…¥é›†ç¾¤ä¸­ã€‚</p><p>Keepalivedå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œå³é€šè¿‡IPæ¼‚ç§»å®ç°æœåŠ¡çš„é«˜å¯ç”¨ï¼Œä¹Ÿå¯ä»¥ç»“åˆLVSä½¿ç”¨ï¼Œå³ä¸€æ–¹é¢é€šè¿‡IPæ¼‚ç§»å®ç°LVSè´Ÿè½½å‡è¡¡å±‚çš„é«˜å¯ç”¨ï¼Œå¦ä¸€æ–¹é¢å®ç°LVSåº”ç”¨æœåŠ¡å±‚çš„çŠ¶æ€ç›‘æ§ã€‚</p><h4 id="45-æ€ä¹ˆæä¸€ä¸ªå¹¶å‘æœåŠ¡ç¨‹åºï¼Ÿ"><a href="#45-æ€ä¹ˆæä¸€ä¸ªå¹¶å‘æœåŠ¡ç¨‹åºï¼Ÿ" class="headerlink" title="45. æ€ä¹ˆæä¸€ä¸ªå¹¶å‘æœåŠ¡ç¨‹åºï¼Ÿ"></a>45. æ€ä¹ˆæä¸€ä¸ªå¹¶å‘æœåŠ¡ç¨‹åºï¼Ÿ</h4><h4 id="46-è®²è§£ä¸€ä¸‹ä½ åšè¿‡çš„é¡¹ç›®ï¼Œç„¶åæ‰¾é—®é¢˜é—®å®ç°ç»†èŠ‚ã€‚"><a href="#46-è®²è§£ä¸€ä¸‹ä½ åšè¿‡çš„é¡¹ç›®ï¼Œç„¶åæ‰¾é—®é¢˜é—®å®ç°ç»†èŠ‚ã€‚" class="headerlink" title="46. è®²è§£ä¸€ä¸‹ä½ åšè¿‡çš„é¡¹ç›®ï¼Œç„¶åæ‰¾é—®é¢˜é—®å®ç°ç»†èŠ‚ã€‚"></a>46. è®²è§£ä¸€ä¸‹ä½ åšè¿‡çš„é¡¹ç›®ï¼Œç„¶åæ‰¾é—®é¢˜é—®å®ç°ç»†èŠ‚ã€‚</h4><h4 id="47-mysqläº‹åŠ¡è¯´ä¸‹"><a href="#47-mysqläº‹åŠ¡è¯´ä¸‹" class="headerlink" title="47. mysqläº‹åŠ¡è¯´ä¸‹"></a>47. mysqläº‹åŠ¡è¯´ä¸‹</h4><p>äº‹åŠ¡æ˜¯ä¸€ç»„åŸå­æ€§çš„sqlå‘½ä»¤æˆ–è€…è¯´æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒ,å¦‚æœæ•°æ®åº“å¼•æ“èƒ½å¤ŸæˆåŠŸçš„å¯¹æ•°æ®åº“åº”ç”¨è¯¥ç»„çš„å…¨éƒ¨sqlè¯­å¥,é‚£ä¹ˆå°±æ‰§è¡Œè¯¥ç»„å‘½ä»¤å¦‚æœå…¶ä¸­æœ‰ä»»ä½•ä¸€æ¡è¯­å¥å› ä¸ºå´©æºƒæˆ–è€…å…¶å®ƒåŸå› æ— æ³•æ‰§è¡Œ,é‚£ä¹ˆè¯¥ç»„ä¸­æ‰€æœ‰çš„sqlè¯­å¥éƒ½ä¸ä¼šæ‰§è¡Œ,å¦‚æœæ²¡æœ‰æ˜¾ç¤ºå¯åŠ¨äº‹åŠ¡,æ•°æ®åº“ä¼šæ ¹æ®autocommitçš„å€¼.é»˜è®¤æ¯æ¡sqlæ“ä½œéƒ½ä¼šè‡ªåŠ¨æäº¤ã€‚</p><ul><li>åŸå­æ€§</li></ul><p>ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œ,è¦ä¹ˆéƒ½å®Œæˆ,è¦ä¹ˆéƒ½ä¸æ‰§è¡Œ.å¯¹äºä¸€ä¸ªäº‹åŠ¡æ¥è¯´,ä¸å¯èƒ½åªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚</p><ul><li>ä¸€è‡´æ€§</li></ul><p>æ•°æ®åº“ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€å˜åˆ°å¦å¤–ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº‹åŠ¡ä¹‹å‰å’Œä¹‹åçš„çŠ¶æ€éƒ½å¿…é¡»å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åœ¨äº‹åŠ¡Tå¼€å§‹æ—¶ï¼Œæ­¤æ—¶æ•°æ®åº“æœ‰ä¸€ç§çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€æ˜¯æ‰€æœ‰çš„MySQLå¯¹è±¡å¤„äºä¸€è‡´çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ•°æ®åº“å®Œæ•´æ€§çº¦æŸæ­£ç¡®ï¼Œæ—¥å¿—çŠ¶æ€ä¸€è‡´ç­‰ï¼Œå½“äº‹åŠ¡Tæäº¤åï¼Œè¿™æ—¶æ•°æ®åº“åˆæœ‰äº†ä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œä¸åŒçš„æ•°æ®ï¼Œä¸åŒçš„ç´¢å¼•ï¼Œä¸åŒçš„æ—¥å¿—ç­‰ï¼Œä½†æ­¤æ—¶ï¼Œçº¦æŸï¼Œæ•°æ®ï¼Œç´¢å¼•ï¼Œæ—¥å¿—ç­‰MySQLå„ç§å¯¹è±¡è¿˜æ˜¯è¦ä¿æŒä¸€è‡´æ€§ï¼ˆæ­£ç¡®æ€§ï¼‰ã€‚ è¿™å°±æ˜¯ ä»ä¸€ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€ï¼Œå˜åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯äº‹åŠ¡æ‰§è¡Œåï¼Œå¹¶æ²¡æœ‰ç ´åæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸï¼ˆä¸€åˆ‡éƒ½æ˜¯å¯¹çš„ï¼‰ã€‚</span><br></pre></td></tr></table></figure><ul><li>éš”ç¦»æ€§</li></ul><p>éš”ç¦»æ€§æ˜¯æŒ‡å½“å¤šä¸ªç”¨æˆ·å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œæ¯”å¦‚æ“ä½œåŒä¸€å¼ è¡¨æ—¶ï¼Œæ•°æ®åº“ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·å¼€å¯çš„äº‹åŠ¡ï¼Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡çš„æ“ä½œæ‰€å¹²æ‰°ï¼Œå¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´è¦ç›¸äº’éš”ç¦»ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å¯¹äºä»»æ„ä¸¤ä¸ªå¹¶å‘çš„äº‹åŠ¡T1å’ŒT2ï¼Œåœ¨äº‹åŠ¡T1çœ‹æ¥ï¼ŒT2è¦ä¹ˆåœ¨T1å¼€å§‹ä¹‹å‰å°±å·²ç»ç»“æŸï¼Œè¦ä¹ˆåœ¨T1ç»“æŸä¹‹åæ‰å¼€å§‹ï¼Œè¿™æ ·æ¯ä¸ªäº‹åŠ¡éƒ½æ„Ÿè§‰ä¸åˆ°æœ‰å…¶ä»–äº‹åŠ¡åœ¨å¹¶å‘åœ°æ‰§è¡Œã€‚</span><br></pre></td></tr></table></figure><ul><li>æŒä¹…æ€§</li></ul><p>æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤äº†ï¼Œé‚£ä¹ˆå¯¹äºæ•°æ®åº“ä¸­çš„æ•°æ®æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä¾¿æ˜¯åœ¨æ•°æ®åº“ç³»ç»Ÿé­é‡åˆ°æ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿä¸ä¼šä¸¢å¤±æäº¤äº‹åŠ¡çš„æ“ä½œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æˆ‘ä»¬åœ¨ä½¿ç”¨è¿æ¥æ± æ“ä½œæ•°æ®åº“æ—¶ï¼Œåœ¨æäº¤äº‹åŠ¡æ–¹æ³•åï¼Œæç¤ºç”¨æˆ·äº‹åŠ¡æ“ä½œå®Œæˆï¼Œå½“æˆ‘ä»¬ç¨‹åºæ‰§è¡Œå®Œæˆç›´åˆ°çœ‹åˆ°æç¤ºåï¼Œå°±å¯ä»¥è®¤å®šäº‹åŠ¡ä»¥åŠæ­£ç¡®æäº¤ï¼Œå³ä½¿è¿™æ—¶å€™æ•°æ®åº“å‡ºç°äº†é—®é¢˜ï¼Œä¹Ÿå¿…é¡»è¦å°†æˆ‘ä»¬çš„äº‹åŠ¡å®Œå…¨æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™å°±ä¼šé€ æˆæˆ‘ä»¬çœ‹åˆ°æç¤ºäº‹åŠ¡å¤„ç†å®Œæ¯•ï¼Œä½†æ˜¯æ•°æ®åº“å› ä¸ºæ•…éšœè€Œæ²¡æœ‰æ‰§è¡Œäº‹åŠ¡çš„é‡å¤§é”™è¯¯ã€‚</span><br></pre></td></tr></table></figure><h4 id="48-æ€ä¹ˆåšä¸€ä¸ªè‡ªåŠ¨åŒ–é…ç½®å¹³å°ç³»ç»Ÿï¼Ÿ"><a href="#48-æ€ä¹ˆåšä¸€ä¸ªè‡ªåŠ¨åŒ–é…ç½®å¹³å°ç³»ç»Ÿï¼Ÿ" class="headerlink" title="48. æ€ä¹ˆåšä¸€ä¸ªè‡ªåŠ¨åŒ–é…ç½®å¹³å°ç³»ç»Ÿï¼Ÿ"></a>48. æ€ä¹ˆåšä¸€ä¸ªè‡ªåŠ¨åŒ–é…ç½®å¹³å°ç³»ç»Ÿï¼Ÿ</h4><h4 id="49-grpcéµå¾ªä»€ä¹ˆåè®®ï¼Ÿ"><a href="#49-grpcéµå¾ªä»€ä¹ˆåè®®ï¼Ÿ" class="headerlink" title="49. grpcéµå¾ªä»€ä¹ˆåè®®ï¼Ÿ"></a>49. grpcéµå¾ªä»€ä¹ˆåè®®ï¼Ÿ</h4><h4 id="50-grpcå†…éƒ¨åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#50-grpcå†…éƒ¨åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="50. grpcå†…éƒ¨åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ"></a>50. grpcå†…éƒ¨åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ</h4><h4 id="51-http2çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸http1-1çš„å¯¹æ¯”ã€‚"><a href="#51-http2çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸http1-1çš„å¯¹æ¯”ã€‚" class="headerlink" title="51. http2çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸http1.1çš„å¯¹æ¯”ã€‚"></a>51. http2çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸http1.1çš„å¯¹æ¯”ã€‚</h4><table><thead><tr><th>HTTP1.1</th><th>HTTP2</th><th>QUIC</th></tr></thead><tbody><tr><td>æŒä¹…è¿æ¥</td><td>äºŒè¿›åˆ¶åˆ†å¸§</td><td>åŸºäºUDPçš„å¤šè·¯ä¼ è¾“ï¼ˆå•è¿æ¥ä¸‹ï¼‰</td></tr><tr><td>è¯·æ±‚ç®¡é“åŒ–</td><td>å¤šè·¯å¤ç”¨ï¼ˆæˆ–è¿æ¥å…±äº«ï¼‰</td><td>æä½çš„ç­‰å¾…æ—¶å»¶ï¼ˆç›¸æ¯”äºTCPçš„ä¸‰æ¬¡æ¡æ‰‹ï¼‰</td></tr><tr><td>å¢åŠ ç¼“å­˜å¤„ç†ï¼ˆæ–°çš„å­—æ®µå¦‚cache-controlï¼‰</td><td>å¤´éƒ¨å‹ç¼©</td><td>QUICä¸º ä¼ è¾“å±‚ åè®® ï¼Œæˆä¸ºæ›´å¤šåº”ç”¨å±‚çš„é«˜æ€§èƒ½é€‰æ‹©</td></tr><tr><td>å¢åŠ Hostå­—æ®µã€æ”¯æŒæ–­ç‚¹ä¼ è¾“ç­‰ï¼ˆæŠŠæ–‡ä»¶åˆ†æˆå‡ éƒ¨åˆ†ï¼‰</td><td>æœåŠ¡å™¨æ¨é€</td></tr></tbody></table><h4 id="52-Goçš„è°ƒåº¦åŸç†"><a href="#52-Goçš„è°ƒåº¦åŸç†" class="headerlink" title="52. Goçš„è°ƒåº¦åŸç†."></a>52. Goçš„è°ƒåº¦åŸç†.</h4><ul><li><a href="https://colobu.com/2017/05/04/go-scheduler/" target="_blank" rel="noopener">Goè°ƒåº¦å™¨: M, P å’Œ G</a></li><li><a href="http://www.flysnow.org/2017/04/11/go-in-action-go-goroutine.html" target="_blank" rel="noopener">Goè¯­è¨€å®æˆ˜ç¬”è®°ï¼ˆåäºŒï¼‰| Go goroutine</a></li><li><a href="http://ga0.github.io/golang/2015/09/20/golang-runtime-scheduler.html" target="_blank" rel="noopener">Golangè°ƒåº¦å™¨æºç åˆ†æ</a></li><li><a href="https://github.com/KeKe-Li/For-learning-Go-Tutorial/blob/master/src/chapter10/01.0.md" target="_blank" rel="noopener">Goroutineè°ƒåº¦è¿‡ç¨‹</a></li></ul><h4 id="53-go-structèƒ½ä¸èƒ½æ¯”è¾ƒ"><a href="#53-go-structèƒ½ä¸èƒ½æ¯”è¾ƒ" class="headerlink" title="53. go structèƒ½ä¸èƒ½æ¯”è¾ƒ"></a>53. go structèƒ½ä¸èƒ½æ¯”è¾ƒ</h4><ul><li>ç›¸åŒstructç±»å‹çš„å¯ä»¥æ¯”è¾ƒ</li><li>ä¸åŒstructç±»å‹çš„ä¸å¯ä»¥æ¯”è¾ƒ,ç¼–è¯‘éƒ½ä¸è¿‡ï¼Œç±»å‹ä¸åŒ¹é…</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line">func main() &#123;</span><br><span class="line">    type A struct &#123;</span><br><span class="line">        a int</span><br><span class="line">    &#125;</span><br><span class="line">    type B struct &#123;</span><br><span class="line">        a int</span><br><span class="line">    &#125;</span><br><span class="line">    a := A&#123;1&#125;</span><br><span class="line">    //b := A&#123;1&#125;</span><br><span class="line">    b := B&#123;1&#125;</span><br><span class="line">    if a == b &#123;</span><br><span class="line">        fmt.Println(&quot;a == b&quot;)</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        fmt.Println(&quot;a != b&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line">// output</span><br><span class="line">// command-line-arguments [command-line-arguments.test]</span><br><span class="line">// ./.go:14:7: invalid operation: a == b (mismatched types A and B)</span><br></pre></td></tr></table></figure><ol><li>go deferï¼ˆfor deferï¼‰</li></ol><ul><li><a href="https://deepzz.com/post/how-to-use-defer-in-golang.html" target="_blank" rel="noopener">Go å…³é”®å­— defer çš„ä¸€äº›å‘</a></li></ul><ol><li>selectå¯ä»¥ç”¨äºä»€ä¹ˆ?</li></ol><p>Goçš„selectä¸»è¦æ˜¯å¤„ç†å¤šä¸ªchannelçš„æ“ä½œ.</p><ul><li><a href="https://segmentfault.com/a/1190000006815341" target="_blank" rel="noopener">Goè¯­è¨€å¹¶å‘æ¨¡å‹ï¼šä½¿ç”¨ select</a></li></ul><ol><li>contextåŒ…çš„ç”¨é€”æ˜¯ä»€ä¹ˆ?</li></ol><p>godoc: <a href="https://golang.org/pkg/context/" target="_blank" rel="noopener">https://golang.org/pkg/context/</a></p><ul><li><a href="https://zhuanlan.zhihu.com/p/34417106" target="_blank" rel="noopener">Go Contextçš„è¸©å‘ç»å†</a></li><li><a href="http://www.flysnow.org/2017/05/12/go-in-action-go-context.html" target="_blank" rel="noopener">Goè¯­è¨€å®æˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰| Go Context</a></li></ul><ol><li>clientå¦‚ä½•å®ç°é•¿è¿æ¥?</li></ol><ul><li><a href="http://www.nowamagic.net/academy/detail/23350382#" target="_blank" rel="noopener">TCPåè®®çš„KeepAliveæœºåˆ¶ä¸HeartBeatå¿ƒè·³åŒ…</a></li><li><a href="http://www.nowamagic.net/academy/detail/23350305" target="_blank" rel="noopener">HTTP Keep-Aliveæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•å·¥ä½œï¼Ÿ</a></li></ul><ol><li>ä¸»åç¨‹å¦‚ä½•ç­‰å…¶ä½™åç¨‹å®Œå†æ“ä½œ?</li></ol><ul><li><a href="https://blog.csdn.net/u011304970/article/details/72722044" target="_blank" rel="noopener">Goå¹¶å‘ï¼šåˆ©ç”¨sync.WaitGroupå®ç°åç¨‹åŒæ­¥</a></li><li><a href="http://yoojia.xyz/2018/04/13/golang-waitgroup/" target="_blank" rel="noopener">Goè¯­è¨€é‡ç‚¹ç¬”è®°-æ·±å…¥äº†è§£sync.WaitGroup</a></li></ul><ol><li>sliceï¼Œlenï¼Œcapï¼Œå…±äº«ï¼Œæ‰©å®¹.</li><li>mapå¦‚ä½•é¡ºåºè¯»å–?</li></ol><p>å¯ä»¥é€šè¿‡sortä¸­çš„æ’åºåŒ…è¿›è¡Œå¯¹mapä¸­çš„keyè¿›è¡Œæ’åº</p><ul><li><a href="https://www.jianshu.com/p/6e52bad56e06" target="_blank" rel="noopener">golang:ä½¿ç”¨ sort æ¥æ’åº</a></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;sort&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    var m = map[string]int&#123;</span><br><span class="line">        &quot;hello&quot;:         0,</span><br><span class="line">        &quot;morning&quot;:       1,</span><br><span class="line">        &quot;my&quot;:            2,</span><br><span class="line">        &quot;girl&quot;:   3,</span><br><span class="line">    &#125;</span><br><span class="line">    var keys []string</span><br><span class="line">    for k := range m &#123;</span><br><span class="line">        keys = append(keys, k)</span><br><span class="line">    &#125;</span><br><span class="line">    sort.Strings(keys)</span><br><span class="line">    for _, k := range keys &#123;</span><br><span class="line">        fmt.Println(&quot;Key:&quot;, k, &quot;Value:&quot;, m[k])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>å®ç°set</li></ol><p>æ ¹æ®goä¸­mapçš„keysçš„æ— åºæ€§å’Œå”¯ä¸€æ€§ï¼Œå¯ä»¥å°†å…¶ä½œä¸ºset</p><ul><li><a href="https://studygolang.com/articles/3291" target="_blank" rel="noopener">golangå®ç°seté›†åˆ,å˜ç›¸å®ç°åˆ‡ç‰‡å»é‡</a></li></ul><ol><li>å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ï¼‰</li></ol><p>æ ¹æ®Goroutineå’Œchannelçš„è¯»å†™å¯ä»¥å®ç°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ</p><ul><li><a href="https://blog.csdn.net/phpduang/article/details/80143626" target="_blank" rel="noopener">golang channelå¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…å®ä¾‹</a></li></ul><ol><li>å¤§æ–‡ä»¶æ’åº</li></ol><ul><li><a href="https://blog.csdn.net/michellechouu/article/details/47002393" target="_blank" rel="noopener">ã€ç®—æ³•ã€‘å¯¹ä¸€ä¸ª20GBå¤§çš„æ–‡ä»¶æ’åº</a></li></ul><p>64.åŸºæœ¬æ’åºï¼Œå“ªäº›æ˜¯ç¨³å®šçš„</p><p>é€‰æ‹©æ’åºã€å¿«é€Ÿæ’åºã€å¸Œå°”æ’åºã€å †æ’åºä¸æ˜¯ç¨³å®šçš„æ’åºç®—æ³•ï¼Œ</p><p>å†’æ³¡æ’åºã€æ’å…¥æ’åºã€å½’å¹¶æ’åºå’ŒåŸºæ•°æ’åºæ˜¯ç¨³å®šçš„æ’åºç®—æ³•</p><ul><li><a href="https://www.cnblogs.com/codingmylife/archive/2012/10/21/2732980.html" target="_blank" rel="noopener">ç¨³å®šæ’åºå’Œä¸ç¨³å®šæ’åº</a></li></ul><ol><li>Http getè·Ÿhead</li></ol><p>get:è·å–ç”±Request-URIæ ‡è¯†çš„ä»»ä½•ä¿¡æ¯(ä»¥å®ä½“çš„å½¢å¼)ï¼Œå¦‚æœRequest-URIå¼•ç”¨æŸä¸ªæ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œåˆ™åº”è¯¥ä»¥å®ƒäº§ç”Ÿçš„æ•°æ®ä½œä¸ºåœ¨å“åº”ä¸­çš„å®ä½“ï¼Œè€Œä¸æ˜¯è¯¥è¿‡ç¨‹çš„æºä»£ç æ–‡æœ¬ï¼Œé™¤éè¯¥è¿‡ç¨‹ç¢°å·§è¾“å‡ºè¯¥æ–‡æœ¬ã€‚</p><p>head: é™¤äº†æœåŠ¡å™¨ä¸èƒ½åœ¨å“åº”ä¸­è¿”å›æ¶ˆæ¯ä½“ï¼ŒHEADæ–¹æ³•ä¸GETç›¸åŒã€‚ç”¨æ¥è·å–æš—ç¤ºå®ä½“çš„å…ƒä¿¡æ¯ï¼Œè€Œä¸éœ€è¦ä¼ è¾“å®ä½“æœ¬èº«ã€‚å¸¸ç”¨äºæµ‹è¯•è¶…æ–‡æœ¬é“¾æ¥çš„æœ‰æ•ˆæ€§ã€å¯ç”¨æ€§å’Œæœ€è¿‘çš„ä¿®æ”¹ã€‚</p><ul><li><a href="https://github.com/xuelangZF/CS_Offer/blob/master/Network/HTTP.md" target="_blank" rel="noopener">Httpä»‹ç»</a></li></ul><ol><li>Http 401,403</li></ol><p><strong>401 Unauthorized</strong>ï¼š è¯¥HTTPçŠ¶æ€ç è¡¨ç¤ºè®¤è¯é”™è¯¯ï¼Œå®ƒæ˜¯ä¸ºäº†è®¤è¯è®¾è®¡çš„ï¼Œè€Œä¸æ˜¯ä¸ºäº†æˆæƒè®¾è®¡çš„ã€‚æ”¶åˆ°401å“åº”ï¼Œ<strong>è¡¨ç¤ºè¯·æ±‚æ²¡æœ‰è¢«è®¤è¯â€”å‹æ ¹æ²¡æœ‰è®¤è¯æˆ–è€…è®¤è¯ä¸æ­£ç¡®â€”ä½†æ˜¯è¯·é‡æ–°è®¤è¯å’Œé‡è¯•ã€‚</strong>ï¼ˆä¸€èˆ¬åœ¨å“åº”å¤´éƒ¨åŒ…å«ä¸€ä¸ª<em>WWW-Authenticate</em>æ¥æè¿°å¦‚ä½•è®¤è¯ï¼‰ã€‚é€šå¸¸ç”±webæœåŠ¡å™¨è¿”å›ï¼Œè€Œä¸æ˜¯webåº”ç”¨ã€‚ä»æ€§è´¨ä¸Šæ¥è¯´æ˜¯ä¸´æ—¶çš„ä¸œè¥¿ã€‚ï¼ˆæœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯é‡è¯•ï¼‰</p><p><strong>403 Forbidden</strong>ï¼šè¯¥HTTPçŠ¶æ€ç æ˜¯å…³äºæˆæƒæ–¹é¢çš„ã€‚ä»æ€§è´¨ä¸Šæ¥è¯´æ˜¯æ°¸ä¹…çš„ä¸œè¥¿ï¼Œå’Œåº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ç›¸å…³è”ã€‚å®ƒæ¯”401æ›´å…·ä½“ï¼Œæ›´å®é™…ã€‚æ”¶åˆ°403å“åº”è¡¨ç¤º<strong>æœåŠ¡å™¨å®Œæˆè®¤è¯è¿‡ç¨‹ï¼Œä½†æ˜¯å®¢æˆ·ç«¯è¯·æ±‚æ²¡æœ‰æƒé™å»è®¿é—®è¦æ±‚çš„èµ„æºã€‚</strong></p><p>æ€»çš„æ¥è¯´ï¼Œ<strong>401 Unauthorized</strong>å“åº”åº”è¯¥ç”¨æ¥è¡¨ç¤ºç¼ºå¤±æˆ–é”™è¯¯çš„è®¤è¯ï¼›<strong>403 Forbidden</strong>å“åº”åº”è¯¥åœ¨è¿™ä¹‹åç”¨ï¼Œå½“ç”¨æˆ·è¢«è®¤è¯åï¼Œä½†ç”¨æˆ·æ²¡æœ‰è¢«æˆæƒåœ¨ç‰¹å®šèµ„æºä¸Šæ‰§è¡Œæ“ä½œã€‚</p><ul><li><a href="https://www.jianshu.com/p/6dceeebbde5b" target="_blank" rel="noopener">HTTPå“åº”ç 403 Forbiddenå’Œ401 Unauthorizedå¯¹æ¯”</a></li></ul><p>67.Http keep-alive</p><ol><li>Httpèƒ½ä¸èƒ½ä¸€æ¬¡è¿æ¥å¤šæ¬¡è¯·æ±‚ï¼Œä¸ç­‰åç«¯è¿”å›</li><li>TCP å’Œ UDP æœ‰ä»€ä¹ˆåŒºåˆ«,é€‚ç”¨åœºæ™¯</li></ol><ul><li>TCP æ˜¯é¢å‘è¿æ¥çš„ï¼ŒUDP æ˜¯é¢å‘æ— è¿æ¥çš„ï¼›æ•… TCP éœ€è¦å»ºç«‹è¿æ¥å’Œæ–­å¼€è¿æ¥ï¼ŒUDP ä¸éœ€è¦ã€‚</li><li>TCP æ˜¯æµåè®®ï¼ŒUDP æ˜¯æ•°æ®åŒ…åè®®ï¼›æ•… TCP æ•°æ®æ²¡æœ‰å¤§å°é™åˆ¶ï¼ŒUDP æ•°æ®æŠ¥æœ‰å¤§å°é™åˆ¶ï¼ˆUDP åè®®æœ¬èº«é™åˆ¶ã€æ•°æ®é“¾è·¯å±‚çš„ MTUã€ç¼“å­˜åŒºå¤§å°ï¼‰ã€‚</li><li>TCP æ˜¯å¯é åè®®ï¼ŒUDP æ˜¯ä¸å¯é åè®®ï¼›æ•… TCP ä¼šå¤„ç†æ•°æ®ä¸¢åŒ…é‡å‘ä»¥åŠä¹±åºç­‰æƒ…å†µï¼ŒUDP åˆ™ä¸ä¼šå¤„ç†ã€‚</li></ul><p><code>UDP çš„ç‰¹ç‚¹åŠä½¿ç”¨åœºæ™¯</code>:</p><p>UDP ä¸æä¾›å¤æ‚çš„æ§åˆ¶æœºåˆ¶ï¼Œåˆ©ç”¨ IP æä¾›é¢å‘æ— è¿æ¥çš„é€šä¿¡æœåŠ¡ï¼Œéšæ—¶éƒ½å¯ä»¥å‘é€æ•°æ®ï¼Œå¤„ç†ç®€å•ä¸”é«˜æ•ˆï¼Œç»å¸¸ç”¨äºä»¥ä¸‹åœºæ™¯ï¼š</p><p>åŒ…æ€»é‡è¾ƒå°çš„é€šä¿¡ï¼ˆDNSã€SNMPï¼‰</p><p>è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šåª’ä½“é€šä¿¡ï¼ˆå³æ—¶é€šä¿¡ï¼‰</p><p>å¹¿æ’­é€šä¿¡</p><p><code>TCP çš„ç‰¹ç‚¹åŠä½¿ç”¨åœºæ™¯</code>:</p><p>ç›¸å¯¹äº UDPï¼ŒTCP å®ç°äº†æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­çš„å„ç§æ§åˆ¶ï¼Œå¯ä»¥è¿›è¡Œä¸¢åŒ…æ—¶çš„é‡å‘æ§åˆ¶ï¼Œè¿˜å¯ä»¥å¯¹æ¬¡åºä¹±æ‰çš„åˆ†åŒ…è¿›è¡Œé¡ºåºæ§åˆ¶ã€‚</p><p>åœ¨å¯¹å¯é æ€§è¦æ±‚è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ TCPï¼Œå³ä¸è€ƒè™‘ UDP çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥é€‰æ‹© TCPã€‚</p><ul><li><a href="https://mp.weixin.qq.com/s/jLkhjM7wOpZuWgJdAXis1A" target="_blank" rel="noopener">iOS é¢è¯•é¢˜ TCP UDP æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸTCP ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ</a></li></ul><ol><li>time-waitçš„ä½œç”¨</li></ol><ul><li><a href="https://www.iteblog.com/archives/169.html" target="_blank" rel="noopener">TCP/IPçŠ¶æ€å›¾çš„TIME_WAITä½œç”¨</a></li></ul><ol><li>æ•°æ®åº“å¦‚ä½•å»ºç´¢å¼•</li></ol><ul><li><a href="https://blog.csdn.net/nanaMasuda/article/details/52358114" target="_blank" rel="noopener">æ­£ç¡®åˆç†çš„å»ºç«‹MySQLæ•°æ®åº“ç´¢å¼•</a></li></ul><ol><li>å­¤å„¿è¿›ç¨‹ï¼Œåƒµå°¸è¿›ç¨‹</li></ol><ul><li>å­¤å„¿è¿›ç¨‹ï¼šä¸€ä¸ªçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢«initè¿›ç¨‹(è¿›ç¨‹å·ä¸º1)æ‰€æ”¶å…»ï¼Œå¹¶ç”±initè¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚</li><li>åƒµå°¸è¿›ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨waitæˆ–waitpidè·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ã€‚è¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµæ­»è¿›ç¨‹ã€‚</li></ul><ol><li>æ­»é”æ¡ä»¶ï¼Œå¦‚ä½•é¿å…</li><li>linuxå‘½ä»¤ï¼ŒæŸ¥çœ‹ç«¯å£å ç”¨ï¼Œcpuè´Ÿè½½ï¼Œå†…å­˜å ç”¨ï¼Œå¦‚ä½•å‘é€ä¿¡å·ç»™ä¸€ä¸ªè¿›ç¨‹</li><li>gitæ–‡ä»¶ç‰ˆæœ¬ï¼Œä½¿ç”¨é¡ºåºï¼Œmergeè·Ÿrebase</li><li>é€šå¸¸ä¸€èˆ¬ä¼šç”¨åˆ°å“ªäº›æ•°æ®ç»“æ„?</li><li>é“¾è¡¨å’Œæ•°ç»„ç›¸æ¯”, æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹?</li><li>å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªæ— ç¯å•é“¾è¡¨æœ‰æ²¡æœ‰äº¤å‰ç‚¹?</li><li>å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå•é“¾è¡¨æœ‰æ²¡æœ‰ç¯, å¹¶æ‰¾å‡ºå…¥ç¯ç‚¹?</li><li>æè¿°ä¸€ä¸‹ TCP å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹ä¸­</li><li>TCP æœ‰å“ªäº›çŠ¶æ€?</li><li>TCP çš„ LISTEN çŠ¶æ€æ˜¯ä»€ä¹ˆ?</li><li>TCP çš„ CLOSE_WAIT çŠ¶æ€æ˜¯ä»€ä¹ˆ?</li><li>å»ºç«‹ä¸€ä¸ª socket è¿æ¥è¦ç»è¿‡å“ªäº›æ­¥éª¤?</li><li>å¸¸è§çš„ HTTP çŠ¶æ€ç æœ‰å“ªäº›?</li><li>301å’Œ302æœ‰ä»€ä¹ˆåŒºåˆ«?</li><li>504å’Œ500æœ‰ä»€ä¹ˆåŒºåˆ«?</li><li>HTTPS å’Œ HTTP æœ‰ä»€ä¹ˆåŒºåˆ«?</li><li>ç®—æ³•é¢˜: æ‰‹å†™ä¸€ä¸ªå¿«é€Ÿæ’åº</li></ol><p>å¿«é€Ÿæ’åº:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">var arr = []int&#123;19,8,16,15,23,34,6,3,1,0,2,9,7&#125;</span><br><span class="line">quickAscendingSort(arr, 0, len(arr)-1)</span><br><span class="line">fmt.Println(&quot;quickAscendingSort:&quot;,arr)</span><br><span class="line"></span><br><span class="line">quickDescendingSort(arr, 0, len(arr)-1)</span><br><span class="line">fmt.Println(&quot;quickDescendingSort:&quot;,arr)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//å‡åº</span><br><span class="line">func quickAscendingSort(arr []int, start, end int) &#123;</span><br><span class="line">if (start &lt; end) &#123;</span><br><span class="line">i, j := start, end</span><br><span class="line">key := arr[(start + end)/2]</span><br><span class="line">for i &lt;= j &#123;</span><br><span class="line">for arr[i] &lt; key &#123;</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line">for arr[j] &gt; key &#123;</span><br><span class="line">j--</span><br><span class="line">&#125;</span><br><span class="line">if i &lt;= j &#123;</span><br><span class="line">arr[i], arr[j] = arr[j], arr[i]</span><br><span class="line">i++</span><br><span class="line">j--</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if start &lt; j &#123;</span><br><span class="line">quickAscendingSort(arr, start, j)</span><br><span class="line">&#125;</span><br><span class="line">if end &gt; i &#123;</span><br><span class="line">quickAscendingSort(arr, i, end)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//é™åº</span><br><span class="line">func quickDescendingSort(arr []int, start, end int) &#123;</span><br><span class="line">if (start &lt; end) &#123;</span><br><span class="line">i, j := start, end</span><br><span class="line">key := arr[(start + end)/2]</span><br><span class="line">for i &lt;= j &#123;</span><br><span class="line">for arr[i] &gt; key &#123;</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line">for arr[j] &lt; key &#123;</span><br><span class="line">j--</span><br><span class="line">&#125;</span><br><span class="line">if i &lt;= j &#123;</span><br><span class="line">arr[i], arr[j] = arr[j], arr[i]</span><br><span class="line">i++</span><br><span class="line">j--</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if start &lt; j &#123;</span><br><span class="line">quickDescendingSort(arr, start, j)</span><br><span class="line">&#125;</span><br><span class="line">if end &gt; i &#123;</span><br><span class="line">quickDescendingSort(arr, i, end)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>Golang é‡Œçš„é€ƒé€¸åˆ†ææ˜¯ä»€ä¹ˆï¼Ÿæ€ä¹ˆé¿å…å†…å­˜é€ƒé€¸ï¼Ÿ</li><li>é…ç½®ä¸­å¿ƒå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ</li><li>Golang çš„GCè§¦å‘æ—¶æœºæ˜¯ä»€ä¹ˆ?</li><li>Redis é‡Œæ•°æ®ç»“æ„çš„å®ç°ç†Ÿæ‚‰å—?</li><li>Etcdçš„Raftä¸€è‡´æ€§ç®—æ³•åŸç†?</li><li>å¾®æœåŠ¡æ¦‚å¿µ.</li><li>SLBåŸç†.</li><li>åˆ†å¸ƒå¼ä¸€ç›´æ€§åŸåˆ™.</li><li>å¦‚ä½•ä¿è¯æœåŠ¡å®•æœºé€ æˆçš„åˆ†å¸ƒå¼æœåŠ¡èŠ‚ç‚¹å¤„ç†é—®é¢˜?</li><li>æœåŠ¡å‘ç°æ€ä¹ˆå®ç°çš„.</li><li>Goä¸­åˆ‡ç‰‡ï¼Œmapï¼Œstruct åœ¨64ä½æœºå™¨ä¸­å ç”¨å­—èŠ‚æ˜¯å¤šå°‘?</li></ol><p>åœ¨64ä½ç³»ç»Ÿä¸‹ï¼ŒGolangçš„åˆ‡ç‰‡å ç”¨å­—èŠ‚æ˜¯24ä½ï¼Œmapå’Œstructéƒ½æ˜¯8ä½.</p><ol><li>Goä¸­çš„deferå‡½æ•°ä½¿ç”¨ä¸‹é¢çš„ä¸¤ç§æƒ…å†µä¸‹ç»“æœæ˜¯å¤šå°‘ï¼Œä¸ºä»€ä¹ˆ?</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">a := 1</span><br><span class="line">defer fmt.Println(&quot;the value of a1:&quot;,a)</span><br><span class="line">a++</span><br><span class="line"></span><br><span class="line">defer func() &#123;</span><br><span class="line">fmt.Println(&quot;the value of a2:&quot;,a)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>è¿è¡Œ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">the value of a1: 1</span><br><span class="line">the value of a1: 2</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ç§æƒ…å†µï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">defer fmt.Println(&quot;the value of a1:&quot;,a)</span><br></pre></td></tr></table></figure><p>deferå»¶è¿Ÿå‡½æ•°è°ƒç”¨çš„fmt.Println(a)å‡½æ•°çš„å‚æ•°å€¼åœ¨deferè¯­å¥å‡ºç°æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥æ— è®ºåé¢å¦‚ä½•ä¿®æ”¹aå˜é‡éƒ½ä¸ä¼šå½±å“å»¶è¿Ÿå‡½æ•°ã€‚</p><p>ç¬¬äºŒç§æƒ…å†µ:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">defer func() &#123;</span><br><span class="line">fmt.Println(&quot;the value of a2:&quot;,a)</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>deferå»¶è¿Ÿå‡½æ•°è°ƒç”¨çš„å‡½æ•°å‚æ•°çš„å€¼åœ¨deferå®šä¹‰æ—¶å€™å°±ç¡®å®šäº†ï¼Œè€Œdeferå»¶è¿Ÿå‡½æ•°å†…éƒ¨æ‰€ä½¿ç”¨çš„å€¼éœ€è¦åœ¨è¿™ä¸ªå‡½æ•°è¿è¡Œæ—¶å€™æ‰ç¡®å®šã€‚</p><h4 id="Golangé¢è¯•å‚è€ƒ"><a href="#Golangé¢è¯•å‚è€ƒ" class="headerlink" title="Golangé¢è¯•å‚è€ƒ"></a>Golangé¢è¯•å‚è€ƒ</h4><ul><li><a href="http://m.nowcoder.com/discuss/145338?type=2&amp;order=0&amp;pos=6&amp;page=1&amp;headNav=www&amp;from=singlemessage&amp;isappinstalled=0" target="_blank" rel="noopener">Golangé¢è¯•</a></li><li><a href="http://morsmachine.dk/go-scheduler" target="_blank" rel="noopener">Golangè°ƒåº¦</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      golangé¢è¯•é—®é¢˜æ±‡æ€»
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>mongodb å‘½ä»¤è¡Œç™»å½•æ“ä½œ</title>
    <link href="https://cloudsjhan.github.io/2019/04/11/mongodb-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C/"/>
    <id>https://cloudsjhan.github.io/2019/04/11/mongodb-å‘½ä»¤è¡Œç™»å½•æ“ä½œ/</id>
    <published>2019-04-11T07:07:14.000Z</published>
    <updated>2019-04-22T02:55:05.331Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h2 id="Mac-OSä¸‹è½½å®‰è£…åŠé…ç½®"><a href="#Mac-OSä¸‹è½½å®‰è£…åŠé…ç½®" class="headerlink" title="Mac OSä¸‹è½½å®‰è£…åŠé…ç½®"></a>Mac OSä¸‹è½½å®‰è£…åŠé…ç½®</h2><p>ä½¿ç”¨brewå¯ä»¥ç›´æ¥æå®šï¼Œç®€å•æ–¹ä¾¿ï¼</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mongodb</span><br></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåä¼šæç¤ºå¯åŠ¨çš„æ–¹å¼ï¼Œå®‰è£…ä½ç½®ç­‰ç­‰ä¿¡æ¯ã€‚</p><p><img src="https:////upload-images.jianshu.io/upload_images/4218662-435c85a12eae4a61.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/958/format/webp" alt="img"></p><p>å®‰è£…å®Œæˆ</p><p>å®‰è£…å®Œæˆåï¼ŒæŒ‰ç…§æç¤ºå¯åŠ¨MongoDBï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --config /usr/local/etc/mongod.conf</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶å·²ä¿®æ”¹fork=trueï¼Œå› æ­¤å¯åŠ¨åå°†ä»¥åå°è¿›ç¨‹æ–¹å¼å­˜åœ¨ã€‚</p><p><img src="https:////upload-images.jianshu.io/upload_images/4218662-7842d5837475c137.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="img"></p><p>MongoDBå¯åŠ¨</p><p>ç»ˆç«¯è¾“å…¥mongoè¿æ¥MongoDBæ•°æ®åº“(é»˜è®¤è¿æ¥æœ¬æœºçš„27017ç«¯å£)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo</span><br></pre></td></tr></table></figure><p><img src="https:////upload-images.jianshu.io/upload_images/4218662-8f368a1234b354cf.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1000/format/webp" alt="img"></p><p>å®¢æˆ·ç«¯è¿æ¥</p><h2 id="é…ç½®æ–‡ä»¶"><a href="#é…ç½®æ–‡ä»¶" class="headerlink" title="é…ç½®æ–‡ä»¶"></a>é…ç½®æ–‡ä»¶</h2><p>MongoDBå¼•å…¥ä¸€ä¸ªYAML-basedæ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚<br> ç°åœ¨çš„é…ç½®æ–‡ä»¶/usr/local/etc/mongod.confæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># æ—¥å¿—</span><br><span class="line">systemLog:</span><br><span class="line"># æ—¥å¿—ä¸ºæ–‡ä»¶</span><br><span class="line">  destination: file</span><br><span class="line"># æ–‡ä»¶ä½ç½®</span><br><span class="line">  path: /usr/local/var/log/mongodb/mongo.log</span><br><span class="line"># æ˜¯å¦è¿½åŠ </span><br><span class="line">  logAppend: true</span><br><span class="line">#è¿›ç¨‹</span><br><span class="line">processManagement:</span><br><span class="line"># å®ˆæŠ¤è¿›ç¨‹æ–¹å¼</span><br><span class="line">  fork: true</span><br><span class="line">storage:</span><br><span class="line">  dbPath: /usr/local/var/mongodb</span><br><span class="line">net:</span><br><span class="line"># ç»‘å®šIPï¼Œé»˜è®¤127.0.0.1ï¼Œåªèƒ½æœ¬æœºè®¿é—®</span><br><span class="line">  bindIp: 127.0.0.1</span><br><span class="line"># ç«¯å£</span><br><span class="line">  port: 27017</span><br></pre></td></tr></table></figure><h2 id="CentOS-7-å®‰è£…MongoDBè¯¦ç»†æ­¥éª¤"><a href="#CentOS-7-å®‰è£…MongoDBè¯¦ç»†æ­¥éª¤" class="headerlink" title="CentOS 7 å®‰è£…MongoDBè¯¦ç»†æ­¥éª¤"></a><a href="https://segmentfault.com/a/1190000016877915" target="_blank" rel="noopener">CentOS 7 å®‰è£…MongoDBè¯¦ç»†æ­¥éª¤</a></h2><p>åˆ›å»º<code>/etc/yum.repos.d/mongodb-org-4.0.repo</code>æ–‡ä»¶ï¼Œç¼–è¾‘å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[mongodb-org-4.0]</span><br><span class="line">name=MongoDB Repository</span><br><span class="line">baseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/</span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc</span><br></pre></td></tr></table></figure><p>è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…æœ€æ–°ç‰ˆçš„mongodbï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install -y mongodb-org</span><br></pre></td></tr></table></figure><p>é…ç½®<code>mongod.conf</code>å…è®¸è¿œç¨‹è¿æ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/mongod.conf</span><br><span class="line"></span><br><span class="line"># Listen to all ip address</span><br><span class="line">bind_ip = 0.0.0.0</span><br></pre></td></tr></table></figure><p>å¯åŠ¨mongodbï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mongod start</span><br></pre></td></tr></table></figure><p>åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ mongo</span><br><span class="line">&gt;use admin</span><br><span class="line"> db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: &quot;myUserAdmin&quot;,</span><br><span class="line">    pwd: &quot;abc123&quot;,</span><br><span class="line">    roles: [ &#123; role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; &#125;, &quot;readWriteAnyDatabase&quot; ]</span><br><span class="line">  &#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure><p>å¯ç”¨æƒé™ç®¡ç†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ vim /etc/mongod.conf</span><br><span class="line"></span><br><span class="line">#security </span><br><span class="line">security:</span><br><span class="line">  authorization: enabled</span><br></pre></td></tr></table></figure><p>é‡å¯mongodbï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo service mongod restart</span><br></pre></td></tr></table></figure><h3 id="Mongodb-ç”¨æˆ·éªŒè¯ç™»é™†"><a href="#Mongodb-ç”¨æˆ·éªŒè¯ç™»é™†" class="headerlink" title="Mongodb ç”¨æˆ·éªŒè¯ç™»é™†"></a>Mongodb ç”¨æˆ·éªŒè¯ç™»é™†</h3><p>å¯åŠ¨å¸¦è®¿é—®æ§åˆ¶çš„ Mongodb<br> æ–°å»ºç»ˆç«¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --auth --port 27017 --dbpath /data/db1</span><br></pre></td></tr></table></figure><p>ç°åœ¨æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œç”¨æˆ·èº«ä»½çš„éªŒè¯<br> ç¬¬ä¸€ç§ ï¼ˆç±»ä¼¼ MySqlï¼‰<br> å®¢æˆ·ç«¯è¿æ¥æ—¶ï¼ŒæŒ‡å®šç”¨æˆ·åï¼Œå¯†ç ï¼Œdbåç§°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27017 -u &quot;adminUser&quot; -p &quot;adminPass&quot; --authenticationDatabase &quot;admin&quot;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§<br> å®¢æˆ·ç«¯è¿æ¥åï¼Œå†è¿›è¡ŒéªŒè¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mongo --port 27017</span><br><span class="line"></span><br><span class="line">use admin</span><br><span class="line">db.auth(&quot;adminUser&quot;, &quot;adminPass&quot;)</span><br><span class="line"></span><br><span class="line">// è¾“å‡º 1 è¡¨ç¤ºéªŒè¯æˆåŠŸ</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºæ™®é€šç”¨æˆ·"><a href="#åˆ›å»ºæ™®é€šç”¨æˆ·" class="headerlink" title="åˆ›å»ºæ™®é€šç”¨æˆ·"></a>åˆ›å»ºæ™®é€šç”¨æˆ·</h3><p>è¿‡ç¨‹ç±»ä¼¼åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼Œåªæ˜¯ role æœ‰æ‰€ä¸åŒ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use foo</span><br><span class="line"></span><br><span class="line">db.createUser(</span><br><span class="line">  &#123;</span><br><span class="line">    user: &quot;simpleUser&quot;,</span><br><span class="line">    pwd: &quot;simplePass&quot;,</span><br><span class="line">    roles: [ &#123; role: &quot;readWrite&quot;, db: &quot;foo&quot; &#125;,</span><br><span class="line">             &#123; role: &quot;read&quot;, db: &quot;bar&quot; &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ™®é€šç”¨æˆ·<br> ç”¨æˆ·åï¼šsimpleUser<br> å¯†ç ï¼šsimplePass<br> æƒé™ï¼šè¯»å†™æ•°æ®åº“ fooï¼Œ åªè¯»æ•°æ®åº“ barã€‚</p><p><strong>æ³¨æ„</strong><br> <strong>NOTE</strong><br> <strong>WARN</strong><br> <code>use foo</code>è¡¨ç¤ºç”¨æˆ·åœ¨ foo åº“ä¸­åˆ›å»ºï¼Œå°±ä¸€å®šè¦ foo åº“éªŒè¯èº«ä»½ï¼Œå³ç”¨æˆ·çš„ä¿¡æ¯è·Ÿéšéšæ•°æ®åº“ã€‚æ¯”å¦‚ä¸Šè¿° simpleUser è™½ç„¶æœ‰ bar åº“çš„è¯»å–æƒé™ï¼Œä½†æ˜¯ä¸€å®šè¦å…ˆåœ¨ foo åº“è¿›è¡Œèº«ä»½éªŒè¯ï¼Œç›´æ¥è®¿é—®ä¼šæç¤ºéªŒè¯å¤±è´¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use foo</span><br><span class="line">db.auth(&quot;simpleUser&quot;, &quot;simplePass&quot;)</span><br><span class="line"></span><br><span class="line">use bar</span><br><span class="line">show collections</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æœ admin åº“æ²¡æœ‰ä»»ä½•ç”¨æˆ·çš„è¯ï¼Œå³ä½¿åœ¨å…¶ä»–æ•°æ®åº“ä¸­åˆ›å»ºäº†ç”¨æˆ·ï¼Œå¯ç”¨èº«ä»½éªŒè¯ï¼Œé»˜è®¤çš„è¿æ¥æ–¹å¼ä¾ç„¶ä¼šæœ‰è¶…çº§æƒé™</p><hr>]]></content>
    
    <summary type="html">
    
      mongodb å‘½ä»¤è¡Œç™»å½•æ“ä½œ
    
    </summary>
    
      <category term="MongoDB" scheme="https://cloudsjhan.github.io/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="https://cloudsjhan.github.io/tags/MongoDB/"/>
    
  </entry>
  
  <entry>
    <title>Scrapy è§£å†³URLè¢«é‡å®šå‘æ— æ³•æŠ“å–åˆ°æ•°æ®é—®é¢˜301å’Œ302</title>
    <link href="https://cloudsjhan.github.io/2019/04/10/Scrapy-%E8%A7%A3%E5%86%B3URL%E8%A2%AB%E9%87%8D%E5%AE%9A%E5%90%91%E6%97%A0%E6%B3%95%E6%8A%93%E5%8F%96%E5%88%B0%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98301%E5%92%8C302/"/>
    <id>https://cloudsjhan.github.io/2019/04/10/Scrapy-è§£å†³URLè¢«é‡å®šå‘æ— æ³•æŠ“å–åˆ°æ•°æ®é—®é¢˜301å’Œ302/</id>
    <published>2019-04-10T08:48:20.000Z</published>
    <updated>2019-04-10T08:50:53.627Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>1.ä»€ä¹ˆæ˜¯çŠ¶æ€ç 301,302</p><p>301 Moved Permanentlyï¼ˆæ°¸ä¹…é‡å®šå‘ï¼‰ è¢«è¯·æ±‚çš„èµ„æºå·²æ°¸ä¹…ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼Œå¹¶ä¸”å°†æ¥ä»»ä½•å¯¹æ­¤èµ„æºçš„å¼•ç”¨éƒ½åº”è¯¥ä½¿ç”¨æœ¬å“åº”è¿”å›çš„è‹¥å¹²ä¸ªURIä¹‹ä¸€ã€‚</p><p>è§£å†³ï¼ˆä¸€ï¼‰</p><p>1.åœ¨Requestä¸­å°†scrapyçš„dont_filter=Trueï¼Œå› ä¸ºscrapyæ˜¯é»˜è®¤è¿‡æ»¤æ‰é‡å¤çš„è¯·æ±‚URLï¼Œæ·»åŠ ä¸Šå‚æ•°ä¹‹åå³ä½¿è¢«é‡å®šå‘äº†ä¹Ÿèƒ½è¯·æ±‚åˆ°æ­£å¸¸çš„æ•°æ®äº†</p><h2 id="example"><a href="#example" class="headerlink" title="example"></a>example</h2><p>Request(url, callback=self.next_parse, dont_filter=True)<br>è§£å†³ï¼ˆäºŒï¼‰</p><p>åœ¨scrapyæ¡†æ¶ä¸­çš„ settings.pyæ–‡ä»¶é‡Œæ·»åŠ </p><p>HTTPERROR_ALLOWED_CODES = [301]<br>è§£å†³ï¼ˆä¸‰ï¼‰</p><p>ä½¿ç”¨requestsæ¨¡å—é‡åˆ°301å’Œ302é—®é¢˜æ—¶</p><p>def website():<br>    â€˜urlâ€™<br>    headers = {â€˜Acceptâ€™:     â€˜text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8â€™,<br>           â€˜Accept-Encodingâ€™: â€˜gzip, deflate, sdch, brâ€™,<br>           â€˜Accept-Languageâ€™: â€˜zh-CN,zh;q=0.8â€™,<br>           â€˜Connectionâ€™: â€˜keep-aliveâ€™,<br>           â€˜Hostâ€™: â€˜pan.baidu.comâ€™,<br>           â€˜Upgrade-Insecure-Requestsâ€™: â€˜1â€™,<br>           â€˜User-Agentâ€™: â€˜Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36â€™}</p><pre><code>url = &apos;https://www.baidu.com/&apos;html = requests.get(url, headers=headers, allow_redirects=False)return html.headers[&apos;Location&apos;]</code></pre><p>allow_redirects=Falseçš„æ„ä¹‰ä¸ºæ‹’ç»é»˜è®¤çš„301/302é‡å®šå‘ä»è€Œå¯ä»¥é€šè¿‡html.headers[â€˜Locationâ€™]æ‹¿åˆ°é‡å®šå‘çš„URLã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      Scrapy è§£å†³URLè¢«é‡å®šå‘æ— æ³•æŠ“å–åˆ°æ•°æ®é—®é¢˜301å’Œ302
    
    </summary>
    
      <category term="Scrapy" scheme="https://cloudsjhan.github.io/categories/Scrapy/"/>
    
    
      <category term="Scrapy" scheme="https://cloudsjhan.github.io/tags/Scrapy/"/>
    
  </entry>
  
  <entry>
    <title>scrapy æºç åˆ†æä¹‹retryä¸­é—´ä»¶ä¸åº”ç”¨</title>
    <link href="https://cloudsjhan.github.io/2019/03/29/scrapy-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bretry%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    <id>https://cloudsjhan.github.io/2019/03/29/scrapy-æºç åˆ†æä¹‹retryä¸­é—´ä»¶/</id>
    <published>2019-03-29T11:33:40.000Z</published>
    <updated>2019-03-29T13:57:34.558Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p><code>è¿™æ¬¡è®©æˆ‘ä»¬åˆ†æscrapyé‡è¯•æœºåˆ¶çš„æºç ï¼Œå­¦ä¹ å…¶ä¸­çš„æ€æƒ³ï¼Œç¼–å†™å®šåˆ¶åŒ–middleware,æ•æ‰çˆ¬å–å¤±è´¥çš„URLç­‰ä¿¡æ¯ã€‚</code></p><h2 id="scrapyç®€ä»‹"><a href="#scrapyç®€ä»‹" class="headerlink" title="scrapyç®€ä»‹"></a>scrapyç®€ä»‹</h2><p>Scrapyæ˜¯ä¸€ä¸ªä¸ºäº†çˆ¬å–ç½‘ç«™æ•°æ®ï¼Œæå–ç»“æ„æ€§æ•°æ®è€Œç¼–å†™çš„åº”ç”¨æ¡†æ¶ã€‚ å¯ä»¥åº”ç”¨åœ¨åŒ…æ‹¬æ•°æ®æŒ–æ˜ï¼Œä¿¡æ¯å¤„ç†æˆ–å­˜å‚¨å†å²æ•°æ®ç­‰ä¸€ç³»åˆ—çš„ç¨‹åºä¸­ã€‚</p><p>å…¶æœ€åˆæ˜¯ä¸ºäº† <a href="http://en.wikipedia.org/wiki/Screen_scraping" target="_blank" rel="noopener">é¡µé¢æŠ“å–</a> (æ›´ç¡®åˆ‡æ¥è¯´, <a href="http://en.wikipedia.org/wiki/Web_scraping" target="_blank" rel="noopener">ç½‘ç»œæŠ“å–</a> )æ‰€è®¾è®¡çš„ï¼Œ ä¹Ÿå¯ä»¥åº”ç”¨åœ¨è·å–APIæ‰€è¿”å›çš„æ•°æ®(ä¾‹å¦‚ <a href="http://aws.amazon.com/associates/" target="_blank" rel="noopener">Amazon Associates Web Services</a> ) æˆ–è€…é€šç”¨çš„ç½‘ç»œçˆ¬è™«ã€‚</p><p>ä¸€å¼ å›¾å¯çœ‹æ¸…æ¥šscrapyä¸­æ•°æ®çš„æµå‘ï¼š</p><p><img src="https://scrapy-chs.readthedocs.io/zh_CN/0.24/_images/scrapy_architecture.png" alt=""></p><p>ç®€å•äº†è§£ä¸€ä¸‹å„ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½ï¼Œå¯ä»¥çœ‹ä¸‹é¢ç®€åŒ–ç‰ˆæ•°æ®æµï¼š</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1jwn7d37aj30tg0iy0v1.jpg" alt=""></p><h2 id="æ€»æœ‰æ¼ç½‘ä¹‹é±¼"><a href="#æ€»æœ‰æ¼ç½‘ä¹‹é±¼" class="headerlink" title="æ€»æœ‰æ¼ç½‘ä¹‹é±¼"></a>æ€»æœ‰æ¼ç½‘ä¹‹é±¼</h2><p>ä¸ç®¡ä½ çš„ä¸»æœºé…ç½®å¤šä¹ˆåŠç‚¸å¤©ï¼Œè¿˜æ˜¯ç½‘é€Ÿå¤šä¹ˆç»™åŠ›ï¼Œåœ¨scrapyçš„å¤§è§„æ¨¡ä»»åŠ¡ä¸­ï¼Œæœ€ç»ˆçˆ¬å–çš„itemæ•°é‡éƒ½ä¸ä¼šç­‰äºæœŸæœ›çˆ¬å–çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ€»æœ‰é‚£ä¹ˆä¸€äº›çˆ¬å–å¤±è´¥çš„æ¼ç½‘ä¹‹é±¼ï¼Œé€šè¿‡åˆ†æscrapyçš„æ—¥å¿—ï¼Œå¯ä»¥çŸ¥é“é€ æˆå¤±è´¥çš„åŸå› æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š</p><ol><li>exception_count</li><li>httperror</li></ol><p><img src="https://ws1.sinaimg.cn/large/006tKfTcgy1g1jyf6bmcfj314w0kqq97.jpg" alt=""></p><p>ä»¥ä¸Šçš„ä¸ç®¡æ˜¯exceptionè¿˜æ˜¯httperror, scrapyä¸­éƒ½æœ‰å¯¹åº”çš„retryæœºåˆ¶ï¼Œåœ¨<code>settings.py</code>æ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥è®¾ç½®æœ‰å…³é‡è¯•çš„å‚æ•°ï¼Œç­‰è¿è¡Œé‡åˆ°å¼‚å¸¸å’Œé”™è¯¯æ—¶å€™ï¼Œscrapyå°±ä¼šè‡ªåŠ¨å¤„ç†è¿™äº›é—®é¢˜ï¼Œå…¶ä¸­æœ€å…³é”®çš„éƒ¨åˆ†å°±æ˜¯é‡è¯•ä¸­é—´ä»¶ï¼Œä¸‹é¢è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹scrapyçš„retry middlewareã€‚</p><h2 id="RetryMiddleæºç åˆ†æ"><a href="#RetryMiddleæºç åˆ†æ" class="headerlink" title="RetryMiddleæºç åˆ†æ"></a>RetryMiddleæºç åˆ†æ</h2><p>åœ¨scrapyé¡¹ç›®çš„<code>middlewares.py</code>æ–‡ä»¶ä¸­ æ•²å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scrapy.downloadermiddlewares.retry <span class="keyword">import</span> RetryMiddleware</span><br></pre></td></tr></table></figure><p>æŒ‰ä½ctrlé”®ï¼ˆMacæ˜¯commandé”®ï¼‰ï¼Œé¼ æ ‡å·¦é”®ç‚¹å‡»RetryMiddlewareè¿›å…¥è¯¥ä¸­é—´ä»¶æ‰€åœ¨çš„é¡¹ç›®æ–‡ä»¶çš„ä½ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹æ–‡ä»¶çš„å½¢å¼æ‰¾åˆ°è¯¥è¯¥ä¸­é—´ä»¶çš„ä½ç½®ï¼Œè·¯å¾„æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">site-packages/scrapy/downloadermiddlewares/retry.RetryMiddleware</span><br></pre></td></tr></table></figure><p>æºç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RetryMiddleware</span><span class="params">(object)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># IOError is raised by the HttpCompression middleware when trying to</span></span><br><span class="line">    <span class="comment"># decompress an empty response</span></span><br><span class="line">    <span class="comment"># éœ€è¦é‡è¯•çš„å¼‚å¸¸çŠ¶æ€ï¼Œå¯ä»¥çœ‹å‡ºï¼Œå…¶ä¸­æœ‰äº›æ˜¯ä¸Šé¢logä¸­çš„å¼‚å¸¸</span></span><br><span class="line">    EXCEPTIONS_TO_RETRY = (defer.TimeoutError, TimeoutError, DNSLookupError,</span><br><span class="line">                           ConnectionRefusedError, ConnectionDone, ConnectError,</span><br><span class="line">                           ConnectionLost, TCPTimedOutError, ResponseFailed,</span><br><span class="line">                           IOError, TunnelError)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, settings)</span>:</span></span><br><span class="line">      <span class="comment"># è¯»å– settings.py ä¸­å…³äºé‡è¯•çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æœæ²¡æœ‰é…ç½®é‡è¯•çš„è¯ï¼Œç›´æ¥è·³è¿‡</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> settings.getbool(<span class="string">'RETRY_ENABLED'</span>):</span><br><span class="line">            <span class="keyword">raise</span> NotConfigured</span><br><span class="line">        self.max_retry_times = settings.getint(<span class="string">'RETRY_TIMES'</span>)</span><br><span class="line">        self.retry_http_codes = set(int(x) <span class="keyword">for</span> x <span class="keyword">in</span> settings.getlist(<span class="string">'RETRY_HTTP_CODES'</span>))</span><br><span class="line">        self.priority_adjust = settings.getint(<span class="string">'RETRY_PRIORITY_ADJUST'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">from_crawler</span><span class="params">(cls, crawler)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls(crawler.settings)</span><br><span class="line"><span class="comment"># å¦‚æœresponseçš„çŠ¶æ€ç ï¼Œæ˜¯æˆ‘ä»¬è¦é‡è¯•çš„</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.meta.get(<span class="string">'dont_retry'</span>, <span class="keyword">False</span>):</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">if</span> response.status <span class="keyword">in</span> self.retry_http_codes:</span><br><span class="line">            reason = response_status_message(response.status)</span><br><span class="line">            <span class="keyword">return</span> self._retry(request, reason, spider) <span class="keyword">or</span> response</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"><span class="comment"># å‡ºç°äº†éœ€è¦é‡è¯•çš„å¼‚å¸¸çŠ¶æ€ï¼Œ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(exception, self.EXCEPTIONS_TO_RETRY) \</span><br><span class="line">                <span class="keyword">and</span> <span class="keyword">not</span> request.meta.get(<span class="string">'dont_retry'</span>, <span class="keyword">False</span>):</span><br><span class="line">            <span class="keyword">return</span> self._retry(request, exception, spider)</span><br><span class="line"><span class="comment"># é‡è¯•æ“ä½œ</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_retry</span><span class="params">(self, request, reason, spider)</span>:</span></span><br><span class="line">        retries = request.meta.get(<span class="string">'retry_times'</span>, <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        retry_times = self.max_retry_times</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'max_retry_times'</span> <span class="keyword">in</span> request.meta:</span><br><span class="line">            retry_times = request.meta[<span class="string">'max_retry_times'</span>]</span><br><span class="line"></span><br><span class="line">        stats = spider.crawler.stats</span><br><span class="line">        <span class="keyword">if</span> retries &lt;= retry_times:</span><br><span class="line">            logger.debug(<span class="string">"Retrying %(request)s (failed %(retries)d times): %(reason)s"</span>,</span><br><span class="line">                         &#123;<span class="string">'request'</span>: request, <span class="string">'retries'</span>: retries, <span class="string">'reason'</span>: reason&#125;,</span><br><span class="line">                         extra=&#123;<span class="string">'spider'</span>: spider&#125;)</span><br><span class="line">            retryreq = request.copy()</span><br><span class="line">            retryreq.meta[<span class="string">'retry_times'</span>] = retries</span><br><span class="line">            retryreq.dont_filter = <span class="keyword">True</span></span><br><span class="line">            retryreq.priority = request.priority + self.priority_adjust</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> isinstance(reason, Exception):</span><br><span class="line">                reason = global_object_name(reason.__class__)</span><br><span class="line"></span><br><span class="line">            stats.inc_value(<span class="string">'retry/count'</span>)</span><br><span class="line">            stats.inc_value(<span class="string">'retry/reason_count/%s'</span> % reason)</span><br><span class="line">            <span class="keyword">return</span> retryreq</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            stats.inc_value(<span class="string">'retry/max_reached'</span>)</span><br><span class="line">            logger.debug(<span class="string">"Gave up retrying %(request)s (failed %(retries)d times): %(reason)s"</span>,</span><br><span class="line">                         &#123;<span class="string">'request'</span>: request, <span class="string">'retries'</span>: retries, <span class="string">'reason'</span>: reason&#125;,</span><br><span class="line">                         extra=&#123;<span class="string">'spider'</span>: spider&#125;)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æºç æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œå¯¹äºè¿”å›http codeçš„responseï¼Œè¯¥ä¸­é—´ä»¶ä¼šé€šè¿‡process_responseæ–¹æ³•æ¥å¤„ç†ï¼Œå¤„ç†åŠæ³•æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­response.statusæ˜¯å¦åœ¨retry_http_codesé›†åˆä¸­ï¼Œè¿™ä¸ªé›†åˆæ˜¯è¯»å–çš„é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">RETRY_ENABLED = <span class="keyword">True</span>                  <span class="comment"># é»˜è®¤å¼€å¯å¤±è´¥é‡è¯•ï¼Œä¸€èˆ¬å…³é—­</span></span><br><span class="line">RETRY_TIMES = <span class="number">3</span>                         <span class="comment"># å¤±è´¥åé‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸¤æ¬¡</span></span><br><span class="line">RETRY_HTTP_CODES = [<span class="number">500</span>, <span class="number">502</span>, <span class="number">503</span>, <span class="number">504</span>, <span class="number">522</span>, <span class="number">524</span>, <span class="number">408</span>]    <span class="comment"># ç¢°åˆ°è¿™äº›éªŒè¯ç ï¼Œæ‰å¼€å¯é‡è¯•</span></span><br></pre></td></tr></table></figure><p>å¯¹äºhttperrorçš„å¤„ç†ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå®šä¹‰äº†ä¸€ä¸ª EXCEPTIONS_TO_RETRYçš„åˆ—è¡¨ï¼Œé‡Œé¢å­˜æ”¾æ‰€æœ‰çš„å¼‚å¸¸ç±»å‹ï¼Œç„¶ååˆ¤æ–­ä¼ å…¥çš„å¼‚å¸¸æ˜¯å¦å­˜åœ¨äºè¯¥é›†åˆä¸­ï¼Œå¦‚æœåœ¨å°±è¿›å…¥retryé€»è¾‘ï¼Œä¸åœ¨å°±å¿½ç•¥ã€‚</p><h2 id="æºç æ€æƒ³çš„åº”ç”¨"><a href="#æºç æ€æƒ³çš„åº”ç”¨" class="headerlink" title="æºç æ€æƒ³çš„åº”ç”¨"></a>æºç æ€æƒ³çš„åº”ç”¨</h2><p>äº†è§£scrapyå¦‚ä½•å¤„ç†å¼‚å¸¸åï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ç§æ€æƒ³ï¼Œå†™ä¸€ä¸ªmiddlewareï¼Œå¯¹çˆ¬å–å¤±è´¥çš„æ¼ç½‘ä¹‹é±¼è¿›è¡Œæ•è·ï¼Œæ–¹ä¾¿ä»¥ååšè¡¥çˆ¬ã€‚</p><ol><li>åœ¨middlewares.pyä¸­ from scrapy.downloadermiddlewares.retry import RetryMiddleware, å†™ä¸€ä¸ªclassï¼Œç»§æ‰¿è‡ªRetryMiddlewareï¼›</li><li>å¯¹çˆ¶ç±»çš„<code>process_response()</code>å’Œ<code>process_exception()</code>æ–¹æ³•è¿›è¡Œé‡å†™ï¼›</li><li>å°†è¯¥middlewareåŠ å…¥setting.py;</li><li>æ³¨æ„äº‹é¡¹ï¼šè¯¥ä¸­é—´ä»¶çš„Order_codeä¸èƒ½è¿‡å¤§ï¼Œå¦‚æœè¿‡å¤§å°±ä¼šè¶Šæ¥è¿‘ä¸‹è½½å™¨ï¼Œå°±ä¼šä¼˜å…ˆäºRetryMiddlewareå¤„ç†responseï¼Œä½†è¿™ä¸ªä¸­é—´ä»¶æ˜¯ç”¨æ¥å¤„ç†æœ€ç»ˆçš„é”™è¯¯çš„ï¼Œå³å½“ä¸€ä¸ªresponse 500è¿›å…¥ä¸­é—´ä»¶é“¾è·¯æ—¶ï¼Œéœ€è¦å…ˆç»è¿‡retryä¸­é—´ä»¶å¤„ç†ï¼Œä¸èƒ½å…ˆç”±æˆ‘ä»¬å†™çš„ä¸­é—´ä»¶æ¥å¤„ç†ï¼Œå®ƒä¸å…·æœ‰retryçš„åŠŸèƒ½ï¼Œæ¥æ”¶åˆ°500çš„responseå°±ç›´æ¥æ”¾å¼ƒæ‰è¯¥requestç›´æ¥returnäº†ï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚åªæœ‰ç»è¿‡retryåä»ç„¶æœ‰å¼‚å¸¸çš„requestæ‰åº”å½“ç”±æˆ‘ä»¬å†™çš„ä¸­é—´ä»¶æ¥å¤„ç†ï¼Œè¿™æ—¶å€™ä½ æƒ³æ€ä¹ˆå¤„ç†éƒ½å¯ä»¥ï¼Œæ¯”å¦‚å†æ¬¡retryã€returnä¸€ä¸ªé‡æ–°æ„é€ çš„responseï¼Œä½†æ˜¯å¦‚æœä½ ä¸ºäº†åŠ å¿«çˆ¬è™«é€Ÿåº¦ï¼Œä¸è®¾ç½®retryä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</li></ol><p>Talk is cheap, show the code:</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFailedUrl</span><span class="params">(RetryMiddleware)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, settings)</span>:</span></span><br><span class="line">        self.max_retry_times = settings.getint(<span class="string">'RETRY_TIMES'</span>)</span><br><span class="line">        self.retry_http_codes = set(int(x) <span class="keyword">for</span> x <span class="keyword">in</span> settings.getlist(<span class="string">'RETRY_HTTP_CODES'</span>))</span><br><span class="line">        self.priority_adjust = settings.getint(<span class="string">'RETRY_PRIORITY_ADJUST'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response, spider)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> response.status <span class="keyword">in</span> self.retry_http_codes:</span><br><span class="line">        <span class="comment"># å°†çˆ¬å–å¤±è´¥çš„URLå­˜ä¸‹æ¥ï¼Œä½ ä¹Ÿå¯ä»¥å­˜åˆ°åˆ«çš„å­˜å‚¨</span></span><br><span class="line">            <span class="keyword">with</span> open(str(spider.name) + <span class="string">".txt"</span>, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(response.url + <span class="string">"\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> response</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_exception</span><span class="params">(self, request, exception, spider)</span>:</span></span><br><span class="line">    <span class="comment"># å‡ºç°å¼‚å¸¸çš„å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> isinstance(exception, self.EXCEPTIONS_TO_RETRY):</span><br><span class="line">            <span class="keyword">with</span> open(str(spider.name) + <span class="string">".txt"</span>, <span class="string">"a"</span>) <span class="keyword">as</span> f:</span><br><span class="line">                f.write(str(request) + <span class="string">"\n"</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">None</span></span><br></pre></td></tr></table></figure><p>setting.pyä¸­æ·»åŠ è¯¥ä¸­é—´ä»¶ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DOWNLOADER_MIDDLEWARES = &#123;</span><br><span class="line">   <span class="string">'myspider.middlewares.TabelogDownloaderMiddleware'</span>: <span class="number">543</span>,</span><br><span class="line">    <span class="string">'myspider.middlewares.RandomProxy'</span>: <span class="number">200</span>,</span><br><span class="line">    <span class="string">'myspider.middlewares.GetFailedUrl'</span>: <span class="number">220</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬æ•…æ„å†™é”™URLï¼Œæˆ–è€…å°†download_delayç¼©çŸ­ï¼Œå°±ä¼šå‡ºç°å„ç§å¼‚å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬ç°åœ¨èƒ½å¤Ÿæ•è·å®ƒä»¬äº†ï¼š</p><p><img src="https://ws2.sinaimg.cn/large/006tKfTcly1g1k09zlxtzj30ua076128.jpg" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      åˆ†æscrapyçš„retryæºç ï¼Œå®šåˆ¶åŒ–é‡è¯•æœºåˆ¶
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
      <category term="scrapy" scheme="https://cloudsjhan.github.io/tags/scrapy/"/>
    
  </entry>
  
  <entry>
    <title>Go Modulesä½¿ç”¨æ–¹æ³•</title>
    <link href="https://cloudsjhan.github.io/2019/03/29/Go-Modules%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/"/>
    <id>https://cloudsjhan.github.io/2019/03/29/Go-Modulesä½¿ç”¨æ–¹æ³•/</id>
    <published>2019-03-29T11:14:26.000Z</published>
    <updated>2019-03-29T11:17:02.471Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h1 id="Go-Modulesä½¿ç”¨æ•™ç¨‹"><a href="#Go-Modulesä½¿ç”¨æ•™ç¨‹" class="headerlink" title="Go Modulesä½¿ç”¨æ•™ç¨‹"></a>Go Modulesä½¿ç”¨æ•™ç¨‹</h1><h2 id="å¼•å…¥"><a href="#å¼•å…¥" class="headerlink" title="å¼•å…¥"></a>å¼•å…¥</h2><p><a href="https://talks.godoc.org/github.com/myitcv/talks/2018-08-15-glug-modules/main.slide#1" target="_blank" rel="noopener">https://talks.godoc.org/github.com/myitcv/talks/2018-08-15-glug-modules/main.slide#1</a></p><h2 id="Go-Modulesä»‹ç»"><a href="#Go-Modulesä»‹ç»" class="headerlink" title="Go Modulesä»‹ç»"></a>Go Modulesä»‹ç»</h2><p>Modulesæ˜¯Go 1.11ä¸­æ–°å¢çš„å®éªŒæ€§åŠŸèƒ½ï¼ŒåŸºäºvgoæ¼”å˜è€Œæ¥ï¼Œæ˜¯ä¸€ä¸ªæ–°å‹çš„åŒ…ç®¡ç†å·¥å…·ã€‚</p><h2 id="å¸¸è§çš„åŒ…ç®¡ç†å·¥å…·"><a href="#å¸¸è§çš„åŒ…ç®¡ç†å·¥å…·" class="headerlink" title="å¸¸è§çš„åŒ…ç®¡ç†å·¥å…·"></a>å¸¸è§çš„åŒ…ç®¡ç†å·¥å…·</h2><ul><li>govendor</li><li>dep</li><li>glide</li><li>godep</li></ul><p>è¿™äº›åŒ…ç®¡ç†å·¥å…·éƒ½æ˜¯åŸºäº<code>GOPATH</code>æˆ–è€…<code>vendor</code>ç›®å½•ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³ä¸åŒç‰ˆæœ¬ä¾èµ–é—®é¢˜ã€‚Modulesæ˜¯åœ¨<code>GOPATH</code>ä¹‹å¤–ä¸€å¥—æ–°çš„åŒ…ç®¡ç†æ–¹å¼ã€‚</p><h2 id="å¦‚ä½•æ¿€æ´»Modules"><a href="#å¦‚ä½•æ¿€æ´»Modules" class="headerlink" title="å¦‚ä½•æ¿€æ´»Modules"></a>å¦‚ä½•æ¿€æ´»Modules</h2><p>é¦–å…ˆè¦æŠŠgoå‡çº§åˆ°1.11ã€‚</p><p>å‡çº§åï¼Œå¯ä»¥è®¾ç½®é€šè¿‡ä¸€ä¸ªç¯å¢ƒå˜é‡<code>GO111MODULE</code>æ¥æ¿€æ´»modulesï¼š</p><ul><li>GO111MODULE=offï¼Œgoå‘½ä»¤è¡Œå°†ä¸ä¼šæ”¯æŒmoduleåŠŸèƒ½ï¼Œå¯»æ‰¾ä¾èµ–åŒ…çš„æ–¹å¼å°†ä¼šæ²¿ç”¨æ—§ç‰ˆæœ¬é‚£ç§é€šè¿‡vendorç›®å½•æˆ–è€…GOPATHæ¨¡å¼æ¥æŸ¥æ‰¾ã€‚</li><li>GO111MODULE=onï¼Œgoå‘½ä»¤è¡Œä¼šä½¿ç”¨modulesï¼Œè€Œä¸€ç‚¹ä¹Ÿä¸ä¼šå»GOPATHç›®å½•ä¸‹æŸ¥æ‰¾ã€‚</li><li>GO111MODULE=autoï¼Œé»˜è®¤å€¼ï¼Œgoå‘½ä»¤è¡Œå°†ä¼šæ ¹æ®å½“å‰ç›®å½•æ¥å†³å®šæ˜¯å¦å¯ç”¨moduleåŠŸèƒ½ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å½¢ï¼šå½“å‰ç›®å½•åœ¨GOPATH/srcä¹‹å¤–ä¸”è¯¥ç›®å½•åŒ…å«go.modæ–‡ä»¶ï¼Œæˆ–è€…å½“å‰æ–‡ä»¶åœ¨åŒ…å«go.modæ–‡ä»¶çš„ç›®å½•ä¸‹é¢ã€‚</li></ul><p>å½“moduleåŠŸèƒ½å¯ç”¨æ—¶ï¼Œ<code>GOPATH</code>åœ¨é¡¹ç›®æ„å»ºè¿‡ç¨‹ä¸­ä¸å†æ‹…å½“importçš„è§’è‰²ï¼Œä½†å®ƒä»ç„¶å­˜å‚¨ä¸‹è½½çš„ä¾èµ–åŒ…ï¼Œå…·ä½“ä½ç½®åœ¨<code>$GOPATH/pkg/mod</code>ã€‚</p><h2 id="åˆå§‹åŒ–Modules"><a href="#åˆå§‹åŒ–Modules" class="headerlink" title="åˆå§‹åŒ–Modules"></a>åˆå§‹åŒ–Modules</h2><p>Go1.11æ–°å¢äº†å‘½ä»¤<code>go mod</code>æ¥æ”¯æŒModulesçš„ä½¿ç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&gt; go help mod</span><br><span class="line">Go mod provides access to operations on modules.</span><br><span class="line"></span><br><span class="line">Note that support for modules is built into all the go commands,</span><br><span class="line">not just &apos;go mod&apos;. For example, day-to-day adding, removing, upgrading,</span><br><span class="line">and downgrading of dependencies should be done using &apos;go get&apos;.</span><br><span class="line">See &apos;go help modules&apos; for an overview of module functionality.</span><br><span class="line"></span><br><span class="line">Usage:</span><br><span class="line"></span><br><span class="line">    go mod &lt;command&gt; [arguments]</span><br><span class="line"></span><br><span class="line">The commands are:</span><br><span class="line"></span><br><span class="line">    download    download modules to local cache</span><br><span class="line">    edit        edit go.mod from tools or scripts</span><br><span class="line">    graph       print module requirement graph</span><br><span class="line">    init        initialize new module in current directory</span><br><span class="line">    tidy        add missing and remove unused modules</span><br><span class="line">    vendor      make vendored copy of dependencies</span><br><span class="line">    verify      verify dependencies have expected content</span><br><span class="line">    why         explain why packages or modules are needed</span><br><span class="line"></span><br><span class="line">Use &quot;go help mod &lt;command&gt;&quot; for more information about a command.</span><br></pre></td></tr></table></figure><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®helloworldï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &amp;&amp; mkdir helloworld &amp;&amp; cd helloworld</span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºæ–‡ä»¶<code>main.go</code>å¹¶å†™å…¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    log &quot;github.com/sirupsen/logrus&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    log.WithFields(log.Fields&#123;</span><br><span class="line">        &quot;animal&quot;: &quot;walrus&quot;,</span><br><span class="line">    &#125;).Info(&quot;A walrus appears&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–mod:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go mod init helloworld</span><br></pre></td></tr></table></figure><p>ç³»ç»Ÿç”Ÿæˆäº†ä¸€ä¸ª<code>go.mod</code>çš„æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module helloworld</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œgo buildï¼Œå†æ¬¡æŸ¥çœ‹go.modæ–‡ä»¶å‘ç°å¤šäº†ä¸€äº›å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">module helloworld</span><br><span class="line"></span><br><span class="line">require github.com/sirupsen/logrus v1.1.1</span><br></pre></td></tr></table></figure><p>åŒæ—¶å¤šäº†ä¸€ä¸ª<code>go.sum</code>çš„æ–‡ä»¶ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=</span><br><span class="line">github.com/konsorten/go-windows-terminal-sequences v0.0.0-20180402223658-b729f2633dfe/go.mod h1:T0+1ngSBFLxvqU3pZ+m/2kptfBszLMUkC4ZK/EgS/cQ=</span><br><span class="line">github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=</span><br><span class="line">github.com/sirupsen/logrus v1.1.1 h1:VzGj7lhU7KEB9e9gMpAV/v5XT2NVSvLJhJLCWbnkgXg=</span><br><span class="line">github.com/sirupsen/logrus v1.1.1/go.mod h1:zrgwTnHtNr00buQ1vSptGe8m1f/BbgsPukg8qsT7A+A=</span><br><span class="line">github.com/stretchr/testify v1.2.2/go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=</span><br><span class="line">golang.org/x/crypto v0.0.0-20180904163835-0709b304e793 h1:u+LnwYTOOW7Ukr/fppxEb1Nwz0AtPflrblfvUudpo+I=</span><br><span class="line">golang.org/x/crypto v0.0.0-20180904163835-0709b304e793/go.mod h1:6SG95UA2DQfeDnfUPMdvaQW0Q7yPrPDi9nlGo2tz2b4=</span><br><span class="line">golang.org/x/sys v0.0.0-20180905080454-ebe1bf3edb33 h1:I6FyU15t786LL7oL/hn43zqTuEGr4PN7F4XJ1p4E3Y8=</span><br><span class="line">golang.org/x/sys v0.0.0-20180905080454-ebe1bf3edb33/go.mod h1:STP8DvDyc/dI5b8T5hshtkjS+E42TnysNCUPdjciGhY=</span><br></pre></td></tr></table></figure><p>go.sumä¸æ˜¯ä¸€ä¸ªé”æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªæ¨¡å—ç‰ˆæœ¬å†…å®¹çš„æ ¡éªŒå€¼ï¼Œç”¨æ¥éªŒè¯å½“å‰ç¼“å­˜çš„æ¨¡å—ã€‚go.sumåŒ…å«äº†ç›´æ¥ä¾èµ–å’Œé—´æ¥ä¾èµ–çš„åŒ…çš„ä¿¡æ¯ï¼Œæ¯”go.modè¦å¤šä¸€äº›ã€‚</p><h2 id="go-mod"><a href="#go-mod" class="headerlink" title="go.mod"></a>go.mod</h2><p>æœ‰å››ç§æŒ‡ä»¤ï¼šmoduleï¼Œrequireï¼Œexcludeï¼Œreplaceã€‚</p><ul><li>moduleï¼šæ¨¡å—åç§°</li><li>requireï¼šä¾èµ–åŒ…åˆ—è¡¨ä»¥åŠç‰ˆæœ¬</li><li>excludeï¼šç¦æ­¢ä¾èµ–åŒ…åˆ—è¡¨ï¼ˆä»…åœ¨å½“å‰æ¨¡å—ä¸ºä¸»æ¨¡å—æ—¶ç”Ÿæ•ˆï¼‰</li><li>replaceï¼šæ›¿æ¢ä¾èµ–åŒ…åˆ—è¡¨ ï¼ˆä»…åœ¨å½“å‰æ¨¡å—ä¸ºä¸»æ¨¡å—æ—¶ç”Ÿæ•ˆï¼‰</li></ul><h2 id="å…¶ä»–å‘½ä»¤"><a href="#å…¶ä»–å‘½ä»¤" class="headerlink" title="å…¶ä»–å‘½ä»¤"></a>å…¶ä»–å‘½ä»¤</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go mod tidy //æ‹‰å–ç¼ºå°‘çš„æ¨¡å—ï¼Œç§»é™¤ä¸ç”¨çš„æ¨¡å—ã€‚</span><br><span class="line">go mod download //ä¸‹è½½ä¾èµ–åŒ…</span><br><span class="line">go mod graph //æ‰“å°æ¨¡å—ä¾èµ–å›¾</span><br><span class="line">go mod vendor //å°†ä¾èµ–å¤åˆ¶åˆ°vendorä¸‹</span><br><span class="line">go mod verify //æ ¡éªŒä¾èµ–</span><br><span class="line">go mod why //è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¾èµ–</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go list -m -json all //ä¾èµ–è¯¦æƒ…</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      Go modules ä½¿ç”¨
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="Golang" scheme="https://cloudsjhan.github.io/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Pythonçš„map/reduce/filter</title>
    <link href="https://cloudsjhan.github.io/2019/03/27/Python%E7%9A%84map-reduce-filter/"/>
    <id>https://cloudsjhan.github.io/2019/03/27/Pythonçš„map-reduce-filter/</id>
    <published>2019-03-27T03:06:12.000Z</published>
    <updated>2019-03-27T03:09:29.569Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="è½¬è½½è‡ªexplore-python"><a href="#è½¬è½½è‡ªexplore-python" class="headerlink" title="è½¬è½½è‡ªexplore_python"></a>è½¬è½½è‡ª<a href="http://funhacks.net/explore-python/" target="_blank" rel="noopener">explore_python</a></h3><ul><li><a href="http://funhacks.net/explore-python/Functional/map_reduce_filter.html" target="_blank" rel="noopener">http://funhacks.net/explore-python/Functional/map_reduce_filter.html</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      pythonçš„Mapã€reduceã€filterè§£æ
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>golangçš„å¤šæ€å®ç°</title>
    <link href="https://cloudsjhan.github.io/2019/03/18/golang%E7%9A%84%E5%A4%9A%E6%80%81%E5%AE%9E%E7%8E%B0/"/>
    <id>https://cloudsjhan.github.io/2019/03/18/golangçš„å¤šæ€å®ç°/</id>
    <published>2019-03-18T07:57:27.000Z</published>
    <updated>2019-03-18T08:14:30.423Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="å¤šæ€ï¼ˆpolymorphismï¼‰"><a href="#å¤šæ€ï¼ˆpolymorphismï¼‰" class="headerlink" title="å¤šæ€ï¼ˆpolymorphismï¼‰"></a>å¤šæ€ï¼ˆpolymorphismï¼‰</h3><p>å¤šæ€æ˜¯æ¥å£çš„ä¸€ä¸ªå…³é”®åŠŸèƒ½å’ŒGoè¯­è¨€çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚</p><p>å½“éæ¥å£ç±»å‹<code>T</code>çš„ä¸€ä¸ªå€¼<code>t</code>è¢«åŒ…è£¹åœ¨æ¥å£ç±»å‹<code>I</code>çš„ä¸€ä¸ªæ¥å£å€¼<code>i</code>ä¸­ï¼Œé€šè¿‡<code>i</code>è°ƒç”¨æ¥å£ç±»å‹<code>I</code>æŒ‡å®šçš„ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œäº‹å®ä¸Šä¸ºéæ¥å£ç±»å‹<code>T</code>å£°æ˜çš„å¯¹åº”æ–¹æ³•å°†é€šè¿‡éæ¥å£å€¼<code>t</code>è¢«è°ƒç”¨ã€‚ æ¢å¥è¯è¯´ï¼Œ<strong>è°ƒç”¨ä¸€ä¸ªæ¥å£å€¼çš„æ–¹æ³•å®é™…ä¸Šå°†è°ƒç”¨æ­¤æ¥å£å€¼çš„åŠ¨æ€å€¼çš„å¯¹åº”æ–¹æ³•</strong>ã€‚ æ¯”å¦‚ï¼Œå½“æ–¹æ³•<code>i.m</code>è¢«è°ƒç”¨æ—¶ï¼Œå…¶å®è¢«è°ƒç”¨çš„æ˜¯æ–¹æ³•<code>t.m</code>ã€‚ ä¸€ä¸ªæ¥å£å€¼å¯ä»¥é€šè¿‡åŒ…è£¹ä¸åŒåŠ¨æ€ç±»å‹çš„åŠ¨æ€å€¼æ¥è¡¨ç°å‡ºå„ç§ä¸åŒçš„è¡Œä¸ºï¼Œè¿™ç§°ä¸ºå¤šæ€ã€‚</p><p>å½“æ–¹æ³•<code>i.m</code>è¢«è°ƒç”¨æ—¶ï¼Œ<code>i</code>å­˜å‚¨çš„å®ç°å…³ç³»ä¿¡æ¯çš„æ–¹æ³•è¡¨ä¸­çš„æ–¹æ³•<code>t.m</code>å°†è¢«æ‰¾åˆ°å¹¶è¢«è°ƒç”¨ã€‚ æ­¤æ–¹æ³•è¡¨æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ï¼Œæ‰€ä»¥æ­¤å¯»æ‰¾è¿‡ç¨‹åªä¸è¿‡æ˜¯ä¸€ä¸ªåˆ‡ç‰‡å…ƒç´ è®¿é—®æ“ä½œï¼Œä¸ä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´ã€‚</p><p>æ³¨æ„ï¼Œåœ¨nilæ¥å£å€¼ä¸Šè°ƒç”¨æ–¹æ³•å°†äº§ç”Ÿä¸€ä¸ªææ…Œï¼Œå› ä¸ºæ²¡æœ‰å…·ä½“çš„æ–¹æ³•å¯è¢«è°ƒç”¨ã€‚</p><p>ä¸€ä¸ªä¾‹å­ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Filter <span class="keyword">interface</span> &#123;</span><br><span class="line">About() <span class="keyword">string</span></span><br><span class="line">Process([]<span class="keyword">int</span>) []<span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// UniqueFilterç”¨æ¥åˆ é™¤é‡å¤çš„æ•°å­—ã€‚</span></span><br><span class="line"><span class="keyword">type</span> UniqueFilter <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(UniqueFilter)</span> <span class="title">About</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"åˆ é™¤é‡å¤çš„æ•°å­—"</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(UniqueFilter)</span> <span class="title">Process</span><span class="params">(inputs []<span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line">outs := <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="built_in">len</span>(inputs))</span><br><span class="line">pusheds := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">int</span>]<span class="keyword">bool</span>)</span><br><span class="line"><span class="keyword">for</span> _, n := <span class="keyword">range</span> inputs &#123;</span><br><span class="line"><span class="keyword">if</span> !pusheds[n] &#123;</span><br><span class="line">pusheds[n] = <span class="literal">true</span></span><br><span class="line">outs = <span class="built_in">append</span>(outs, n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> outs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MultipleFilterç”¨æ¥åªä¿ç•™æŸä¸ªæ•´æ•°çš„å€æ•°æ•°å­—ã€‚</span></span><br><span class="line"><span class="keyword">type</span> MultipleFilter <span class="keyword">int</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mf MultipleFilter)</span> <span class="title">About</span><span class="params">()</span> <span class="title">string</span></span> &#123;</span><br><span class="line"><span class="keyword">return</span> fmt.Sprintf(<span class="string">"ä¿ç•™%vçš„å€æ•°"</span>, mf)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(mf MultipleFilter)</span> <span class="title">Process</span><span class="params">(inputs []<span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line"><span class="keyword">var</span> outs = <span class="built_in">make</span>([]<span class="keyword">int</span>, <span class="number">0</span>, <span class="built_in">len</span>(inputs))</span><br><span class="line"><span class="keyword">for</span> _, n := <span class="keyword">range</span> inputs &#123;</span><br><span class="line"><span class="keyword">if</span> n % <span class="keyword">int</span>(mf) == <span class="number">0</span> &#123;</span><br><span class="line">outs = <span class="built_in">append</span>(outs, n)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> outs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨å¤šæ€ç‰¹æ€§çš„å¸®åŠ©ä¸‹ï¼Œåªéœ€è¦ä¸€ä¸ªfilteAndPrintå‡½æ•°ã€‚</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">filteAndPrint</span><span class="params">(fltr Filter, unfiltered []<span class="keyword">int</span>)</span> []<span class="title">int</span></span> &#123;</span><br><span class="line"><span class="comment">// åœ¨fltrå‚æ•°ä¸Šè°ƒç”¨æ–¹æ³•å…¶å®æ˜¯è°ƒç”¨fltrçš„åŠ¨æ€å€¼çš„æ–¹æ³•ã€‚</span></span><br><span class="line">filtered := fltr.Process(unfiltered)</span><br><span class="line">fmt.Println(fltr.About() + <span class="string">":\n\t"</span>, filtered)</span><br><span class="line"><span class="keyword">return</span> filtered</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">numbers := []<span class="keyword">int</span>&#123;<span class="number">12</span>, <span class="number">7</span>, <span class="number">21</span>, <span class="number">12</span>, <span class="number">12</span>, <span class="number">26</span>, <span class="number">25</span>, <span class="number">21</span>, <span class="number">30</span>&#125;</span><br><span class="line">fmt.Println(<span class="string">"è¿‡æ»¤ä¹‹å‰ï¼š\n\t"</span>, numbers)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‰ä¸ªéæ¥å£å€¼è¢«åŒ…è£¹åœ¨ä¸€ä¸ªFilteråˆ‡ç‰‡çš„ä¸‰ä¸ªæ¥å£å…ƒç´ ä¸­ã€‚</span></span><br><span class="line">filters := []Filter&#123;</span><br><span class="line">UniqueFilter&#123;&#125;,</span><br><span class="line">MultipleFilter(<span class="number">2</span>),</span><br><span class="line">MultipleFilter(<span class="number">3</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¯ä¸ªåˆ‡ç‰‡å…ƒç´ å°†è¢«èµ‹å€¼ç»™ç±»å‹ä¸ºFilterçš„å¾ªç¯å˜é‡fltrã€‚</span></span><br><span class="line"><span class="comment">// æ¯ä¸ªå…ƒç´ ä¸­çš„åŠ¨æ€å€¼ä¹Ÿå°†è¢«åŒæ—¶å¤åˆ¶å¹¶è¢«åŒ…è£¹åœ¨å¾ªç¯å˜é‡flträ¸­ã€‚</span></span><br><span class="line"><span class="keyword">for</span> _, fltr := <span class="keyword">range</span> filters &#123;</span><br><span class="line">numbers = filteAndPrint(fltr, numbers)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">è¿‡æ»¤ä¹‹å‰ï¼š</span><br><span class="line"> [12 7 21 12 12 26 25 21 30]</span><br><span class="line">åˆ é™¤é‡å¤çš„æ•°å­—:</span><br><span class="line"> [12 7 21 26 25 30]</span><br><span class="line">ä¿ç•™2çš„å€æ•°:</span><br><span class="line"> [12 26 30]</span><br><span class="line">ä¿ç•™3çš„å€æ•°:</span><br><span class="line"> [12 30]</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¤šæ€ä½¿å¾—æˆ‘ä»¬ä¸å¿…ä¸ºæ¯ä¸ªè¿‡æ»¤å™¨ç±»å‹å†™ä¸€ä¸ªå•ç‹¬çš„<code>filteAndPrint</code>å‡½æ•°ã€‚</p><p>é™¤äº†ä¸Šè¿°è¿™ä¸ªå¥½å¤„ï¼Œå¤šæ€ä¹Ÿä½¿å¾—ä¸€ä¸ªä»£ç åŒ…çš„å¼€å‘è€…å¯ä»¥åœ¨æ­¤ä»£ç åŒ…ä¸­å£°æ˜ä¸€ä¸ªæ¥å£ç±»å‹å¹¶å£°æ˜ä¸€ä¸ªæ‹¥æœ‰æ­¤æ¥å£ç±»å‹å‚æ•°çš„å‡½æ•°ï¼ˆæˆ–è€…æ–¹æ³•ï¼‰ï¼Œä»è€Œæ­¤ä»£ç åŒ…çš„ä¸€ä¸ªç”¨æˆ·å¯ä»¥åœ¨ç”¨æˆ·åŒ…ä¸­å£°æ˜ä¸€ä¸ªå®ç°äº†æ­¤æ¥å£ç±»å‹çš„ç”¨æˆ·ç±»å‹ï¼Œå¹¶ä¸”å°†æ­¤ç”¨æˆ·ç±»å‹çš„å€¼åšä¸ºå®å‚ä¼ é€’ç»™æ­¤ä»£ç åŒ…ä¸­å£°æ˜çš„å‡½æ•°ï¼ˆæˆ–è€…æ–¹æ³•ï¼‰çš„è°ƒç”¨ã€‚ æ­¤ä»£ç åŒ…çš„å¼€å‘è€…å¹¶ä¸ç”¨å…³å¿ƒä¸€ä¸ªç”¨æˆ·ç±»å‹å…·ä½“æ˜¯å¦‚ä½•å£°æ˜çš„ï¼Œåªè¦æ­¤ç”¨æˆ·ç±»å‹æ»¡è¶³æ­¤ä»£ç åŒ…ä¸­å£°æ˜çš„æ¥å£ç±»å‹è§„å®šçš„è¡Œä¸ºå³å¯ã€‚</p><p>äº‹å®ä¸Šï¼Œå¤šæ€å¯¹äºä¸€ä¸ªè¯­è¨€æ¥è¯´å¹¶éä¸€ä¸ªä¸å¯æˆ–ç¼ºçš„ç‰¹æ€§ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶å®ƒé€”å¾„æ¥å®ç°å¤šæ€çš„ä½œç”¨ã€‚ ä½†æ˜¯ï¼Œå¤šæ€å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´å’Œä¼˜é›…ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      golangçš„å¤šæ€å®ç°ä¸åŸç†
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>mysqlå…³é—­update safe mode</title>
    <link href="https://cloudsjhan.github.io/2019/03/11/mysql%E5%85%B3%E9%97%ADupdate-safe-mode/"/>
    <id>https://cloudsjhan.github.io/2019/03/11/mysqlå…³é—­update-safe-mode/</id>
    <published>2019-03-11T02:28:38.000Z</published>
    <updated>2019-03-11T02:30:18.232Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>SET SQL_SAFE_UPDATES = 0;</li></ul><hr>]]></content>
    
    <summary type="html">
    
      mysqlå…³é—­update safe mode
    
    </summary>
    
      <category term="mysql" scheme="https://cloudsjhan.github.io/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://cloudsjhan.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>git-ä¿æŒforkçš„é¡¹ç›®ä¸ä¸Šæ¸¸åŒæ­¥</title>
    <link href="https://cloudsjhan.github.io/2019/02/26/git-%E4%BF%9D%E6%8C%81fork%E7%9A%84%E9%A1%B9%E7%9B%AE%E4%B8%8E%E4%B8%8A%E6%B8%B8%E5%90%8C%E6%AD%A5/"/>
    <id>https://cloudsjhan.github.io/2019/02/26/git-ä¿æŒforkçš„é¡¹ç›®ä¸ä¸Šæ¸¸åŒæ­¥/</id>
    <published>2019-02-26T01:48:38.000Z</published>
    <updated>2019-02-26T01:53:39.122Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼š</li></ul><p>git remote add upstream [upstream_url]</p><ul><li>fetch ä¹‹ï¼š</li></ul><p>git fetch upstream</p><ul><li>åˆ‡æ¢åˆ°æœ¬åœ°masteråˆ†æ”¯ï¼š</li></ul><p>git checkout master</p><ul><li>å°†upstream/master mergeåˆ° æœ¬åœ°masteråˆ†æ”¯ï¼š</li></ul><p>git merge upstream/master  //å¯èƒ½ä¼šæŠ¥é”™ï¼Œå¦‚æœæŠ¥é”™å°±æ‰§è¡Œï¼šgit pull</p><ul><li>åŒæ—¶pushåˆ°è‡ªå·±çš„githubä»“åº“ï¼š</li></ul><p>git push origin master</p><hr>]]></content>
    
    <summary type="html">
    
      git-ä¿æŒforkçš„é¡¹ç›®ä¸ä¸Šæ¸¸åŒæ­¥
    
    </summary>
    
      <category term="git" scheme="https://cloudsjhan.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://cloudsjhan.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>è¯¦è§£Go regexpåŒ…ä¸­ ReplaceAllString çš„ç”¨æ³•</title>
    <link href="https://cloudsjhan.github.io/2019/02/01/%E8%AF%A6%E8%A7%A3Go-regexp%E5%8C%85%E4%B8%AD-ReplaceAllString-%E7%9A%84%E7%94%A8%E6%B3%95/"/>
    <id>https://cloudsjhan.github.io/2019/02/01/è¯¦è§£Go-regexpåŒ…ä¸­-ReplaceAllString-çš„ç”¨æ³•/</id>
    <published>2019-02-01T04:23:12.000Z</published>
    <updated>2019-02-01T09:37:45.426Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æ˜¨å¤©æœ‰åŒäº‹åœ¨çœ‹k8sæºç ï¼Œçªç„¶é—®äº†ä¸€ä¸ªçœ‹ä¼¼å¾ˆç®€å•çš„é—®é¢˜ï¼Œ<a href="https://golang.org/pkg/regexp/#Regexp.ReplaceAllString" target="_blank" rel="noopener">https://golang.org/pkg/regexp/#Regexp.ReplaceAllString</a> å®˜æ–¹æ–‡æ¡£ä¸­<code>ReplaceAllString</code>çš„è§£é‡Šï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿåˆ°åº•æ€ä¹ˆç”¨ï¼Ÿ</p><p>å®˜æ–¹è‹±æ–‡åŸæ–‡ï¼š</p><p><code>func (re *Regexp) ReplaceAllString(src, repl string) string</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ReplaceAllString returns a copy of src, replacing matches of the Regexp with the replacement <span class="built_in">string</span> repl. Inside repl, $ signs are interpreted as in Expand, so <span class="keyword">for</span> instance $<span class="number">1</span> represents the text of the first submatch.</span><br></pre></td></tr></table></figure><p>ä¸­æ–‡æ–‡æ¡£ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ReplaceAllLiteralè¿”å›srcçš„ä¸€ä¸ªæ‹·è´ï¼Œå°†srcä¸­æ‰€æœ‰reçš„åŒ¹é…ç»“æœéƒ½æ›¿æ¢ä¸ºreplã€‚åœ¨æ›¿æ¢æ—¶ï¼Œreplä¸­çš„&apos;$&apos;ç¬¦å·ä¼šæŒ‰ç…§Expandæ–¹æ³•çš„è§„åˆ™è¿›è¡Œè§£é‡Šå’Œæ›¿æ¢ï¼Œä¾‹å¦‚$1ä¼šè¢«æ›¿æ¢ä¸ºç¬¬ä¸€ä¸ªåˆ†ç»„åŒ¹é…ç»“æœã€‚</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šå»ä¸€è„¸æ‡µé€¼ï¼Œè¿˜æ˜¯ä¸ç†è§£è¿™ä¸ªå‡½æ•°åˆ°åº•æ€ä¹ˆç”¨ã€‚</p><p>åˆå»çœ‹å®˜æ–¹çš„ç¤ºä¾‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Exampleï¼š</span><br><span class="line">re := regexp.MustCompile(<span class="string">"a(x*)b"</span>)</span><br><span class="line">fmt.Println(re.ReplaceAllString(<span class="string">"-ab-axxb-"</span>, <span class="string">"T"</span>))</span><br><span class="line">fmt.Println(re.ReplaceAllString(<span class="string">"-ab-axxb-"</span>, <span class="string">"$1"</span>))</span><br><span class="line">fmt.Println(re.ReplaceAllString(<span class="string">"-ab-axxb-"</span>, <span class="string">"$1W"</span>))</span><br><span class="line">fmt.Println(re.ReplaceAllString(<span class="string">"-ab-axxb-"</span>, <span class="string">"$&#123;1&#125;W"</span>))</span><br><span class="line"></span><br><span class="line">Output:</span><br><span class="line"></span><br><span class="line">-T-T-</span><br><span class="line">--xx-</span><br><span class="line">---</span><br><span class="line">-W-xxW-</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€ä¸ªæ›¿æ¢å‹‰å¼ºèƒ½çœ‹æ˜ç™½ï¼Œæ˜¯ç”¨<code>T</code>å»æ›¿æ¢<code>-ab-axxb-</code>ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„éƒ¨åˆ†ï¼›ç¬¬äºŒä¸ªä¸­çš„<code>$</code>æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ<code>$1</code>çœ‹èµ·æ¥åƒæ˜¯åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼åˆ†ç»„ä¸­ç¬¬ä¸€éƒ¨åˆ†ï¼Œé‚£<code>$1W</code>å‘¢ï¼Ÿ<code>${1}W</code>å‘¢ï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜ï¼Œå¼€å§‹æ·±å…¥ç ”ç©¶è¿™ä¸ªå‡½æ•°åˆ°åº•æ€ä¹ˆç”¨ã€‚</p><p>é¦–å…ˆï¼Œ<code>$</code>ç¬¦å·åœ¨<code>Expand</code>å‡½æ•°ä¸­æœ‰è§£é‡Šè¿‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func (re *Regexp) Expand(dst []byte, template []byte, src []byte, match []int) []byte</span><br><span class="line"></span><br><span class="line">Expandè¿”å›æ–°ç”Ÿæˆçš„å°†templateæ·»åŠ åˆ°dståé¢çš„åˆ‡ç‰‡ã€‚åœ¨æ·»åŠ æ—¶ï¼ŒExpandä¼šå°†templateä¸­çš„å˜é‡æ›¿æ¢ä¸ºä»srcåŒ¹é…çš„ç»“æœã€‚matchåº”è¯¥æ˜¯è¢«FindSubmatchIndexè¿”å›çš„åŒ¹é…ç»“æœèµ·æ­¢ä½ç½®ç´¢å¼•ã€‚ï¼ˆé€šå¸¸å°±æ˜¯åŒ¹é…srcï¼Œé™¤éä½ è¦å°†åŒ¹é…å¾—åˆ°çš„ä½ç½®ç”¨äºå¦ä¸€ä¸ª[]byteï¼‰</span><br><span class="line"></span><br><span class="line">åœ¨templateå‚æ•°é‡Œï¼Œä¸€ä¸ªå˜é‡è¡¨ç¤ºä¸ºæ ¼å¼å¦‚ï¼š$nameæˆ–$&#123;name&#125;çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­nameæ˜¯é•¿åº¦&gt;0çš„å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿çš„åºåˆ—ã€‚ä¸€ä¸ªå•çº¯çš„æ•°å­—å­—ç¬¦åå¦‚$1ä¼šä½œä¸ºæ•è·åˆ†ç»„çš„æ•°å­—ç´¢å¼•ï¼›å…¶ä»–çš„åå­—å¯¹åº”(?P&lt;name&gt;...)è¯­æ³•äº§ç”Ÿçš„å‘½åæ•è·åˆ†ç»„çš„åå­—ã€‚è¶…å‡ºèŒƒå›´çš„æ•°å­—ç´¢å¼•ã€ç´¢å¼•å¯¹åº”çš„åˆ†ç»„æœªåŒ¹é…åˆ°æ–‡æœ¬ã€æ­£åˆ™è¡¨è¾¾å¼ä¸­æœªå‡ºç°çš„åˆ†ç»„åï¼Œéƒ½ä¼šè¢«æ›¿æ¢ä¸ºç©ºåˆ‡ç‰‡ã€‚</span><br><span class="line"></span><br><span class="line">$nameæ ¼å¼çš„å˜é‡åï¼Œnameä¼šå°½å¯èƒ½å–æœ€é•¿åºåˆ—ï¼š$1xç­‰ä»·äº$&#123;1x&#125;è€Œé$&#123;1&#125;xï¼Œ$10ç­‰ä»·äº$&#123;10&#125;è€Œé$&#123;1&#125;0ã€‚å› æ­¤$nameé€‚ç”¨åœ¨åè·Ÿç©ºæ ¼/æ¢è¡Œç­‰å­—ç¬¦çš„æƒ…å†µï¼Œ$&#123;name&#125;é€‚ç”¨æ‰€æœ‰æƒ…å†µã€‚</span><br><span class="line"></span><br><span class="line">å¦‚æœè¦åœ¨è¾“å‡ºä¸­æ’å…¥ä¸€ä¸ªå­—é¢å€¼&apos;$&apos;ï¼Œåœ¨templateé‡Œå¯ä»¥ä½¿ç”¨$$ã€‚</span><br></pre></td></tr></table></figure><p>è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®æœ€ç»ˆè¦çš„éƒ¨åˆ†å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ç‚¹ï¼š</p><ol><li><code>$</code>åé¢åªæœ‰æ•°å­—ï¼Œåˆ™ä»£è¡¨æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„ç´¢å¼•ï¼Œå…³äºæ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„è§£é‡Šï¼š</li></ol><p>æ•è·ç»„å¯ä»¥é€šè¿‡ä»å·¦åˆ°å³è®¡ç®—å…¶å¼€æ‹¬å·æ¥ç¼–å· ã€‚ä¾‹å¦‚ï¼Œåœ¨è¡¨è¾¾å¼ (A)(B(C)) ä¸­ï¼Œå­˜åœ¨å››ä¸ªè¿™æ ·çš„ç»„ï¼š</p><table><thead><tr><th><strong>0</strong></th><th>(A)(B(C))</th></tr></thead><tbody><tr><td><strong>1</strong></td><td>(A)</td></tr><tr><td><strong>2</strong></td><td>(B(C))</td></tr><tr><td><strong>3</strong></td><td>(C)</td></tr></tbody></table><p>ç»„é›¶å§‹ç»ˆä»£è¡¨æ•´ä¸ªè¡¨è¾¾å¼</p><p>ä¹‹æ‰€ä»¥è¿™æ ·å‘½åæ•è·ç»„æ˜¯å› ä¸ºåœ¨åŒ¹é…ä¸­ï¼Œä¿å­˜äº†ä¸è¿™äº›ç»„åŒ¹é…çš„è¾“å…¥åºåˆ—çš„æ¯ä¸ªå­åºåˆ—ã€‚æ•è·çš„å­åºåˆ—ç¨åå¯ä»¥é€šè¿‡ Back å¼•ç”¨ï¼ˆåå‘å¼•ç”¨ï¼‰ åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨åŒ¹é…æ“ä½œå®Œæˆåä»åŒ¹é…å™¨æ£€ç´¢ã€‚</p><p>åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„<code>$1</code>éƒ¨åˆ†ï¼Œä¿ç•™è¯¥éƒ¨åˆ†ï¼Œå»æ‰å…¶ä½™éƒ¨åˆ†ï¼›</p><ol start="2"><li><code>$</code>åé¢æ˜¯å­—ç¬¦ä¸²ï¼Œå³<code>$name</code>,ä»£è¡¨åŒ¹é…<strong>å¯¹åº”(?P<name>â€¦)è¯­æ³•äº§ç”Ÿçš„å‘½åæ•è·åˆ†ç»„çš„åå­—</name></strong></li><li><code>${æ•°å­—}å­—ç¬¦ä¸²</code>,å³<code>${1}xxx</code>ï¼Œæ„æ€æ˜¯åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„1ï¼Œ<code>src</code>ä¸­åŒ¹é…åˆ†ç»„1çš„ä¿ç•™ï¼Œå¹¶åˆ é™¤<code>src</code>å‰©ä½™éƒ¨åˆ†ï¼Œè¿½åŠ <code>xxx</code>ï¼Œåé¢ä¼šæœ‰ä»£ç ç¤ºä¾‹è§£é‡Šè¿™éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€éš¾ç†è§£çš„éƒ¨åˆ†</li><li>æœ€ç®€å•çš„æƒ…å†µï¼Œå‚æ•°<code>repl</code>æ˜¯å­—ç¬¦ä¸²ï¼Œå°†srcä¸­æ‰€æœ‰reçš„åŒ¹é…ç»“æœéƒ½æ›¿æ¢ä¸ºrepl</li></ol><p>ä¸‹é¢ç”¨ä»£ç æ¥è§£é‡Šä»¥ä¸Šå‡ ç§æƒ…å†µï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"regexp"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">s := <span class="string">"Hello World, 123 Go!"</span></span><br><span class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼regï¼ŒåŒ¹é…Helloæˆ–è€…Go</span></span><br><span class="line">reg := regexp.MustCompile(<span class="string">`(Hell|G)o`</span>)</span><br><span class="line"></span><br><span class="line">s2 := <span class="string">"2019-12-01,test"</span></span><br><span class="line"><span class="comment">//å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼reg2,åŒ¹é… YYYY-MM-DD çš„æ—¥æœŸæ ¼å¼</span></span><br><span class="line">reg2 := regexp.MustCompile(<span class="string">`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//æœ€ç®€å•çš„æƒ…å†µï¼Œç”¨â€œTæ›¿æ¢â€"-ab-axxb-"ä¸­ç¬¦åˆæ­£åˆ™"a(x*)b"çš„éƒ¨åˆ†</span></span><br><span class="line">    reg3 := regexp.MustCompile(<span class="string">"a(x*)b"</span>)</span><br><span class="line">fmt.Println(re.ReplaceAllString(<span class="string">"-ab-axxb-"</span>, <span class="string">"T"</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">//$&#123;1&#125;åŒ¹é…"Hello World, 123 Go!"ä¸­ç¬¦åˆæ­£åˆ™`(Hell|G)`çš„éƒ¨åˆ†å¹¶ä¿ç•™ï¼Œå»æ‰"Hello"ä¸"Go"ä¸­çš„'o'å¹¶ç”¨"ddd"è¿½åŠ </span></span><br><span class="line">rep1 := <span class="string">"$&#123;1&#125;ddd"</span></span><br><span class="line">fmt.Printf(<span class="string">"%q\n"</span>, reg.ReplaceAllString(s, rep1))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é¦–å…ˆï¼Œ"2019-12-01,test"ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`çš„éƒ¨åˆ†æ˜¯"2019-12-01",å°†è¯¥éƒ¨åˆ†åŒ¹é…'(\d&#123;4&#125;)'çš„'2019'ä¿ç•™ï¼Œå»æ‰å‰©ä½™éƒ¨åˆ†</span></span><br><span class="line">    rep2 := <span class="string">"$&#123;1&#125;"</span></span><br><span class="line">fmt.Printf(<span class="string">"%q\n"</span>, reg2.ReplaceAllString(s2,rep2))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é¦–å…ˆï¼Œ"2019-12-01,test"ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`çš„éƒ¨åˆ†æ˜¯"2019-12-01",å°†è¯¥éƒ¨åˆ†åŒ¹é…'(\d&#123;2&#125;)'çš„'12'ä¿ç•™ï¼Œå»æ‰å‰©ä½™éƒ¨åˆ†</span></span><br><span class="line">     rep3 := <span class="string">"$&#123;2&#125;"</span></span><br><span class="line">fmt.Printf(<span class="string">"%q\n"</span>, reg2.ReplaceAllString(s2,rep3))</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//é¦–å…ˆï¼Œ"2019-12-01,test"ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`çš„éƒ¨åˆ†æ˜¯"2019-12-01",å°†è¯¥éƒ¨åˆ†åŒ¹é…'(\d&#123;2&#125;)'çš„'01'ä¿ç•™ï¼Œå»æ‰å‰©ä½™éƒ¨åˆ†,å¹¶è¿½åŠ "13:30:12"</span></span><br><span class="line">    rep4 := <span class="string">"$&#123;3&#125;:13:30:12"</span></span><br><span class="line">fmt.Printf(<span class="string">"%q\n"</span>, reg2.ReplaceAllString(s2,rep4))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä»£ç è¾“å‡ºä¾æ¬¡æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go run main.go</span></span><br><span class="line">-T-T-</span><br><span class="line">"Hellddd World, 123 Gddd!"</span><br><span class="line">"2019,test"</span><br><span class="line">"12,test"</span><br><span class="line">"01:13:30:12,test"</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Go<code>regexp</code>åŒ…ä¸­çš„<code>ReplaceAllString</code>è®¾è®¡æœ‰äº›è®¸åäººç±»ï¼Œç†è§£å’Œä½¿ç”¨ä¸Šæ„Ÿè§‰ä¸æ–¹ä¾¿ï¼Œå¦‚æœä½ æœ‰æ›´å¥½çš„ç†è§£æˆ–è€…ç¤ºä¾‹ä»£ç ï¼ŒCall me!</p><hr>]]></content>
    
    <summary type="html">
    
      è¯¦è§£Go regexpåŒ…ä¸­ ReplaceAllString çš„ç”¨æ³•
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>goè¯­è¨€å‘ä¹‹for range</title>
    <link href="https://cloudsjhan.github.io/2019/01/31/go%E8%AF%AD%E8%A8%80%E5%9D%91%E4%B9%8Bfor-range/"/>
    <id>https://cloudsjhan.github.io/2019/01/31/goè¯­è¨€å‘ä¹‹for-range/</id>
    <published>2019-01-31T01:59:59.000Z</published>
    <updated>2019-01-31T02:05:43.618Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h1 id="goè¯­è¨€å‘ä¹‹for-range"><a href="#goè¯­è¨€å‘ä¹‹for-range" class="headerlink" title="goè¯­è¨€å‘ä¹‹for range"></a>goè¯­è¨€å‘ä¹‹for range</h1><blockquote><p>è¿™ç¯‡æ–‡ç« ç®€å•æ¸…æ™°åœ°è§£é‡Šäº†ä¹‹å‰éå†structåˆ‡ç‰‡æ—¶é‡åˆ°çš„ä¸€äº›æ€ªå¼‚ç°è±¡ï¼Œè¿™ä¸ªé—®é¢˜å½“æ—¶ä¹Ÿå†™äº†ä¸€ç¯‡æ–‡ç« æ¥è®¨è®ºï¼Œ<a href="https://cloudsjhan.github.io/2018/10/27/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8Bgolang%E4%B8%AD%E4%BF%AE%E6%94%B9struct%E7%9A%84slice%E7%9A%84%E5%80%BC/">æ–‡ç« åœ°å€</a>ï¼Œä½†æ˜¯æ²¡æœ‰åˆ‡ä¸­è¦ç‚¹ã€‚æ˜¨å¤©æ— æ„ä¸­çœ‹åˆ°è¿™ç¯‡åšå®¢ï¼Œè±ç„¶å¼€æœ—ã€‚</p></blockquote><hr><p>goåªæä¾›äº†ä¸€ç§å¾ªç¯æ–¹å¼ï¼Œå³forå¾ªç¯ï¼Œåœ¨ä½¿ç”¨æ—¶å¯ä»¥åƒcé‚£æ ·ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡for rangeæ–¹å¼éå†å®¹å™¨ç±»å‹å¦‚æ•°ç»„ã€åˆ‡ç‰‡å’Œæ˜ å°„ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨for rangeæ—¶ï¼Œå¦‚æœä½¿ç”¨ä¸å½“ï¼Œå°±ä¼šå‡ºç°ä¸€äº›é—®é¢˜ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œè¡Œä¸ºä¸å¦‚é¢„æœŸã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ç¤ºä¾‹ç¨‹åºå°†éå†ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå¹¶å°†åˆ‡ç‰‡çš„å€¼å½“æˆæ˜ å°„çš„é”®å’Œå€¼å­˜å…¥ï¼Œåˆ‡ç‰‡ç±»å‹æ˜¯ä¸€ä¸ªintå‹ï¼Œæ˜ å°„çš„ç±»å‹æ˜¯é”®ä¸ºintå‹ï¼Œå€¼ä¸º*intï¼Œå³å€¼æ˜¯ä¸€ä¸ªåœ°å€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    slice := []int&#123;0, 1, 2, 3&#125;</span><br><span class="line">    myMap := make(map[int]*int)</span><br><span class="line"></span><br><span class="line">    for index, value := range slice &#123;</span><br><span class="line">        myMap[index] = &amp;value</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(&quot;=====new map=====&quot;)</span><br><span class="line">    prtMap(myMap)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func prtMap(myMap map[int]*int) &#123;</span><br><span class="line">    for key, value := range myMap &#123;</span><br><span class="line">        fmt.Printf(&quot;map[%v]=%v\n&quot;, key, *value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=====new map=====</span><br><span class="line">map[3]=3</span><br><span class="line">map[0]=3</span><br><span class="line">map[1]=3</span><br><span class="line">map[2]=3</span><br></pre></td></tr></table></figure><p>ç”±è¾“å‡ºå¯ä»¥çŸ¥é“ï¼Œä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„è¾“å‡ºï¼Œæ­£ç¡®è¾“å‡ºåº”è¯¥å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">=====new map=====</span><br><span class="line">map[0]=0</span><br><span class="line">map[1]=1</span><br><span class="line">map[2]=2</span><br><span class="line">map[3]=3</span><br><span class="line">ï¼ˆæ— åºè¾“å‡ºï¼Œä½†æ˜¯å€¼æ˜¯0,1,2,3ï¼‰</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ç”±è¾“å‡ºå¯ä»¥çŸ¥é“ï¼Œæ˜ å°„çš„å€¼éƒ½ç›¸åŒä¸”éƒ½æ˜¯3ã€‚å…¶å®å¯ä»¥çŒœæµ‹æ˜ å°„çš„å€¼éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ï¼Œéå†åˆ°åˆ‡ç‰‡çš„æœ€åä¸€ä¸ªå…ƒç´ 3æ—¶ï¼Œå°†3å†™å…¥äº†è¯¥åœ°å€ï¼Œæ‰€ä»¥å¯¼è‡´æ˜ å°„æ‰€æœ‰å€¼éƒ½ç›¸åŒã€‚å…¶å®çœŸå®åŸå› ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå› ä¸ºfor rangeåˆ›å»ºäº†æ¯ä¸ªå…ƒç´ çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯ç›´æ¥è¿”å›æ¯ä¸ªå…ƒç´ çš„å¼•ç”¨ï¼Œå¦‚æœä½¿ç”¨è¯¥å€¼å˜é‡çš„åœ°å€ä½œä¸ºæŒ‡å‘æ¯ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œå°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œåœ¨è¿­ä»£æ—¶ï¼Œè¿”å›çš„å˜é‡æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ä¸­æ ¹æ®åˆ‡ç‰‡ä¾æ¬¡èµ‹å€¼çš„æ–°å˜é‡ï¼Œæ‰€ä»¥å€¼çš„åœ°å€æ€»æ˜¯ç›¸åŒçš„ï¼Œå¯¼è‡´ç»“æœä¸å¦‚é¢„æœŸã€‚</p><p>ä¿®æ­£åç¨‹åºå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    slice := []int&#123;0, 1, 2, 3&#125;</span><br><span class="line">    myMap := make(map[int]*int)</span><br><span class="line"></span><br><span class="line">    for index, value := range slice &#123;</span><br><span class="line">        num := value</span><br><span class="line">        myMap[index] = &amp;num</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(&quot;=====new map=====&quot;)</span><br><span class="line">    prtMap(myMap)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func prtMap(myMap map[int]*int) &#123;</span><br><span class="line">    for key, value := range myMap &#123;</span><br><span class="line">        fmt.Printf(&quot;map[%v]=%v\n&quot;, key, *value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">=====new map=====</span><br><span class="line">map[2]=2</span><br><span class="line">map[3]=3</span><br><span class="line">map[0]=0</span><br><span class="line">map[1]=1</span><br></pre></td></tr></table></figure><hr><p>å¼•ç”¨å£°æ˜ï¼šè¯¥åšå®¢æ¥è‡ªäº<a href="https://studygolang.com/articles/9701" target="_blank" rel="noopener">è¿™é‡Œ</a>.</p><hr>]]></content>
    
    <summary type="html">
    
      goè¯­è¨€å‘ä¹‹for range
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>è®°ç¬¬ä¸€ä¸ªVueé¡¹ç›®å°å‰å¹•åçš„ç»å†</title>
    <link href="https://cloudsjhan.github.io/2019/01/28/%E8%AE%B0%E7%AC%AC%E4%B8%80%E4%B8%AAVue%E9%A1%B9%E7%9B%AE%E5%8F%B0%E5%89%8D%E5%B9%95%E5%90%8E%E7%9A%84%E7%BB%8F%E5%8E%86/"/>
    <id>https://cloudsjhan.github.io/2019/01/28/è®°ç¬¬ä¸€ä¸ªVueé¡¹ç›®å°å‰å¹•åçš„ç»å†/</id>
    <published>2019-01-28T07:28:46.000Z</published>
    <updated>2019-01-28T15:32:19.505Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>0å‰ç«¯å¼€å‘ç»éªŒï¼Œåˆæ¬¡æ¥è§¦Vueï¼Œä»åç«¯åˆ°å‰ç«¯ï¼Œä»å¼€å‘ã€æ‰“åŒ…åˆ°éƒ¨ç½²ï¼Œå®Œæ•´çš„å†ç¨‹ã€‚</p><p>é¦–å…ˆç²—ç•¥é€šè¯»äº†ä¸€é<a href="https://cn.vuejs.org/" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼ŒåŠ¨æ‰‹ç”¨webpackæ­å»ºäº†ä¸€ä¸ªç®€å•çš„demoã€‚</p><p>çœ‹äº†Echartsçš„å®˜æ–¹<a href="https://echarts.baidu.com/examples/" target="_blank" rel="noopener">demo</a>ï¼Œäº†è§£äº†å‡ ç§æ•°æ®å›¾è¡¨çš„æ•°æ®ç»“æ„ã€‚å› ä¸ºæˆ‘è¦åšçš„é¡¹ç›®å°±æ˜¯è¦å°†åç«¯æ¥å£çš„æ•°æ®æ‹¿åˆ°ï¼Œç„¶åå›¾å½¢åŒ–çš„å½¢å¼å±•ç¤ºå‡ºæ¥ã€‚</p><h1 id="å¯¹æ¥åç«¯ï¼Œè¿›è¡ŒaxiosäºŒæ¬¡å¼€å‘"><a href="#å¯¹æ¥åç«¯ï¼Œè¿›è¡ŒaxiosäºŒæ¬¡å¼€å‘" class="headerlink" title="å¯¹æ¥åç«¯ï¼Œè¿›è¡ŒaxiosäºŒæ¬¡å¼€å‘"></a>å¯¹æ¥åç«¯ï¼Œè¿›è¡ŒaxiosäºŒæ¬¡å¼€å‘</h1><p>åœ¨æ„å»ºåº”ç”¨æ—¶éœ€è¦è®¿é—®ä¸€ä¸ª API å¹¶å±•ç¤ºå…¶æ•°æ®ï¼Œè°ƒç ”Vueçš„å¤šç§æ–¹å¼åé€‰æ‹©äº†å®˜æ–¹æ¨èçš„axioxã€‚</p><h1 id="ä»ajaxåˆ°fetchã€axios"><a href="#ä»ajaxåˆ°fetchã€axios" class="headerlink" title="ä»ajaxåˆ°fetchã€axios"></a>ä»ajaxåˆ°fetchã€axios</h1><p>å‰ç«¯æ˜¯ä¸ªå‘å±•è¿…é€Ÿçš„é¢†åŸŸï¼Œå‰ç«¯è¯·æ±‚è‡ªç„¶ä¹Ÿå‘å±•è¿…é€Ÿï¼Œä»åŸç”Ÿçš„XHRåˆ°jquery ajaxï¼Œå†åˆ°ç°åœ¨çš„axioså’Œfetchã€‚</p><h3 id="jquery-ajax"><a href="#jquery-ajax" class="headerlink" title="jquery ajax"></a>jquery ajax</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$.ajax(&#123;</span><br><span class="line">    type: &apos;POST&apos;,</span><br><span class="line">    url: url,</span><br><span class="line">    data: data,</span><br><span class="line">    dataType: dataType,</span><br><span class="line">    success: function() &#123;&#125;,</span><br><span class="line">    error: function() &#123;&#125;</span><br><span class="line">&#125;)</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><p>å®ƒæ˜¯å¯¹åŸç”ŸXHRçš„å°è£…ï¼Œè¿˜æ”¯æŒJSONPï¼Œéå¸¸æ–¹ä¾¿ï¼›çœŸçš„æ˜¯ç”¨è¿‡çš„éƒ½è¯´å¥½ã€‚ä½†æ˜¯éšç€reactï¼Œvueç­‰å‰ç«¯æ¡†æ¶çš„å…´èµ·ï¼Œjqueryæ—©å·²ä¸å¤å½“å¹´ä¹‹å‹‡ã€‚å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ajaxï¼Œä½†æ˜¯å´éœ€è¦å¼•å…¥æ•´ä¸ªjqueryï¼Œè¿™éå¸¸çš„ä¸åˆç†ï¼Œäºæ˜¯ä¾¿æœ‰äº†fetchçš„è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="fetch"><a href="#fetch" class="headerlink" title="fetch"></a>fetch</h3><p>fetchå·ç§°æ˜¯ajaxçš„æ›¿ä»£å“ï¼Œå®ƒçš„APIæ˜¯åŸºäºPromiseè®¾è®¡çš„ï¼Œæ—§ç‰ˆæœ¬çš„æµè§ˆå™¨ä¸æ”¯æŒPromiseï¼Œéœ€è¦ä½¿ç”¨polyfill es6-promise</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// åŸç”ŸXHR</span><br><span class="line">var xhr = new XMLHttpRequest();</span><br><span class="line">xhr.open(&apos;GET&apos;, url);</span><br><span class="line">xhr.onreadystatechange = function() &#123;</span><br><span class="line">    if (xhr.readyState === 4 &amp;&amp; xhr.status === 200) &#123;</span><br><span class="line">        console.log(xhr.responseText)   // ä»æœåŠ¡å™¨è·å–æ•°æ®</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">xhr.send()</span><br><span class="line">// fetch</span><br><span class="line">fetch(url)</span><br><span class="line">    .then(response =&gt; &#123;</span><br><span class="line">        if (response.ok) &#123;</span><br><span class="line">            response.json()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    .then(data =&gt; console.log(data))</span><br><span class="line">    .catch(err =&gt; console.log(err))</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥å¥½åƒæ˜¯æ–¹ä¾¿ç‚¹ï¼Œthené“¾å°±åƒä¹‹å‰ç†Ÿæ‚‰çš„callbackã€‚</p><p>åœ¨MDNä¸Šï¼Œè®²åˆ°å®ƒè·Ÿjquery ajaxçš„åŒºåˆ«ï¼Œè¿™ä¹Ÿæ˜¯fetchå¾ˆå¥‡æ€ªçš„åœ°æ–¹ï¼š</p><blockquote><p>å½“æ¥æ”¶åˆ°ä¸€ä¸ªä»£è¡¨é”™è¯¯çš„ HTTP çŠ¶æ€ç æ—¶ï¼Œä» fetch()è¿”å›çš„ Promise ä¸ä¼šè¢«æ ‡è®°ä¸º rejectï¼Œ å³ä½¿è¯¥ HTTP å“åº”çš„çŠ¶æ€ç æ˜¯ 404 æˆ– 500ã€‚ç›¸åï¼Œå®ƒä¼šå°† Promise çŠ¶æ€æ ‡è®°ä¸º resolve ï¼ˆä½†æ˜¯ä¼šå°† resolve çš„è¿”å›å€¼çš„ ok å±æ€§è®¾ç½®ä¸º false ï¼‰ï¼Œ ä»…å½“ç½‘ç»œæ•…éšœæ—¶æˆ–è¯·æ±‚è¢«é˜»æ­¢æ—¶ï¼Œæ‰ä¼šæ ‡è®°ä¸º rejectã€‚ é»˜è®¤æƒ…å†µä¸‹, fetch ä¸ä¼šä»æœåŠ¡ç«¯å‘é€æˆ–æ¥æ”¶ä»»ä½• cookies, å¦‚æœç«™ç‚¹ä¾èµ–äºç”¨æˆ· sessionï¼Œåˆ™ä¼šå¯¼è‡´æœªç»è®¤è¯çš„è¯·æ±‚ï¼ˆè¦å‘é€ cookiesï¼Œå¿…é¡»è®¾ç½® credentials é€‰é¡¹ï¼‰.</p></blockquote><p>çªç„¶æ„Ÿè§‰è¿™è¿˜ä¸å¦‚jquery ajaxå¥½ç”¨å‘¢ï¼Ÿåˆ«æ€¥ï¼Œå†æ­é…ä¸Šasync/awaitå°†ä¼šè®©æˆ‘ä»¬çš„å¼‚æ­¥ä»£ç æ›´åŠ ä¼˜é›…ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">async function test() &#123;</span><br><span class="line">    let response = await fetch(url);</span><br><span class="line">    let data = await response.json();</span><br><span class="line">    console.log(data)</span><br><span class="line">&#125;</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><p>çœ‹èµ·æ¥æ˜¯ä¸æ˜¯åƒåŒæ­¥ä»£ç ä¸€æ ·ï¼Ÿç®€ç›´å®Œç¾ï¼å¥½å§ï¼Œå…¶å®å¹¶ä¸å®Œç¾ï¼Œasync/awaitæ˜¯ES7çš„APIï¼Œç›®å‰è¿˜åœ¨è¯•éªŒé˜¶æ®µï¼Œè¿˜éœ€è¦æˆ‘ä»¬ä½¿ç”¨babelè¿›è¡Œè½¬è¯‘æˆES5ä»£ç ã€‚</p><p>è¿˜è¦æä¸€ä¸‹çš„æ˜¯ï¼Œfetchæ˜¯æ¯”è¾ƒåº•å±‚çš„APIï¼Œå¾ˆå¤šæƒ…å†µä¸‹éƒ½éœ€è¦æˆ‘ä»¬å†æ¬¡å°è£…ã€‚ æ¯”å¦‚ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// jquery ajax</span><br><span class="line">$.post(url, &#123;name: &apos;test&apos;&#125;)</span><br><span class="line">// fetch</span><br><span class="line">fetch(url, &#123;</span><br><span class="line">    method: &apos;POST&apos;,</span><br><span class="line">    body: Object.keys(&#123;name: &apos;test&apos;&#125;).map((key) =&gt; &#123;</span><br><span class="line">        return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(params[key]);</span><br><span class="line">    &#125;).join(&apos;&amp;&apos;)</span><br><span class="line">&#125;)</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><p>ç”±äºfetchæ˜¯æ¯”è¾ƒåº•å±‚çš„APIï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å°†å‚æ•°æ‹¼æ¥æˆâ€™name=testâ€™çš„æ ¼å¼ï¼Œè€Œjquery ajaxå·²ç»å°è£…å¥½äº†ã€‚æ‰€ä»¥fetchå¹¶ä¸æ˜¯å¼€ç®±å³ç”¨çš„ã€‚</p><p>å¦å¤–ï¼Œfetchè¿˜ä¸æ”¯æŒè¶…æ—¶æ§åˆ¶ã€‚</p><p>å“å‘€ï¼Œæ„Ÿè§‰fetchå¥½åƒåœ¾å•Šï¼Œï¼Œè¿˜éœ€è¦ç»§ç»­æˆé•¿ã€‚ã€‚</p><h3 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h3><p>axiosæ˜¯å°¤é›¨æºªå¤§ç¥æ¨èä½¿ç”¨çš„ï¼Œå®ƒä¹Ÿæ˜¯å¯¹åŸç”ŸXHRçš„å°è£…ã€‚å®ƒæœ‰ä»¥ä¸‹å‡ å¤§ç‰¹æ€§ï¼š</p><ul><li>å¯ä»¥åœ¨node.jsä¸­ä½¿ç”¨</li><li>æä¾›äº†å¹¶å‘è¯·æ±‚çš„æ¥å£</li><li>æ”¯æŒPromise API</li></ul><p>ç®€å•ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">axios(&#123;</span><br><span class="line">    method: &apos;GET&apos;,</span><br><span class="line">    url: url,</span><br><span class="line">&#125;)</span><br><span class="line">.then(res =&gt; &#123;console.log(res)&#125;)</span><br><span class="line">.catch(err =&gt; &#123;console.log(err)&#125;)</span><br></pre></td></tr></table></figure><p>å¹¶å‘è¯·æ±‚,å®˜æ–¹çš„å¹¶å‘ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">function getUserAccount() &#123;</span><br><span class="line">  return axios.get(&apos;/user/12345&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function getUserPermissions() &#123;</span><br><span class="line">  return axios.get(&apos;/user/12345/permissions&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">axios.all([getUserAccount(), getUserPermissions()])</span><br><span class="line">  .then(axios.spread(function (acct, perms) &#123;</span><br><span class="line">    // Both requests are now complete</span><br><span class="line">  &#125;));</span><br></pre></td></tr></table></figure><p>axiosä½“ç§¯æ¯”è¾ƒå°ï¼Œä¹Ÿæ²¡æœ‰ä¸Šé¢fetchçš„å„ç§é—®é¢˜ï¼Œæˆ‘è®¤ä¸ºæ˜¯å½“å‰æœ€å¥½çš„è¯·æ±‚æ–¹å¼ </p><p>è¯¦æƒ…å‚è€ƒ<a href="https://cn.vuejs.org/v2/cookbook/using-axios-to-consume-apis.html" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a></p><p>#äºŒæ¬¡å°è£…axios</p><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªrequest.js,å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> axios <span class="keyword">from</span> <span class="string">'axios'</span>;</span><br><span class="line"><span class="keyword">import</span> Qs <span class="keyword">from</span> <span class="string">'qs'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkStatus</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> msg = <span class="string">""</span>, level = <span class="string">"error"</span>;</span><br><span class="line">    <span class="keyword">switch</span> (err.response.status) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">401</span>:</span><br><span class="line">        msg = <span class="string">"æ‚¨è¿˜æ²¡æœ‰ç™»é™†"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">403</span>:</span><br><span class="line">        msg = <span class="string">"æ‚¨æ²¡æœ‰è¯¥é¡¹æƒé™"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">404</span>:</span><br><span class="line">        msg = <span class="string">"èµ„æºä¸å­˜åœ¨"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">500</span>:</span><br><span class="line">        msg = <span class="string">"æœåŠ¡å™¨å‘ç”Ÿäº†ç‚¹æ„å¤–"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      msg = res.data.msg;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (msg !== <span class="string">""</span> &amp;&amp; msg !== <span class="literal">undefined</span> &amp;&amp; msg !== <span class="literal">null</span>) &#123;</span><br><span class="line">        store.dispatch(<span class="string">'showSnackBar'</span>, &#123;<span class="attr">text</span>: msg, <span class="attr">level</span>: level&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> err.response;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">checkCode</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ((res.status &gt;= <span class="number">200</span> &amp;&amp; res.status &lt; <span class="number">400</span>) &amp;&amp; (res.data.status &gt;= <span class="number">200</span> &amp;&amp; res.data.status &lt; <span class="number">400</span>)) &#123;</span><br><span class="line">      <span class="keyword">let</span> msg = <span class="string">""</span>, level = <span class="string">"success"</span>;</span><br><span class="line">      <span class="keyword">switch</span> (res.data.status) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">201</span>:</span><br><span class="line">          msg = <span class="string">"åˆ›å»ºæˆåŠŸ"</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">204</span>:</span><br><span class="line">          msg = <span class="string">"åˆ é™¤æˆåŠŸ"</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        msg = res.data.success;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è¿™é‡Œå°è£…axiosçš„get,post,put,deleteç­‰æ–¹æ³•</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    get(url, params) &#123;</span><br><span class="line">      <span class="keyword">return</span> axios.get(</span><br><span class="line">        url,</span><br><span class="line">        params,</span><br><span class="line">      ).then(checkCode).catch(<span class="function">(<span class="params">error</span>)=&gt;</span>&#123;<span class="built_in">console</span>.log(error)&#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    post(url, data) &#123;</span><br><span class="line">      <span class="keyword">return</span> axios.post(</span><br><span class="line">        url,</span><br><span class="line">        Qs.stringify(data),</span><br><span class="line">      ).then(checkCode).catch(checkStatus);</span><br><span class="line">    &#125;,</span><br><span class="line">    put(url, data) &#123;</span><br><span class="line">      <span class="keyword">return</span> axios.put(</span><br><span class="line">        url,</span><br><span class="line">        Qs.stringify(data),</span><br><span class="line">      ).then(checkCode).catch(checkStatus);</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="keyword">delete</span>(url, data) &#123;</span><br><span class="line">      <span class="keyword">return</span> axios.delete(</span><br><span class="line">        url,</span><br><span class="line">        &#123;<span class="attr">data</span>: Qs.stringify(data)&#125;,</span><br><span class="line">      ).then(checkCode).catch(checkStatus);</span><br><span class="line">    &#125;,</span><br><span class="line">    patch(url, data) &#123;</span><br><span class="line">      <span class="keyword">return</span> axios.patch(</span><br><span class="line">        url,</span><br><span class="line">        data,</span><br><span class="line">      ).then(checkCode).catch(checkStatus);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸€ä¸ªapi.js,å­˜æ”¾åç«¯çš„æ¥å£ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯¼å…¥ä¸Šé¢çš„requestæ¨¡å—</span></span><br><span class="line"><span class="keyword">import</span> request <span class="keyword">from</span> <span class="string">'./request'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//å£°æ˜åç«¯æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> urlUserPrefix = <span class="string">'/v1/users'</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> urlProductPrefix = <span class="string">'/v1/products'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä½¿ç”¨å‰é¢å°è£…å¥½çš„æ–¹æ³•ï¼Œè°ƒç”¨åç«¯æ¥å£</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getUserslInfoLast = <span class="function"><span class="params">data</span> =&gt;</span> request.get(<span class="string">`<span class="subst">$&#123;urlUserPrefix&#125;</span>`</span>, data);</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> getProductsInfo = <span class="function"><span class="params">data</span> =&gt;</span> request.get(<span class="string">`<span class="subst">$&#123;urlProductPrefix&#125;</span>`</span>, data);</span><br></pre></td></tr></table></figure><p>åœ¨.vueæ–‡ä»¶ä¸­ä½¿ç”¨å®šä¹‰çš„æ–¹æ³•ï¼Œè·å–åç«¯æ¥å£çš„æ•°æ®ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span>  &#123;</span><br><span class="line"></span><br><span class="line">    components: &#123;</span><br><span class="line">    chart: ECharts,</span><br><span class="line">   </span><br><span class="line">  &#125;,</span><br><span class="line">  store,</span><br><span class="line">    name: <span class="string">'ResourceTypeLine'</span>,</span><br><span class="line">    data: <span class="function"><span class="params">()</span> =&gt;</span>(&#123;</span><br><span class="line">       seconds: <span class="number">-1</span>,</span><br><span class="line">      </span><br><span class="line">        <span class="comment">//define dataset</span></span><br><span class="line">   apiResponse:&#123;&#125;,</span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">    initOptions: &#123;</span><br><span class="line">        renderer: options.renderer || <span class="string">'canvas'</span></span><br><span class="line">      &#125;,</span><br><span class="line">      </span><br><span class="line">    mounted:<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">   </span><br><span class="line"><span class="keyword">this</span>.fTimeArray = <span class="keyword">this</span>.getFormatTime()</span><br><span class="line"></span><br><span class="line"><span class="comment">//è°ƒç”¨methodé‡Œé¢çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">this</span>.getUserInfo()</span><br><span class="line">   </span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line"><span class="comment">//å¼‚æ­¥æ–¹å¼è°ƒç”¨åç«¯æ¥å£</span></span><br><span class="line">       <span class="keyword">async</span> getUserInfo() &#123;</span><br><span class="line">        <span class="keyword">const</span> resThis = <span class="keyword">await</span> urlUserPrefix(&#123;</span><br><span class="line">          params: &#123;</span><br><span class="line">              <span class="comment">//getçš„å‚æ•°åœ¨è¿™é‡Œæ·»åŠ </span></span><br><span class="line">            beginTime: <span class="keyword">this</span>.fTimeArray[<span class="number">0</span>],</span><br><span class="line">            endTime: <span class="keyword">this</span>.fTimeArray[<span class="number">1</span>],</span><br><span class="line">          &#125;</span><br><span class="line">         </span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.apiResponseThisMonth = resThis.data</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="built_in">console</span>.log(err);</span><br><span class="line">        &#125; </span><br><span class="line">      &#125;,</span><br></pre></td></tr></table></figure><h1 id="å¼€å‘ç¯å¢ƒé…ç½®è·¨åŸŸ"><a href="#å¼€å‘ç¯å¢ƒé…ç½®è·¨åŸŸ" class="headerlink" title="å¼€å‘ç¯å¢ƒé…ç½®è·¨åŸŸ"></a>å¼€å‘ç¯å¢ƒé…ç½®è·¨åŸŸ</h1><p>ä¸ºäº†æ›´æ–¹ä¾¿åœ°ä¸åå°è”è°ƒï¼Œéœ€è¦åœ¨ç”¨vueè„šæ‰‹æ¶åˆ›å»ºåœ°é¡¹ç›®ä¸­ï¼Œåœ¨configç›®å½•åœ°index.jsè®¾ç½®proxytableæ¥å®ç°è·¨åŸŸè¯·æ±‚ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  build: &#123;</span><br><span class="line">    env: <span class="built_in">require</span>(<span class="string">'./prod.env'</span>),</span><br><span class="line">    index: path.resolve(__dirname, <span class="string">'../dist/index.html'</span>),</span><br><span class="line">    assetsRoot: path.resolve(__dirname, <span class="string">'../dist'</span>),</span><br><span class="line">    assetsSubDirectory: <span class="string">'static'</span>,</span><br><span class="line">    assetsPublicPath: <span class="string">'.'</span>,</span><br><span class="line">    productionSourceMap: <span class="literal">false</span>,</span><br><span class="line">    <span class="comment">// Gzip off by default as many popular static hosts such as</span></span><br><span class="line">    <span class="comment">// Surge or Netlify already gzip all static assets for you.</span></span><br><span class="line">    <span class="comment">// Before setting to `true`, make sure to:</span></span><br><span class="line">    <span class="comment">// npm install --save-dev compression-webpack-plugin</span></span><br><span class="line">    productionGzip: <span class="literal">false</span>,</span><br><span class="line">    productionGzipExtensions: [<span class="string">'js'</span>, <span class="string">'css'</span>],</span><br><span class="line">    <span class="comment">// Run the build command with an extra argument to</span></span><br><span class="line">    <span class="comment">// View the bundle analyzer report after build finishes:</span></span><br><span class="line">    <span class="comment">// `npm run build --report`</span></span><br><span class="line">    <span class="comment">// Set to `true` or `false` to always turn it on or off</span></span><br><span class="line">    bundleAnalyzerReport: process.env.npm_config_report</span><br><span class="line">  &#125;,</span><br><span class="line">  dev: &#123;</span><br><span class="line">    env: <span class="built_in">require</span>(<span class="string">'./dev.env'</span>),</span><br><span class="line">    port: <span class="number">8080</span>,</span><br><span class="line">    <span class="comment">// hosts:"0.0.0.0",</span></span><br><span class="line">    autoOpenBrowser: <span class="literal">true</span>,</span><br><span class="line">    assetsSubDirectory: <span class="string">'static'</span>,</span><br><span class="line">    assetsPublicPath: <span class="string">'/'</span>,</span><br><span class="line">    <span class="comment">//é…ç½®è·¨åŸŸè¯·æ±‚,æ³¨æ„é…ç½®å®Œä¹‹åéœ€è¦é‡å¯ç¼–è¯‘è¯¥é¡¹ç›®</span></span><br><span class="line">    proxyTable: &#123;</span><br><span class="line">      <span class="comment">//è¯·æ±‚åå­—å˜é‡å¯ä»¥è‡ªå·±å®šä¹‰</span></span><br><span class="line">      <span class="string">'/api'</span>: &#123;</span><br><span class="line">        target: <span class="string">'http://test.com'</span>, <span class="comment">// è¯·æ±‚çš„æ¥å£åŸŸåæˆ–IPåœ°å€ï¼Œå¼€å¤´æ˜¯httpæˆ–https</span></span><br><span class="line">        <span class="comment">// secure: false,  // å¦‚æœæ˜¯httpsæ¥å£ï¼Œéœ€è¦é…ç½®è¿™ä¸ªå‚æ•°</span></span><br><span class="line">        changeOrigin: <span class="literal">true</span>,<span class="comment">// æ˜¯å¦è·¨åŸŸï¼Œå¦‚æœæ¥å£è·¨åŸŸï¼Œéœ€è¦è¿›è¡Œè¿™ä¸ªå‚æ•°é…ç½®</span></span><br><span class="line">        pathRewrite: &#123;</span><br><span class="line">          <span class="string">'^/api'</span>:<span class="string">""</span><span class="comment">//è¡¨ç¤ºéœ€è¦rewriteé‡å†™è·¯å¾„  </span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment">// CSS Sourcemaps off by default because relative paths are "buggy"</span></span><br><span class="line">    <span class="comment">// with this option, according to the CSS-Loader README</span></span><br><span class="line">    <span class="comment">// (https://github.com/webpack/css-loader#sourcemaps)</span></span><br><span class="line">    <span class="comment">// In our experience, they generally work as expected,</span></span><br><span class="line">    <span class="comment">// just be aware of this issue when enabling this option.</span></span><br><span class="line">    cssSourceMap: <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="vue-é¡¹ç›®æ‰“åŒ…éƒ¨ç½²ï¼Œé€šè¿‡nginx-è§£å†³è·¨åŸŸé—®é¢˜"><a href="#vue-é¡¹ç›®æ‰“åŒ…éƒ¨ç½²ï¼Œé€šè¿‡nginx-è§£å†³è·¨åŸŸé—®é¢˜" class="headerlink" title="vue é¡¹ç›®æ‰“åŒ…éƒ¨ç½²ï¼Œé€šè¿‡nginx è§£å†³è·¨åŸŸé—®é¢˜"></a>vue é¡¹ç›®æ‰“åŒ…éƒ¨ç½²ï¼Œé€šè¿‡nginx è§£å†³è·¨åŸŸé—®é¢˜</h1><p>â€‹     æœ€è¿‘å°†å…¬å¸vue é¡¹ç›®æ‰“åŒ…éƒ¨ç½²æœåŠ¡å™¨æ—¶ï¼Œäº§ç”Ÿäº†ä¸€ç‚¹å°æ’æ›²ï¼Œå¼€å‘ç¯å¢ƒä¸­é…ç½®çš„è·¨åŸŸåœ¨å°†é¡¹ç›®æ‰“åŒ…ä¸ºé™æ€æ–‡ä»¶æ—¶æ˜¯æ²¡æœ‰ç”¨çš„ ï¼Œå°±æƒ³åˆ°äº†ç”¨ nginx é€šè¿‡åå‘ä»£ç†çš„æ–¹å¼è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªå·¨å¤§çš„å‘ï¼Œåé¢ä¼šè®²åˆ°ã€‚</p><h4 id="å‰ææ¡ä»¶"><a href="#å‰ææ¡ä»¶" class="headerlink" title="å‰ææ¡ä»¶"></a>å‰ææ¡ä»¶</h4><p>liunx ä¸‹ nginx å®‰è£…é…ç½®ï¼ˆå°†ä¸åšå¤šçš„é˜è¿°ï¼Œè¯·è‡ªè¡Œç™¾åº¦ï¼‰</p><h4 id="é…ç½®nginx"><a href="#é…ç½®nginx" class="headerlink" title="é…ç½®nginx"></a>é…ç½®nginx</h4><ul><li>é€šè¿‡ Xshell è¿æ¥ liunx æœåŠ¡å™¨ ï¼Œæ‰“å¼€ nginx.conf é…ç½®æ–‡ä»¶ï¼Œæˆ–é€šè¿‡ WinSCP ç›´æ¥æ‰“å¼€å¹¶ç¼–è¾‘nginx.confæ–‡ä»¶ ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©åè€… ã€‚ï¼ˆå…·ä½“é…ç½®æ–‡ä»¶çš„è·¯å¾„æ ¹æ®ä½ å®‰è£…æ—¶å†³å®šï¼‰</li><li>åœ¨é…ç½®æ–‡ä»¶ä¸­æ–°å¢ä¸€ä¸ªserver</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># æ–°å¢çš„æœåŠ¡ </span><br><span class="line"># æ–°å¢çš„æœåŠ¡</span><br><span class="line">server &#123;</span><br><span class="line">listen       8086; # ç›‘å¬çš„ç«¯å£</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">root /var/www;  # vue æ‰“åŒ…åé™æ€æ–‡ä»¶å­˜æ”¾çš„åœ°å€</span><br><span class="line">index index.html; # é»˜è®¤ä¸»é¡µåœ°å€</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /v1 &#123;</span><br><span class="line">proxy_pass http://47.106.184.89:9010/v1; # ä»£ç†æ¥å£åœ°å€</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location /testApi &#123;</span><br><span class="line">proxy_pass http://40.106.197.89:9086/testApi; # ä»£ç†æ¥å£åœ°å€</span><br><span class="line">&#125;</span><br><span class="line">error_page   500 502 503 504  /50x.html;</span><br><span class="line">location = /50x.html &#123;</span><br><span class="line">root   html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">å¤åˆ¶ä»£ç </span><br></pre></td></tr></table></figure><ul><li>è§£é‡Šè¯´æ˜</li></ul><p>/var/wwwæ˜¯æˆ‘å½“å‰å°†vue æ–‡ä»¶æ‰“åŒ…åå­˜æ”¾åœ¨ liunxä¸‹çš„è·¯å¾„ ï¼Œ</p><p> å½“æˆ‘ä»¬å¯åŠ¨ nginx å å°±å¯ä»¥é€šè¿‡<a href="http://ipåœ°å€:8086/è®¿é—®åˆ°vue" target="_blank" rel="noopener">http://ipåœ°å€:8086/è®¿é—®åˆ°vue</a> æ‰“åŒ…çš„é™æ€æ–‡ä»¶ã€‚</p><p>2.<code>location /v1 æŒ‡æ‹¦æˆªä»¥</code>v1<code>å¼€å¤´çš„è¯·æ±‚ï¼Œhttpè¯·æ±‚æ ¼å¼ä¸º</code><a href="http://ipåœ°å€:8086/v1/***`,è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼ä¸€å®šè¦æŒ‰ç…§ä¸Šé¢çš„é…ç½®æ–‡ä»¶**ï¼šproxy_pass" target="_blank" rel="noopener">http://ipåœ°å€:8086/v1/***`,è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼ä¸€å®šè¦æŒ‰ç…§ä¸Šé¢çš„é…ç½®æ–‡ä»¶**ï¼šproxy_pass</a> <a href="http://47.106.184.89:9010/v1" target="_blank" rel="noopener">http://47.106.184.89:9010/v1</a>; # ä»£ç†æ¥å£åœ°å€<strong>ï¼Œå¦‚æœä½ åƒæˆ‘ä¸€å¼€å§‹å†™çš„</strong>proxy_pass <a href="http://47.106.184.89:9010/" target="_blank" rel="noopener">http://47.106.184.89:9010/</a>; # ä»£ç†æ¥å£åœ°å€**ï¼Œä½ æ°¸è¿œä¹ŸåŒ¹é…ä¸åˆ°å¯¹åº”çš„æ¥å£ï¼ã€‚</p><p>proxy_pass <a href="http://47.106.197.89:9093/v1;`" target="_blank" rel="noopener">http://47.106.197.89:9093/v1;`</a> å½“æ‹¦æˆªåˆ°éœ€è¦å¤„ç†çš„è¯·æ±‚æ—¶ï¼Œå°†æ‹¦æˆªè¯·æ±‚ä»£ç†åˆ°çš„ æ¥å£åœ°å€ã€‚</p><h1 id="webpackæ‰“åŒ…"><a href="#webpackæ‰“åŒ…" class="headerlink" title="webpackæ‰“åŒ…"></a>webpackæ‰“åŒ…</h1><p>ä¸‹é¢æ˜¯config/index.jsé…ç½®æ–‡ä»¶</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// see http://vuejs-templates.github.io/webpack for documentation.</span><br><span class="line">var path = require(&apos;path&apos;)</span><br><span class="line"></span><br><span class="line">module.exports = &#123;</span><br><span class="line">  build: &#123;</span><br><span class="line">    env: require(&apos;./prod.env&apos;),</span><br><span class="line">    index: path.resolve(__dirname, &apos;../dist/index.html&apos;),</span><br><span class="line">    assetsRoot: path.resolve(__dirname, &apos;../dist&apos;),</span><br><span class="line">    assetsSubDirectory: &apos;static&apos;,</span><br><span class="line">    assetsPublicPath: &apos;.&apos;,</span><br><span class="line">    productionSourceMap: false,</span><br><span class="line">    // Gzip off by default as many popular static hosts such as</span><br><span class="line">    // Surge or Netlify already gzip all static assets for you.</span><br><span class="line">    // Before setting to `true`, make sure to:</span><br><span class="line">    // npm install --save-dev compression-webpack-plugin</span><br><span class="line">    productionGzip: false,</span><br><span class="line">    productionGzipExtensions: [&apos;js&apos;, &apos;css&apos;],</span><br><span class="line">    // Run the build command with an extra argument to</span><br><span class="line">    // View the bundle analyzer report after build finishes:</span><br><span class="line">    // `npm run build --report`</span><br><span class="line">    // Set to `true` or `false` to always turn it on or off</span><br><span class="line">    bundleAnalyzerReport: process.env.npm_config_report</span><br><span class="line">  &#125;,</span><br><span class="line">  dev: &#123;</span><br><span class="line">    env: require(&apos;./dev.env&apos;),</span><br><span class="line">    port: 8080,</span><br><span class="line">    // hosts:&quot;0.0.0.0&quot;,</span><br><span class="line">    autoOpenBrowser: true,</span><br><span class="line">    assetsSubDirectory: &apos;static&apos;,</span><br><span class="line">    assetsPublicPath: &apos;/&apos;,</span><br><span class="line">    //é…ç½®è·¨åŸŸè¯·æ±‚,æ³¨æ„é…ç½®å®Œä¹‹åéœ€è¦é‡å¯ç¼–è¯‘è¯¥é¡¹ç›®</span><br><span class="line">    proxyTable: &#123;</span><br><span class="line">      //è¯·æ±‚åå­—å˜é‡å¯ä»¥è‡ªå·±å®šä¹‰</span><br><span class="line">      &apos;/api&apos;: &#123;</span><br><span class="line">        target: &apos;http://billing.hybrid.cloud.ctripcorp.com&apos;, // è¯·æ±‚çš„æ¥å£åŸŸåæˆ–IPåœ°å€ï¼Œå¼€å¤´æ˜¯httpæˆ–https</span><br><span class="line">        // secure: false,  // å¦‚æœæ˜¯httpsæ¥å£ï¼Œéœ€è¦é…ç½®è¿™ä¸ªå‚æ•°</span><br><span class="line">        changeOrigin: true,// æ˜¯å¦è·¨åŸŸï¼Œå¦‚æœæ¥å£è·¨åŸŸï¼Œéœ€è¦è¿›è¡Œè¿™ä¸ªå‚æ•°é…ç½®</span><br><span class="line">        pathRewrite: &#123;</span><br><span class="line">          &apos;^/api&apos;:&quot;&quot;//è¡¨ç¤ºéœ€è¦rewriteé‡å†™è·¯å¾„  </span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    // CSS Sourcemaps off by default because relative paths are &quot;buggy&quot;</span><br><span class="line">    // with this option, according to the CSS-Loader README</span><br><span class="line">    // (https://github.com/webpack/css-loader#sourcemaps)</span><br><span class="line">    // In our experience, they generally work as expected,</span><br><span class="line">    // just be aware of this issue when enabling this option.</span><br><span class="line">    cssSourceMap: false</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h1><p>æ‰“åŒ…Dockeré•œåƒ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">FROM Nginx:base</span><br><span class="line"></span><br><span class="line">MAINTAINER author &lt;hantmac@outlook.com&gt;</span><br><span class="line"></span><br><span class="line">WORKDIR /opt/workDir</span><br><span class="line">RUN mkdir /var/log/workDir</span><br><span class="line"></span><br><span class="line">COPY dist /var/www</span><br><span class="line"></span><br><span class="line">ADD  nginx/default.conf /etc/nginx/conf.d/default.conf</span><br><span class="line"></span><br><span class="line">ENTRYPOINT nginx -g "daemon off;"</span><br></pre></td></tr></table></figure><h1 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h1><p>è¿™æ˜¯é¦–æ¬¡æ¥è§¦å‰ç«¯çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼ŒæœŸé—´ç»å†äº†ä»åç«¯æ¥å£å¼€å‘ï¼Œå‰ç«¯æ¡†æ¶é€‰å‹ï¼ˆä¸€åº¦æƒ³è¦ç”¨reactï¼Œåæ¥è¿˜æ˜¯æ”¾å¼ƒï¼‰ï¼Œç†Ÿæ‚‰Vueï¼Œåˆ°ç»„ä»¶å¼€å‘ï¼Œwebpackæ„å»ºï¼ŒNginxéƒ¨ç½²ï¼ŒDockerå‘å¸ƒçš„å®Œæ•´è¿‡ç¨‹ã€‚è™½ç„¶é¡µé¢æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æœŸé—´çš„é‡‡å‘æ— æ•°ï¼Œåé¢è¿˜è¦ç»§ç»­åŠªåŠ›ï¼</p><hr>]]></content>
    
    <summary type="html">
    
      è®°ç¬¬ä¸€ä¸ªVueé¡¹ç›®å°å‰å¹•åçš„ç»å†
    
    </summary>
    
      <category term="Frontend" scheme="https://cloudsjhan.github.io/categories/Frontend/"/>
    
    
      <category term="Vue" scheme="https://cloudsjhan.github.io/tags/Vue/"/>
    
      <category term="Frontend" scheme="https://cloudsjhan.github.io/tags/Frontend/"/>
    
  </entry>
  
  <entry>
    <title>20181202-Postmortem-debugging-Go-services-with-Delve[ç¿»è¯‘]</title>
    <link href="https://cloudsjhan.github.io/2019/01/20/20181202-Postmortem-debugging-Go-services-with-Delve-%E7%BF%BB%E8%AF%91/"/>
    <id>https://cloudsjhan.github.io/2019/01/20/20181202-Postmortem-debugging-Go-services-with-Delve-ç¿»è¯‘/</id>
    <published>2019-01-20T15:39:57.000Z</published>
    <updated>2019-01-20T16:05:15.383Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h1 id="ä½¿ç”¨Delve-è°ƒè¯•GoæœåŠ¡çš„ä¸€æ¬¡ç»å†"><a href="#ä½¿ç”¨Delve-è°ƒè¯•GoæœåŠ¡çš„ä¸€æ¬¡ç»å†" class="headerlink" title="ä½¿ç”¨Delve è°ƒè¯•GoæœåŠ¡çš„ä¸€æ¬¡ç»å†"></a>ä½¿ç”¨Delve è°ƒè¯•GoæœåŠ¡çš„ä¸€æ¬¡ç»å†</h1><hr><blockquote><p>Vladimir Varankin å†™äº 2018/12/02</p></blockquote><p>æŸå¤©ï¼Œæˆ‘ä»¬ç”Ÿäº§æœåŠ¡ä¸Šçš„å‡ ä¸ªå®ä¾‹çªç„¶ä¸èƒ½å¤„ç†å¤–éƒ¨è¿›å…¥çš„æµé‡ï¼ŒHTTPè¯·æ±‚æˆåŠŸé€šè¿‡è´Ÿè½½å‡è¡¡åˆ°è¾¾å®ä¾‹ï¼Œä½†æ˜¯ä¹‹åå´hangä½äº†ã€‚æ¥ä¸‹æ¥è®°å½•çš„æ˜¯ä¸€æ¬¡è°ƒè¯•åœ¨çº¿GoæœåŠ¡çš„æƒŠå¿ƒåŠ¨é­„çš„ç»å†ã€‚</p><p>æ­£æ˜¯ä¸‹é¢é€æ­¥æ¼”ç¤ºçš„æ“ä½œï¼Œå¸®åŠ©æˆ‘ä»¬å®šä½äº†é—®é¢˜çš„æ ¹æœ¬åŸå› ã€‚</p><p>ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†èµ·ä¸€ä¸ªGoå†™çš„HTTPæœåŠ¡ä½œä¸ºè°ƒè¯•ä½¿ç”¨ï¼Œè¿™ä¸ªæœåŠ¡å®ç°çš„ç»†èŠ‚æš‚æ—¶ä¸åšæ·±ç©¶ï¼ˆä¹‹åæˆ‘ä»¬å°†æ·±å…¥åˆ†æä»£ç ï¼‰ã€‚ä¸€ä¸ªçœŸå®çš„ç”Ÿäº§åº”ç”¨å¯èƒ½åŒ…å«å¾ˆå¤šç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å®ç°äº†ä¸šåŠ¡ç½—å’ŒæœåŠ¡çš„åŸºç¡€æ¶æ„ã€‚æˆ‘ä»¬å¯ä»¥ç¡®ä¿¡ï¼Œè¿™äº›åº”ç”¨å·²ç»åœ¨ç”Ÿäº§ç¯å¢ƒâ€œèº«ç»ç™¾æˆ˜â€ :)ã€‚</p><p>æºä»£ç ä»¥åŠé…ç½®ç»†èŠ‚å¯ä»¥æŸ¥çœ‹<a href="https://github.com/narqo/postmortem-debug-go" target="_blank" rel="noopener">GitHubä»“åº“</a>ã€‚ä¸ºäº†å®Œæˆæ¥ä¸‹æ¥çš„å·¥ä½œï¼Œä½ éœ€è¦ä¸€å°Linuxç³»ç»Ÿçš„è™šæœºï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨<a href="https://github.com/sevos/vagrant-hostmanager" target="_blank" rel="noopener">vagrant-hostmanager</a>æ’ä»¶ã€‚<code>Vagrantfile</code>åœ¨GitHubä»“åº“çš„æ ¹ç›®å½•ï¼Œå¯ä»¥æŸ¥çœ‹æ›´å¤šç»†èŠ‚ã€‚</p><p>è®©æˆ‘ä»¬å¼€å¯è™šæœºï¼Œæ„å»ºHTTPæœåŠ¡å¹¶ä¸”è¿è¡Œèµ·æ¥ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vagrant up</span></span><br><span class="line">Bringing machine 'server-test-1' up with 'virtualbox' provider...</span><br><span class="line"></span><br><span class="line"><span class="meta">$</span><span class="bash"> vagrant ssh server-test-1</span></span><br><span class="line">Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-33-generic x86_64)</span><br><span class="line">Â·Â·Â·</span><br><span class="line">vagrant@server-test-1:~$ cd /vagrant/example/server</span><br><span class="line">vagrant@server-test-1:/vagrant/example/server$ go build</span><br><span class="line">vagrant@server-test-1:/vagrant/example/server$ ./server --addr=:10080</span><br><span class="line">server listening addr=:10080</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>curl</code>å‘é€è¯·æ±‚åˆ°æ‰€èµ·çš„HTTPæœåŠ¡ï¼Œå¯ä»¥åˆ¤æ–­å…¶æ˜¯å¦å¤„äºå·¥ä½œçŠ¶æ€ï¼Œæ–°å¼€ä¸€ä¸ªterminalå¹¶æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl <span class="string">'http://server-test-1:10080'</span></span></span><br><span class="line">OK</span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ¨¡æ‹Ÿå¤±è´¥çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å‘é€å¤§é‡è¯·æ±‚åˆ°HTTPæœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨HTTP benchmarkæµ‹è¯•å·¥å…·<a href="https://github.com/wg/wrk" target="_blank" rel="noopener">wrk</a>è¿›è¡Œæ¨¡æ‹Ÿã€‚æˆ‘çš„MacBookæ˜¯4æ ¸çš„ï¼Œæ‰€ä»¥ä½¿ç”¨4ä¸ªçº¿ç¨‹è¿è¡Œwrkï¼Œèƒ½å¤Ÿäº§ç”Ÿ1000ä¸ªè¿æ¥ï¼ŒåŸºæœ¬èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> wrk -d1m -t4 -c1000 <span class="string">'http://server-test-1:10080'</span></span></span><br><span class="line">Running 1m test @ http://server-test-1:10080</span><br><span class="line">  4 threads and 1000 connections</span><br><span class="line">  Â·Â·Â·</span><br></pre></td></tr></table></figure><p>ä¸€ä¼šçš„æ—¶é—´ï¼ŒæœåŠ¡å™¨hangä½äº†ã€‚ç”šè‡³ç­‰wrkè·‘å®Œä¹‹åï¼ŒæœåŠ¡å™¨å·²ç»ä¸èƒ½å¤„ç†ä»»ä½•è¯·æ±‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> curl --max-time 5 <span class="string">'http://server-test-1:10080/'</span></span></span><br><span class="line">curl: (28) Operation timed out after 5001 milliseconds with 0 bytes received</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡åˆ°éº»çƒ¦äº†ï¼è®©æˆ‘ä»¬åˆ†æä¸€ä¸‹ã€‚</p><hr><p><em>åœ¨æˆ‘ä»¬ç”Ÿäº§æœåŠ¡çš„çœŸå®åœºæ™¯ä¸­ï¼ŒæœåŠ¡å™¨èµ·æ¥ä»¥åï¼Œgoroutinesçš„æ•°é‡ç”±äºè¯·æ±‚çš„å¢å¤šè€Œè¿…é€Ÿå¢åŠ ï¼Œä¹‹åä¾¿å¤±å»å“åº”ã€‚å¯¹pprofè°ƒè¯•å¥æŸ„çš„è¯·æ±‚å˜å¾—éå¸¸éå¸¸æ…¢ï¼Œçœ‹èµ·æ¥å°±åƒæœåŠ¡å™¨â€œæ­»æ‰äº†â€ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå°è¯•ä½¿ç”¨<code>SIGQUIT</code>å‘½ä»¤æ€æ‰è¿›ç¨‹ä»¥<a href="https://golang.org/pkg/os/signal/#hdr-Default_behavior_of_signals_in_Go_programs" target="_blank" rel="noopener">é‡Šæ”¾æ‰€è¿è¡Œgoroutineså †æ ˆ</a>ï¼Œä½†æ˜¯æ”¶ä¸åˆ°ä»»ä½•æ•ˆæœã€‚</em></p><h2 id="GDBå’ŒCoredump"><a href="#GDBå’ŒCoredump" class="headerlink" title="GDBå’ŒCoredump"></a>GDBå’ŒCoredump</h2><p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GDBï¼ˆGNU Debuggerï¼‰å°è¯•è¿›å…¥æ­£åœ¨è¿è¡Œçš„æœåŠ¡å†…éƒ¨ã€‚</p><hr><p><em>åœ¨ç”Ÿäº§ç¯å¢ƒè¿è¡Œè°ƒè¯•å™¨å¯èƒ½éœ€è¦é¢å¤–çš„æƒé™ï¼Œæ‰€ä»¥ä¸ä½ çš„å›¢é˜Ÿæå‰æ²Ÿé€šæ˜¯å¾ˆæ˜æ™ºçš„ã€‚</em></p><hr><p>åœ¨è™šæœºä¸Šå†å¼€å¯ä¸€ä¸ªSSHä¼šè¯ï¼Œæ‰¾åˆ°æœåŠ¡å™¨çš„è¿›ç¨‹idå¹¶ä½¿ç”¨è°ƒè¯•å™¨è¿æ¥åˆ°è¯¥è¿›ç¨‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> vagrant ssh server-test-1</span></span><br><span class="line">Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-33-generic x86_64)</span><br><span class="line">Â·Â·Â·</span><br><span class="line">vagrant@server-test-1:~$ pgrep server</span><br><span class="line">1628</span><br><span class="line">vagrant@server-test-1:~$ cd /vagrant</span><br><span class="line">vagrant@server-test-1:/vagrant$ sudo gdb --pid=1628 example/server/server</span><br><span class="line">GNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-git</span><br><span class="line">Â·Â·Â·</span><br></pre></td></tr></table></figure><p>è°ƒè¯•å™¨è¿æ¥åˆ°æœåŠ¡å™¨è¿›ç¨‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡ŒGDBçš„<code>bt</code>å‘½ä»¤ï¼ˆaka backtraceï¼‰æ¥æ£€æŸ¥å½“å‰çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(gdb) bt</span><br><span class="line"><span class="meta">#</span><span class="bash">0  runtime.futex () at /usr/<span class="built_in">local</span>/go/src/runtime/sys_linux_amd64.s:532</span></span><br><span class="line"><span class="meta">#</span><span class="bash">1  0x000000000042b08b <span class="keyword">in</span> runtime.futexsleep (addr=0xa9a160 &lt;runtime.m0+320&gt;, ns=-1, val=0) at /usr/<span class="built_in">local</span>/go/src/runtime/os_linux.go:46</span></span><br><span class="line"><span class="meta">#</span><span class="bash">2  0x000000000040c382 <span class="keyword">in</span> runtime.notesleep (n=0xa9a160 &lt;runtime.m0+320&gt;) at /usr/<span class="built_in">local</span>/go/src/runtime/lock_futex.go:151</span></span><br><span class="line"><span class="meta">#</span><span class="bash">3  0x0000000000433b4a <span class="keyword">in</span> runtime.stoplockedm () at /usr/<span class="built_in">local</span>/go/src/runtime/proc.go:2165</span></span><br><span class="line"><span class="meta">#</span><span class="bash">4  0x0000000000435279 <span class="keyword">in</span> runtime.schedule () at /usr/<span class="built_in">local</span>/go/src/runtime/proc.go:2565</span></span><br><span class="line"><span class="meta">#</span><span class="bash">5  0x00000000004353fe <span class="keyword">in</span> runtime.park_m (gp=0xc000066d80) at /usr/<span class="built_in">local</span>/go/src/runtime/proc.go:2676</span></span><br><span class="line"><span class="meta">#</span><span class="bash">6  0x000000000045ae1b <span class="keyword">in</span> runtime.mcall () at /usr/<span class="built_in">local</span>/go/src/runtime/asm_amd64.s:299</span></span><br><span class="line"><span class="meta">#</span><span class="bash">7  0x000000000045ad39 <span class="keyword">in</span> runtime.rt0_go () at /usr/<span class="built_in">local</span>/go/src/runtime/asm_amd64.s:201</span></span><br><span class="line"><span class="meta">#</span><span class="bash">8  0x0000000000000000 <span class="keyword">in</span> ?? ()</span></span><br></pre></td></tr></table></figure><p>è¯´å®è¯æˆ‘å¹¶ä¸æ˜¯GDBçš„ä¸“å®¶ï¼Œä½†æ˜¯æ˜¾è€Œæ˜“è§Goè¿è¡Œæ—¶ä¼¼ä¹ä½¿çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€äº†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>è°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ˜¯ä¸æ˜æ™ºçš„ï¼Œä¸å¦‚å°†è¯¥çº¿ç¨‹çš„coredumpä¿å­˜ä¸‹æ¥ï¼Œè¿›è¡Œç¦»çº¿åˆ†æã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GDBçš„<code>gcore</code>å‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†coreæ–‡ä»¶ä¿å­˜åœ¨å½“å‰å·¥ä½œç›®å½•å¹¶å‘½åä¸º<code>core.&lt;process_id&gt;</code>ã€‚</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">(gdb) gcore</span><br><span class="line">Saved corefile core.1628</span><br><span class="line">(gdb) quit</span><br><span class="line">A debugging session is active.</span><br><span class="line"></span><br><span class="line">Inferior 1 [process 1628] will be detached.</span><br><span class="line"></span><br><span class="line">Quit anyway? (y or n) y</span><br><span class="line">Detaching from program: /vagrant/example/server/server, process 1628</span><br></pre></td></tr></table></figure><p>coreæ–‡ä»¶ä¿å­˜åï¼ŒæœåŠ¡å™¨æ²¡å¿…è¦ç»§ç»­è¿è¡Œï¼Œä½¿ç”¨<code>kill -9</code>ç»“æŸå®ƒã€‚</p><p>æˆ‘ä»¬èƒ½å¤Ÿæ³¨æ„åˆ°ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ï¼Œcoreæ–‡ä»¶ä¾ç„¶ä¼šå¾ˆå¤§ï¼ˆæˆ‘è¿™ä¸€ä»½æ˜¯1.2Gï¼‰,å¯¹äºç”Ÿäº§çš„æœåŠ¡æ¥è¯´ï¼Œå¯èƒ½ä¼šæ›´åŠ å·¨å¤§ã€‚</p><p><em>å¦‚æœéœ€è¦äº†è§£æ›´å¤šä½¿ç”¨GDBè°ƒè¯•çš„æŠ€å·§ï¼Œå¯ä»¥ç»§ç»­é˜…è¯»<a href="https://golang.org/doc/gdb" target="_blank" rel="noopener">ä½¿ç”¨GDBè°ƒè¯•Goä»£ç </a>ã€‚</em></p><h2 id="ä½¿ç”¨Delveè°ƒè¯•å™¨"><a href="#ä½¿ç”¨Delveè°ƒè¯•å™¨" class="headerlink" title="ä½¿ç”¨Delveè°ƒè¯•å™¨"></a>ä½¿ç”¨Delveè°ƒè¯•å™¨</h2><p><a href="https://github.com/derekparker/delve" target="_blank" rel="noopener">Delve</a>æ˜¯ä¸€ä¸ªé’ˆå¯¹Goç¨‹åºçš„è°ƒè¯•å™¨ã€‚å®ƒç±»ä¼¼äºGDBï¼Œä½†æ˜¯æ›´å…³æ³¨Goçš„è¿è¡Œæ—¶ã€æ•°æ®ç»“æ„ä»¥åŠå…¶ä»–å†…éƒ¨çš„æœºåˆ¶ã€‚</p><p>å¦‚æœä½ å¯¹Delveçš„å†…éƒ¨å®ç°æœºåˆ¶å¾ˆæ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆæˆ‘ååˆ†æ¨èä½ é˜…è¯»Alessandro Arzilliåœ¨GopherCon EU 2018æ‰€ä½œçš„æ¼”è®²ï¼Œ[<a href="https://www.youtube.com/watch?v=IKnTr7Zms1k" target="_blank" rel="noopener">Internal Architecture of Delve, a Debugger For Go</a>]ã€‚</p><p>Delveæ˜¯ç”¨Goå†™çš„ï¼Œæ‰€ä»¥å®‰è£…èµ·æ¥éå¸¸ç®€å•ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> go get -u github.com/derekparker/delve/cmd/dlv</span></span><br></pre></td></tr></table></figure><p>Delveå®‰è£…ä»¥åï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿è¡Œ<code>dlv core &lt;path to service binary&gt; &lt;core file&gt;</code>æ¥åˆ†æcoreæ–‡ä»¶ã€‚æˆ‘ä»¬å…ˆåˆ—å‡ºæ‰§è¡Œcoredumpæ—¶æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰goroutinesã€‚Delveçš„<code>goroutines</code>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dlv core example/server/server core.1628</span></span><br><span class="line"></span><br><span class="line">(dlv) goroutines</span><br><span class="line">  Â·Â·Â·</span><br><span class="line">  Goroutine 4611 - User: /vagrant/example/server/metrics.go:113 main.(*Metrics).CountS (0x703948)</span><br><span class="line">  Goroutine 4612 - User: /vagrant/example/server/metrics.go:113 main.(*Metrics).CountS (0x703948)</span><br><span class="line">  Goroutine 4613 - User: /vagrant/example/server/metrics.go:113 main.(*Metrics).CountS (0x703948)</span><br></pre></td></tr></table></figure><p>ä¸å¹¸çš„æ˜¯ï¼Œåœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸‹ï¼Œè¿™ä¸ªåˆ—è¡¨å¯èƒ½ä¼šå¾ˆé•¿ï¼Œç”šè‡³ä¼šè¶…å‡ºterminalçš„ç¼“å†²åŒºã€‚ç”±äºæœåŠ¡å™¨ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„goroutineï¼Œæ‰€ä»¥<code>goroutines</code>å‘½ä»¤ç”Ÿæˆçš„åˆ—è¡¨å¯èƒ½ä¼šæœ‰ç™¾ä¸‡æ¡ã€‚æˆ‘ä»¬å‡è®¾ç°åœ¨å·²ç»é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œå¹¶æƒ³ä¸€ä¸ªæ–¹æ³•æ¥è§£å†³å®ƒã€‚</p><p>Delveæ”¯æŒâ€headlessâ€æ¨¡å¼ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡<a href="https://github.com/derekparker/delve/tree/master/Documentation/api" target="_blank" rel="noopener">JSON-RPC API</a>ä¸è°ƒè¯•å™¨äº¤äº’ã€‚</p><p>è¿è¡Œ<code>dlv core</code>å‘½ä»¤ï¼ŒæŒ‡å®šæƒ³è¦å¯åŠ¨çš„Delve API serverï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dlv core example/server/server core.1628 --listen :44441 --headless --<span class="built_in">log</span></span></span><br><span class="line">API server listening at: [::]:44441</span><br><span class="line">INFO[0000] opening core file core.1628 (executable example/server/server)  layer=debugger</span><br></pre></td></tr></table></figure><p>è°ƒè¯•æœåŠ¡å™¨è¿è¡Œåï¼Œæˆ‘ä»¬å¯ä»¥å‘é€å‘½ä»¤åˆ°å…¶TCPç«¯å£å¹¶å°†è¿”å›ç»“æœä»¥åŸç”ŸJSONçš„æ ¼å¼å­˜å‚¨ã€‚æˆ‘ä»¬ä»¥ä¸Šé¢ç›¸åŒçš„æ–¹å¼å¾—åˆ°æ­£åœ¨è¿è¡Œçš„goroutinesï¼Œä¸åŒçš„æ˜¯æˆ‘ä»¬å°†ç»“æœå­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> <span class="built_in">echo</span> -n <span class="string">'&#123;"method":"RPCServer.ListGoroutines","params":[],"id":2&#125;'</span> | nc -w 1 localhost 44441 &gt; server-test-1_dlv-rpc-list_goroutines.json</span></span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†ä¸€ä¸ªï¼ˆæ¯”è¾ƒå¤§çš„ï¼‰JSONæ–‡ä»¶ï¼Œé‡Œé¢å­˜å‚¨å¤§é‡åŸå§‹ä¿¡æ¯ã€‚æ¨èä½¿ç”¨<a href="https://stedolan.github.io/jq/" target="_blank" rel="noopener">jq</a>å‘½ä»¤è¿›ä¸€æ­¥äº†è§£JSONæ•°æ®çš„åŸè²Œï¼Œä¸¾ä¾‹ï¼šè¿™é‡Œæˆ‘è·å–JSONæ•°æ®çš„resultå­—æ®µçš„å‰ä¸‰ä¸ªå¯¹è±¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jq <span class="string">'.result[0:3]'</span> server-test-1_dlv-rpc-list_goroutines.json</span></span><br><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    "id": 1,</span><br><span class="line">    "currentLoc": &#123;</span><br><span class="line">      "pc": 4380603,</span><br><span class="line">      "file": "/usr/local/go/src/runtime/proc.go",</span><br><span class="line">      "line": 303,</span><br><span class="line">      "function": &#123;</span><br><span class="line">        "name": "runtime.gopark",</span><br><span class="line">        "value": 4380368,</span><br><span class="line">        "type": 0,</span><br><span class="line">        "goType": 0,</span><br><span class="line">        "optimized": true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "userCurrentLoc": &#123;</span><br><span class="line">      "pc": 6438159,</span><br><span class="line">      "file": "/vagrant/example/server/main.go",</span><br><span class="line">      "line": 52,</span><br><span class="line">      "function": &#123;</span><br><span class="line">        "name": "main.run",</span><br><span class="line">        "value": 6437408,</span><br><span class="line">        "type": 0,</span><br><span class="line">        "goType": 0,</span><br><span class="line">        "optimized": true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "goStatementLoc": &#123;</span><br><span class="line">      "pc": 4547433,</span><br><span class="line">      "file": "/usr/local/go/src/runtime/asm_amd64.s",</span><br><span class="line">      "line": 201,</span><br><span class="line">      "function": &#123;</span><br><span class="line">        "name": "runtime.rt0_go",</span><br><span class="line">        "value": 4547136,</span><br><span class="line">        "type": 0,</span><br><span class="line">        "goType": 0,</span><br><span class="line">        "optimized": true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "startLoc": &#123;</span><br><span class="line">      "pc": 4379072,</span><br><span class="line">      "file": "/usr/local/go/src/runtime/proc.go",</span><br><span class="line">      "line": 110,</span><br><span class="line">      "function": &#123;</span><br><span class="line">        "name": "runtime.main",</span><br><span class="line">        "value": 4379072,</span><br><span class="line">        "type": 0,</span><br><span class="line">        "goType": 0,</span><br><span class="line">        "optimized": true</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    "threadID": 0,</span><br><span class="line">    "unreadable": ""</span><br><span class="line">  &#125;,</span><br><span class="line">  Â·Â·Â·</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>JSONæ•°æ®ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ä»£è¡¨äº†ä¸€ä¸ªgoroutineã€‚é€šè¿‡<a href="https://github.com/derekparker/delve/blob/master/Documentation/cli/README.md#goroutines" target="_blank" rel="noopener">å‘½ä»¤æ‰‹å†Œ</a></p><p>å¯çŸ¥ï¼Œ<code>goroutines</code>å‘½ä»¤å¯ä»¥è·å¾—æ¯ä¸€ä¸ªgoroutinesçš„ä¿¡æ¯ã€‚é€šè¿‡æ‰‹å†Œæˆ‘ä»¬èƒ½å¤Ÿåˆ†æå‡º<code>userCurrentLoc</code>å­—æ®µæ˜¯æœåŠ¡å™¨æºç ä¸­goroutinesæœ€åå‡ºç°çš„åœ°æ–¹ã€‚</p><p>ä¸ºäº†èƒ½å¤Ÿäº†è§£å½“core fileåˆ›å»ºçš„æ—¶å€™ï¼Œgoroutinesæ­£åœ¨åšä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†JSONæ–‡ä»¶ä¸­åŒ…å«<code>userCurrentLoc</code>å­—æ®µçš„å‡½æ•°åå­—ä»¥åŠå…¶è¡Œå·ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jq -c <span class="string">'.result[] | [.userCurrentLoc.function.name, .userCurrentLoc.line]'</span> server-test-1_dlv-rpc-list_goroutines.json | sort | uniq -c</span></span><br><span class="line"></span><br><span class="line">   1 ["internal/poll.runtime_pollWait",173]</span><br><span class="line">1000 ["main.(*Metrics).CountS",95]</span><br><span class="line">   1 ["main.(*Metrics).SetM",105]</span><br><span class="line">   1 ["main.(*Metrics).startOutChannelConsumer",179]</span><br><span class="line">   1 ["main.run",52]</span><br><span class="line">   1 ["os/signal.signal_recv",139]</span><br><span class="line">   6 ["runtime.gopark",303]</span><br></pre></td></tr></table></figure><p>å¤§é‡çš„goroutines(ä¸Šé¢æ˜¯1000ä¸ª)åœ¨å‡½æ•°<code>main.(*Metrics).CoutS</code>çš„95è¡Œè¢«é˜»å¡ã€‚ç°åœ¨æˆ‘ä»¬å›å¤´çœ‹ä¸€ä¸‹æˆ‘ä»¬æœåŠ¡å™¨çš„<a href="https://github.com/narqo/postmortem-debug-go" target="_blank" rel="noopener">æºç </a>ã€‚</p><p>åœ¨<code>main</code>åŒ…ä¸­æ‰¾åˆ°<code>Metrics</code>ç»“æ„ä½“å¹¶ä¸”æ‰¾åˆ°å®ƒçš„<code>CountS</code>æ–¹æ³•ï¼ˆexample/server/metrics.goï¼‰ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CountS increments counter per second.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *Metrics)</span> <span class="title">CountS</span><span class="params">(key <span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">    m.inChannel &lt;- NewCountMetric(key, <span class="number">1</span>, second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çš„æœåŠ¡å™¨åœ¨å¾€<code>inChannel</code>é€šé“å‘é€çš„æ—¶å€™é˜»å¡ä½äº†ã€‚è®©æˆ‘ä»¬æ‰¾å‡ºè°è´Ÿè´£ä»è¿™ä¸ªé€šé“è¯»å–æ•°æ®ï¼Œæ·±å…¥ç ”ç©¶ä»£ç ä¹‹åæˆ‘ä»¬æ‰¾åˆ°äº†<a href="https://github.com/narqo/postmortem-debug-go/blob/2c42ca73ebd500fe8da1c6ac8ecaf4af143aca78/example/server/metrics.go#L109" target="_blank" rel="noopener">ä¸‹é¢çš„å‡½æ•°</a>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// starts a consumer for inChannel</span><br><span class="line">func (m *Metrics) startInChannelConsumer() &#123;</span><br><span class="line">    for inMetrics := range m.inChannel &#123;</span><br><span class="line">       // Â·Â·Â·</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°é€ä¸ªåœ°ä»é€šé“ä¸­è¯»å–æ•°æ®å¹¶åŠ ä»¥å¤„ç†ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹å‘é€åˆ°è¿™ä¸ªé€šé“çš„ä»»åŠ¡ä¼šè¢«é˜»å¡å‘¢ï¼Ÿ</p><p>å½“å¤„ç†é€šé“çš„æ—¶å€™ï¼Œæ ¹æ®Dave Cheneyçš„<a href="https://dave.cheney.net/2014/03/19/channel-axioms" target="_blank" rel="noopener">é€šé“å‡†åˆ™</a>ï¼Œåªæœ‰å››ç§æƒ…å†µå¯èƒ½å¯¼è‡´é€šé“æœ‰é—®é¢˜ï¼š</p><ul><li>å‘ä¸€ä¸ªnilé€šé“å‘é€</li><li>ä»ä¸€ä¸ªnilé€šé“æ¥æ”¶</li><li>å‘ä¸€ä¸ªå·²å…³é—­çš„é€šé“å‘é€</li><li>ä»ä¸€ä¸ªå·²å…³é—­çš„é€šé“æ¥æ”¶å¹¶ç«‹å³è¿”å›é›¶å€¼</li></ul><p>ç¬¬ä¸€çœ¼å°±çœ‹åˆ°äº†â€œå‘ä¸€ä¸ªnilé€šé“å‘é€â€ï¼Œè¿™çœ‹èµ·æ¥åƒæ˜¯é—®é¢˜çš„åŸå› ã€‚ä½†æ˜¯åå¤æ£€æŸ¥ä»£ç åï¼Œ<code>inChannel</code>æ˜¯ç”±<code>Metrics</code>åˆå§‹åŒ–çš„ï¼Œä¸å¯èƒ½ä¸ºnilã€‚</p><p>nä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œä½¿ç”¨<code>jq</code>å‘½ä»¤è·å–åˆ°çš„ä¿¡æ¯ä¸­ï¼Œæ²¡æœ‰<code>startInChannelConsumer</code>æ–¹æ³•ã€‚ä¼šä¸ä¼šæ˜¯å› ä¸ºåœ¨<code>main.(*Metrics).startInChannelConsumer</code>çš„æŸä¸ªåœ°æ–¹é˜»å¡è€Œå¯¼è‡´è¿™ä¸ªï¼ˆå¯ç¼“å†²ï¼‰é€šé“æ»¡äº†ï¼Ÿ</p><p>Delveèƒ½å¤Ÿæä¾›ä»å¼€å§‹ä½ç½®åˆ°<code>userCurrentLoc</code>å­—æ®µä¹‹é—´çš„åˆå§‹ä½ç½®ä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯å­˜å‚¨åˆ°<code>startLoc</code>å­—æ®µä¸­ã€‚ä½¿ç”¨ä¸‹é¢çš„jqå‘½ä»¤å¯ä»¥æŸ¥è¯¢å‡ºæ‰€æœ‰goroutines,å…¶åˆå§‹ä½ç½®éƒ½åœ¨å‡½æ•°<code>startInChannelConsumer</code>ä¸­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> jq <span class="string">'.result[] | select(.startLoc.function.name | test("startInChannelConsumer$"))'</span> server-test-1_dlv-rpc-list_goroutines.json</span></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">  "id": 20,</span><br><span class="line">  "currentLoc": &#123;</span><br><span class="line">    "pc": 4380603,</span><br><span class="line">    "file": "/usr/local/go/src/runtime/proc.go",</span><br><span class="line">    "line": 303,</span><br><span class="line">    "function": &#123;</span><br><span class="line">      "name": "runtime.gopark",</span><br><span class="line">      "value": 4380368,</span><br><span class="line">      "type": 0,</span><br><span class="line">      "goType": 0,</span><br><span class="line">      "optimized": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "userCurrentLoc": &#123;</span><br><span class="line">    "pc": 6440847,</span><br><span class="line">    "file": "/vagrant/example/server/metrics.go",</span><br><span class="line">    "line": 105,</span><br><span class="line">    "function": &#123;</span><br><span class="line">      "name": "main.(*Metrics).SetM",</span><br><span class="line">      "value": 6440672,</span><br><span class="line">      "type": 0,</span><br><span class="line">      "goType": 0,</span><br><span class="line">      "optimized": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  "startLoc": &#123;</span><br><span class="line">    "pc": 6440880,</span><br><span class="line">    "file": "/vagrant/example/server/metrics.go",</span><br><span class="line">    "line": 109,</span><br><span class="line">    "function": &#123;</span><br><span class="line">      "name": "main.(*Metrics).startInChannelConsumer",</span><br><span class="line">      "value": 6440880,</span><br><span class="line">      "type": 0,</span><br><span class="line">      "goType": 0,</span><br><span class="line">      "optimized": true</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  Â·Â·Â·</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœä¸­æœ‰ä¸€æ¡ä¿¡æ¯éå¸¸æŒ¯å¥‹äººå¿ƒï¼</p><p>åœ¨<code>main.(*Metrics).startInChannelConsumer</code>ï¼Œ109è¡Œï¼ˆçœ‹ç»“æœä¸­çš„startLocå­—æ®µï¼‰ï¼Œæœ‰ä¸€ä¸ªidä¸º20çš„goroutinesé˜»å¡ä½äº†ï¼</p><p>æ‹¿åˆ°goroutinesçš„idèƒ½å¤Ÿå¤§å¤§é™ä½æˆ‘ä»¬æœç´¢çš„èŒƒå›´ï¼ˆå¹¶ä¸”æˆ‘ä»¬å†ä¹Ÿä¸ç”¨æ·±å…¥åºå¤§çš„JSONæ–‡ä»¶äº†ï¼‰ã€‚ä½¿ç”¨Delveçš„<code>goroutines</code>å‘½ä»¤æˆ‘ä»¬èƒ½å¤Ÿå°†å½“å‰goroutinesåˆ‡æ¢åˆ°ç›®æ ‡goroutinesï¼Œç„¶åå¯ä»¥ä½¿ç”¨<code>stack</code>å‘½ä»¤æ‰“å°è¯¥goroutinesçš„å †æ ˆä¿¡æ¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> dlv core example/server/server core.1628</span></span><br><span class="line"></span><br><span class="line">(dlv) goroutine 20</span><br><span class="line">Switched from 0 to 20 (thread 1628)</span><br><span class="line"></span><br><span class="line">(dlv) stack -full</span><br><span class="line">0  0x000000000042d7bb in runtime.gopark</span><br><span class="line">   at /usr/local/go/src/runtime/proc.go:303</span><br><span class="line">       lock = unsafe.Pointer(0xc000104058)</span><br><span class="line">       reason = waitReasonChanSend</span><br><span class="line">Â·Â·Â·</span><br><span class="line">3  0x00000000004066a5 in runtime.chansend1</span><br><span class="line">   at /usr/local/go/src/runtime/chan.go:125</span><br><span class="line">       c = (unreadable empty OP stack)</span><br><span class="line">       elem = (unreadable empty OP stack)</span><br><span class="line"></span><br><span class="line">4  0x000000000062478f in main.(*Metrics).SetM</span><br><span class="line">   at /vagrant/example/server/metrics.go:105</span><br><span class="line">       key = (unreadable empty OP stack)</span><br><span class="line">       m = (unreadable empty OP stack)</span><br><span class="line">       value = (unreadable empty OP stack)</span><br><span class="line"></span><br><span class="line">5  0x0000000000624e64 in main.(*Metrics).sendMetricsToOutChannel</span><br><span class="line">   at /vagrant/example/server/metrics.go:146</span><br><span class="line">       m = (*main.Metrics)(0xc000056040)</span><br><span class="line">       scope = 0</span><br><span class="line">       updateInterval = (unreadable could not find loclist entry at 0x89f76 for address 0x624e63)</span><br><span class="line"></span><br><span class="line">6  0x0000000000624a2f in main.(*Metrics).startInChannelConsumer</span><br><span class="line">   at /vagrant/example/server/metrics.go:127</span><br><span class="line">       m = (*main.Metrics)(0xc000056040)</span><br><span class="line">       inMetrics = main.Metric &#123;Type: TypeCount, Scope: 0, Key: "server.req-incoming",...+2 more&#125;</span><br><span class="line">       nextUpdate = (unreadable could not find loclist entry at 0x89e86 for address 0x624a2e)</span><br></pre></td></tr></table></figure><p>ä»ä¸‹å¾€ä¸Šåˆ†æï¼š</p><p>ï¼ˆ6ï¼‰ä¸€ä¸ªæ¥è‡ªé€šé“çš„æ–°<code>inMetrics</code>å€¼åœ¨<code>main.(*Metrics).startInChannelConsumer</code>ä¸­è¢«æ¥æ”¶</p><p>ï¼ˆ5ï¼‰æˆ‘ä»¬è°ƒç”¨<code>main.(*Metrics).sendMetricsToOutChannel</code>å¹¶ä¸”åœ¨<code>example/server/metrics.go</code>çš„146è¡Œè¿›è¡Œå¤„ç†</p><p>ï¼ˆ4ï¼‰ç„¶å<code>main.(*Metrics).SetM</code>è¢«è°ƒç”¨</p><p>ä¸€ç›´è¿è¡Œåˆ°<code>runtime.gopark</code>ä¸­çš„<code>waitReasonChanSend</code>é˜»å¡ï¼</p><p>ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½æ˜æœ—äº†ï¼</p><p>å•ä¸ªgoroutinesä¸­ï¼Œä¸€ä¸ªä»ç¼“å†²é€šé“è¯»å–æ•°æ®çš„å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿåœ¨å¾€é€šé“ä¸­å‘é€æ•°æ®ã€‚å½“è¿›å…¥é€šé“çš„å€¼è¾¾åˆ°é€šé“çš„å®¹é‡æ—¶ï¼Œæ¶ˆè´¹å‡½æ•°ç»§ç»­å¾€å·²æ»¡çš„é€šé“ä¸­å‘é€æ•°æ®å°±ä¼šé€ æˆè‡ªèº«çš„æ­»é”ã€‚ç”±äºå•ä¸ªé€šé“çš„æ¶ˆè´¹è€…æ­»é”ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªå°è¯•å¾€é€šé“ä¸­å‘é€æ•°æ®çš„è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ã€‚</p><hr><p>è¿™å°±æ˜¯æˆ‘ä»¬çš„æ•…äº‹ï¼Œä½¿ç”¨ä¸Šè¿°è°ƒè¯•æŠ€æœ¯å¸®åŠ©æˆ‘ä»¬å‘ç°äº†é—®é¢˜çš„æ ¹æºã€‚é‚£äº›ä»£ç æ˜¯å¾ˆå¤šå¹´å‰å†™çš„ï¼Œç”šè‡³ä»æ²¡æœ‰äººçœ‹è¿‡è¿™äº›ä»£ç ï¼Œä¹Ÿä¸‡ä¸‡æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´è¿™ä¹ˆå¤§çš„é—®é¢˜ã€‚</p><p>å¦‚ä½ æ‰€è§ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰é—®é¢˜éƒ½èƒ½ç”±å·¥å…·è§£å†³ï¼Œä½†æ˜¯å·¥å…·èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°å·¥ä½œã€‚æˆ‘å¸Œæœ›ï¼Œé€šè¿‡æ­¤æ–‡èƒ½å¤Ÿæ¿€åŠ±ä½ å¤šå¤šå°è¯•è¿™äº›å·¥å…·ã€‚æˆ‘éå¸¸ä¹æ„å€¾å¬ä½ ä»¬å¤„ç†ç±»ä¼¼é—®é¢˜çš„å…¶å®ƒè§£å†³æ–¹æ¡ˆã€‚</p><p><strong>Vladimir<em>æ˜¯ä¸€ä¸ªåç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œç›®å‰å°±èŒäº</em>adjust.com. @tvii on Twitter, @narqo on Github</strong></p><hr><p>via: <a href="https://blog.gopheracademy.com/advent-2018/postmortem-debugging-delve/" target="_blank" rel="noopener">https://blog.gopheracademy.com/advent-2018/postmortem-debugging-delve/</a></p><p>ä½œè€…ï¼š<a href="https://blog.gopheracademy.com/advent-2018/postmortem-debugging-delve/" target="_blank" rel="noopener">Vladimir Varankin</a><br>è¯‘è€…ï¼š<a href="https://github.com/hantmac" target="_blank" rel="noopener">hantmac</a></p><hr>]]></content>
    
    <summary type="html">
    
      Postmortem-debugging-Go-services-with-Delve[ç¿»è¯‘]
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>è‡ªåŠ¨åŒ–è„šæœ¬å®ç°goå®‰è£…ä¸å‡çº§</title>
    <link href="https://cloudsjhan.github.io/2019/01/12/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0go%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%87%E7%BA%A7/"/>
    <id>https://cloudsjhan.github.io/2019/01/12/è‡ªåŠ¨åŒ–è„šæœ¬å®ç°goå®‰è£…ä¸å‡çº§/</id>
    <published>2019-01-12T15:55:47.000Z</published>
    <updated>2019-01-20T15:46:40.063Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="æºç å®‰è£…ï¼š"><a href="#æºç å®‰è£…ï¼š" class="headerlink" title="æºç å®‰è£…ï¼š"></a>æºç å®‰è£…ï¼š</h3><ul><li>ä¸‹è½½å¯¹åº”çš„æ“ä½œç³»ç»Ÿçš„æœ€æ–°çš„ Golang ç‰ˆæœ¬ï¼š<a href="https://golang.org/dl/" target="_blank" rel="noopener">https://golang.org/dl/</a></li></ul><p>åœ¨ home ç›®å½•ä¸‹å»ºç«‹  installGoç›®å½•ï¼Œç„¶ååœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºå‡çº§ä¸éƒ¨ç½²æ–‡ä»¶ä»¥åŠä¸‹è½½æœ€æ–°çš„ golang æºç åŒ…ï¼š </p><p>ä»¥ä¸‹æ˜¯ installOrUpdate.sh å…·ä½“å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> !/bin/bash</span></span><br><span class="line"></span><br><span class="line">if [ -z "$1" ]; then</span><br><span class="line">â€‹        echo "usage: ./install.sh go-package.tar.gz"</span><br><span class="line">â€‹        exit</span><br><span class="line">fiif [ -d "/usr/local/go" ]; then</span><br><span class="line">â€‹        echo "Uninstalling old go version..."</span><br><span class="line">â€‹        sudo rm -rf /usr/local/go</span><br><span class="line">fi</span><br><span class="line">echo "Installing..."</span><br><span class="line">sudo tar -C /usr/local -xzf $1</span><br><span class="line">echo export GOPATH=/go" &gt;&gt; /etc/profile</span><br><span class="line">echo export GOROOT=/usr/local/go &gt;&gt; /etc/profile</span><br><span class="line">echo export PATH=$PATH:$GOROOT/bin:$GOPATH/bin1 &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line">rm -rf $1</span><br><span class="line">echo "Done"</span><br></pre></td></tr></table></figure><p>ç„¶åè¿è¡Œï¼š</p><p>sudo sh install.sh go1.10.linux-amd64.tar.gz</p><ul><li><p>æˆ–è€…æ‰‹åŠ¨è®¾ç½®å¥½GOPATHï¼ŒGOROOT </p><p>ç¼–è¾‘ /etc/profile åœ¨æ–‡ä»¶å°¾éƒ¨åŠ å…¥ï¼š</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">export GOPATH=/go</span><br><span class="line">export GOROOT=/usr/local/go</span><br><span class="line">export PATH=$PATH:$GOROOT/bin:$GOPATH/bin1</span><br><span class="line"></span><br><span class="line">è¿è¡Œ source /etc/profile è®©ç¯å¢ƒå˜é‡ç”Ÿæ•ˆ</span><br></pre></td></tr></table></figure><h2 id="è‡³æ­¤ï¼ŒGo-å·²å®‰è£…æˆåŠŸ"><a href="#è‡³æ­¤ï¼ŒGo-å·²å®‰è£…æˆåŠŸ" class="headerlink" title="è‡³æ­¤ï¼ŒGo å·²å®‰è£…æˆåŠŸ"></a>è‡³æ­¤ï¼ŒGo å·²å®‰è£…æˆåŠŸ</h2><ul><li><p>å‡çº§</p><p>å¦‚æœéœ€è¦å‡çº§çš„è¯åªéœ€è¦å°†æœ€æ–°çš„æºç åŒ…ä¸‹è½½åˆ°ç¬¬ä¸€æ­¥çš„ installGo æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åè¿è¡Œsudo sh install.sh go1.xx.linux-amd64.tar.gz å³å¯ã€‚</p></li><li>shellè„šæœ¬æ›´æ–°åœ°å€<a href="https://github.com/hantmac/Install_or_Update_Go_Automatically" target="_blank" rel="noopener">github</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      è‡ªåŠ¨åŒ–è„šæœ¬å®ç°goå®‰è£…ä¸å‡çº§
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>beegoæ³¨è§£è·¯ç”±ä¸­@Paramçš„å‚æ•°è§£é‡Š</title>
    <link href="https://cloudsjhan.github.io/2019/01/03/beego%E6%B3%A8%E8%A7%A3%E8%B7%AF%E7%94%B1%E4%B8%AD-Param%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A/"/>
    <id>https://cloudsjhan.github.io/2019/01/03/beegoæ³¨è§£è·¯ç”±ä¸­-Paramçš„å‚æ•°è§£é‡Š/</id>
    <published>2019-01-03T08:56:19.000Z</published>
    <updated>2019-01-03T09:00:27.642Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>beegoæ³¨è§£è·¯ç”±çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæˆ‘ä»¬çš„æ³¨é‡Šåˆ†ä¸ºä»¥ä¸‹ç±»åˆ«ï¼š</p><ul><li><p>@Title</p><p>æ¥å£çš„æ ‡é¢˜ï¼Œç”¨æ¥æ ‡ç¤ºå”¯ä¸€æ€§ï¼Œå”¯ä¸€ï¼Œå¯é€‰</p><p>æ ¼å¼ï¼šä¹‹åè·Ÿä¸€ä¸ªæè¿°å­—ç¬¦ä¸²</p></li><li><p>@Description</p><p>æ¥å£çš„ä½œç”¨ï¼Œç”¨æ¥æè¿°æ¥å£çš„ç”¨é€”ï¼Œå”¯ä¸€ï¼Œå¯é€‰</p><p>æ ¼å¼ï¼šä¹‹åè·Ÿä¸€ä¸ªæè¿°å­—ç¬¦ä¸²</p></li><li><p><a href="http://my.oschina.net/param" target="_blank" rel="noopener">@Param</a></p><p>è¯·æ±‚çš„å‚æ•°ï¼Œç”¨æ¥æè¿°æ¥å—çš„å‚æ•°ï¼Œå¤šä¸ªï¼Œå¯é€‰</p><p>æ ¼å¼ï¼šå˜é‡å ä¼ è¾“ç±»å‹ ç±»å‹ æ˜¯å¦å¿…é¡» æè¿°</p><p>ä¼ è¾“ç±»å‹ï¼špaht or body</p><p>ç±»å‹ï¼š</p><p>å˜é‡åå’Œæè¿°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²</p><p>æ˜¯å¦å¿…é¡»ï¼štrue æˆ–è€…false</p></li><li><ul><li>string</li><li>int</li><li>int64</li><li>å¯¹è±¡ï¼Œè¿™ä¸ªåœ°æ–¹å¤§å®¶å†™çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œéœ€è¦æ˜¯ç›¸å¯¹äºå½“å‰é¡¹ç›®çš„è·¯å¾„.å¯¹è±¡ï¼Œä¾‹å¦‚<code>models.Object</code>è¡¨ç¤º<code>models</code>ç›®å½•ä¸‹çš„Objectå¯¹è±¡ï¼Œè¿™æ ·beeåœ¨ç”Ÿæˆæ–‡æ¡£çš„æ—¶å€™ä¼šå»æ‰«ææ”¹å¯¹è±¡å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·æ”¹å¯¹è±¡ã€‚</li><li>query è¡¨ç¤ºå¸¦åœ¨urlä¸²é‡Œé¢?aa=bb&amp;cc=dd</li><li>form è¡¨ç¤ºä½¿ç”¨è¡¨å•é€’äº¤æ•°æ®</li><li>path è¡¨ç¤ºURLä¸²ä¸­å¾—å­—ç¬¦ï¼Œä¾‹å¦‚/user/{uid} é‚£ä¹ˆuidå°±æ˜¯ä¸€ä¸ªpathç±»å‹çš„å‚æ•°</li><li>body è¡¨ç¤ºä½¿ç”¨raw bodyè¿›è¡Œæ•°æ®çš„ä¼ è¾“</li><li>header è¡¨ç¤ºé€šè¿‡headerè¿›è¡Œæ•°æ®çš„ä¼ è¾“</li></ul></li><li></li><li><p><a href="http://my.oschina.net/u/660711" target="_blank" rel="noopener">@Success</a></p><p>æˆåŠŸè¿”å›çš„codeå’Œå¯¹è±¡æˆ–è€…ä¿¡æ¯</p><p>æ ¼å¼ï¼šcode å¯¹è±¡ç±»å‹ ä¿¡æ¯æˆ–è€…å¯¹è±¡è·¯å¾„</p><p>codeï¼šè¡¨ç¤ºHTTPçš„æ ‡å‡†status codeï¼Œ200 201ç­‰</p><p>å¯¹è±¡ç±»å‹ï¼š{object}è¡¨ç¤ºå¯¹è±¡ï¼Œå…¶ä»–é»˜è®¤éƒ½è®¤ä¸ºæ˜¯å­—ç¬¦ç±»å‹ï¼Œä¼šæ˜¾ç¤ºç¬¬ä¸‰ä¸ªå‚æ•°ç»™ç”¨æˆ·ï¼Œå¦‚æœæ˜¯{object}ç±»å‹ï¼Œé‚£ä¹ˆå°±ä¼šå»æ‰«ææ”¹å¯¹è±¡ï¼Œå¹¶æ˜¾ç¤ºç»™ç”¨æˆ·</p><p>å¯¹è±¡è·¯å¾„å’Œä¸Šé¢Paramä¸­å¾—å¯¹è±¡ç±»å‹ä¸€æ ·ï¼Œä½¿ç”¨è·¯å¾„.å¯¹è±¡çš„æ–¹å¼æ¥æè¿°</p></li><li><p><a href="http://my.oschina.net/Failure" target="_blank" rel="noopener">@Failure</a></p><p>é”™è¯¯è¿”å›çš„ä¿¡æ¯ï¼Œ</p><p>æ ¼å¼ï¼š code ä¿¡æ¯</p><p>code:åŒä¸ŠSuccess</p><p>é”™è¯¯ä¿¡æ¯ï¼šå­—ç¬¦ä¸²æè¿°ä¿¡æ¯</p></li><li><p><a href="http://my.oschina.net/Router" target="_blank" rel="noopener">@router</a></p><p>ä¸Šé¢å·²ç»æè¿°è¿‡æ”¯æŒä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è·¯ç”±ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ”¯æŒçš„HTTPæ–¹æ³•</p></li></ul><hr>]]></content>
    
    <summary type="html">
    
      beegoæ³¨è§£è·¯ç”±ä¸­@Paramçš„å‚æ•°è§£é‡Š
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="beego" scheme="https://cloudsjhan.github.io/tags/beego/"/>
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>golang use reflect to judge type of variable</title>
    <link href="https://cloudsjhan.github.io/2018/12/25/golang-use-reflect-to-judge-type-of-variable/"/>
    <id>https://cloudsjhan.github.io/2018/12/25/golang-use-reflect-to-judge-type-of-variable/</id>
    <published>2018-12-25T11:38:43.000Z</published>
    <updated>2018-12-25T11:48:50.260Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangä¸­å¯ä»¥ä½¿ç”¨ç©ºæ¥å£å³interface{}ä»£è¡¨ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦è·å–è¿”å›å€¼çš„å…·ä½“ç±»å‹</li><li>åœºæ™¯ï¼šbeegoæ¡†æ¶ä¸­çš„orm.Paramsç±»å‹ï¼Œå®é™…ä¸Šæ˜¯map[string]interface{},åœ¨ä½¿ç”¨<a href="https://beego.me/docs/mvc/model/query.md" target="_blank" rel="noopener">valuesæ¥å£</a>çš„æ—¶å€™ï¼Œéœ€è¦ä»è¿”å›Mapä¸­è·å–æ•°æ®ï¼Œéœ€è¦è¿™æ ·è·å–ï¼š<code>Id:m[&quot;Id&quot;].(string)</code>,è¿™æ—¶m[â€œIdâ€]å®é™…ä¸Šæ˜¯Stringç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨reflectæ¨¡å—æ¥è·å–å®é™…çš„ç±»å‹</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reflect.TypeOf(m[<span class="string">"Id"</span>])</span><br><span class="line"><span class="comment">//è¿”å›ä¸ºString</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;reflect&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    var x int32 = 20</span><br><span class="line">    fmt.Println(&quot;type:&quot;, reflect.TypeOf(x))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      golang use reflect to judge type of variable
    
    </summary>
    
      <category term="go" scheme="https://cloudsjhan.github.io/categories/go/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>mysql add primary key auto_increment</title>
    <link href="https://cloudsjhan.github.io/2018/12/25/mysql-add-primary-key-auto-increment/"/>
    <id>https://cloudsjhan.github.io/2018/12/25/mysql-add-primary-key-auto-increment/</id>
    <published>2018-12-25T11:08:53.000Z</published>
    <updated>2018-12-25T11:52:17.418Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æ·»åŠ å­—æ®µid,å¹¶å°†å…¶è®¾ç½®ä¸ºä¸»é”®è‡ªå¢</p><ul><li>alter table TABLE_NAME add id int not null primary key Auto_increment</li></ul><p>å¦‚æœæƒ³æ·»åŠ å·²ç»æœ‰äº†ä¸€åˆ—ä¸ºä¸»é”®ï¼Œå¯ä»¥ç”¨ï¼š</p><ul><li><p>alter table TABLE_NAME add primary key(COL_NAME);</p></li><li><p>å¦‚æœæƒ³ä¿®æ”¹ä¸€åˆ—ä¸ºä¸»é”®ï¼Œåˆ™éœ€è¦å…ˆåˆ é™¤åŸæ¥çš„ä¸»é”®ï¼š</p></li></ul><p>alter table TABLE_NAME drop primary key;</p><p>å†é‡æ–°æ·»åŠ ä¸»é”®ï¼š</p><ul><li>alter table TABLE_NAME add primary key(COL_NAME);</li></ul><hr>]]></content>
    
    <summary type="html">
    
      MySQL add primary key auto_increment for established table
    
    </summary>
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Goå…³äºtimeåŒ…çš„è§£æä¸ä½¿ç”¨</title>
    <link href="https://cloudsjhan.github.io/2018/12/16/Go%E5%85%B3%E4%BA%8Etime%E5%8C%85%E7%9A%84%E8%A7%A3%E6%9E%90%E4%B8%8E%E4%BD%BF%E7%94%A8/"/>
    <id>https://cloudsjhan.github.io/2018/12/16/Goå…³äºtimeåŒ…çš„è§£æä¸ä½¿ç”¨/</id>
    <published>2018-12-16T15:16:34.000Z</published>
    <updated>2019-01-09T11:24:47.279Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="Goå…³äºæ—¶é—´ä¸æ—¥æœŸçš„å¤„ç†"><a href="#Goå…³äºæ—¶é—´ä¸æ—¥æœŸçš„å¤„ç†" class="headerlink" title="Goå…³äºæ—¶é—´ä¸æ—¥æœŸçš„å¤„ç†"></a>Goå…³äºæ—¶é—´ä¸æ—¥æœŸçš„å¤„ç†</h3><h4 id="å…³äºtimeçš„æ•°æ®ç±»å‹"><a href="#å…³äºtimeçš„æ•°æ®ç±»å‹" class="headerlink" title="å…³äºtimeçš„æ•°æ®ç±»å‹"></a>å…³äºtimeçš„æ•°æ®ç±»å‹</h4><ul><li><p>timeåŒ…ä¾èµ–çš„æ•°æ®ç±»å‹æœ‰ï¼š<strong>time.Time</strong>,<strong>time.Month</strong>,<strong>time.WeekDay</strong>,<strong>time.Duration</strong>,<strong>time.Location</strong>.</p></li><li><p>è¯¦ç»†ä»‹ç»ä»¥ä¸Šå‡ ç§æ•°æ®ç±»å‹</p><ul><li><p>time.Time</p></li><li><p><code>/usr/local/go/src/time/time.go</code> å®šä¹‰å¦‚ä¸‹:</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Time <span class="keyword">struct</span> &#123;</span><br><span class="line">    sec <span class="keyword">int64</span> <span class="comment">// ä»1å¹´1æœˆ1æ—¥ 00:00:00 UTC è‡³ä»Šè¿‡å»çš„ç§’æ•°</span></span><br><span class="line">    nsec <span class="keyword">int32</span> <span class="comment">// æœ€è¿‘ä¸€ç§’åˆ°ä¸‹ä¸€ç§’è¿‡å»çš„çº³ç§’æ•°</span></span><br><span class="line">    loc *Location <span class="comment">// æ—¶åŒº</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>time.Timeä¼šè¿”å›çº³ç§’æ—¶é—´ç²¾åº¦çš„æ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ti time.Time</span><br><span class="line">ti = time.Now()</span><br><span class="line">fmt.Printf(<span class="string">"æ—¶é—´: %v, æ—¶åŒº:  %v,  æ—¶é—´ç±»å‹: %T\n"</span>, t, t.Location(), t)</span><br><span class="line"><span class="comment">//æ—¶é—´: 2018-12-15 09:06:05.816187261 +0800 CST, æ—¶åŒº:  Local,  æ—¶é—´ç±»å‹: time.Time</span></span><br></pre></td></tr></table></figure></li><li><p>time.Month, goä¸­è‡ªå·±é‡æ–°å®šä¹‰äº†monthçš„ç±»å‹ï¼Œä¸time.yearå’Œtime.dayä¸åŒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">type Month int</span><br><span class="line"></span><br><span class="line">const (</span><br><span class="line">    January Month = 1 + iota</span><br><span class="line">    February</span><br><span class="line">    March</span><br><span class="line">    April</span><br><span class="line">    May</span><br><span class="line">    June</span><br><span class="line">    July</span><br><span class="line">    August</span><br><span class="line">    September</span><br><span class="line">    October</span><br><span class="line">    November</span><br><span class="line">    December</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>iotaæ˜¯golangè¯­è¨€çš„å¸¸é‡è®¡æ•°å™¨,åªèƒ½åœ¨å¸¸é‡çš„è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚<br> iotaåœ¨constå…³é”®å­—å‡ºç°æ—¶å°†è¢«é‡ç½®ä¸º0(constå†…éƒ¨çš„ç¬¬ä¸€è¡Œä¹‹å‰)ï¼Œconstä¸­æ¯æ–°å¢ä¸€è¡Œå¸¸é‡å£°æ˜å°†ä½¿iotaè®¡æ•°ä¸€æ¬¡(iotaå¯ç†è§£ä¸ºconstè¯­å¥å—ä¸­çš„è¡Œç´¢å¼•)ã€‚ ä½¿ç”¨iotaèƒ½ç®€åŒ–å®šä¹‰ï¼Œåœ¨å®šä¹‰æšä¸¾æ—¶å¾ˆæœ‰ç”¨ã€‚</p></li><li><p>time.WeekDay,ä»£è¡¨ä¸€å‘¨ä¹‹ä¸­çš„æ˜ŸæœŸå‡ ï¼ˆå½“ç„¶æ˜¯æŒ‰ç…§è¥¿æ–¹çš„è§„åˆ™ï¼Œä»–ä»¬æŠŠå‘¨æ—¥å½“åšæ˜¯ä¸€å‘¨çš„å¼€å§‹ï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> WeekDay <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Sunday Weekday = <span class="literal">iota</span></span><br><span class="line">    Monday</span><br><span class="line">    Tuesday</span><br><span class="line">    Wednesday</span><br><span class="line">    Thursday</span><br><span class="line">    Friday</span><br><span class="line">    Saturday</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li><p>time.Duration,ä»£è¡¨ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„çº³ç§’å·®å€¼ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Duration <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Nanosecond  Duration = <span class="number">1</span></span><br><span class="line">    Microsecond          = <span class="number">1000</span> * Nanosecond</span><br><span class="line">    Millisecond          = <span class="number">1000</span> * Microsecond</span><br><span class="line">    Second               = <span class="number">1000</span> * Millisecond</span><br><span class="line">    Minute               = <span class="number">60</span> * Second</span><br><span class="line">    Hour                 = <span class="number">60</span> * Minute</span><br><span class="line">)</span><br></pre></td></tr></table></figure></li><li><p>time.Location,æ—¶åŒºä¿¡æ¯</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Location <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="keyword">string</span></span><br><span class="line">    zone []zone</span><br><span class="line">    tx   []zoneTrans</span><br><span class="line">    cacheStart <span class="keyword">int64</span></span><br><span class="line">    cacheEnd   <span class="keyword">int64</span></span><br><span class="line">    cacheZone  *zone</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒ—äº¬æ—¶é—´ï¼šAsia/Shanghai</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="ä»¥ä¸Šç±»å‹receiverçš„å®ç°æ–¹æ³•"><a href="#ä»¥ä¸Šç±»å‹receiverçš„å®ç°æ–¹æ³•" class="headerlink" title="ä»¥ä¸Šç±»å‹receiverçš„å®ç°æ–¹æ³•"></a>ä»¥ä¸Šç±»å‹receiverçš„å®ç°æ–¹æ³•</h4><ul><li>time.Timeç›¸å…³æ–¹æ³•</li></ul><p><code>func Now() Time {}</code> // å½“å‰æœ¬åœ°æ—¶é—´</p><p> <code>func Unix(sec int64, nsec int64) Time {}</code>  // æ ¹æ®æ—¶é—´æˆ³è¿”å›æœ¬åœ°æ—¶é—´</p><p> <code>func Date(year int, month Month, day, hour, min, sec, nsec int, loc *Location) Time {}</code> // è¿”å›æŒ‡å®šæ—¶é—´</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/ å½“å‰æœ¬åœ°æ—¶é—´</span><br><span class="line">t = time.Now()</span><br><span class="line">fmt.Println(<span class="string">"'time.Now': "</span>, t)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ ¹æ®æ—¶é—´æˆ³è¿”å›æœ¬åœ°æ—¶é—´</span></span><br><span class="line">t_by_unix := time.Unix(<span class="number">1487780010</span>, <span class="number">0</span>)</span><br><span class="line">fmt.Println(<span class="string">"'time.Unix': "</span>, t_by_unix)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›æŒ‡å®šæ—¶é—´</span></span><br><span class="line">t_by_date := time.Date(<span class="number">2017</span>, time.Month(<span class="number">2</span>), <span class="number">23</span>, <span class="number">1</span>, <span class="number">30</span>, <span class="number">30</span>, <span class="number">0</span>, l)</span><br><span class="line">fmt.Println(<span class="string">"'time.Date': "</span>, t_by_date)</span><br></pre></td></tr></table></figure><ul><li><p>æŒ‰ç…§æ—¶åŒºä¿¡æ¯æ˜¾ç¤ºæ—¶é—´</p></li><li><p><code>func (t Time) UTC() Time {}</code> // è·å–æŒ‡å®šæ—¶é—´åœ¨UTC æ—¶åŒºçš„æ—¶é—´è¡¨ç¤º</p></li><li><code>func (t Time) Local() Time {}</code> // ä»¥æœ¬åœ°æ—¶åŒºè¡¨ç¤º</li><li><code>func (t Time) In(loc *Location) Time {}</code> // æ—¶é—´åœ¨æŒ‡å®šæ—¶åŒºçš„è¡¨ç¤º</li><li><code>func (t Time) Format(layout string) string {}</code> // æŒ‰æŒ‡å®šæ ¼å¼æ˜¾ç¤ºæ—¶é—´</li></ul></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æŒ‡å®šæ—¶é—´åœ¨UTC æ—¶åŒºçš„æ—¶é—´è¡¨ç¤º</span></span><br><span class="line">t_by_utc := t.UTC()</span><br><span class="line">fmt.Println(<span class="string">"'t.UTC': "</span>, t_by_utc)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å–æœ¬åœ°æ—¶é—´è¡¨ç¤º</span></span><br><span class="line">t_by_local := t.Local()</span><br><span class="line">fmt.Println(<span class="string">"'t.Local': "</span>, t_by_local)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ—¶é—´åœ¨æŒ‡å®šæ—¶åŒºçš„è¡¨ç¤º</span></span><br><span class="line">t_in := t.In(time.UTC)</span><br><span class="line">fmt.Println(<span class="string">"'t.In': "</span>, t_in)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Format</span></span><br><span class="line">fmt.Println(<span class="string">"t.Format"</span>, t.Format(time.RFC3339))</span><br></pre></td></tr></table></figure><ul><li>è·å–å¹´æœˆæ—¥ç­‰ä¿¡æ¯</li></ul><p><code>func (t Time) Date() (year int, month Month, day int) {}</code> // è¿”å›æ—¶é—´çš„æ—¥æœŸä¿¡æ¯</p><p> <code>func (t Time) Year() int {}</code> // è¿”å›å¹´</p><p> <code>func (t Time) Month() Month {}</code> // æœˆ</p><p> <code>func (t Time) Day() int {}</code> // æ—¥</p><p> <code>func (t Time) Weekday() Weekday {}</code> // æ˜ŸæœŸ</p><p> <code>func (t Time) ISOWeek() (year, week int) {}</code> // è¿”å›å¹´ï¼Œæ˜ŸæœŸèŒƒå›´ç¼–å·</p><p> <code>func (t Time) Clock() (hour, min, sec int) {}</code> // è¿”å›æ—¶é—´çš„æ—¶åˆ†ç§’</p><p> <code>func (t Time) Hour() int {}</code> // è¿”å›å°æ—¶</p><p> <code>func (t Time) Minute() int {}</code> // åˆ†é’Ÿ</p><p> <code>func (t Time) Second() int {}</code> // ç§’</p><p> <code>func (t Time) Nanosecond() int {}</code> // çº³ç§’</p><p> <code>func (t Time) YearDay() int {}</code> // ä¸€å¹´ä¸­å¯¹åº”çš„å¤©</p><p> <code>func (t Time) Location() *Location {}</code> // æ—¶é—´çš„æ—¶åŒº</p><p> <code>func (t Time) Zone() (name string, offset int) {}</code> // æ—¶é—´æ‰€åœ¨æ—¶åŒºçš„è§„èŒƒåå’Œæƒ³å¯¹UTC æ—¶é—´åç§»é‡</p><p> <code>func (t Time) Unix() int64 {}</code> // æ—¶é—´è½¬ä¸ºæ—¶é—´æˆ³</p><p> <code>func (t Time) UnixNano() int64 {}</code> // æ—¶é—´è½¬ä¸ºæ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›æ—¶é—´çš„æ—¥æœŸä¿¡æ¯</span></span><br><span class="line">year, month, day := t.Date()</span><br><span class="line">fmt.Println(<span class="string">"'t.Date': "</span>, year, month, day)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜ŸæœŸ</span></span><br><span class="line">week := t.Weekday()</span><br><span class="line">fmt.Println(<span class="string">"'t.Weekday': "</span>, week)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›å¹´ï¼Œæ˜ŸæœŸèŒƒå›´ç¼–å·</span></span><br><span class="line">year, week_int := t.ISOWeek()</span><br><span class="line">fmt.Println(<span class="string">"'t.ISOWeek': "</span>, year, week_int)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿”å›æ—¶é—´çš„æ—¶åˆ†ç§’</span></span><br><span class="line">hour, min, sec := t.Clock()</span><br><span class="line">fmt.Println(<span class="string">"'t.Clock': "</span>, hour, min, sec)</span><br></pre></td></tr></table></figure><ul><li>æ—¶é—´è¿ç®—</li></ul><p><code>func (t Time) IsZero() bool {}</code> // æ˜¯å¦æ˜¯é›¶æ—¶æ—¶é—´</p><p> <code>func (t Time) After(u Time) bool {}</code> // æ—¶é—´åœ¨u ä¹‹å‰</p><p> <code>func (t Time) Before(u Time) bool {}</code> // æ—¶é—´åœ¨u ä¹‹å</p><p> <code>func (t Time) Equal(u Time) bool {}</code> // æ—¶é—´ä¸u ç›¸åŒ</p><p> <code>func (t Time) Add(d Duration) Time {}</code> // è¿”å›t +d çš„æ—¶é—´ç‚¹</p><p> <code>func (t Time) Sub(u Time) Duration {}</code> // è¿”å› t-u</p><p> <code>func (t Time) AddDate(years int, months int, days int) Time {}</code> è¿”å›å¢åŠ äº†ç»™å‡ºçš„å¹´ä»½ã€æœˆä»½å’Œå¤©æ•°çš„æ—¶é—´ç‚¹Time</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// è¿”å›å¢åŠ äº†ç»™å‡ºçš„å¹´ä»½ã€æœˆä»½å’Œå¤©æ•°çš„æ—¶é—´ç‚¹Time</span><br><span class="line">t_new := t.AddDate(0, 1, 1)</span><br><span class="line">fmt.Println(&quot;&apos;t.AddDate&apos;: &quot;, t_new)</span><br><span class="line"></span><br><span class="line">// æ—¶é—´åœ¨u ä¹‹å‰</span><br><span class="line">is_after := t.After(t_new)</span><br><span class="line">fmt.Println(&quot;&apos;t.After&apos;: &quot;, is_after)</span><br></pre></td></tr></table></figure><ul><li>time.Durationçš„ç±»å‹receiverå®ç°çš„æ–¹æ³•</li></ul><p><code>func (d Duration) String() string</code> // æ ¼å¼åŒ–è¾“å‡º Duration</p><p> <code>func (d Duration) Nanoseconds() int64</code> // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºçº³ç§’</p><p> <code>func (d Duration) Seconds() float64</code> // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºç§’</p><p> <code>func (d Duration) Minutes() float64</code> // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºåˆ†é’Ÿ</p><p> <code>func (d Duration) Hours() float64</code> // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºå°æ—¶</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// time.Duration æ—¶é—´æ®µ</span></span><br><span class="line">fmt.Println(<span class="string">"time.Duration æ—¶é—´æ®µ"</span>)</span><br><span class="line">d = time.Duration(<span class="number">10000000000000</span>)<span class="comment">//è¾“å…¥å‚æ•°ä¸ºint64ç±»å‹</span></span><br><span class="line"></span><br><span class="line">fmt.Printf(<span class="string">"'String: %v', 'Nanoseconds: %v', 'Seconds: %v', 'Minutes: %v', 'Hours: %v'\n"</span>, </span><br><span class="line">d.String(), d.Nanoseconds(), d.Seconds(), d.Minutes(), d.Hours())</span><br><span class="line"><span class="comment">// 'String: 2h46m40s', 'Nanoseconds: 10000000000000', 'Seconds: 10000', 'Minutes: 166.66666666666666', 'Hours: 2.7777777777777777'</span></span><br></pre></td></tr></table></figure><ul><li>time.Locationçš„receiverå®ç°çš„æ–¹æ³•</li></ul><p><code>func (l *Location) String() string</code> // è¾“å‡ºæ—¶åŒºå</p><p> <code>func FixedZone(name string, offset int) *Location</code> // FixedZone ä½¿ç”¨ç»™å®šçš„åœ°ç‚¹ånameå’Œæ—¶é—´åç§»é‡offsetï¼ˆå•ä½ç§’ï¼‰åˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªLocation</p><p> <code>func LoadLocation(name string) (*Location, error)</code> // LoadLocation ä½¿ç”¨ç»™å®šçš„åå­—åˆ›å»ºLocation</p><p><code>func Sleep(d Duration)</code> // Sleepé˜»å¡å½“å‰goç¨‹è‡³å°‘dä»£è¡¨çš„æ—¶é—´æ®µã€‚d&lt;=0æ—¶ï¼ŒSleepä¼šç«‹åˆ»è¿”å›</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">d_second := time.Second</span><br><span class="line">time.Sleep(d_second)</span><br></pre></td></tr></table></figure><h3 id="ä¸€äº›å¸¸ç”¨çš„æŠ€å·§ä¸ä»£ç ç¤ºä¾‹"><a href="#ä¸€äº›å¸¸ç”¨çš„æŠ€å·§ä¸ä»£ç ç¤ºä¾‹" class="headerlink" title="ä¸€äº›å¸¸ç”¨çš„æŠ€å·§ä¸ä»£ç ç¤ºä¾‹"></a>ä¸€äº›å¸¸ç”¨çš„æŠ€å·§ä¸ä»£ç ç¤ºä¾‹</h3><ul><li><p>stringä¸time.Timeäº’è½¬</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">date        = <span class="string">"2006-01-02"</span></span><br><span class="line">datetime    = <span class="string">"2006-01-02 15:04:02"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">timeStamp := time.Now().Format(date) <span class="comment">//å°†å½“å‰æ—¶é—´ï¼Œå³time.Timeç±»å‹è½¬ä¸ºstring</span></span><br><span class="line"></span><br><span class="line">billTimeStamp, err := time.Parse(date,timeStamp)<span class="comment">//å°†Stringç±»å‹çš„æ—¶é—´è½¬ä¸ºtime.Timeç±»å‹</span></span><br></pre></td></tr></table></figure></li><li><p>unix timeä¸Stringäº’è½¬</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">endTime := time.Unix(time.Now().Unix(), <span class="number">0</span>)<span class="comment">//æ­¤æ—¶endTimeæ˜¯time.Timeç±»å‹</span></span><br><span class="line">endStr := endTime.Format(datetime)<span class="comment">//å°†unix time è½¬ä¸ºäº†Stringï¼Œå†æ ¹æ®ä¸Šé¢çš„ä¾‹å­ï¼Œå¯è½¬ä¸ºtime.Time</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"time"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//è·å–æ—¶é—´æˆ³</span></span><br><span class="line"></span><br><span class="line">timestamp := time.Now().Unix()</span><br><span class="line"></span><br><span class="line">fmt.Println(timestamp)</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²,tmä¸ºTimeç±»å‹</span></span><br><span class="line"></span><br><span class="line">tm := time.Unix(timestamp, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(tm.Format(<span class="string">"2006-01-02 03:04:05 PM"</span>))</span><br><span class="line"></span><br><span class="line">fmt.Println(tm.Format(<span class="string">"02/01/2006 15:04:05 PM"</span>))</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»å­—ç¬¦ä¸²è½¬ä¸ºæ—¶é—´æˆ³ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¼å¼ï¼Œç¬¬äºŒä¸ªæ˜¯è¦è½¬æ¢çš„æ—¶é—´å­—ç¬¦ä¸²</span></span><br><span class="line"></span><br><span class="line">tm2, _ := time.Parse(<span class="string">"01/02/2006"</span>, <span class="string">"02/08/2018"</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(tm2.Unix())</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç›¸å…³å‚è€ƒ"><a href="#ç›¸å…³å‚è€ƒ" class="headerlink" title="ç›¸å…³å‚è€ƒ"></a>ç›¸å…³å‚è€ƒ</h4><p><a href="https://link.jianshu.com/?t=http://studygolang.com/static/pkgdoc/pkg/time.htm" target="_blank" rel="noopener">pkg/timeä¸­æ–‡ç¿»è¯‘</a></p><p><a href="https://link.jianshu.com/?t=https://golang.org/pkg/time/" target="_blank" rel="noopener">pkg/timeè‹±æ–‡</a></p>]]></content>
    
    <summary type="html">
    
      golang timeåŒ…çš„è§£æä¸ä½¿ç”¨
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>ä»å†’æ³¡æ’åºä¼˜åŒ–åˆ°GoåŸºå‡†æµ‹è¯•</title>
    <link href="https://cloudsjhan.github.io/2018/12/15/%E4%BB%8E%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96%E5%88%B0Go%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/"/>
    <id>https://cloudsjhan.github.io/2018/12/15/ä»å†’æ³¡æ’åºä¼˜åŒ–åˆ°GoåŸºå‡†æµ‹è¯•/</id>
    <published>2018-12-15T15:12:08.000Z</published>
    <updated>2018-12-15T16:03:47.813Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="Goçš„æµ‹è¯•"><a href="#Goçš„æµ‹è¯•" class="headerlink" title="Goçš„æµ‹è¯•"></a>Goçš„æµ‹è¯•</h3><h4 id="å•å…ƒæµ‹è¯•"><a href="#å•å…ƒæµ‹è¯•" class="headerlink" title="å•å…ƒæµ‹è¯•"></a>å•å…ƒæµ‹è¯•</h4><ul><li>æµ‹è¯•æ–‡ä»¶å‘½åï¼šæ–‡ä»¶å‘½åä½¿ç”¨ xx_test.go ä¿å­˜åœ¨é¡¹ç›®ç›®å½•é‡Œå³å¯ï¼Œä¹Ÿå¯ä»¥æ–°å»ºä¸ªtestç›®å½•ï¼ŒTestAllï¼›</li><li>æµ‹è¯•å‡½æ•°å‘½åï¼šå•å…ƒæµ‹è¯•å‡½æ•°åTestå¼€å¤´ï¼Œæ¥æ”¶ä¸€ä¸ªæŒ‡é’ˆå‹å‚æ•°ï¼ˆ*testing.Tï¼‰ï¼›</li><li>è¿è¡Œæµ‹è¯•ç¨‹åºï¼šgo run test -v -run=â€å‡½æ•°åâ€ï¼Œå…¶ä¸­-væ„æ€æ˜¯è¾“å‡ºè¯¦ç»†çš„æµ‹è¯•ä¿¡æ¯ï¼›</li></ul><h4 id="åŸºå‡†æµ‹è¯•"><a href="#åŸºå‡†æµ‹è¯•" class="headerlink" title="åŸºå‡†æµ‹è¯•"></a>åŸºå‡†æµ‹è¯•</h4><ul><li>æµ‹è¯•æ–‡ä»¶å‘½åï¼šæµ‹è¯•æ–‡ä»¶å‘½åï¼šæ–‡ä»¶å‘½åä½¿ç”¨ xx_test.go ä¿å­˜åœ¨é¡¹ç›®ç›®å½•é‡Œå³å¯ï¼Œä¹Ÿå¯ä»¥æ–°å»ºä¸ªtestç›®å½•ï¼ŒTestAllï¼›</li><li>æµ‹è¯•å‡½æ•°å‘½åï¼šåŸºå‡†æµ‹è¯•ä»¥Benchmarkå¼€å¤´ï¼Œæ¥æ”¶ä¸€ä¸ªæŒ‡é’ˆå‹å‚æ•°ï¼ˆ*testing.Bï¼‰ï¼›</li><li>è¿è¡Œæµ‹è¯•ç¨‹åºï¼šgo test -v -bench=â€å‡½æ•°åâ€ï¼›</li><li>è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ -benchmem, -benchmem è¡¨ç¤ºåˆ†é…å†…å­˜çš„æ¬¡æ•°å’Œå­—èŠ‚æ•°ï¼Œ-benchtime=â€3sâ€ è¡¨ç¤ºæŒç»­3ç§’</li></ul><h3 id="å†’æ³¡æ’åºåŠå…¶ç®€å•ä¼˜åŒ–"><a href="#å†’æ³¡æ’åºåŠå…¶ç®€å•ä¼˜åŒ–" class="headerlink" title="å†’æ³¡æ’åºåŠå…¶ç®€å•ä¼˜åŒ–"></a>å†’æ³¡æ’åºåŠå…¶ç®€å•ä¼˜åŒ–</h3><h4 id="å†’æ³¡æ’åº"><a href="#å†’æ³¡æ’åº" class="headerlink" title="å†’æ³¡æ’åº"></a>å†’æ³¡æ’åº</h4><p>å‰å‡ å¤©çœ‹ä¸€ä¸ªå…¬ä¼—å·ï¼Œè¯´æ˜¯æœ‰ä¸ªäººå»ç¾å›¢é¢è¯•ï¼Œè¢«è¦æ±‚æ‰‹å†™å†’æ³¡æ’åºç®—æ³•ï¼Œè¿™äººå¿ƒæƒ³è¿™è¿˜ä¸ç®€å•çš„ï¼Œåˆ†åˆ†é’Ÿå†™ä¸‹äº†ä¸‹é¢çš„ä»£ç ï¼Œå¯ä»¥è¯´æ˜¯éå¸¸æ ‡å‡†çš„å†’æ³¡æ’åºäº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BubbleSort</span><span class="params">(array []<span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>; i&lt;<span class="built_in">len</span>(array)<span class="number">-1</span>;i++&#123;</span><br><span class="line"><span class="keyword">for</span> j :=<span class="number">0</span>;j&lt;<span class="built_in">len</span>(array)-i<span class="number">-1</span>;j++&#123;</span><br><span class="line"><span class="keyword">if</span> array[j]&gt;array[j+<span class="number">1</span>]&#123;</span><br><span class="line">swap(j, j+<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯éšä¹‹ï¼Œé¢è¯•å®˜è¯´è®©ä»–ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªç®—æ³•ï¼Œé—®ä»–æœ‰æ²¡æœ‰å¯ä¼˜åŒ–çš„åœ°æ–¹ï¼Œè¿™äººå°±æ‡µé€¼äº†ã€‚å…¶å®å†’æ³¡æ’åºå¯ä¼˜åŒ–çš„åœ°æ–¹å¾ˆå¤šï¼Œæœ€ç®€å•çš„ä¸€ç§å°±æ˜¯åŠ ä¸€ä¸ªæ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»æ’åºå®Œæ¯•ï¼Œæ’åºå·²ç»å®Œæˆçš„è¯å°±æ²¡æœ‰å¿…è¦å†æ¯”è¾ƒä¸‹å»ï¼Œæµªè´¹æ—¶é—´ã€‚ä¸Šé¢çš„ä»£ç æ·»åŠ å‡ è¡Œï¼Œé‚£äººå°±å¾ˆå¯èƒ½æ‹¿åˆ°offeräº†ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">BubbleSort</span><span class="params">(array []<span class="keyword">int</span>)</span></span>  &#123;</span><br><span class="line">i := <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">0</span>; i&lt;<span class="built_in">len</span>(array)<span class="number">-1</span>;i++&#123;</span><br><span class="line">exchanged := <span class="literal">false</span></span><br><span class="line"><span class="keyword">for</span> j :=<span class="number">0</span>;j&lt;<span class="built_in">len</span>(array)-i<span class="number">-1</span>;j++&#123;</span><br><span class="line"><span class="keyword">if</span> array[j]&gt;array[j+<span class="number">1</span>]&#123;</span><br><span class="line">swap(j, j+<span class="number">1</span>)</span><br><span class="line">exchanged = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> exchanged == <span class="literal">false</span> &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆï¼Œå¦‚ä½•æ›´ç›´è§‚çš„çœ‹å‡ºï¼Œä¼˜åŒ–è¿‡çš„ä»£ç ç¡®å®æœ‰æ•ˆå‘¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨goè‡ªå¸¦çš„åŸºå‡†æµ‹è¯•ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸¤æ®µä»£ç çš„æ€§èƒ½ï¼Œä¼˜åŒ–ä¸å¦å°±ä¸€ç›®äº†ç„¶ã€‚</p><h3 id="åŸºå‡†æµ‹è¯•å†’æ³¡æ’åº"><a href="#åŸºå‡†æµ‹è¯•å†’æ³¡æ’åº" class="headerlink" title="åŸºå‡†æµ‹è¯•å†’æ³¡æ’åº"></a>åŸºå‡†æµ‹è¯•å†’æ³¡æ’åº</h3><ul><li><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå­˜æ”¾æµ‹è¯•æ–‡ä»¶çš„æ–‡ä»¶å¤¹</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir testAll</span><br></pre></td></tr></table></figure></li><li><p>ç„¶ååˆ›å»ºåŸºå‡†æµ‹è¯•æ–‡ä»¶</p></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">touch benchmark_test.<span class="keyword">go</span></span><br></pre></td></tr></table></figure><ul><li>ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç </li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">var sortArray = []int&#123;41, 24, 76, 11, 45, 64, 21, 69, 19, 36&#125;</span><br><span class="line">func BenchmarkBubbleSort(b *testing.B)  &#123;</span><br><span class="line"></span><br><span class="line">for i:=0;i&lt;b.N;i++ &#123;</span><br><span class="line">BubbleSort(sortArray)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•åŸºæœ¬å†’æ³¡æ’åº"><a href="#æµ‹è¯•åŸºæœ¬å†’æ³¡æ’åº" class="headerlink" title="æµ‹è¯•åŸºæœ¬å†’æ³¡æ’åº"></a>æµ‹è¯•åŸºæœ¬å†’æ³¡æ’åº</h4><ul><li><p>æˆ‘ä»¬é¦–å…ˆæµ‹è¯•æœ€åŸå§‹çš„å†’æ³¡æ’åº</p></li><li><p>åœ¨testAllæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go test -v -bench=&quot;BubbleSort&quot;</span><br></pre></td></tr></table></figure><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fy7v2wibo3j313o0bgta3.jpg" alt=""></p><p>åŸºå‡†æµ‹è¯•ç»“æœå¦‚å›¾æ‰€ç¤ºï¼Œè§£é‡Šä¸€ä¸‹å‡ ä¸ªå…³é”®å‚æ•°ï¼Œ</p><p>81.2ns/op è¡¨ç¤ºæ¯æ¬¡æ“ä½œè€—æ—¶81.2çº³ç§’ï¼Œ1.725sè¡¨ç¤ºç¨‹åºè¿è¡Œçš„æ—¶é—´ã€‚</p><h3 id="æµ‹è¯•ä¼˜åŒ–çš„å†’æ³¡æ’åº"><a href="#æµ‹è¯•ä¼˜åŒ–çš„å†’æ³¡æ’åº" class="headerlink" title="æµ‹è¯•ä¼˜åŒ–çš„å†’æ³¡æ’åº"></a>æµ‹è¯•ä¼˜åŒ–çš„å†’æ³¡æ’åº</h3><ul><li>æ‰§è¡Œ</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go test -v -bench=&quot;BubbleSort&quot;</span><br></pre></td></tr></table></figure><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fy7v8m1tz8j31400bcmyk.jpg" alt=""></p></li></ul><p>  å¯ä»¥çœ‹åˆ°ä¼˜åŒ–è¿‡çš„ä»£ç ï¼Œæ‰§è¡Œæ—¶é—´ä¸º1.2s,è€Œä¸”æ¯æ¬¡æ“ä½œçš„è€—æ—¶ä¸º23.0çº³ç§’ï¼Œè¶³è¶³é™ä½äº†60%å¤šã€‚å¯è§ä¸€ä¸ªå¾ˆç®€å•çš„ä¼˜åŒ–å°±å¯ä»¥ä½¿ä»£ç æå‡è¿™ä¹ˆå¤šï¼Œåœ¨ä»¥åçš„å·¥ä½œä¸­ï¼Œå¯¹äºä»£ç çš„è®¾è®¡ä¸ä¼˜åŒ–è¿˜æ˜¯è¦é‡è§†ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      ä»å†’æ³¡æ’åºçœ‹Goçš„åŸºå‡†æµ‹è¯•åŠå…¶ä½¿ç”¨
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/tags/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
  </entry>
  
  <entry>
    <title>postman æ¥å£æµ‹è¯•ç¥å™¨</title>
    <link href="https://cloudsjhan.github.io/2018/12/08/postman-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E7%A5%9E%E5%99%A8/"/>
    <id>https://cloudsjhan.github.io/2018/12/08/postman-æ¥å£æµ‹è¯•ç¥å™¨/</id>
    <published>2018-12-08T15:41:16.000Z</published>
    <updated>2018-12-08T15:54:58.525Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><a id="more"></a><h1 id="Postman-æ¥å£æµ‹è¯•ç¥å™¨"><a href="#Postman-æ¥å£æµ‹è¯•ç¥å™¨" class="headerlink" title="Postman æ¥å£æµ‹è¯•ç¥å™¨"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=postman-%e6%8e%a5%e5%8f%a3%e6%b5%8b%e8%af%95%e7%a5%9e%e5%99%a8" target="_blank" rel="noopener">Postman æ¥å£æµ‹è¯•ç¥å™¨</a></h1><p>Postman æ˜¯ä¸€ä¸ªæ¥å£æµ‹è¯•å’Œ http è¯·æ±‚çš„ç¥å™¨ï¼Œéå¸¸å¥½ç”¨ã€‚</p><p>å®˜æ–¹ github åœ°å€: <a href="https://github.com/postmanlabs" target="_blank" rel="noopener">https://github.com/postmanlabs</a></p><p>Postman çš„ä¼˜ç‚¹ï¼š</p><ul><li>æ”¯æŒå„ç§çš„è¯·æ±‚ç±»å‹: getã€postã€putã€patchã€delete ç­‰</li><li>æ”¯æŒåœ¨çº¿å­˜å‚¨æ•°æ®ï¼Œé€šè¿‡è´¦å·å°±å¯ä»¥è¿›è¡Œè¿ç§»æ•°æ®</li><li>å¾ˆæ–¹ä¾¿çš„æ”¯æŒè¯·æ±‚ header å’Œè¯·æ±‚å‚æ•°çš„è®¾ç½®</li><li>æ”¯æŒä¸åŒçš„è®¤è¯æœºåˆ¶ï¼ŒåŒ…æ‹¬ Basic Authï¼ŒDigest Authï¼ŒOAuth 1.0ï¼ŒOAuth 2.0 ç­‰</li><li>å“åº”æ•°æ®æ˜¯è‡ªåŠ¨æŒ‰ç…§è¯­æ³•æ ¼å¼é«˜äº®çš„ï¼ŒåŒ…æ‹¬ HTMLï¼ŒJSON å’Œ XML</li></ul><blockquote><p> ä»¥ä¸‹å†…å®¹ä¸»è¦å‚è€ƒï¼š <a href="https://github.com/crifan/api_tool_postman" target="_blank" rel="noopener">Github: api_tool_postman</a>  </p></blockquote><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%ae%89%e8%a3%85" target="_blank" rel="noopener">å®‰è£…</a></h2><p>Postman å¯ä»¥å•ç‹¬ä½œä¸ºä¸€ä¸ªåº”ç”¨å®‰è£…ï¼Œä¹Ÿå¯ä»¥ä½œä¸º chrome çš„ä¸€ä¸ªæ’ä»¶å®‰è£…ã€‚</p><ul><li>chrome æ’ä»¶å®‰è£…, <a href="https://chrome.google.com/webstore/detail/postman/fhbjgbiflinjbdggehcddcbncdddomop" target="_blank" rel="noopener">Postman æ’ä»¶åœ°å€</a>  </li><li><a href="http://files.cnblogs.com/files/mafly/postman-4.1.2.rar" target="_blank" rel="noopener">å•ç‹¬åº”ç”¨å®‰è£…ä¸‹è½½</a>  </li></ul><p>ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹è½½å®‰è£…ç‹¬ç«‹ç‰ˆæœ¬app è½¯ä»¶çš„ Postman çš„è¿‡ç¨‹ï¼š</p><p>å»ä¸»é¡µ<a href="https://www.getpostman.com/" target="_blank" rel="noopener">Postman å®˜ç½‘</a>æ‰¾åˆ°ï¼š<a href="https://www.getpostman.com/apps" target="_blank" rel="noopener">Postman | Apps</a></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/c7j24uyvhy.png?imageView2/2/w/1620" alt="img"></p><p>å»ä¸‹è½½è‡ªå·±å¹³å°çš„ç‰ˆæœ¬ï¼š</p><ul><li>Mac</li><li>Windowsï¼ˆx86/x64ï¼‰</li><li>Linuxï¼ˆx86/x64ï¼‰ å³å¯ã€‚</li></ul><h2 id="å¿«é€Ÿå…¥é—¨ï¼Œæ€»ä½“ä½¿ç”¨æ–¹ç•¥"><a href="#å¿«é€Ÿå…¥é—¨ï¼Œæ€»ä½“ä½¿ç”¨æ–¹ç•¥" class="headerlink" title="å¿«é€Ÿå…¥é—¨ï¼Œæ€»ä½“ä½¿ç”¨æ–¹ç•¥"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%bf%ab%e9%80%9f%e5%85%a5%e9%97%a8%ef%bc%8c%e6%80%bb%e4%bd%93%e4%bd%bf%e7%94%a8%e6%96%b9%e7%95%a5" target="_blank" rel="noopener">å¿«é€Ÿå…¥é—¨ï¼Œæ€»ä½“ä½¿ç”¨æ–¹ç•¥</a></h2><p>å®‰è£…æˆåŠŸåï¼Œæ‰“å¼€è½¯ä»¶ã€‚</p><h3 id="æ–°å»ºæ¥å£"><a href="#æ–°å»ºæ¥å£" class="headerlink" title="æ–°å»ºæ¥å£"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%96%b0%e5%bb%ba%e6%8e%a5%e5%8f%a3" target="_blank" rel="noopener">æ–°å»ºæ¥å£</a></h3><p>å¯¹åº”çš„Requestï¼š<code>New -&gt; Request</code></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/a43avzlvvt.png?imageView2/2/w/1620" alt="img"></p><p>æˆ–ï¼Œåœ¨å³è¾¹çš„ Tab é¡µé¢ä¸­ç‚¹å‡»åŠ å·+ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/kr7zu3lg54.png?imageView2/2/w/1620" alt="img"></p><p>å³å¯çœ‹åˆ°æ–°å»ºçš„ Tab é¡µï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/7x0f5ohfxq.png?imageView2/2/w/1620" alt="img"></p><h3 id="è®¾ç½®-HTTP-è¯·æ±‚çš„æ–¹æ³•"><a href="#è®¾ç½®-HTTP-è¯·æ±‚çš„æ–¹æ³•" class="headerlink" title="è®¾ç½® HTTP è¯·æ±‚çš„æ–¹æ³•"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e8%ae%be%e7%bd%ae-http-%e8%af%b7%e6%b1%82%e7%9a%84%e6%96%b9%e6%b3%95" target="_blank" rel="noopener">è®¾ç½® HTTP è¯·æ±‚çš„æ–¹æ³•</a></h3><p>è®¾ç½® HTTP çš„ Method æ–¹æ³•å’Œè¾“å…¥ api çš„åœ°å€</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/nvkjcxavj1.png?imageView2/2/w/1620" alt="img"></p><h3 id="è®¾ç½®ç›¸å…³è¯·æ±‚å¤´ä¿¡æ¯"><a href="#è®¾ç½®ç›¸å…³è¯·æ±‚å¤´ä¿¡æ¯" class="headerlink" title="è®¾ç½®ç›¸å…³è¯·æ±‚å¤´ä¿¡æ¯"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e8%ae%be%e7%bd%ae%e7%9b%b8%e5%85%b3%e8%af%b7%e6%b1%82%e5%a4%b4%e4%bf%a1%e6%81%af" target="_blank" rel="noopener">è®¾ç½®ç›¸å…³è¯·æ±‚å¤´ä¿¡æ¯</a></h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/sde0dugknd.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/d4vmkb97c4.png?imageView2/2/w/1620" alt="img"></p><h3 id="è®¾ç½®ç›¸å…³-GET-æˆ–-POST-ç­‰çš„å‚æ•°"><a href="#è®¾ç½®ç›¸å…³-GET-æˆ–-POST-ç­‰çš„å‚æ•°" class="headerlink" title="è®¾ç½®ç›¸å…³ GET æˆ– POST ç­‰çš„å‚æ•°"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e8%ae%be%e7%bd%ae%e7%9b%b8%e5%85%b3-get-%e6%88%96-post-%e7%ad%89%e7%9a%84%e5%8f%82%e6%95%b0" target="_blank" rel="noopener">è®¾ç½®ç›¸å…³ GET æˆ– POST ç­‰çš„å‚æ•°</a></h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/qgi9b1hmbs.png?imageView2/2/w/1620" alt="img"></p><h3 id="å‘é€è¯·æ±‚"><a href="#å‘é€è¯·æ±‚" class="headerlink" title="å‘é€è¯·æ±‚"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8f%91%e9%80%81%e8%af%b7%e6%b1%82" target="_blank" rel="noopener">å‘é€è¯·æ±‚</a></h3><p>éƒ½å¡«å†™å¥½ä¹‹åï¼Œç‚¹å‡» Send å»å‘é€è¯·æ±‚ Requestï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/u4cd93numl.png?imageView2/2/w/1620" alt="img"></p><h3 id="æŸ¥çœ‹å“åº”-Responseçš„ä¿¡æ¯"><a href="#æŸ¥çœ‹å“åº”-Responseçš„ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹å“åº” Responseçš„ä¿¡æ¯"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%9f%a5%e7%9c%8b%e5%93%8d%e5%ba%94-response%e7%9a%84%e4%bf%a1%e6%81%af" target="_blank" rel="noopener">æŸ¥çœ‹å“åº” Responseçš„ä¿¡æ¯</a></h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/oo22jbrg8v.png?imageView2/2/w/1620" alt="img"></p><p>ç„¶åå¯ä»¥é‡å¤ä¸Šè¿°ä¿®æ”¹ Request çš„å‚æ•°ï¼Œç‚¹å‡» Send å»å‘é€è¯·æ±‚çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿è°ƒè¯•åˆ° API æ¥å£æ­£å¸¸å·¥ä½œä¸ºæ­¢ã€‚</p><h3 id="ä¿å­˜æ¥å£é…ç½®"><a href="#ä¿å­˜æ¥å£é…ç½®" class="headerlink" title="ä¿å­˜æ¥å£é…ç½®"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e4%bf%9d%e5%ad%98%e6%8e%a5%e5%8f%a3%e9%85%8d%e7%bd%ae" target="_blank" rel="noopener">ä¿å­˜æ¥å£é…ç½®</a></h3><p>å¾…æ•´ä¸ªæ¥å£éƒ½è°ƒè¯•å®Œæ¯•åï¼Œè®°å¾—ç‚¹å‡» Save å»ä¿å­˜æ¥å£ä¿¡æ¯ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/n2p3eq0ie6.png?imageView2/2/w/1620" alt="img"></p><p>å»ä¿å­˜å½“å‰ API æ¥å£ï¼Œç„¶åéœ€è¦å¡«å†™ç›¸å…³çš„æ¥å£ä¿¡æ¯ï¼š</p><ul><li>Request Name: è¯·æ±‚çš„åå­— <ul><li>æˆ‘ä¸€èˆ¬ä¹ æƒ¯ç”¨ä¿å­˜ä¸º æ¥å£çš„æœ€åçš„å­—æ®µåï¼Œæ¯”å¦‚<code>http://{{server_address}}/ucows/login/login</code>ä¸­çš„<code>/login/login</code></li></ul></li><li>Request Description: æ¥å£çš„æè¿° <ul><li><code>å¯é€‰</code> æœ€å¥½å†™ä¸Šè¯¥æ¥å£çš„è¦å®ç°çš„åŸºæœ¬åŠŸèƒ½å’Œç›¸å…³æ³¨æ„äº‹é¡¹</li><li>æ”¯æŒ Markdown è¯­æ³•</li></ul></li><li>Select a collection or folder to save: é€‰æ‹©è¦ä¿å­˜åˆ°å“ªä¸ªåˆ†ç»„ï¼ˆæˆ–æ–‡ä»¶å¤¹ï¼‰ <ul><li>å¾€å¾€ä¿å­˜åˆ°æŸä¸ª API æ¥å£åˆ°æ‰€å±çš„è¯¥é¡¹ç›®åçš„åˆ†ç»„</li></ul></li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/zntknyfx6w.png?imageView2/2/w/1620" alt="img"></p><p>å¡«å†™å¥½å†…å®¹ï¼Œé€‰æ‹©å¥½åˆ†ç»„ï¼Œå†ç‚¹å‡»ä¿å­˜ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/sb5yb8cwpi.png?imageView2/2/w/1620" alt="img"></p><p>æ­¤æ—¶ï¼ŒTab çš„å³ä¸Šè§’çš„é»„è‰²ç‚¹ï¼ˆè¡¨ç¤ºæ²¡æœ‰ä¿å­˜ï¼‰æ¶ˆå¤±äº†ï¼Œè¡¨ç¤ºå·²ä¿å­˜ã€‚</p><p>ä¸”å¯¹åº”çš„åˆ†ç»„ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æ¥å£äº†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/x3lmlaykbk.png?imageView2/2/w/1620" alt="img"></p><blockquote><p> [warning] é»˜è®¤ä¸ä¿å­˜è¿”å›çš„ Response æ•°æ®  </p></blockquote><ul><li>ç›´æ¥ç‚¹å‡» Save å»ä¿å­˜ï¼Œåªèƒ½ä¿å­˜ API æœ¬èº«ï¼ˆçš„ Request è¯·æ±‚ï¼‰ï¼Œä¸ä¼šä¿å­˜ Response çš„æ•°æ®</li><li>æƒ³è¦ä¿å­˜ Response æ•°æ®ï¼Œéœ€è¦ç”¨åé¢è¦ä»‹ç»çš„ <a href="http://book.crifan.com/books/api_tool_postman/website/postman_func_resp/save_multi_example.html" target="_blank" rel="noopener">å¤šä¸ª Example</a></li></ul><h2 id="Request-çš„å¤šå‚æ•°æ“ä½œè¯¦è§£"><a href="#Request-çš„å¤šå‚æ•°æ“ä½œè¯¦è§£" class="headerlink" title="Request çš„å¤šå‚æ•°æ“ä½œè¯¦è§£"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=request-%e7%9a%84%e5%a4%9a%e5%8f%82%e6%95%b0%e6%93%8d%e4%bd%9c%e8%af%a6%e8%a7%a3" target="_blank" rel="noopener">Request çš„å¤šå‚æ•°æ“ä½œè¯¦è§£</a></h2><h3 id="è‡ªåŠ¨è§£æå¤šä¸ªå‚æ•°-Params"><a href="#è‡ªåŠ¨è§£æå¤šä¸ªå‚æ•°-Params" class="headerlink" title="è‡ªåŠ¨è§£æå¤šä¸ªå‚æ•° Params"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e8%87%aa%e5%8a%a8%e8%a7%a3%e6%9e%90%e5%a4%9a%e4%b8%aa%e5%8f%82%e6%95%b0-params" target="_blank" rel="noopener">è‡ªåŠ¨è§£æå¤šä¸ªå‚æ•° Params</a></h3><p>æ¯”å¦‚ï¼Œå¯¹äºä¸€ä¸ª GET çš„è¯·æ±‚çš„ url æ˜¯ï¼š <code>http://openapi.youdao.com/api?q=çº åˆ ç (EC)çš„å­¦ä¹ &amp;from=zh_CHS&amp;to=EN&amp;appKey=152e0e77723a0026&amp;salt=4&amp;sign=6BE15F1868019AD71C442E6399DB1FE4</code></p><p>å¯¹åº”ç€å…¶å®æ˜¯<code>?key=value</code>å½¢å¼ä¸­åŒ…å«å¤šä¸ª Http çš„ GET çš„ query string=query parameters</p><p>Postman å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬è§£æå‡ºå¯¹åº”å‚æ•°ï¼Œå¯ä»¥ç‚¹å‡» Paramsï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/9kga5uhyuq.png?imageView2/2/w/1620" alt="img"></p><p>çœ‹åˆ°å±•å¼€çš„å¤šä¸ªå‚æ•°ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/2agjjtnusz.png?imageView2/2/w/1620" alt="img"></p><p>å¦‚æ­¤å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¿®æ”¹ï¼Œå¢åˆ å¯¹åº”çš„å‚æ•°äº†ã€‚</p><h3 id="ä¸´æ—¶ç¦ç”¨å‚æ•°"><a href="#ä¸´æ—¶ç¦ç”¨å‚æ•°" class="headerlink" title="ä¸´æ—¶ç¦ç”¨å‚æ•°"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e4%b8%b4%e6%97%b6%e7%a6%81%e7%94%a8%e5%8f%82%e6%95%b0" target="_blank" rel="noopener">ä¸´æ—¶ç¦ç”¨å‚æ•°</a></h3><p>ä¸”è¿˜æ”¯æŒï¼Œåœ¨ä¸åˆ é™¤æŸå‚æ•°çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæƒ³è¦æš‚æ—¶ä¸ä¼ å‚æ•°ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ä¸å‹¾é€‰çš„æ–¹å¼å»å®ç°ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/atacmafooc.png?imageView2/2/w/1620" alt="img"></p><h3 id="æ‰¹é‡ç¼–è¾‘-GET-çš„å¤šä¸ªå‚æ•°"><a href="#æ‰¹é‡ç¼–è¾‘-GET-çš„å¤šä¸ªå‚æ•°" class="headerlink" title="æ‰¹é‡ç¼–è¾‘ GET çš„å¤šä¸ªå‚æ•°"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%89%b9%e9%87%8f%e7%bc%96%e8%be%91-get-%e7%9a%84%e5%a4%9a%e4%b8%aa%e5%8f%82%e6%95%b0" target="_blank" rel="noopener">æ‰¹é‡ç¼–è¾‘ GET çš„å¤šä¸ªå‚æ•°</a></h3><p>å½“ç„¶ï¼Œå¦‚æœæƒ³è¦æ‰¹é‡çš„ç¼–è¾‘å‚æ•°ï¼Œå¯ä»¥ç‚¹å‡»å³ä¸Šè§’çš„Bulk Editï¼Œå»å®ç°æ‰¹é‡ç¼–è¾‘ã€‚</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/xn3piv6qv8.png?imageView2/2/w/1620" alt="img"></p><h2 id="æ¥å£æè¿°ä¸è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£"><a href="#æ¥å£æè¿°ä¸è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£" class="headerlink" title="æ¥å£æè¿°ä¸è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%8e%a5%e5%8f%a3%e6%8f%8f%e8%bf%b0%e4%b8%8e%e8%87%aa%e5%8a%a8%e7%94%9f%e6%88%90%e6%96%87%e6%a1%a3" target="_blank" rel="noopener">æ¥å£æè¿°ä¸è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£</a></h2><p>API çš„æè¿°ä¸­ï¼Œä¹Ÿæ”¯æŒ Markdownï¼Œå®˜æ–¹çš„æ¥å£è¯´æ˜æ–‡æ¡£ï¼š<a href="https://www.getpostman.com/docs/postman/api_documentation/intro_to_api_documentation" target="_blank" rel="noopener">Intro to API documentation</a>ã€‚</p><p>æ‰€ä»¥ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ·»åŠ æœ‰æ¡ç†çš„æ¥å£æè¿°ï¼Œå°¤å…¶æ˜¯å‚æ•°è§£é‡Šäº†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/428i64obvu.png?imageView2/2/w/1620" alt="img"></p><h3 id="æè¿°æ”¯æŒ-markdown-è¯­æ³•"><a href="#æè¿°æ”¯æŒ-markdown-è¯­æ³•" class="headerlink" title="æè¿°æ”¯æŒ markdown è¯­æ³•"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%8f%8f%e8%bf%b0%e6%94%af%e6%8c%81-markdown-%e8%af%ad%e6%b3%95" target="_blank" rel="noopener">æè¿°æ”¯æŒ markdown è¯­æ³•</a></h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/gae7gd5ldb.png?imageView2/2/w/1620" alt="img"></p><p>è€Œå¯¹äºè¦è§£é‡Šçš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ä¹‹å‰çš„<code>Param -&gt; Bulk Edit</code>çš„å†…å®¹ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/k8h8cccbmy.png?imageView2/2/w/1620" alt="img"></p><p>æ‹·è´è¿‡æ¥ï¼Œå†ç»§ç»­å»ç¼–è¾‘ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/q3ehctbg4b.png?imageView2/2/w/1620" alt="img"></p><p>ä»¥åŠæ·»åŠ æ›´å¤šè§£é‡Šä¿¡æ¯ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/cvxks97jg5.png?imageView2/2/w/1620" alt="img"></p><p>ç‚¹å‡» Update åï¼Œå³å¯ä¿å­˜ã€‚</p><h3 id="å‘å¸ƒæ¥å£å¹¶ç”Ÿæˆ-markdown-çš„æè¿°æ–‡ä»¶"><a href="#å‘å¸ƒæ¥å£å¹¶ç”Ÿæˆ-markdown-çš„æè¿°æ–‡ä»¶" class="headerlink" title="å‘å¸ƒæ¥å£å¹¶ç”Ÿæˆ markdown çš„æè¿°æ–‡ä»¶"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8f%91%e5%b8%83%e6%8e%a5%e5%8f%a3%e5%b9%b6%e7%94%9f%e6%88%90-markdown-%e7%9a%84%e6%8f%8f%e8%bf%b0%e6%96%87%e4%bb%b6" target="_blank" rel="noopener">å‘å¸ƒæ¥å£å¹¶ç”Ÿæˆ markdown çš„æè¿°æ–‡ä»¶</a></h3><p>å»å‘å¸ƒåï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6td22h0mcp.png?imageView2/2/w/1620" alt="img"></p><p>å¯¹åº”çš„æ•ˆæœï¼š<a href="https://documenter.getpostman.com/view/669382/collection/77fd4ek" target="_blank" rel="noopener">æœ‰é“ç¿»è¯‘</a></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/w9r9f2lhvj.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6w93zr891f.png?imageView2/2/w/1620" alt="img"></p><h2 id="Response-æ·±å…¥"><a href="#Response-æ·±å…¥" class="headerlink" title="Response æ·±å…¥"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=response-%e6%b7%b1%e5%85%a5" target="_blank" rel="noopener">Response æ·±å…¥</a></h2><h3 id="Response-æ•°æ®æ˜¾ç¤ºæ¨¡å¼"><a href="#Response-æ•°æ®æ˜¾ç¤ºæ¨¡å¼" class="headerlink" title="Response æ•°æ®æ˜¾ç¤ºæ¨¡å¼"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=response-%e6%95%b0%e6%8d%ae%e6%98%be%e7%a4%ba%e6%a8%a1%e5%bc%8f" target="_blank" rel="noopener">Response æ•°æ®æ˜¾ç¤ºæ¨¡å¼</a></h3><p>Postman å¯¹äºè¿”å›çš„ Response æ•°æ®ï¼Œæ”¯æŒä¸‰ç§æ˜¾ç¤ºæ¨¡å¼ã€‚</p><ul><li><code>é»˜è®¤</code>æ ¼å¼åŒ–åçš„ Pretty æ¨¡å¼</li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/90i3wajcea.png?imageView2/2/w/1620" alt="img"></p><ul><li>Raw åŸå§‹æ¨¡å¼</li></ul><p>ç‚¹å‡»Rawï¼Œå¯ä»¥æŸ¥çœ‹åˆ°è¿”å›çš„æ²¡æœ‰æ ¼å¼åŒ–ä¹‹å‰çš„åŸå§‹æ•°æ®ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/2o5e02t9ac.png?imageView2/2/w/1620" alt="img"></p><ul><li>Preview é¢„è§ˆæ¨¡å¼</li></ul><p>ä»¥åŠ Previewï¼Œæ˜¯å¯¹åº” Raw åŸå§‹æ ¼å¼çš„é¢„è§ˆæ¨¡å¼ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/jbnnfhoye4.png?imageView2/2/w/1620" alt="img"></p><p>Preview è¿™ç§æ¨¡å¼çš„æ˜¾ç¤ºæ•ˆæœï¼Œå¥½åƒæ˜¯å¯¹äºè¿”å›çš„æ˜¯ html é¡µé¢è¿™ç±»ï¼Œæ‰æ¯”è¾ƒæœ‰æ•ˆæœã€‚</p><h3 id="Response-çš„-Cookies"><a href="#Response-çš„-Cookies" class="headerlink" title="Response çš„ Cookies"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=response-%e7%9a%84-cookies" target="_blank" rel="noopener">Response çš„ Cookies</a></h3><p>å¾ˆå¤šæ—¶å€™æ™®é€šçš„ API è°ƒç”¨ï¼Œå€’æ˜¯æ²¡æœ‰ Cookie çš„ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/1srkh454hi.png?imageView2/2/w/1620" alt="img"></p><h3 id="Response-çš„-Headers-å¤´ä¿¡æ¯"><a href="#Response-çš„-Headers-å¤´ä¿¡æ¯" class="headerlink" title="Response çš„ Headers å¤´ä¿¡æ¯"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=response-%e7%9a%84-headers-%e5%a4%b4%e4%bf%a1%e6%81%af" target="_blank" rel="noopener">Response çš„ Headers å¤´ä¿¡æ¯</a></h3><p>ä¸¾ä¾‹ï¼Œæ­¤å¤„è¿”å›çš„æ˜¯æœ‰ Headers å¤´ä¿¡æ¯çš„ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/4hjkacbfao.png?imageView2/2/w/1620" alt="img"></p><p>å¯ä»¥ä»ä¸­çœ‹åˆ°æœåŠ¡å™¨æ˜¯ Nginx çš„ã€‚</p><h2 id="ä¿å­˜å¤šä¸ª-Example"><a href="#ä¿å­˜å¤šä¸ª-Example" class="headerlink" title="ä¿å­˜å¤šä¸ª Example"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e4%bf%9d%e5%ad%98%e5%a4%9a%e4%b8%aa-example" target="_blank" rel="noopener">ä¿å­˜å¤šä¸ª Example</a></h2><p>ä¹‹å‰æƒ³è¦å®ç°ï¼Œè®©å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­èƒ½çœ‹åˆ°æ¥å£è¿”å›çš„ Response æ•°æ®ã€‚åæ¥å‘ç°æ˜¯Exampleè¿™ä¸ªåŠŸèƒ½å»å®ç°æ­¤æ•ˆæœçš„ã€‚</p><h3 id="å¦‚ä½•æ·»åŠ -Example"><a href="#å¦‚ä½•æ·»åŠ -Example" class="headerlink" title="å¦‚ä½•æ·»åŠ  Example"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%a6%82%e4%bd%95%e6%b7%bb%e5%8a%a0-example" target="_blank" rel="noopener">å¦‚ä½•æ·»åŠ  Example</a></h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/4wjzn3wjr5.png?imageView2/2/w/1620" alt="img"></p><p>ç»§ç»­ç‚¹å‡»Save Exampleï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/pyzrhod8jg.png?imageView2/2/w/1620" alt="img"></p><p>ä¿å­˜åï¼Œå°±èƒ½çœ‹åˆ°Example(1)äº†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/dhmfi3mz78.png?imageView2/2/w/1620" alt="img"></p><h3 id="å•ä¸ª-Example-åœ¨å¯¼å‡ºçš„-API-æ–‡æ¡£ä¸­çš„æ•ˆæœ"><a href="#å•ä¸ª-Example-åœ¨å¯¼å‡ºçš„-API-æ–‡æ¡£ä¸­çš„æ•ˆæœ" class="headerlink" title="å•ä¸ª Example åœ¨å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­çš„æ•ˆæœ"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8d%95%e4%b8%aa-example-%e5%9c%a8%e5%af%bc%e5%87%ba%e7%9a%84-api-%e6%96%87%e6%a1%a3%e4%b8%ad%e7%9a%84%e6%95%88%e6%9e%9c" target="_blank" rel="noopener">å•ä¸ª Example åœ¨å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­çš„æ•ˆæœ</a></h3><p>ç„¶åå†å»å¯¼å‡ºæ–‡æ¡£ï¼Œå¯¼å‡ºæ–‡æ¡£ä¸­çš„ç¡®èƒ½çœ‹åˆ°è¿”å›æ•°æ®çš„ä¾‹å­ï¼š </p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/651td0ljtp.png?imageView2/2/w/1620" alt="img"></p><h3 id="å¤šä¸ª-Example-åœ¨å¯¼å‡ºçš„-API-æ–‡æ¡£ä¸­çš„æ•ˆæœ"><a href="#å¤šä¸ª-Example-åœ¨å¯¼å‡ºçš„-API-æ–‡æ¡£ä¸­çš„æ•ˆæœ" class="headerlink" title="å¤šä¸ª Example åœ¨å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­çš„æ•ˆæœ"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%a4%9a%e4%b8%aa-example-%e5%9c%a8%e5%af%bc%e5%87%ba%e7%9a%84-api-%e6%96%87%e6%a1%a3%e4%b8%ad%e7%9a%84%e6%95%88%e6%9e%9c" target="_blank" rel="noopener">å¤šä¸ª Example åœ¨å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­çš„æ•ˆæœ</a></h3><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6bte63z6hq.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6ckvn8fm3x.png?imageView2/2/w/1620" alt="img"></p><h2 id="å…¶ä»–å¥½ç”¨çš„åŠŸèƒ½åŠå·¥å…·"><a href="#å…¶ä»–å¥½ç”¨çš„åŠŸèƒ½åŠå·¥å…·" class="headerlink" title="å…¶ä»–å¥½ç”¨çš„åŠŸèƒ½åŠå·¥å…·"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%85%b6%e4%bb%96%e5%a5%bd%e7%94%a8%e7%9a%84%e5%8a%9f%e8%83%bd%e5%8f%8a%e5%b7%a5%e5%85%b7" target="_blank" rel="noopener">å…¶ä»–å¥½ç”¨çš„åŠŸèƒ½åŠå·¥å…·</a></h2><h3 id="åˆ†ç»„-Collection"><a href="#åˆ†ç»„-Collection" class="headerlink" title="åˆ†ç»„ Collection"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%88%86%e7%bb%84-collection" target="_blank" rel="noopener">åˆ†ç»„ Collection</a></h3><p>åœ¨åˆšå¼€å§‹ä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œä¸ºäº†åç»­ä¾¿äºç»„ç»‡å’Œç®¡ç†ï¼ŒæŠŠåŒå±è¯¥é¡¹ç›®çš„å¤šä¸ª APIï¼Œæ”¾åœ¨ä¸€ç»„é‡Œ</p><p>æ‰€ä»¥è¦å…ˆå»æ–°å»ºä¸€ä¸ª Collection: <code>New -&gt; Collection</code></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/lokimruefe.png?imageView2/2/w/1620" alt="img"></p><p>ä½¿ç”¨äº†æ®µæ—¶é—´åï¼Œå»ºäº†å¤šä¸ªåˆ†ç»„çš„æ•ˆæœï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ggk7qt7s4f.png?imageView2/2/w/1620" alt="img"></p><p>å•ä¸ªåˆ†ç»„å±•å¼€åçš„æ•ˆæœï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/w64q4ziv08.png?imageView2/2/w/1620" alt="img"></p><h3 id="å†å²è®°å½•-History"><a href="#å†å²è®°å½•-History" class="headerlink" title="å†å²è®°å½• History"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8e%86%e5%8f%b2%e8%ae%b0%e5%bd%95-history" target="_blank" rel="noopener">å†å²è®°å½• History</a></h3><p>Postman æ”¯æŒ history å†å²è®°å½•ï¼Œæ˜¾ç¤ºå‡ºæœ€è¿‘ä½¿ç”¨è¿‡çš„ APIï¼š </p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ui0g94c42i.png?imageView2/2/w/1620" alt="img"></p><h3 id="ç”¨ç¯å¢ƒå˜é‡å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬"><a href="#ç”¨ç¯å¢ƒå˜é‡å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬" class="headerlink" title="ç”¨ç¯å¢ƒå˜é‡å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e7%94%a8%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%ae%9e%e7%8e%b0%e5%a4%9a%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%89%88%e6%9c%ac" target="_blank" rel="noopener">ç”¨ç¯å¢ƒå˜é‡å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬</a></h3><h4 id="ç°å­˜é—®é¢˜"><a href="#ç°å­˜é—®é¢˜" class="headerlink" title="ç°å­˜é—®é¢˜"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e7%8e%b0%e5%ad%98%e9%97%ae%e9%a2%98" target="_blank" rel="noopener">ç°å­˜é—®é¢˜</a></h4><p>åœ¨æµ‹è¯• API æœŸé—´ï¼Œå¾€å¾€å­˜åœ¨å¤šç§ç¯å¢ƒï¼Œå¯¹åº” IP åœ°å€ï¼ˆæˆ–åŸŸåä¹Ÿä¸åŒï¼‰</p><p>æ¯”å¦‚ï¼š</p><ul><li><p>Prod: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://116.62.25.57/ucows</span><br></pre></td></tr></table></figure><ul><li>ç”¨äºå¼€å‘å®Œæˆå‘å¸ƒåˆ°ç”Ÿäº§ç¯å¢ƒ</li></ul></li><li><p>Dev: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://123.206.191.125/ucows</span><br></pre></td></tr></table></figure><ul><li>ç”¨äºå¼€å‘æœŸé—´çš„çº¿ä¸Šçš„ Development çš„æµ‹è¯•ç¯å¢ƒ</li></ul></li><li><p>LocalTest: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.0.140:80/ucows</span><br></pre></td></tr></table></figure><ul><li>ç”¨äºå¼€å‘æœŸé—´é…åˆåå°å¼€å‘äººå‘˜çš„æœ¬åœ°å±€åŸŸç½‘å†…çš„æœ¬åœ°ç¯å¢ƒï¼Œç”¨äºè”åˆè°ƒè¯• API æ¥å£</li></ul></li></ul><p>è€Œåœ¨æµ‹è¯• API æœŸé—´ï¼Œå¾€å¾€éœ€è¦æ‰‹åŠ¨å»ä¿®æ”¹ API çš„åœ°å€ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/l7grallxhf.png?imageView2/2/w/1620" alt="img"></p><p>æ•ˆç‡æ¯”è¾ƒä½ï¼Œä¸”åœ°å€æ›´æ¢åä¹‹å‰åœ°å€å°±æ²¡æ³•ä¿ç•™äº†ã€‚</p><p>å¦å¤–ï¼Œä¸”æ ¹æ®ä¸åŒ IP åœ°å€ï¼ˆæˆ–è€…åŸŸåï¼‰ä¹Ÿä¸å®¹æ˜“è¯†åˆ«æ˜¯å“ªå¥—ç¯å¢ƒã€‚</p><h3 id="Postman-æ”¯æŒç”¨-Environment-ç¯å¢ƒå˜é‡å»å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬"><a href="#Postman-æ”¯æŒç”¨-Environment-ç¯å¢ƒå˜é‡å»å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬" class="headerlink" title="Postman æ”¯æŒç”¨ Environment ç¯å¢ƒå˜é‡å»å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=postman-%e6%94%af%e6%8c%81%e7%94%a8-environment-%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e5%8e%bb%e5%ae%9e%e7%8e%b0%e5%a4%9a%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%89%88%e6%9c%ac" target="_blank" rel="noopener">Postman æ”¯æŒç”¨ Environment ç¯å¢ƒå˜é‡å»å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬</a></h3><p>åæ¥å‘ç° Postman ä¸­ï¼Œæœ‰ Environment å’Œ Global Variableï¼Œç”¨äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ç°ä¸åŒç¯å¢ƒçš„ç®¡ç†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/rzkb6ahdi2.png?imageView2/2/w/1620" alt="img"></p><blockquote><p> å¾ˆæ˜æ˜¾ï¼Œå°±å¯ä»¥ç”¨æ¥å®ç°ä¸ç”¨æ‰‹åŠ¨ä¿®æ”¹ url ä¸­çš„æœåŠ¡å™¨åœ°å€ï¼Œä»è€ŒåŠ¨æ€çš„å®ç°ï¼Œæ”¯æŒä¸åŒæœåŠ¡å™¨ç¯å¢ƒ:  </p></blockquote><ul><li>Production ç”Ÿäº§ç¯å¢ƒ</li><li>Development å¼€å‘ç¯å¢ƒ</li><li>Local æœ¬åœ°å±€åŸŸç½‘ç¯å¢ƒ</li></ul><h4 id="å¦‚ä½•ä½¿ç”¨-Enviroment-å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬"><a href="#å¦‚ä½•ä½¿ç”¨-Enviroment-å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ Enviroment å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8-enviroment-%e5%ae%9e%e7%8e%b0%e5%a4%9a%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%89%88%e6%9c%ac" target="_blank" rel="noopener">å¦‚ä½•ä½¿ç”¨ Enviroment å®ç°å¤šæœåŠ¡å™¨ç‰ˆæœ¬</a></h4><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/pvj87t9bl9.png?imageView2/2/w/1620" alt="img"></p><p>æˆ–è€…ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/4cqehxbdq1.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/t6gzc4ktvw.png?imageView2/2/w/1620" alt="img"></p><blockquote><p> Environments are a group of variables &amp; values, that allow you to quickly switch the context for your requests and collections.  Learn more about environments  You can declare a variable in an environment and give it a starting value, then use it in a request by putting the variable name within curly-braces. Create an environment to get started.  </p></blockquote><p>è¾“å…¥ Key å’Œ valueï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/tdph8jo5u3.png?imageView2/2/w/1620" alt="img"></p><p>ç‚¹å‡» Add åï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/nvb1s1ht5r.png?imageView2/2/w/1620" alt="img"></p><blockquote><p> [info] ç¯å¢ƒå˜é‡å¯ä»¥ä½¿ç”¨çš„åœ°æ–¹  </p></blockquote><ul><li>URL</li><li>URL params</li><li>Header values</li><li>form-data/url-encoded values</li><li>Raw body content</li><li>Helper fields</li><li>å†™ test æµ‹è¯•è„šæœ¬ä¸­</li><li>é€šè¿‡ postman çš„æ¥å£ï¼Œè·å–æˆ–è®¾ç½®ç¯å¢ƒå˜é‡çš„å€¼ã€‚</li></ul><p>æ­¤å¤„æŠŠä¹‹å‰çš„åœ¨ url ä¸­çš„ IP åœ°å€ï¼ˆæˆ–åŸŸåï¼‰æ¢æˆç¯å¢ƒå˜é‡ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/zfvm8xnp5u.png?imageView2/2/w/1620" alt="img"></p><p>é¼ æ ‡ç§»åŠ¨åˆ°ç¯å¢ƒå˜é‡ä¸Šï¼Œå¯ä»¥åŠ¨æ€æ˜¾ç¤ºå‡ºå…·ä½“çš„å€¼ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/msdxb4rrwj.png?imageView2/2/w/1620" alt="img"></p><p>å†å»æ·»åŠ å¦å¤–ä¸€ä¸ªå¼€å‘ç¯å¢ƒï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/rs4j9obq5m.png?imageView2/2/w/1620" alt="img"></p><p>åˆ™å¯æ·»åŠ å®Œ 2 ä¸ªç¯å¢ƒå˜é‡ï¼Œè¡¨ç¤ºä¸¤ä¸ªæœåŠ¡å™¨åœ°å€ï¼Œä¸¤ä¸ªç‰ˆæœ¬ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/73l36ef55w.png?imageView2/2/w/1620" alt="img"></p><p>ç„¶åå°±å¯ä»¥åˆ‡æ¢ä¸åŒæœåŠ¡å™¨ç¯å¢ƒäº†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/9n52eok8vu.png?imageView2/2/w/1620" alt="img"></p><p>å¯ä»¥çœ‹åˆ°ï¼ŒåŒæ ·çš„å˜é‡ server_addressï¼Œåœ¨åˆ‡æ¢åå¯¹åº” IP åœ°å€å°±å˜æˆå¸Œæœ›çš„å¼€å‘ç¯å¢ƒçš„ IP äº†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/h487ru075j.png?imageView2/2/w/1620" alt="img"></p><h4 id="Postman-å¯¼å‡º-API-æ–‡æ¡£ä¸­å¤šä¸ªç¯å¢ƒå˜é‡çš„æ•ˆæœ"><a href="#Postman-å¯¼å‡º-API-æ–‡æ¡£ä¸­å¤šä¸ªç¯å¢ƒå˜é‡çš„æ•ˆæœ" class="headerlink" title="Postman å¯¼å‡º API æ–‡æ¡£ä¸­å¤šä¸ªç¯å¢ƒå˜é‡çš„æ•ˆæœ"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=postman-%e5%af%bc%e5%87%ba-api-%e6%96%87%e6%a1%a3%e4%b8%ad%e5%a4%9a%e4%b8%aa%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e7%9a%84%e6%95%88%e6%9e%9c" target="_blank" rel="noopener">Postman å¯¼å‡º API æ–‡æ¡£ä¸­å¤šä¸ªç¯å¢ƒå˜é‡çš„æ•ˆæœ</a></h4><p>é¡ºå¸¦ä¹Ÿå»çœ‹çœ‹ï¼Œå¯¼å‡ºä¸º API æ–‡æ¡£åï¼Œå¸¦äº†è¿™ç§ Environment çš„å˜é‡çš„æ¥å£ï¼Œæ–‡æ¡£é•¿ä»€ä¹ˆæ ·å­ï¼š</p><p>å‘ç°æ˜¯åœ¨å‘å¸ƒä¹‹å‰ï¼Œéœ€è¦é€‰æ‹©å¯¹åº”çš„ç¯å¢ƒçš„ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/dg394n77xg.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6fqqywrz4h.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/jzcgi6c3lg.png?imageView2/2/w/1620" alt="img"></p><p>å‘å¸ƒåçš„æ–‡æ¡£ï¼Œå¯ä»¥çœ‹åˆ°æ‰€é€‰ç¯å¢ƒå’Œå¯¹åº”æœåŠ¡å™¨çš„ IP çš„ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/k3tppka6qg.png?imageView2/2/w/1620" alt="img"></p><p>å½“ç„¶å‘å¸ƒæ–‡æ¡£åï¼Œä¹Ÿå¯ä»¥å®æ—¶åˆ‡æ¢ç¯å¢ƒï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/fqnjm0392m.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6cz9xt9z7y.png?imageView2/2/w/1620" alt="img"></p><h4 id="ç¯å¢ƒå˜é‡çš„å¥½å¤„"><a href="#ç¯å¢ƒå˜é‡çš„å¥½å¤„" class="headerlink" title="ç¯å¢ƒå˜é‡çš„å¥½å¤„"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e7%9a%84%e5%a5%bd%e5%a4%84" target="_blank" rel="noopener">ç¯å¢ƒå˜é‡çš„å¥½å¤„</a></h4><p>å½“æ›´æ¢æœåŠ¡å™¨æ—¶ï¼Œç›´æ¥ä¿®æ”¹å˜é‡çš„ IP åœ°å€ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/y6virrs94v.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/udsfrqtqxg.png?imageView2/2/w/1620" alt="img"></p><p>å³å¯å®æ—¶æ›´æ–°ï¼Œå½“é¼ æ ‡ç§»åŠ¨åˆ°å˜é‡ä¸Šå³å¯çœ‹åˆ°æ•ˆæœï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6i5l61q5gz.png?imageView2/2/w/1620" alt="img"></p><h3 id="ä»£ç ç”Ÿæˆå·¥å…·"><a href="#ä»£ç ç”Ÿæˆå·¥å…·" class="headerlink" title="ä»£ç ç”Ÿæˆå·¥å…·"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e4%bb%a3%e7%a0%81%e7%94%9f%e6%88%90%e5%b7%a5%e5%85%b7" target="_blank" rel="noopener">ä»£ç ç”Ÿæˆå·¥å…·</a></h3><h4 id="æŸ¥çœ‹å½“å‰è¯·æ±‚çš„-HTTP-åŸå§‹å†…å®¹"><a href="#æŸ¥çœ‹å½“å‰è¯·æ±‚çš„-HTTP-åŸå§‹å†…å®¹" class="headerlink" title="æŸ¥çœ‹å½“å‰è¯·æ±‚çš„ HTTP åŸå§‹å†…å®¹"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%9f%a5%e7%9c%8b%e5%bd%93%e5%89%8d%e8%af%b7%e6%b1%82%e7%9a%84-http-%e5%8e%9f%e5%a7%8b%e5%86%85%e5%ae%b9" target="_blank" rel="noopener">æŸ¥çœ‹å½“å‰è¯·æ±‚çš„ HTTP åŸå§‹å†…å®¹</a></h4><p>å¯¹äºå½“å‰çš„è¯·æ±‚ï¼Œè¿˜å¯ä»¥é€šè¿‡ç‚¹å‡» Code</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/fjqiinpdmd.png?imageView2/2/w/1620" alt="img"></p><p>å»æŸ¥çœ‹å¯¹åº”çš„ç¬¦åˆ HTTP åè®®çš„åŸå§‹çš„å†…å®¹ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ems6iaymhz.png?imageView2/2/w/1620" alt="img"></p><h4 id="å„ç§è¯­è¨€çš„ç¤ºä¾‹ä»£ç Code-Generation-Tools"><a href="#å„ç§è¯­è¨€çš„ç¤ºä¾‹ä»£ç Code-Generation-Tools" class="headerlink" title="å„ç§è¯­è¨€çš„ç¤ºä¾‹ä»£ç Code Generation Tools"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%90%84%e7%a7%8d%e8%af%ad%e8%a8%80%e7%9a%84%e7%a4%ba%e4%be%8b%e4%bb%a3%e7%a0%81code-generation-tools" target="_blank" rel="noopener">å„ç§è¯­è¨€çš„ç¤ºä¾‹ä»£ç Code Generation Tools</a></h4><p>æ¯”å¦‚ï¼š</p><ul><li>Swift è¯­è¨€</li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/n2mpfxcdv3.png?imageView2/2/w/1620" alt="img"></p><ul><li>Java è¯­è¨€</li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/r9dvvipgd1.png?imageView2/2/w/1620" alt="img"></p><ul><li>å…¶ä»–å„ç§è¯­è¨€ è¿˜æ”¯æŒå…¶ä»–å„ç§è¯­è¨€ï¼š</li></ul><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/n935sl95gc.png?imageView2/2/w/1620" alt="img"></p><p>ç›®å‰æ”¯æŒçš„è¯­è¨€æœ‰ï¼š</p><ul><li>HTTP</li><li>C (LibCurl)</li><li>cURL</li><li>C#(RestSharp)</li><li>Go</li><li>Java <ul><li>OK HTTP</li><li>Unirest</li></ul></li><li>Javascript</li><li>NodeJS</li><li>Objective-C(NSURL)</li><li>OCaml(Cohttp)</li><li>PHP</li><li>Python</li><li>Ruby(NET::Http)</li><li>Shell</li><li>Swift(NSURL)</li></ul><p>ä»£ç ç”Ÿæˆå·¥å…·çš„å¥½å¤„æ˜¯ï¼šåœ¨å†™è°ƒç”¨æ­¤ API çš„ä»£ç æ—¶ï¼Œå°±å¯ä»¥å‚è€ƒå¯¹åº”ä»£ç ï¼Œç”šè‡³æ‹·è´ç²˜è´´å¯¹åº”ä»£ç ï¼Œå³å¯ã€‚</p><h3 id="æµ‹è¯•æ¥å£"><a href="#æµ‹è¯•æ¥å£" class="headerlink" title="æµ‹è¯•æ¥å£"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e6%b5%8b%e8%af%95%e6%8e%a5%e5%8f%a3" target="_blank" rel="noopener">æµ‹è¯•æ¥å£</a></h3><p>é€‰ä¸­æŸä¸ªåˆ†ç»„åï¼Œç‚¹å‡» Runner</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/p5ijm3jotv.png?imageView2/2/w/1620" alt="img"></p><p>é€‰ä¸­æŸä¸ªåˆ†ç»„åç‚¹å‡» Run</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/d40ouxqffx.png?imageView2/2/w/1620" alt="img"></p><p>å³å¯çœ‹åˆ°æµ‹è¯•ç»“æœï¼š </p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ynyz14nrsu.png?imageView2/2/w/1620" alt="img"></p><p>å…³äºæ­¤åŠŸèƒ½çš„ä»‹ç»å¯å‚è€ƒ<a href="https://www.getpostman.com/postman" target="_blank" rel="noopener">Postman å®˜ç½‘</a>çš„<a href="https://www.getpostman.com/img/v2/postman/gifs/collection-runner.gif" target="_blank" rel="noopener">git å›¾</a></p><h3 id="MockServer"><a href="#MockServer" class="headerlink" title="MockServer"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=mockserver" target="_blank" rel="noopener">MockServer</a></h3><p>ç›´æ¥å‚è€ƒå®˜ç½‘ã€‚</p><h2 id="åŠŸèƒ½ç•Œé¢"><a href="#åŠŸèƒ½ç•Œé¢" class="headerlink" title="åŠŸèƒ½ç•Œé¢"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8a%9f%e8%83%bd%e7%95%8c%e9%9d%a2" target="_blank" rel="noopener">åŠŸèƒ½ç•Œé¢</a></h2><h3 id="å¤š-Tab-åˆ†é¡µ"><a href="#å¤š-Tab-åˆ†é¡µ" class="headerlink" title="å¤š Tab åˆ†é¡µ"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%a4%9a-tab-%e5%88%86%e9%a1%b5" target="_blank" rel="noopener">å¤š Tab åˆ†é¡µ</a></h3><p>Postman æ”¯æŒå¤š tab é¡µï¼Œäºæ­¤å¯¹æ¯”ä¹‹å‰æœ‰äº› API è°ƒè¯•å·¥å…·å°±ä¸æ”¯æŒå¤š Tab é¡µï¼Œæ¯”å¦‚<code>Advanced Rest Client</code></p><p>å¤š tab çš„å¥½å¤„ï¼š</p><p>æ–¹ä¾¿åœ¨ä¸€ä¸ª tab ä¸­æµ‹è¯•ï¼Œå¾—åˆ°ç»“æœåï¼Œå¤åˆ¶ç²˜è´´åˆ°å¦å¤–çš„ tab ä¸­ï¼Œç»§ç»­æµ‹è¯•å…¶å®ƒæ¥å£</p><p>æ¯”å¦‚æ­¤å¤„ tab1 ä¸­ï¼Œæµ‹è¯•äº†è·å–éªŒè¯ç æ¥å£åï¼Œæ‹·è´æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œç²˜è´´åˆ° tab2 ä¸­ï¼Œç»§ç»­æµ‹è¯•æ³¨å†Œçš„æ¥å£</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/9h475eyqnd.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/f26rmodg14.png?imageView2/2/w/1620" alt="img"></p><h3 id="ç•Œé¢æŸ¥çœ‹æ¨¡å¼"><a href="#ç•Œé¢æŸ¥çœ‹æ¨¡å¼" class="headerlink" title="ç•Œé¢æŸ¥çœ‹æ¨¡å¼"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e7%95%8c%e9%9d%a2%e6%9f%a5%e7%9c%8b%e6%a8%a1%e5%bc%8f" target="_blank" rel="noopener">ç•Œé¢æŸ¥çœ‹æ¨¡å¼</a></h3><p>Postman çš„é»˜è®¤çš„ Request å’Œ Response æ˜¯ä¸Šä¸‹å¸ƒå±€ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ilcrw9qu2a.png?imageView2/2/w/1620" alt="img"></p><p>æ­¤å¤„ç‚¹å‡»å³ä¸‹è§’çš„<code>Two pane view</code>ï¼Œå°±å˜æˆå·¦å³çš„äº†ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ij8lqwx97b.png?imageView2/2/w/1620" alt="img"></p><blockquote><p> [info] å·¦å³å¸ƒå±€çš„ç”¨é€”  å¯¹äºæ•°æ®é‡å¾ˆå¤§ï¼Œåˆæƒ³è¦åŒæ—¶çœ‹åˆ°è¯·æ±‚å’Œè¿”å›çš„æ•°æ®çš„æ—¶å€™ï¼Œåº”è¯¥æ¯”è¾ƒæœ‰ç”¨ã€‚  </p></blockquote><h3 id="å¤šé¢œè‰²ä¸»é¢˜"><a href="#å¤šé¢œè‰²ä¸»é¢˜" class="headerlink" title="å¤šé¢œè‰²ä¸»é¢˜"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%a4%9a%e9%a2%9c%e8%89%b2%e4%b8%bb%e9%a2%98" target="_blank" rel="noopener">å¤šé¢œè‰²ä¸»é¢˜</a></h3><p>Posman æ”¯æŒä¸¤ç§ä¸»é¢˜ï¼š</p><ul><li>æ·±è‰²ä¸»é¢˜</li></ul><p>å½“å‰æ˜¯æ·±è‰²ä¸»é¢˜ï¼Œæ•ˆæœå¾ˆä¸é”™ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/jz9xmkcowa.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/u82a7psrgy.png?imageView2/2/w/1620" alt="img"></p><ul><li>æµ…è‰²ä¸»é¢˜</li></ul><p>å¯ä»¥åˆ‡æ¢åˆ° æµ…è‰²ä¸»é¢˜ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/qu330s3pfl.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/d17b0zdb4c.png?imageView2/2/w/1620" alt="img"></p><h2 id="API-æ–‡æ¡£ç”Ÿæˆ"><a href="#API-æ–‡æ¡£ç”Ÿæˆ" class="headerlink" title="API æ–‡æ¡£ç”Ÿæˆ"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=api-%e6%96%87%e6%a1%a3%e7%94%9f%e6%88%90" target="_blank" rel="noopener">API æ–‡æ¡£ç”Ÿæˆ</a></h2><p>åœ¨æœåŠ¡ç«¯åå°çš„å¼€å‘äººå‘˜æµ‹è¯•å¥½äº†æ¥å£åï¼Œæ‰“ç®—æŠŠæ¥å£çš„å„ç§ä¿¡æ¯å‘ç»™ä½¿ç”¨æ­¤ API çš„å‰ç«¯çš„ç§»åŠ¨ç«¯äººå‘˜æ—¶ï¼Œå¾€å¾€ä¼šé‡åˆ°ï¼š</p><p>è¦ä¹ˆæ˜¯ç”¨å¤åˆ¶ç²˜è´´ -&gt; æ ¼å¼ä¸å‹å¥½ è¦ä¹ˆæ˜¯ç”¨ Postman ä¸­æˆªå›¾ -&gt; æ–¹ä¾¿çœ‹ï¼Œä½†æ˜¯ä¸æ–¹ä¾¿è·å¾— API æ¥å£å’Œå­—æ®µç­‰æ–‡å­—å†…å®¹ è¦ä¹ˆæ˜¯ç”¨ Postman ä¸­å¯¼å‡ºä¸º JSON -&gt; json æ–‡ä»¶ä¸­ä¿¡æ¯å¤ªç¹æ‚ï¼Œä¸åˆ©äºæ‰¾åˆ°æ‰€éœ€è¦çš„ä¿¡æ¯ è¦ä¹ˆæ˜¯ç”¨æ–‡æ¡£ï¼Œæ¯”å¦‚å»ç¼–å†™ Markdown æ–‡æ¡£ -&gt; ä½†åç»­ API çš„å˜æ›´éœ€è¦å®æ—¶åŒæ­¥ä¿®æ”¹æ–‡æ¡£ï¼Œä¹Ÿä¼šå¾ˆéº»çƒ¦ è¿™éƒ½ä¼šå¯¼è‡´åˆ«äººæŸ¥çœ‹å’Œä½¿ç”¨ API æ—¶å¾ˆä¸æ–¹ä¾¿ã€‚</p><p>-&gt; å¯¹æ­¤ï¼ŒPostman æä¾›äº†å‘å¸ƒ API</p><p>é¢„è§ˆå’Œå‘å¸ƒ API æ–‡æ¡£ ä¸‹é¢ä»‹ç» Postman ä¸­å¦‚ä½•é¢„è§ˆå’Œå‘å¸ƒ API æ–‡æ¡£ã€‚</p><h3 id="ç®€è¦æ¦‚è¿°æ­¥éª¤"><a href="#ç®€è¦æ¦‚è¿°æ­¥éª¤" class="headerlink" title="ç®€è¦æ¦‚è¿°æ­¥éª¤"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e7%ae%80%e8%a6%81%e6%a6%82%e8%bf%b0%e6%ad%a5%e9%aa%a4" target="_blank" rel="noopener">ç®€è¦æ¦‚è¿°æ­¥éª¤</a></h3><ol><li>Collection</li><li>é¼ æ ‡ç§»åŠ¨åˆ°æŸä¸ª Collectionï¼Œç‚¹å‡» ä¸‰ä¸ªç‚¹</li><li>Publish Docs</li><li>Publish</li><li>å¾—åˆ° Public URL</li><li>åˆ«äººæ‰“å¼€è¿™ä¸ª Public URLï¼Œå³å¯æŸ¥çœ‹ API æ–‡æ¡£</li></ol><h3 id="é¢„è§ˆ-API-æ–‡æ¡£"><a href="#é¢„è§ˆ-API-æ–‡æ¡£" class="headerlink" title="é¢„è§ˆ API æ–‡æ¡£"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e9%a2%84%e8%a7%88-api-%e6%96%87%e6%a1%a3" target="_blank" rel="noopener">é¢„è§ˆ API æ–‡æ¡£</a></h3><p>ç‚¹å‡»åˆ†ç»„å³è¾¹çš„å¤§äºå·&gt;</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/s7pgyjn13y.png?imageView2/2/w/1620" alt="img"></p><p>å¦‚æœåªæ˜¯é¢„è§ˆï¼Œæ¯”å¦‚åå°å¼€å‘å‘˜è‡ªå·±æŸ¥çœ‹ API æ–‡æ¡£çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ï¼šView in web</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/95ekutmlpe.png?imageView2/2/w/1620" alt="img"></p><blockquote><p> ç­‰ä»·äºç‚¹å‡»Publish Docså»å‘å¸ƒï¼š  </p></blockquote><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/ca0mw3r3x7.png?imageView2/2/w/1620" alt="img"></p><p>View in Web åï¼Œæœ‰ Publish çš„é€‰é¡¹ï¼ˆè§åé¢çš„æˆªå›¾ï¼‰</p><p>View in Web åï¼Œä¼šæ‰“å¼€é¢„è§ˆé¡µé¢ï¼š</p><p>æ¯”å¦‚ï¼š</p><p>å¥¶ç‰›äº‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://documenter.getpostman.com/collection/view/669382-42273840-6237-dbae-5455-26b16f45e2b9</span><br></pre></td></tr></table></figure><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/8yfixnbs9s.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/6qtob43od0.png?imageView2/2/w/1620" alt="img"></p><p>è€Œå³è¾¹çš„ç¤ºä¾‹ä»£ç ï¼Œä¹Ÿå¯ä»¥ä»é»˜è®¤çš„ cURL æ¢æˆå…¶ä»–çš„ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/gy60gkar15.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/hmptft1z7u.png?imageView2/2/w/1620" alt="img"></p><h3 id="å‘å¸ƒ-API-æ–‡æ¡£"><a href="#å‘å¸ƒ-API-æ–‡æ¡£" class="headerlink" title="å‘å¸ƒ API æ–‡æ¡£"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8f%91%e5%b8%83-api-%e6%96%87%e6%a1%a3" target="_blank" rel="noopener">å‘å¸ƒ API æ–‡æ¡£</a></h3><p>å¦‚æœæƒ³è¦è®©å…¶ä»–äººèƒ½çœ‹åˆ°è¿™ä¸ªæ–‡æ¡£ï¼Œåˆ™ç‚¹å‡» Publishï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/nfsjy8thb8.png?imageView2/2/w/1620" alt="img"></p><p>ç„¶åä¼šæ‰“å¼€ç±»ä¼¼äºè¿™æ ·çš„åœ°å€ï¼š</p><p>Postman Documenter</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://documenter.getpostman.com/collection/publish?meta=Y29sbGVjdGlvbl9pZD00MjI3Mzg0MC02MjM3LWRiYWUtNTQ1NS0yNmIxNmY0NWUyYjkmb3duZXI9NjY5MzgyJmNvbGxlY3Rpb25fbmFtZT0lRTUlQTUlQjYlRTclODklOUIlRTQlQkElOTE=</span><br></pre></td></tr></table></figure><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/84pbk6ppzq.png?imageView2/2/w/1620" alt="img"></p><p>ç‚¹å‡» Publish åï¼Œå¯ä»¥ç”Ÿæˆå¯¹åº”çš„å…¬å¼€çš„ç½‘é¡µåœ°å€ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/z3ce5w7dfv.png?imageView2/2/w/1620" alt="img"></p><p>æ‰“å¼€ API æ¥å£æ–‡æ¡£åœ°å€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://documenter.getpostman.com/view/669382/collection/77fd4RM</span><br></pre></td></tr></table></figure><p>å³å¯çœ‹åˆ°ï¼ˆå’Œå‰é¢é¢„è§ˆä¸€æ ·æ•ˆæœçš„ API æ–‡æ¡£äº†ï¼‰ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/84j5ppdtoh.png?imageView2/2/w/1620" alt="img"></p><p>å¦‚æ­¤ï¼Œåˆ«äººå³å¯æŸ¥çœ‹å¯¹åº”çš„ API æ¥å£æ–‡æ¡£ã€‚</p><h3 id="å·²å‘å¸ƒçš„-API-æ–‡æ¡£æ”¯æŒè‡ªåŠ¨æ›´æ–°"><a href="#å·²å‘å¸ƒçš„-API-æ–‡æ¡£æ”¯æŒè‡ªåŠ¨æ›´æ–°" class="headerlink" title="å·²å‘å¸ƒçš„ API æ–‡æ¡£æ”¯æŒè‡ªåŠ¨æ›´æ–°"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%b7%b2%e5%8f%91%e5%b8%83%e7%9a%84-api-%e6%96%87%e6%a1%a3%e6%94%af%e6%8c%81%e8%87%aa%e5%8a%a8%e6%9b%b4%e6%96%b0" target="_blank" rel="noopener">å·²å‘å¸ƒçš„ API æ–‡æ¡£æ”¯æŒè‡ªåŠ¨æ›´æ–°</a></h3><p>åç»­å¦‚æœè‡ªå·±çš„ API æ¥å£ä¿®æ”¹åï¼š</p><p>æ¯”å¦‚ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/svcgj7qdll.png?imageView2/2/w/1620" alt="img"></p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/kezpmqdfe8.png?imageView2/2/w/1620" alt="img"></p><p>ï¼ˆåæ¥å‘ç°ï¼Œä¸ç”¨å†å»è¿›å…¥æ­¤é¢„è§ˆå’Œå‘å¸ƒçš„æµç¨‹ï¼Œå»æ›´æ–°æ–‡æ¡£ï¼Œè€Œæ˜¯ Postman è‡ªåŠ¨æ”¯æŒï¼‰</p><p>åˆ«äººå»åˆ·æ–°è¯¥æ–‡æ¡£çš„é¡µé¢ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://documenter.getpostman.com/view/669382/collection/77fd4RM</span><br></pre></td></tr></table></figure><p>å³å¯çœ‹åˆ°æ›´æ–°åçš„å†…å®¹ï¼š</p><p><img src="https://ask.qcloudimg.com/http-save/yehe-1171488/1iumgwfs2k.png?imageView2/2/w/1620" alt="img"></p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a><a href="https://malun666.github.io/aicoder_vip_doc/#/pages/postman?id=%e5%8f%82%e8%80%83%e8%b5%84%e6%96%99" target="_blank" rel="noopener">å‚è€ƒèµ„æ–™</a></h2><ul><li>ä¸»è¦å‚è€ƒï¼šGithub: api_tool_postman</li><li>Manage environments</li><li>postman-å˜é‡/ç¯å¢ƒ/è¿‡æ»¤ç­‰ - ç®€ä¹¦</li><li>Postman ä½¿ç”¨æ‰‹å†Œ 3â€”â€”ç¯å¢ƒå˜é‡ - ç®€ä¹¦</li><li>postman ä½¿ç”¨ä¹‹å››ï¼šåˆ‡æ¢ç¯å¢ƒå’Œè®¾ç½®è¯»å–å˜é‡ - ä¹”å¶å¶ - åšå®¢å›­</li></ul><hr>]]></content>
    
    <summary type="html">
    
      postmanæ¥å£æµ‹è¯•ç¥å™¨ä½¿ç”¨æŠ€å·§
    
    </summary>
    
      <category term="å·¥å…·" scheme="https://cloudsjhan.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="postman" scheme="https://cloudsjhan.github.io/tags/postman/"/>
    
      <category term="å·¥å…·" scheme="https://cloudsjhan.github.io/tags/%E5%B7%A5%E5%85%B7/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯å‘¨åˆŠä¹‹influxDBä½¿ç”¨å…¥é—¨</title>
    <link href="https://cloudsjhan.github.io/2018/12/08/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8BinfluxDB%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8/"/>
    <id>https://cloudsjhan.github.io/2018/12/08/æŠ€æœ¯å‘¨åˆŠä¹‹influxDBä½¿ç”¨å…¥é—¨/</id>
    <published>2018-12-08T15:25:10.000Z</published>
    <updated>2018-12-08T15:31:29.239Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>InfluxDBæ˜¯ä¸€ä¸ªç”¨äºå­˜å‚¨å’Œåˆ†ææ—¶é—´åºåˆ—æ•°æ®çš„å¼€æºæ•°æ®åº“ã€‚</p><p>ä¸»è¦ç‰¹æ€§æœ‰ï¼š</p><ul><li>å†…ç½®HTTPæ¥å£ï¼Œä½¿ç”¨æ–¹ä¾¿</li><li>æ•°æ®å¯ä»¥æ‰“æ ‡è®°ï¼ŒæŸ¥è®©æŸ¥è¯¢å¯ä»¥å¾ˆçµæ´»</li><li>ç±»SQLçš„æŸ¥è¯¢è¯­å¥</li><li>å®‰è£…ç®¡ç†å¾ˆç®€å•ï¼Œå¹¶ä¸”è¯»å†™æ•°æ®å¾ˆé«˜æ•ˆ</li><li>èƒ½å¤Ÿå®æ—¶æŸ¥è¯¢ï¼Œæ•°æ®åœ¨å†™å…¥æ—¶è¢«ç´¢å¼•åå°±èƒ½å¤Ÿè¢«ç«‹å³æŸ¥å‡º</li><li>â€¦â€¦</li></ul><p>åœ¨æœ€æ–°çš„<a href="https://db-engines.com/en/ranking/time+series+dbms" target="_blank" rel="noopener">DB-ENGINES</a>ç»™å‡ºçš„æ—¶é—´åºåˆ—æ•°æ®åº“çš„æ’åä¸­ï¼ŒInfluxDBé«˜å±…ç¬¬ä¸€ä½ï¼Œå¯ä»¥é¢„è§ï¼ŒInfluxDBä¼šè¶Šæ¥è¶Šå¾—åˆ°å¹¿æ³›çš„ä½¿ç”¨ã€‚</p><ul><li><p>influxDBä½¿ç”¨goè¯­è¨€ç¼–å†™ï¼Œé‡‡ç”¨äº†SQL likeçš„è¯­æ³•ï¼Œéå¸¸çµæ´»é«˜æ•ˆï¼Œå¦‚æœä½ çš„æ•°æ®æ˜¯ä¸æ—¶é—´ç›¸å…³çš„ï¼Œé‚£ä¹ˆä½¿ç”¨influxDBåšæ•°æ®å¯è§†åŒ–æ˜¯æœ€åˆé€‚ä¸è¿‡çš„ï¼Œå°¤å…¶æ˜¯influxDBè‡ªèº«å°±æä¾›æ•°æ®åº“CRUDæ‰€éœ€è¦çš„APIï¼Œè™½ç„¶ä¸æ˜¯RESTFulçš„ï¼Œä½†æ˜¯ä¹Ÿçœå»äº†ç¼–å†™åç«¯æ¥å£çš„åŠ›æ°”ã€‚</p></li><li><p>ä¸‹é¢ä»influxDBçš„å®‰è£…ã€ä½¿ç”¨CLIçš„influxdbåŸºæœ¬æ“ä½œã€ä½¿ç”¨APIå¯¹influxdbæ“ä½œåŠgolangä»£ç å®ç°ã€ç»å†çš„å‘ï¼Œå‡ ä¸ªæ–¹é¢åˆ†äº«influxDBçš„å…¥é—¨ç»å†ã€‚</p></li></ul><h3 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h3><ul><li><p>æœ¬æ¬¡å®‰è£…çš„ç¯å¢ƒæ˜¯ï¼š</p><ul><li>CentOS 7</li><li>å†…æ ¸ç‰ˆæœ¬ï¼š4.4.135-1.el7.elrepo.x86_64</li></ul></li><li><p>ç›´æ¥ä½¿ç”¨yumå®‰è£…</p><ul><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/influxdb.repo # è¾“å…¥influxDBçš„repoURLåœ°å€ç­‰ä¿¡æ¯</span><br><span class="line">[influxdb]</span><br><span class="line">  name = InfluxDB Repository - RHEL \$releasever</span><br><span class="line">  baseurl = https://repos.influxdata.com/rhel/\$releasever/\$basearch/stable</span><br><span class="line">  enabled = 1</span><br><span class="line">  gpgcheck = 1</span><br><span class="line">  gpgkey = https://repos.influxdata.com/influxdb.key</span><br><span class="line">  EOF</span><br><span class="line"><span class="meta">  #</span><span class="bash">EOFæ˜¯æ–‡æœ¬çš„ç»“æŸç¬¦</span></span><br></pre></td></tr></table></figure></li></ul></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install influxdb</span><br></pre></td></tr></table></figure></li><li><p>influxd config</p><p>å®‰è£…å®Œæˆåä½¿ç”¨è¯¥å‘½ä»¤æŸ¥çœ‹influxDBçš„é…ç½®å†…å®¹ï¼Œdefaultçš„configæ–‡ä»¶è·¯å¾„åœ¨ï¼š/etc/influxdb/influxdb.conf</p></li><li><p>å¯åŠ¨influxDB</p></li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-m1 ~]# influx</span><br><span class="line">Connected to http://localhost:8086 version 1.7.1</span><br><span class="line">InfluxDB shell version: 1.7.1</span><br><span class="line">Enter an InfluxQL query</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure><p>åˆ°æ­¤å®Œæˆäº†influxDBçš„å®‰è£…ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬åšåŸºæœ¬çš„é…ç½®ã€‚</p><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><ul><li>ç”¨æˆ·ç®¡ç†</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·</span><br><span class="line">CREATE USER "admin" WITH PASSWORD 'xxxx' WITH ALL PRIVILEGES</span><br><span class="line">-- åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·</span><br><span class="line">CREATE USER "user" WITH PASSWORD 'xxxxx'</span><br><span class="line">-- ä¸ºç”¨æˆ·æˆæƒè¯»æƒé™</span><br><span class="line">GRANT READ ON [database] to "user"</span><br><span class="line">-- ä¸ºç”¨æˆ·æˆæƒå†™æƒé™</span><br><span class="line">GRANT WRITE ON [database] to "user"</span><br><span class="line">--------------------- </span><br><span class="line"><span class="meta">#</span><span class="bash"> éœ€è¦ä¿®æ”¹InfluxDBçš„é…ç½®æ–‡ä»¶/etc/influxdb/influxdb.confï¼Œè®¾ç½®httpä¸‹çš„auth-enabled = <span class="literal">true</span>ï¼Œé‡å¯åï¼Œä½¿ç”¨influxå‘½ä»¤ç™»å½•æ•°æ®åº“å°±éœ€è¦ç”¨æˆ·åå’Œå¯†ç äº†ã€‚ï¼ˆInfluxå‘½ä»¤å®é™…ä¸Šä¹Ÿæ˜¯ä½¿ç”¨APIæ¥æ“ä½œInfluxDBçš„ï¼ŒInfluxDBåªæä¾›äº†APIæ¥å£ï¼‰</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç”¨æˆ·</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> show users</span></span><br><span class="line">user  admin</span><br><span class="line">----  -----</span><br><span class="line">admin true</span><br><span class="line">sjhan true</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"></span></span><br></pre></td></tr></table></figure><p>influxDBçš„é…ç½®é¡¹ç›®æœ‰å¾ˆå¤šï¼Œå‰©ä¸‹çš„å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç»§ç»­ç ”ç©¶ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚</p><p>åœ¨è¿›è¡Œæ•°æ®åº“åŸºæœ¬æ“ä½œä¹‹å‰æˆ‘ä»¬å¿…é¡»äº†è§£ä¸€ä¸‹infuxDBçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ</p><h4 id="influxDBåŸºæœ¬æ¦‚å¿µ"><a href="#influxDBåŸºæœ¬æ¦‚å¿µ" class="headerlink" title="influxDBåŸºæœ¬æ¦‚å¿µ"></a>influxDBåŸºæœ¬æ¦‚å¿µ</h4><ul><li>influxDBé‡Œé¢æœ€åŸºæœ¬çš„æ¦‚å¿µå°±æ˜¯ï¼Œmeasurementï¼Œtagsï¼Œfieldsï¼Œpointsã€‚æˆ‘ä»¬å¯ä»¥ç±»æ¯”äºMySQLæ¥ç†è§£è¿™å‡ ä¸ªå­—æ®µï¼š</li><li>measurementç±»ä¼¼äºSQLä¸­çš„tableï¼›</li><li>tagsç±»ä¼¼SQLä¸­çš„è¢«ç´¢å¼•çš„åˆ—ï¼›</li><li>fieldsç±»ä¼¼äºSQLä¸­æ²¡æœ‰è¢«ç´¢å¼•çš„åˆ—ï¼›</li><li>pointså¯¹åº”SQLçš„tableä¸­çš„æ¯è¡Œæ•°æ®ã€‚</li><li>çŸ¥é“äº†è¿™å‡ ä¸ªæ¦‚å¿µï¼Œä¾¿å¯ä»¥ç»§ç»­å¾€ä¸‹è¿›è¡Œï¼Œå¦‚éœ€æ›´åŠ è¯¦ç»†çš„æ–‡æ¡£ï¼Œè‹±æ–‡ç‰ˆæ–‡æ¡£<a href="https://docs.influxdata.com/influxdb/v1.7/" target="_blank" rel="noopener">çŒ›æˆ³è¿™é‡Œ</a>ï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸­æ–‡ç‰ˆï¼Œ<a href="https://jasper-zhang1.gitbooks.io/influxdb/" target="_blank" rel="noopener">çŒ›æˆ³è¿™é‡Œ</a>ã€‚ä¸çŸ¥ä¸ºä½•ä¸­æ–‡ç‰ˆæˆ‘åªæœ‰ç•ªè”·æ‰èƒ½è®¿é—®ã€‚</li></ul><h3 id="influxDBåŸºæœ¬æ“ä½œ"><a href="#influxDBåŸºæœ¬æ“ä½œ" class="headerlink" title="influxDBåŸºæœ¬æ“ä½œ"></a>influxDBåŸºæœ¬æ“ä½œ</h3><ul><li>é¦–å…ˆï¼Œè·ŸMySQLä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-- åˆ›å»ºæ•°æ®åº“ï¼Œé»˜è®¤è®¾ç½®</span><br><span class="line">CREATE DATABASE &quot;first_db&quot;</span><br><span class="line">-- åˆ›å»ºæ•°æ®åº“ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªRetention Policyï¼Œæ•°æ®ä¿ç•™æ—¶é—´æè¿°</span><br><span class="line">-- Retention Policyå„éƒ¨åˆ†æè¿°ï¼šDURATIONä¸ºæ•°æ®å­˜å‚¨æ—¶é•¿ï¼Œä¸‹é¢çš„1då³åªå­˜1å¤©çš„æ•°æ®ï¼›REPLICATIONä¸ºæ•°æ®å‰¯æœ¬ï¼Œä¸€èˆ¬åœ¨ä½¿ç”¨é›†ç¾¤çš„æ—¶å€™æ‰ä¼šè®¾ç½®ä¸º&gt;1ï¼›SHARD DURATIONä¸ºåˆ†åŒºé—´éš”ï¼ŒInfluxDBé»˜è®¤å¯¹æ•°æ®åˆ†åŒºï¼Œå¡«å†™30må³å¯¹æ•°æ®æ¯éš”30åˆ†é’Ÿåšä¸€ä¸ªæ–°çš„åˆ†åŒºï¼›Nameæ˜¯RPçš„åå­—ã€‚</span><br><span class="line">CREATE DATABASE &quot;first_db&quot; WITH DURATION 1d REPLICATION 1 SHARD DURATION 30m NAME &quot;myrp&quot;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªinfluxDBçš„æ•°æ®åº“ï¼Œåå­—ä¸ºfirst_db, æ•°æ®å­˜å‚¨æ—¶é—´ä¸ºä¸€å¤©ï¼Œä¸€ä¸ªå‰¯æœ¬ï¼Œæ¯30åˆ†é’Ÿåšä¸€ä¸ªæ–°çš„åˆ†åŒºã€‚</p><ul><li><p>influxDBæ’å…¥æ•°æ®</p><p>influx -username admin -password</p><p>æˆ‘ä»¬æ’å…¥ä¸€æ¡æ•°æ®åˆ°åˆšåˆšåˆ›å»ºçš„æ•°æ®åº“ä¸­</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> product,productName=disk,usageType=pay,creator=zhangsan,appId=<span class="number">105</span> <span class="keyword">cost</span>=<span class="number">3421.6</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åˆ†æä¸€ä¸‹è¿™æ¡æ’å…¥è¯­å¥ï¼Œå…¶ä¸­productå­—æ®µæ˜¯influxDBä¸­çš„measurement,å‰é¢è®²åŸºæœ¬æ¦‚å¿µçš„æ—¶å€™å·²ç»è§£é‡Šè¿‡ï¼Œç±»ä¼¼äºMySQLä¸­çš„tableï¼Œâ€œproductName=disk,usageType=pay,creator=zhangsan,appId=105â€ï¼Œè¿™ä¸€å¨åœ¨influxDBä¸­å«åštag set,å¯ä»¥ç†è§£ä¸ºtagçš„ä¸€ä¸ªé›†åˆï¼Œtagçš„ç±»å‹åªèƒ½æ˜¯å­—ç¬¦ä¸²çš„K-Vï¼Œè¿˜æœ‰éœ€è¦æ³¨æ„çš„æ˜¯tag setä¸å‰é¢çš„measurementä¹‹é—´åªæœ‰ä¸€ä¸ªé€—å·ï¼Œ<strong>å¹¶æ²¡æœ‰ç©ºæ ¼ï¼</strong>ï¼Œä¸€å¼€å§‹ä¸çŸ¥é“è¿™å›äº‹ï¼Œæ€ä¹ˆæ’å…¥éƒ½æ˜¯å¤±è´¥ã€‚â€œcost=3421.6â€è¿™ä¸ªå«åšfiled setï¼Œfiledçš„ç±»å‹å¯ä»¥æ˜¯floatã€booleanã€integerã€‚è¿™æ ·æ’å…¥çš„ä¸€æ¡æ•°æ®ï¼ŒinfluxDBä¸­å«åšä¸€ä¸ªpointã€‚</p></li></ul><ul><li><p>æŸ¥è¯¢æ“ä½œ</p><p>æŸ¥è¯¢ä¹‹å‰è¦é€‰æ‹©ä½ æƒ³æŸ¥è¯¢çš„æ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use first_db</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from product</span><br></pre></td></tr></table></figure></li></ul><ul><li><p><img src="https://ws2.sinaimg.cn/large/006tNbRwgy1fxzdysawf8j31hq0cqwgt.jpg" alt=""></p></li><li><p>å¯ä»¥çœ‹åˆ°influxDBè‡ªåŠ¨ä¸ºæˆ‘ä»¬çš„è¿™ä¸ªpointåŠ äº†ä¸€ä¸ªtimestampï¼Œè¿™ä¸ªæ˜¯æ•°æ®çš„UNIXæ—¶é—´æ ¼å¼çš„æ—¶é—´ç²¾åº¦ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨æ•°æ®åº“æ—¶å¯ä»¥å®šä¹‰è¿™ä¸ªprecisionï¼Œåƒä¸‹é¢è¿™æ ·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">influx --precision rfc3339</span><br></pre></td></tr></table></figure><p>influxDBè§„å®šäº†å¾ˆå¤šæ—¶é—´ç²¾åº¦ï¼Œå…·ä½“å¯ä»¥åœ¨å‘½ä»¤è¡Œè¾“å‡ºhelpæŸ¥çœ‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">precision &lt;format&gt;    specifies the format of the timestamp: rfc3339, h, m, s, ms, u or ns</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¯æŒ‡å®šçš„æ—¶é—´ç²¾åº¦</span></span><br></pre></td></tr></table></figure><ul><li><p>ä½¿ç”¨influxDBå†…ç½®CLIæ‰§è¡ŒæŸ¥è¯¢æ“ä½œ</p><p>è¿˜æ˜¯æŸ¥è¯¢æˆ‘ä»¬åˆšåˆšæ’å…¥çš„é‚£æ¡æ•°æ®,åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -G 'http://localhost:8086/query?pretty=true' --data-urlencode "db=first_db" --data-urlencode "q=SELECT \"cost\" FROM \"product\" WHERE \"productName\"='disk'"</span><br></pre></td></tr></table></figure><p>å¾—åˆ°è¾“å‡ºä¸ºjsonç»“æ„çš„æŸ¥è¯¢ç»“æœ<img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxzegqffyhj31x50u0jvr.jpg" alt=""></p><p>influxDBå†…ç½®çš„APIå¾ˆå¤§ç¨‹åº¦ç®€åŒ–äº†åç«¯çš„å¼€å‘ï¼Œä½¿å„ç§é¡¹ç›®å¯ä»¥å¿«é€Ÿä¸Šçº¿ã€‚</p></li><li><p>æ’å…¥æ“ä½œçš„API</p></li></ul><p>åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -i -XPOST 'http://localhost:8086/write?db=first_db' --data-binary 'weather,location=us-midwes temperature=125'</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ’å…¥ä¸€æ¡æ•°æ®ï¼Œmeasurement=weatherï¼Œtag=locationï¼Œfiled=temperature,æ—¶é—´æˆ³ä¸ºå½“åœ°æœåŠ¡å™¨æ—¶é—´</span></span><br></pre></td></tr></table></figure><ul><li>æˆ‘ä»¬ä½¿ç”¨postmanæµ‹è¯•è¿™ä¸ªæ’å…¥æ¥å£ï¼Œä»¥ç¡®å®šè¯¥æ¥å£çš„headerï¼Œbodyç­‰ï¼Œä¸ºæ¥ä¸‹æ¥ä½¿ç”¨goç¼–å†™è¯·æ±‚ä»£ç åšå¥½å‡†å¤‡ã€‚é€šè¿‡åˆ†æURLï¼Œæˆ‘ä»¬å¯çŸ¥è¯·æ±‚çš„paramæ˜¯db=first_dbï¼Œâ€“dat-binaryè¿™ä¸ªå‚æ•°ï¼Œæ„å‘³ç€ä½ çš„request bodyå¿…é¡»æ˜¯raw,è€Œä¸”headerçš„content-Type=â€textâ€,å…·ä½“çš„postmanè®¾ç½®å‚ç…§ä¸‹å›¾ï¼š<img src="https://ws4.sinaimg.cn/large/006tNbRwgy1fxzq4jt9xkj31qa0qcgoc.jpg" alt=""></li><li>ç‚¹å‡»Sendä¹‹åï¼Œå¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°responseçš„statusCodeæ˜¯204ï¼Œåœ¨httpåè®®ä¸­ï¼Œè¿™ä¸ªçŠ¶æ€ç æ„æ€æ˜¯è¿”å›ä½“ä¸­æ²¡æœ‰å†…å®¹ã€‚<img src="https://ws4.sinaimg.cn/large/006tNbRwly1fxzqcl2pvtj31q605yq3l.jpg" alt=""></li><li>æˆ‘ä»¬å›åˆ°influxDBçš„terminalä¸­æŸ¥çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ¡æ•°æ®å·²ç»æ’å…¥æˆåŠŸäº†ã€‚</li></ul><h3 id="GOæ“ä½œinfluxDBçš„APIå®ç°æ’å…¥æ•°æ®"><a href="#GOæ“ä½œinfluxDBçš„APIå®ç°æ’å…¥æ•°æ®" class="headerlink" title="GOæ“ä½œinfluxDBçš„APIå®ç°æ’å…¥æ•°æ®"></a>GOæ“ä½œinfluxDBçš„APIå®ç°æ’å…¥æ•°æ®</h3><ul><li><p>å¯ä»¥åˆ©ç”¨è¿™æ ·æ–¹ä¾¿çš„APIï¼Œç¼–å†™ä»£ç ï¼Œå®ç°æ•°æ®çš„æ‰¹é‡é‡‡é›†ã€ç®¡ç†ã€å±•ç¤ºï¼Œè¿™é‡Œæˆ‘ç”¨GOå¯¹æ’å…¥æ•°æ®çš„æ“ä½œç®€å•å®ç°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">reqBody := <span class="string">"weather,location=us-midwes temperature=521 1475839730100400200"</span></span><br><span class="line">rb := []<span class="keyword">byte</span>(reqBody)</span><br><span class="line">    headers := <span class="keyword">map</span>[<span class="keyword">string</span>]<span class="keyword">string</span>&#123;</span><br><span class="line"><span class="string">"Content-type"</span>: <span class="string">"text"</span>,</span><br><span class="line">&#125;</span><br><span class="line">resp, _,err := simpleHttpClient.DoRequest(<span class="string">"POST"</span>,<span class="string">"http://10.18.5.30:8086/write?db=first_db"</span>,headers,rb,<span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(resp))</span><br></pre></td></tr></table></figure><ul><li><p>ä½¿ç”¨çš„DoRequestæ–¹æ³•æ¥è‡ª<a href="https://github.com/hantmac/simple-httpClient" target="_blank" rel="noopener">è¿™é‡Œ</a>ï¼Œè¿™ä¸ªåº“å¯¹golangçš„httpæ“ä½œè¿›è¡Œç®€å•çš„å°è£…ï¼Œè€Œä¸”åŠ å…¥äº†é”™è¯¯å¤„ç†ï¼Œtimeoutå¼‚å¸¸æ£€æµ‹ç­‰ã€‚</p></li><li><p>å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨Goè‡ªå¸¦çš„net/httpåŒ…ä¸­çš„POSTæ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reqBody := <span class="string">"weather,location=us-midwes temperature=521 1475839730100400200"</span></span><br><span class="line"><span class="comment">//rb := []byte(reqBody)</span></span><br><span class="line">    rb := io.NewReader(reqBody)</span><br><span class="line">resp, err := http.Post(<span class="string">"http://10.18.5.30:8086/write?db=first_db"</span>,<span class="string">"text"</span>,rb)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="built_in">panic</span>(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="keyword">string</span>(resp))</span><br></pre></td></tr></table></figure><ul><li>éœ€è¦æ³¨æ„çš„æ˜¯å¯¹request bodyçš„ç±»å‹å¤„ç†ï¼Œnet/http.postæ–¹æ³•è¦æ±‚è¯¥å‚æ•°çš„ç±»å‹æ˜¯io.readerï¼Œæ‰€ä»¥è¦ä½¿ç”¨io.NewReader()è¿›è¡Œè½¬æ¢ã€‚</li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>ä»¥ä¸Šå°±æ˜¯å¯¹influxDBçš„å…¥é—¨ä»‹ç»ï¼ŒåŒ…æ‹¬åŸºæœ¬æ¦‚å¿µï¼Œå®‰è£…ï¼Œé…ç½®ï¼ŒåŸºæœ¬æ“ä½œï¼ˆCLIï¼ŒAPIï¼‰ä»¥åŠä½¿ç”¨GOç¼–å†™æ“ä½œæ•°æ®åº“çš„ä»£ç ã€‚ä½†influxDBçš„å¥¥ç§˜è¿œä¸æ­¢è¿™äº›ï¼Œ<a href="https://docs.influxdata.com/influxdb/v1.7/" target="_blank" rel="noopener">å¦‚éœ€æ›´åŠ æ·±å…¥çš„ç ”ç©¶å¯å‚é˜…å®˜æ–¹æ–‡æ¡£</a>ã€‚</li></ul></li></ul></li></ul></li></ul><hr>]]></content>
    
    <summary type="html">
    
      ä»‹ç»influxDBçš„åŸºæœ¬æ¦‚å¿µï¼ŒåŸºæœ¬æ“ä½œä»¥åŠå¦‚ä½•ä½¿ç”¨goå®ç°influxDBçš„æ“ä½œ
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/tags/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
      <category term="influxDB" scheme="https://cloudsjhan.github.io/tags/influxDB/"/>
    
  </entry>
  
  <entry>
    <title>(è½¬è½½)golangè¯­è¨€å¹¶å‘ä¸å¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£(2)</title>
    <link href="https://cloudsjhan.github.io/2018/12/07/%E8%BD%AC%E8%BD%BD-golang%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E2%80%94%E2%80%94goroutine%E5%92%8Cchannel%E7%9A%84%E8%AF%A6%E7%BB%86%E7%90%86%E8%A7%A3-2/"/>
    <id>https://cloudsjhan.github.io/2018/12/07/è½¬è½½-golangè¯­è¨€å¹¶å‘ä¸å¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£-2/</id>
    <published>2018-12-07T03:48:11.000Z</published>
    <updated>2018-12-07T03:50:05.116Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p><a href="https://studygolang.com/articles/9533" target="_blank" rel="noopener">æœ¬æ–‡è½¬è½½è‡ª</a>ï¼Œç‰ˆæƒå±äºåŸä½œè€…ã€‚</p><h1 id="Goè¯­è¨€çš„å¹¶å‘å’Œå¹¶è¡Œ"><a href="#Goè¯­è¨€çš„å¹¶å‘å’Œå¹¶è¡Œ" class="headerlink" title="Goè¯­è¨€çš„å¹¶å‘å’Œå¹¶è¡Œ"></a>Goè¯­è¨€çš„å¹¶å‘å’Œå¹¶è¡Œ</h1><p>ä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¸€ä¸ªç°è±¡ï¼Œè¿˜æ˜¯è¿™æ®µä»£ç ï¼Œå¦‚æœæˆ‘è·‘åœ¨ä¸¤ä¸ªgoroutinesé‡Œé¢çš„è¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var quit chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func loop() &#123;</span><br><span class="line">    for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">        fmt.Printf(&quot;%d &quot;, i)</span><br><span class="line">    &#125;</span><br><span class="line">    quit &lt;- 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    // å¼€ä¸¤ä¸ªgoroutineè·‘å‡½æ•°loop, loopå‡½æ•°è´Ÿè´£æ‰“å°10ä¸ªæ•°</span><br><span class="line">    go loop()</span><br><span class="line">    go loop()</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 2; i++ &#123;</span><br><span class="line">        &lt;- quit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è§‚å¯Ÿä¸‹è¾“å‡º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ?</p><p>ä»¥å‰æˆ‘ä»¬ç”¨çº¿ç¨‹å»åšç±»ä¼¼ä»»åŠ¡çš„æ—¶å€™ï¼Œç³»ç»Ÿçš„çº¿ç¨‹ä¼šæŠ¢å å¼åœ°è¾“å‡ºï¼Œ è¡¨ç°å‡ºæ¥çš„æ˜¯ä¹±åºåœ°è¾“å‡ºã€‚è€Œgoroutineä¸ºä»€ä¹ˆæ˜¯è¿™æ ·è¾“å‡ºçš„å‘¢ï¼Ÿ</p><h2 id="goroutineæ˜¯åœ¨å¹¶è¡Œå—ï¼Ÿ"><a href="#goroutineæ˜¯åœ¨å¹¶è¡Œå—ï¼Ÿ" class="headerlink" title="goroutineæ˜¯åœ¨å¹¶è¡Œå—ï¼Ÿ"></a>goroutineæ˜¯åœ¨å¹¶è¡Œå—ï¼Ÿ</h2><p>æˆ‘ä»¬æ‰¾ä¸ªä¾‹å­<a href="http://lib.csdn.net/base/softwaretest" target="_blank" rel="noopener">æµ‹è¯•</a>ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import &quot;fmt&quot;</span><br><span class="line">import &quot;time&quot;</span><br><span class="line"></span><br><span class="line">var quit chan int</span><br><span class="line"></span><br><span class="line">func foo(id int) &#123;</span><br><span class="line">    fmt.Println(id)</span><br><span class="line">    time.Sleep(time.Second) // åœé¡¿ä¸€ç§’</span><br><span class="line">    quit &lt;- 0 // å‘æ¶ˆæ¯ï¼šæˆ‘æ‰§è¡Œå®Œå•¦ï¼</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    count := 1000</span><br><span class="line">    quit = make(chan int, count) // ç¼“å†²1000ä¸ªæ•°æ®</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; count; i++ &#123; //å¼€1000ä¸ªgoroutine</span><br><span class="line">        go foo(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for i :=0 ; i &lt; count; i++ &#123; // ç­‰å¾…æ‰€æœ‰å®Œæˆæ¶ˆæ¯å‘é€å®Œæ¯•ã€‚</span><br><span class="line">        &lt;- quit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬è·‘ä¸€ä¸‹è¿™ä¸ªç¨‹åº(ä¹‹æ‰€ä»¥å…ˆç¼–è¯‘å†è¿è¡Œï¼Œæ˜¯ä¸ºäº†è®©ç¨‹åºè·‘çš„å°½é‡å¿«,æµ‹è¯•ç»“æœæ›´å¥½):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">go build test.go</span><br><span class="line">time ./test</span><br><span class="line">./test  0.01s user 0.01s system 1% cpu 1.016 total</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œæ€»è®¡ç”¨æ—¶æ¥è¿‘ä¸€ç§’ã€‚ è²Œä¼¼å¹¶è¡Œäº†ï¼</p><p>æˆ‘ä»¬éœ€è¦é¦–å…ˆè€ƒè™‘ä¸‹ä»€ä¹ˆæ˜¯å¹¶å‘, ä»€ä¹ˆæ˜¯å¹¶è¡Œ</p><h2 id="å¹¶è¡Œå’Œå¹¶å‘"><a href="#å¹¶è¡Œå’Œå¹¶å‘" class="headerlink" title="å¹¶è¡Œå’Œå¹¶å‘"></a>å¹¶è¡Œå’Œå¹¶å‘</h2><p>ä»æ¦‚å¿µä¸Šè®²ï¼Œå¹¶å‘å’Œå¹¶è¡Œæ˜¯ä¸åŒçš„, ç®€å•æ¥è¯´çœ‹è¿™ä¸ªå›¾ç‰‡(åŸå›¾æ¥è‡ª<a href="http://joearms.github.io/2013/04/05/concurrent-and-parallel-programming.html" target="_blank" rel="noopener">è¿™é‡Œ</a>)</p><p><img src="http://hit9.qiniudn.com/con_and_par.jpg" alt="img"></p><ul><li>ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªCoffeeæœºå™¨ï¼Œé‚£æ˜¯å¹¶å‘</li><li>ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸¤ä¸ªCoffeeæœºå™¨ï¼Œé‚£æ˜¯å¹¶è¡Œ</li></ul><p>æ›´å¤šçš„èµ„æ–™ï¼š <a href="http://www.aqee.net/docs/Concurrency-is-not-Parallelism/" target="_blank" rel="noopener">å¹¶å‘ä¸æ˜¯å¹¶è¡Œ</a>, å½“ç„¶Googleä¸Šæœ‰æ›´å¤šå…³äºå¹¶è¡Œå’Œå¹¶å‘çš„åŒºåˆ«ã€‚</p><p>é‚£ä¹ˆå›åˆ°ä¸€å¼€å§‹çš„ç–‘é—®ä¸Šï¼Œä»ä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­æ‰§è¡Œåçš„è¡¨ç°æ¥çœ‹ï¼Œå¤šä¸ªgoroutineè·‘loopå‡½æ•°ä¼šæŒ¨ä¸ªgoroutineå»è¿›è¡Œï¼Œè€Œsleepåˆ™æ˜¯ä¸€èµ·æ‰§è¡Œçš„ã€‚</p><p>è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ</p><p>é»˜è®¤åœ°ï¼Œ <a href="http://lib.csdn.net/base/go" target="_blank" rel="noopener">Go</a>æ‰€æœ‰çš„goroutinesåªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œè·‘ ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œ ä»¥ä¸Šä¸¤ä¸ªä»£ç éƒ½ä¸æ˜¯å¹¶è¡Œçš„ï¼Œä½†æ˜¯éƒ½æ˜¯æ˜¯å¹¶å‘çš„ã€‚</p><p>å¦‚æœå½“å‰goroutineä¸å‘ç”Ÿé˜»å¡ï¼Œå®ƒæ˜¯ä¸ä¼šè®©å‡ºCPUç»™å…¶ä»–goroutineçš„, æ‰€ä»¥ä¾‹å­ä¸€ä¸­çš„è¾“å‡ºä¼šæ˜¯ä¸€ä¸ªä¸€ä¸ªgoroutineè¿›è¡Œçš„ï¼Œè€Œsleepå‡½æ•°åˆ™é˜»å¡æ‰äº† å½“å‰goroutine, å½“å‰goroutineä¸»åŠ¨è®©å…¶ä»–goroutineæ‰§è¡Œ, æ‰€ä»¥å½¢æˆäº†é€»è¾‘ä¸Šçš„å¹¶è¡Œ, ä¹Ÿå°±æ˜¯å¹¶å‘ã€‚</p><h2 id="çœŸæ­£çš„å¹¶è¡Œ"><a href="#çœŸæ­£çš„å¹¶è¡Œ" class="headerlink" title="çœŸæ­£çš„å¹¶è¡Œ"></a>çœŸæ­£çš„å¹¶è¡Œ</h2><p>ä¸ºäº†è¾¾åˆ°çœŸæ­£çš„å¹¶è¡Œï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰Goæˆ‘ä»¬å…è®¸åŒæ—¶æœ€å¤šä½¿ç”¨å¤šä¸ªæ ¸ã€‚</p><p>å›åˆ°èµ·åˆçš„ä¾‹å­ï¼Œæˆ‘ä»¬è®¾ç½®æœ€å¤§å¼€2ä¸ªåŸç”Ÿçº¿ç¨‹, æˆ‘ä»¬éœ€è¦ç”¨åˆ°runtimeåŒ…(runtimeåŒ…æ˜¯goroutineçš„è°ƒåº¦å™¨):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;runtime&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var quit chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func loop() &#123;</span><br><span class="line">    for i := 0; i &lt; 100; i++ &#123; //ä¸ºäº†è§‚å¯Ÿï¼Œè·‘å¤šäº›</span><br><span class="line">        fmt.Printf(&quot;%d &quot;, i)</span><br><span class="line">    &#125;</span><br><span class="line">    quit &lt;- 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    runtime.GOMAXPROCS(2) // æœ€å¤šä½¿ç”¨2ä¸ªæ ¸</span><br><span class="line"></span><br><span class="line">    go loop()</span><br><span class="line">    go loop()</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 2; i++ &#123;</span><br><span class="line">        &lt;- quit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸‹ä¼šçœ‹åˆ°ä¸¤ä¸ªgoroutineä¼šæŠ¢å å¼åœ°è¾“å‡ºæ•°æ®äº†ã€‚</p><p>æˆ‘ä»¬è¿˜å¯ä»¥è¿™æ ·æ˜¾å¼åœ°è®©å‡ºCPUæ—¶é—´ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func loop() &#123;</span><br><span class="line">    for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">        runtime.Gosched() // æ˜¾å¼åœ°è®©å‡ºCPUæ—¶é—´ç»™å…¶ä»–goroutine</span><br><span class="line">        fmt.Printf(&quot;%d &quot;, i)</span><br><span class="line">    &#125;</span><br><span class="line">    quit &lt;- 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line"></span><br><span class="line">    go loop()</span><br><span class="line">    go loop()</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 2; i++ &#123;</span><br><span class="line">        &lt;- quit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§‚å¯Ÿä¸‹ç»“æœä¼šçœ‹åˆ°è¿™æ ·æœ‰è§„å¾‹çš„è¾“å‡º:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 8 8 9 9</span><br></pre></td></tr></table></figure><p>å…¶å®ï¼Œè¿™ç§ä¸»åŠ¨è®©å‡ºCPUæ—¶é—´çš„æ–¹å¼ä»ç„¶æ˜¯åœ¨å•æ ¸é‡Œè·‘ã€‚ä½†æ‰‹å·¥åœ°åˆ‡æ¢goroutineå¯¼è‡´äº†çœ‹ä¸Šå»çš„â€œå¹¶è¡Œâ€ã€‚</p><p>å…¶å®ä½œä¸ºä¸€ä¸ª<a href="http://lib.csdn.net/base/python" target="_blank" rel="noopener">Python</a>ç¨‹åºå‘˜ï¼Œgoroutineè®©æˆ‘æ›´å¤šåœ°æƒ³åˆ°çš„æ˜¯geventçš„åç¨‹ï¼Œè€Œä¸æ˜¯åŸç”Ÿçº¿ç¨‹ã€‚</p><p>å…³äºruntimeåŒ…å¯¹goroutineçš„è°ƒåº¦ï¼Œåœ¨stackoverflowä¸Šæœ‰ä¸€ä¸ªä¸é”™çš„ç­”æ¡ˆ:<a href="http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do" target="_blank" rel="noopener">http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do</a></p><h2 id="ä¸€ä¸ªå°é—®é¢˜"><a href="#ä¸€ä¸ªå°é—®é¢˜" class="headerlink" title="ä¸€ä¸ªå°é—®é¢˜"></a>ä¸€ä¸ªå°é—®é¢˜</h2><p>æˆ‘åœ¨Segmentfaultçœ‹åˆ°äº†è¿™ä¸ªé—®é¢˜: <a href="http://segmentfault.com/q/1010000000207474" target="_blank" rel="noopener">http://segmentfault.com/q/1010000000207474</a></p><p>é¢˜ç›®è¯´ï¼Œå¦‚ä¸‹çš„ç¨‹åºï¼ŒæŒ‰ç…§ç†è§£åº”è¯¥æ‰“å°ä¸‹5æ¬¡ <code>&quot;world&quot;</code>å‘€ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆä»€ä¹ˆä¹Ÿæ²¡æœ‰æ‰“å°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func say(s string) &#123;</span><br><span class="line">    for i := 0; i &lt; 5; i++ &#123;</span><br><span class="line">        fmt.Println(s)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    go say(&quot;world&quot;) //å¼€ä¸€ä¸ªæ–°çš„Goroutinesæ‰§è¡Œ</span><br><span class="line">    for &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥¼ä¸‹çš„ç­”æ¡ˆå·²ç»å¾ˆæ£’äº†ï¼Œè¿™é‡ŒGoä»ç„¶åœ¨ä½¿ç”¨å•æ ¸ï¼Œforæ­»å¾ªç¯å æ®äº†å•æ ¸CPUæ‰€æœ‰çš„èµ„æºï¼Œè€Œmainçº¿å’Œsayä¸¤ä¸ªgoroutineéƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢ï¼Œ æ‰€ä»¥sayæ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚è§£å†³æ–¹æ¡ˆè¿˜æ˜¯ä¸¤ä¸ªï¼š</p><ul><li>å…è®¸Goä½¿ç”¨å¤šæ ¸(<code>runtime.GOMAXPROCS</code>)</li><li>æ‰‹åŠ¨æ˜¾å¼è°ƒåŠ¨(<code>runtime.Gosched</code>)</li></ul><h2 id="runtimeè°ƒåº¦å™¨"><a href="#runtimeè°ƒåº¦å™¨" class="headerlink" title="runtimeè°ƒåº¦å™¨"></a>runtimeè°ƒåº¦å™¨</h2><p>runtimeè°ƒåº¦å™¨æ˜¯ä¸ªå¾ˆç¥å¥‡çš„ä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘çœŸæ˜¯ä½†æ„¿å®ƒä¸å­˜åœ¨ï¼Œæˆ‘å¸Œæœ›æ˜¾å¼è°ƒåº¦èƒ½æ›´ä¸ºè‡ªç„¶äº›ï¼Œå¤šæ ¸å¤„ç†é»˜è®¤å¼€å¯ã€‚</p><p>å…³äºruntimeåŒ…å‡ ä¸ªå‡½æ•°:</p><ul><li><code>Gosched</code> è®©å‡ºcpu</li><li><code>NumCPU</code> è¿”å›å½“å‰ç³»ç»Ÿçš„CPUæ ¸æ•°é‡</li><li><code>GOMAXPROCS</code> è®¾ç½®æœ€å¤§çš„å¯åŒæ—¶ä½¿ç”¨çš„CPUæ ¸æ•°</li><li><code>Goexit</code> é€€å‡ºå½“å‰goroutine(ä½†æ˜¯deferè¯­å¥ä¼šç…§å¸¸æ‰§è¡Œ)</li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æˆ‘ä»¬ä»ä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤çš„, æ‰€æœ‰goroutineä¼šåœ¨ä¸€ä¸ªåŸç”Ÿçº¿ç¨‹é‡Œè·‘ï¼Œä¹Ÿå°±æ˜¯åªä½¿ç”¨äº†ä¸€ä¸ªCPUæ ¸ã€‚</p><p>åœ¨åŒä¸€ä¸ªåŸç”Ÿçº¿ç¨‹é‡Œï¼Œå¦‚æœå½“å‰goroutineä¸å‘ç”Ÿé˜»å¡ï¼Œå®ƒæ˜¯ä¸ä¼šè®©å‡ºCPUæ—¶é—´ç»™å…¶ä»–åŒçº¿ç¨‹çš„goroutinesçš„ï¼Œè¿™æ˜¯Goè¿è¡Œæ—¶å¯¹goroutineçš„è°ƒåº¦ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨runtimeåŒ…æ¥æ‰‹å·¥è°ƒåº¦ã€‚</p><p>æœ¬æ–‡å¼€å¤´çš„ä¸¤ä¸ªä¾‹å­éƒ½æ˜¯é™åˆ¶åœ¨å•æ ¸CPUé‡Œæ‰§è¡Œçš„ï¼Œæ‰€æœ‰çš„goroutinesè·‘åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢ï¼Œåˆ†æå¦‚ä¸‹:</p><ul><li>å¯¹äºä»£ç ä¾‹å­ä¸€ï¼ˆloopå‡½æ•°çš„é‚£ä¸ªï¼‰ï¼Œæ¯ä¸ªgoroutineæ²¡æœ‰å‘ç”Ÿå µå¡(ç›´åˆ°quitæµå…¥æ•°æ®), æ‰€ä»¥åœ¨quitä¹‹å‰æ¯ä¸ªgoroutineä¸ä¼šä¸»åŠ¨è®©å‡ºCPUï¼Œä¹Ÿå°±å‘ç”Ÿäº†ä¸²è¡Œæ‰“å°</li><li>å¯¹äºä»£ç ä¾‹å­äºŒï¼ˆtimeçš„é‚£ä¸ªï¼‰ï¼Œæ¯ä¸ªgoroutineåœ¨sleepè¢«è°ƒç”¨çš„æ—¶å€™ä¼šé˜»å¡ï¼Œè®©å‡ºCPU, æ‰€ä»¥ä¾‹å­äºŒå¹¶å‘æ‰§è¡Œã€‚</li></ul><p>é‚£ä¹ˆå…³äºæˆ‘ä»¬å¼€å¯å¤šæ ¸çš„æ—¶å€™å‘¢ï¼ŸGoè¯­è¨€å¯¹goroutineçš„è°ƒåº¦è¡Œä¸ºåˆæ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥åœ¨Golangå®˜æ–¹ç½‘ç«™çš„<a href="http://golang.org/doc/faq#goroutines" target="_blank" rel="noopener">è¿™é‡Œ</a> æ‰¾åˆ°ä¸€å¥è¯:</p><blockquote><p>When a coroutine blocks, such as by calling a blocking system call, the run-time automatically moves other coroutines on the same operating system thread to a different, runnable thread so they wonâ€™t be blocked.</p></blockquote><p>ä¹Ÿå°±æ˜¯è¯´:</p><blockquote><p>å½“ä¸€ä¸ªgoroutineå‘ç”Ÿé˜»å¡ï¼ŒGoä¼šè‡ªåŠ¨åœ°æŠŠä¸è¯¥goroutineå¤„äºåŒä¸€ç³»ç»Ÿçº¿ç¨‹çš„å…¶ä»–goroutinesè½¬ç§»åˆ°å¦ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ä¸Šå»ï¼Œä»¥ä½¿è¿™äº›goroutinesä¸é˜»å¡</p></blockquote><h2 id="å¼€å¯å¤šæ ¸çš„å®éªŒ"><a href="#å¼€å¯å¤šæ ¸çš„å®éªŒ" class="headerlink" title="å¼€å¯å¤šæ ¸çš„å®éªŒ"></a>å¼€å¯å¤šæ ¸çš„å®éªŒ</h2><p>ä»ç„¶éœ€è¦åšä¸€ä¸ªå®éªŒï¼Œæ¥æµ‹è¯•ä¸‹å¤šæ ¸æ”¯æŒä¸‹goroutinesçš„å¯¹åŸç”Ÿçº¿ç¨‹çš„åˆ†é…, ä¹ŸéªŒè¯ä¸‹æˆ‘ä»¬æ‰€å¾—åˆ°çš„ç»“è®ºâ€œgoroutineä¸é˜»å¡ä¸æ”¾å¼€CPUâ€ã€‚</p><p>å®éªŒä»£ç å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;runtime&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">var quit chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func loop(id int) &#123; // id: è¯¥goroutineçš„æ ‡å·</span><br><span class="line">    for i := 0; i &lt; 10; i++ &#123; //æ‰“å°10æ¬¡è¯¥goroutineçš„æ ‡å·</span><br><span class="line">        fmt.Printf(&quot;%d &quot;, id)</span><br><span class="line">    &#125;</span><br><span class="line">    quit &lt;- 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    runtime.GOMAXPROCS(2) // æœ€å¤šåŒæ—¶ä½¿ç”¨2ä¸ªæ ¸</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 3; i++ &#123; //å¼€ä¸‰ä¸ªgoroutine</span><br><span class="line">        go loop(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; 3; i++ &#123;</span><br><span class="line">        &lt;- quit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤šè·‘å‡ æ¬¡ä¼šçœ‹åˆ°ç±»ä¼¼è¿™äº›è¾“å‡º(ä¸åŒæœºå™¨ç¯å¢ƒä¸ä¸€æ ·):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0 0 0 0 0 1 1 0 0 1 0 0 1 0 1 2 1 2 1 2 1 2 1 2 1 2 2 2 2 2</span><br><span class="line">0 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 2</span><br><span class="line">0 0 0 0 0 0 0 1 1 1 1 1 0 1 0 1 0 1 2 1 2 1 2 2 2 2 2 2 2 2</span><br><span class="line">0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 0 2 0 2 0 2 2 2 2 2 2 2 2</span><br><span class="line">0 0 0 0 0 0 0 1 0 0 1 0 1 2 1 2 1 2 1 2 1 2 1 2 1 2 1 2 2 2</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®ƒæˆ‘ä»¬ä¼šå‘ç°ä»¥ä¸‹ç°è±¡:</p><ul><li>æœ‰æ—¶ä¼šå‘ç”ŸæŠ¢å å¼è¾“å‡º(è¯´æ˜Goå¼€äº†ä¸æ­¢ä¸€ä¸ªåŸç”Ÿçº¿ç¨‹ï¼Œè¾¾åˆ°äº†çœŸæ­£çš„å¹¶è¡Œ)</li><li>æœ‰æ—¶ä¼šé¡ºåºè¾“å‡º, æ‰“å°å®Œ0å†æ‰“å°1, å†æ‰“å°2(è¯´æ˜Goå¼€ä¸€ä¸ªåŸç”Ÿçº¿ç¨‹ï¼Œå•çº¿ç¨‹ä¸Šçš„goroutineä¸é˜»å¡ä¸æ¾å¼€CPU)</li></ul><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬è¿˜ä¼šè§‚å¯Ÿåˆ°ä¸€ä¸ªç°è±¡ï¼Œæ— è®ºæ˜¯æŠ¢å åœ°è¾“å‡ºè¿˜æ˜¯é¡ºåºçš„è¾“å‡ºï¼Œéƒ½ä¼šæœ‰é‚£ä¹ˆä¸¤ä¸ªæ•°å­—è¡¨ç°å‡ºè¿™æ ·çš„ç°è±¡:</p><ul><li>ä¸€ä¸ªæ•°å­—çš„æ‰€æœ‰è¾“å‡ºéƒ½ä¼šåœ¨å¦ä¸€ä¸ªæ•°å­—çš„æ‰€æœ‰è¾“å‡ºä¹‹å‰</li></ul><p>åŸå› æ˜¯ï¼Œ 3ä¸ªgoroutineåˆ†é…åˆ°è‡³å¤š2ä¸ªçº¿ç¨‹ä¸Šï¼Œå°±ä¼šè‡³å°‘ä¸¤ä¸ªgoroutineåˆ†é…åˆ°åŒä¸€ä¸ªçº¿ç¨‹é‡Œï¼Œå•çº¿ç¨‹é‡Œçš„goroutine ä¸é˜»å¡ä¸æ”¾å¼€CPU, ä¹Ÿå°±å‘ç”Ÿäº†é¡ºåºè¾“å‡ºã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      golangè¯­è¨€å¹¶å‘ä¸å¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>(è½¬è½½)golangè¯­è¨€å¹¶å‘ä¸å¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£(1)</title>
    <link href="https://cloudsjhan.github.io/2018/12/07/%E8%BD%AC%E8%BD%BD-golang%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E2%80%94%E2%80%94goroutine%E5%92%8Cchannel%E7%9A%84%E8%AF%A6%E7%BB%86%E7%90%86%E8%A7%A3-1/"/>
    <id>https://cloudsjhan.github.io/2018/12/07/è½¬è½½-golangè¯­è¨€å¹¶å‘ä¸å¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£-1/</id>
    <published>2018-12-07T03:38:01.000Z</published>
    <updated>2018-12-07T03:50:54.511Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æœ¬ç¯‡åšæ–‡è½¬è½½è‡ª<a href="https://studygolang.com/articles/9532?fr=sidebar" target="_blank" rel="noopener">goè¯­è¨€ä¸­æ–‡ç½‘</a>ï¼Œç‰ˆæƒå±åŸä½œè€…æ‰€æœ‰ã€‚</p><p>å¦‚æœä¸æ˜¯æˆ‘å¯¹çœŸæ­£å¹¶è¡Œçš„çº¿ç¨‹çš„è¿½æ±‚ï¼Œå°±ä¸ä¼šè®¤è¯†åˆ°<a href="http://lib.csdn.net/base/go" target="_blank" rel="noopener">Go</a>æœ‰å¤šä¹ˆçš„è¿·äººã€‚</p><p>Goè¯­è¨€ä»è¯­è¨€å±‚é¢ä¸Šå°±æ”¯æŒäº†å¹¶å‘ï¼Œè¿™ä¸å…¶ä»–è¯­è¨€å¤§ä¸ä¸€æ ·ï¼Œä¸åƒä»¥å‰æˆ‘ä»¬è¦ç”¨Threadåº“ æ¥æ–°å»ºçº¿ç¨‹ï¼Œè¿˜è¦ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—åº“æ¥å…±äº«æ•°æ®ã€‚</p><p>ä»¥ä¸‹æ˜¯æˆ‘å…¥é—¨çš„å­¦ä¹ ç¬”è®°ã€‚</p><h1 id="Goè¯­è¨€çš„goroutinesã€ä¿¡é“å’Œæ­»é”"><a href="#Goè¯­è¨€çš„goroutinesã€ä¿¡é“å’Œæ­»é”" class="headerlink" title="Goè¯­è¨€çš„goroutinesã€ä¿¡é“å’Œæ­»é”"></a>Goè¯­è¨€çš„goroutinesã€ä¿¡é“å’Œæ­»é”</h1><h2 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h2><p>Goè¯­è¨€ä¸­æœ‰ä¸ªæ¦‚å¿µå«åšgoroutine, è¿™ç±»ä¼¼æˆ‘ä»¬ç†ŸçŸ¥çš„çº¿ç¨‹ï¼Œä½†æ˜¯æ›´è½»ã€‚</p><p>ä»¥ä¸‹çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸²è¡Œåœ°å»æ‰§è¡Œä¸¤æ¬¡<code>loop</code>å‡½æ•°:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func loop() &#123;</span><br><span class="line">    for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">        fmt.Printf(&quot;%d &quot;, i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    loop()</span><br><span class="line">    loop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯«æ— ç–‘é—®ï¼Œè¾“å‡ºä¼šæ˜¯è¿™æ ·çš„:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬æŠŠä¸€ä¸ªloopæ”¾åœ¨ä¸€ä¸ªgoroutineé‡Œè·‘ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³é”®å­—<code>go</code>æ¥å®šä¹‰å¹¶å¯åŠ¨ä¸€ä¸ªgoroutine:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    go loop() // å¯åŠ¨ä¸€ä¸ªgoroutine</span><br><span class="line">    loop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡çš„è¾“å‡ºå˜æˆäº†:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0 1 2 3 4 5 6 7 8 9</span><br></pre></td></tr></table></figure><p>å¯æ˜¯ä¸ºä»€ä¹ˆåªè¾“å‡ºäº†ä¸€è¶Ÿå‘¢ï¼Ÿæ˜æ˜æˆ‘ä»¬ä¸»çº¿è·‘äº†ä¸€è¶Ÿï¼Œä¹Ÿå¼€äº†ä¸€ä¸ªgoroutineæ¥è·‘ä¸€è¶Ÿå•Šã€‚</p><p>åŸæ¥ï¼Œåœ¨goroutineè¿˜æ²¡æ¥å¾—åŠè·‘loopçš„æ—¶å€™ï¼Œä¸»å‡½æ•°å·²ç»é€€å‡ºäº†ã€‚</p><p>mainå‡½æ•°é€€å‡ºåœ°å¤ªå¿«äº†ï¼Œæˆ‘ä»¬è¦æƒ³åŠæ³•é˜»æ­¢å®ƒè¿‡æ—©åœ°é€€å‡ºï¼Œä¸€ä¸ªåŠæ³•æ˜¯è®©mainç­‰å¾…ä¸€ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    go loop()</span><br><span class="line">    loop()</span><br><span class="line">    time.Sleep(time.Second) // åœé¡¿ä¸€ç§’</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡ç¡®å®è¾“å‡ºäº†ä¸¤è¶Ÿï¼Œç›®çš„è¾¾åˆ°äº†ã€‚</p><p>å¯æ˜¯é‡‡ç”¨ç­‰å¾…çš„åŠæ³•å¹¶ä¸å¥½ï¼Œå¦‚æœgoroutineåœ¨ç»“æŸçš„æ—¶å€™ï¼Œå‘Šè¯‰ä¸‹ä¸»çº¿è¯´â€œHey, æˆ‘è¦è·‘å®Œäº†ï¼â€å°±å¥½äº†ï¼Œ å³æ‰€è°“é˜»å¡ä¸»çº¿çš„åŠæ³•ï¼Œå›å¿†ä¸‹æˆ‘ä»¬<a href="http://lib.csdn.net/base/python" target="_blank" rel="noopener">Python</a>é‡Œé¢ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•çš„å†™æ³•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for thread in threads:</span><br><span class="line">    thread.join()</span><br></pre></td></tr></table></figure><p>æ˜¯çš„ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªç±»ä¼¼<code>join</code>çš„ä¸œè¥¿æ¥é˜»å¡ä½ä¸»çº¿ã€‚é‚£å°±æ˜¯ä¿¡é“</p><h2 id="ä¿¡é“"><a href="#ä¿¡é“" class="headerlink" title="ä¿¡é“"></a>ä¿¡é“</h2><p>ä¿¡é“æ˜¯ä»€ä¹ˆï¼Ÿç®€å•è¯´ï¼Œæ˜¯goroutineä¹‹é—´äº’ç›¸é€šè®¯çš„ä¸œè¥¿ã€‚ç±»ä¼¼æˆ‘ä»¬Unixä¸Šçš„ç®¡é“ï¼ˆå¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’æ¶ˆæ¯ï¼‰ï¼Œ ç”¨æ¥goroutineä¹‹é—´å‘æ¶ˆæ¯å’Œæ¥æ”¶æ¶ˆæ¯ã€‚å…¶å®ï¼Œå°±æ˜¯åœ¨åšgoroutineä¹‹é—´çš„å†…å­˜å…±äº«ã€‚</p><p>ä½¿ç”¨<code>make</code>æ¥å»ºç«‹ä¸€ä¸ªä¿¡é“:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var channel chan int = make(chan int)</span><br><span class="line">// æˆ–</span><br><span class="line">channel := make(chan int)</span><br></pre></td></tr></table></figure><p>é‚£å¦‚ä½•å‘ä¿¡é“å­˜æ¶ˆæ¯å’Œå–æ¶ˆæ¯å‘¢ï¼Ÿ ä¸€ä¸ªä¾‹å­:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    var messages chan string = make(chan string)</span><br><span class="line">    go func(message string) &#123;</span><br><span class="line">        messages &lt;- message // å­˜æ¶ˆæ¯</span><br><span class="line">    &#125;(&quot;Ping!&quot;)</span><br><span class="line"></span><br><span class="line">    fmt.Println(&lt;-messages) // å–æ¶ˆæ¯</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„ï¼Œä¿¡é“çš„å­˜æ¶ˆæ¯å’Œå–æ¶ˆæ¯éƒ½æ˜¯é˜»å¡çš„ (å«åšæ— ç¼“å†²çš„ä¿¡é“ï¼Œä¸è¿‡ç¼“å†²è¿™ä¸ªæ¦‚å¿µç¨åäº†è§£ï¼Œå…ˆè¯´é˜»å¡çš„é—®é¢˜)ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´, æ— ç¼“å†²çš„ä¿¡é“åœ¨å–æ¶ˆæ¯å’Œå­˜æ¶ˆæ¯çš„æ—¶å€™éƒ½ä¼šæŒ‚èµ·å½“å‰çš„goroutineï¼Œé™¤éå¦ä¸€ç«¯å·²ç»å‡†å¤‡å¥½ã€‚</p><p>æ¯”å¦‚ä»¥ä¸‹çš„mainå‡½æ•°å’Œfooå‡½æ•°:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">var ch chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func foo() &#123;</span><br><span class="line">    ch &lt;- 0  // å‘chä¸­åŠ æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰å…¶ä»–goroutineæ¥å–èµ°è¿™ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆæŒ‚èµ·foo, ç›´åˆ°mainå‡½æ•°æŠŠ0è¿™ä¸ªæ•°æ®æ‹¿èµ°</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    go foo()</span><br><span class="line">    &lt;- ch // ä»chå–æ•°æ®ï¼Œå¦‚æœchä¸­è¿˜æ²¡æ”¾æ•°æ®ï¼Œé‚£å°±æŒ‚èµ·mainçº¿ï¼Œç›´åˆ°fooå‡½æ•°ä¸­æ”¾æ•°æ®ä¸ºæ­¢</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£æ—¢ç„¶ä¿¡é“å¯ä»¥é˜»å¡å½“å‰çš„goroutine, é‚£ä¹ˆå›åˆ°ä¸Šä¸€éƒ¨åˆ†ã€Œgoroutineã€æ‰€é‡åˆ°çš„é—®é¢˜ã€Œå¦‚ä½•è®©goroutineå‘Šè¯‰ä¸»çº¿æˆ‘æ‰§è¡Œå®Œæ¯•äº†ã€ çš„é—®é¢˜æ¥, ä½¿ç”¨ä¸€ä¸ªä¿¡é“æ¥å‘Šè¯‰ä¸»çº¿å³å¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">var complete chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func loop() &#123;</span><br><span class="line">    for i := 0; i &lt; 10; i++ &#123;</span><br><span class="line">        fmt.Printf(&quot;%d &quot;, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    complete &lt;- 0 // æ‰§è¡Œå®Œæ¯•äº†ï¼Œå‘ä¸ªæ¶ˆæ¯</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    go loop()</span><br><span class="line">    &lt;- complete // ç›´åˆ°çº¿ç¨‹è·‘å®Œ, å–åˆ°æ¶ˆæ¯. mainåœ¨æ­¤é˜»å¡ä½</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä¸ç”¨ä¿¡é“æ¥é˜»å¡ä¸»çº¿çš„è¯ï¼Œä¸»çº¿å°±ä¼šè¿‡æ—©è·‘å®Œï¼Œloopçº¿éƒ½æ²¡æœ‰æœºä¼šæ‰§è¡Œã€ã€ã€</p><p>å…¶å®ï¼Œæ— ç¼“å†²çš„ä¿¡é“æ°¸è¿œä¸ä¼šå­˜å‚¨æ•°æ®ï¼Œåªè´Ÿè´£æ•°æ®çš„æµé€šï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®²å‘¢ï¼Ÿ</p><ul><li>ä»æ— ç¼“å†²ä¿¡é“å–æ•°æ®ï¼Œå¿…é¡»è¦æœ‰æ•°æ®æµè¿›æ¥æ‰å¯ä»¥ï¼Œå¦åˆ™å½“å‰çº¿é˜»å¡</li><li>æ•°æ®æµå…¥æ— ç¼“å†²ä¿¡é“, å¦‚æœæ²¡æœ‰å…¶ä»–goroutineæ¥æ‹¿èµ°è¿™ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆå½“å‰çº¿é˜»å¡</li></ul><p>æ‰€ä»¥ï¼Œä½ å¯ä»¥<a href="http://lib.csdn.net/base/softwaretest" target="_blank" rel="noopener">æµ‹è¯•</a>ä¸‹ï¼Œæ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬æµ‹è¯•åˆ°çš„æ— ç¼“å†²ä¿¡é“çš„å¤§å°éƒ½æ˜¯0 (<code>len(channel)</code>)</p><p>å¦‚æœä¿¡é“æ­£æœ‰æ•°æ®åœ¨æµåŠ¨ï¼Œæˆ‘ä»¬è¿˜è¦åŠ å…¥æ•°æ®ï¼Œæˆ–è€…ä¿¡é“å¹²æ¶©ï¼Œæˆ‘ä»¬ä¸€ç›´å‘æ— æ•°æ®æµå…¥çš„ç©ºä¿¡é“å–æ•°æ®å‘¢ï¼Ÿ å°±ä¼šå¼•èµ·æ­»é”</p><h2 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h2><p>ä¸€ä¸ªæ­»é”çš„ä¾‹å­:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    ch := make(chan int)</span><br><span class="line">    &lt;- ch // é˜»å¡main goroutine, ä¿¡é“cè¢«é”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œè¿™ä¸ªç¨‹åºä½ ä¼šçœ‹åˆ°GoæŠ¥è¿™æ ·çš„é”™è¯¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br></pre></td></tr></table></figure><p>ä½•è°“æ­»é”? <a href="http://lib.csdn.net/base/operatingsystem" target="_blank" rel="noopener">æ“ä½œç³»ç»Ÿ</a>æœ‰è®²è¿‡çš„ï¼Œæ‰€æœ‰çš„çº¿ç¨‹æˆ–è¿›ç¨‹éƒ½åœ¨ç­‰å¾…èµ„æºçš„é‡Šæ”¾ã€‚å¦‚ä¸Šçš„ç¨‹åºä¸­, åªæœ‰ä¸€ä¸ªgoroutine, æ‰€ä»¥å½“ä½ å‘é‡Œé¢åŠ æ•°æ®æˆ–è€…å­˜æ•°æ®çš„è¯ï¼Œéƒ½ä¼šé”æ­»ä¿¡é“ï¼Œ å¹¶ä¸”é˜»å¡å½“å‰ goroutine, ä¹Ÿå°±æ˜¯æ‰€æœ‰çš„goroutine(å…¶å®å°±mainçº¿ä¸€ä¸ª)éƒ½åœ¨ç­‰å¾…ä¿¡é“çš„å¼€æ”¾(æ²¡äººæ‹¿èµ°æ•°æ®ä¿¡é“æ˜¯ä¸ä¼šå¼€æ”¾çš„)ï¼Œä¹Ÿå°±æ˜¯æ­»é”å’¯ã€‚</p><p>æˆ‘å‘ç°æ­»é”æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¯é¢˜ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªæ­»é”çš„ä¾‹å­:</p><ol><li><p>åªåœ¨å•ä¸€çš„goroutineé‡Œæ“ä½œæ— ç¼“å†²ä¿¡é“ï¼Œä¸€å®šæ­»é”ã€‚æ¯”å¦‚ä½ åªåœ¨mainå‡½æ•°é‡Œæ“ä½œä¿¡é“:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    ch := make(chan int)</span><br><span class="line">    ch &lt;- 1 // 1æµå…¥ä¿¡é“ï¼Œå µå¡å½“å‰çº¿, æ²¡äººå–èµ°æ•°æ®ä¿¡é“ä¸ä¼šæ‰“å¼€</span><br><span class="line">    fmt.Println(&quot;This line code wont run&quot;) //åœ¨æ­¤è¡Œæ‰§è¡Œä¹‹å‰Goå°±ä¼šæŠ¥æ­»é”</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚ä¸‹ä¹Ÿæ˜¯ä¸€ä¸ªæ­»é”çš„ä¾‹å­:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var ch1 chan int = make(chan int)</span><br><span class="line">var ch2 chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func say(s string) &#123;</span><br><span class="line">    fmt.Println(s)</span><br><span class="line">    ch1 &lt;- &lt;- ch2 // ch1 ç­‰å¾… ch2æµå‡ºçš„æ•°æ®</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    go say(&quot;hello&quot;)</span><br><span class="line">    &lt;- ch1  // å µå¡ä¸»çº¿</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ä¸»çº¿ç­‰ch1ä¸­çš„æ•°æ®æµå‡ºï¼Œch1ç­‰ch2çš„æ•°æ®æµå‡ºï¼Œä½†æ˜¯ch2ç­‰å¾…æ•°æ®æµå…¥ï¼Œä¸¤ä¸ªgoroutineéƒ½åœ¨ç­‰ï¼Œä¹Ÿå°±æ˜¯æ­»é”ã€‚</p></li><li><p>å…¶å®ï¼Œæ€»ç»“æ¥çœ‹ï¼Œä¸ºä»€ä¹ˆä¼šæ­»é”ï¼Ÿéç¼“å†²ä¿¡é“ä¸Šå¦‚æœå‘ç”Ÿäº†æµå…¥æ— æµå‡ºï¼Œæˆ–è€…æµå‡ºæ— æµå…¥ï¼Œä¹Ÿå°±å¯¼è‡´äº†æ­»é”ã€‚æˆ–è€…è¿™æ ·ç†è§£ Goå¯åŠ¨çš„æ‰€æœ‰goroutineé‡Œçš„éç¼“å†²ä¿¡é“ä¸€å®šè¦ä¸€ä¸ªçº¿é‡Œå­˜æ•°æ®ï¼Œä¸€ä¸ªçº¿é‡Œå–æ•°æ®ï¼Œè¦æˆå¯¹æ‰è¡Œ ã€‚æ‰€ä»¥ä¸‹é¢çš„ç¤ºä¾‹ä¸€å®šæ­»é”:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">c, quit := make(chan int), make(chan int)</span><br><span class="line"></span><br><span class="line">go func() &#123;</span><br><span class="line">   c &lt;- 1  // cé€šé“çš„æ•°æ®æ²¡æœ‰è¢«å…¶ä»–goroutineè¯»å–èµ°ï¼Œå µå¡å½“å‰goroutine</span><br><span class="line">   quit &lt;- 0 // quitå§‹ç»ˆæ²¡æœ‰åŠæ³•å†™å…¥æ•°æ®</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&lt;- quit // quit ç­‰å¾…æ•°æ®çš„å†™</span><br></pre></td></tr></table></figure><p>ä»”ç»†åˆ†æçš„è¯ï¼Œæ˜¯ç”±äºï¼šä¸»çº¿ç­‰å¾…quitä¿¡é“çš„æ•°æ®æµå‡ºï¼Œquitç­‰å¾…æ•°æ®å†™å…¥ï¼Œè€Œfuncè¢«cé€šé“å µå¡ï¼Œæ‰€æœ‰goroutineéƒ½åœ¨ç­‰ï¼Œæ‰€ä»¥æ­»é”ã€‚</p><p>ç®€å•æ¥çœ‹çš„è¯ï¼Œä¸€å…±ä¸¤ä¸ªçº¿ï¼Œfuncçº¿ä¸­æµå…¥cé€šé“çš„æ•°æ®å¹¶æ²¡æœ‰åœ¨mainçº¿ä¸­æµå‡ºï¼Œè‚¯å®šæ­»é”ã€‚</p></li></ol><p>ä½†æ˜¯ï¼Œæ˜¯å¦æœçœŸ æ‰€æœ‰ä¸æˆå¯¹å‘ä¿¡é“å­˜å–æ•°æ®çš„æƒ…å†µéƒ½æ˜¯æ­»é”?</p><p>å¦‚ä¸‹æ˜¯ä¸ªåä¾‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    c := make(chan int)</span><br><span class="line"></span><br><span class="line">    go func() &#123;</span><br><span class="line">       c &lt;- 1</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºæ­£å¸¸é€€å‡ºäº†ï¼Œå¾ˆç®€å•ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬é‚£ä¸ªæ€»ç»“ä¸èµ·ä½œç”¨äº†ï¼Œè¿˜æ˜¯å› ä¸ºä¸€ä¸ªè®©äººå¾ˆå›§çš„åŸå› ï¼Œmainåˆæ²¡ç­‰å¾…å…¶å®ƒgoroutineï¼Œè‡ªå·±å…ˆè·‘å®Œäº†ï¼Œ æ‰€ä»¥æ²¡æœ‰æ•°æ®æµå…¥cä¿¡é“ï¼Œä¸€å…±æ‰§è¡Œäº†ä¸€ä¸ªgoroutine, å¹¶ä¸”æ²¡æœ‰å‘ç”Ÿé˜»å¡ï¼Œæ‰€ä»¥æ²¡æœ‰æ­»é”é”™è¯¯ã€‚</p><p>é‚£ä¹ˆæ­»é”çš„è§£å†³åŠæ³•å‘¢ï¼Ÿ</p><p>æœ€ç®€å•çš„ï¼ŒæŠŠæ²¡å–èµ°çš„æ•°æ®å–èµ°ï¼Œæ²¡æ”¾å…¥çš„æ•°æ®æ”¾å…¥ï¼Œ å› ä¸ºæ— ç¼“å†²ä¿¡é“ä¸èƒ½æ‰¿è½½æ•°æ®ï¼Œé‚£ä¹ˆå°±èµ¶ç´§æ‹¿èµ°ï¼</p><p>å…·ä½“æ¥è®²ï¼Œå°±æ­»é”ä¾‹å­3ä¸­çš„æƒ…å†µï¼Œå¯ä»¥è¿™ä¹ˆé¿å…æ­»é”:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">c, quit := make(chan int), make(chan int)</span><br><span class="line"></span><br><span class="line">go func() &#123;</span><br><span class="line">    c &lt;- 1</span><br><span class="line">    quit &lt;- 0</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line">&lt;- c // å–èµ°cçš„æ•°æ®ï¼</span><br><span class="line">&lt;-quit</span><br></pre></td></tr></table></figure><p>å¦ä¸€ä¸ªè§£å†³åŠæ³•æ˜¯ç¼“å†²ä¿¡é“, å³è®¾ç½®cæœ‰ä¸€ä¸ªæ•°æ®çš„ç¼“å†²å¤§å°:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c := make(chan int, 1)</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è¯ï¼Œcå¯ä»¥ç¼“å­˜ä¸€ä¸ªæ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ”¾å…¥ä¸€ä¸ªæ•°æ®ï¼Œcå¹¶ä¸ä¼šæŒ‚èµ·å½“å‰çº¿, å†æ”¾ä¸€ä¸ªæ‰ä¼šæŒ‚èµ·å½“å‰çº¿ç›´åˆ°ç¬¬ä¸€ä¸ªæ•°æ®è¢«å…¶ä»–goroutineå–èµ°, ä¹Ÿå°±æ˜¯åªé˜»å¡åœ¨å®¹é‡ä¸€å®šçš„æ—¶å€™ï¼Œä¸è¾¾å®¹é‡ä¸é˜»å¡ã€‚</p><p>è¿™ååˆ†ç±»ä¼¼æˆ‘ä»¬Pythonä¸­çš„é˜Ÿåˆ—<code>Queue</code>ä¸æ˜¯å—ï¼Ÿ</p><h2 id="æ— ç¼“å†²ä¿¡é“çš„æ•°æ®è¿›å‡ºé¡ºåº"><a href="#æ— ç¼“å†²ä¿¡é“çš„æ•°æ®è¿›å‡ºé¡ºåº" class="headerlink" title="æ— ç¼“å†²ä¿¡é“çš„æ•°æ®è¿›å‡ºé¡ºåº"></a>æ— ç¼“å†²ä¿¡é“çš„æ•°æ®è¿›å‡ºé¡ºåº</h2><p>æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œæ— ç¼“å†²ä¿¡é“ä»ä¸å­˜å‚¨æ•°æ®ï¼Œæµå…¥çš„æ•°æ®å¿…é¡»è¦æµå‡ºæ‰å¯ä»¥ã€‚</p><p>è§‚å¯Ÿä»¥ä¸‹çš„ç¨‹åº:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var ch chan int = make(chan int)</span><br><span class="line"></span><br><span class="line">func foo(id int) &#123; //id: è¿™ä¸ªroutineçš„æ ‡å·</span><br><span class="line">    ch &lt;- id</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    // å¼€å¯5ä¸ªroutine</span><br><span class="line">    for i := 0; i &lt; 5; i++ &#123;</span><br><span class="line">        go foo(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å–å‡ºä¿¡é“ä¸­çš„æ•°æ®</span><br><span class="line">    for i := 0; i &lt; 5; i++ &#123;</span><br><span class="line">        fmt.Print(&lt;- ch)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¼€äº†5ä¸ªgoroutineï¼Œç„¶ååˆä¾æ¬¡å–æ•°æ®ã€‚å…¶å®æ•´ä¸ªçš„æ‰§è¡Œè¿‡ç¨‹ç»†åˆ†çš„è¯ï¼Œ5ä¸ªçº¿çš„æ•°æ® ä¾æ¬¡æµè¿‡ä¿¡é“ch, mainæ‰“å°ä¹‹, è€Œå®è§‚ä¸Šæˆ‘ä»¬çœ‹åˆ°çš„å³ æ— ç¼“å†²ä¿¡é“çš„æ•°æ®æ˜¯å…ˆåˆ°å…ˆå‡ºï¼Œä½†æ˜¯ æ— ç¼“å†²ä¿¡é“å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œåªè´Ÿè´£æ•°æ®çš„æµé€š</p><h2 id="ç¼“å†²ä¿¡é“"><a href="#ç¼“å†²ä¿¡é“" class="headerlink" title="ç¼“å†²ä¿¡é“"></a>ç¼“å†²ä¿¡é“</h2><p>ç»ˆäºåˆ°äº†è¿™ä¸ªè¯é¢˜äº†, å…¶å®ç¼“å­˜ä¿¡é“ç”¨è‹±æ–‡æ¥è®²æ›´ä¸ºè¾¾æ„: buffered channel.</p><p>ç¼“å†²è¿™ä¸ªè¯æ„æ€æ˜¯ï¼Œç¼“å†²ä¿¡é“ä¸ä»…å¯ä»¥æµé€šæ•°æ®ï¼Œè¿˜å¯ä»¥ç¼“å­˜æ•°æ®ã€‚å®ƒæ˜¯æœ‰å®¹é‡çš„ï¼Œå­˜å…¥ä¸€ä¸ªæ•°æ®çš„è¯ , å¯ä»¥å…ˆæ”¾åœ¨ä¿¡é“é‡Œï¼Œä¸å¿…é˜»å¡å½“å‰çº¿è€Œç­‰å¾…è¯¥æ•°æ®å–èµ°ã€‚</p><p>å½“ç¼“å†²ä¿¡é“è¾¾åˆ°æ»¡çš„çŠ¶æ€çš„æ—¶å€™ï¼Œå°±ä¼šè¡¨ç°å‡ºé˜»å¡äº†ï¼Œå› ä¸ºè¿™æ—¶å†ä¹Ÿä¸èƒ½æ‰¿è½½æ›´å¤šçš„æ•°æ®äº†ï¼Œã€Œä½ ä»¬å¿…é¡»æŠŠ æ•°æ®æ‹¿èµ°ï¼Œæ‰å¯ä»¥æµå…¥æ•°æ®ã€ã€‚</p><p>åœ¨å£°æ˜ä¸€ä¸ªä¿¡é“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»™makeä»¥ç¬¬äºŒä¸ªå‚æ•°æ¥æŒ‡æ˜å®ƒçš„å®¹é‡(é»˜è®¤ä¸º0ï¼Œå³æ— ç¼“å†²):</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var ch chan int = make(chan int, 2) // å†™å…¥2ä¸ªå…ƒç´ éƒ½ä¸ä¼šé˜»å¡å½“å‰goroutine, å­˜å‚¨ä¸ªæ•°è¾¾åˆ°2çš„æ—¶å€™ä¼šé˜»å¡</span><br></pre></td></tr></table></figure><p>å¦‚ä¸‹çš„ä¾‹å­ï¼Œç¼“å†²ä¿¡é“chå¯ä»¥æ— ç¼“å†²çš„æµå…¥3ä¸ªå…ƒç´ :</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    ch := make(chan int, 3)</span><br><span class="line">    ch &lt;- 1</span><br><span class="line">    ch &lt;- 2</span><br><span class="line">    ch &lt;- 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å†è¯•å›¾æµå…¥ä¸€ä¸ªæ•°æ®çš„è¯ï¼Œä¿¡é“chä¼šé˜»å¡mainçº¿, æŠ¥æ­»é”ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼“å†²ä¿¡é“ä¼šåœ¨æ»¡å®¹é‡çš„æ—¶å€™åŠ é”ã€‚</p><p>å…¶å®ï¼Œç¼“å†²ä¿¡é“æ˜¯å…ˆè¿›å…ˆå‡ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç¼“å†²ä¿¡é“çœ‹ä½œä¸ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    ch := make(chan int, 3)</span><br><span class="line">    ch &lt;- 1</span><br><span class="line">    ch &lt;- 2</span><br><span class="line">    ch &lt;- 3</span><br><span class="line"></span><br><span class="line">    fmt.Println(&lt;-ch) // 1</span><br><span class="line">    fmt.Println(&lt;-ch) // 2</span><br><span class="line">    fmt.Println(&lt;-ch) // 3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¿¡é“æ•°æ®è¯»å–å’Œä¿¡é“å…³é—­"><a href="#ä¿¡é“æ•°æ®è¯»å–å’Œä¿¡é“å…³é—­" class="headerlink" title="ä¿¡é“æ•°æ®è¯»å–å’Œä¿¡é“å…³é—­"></a>ä¿¡é“æ•°æ®è¯»å–å’Œä¿¡é“å…³é—­</h2><p>ä½ ä¹Ÿè®¸å‘ç°ï¼Œä¸Šé¢çš„ä»£ç ä¸€ä¸ªä¸€ä¸ªåœ°å»è¯»å–ä¿¡é“ç®€ç›´å¤ªè´¹äº‹äº†ï¼ŒGoè¯­è¨€å…è®¸æˆ‘ä»¬ä½¿ç”¨<code>range</code>æ¥è¯»å–ä¿¡é“:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    ch := make(chan int, 3)</span><br><span class="line">    ch &lt;- 1</span><br><span class="line">    ch &lt;- 2</span><br><span class="line">    ch &lt;- 3</span><br><span class="line"></span><br><span class="line">    for v := range ch &#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ æ‰§è¡Œäº†ä¸Šé¢çš„ä»£ç ï¼Œä¼šæŠ¥æ­»é”é”™è¯¯çš„ï¼ŒåŸå› æ˜¯rangeä¸ç­‰åˆ°ä¿¡é“å…³é—­æ˜¯ä¸ä¼šç»“æŸè¯»å–çš„ã€‚ä¹Ÿå°±æ˜¯å¦‚æœ ç¼“å†²ä¿¡é“å¹²æ¶¸äº†ï¼Œé‚£ä¹ˆrangeå°±ä¼šé˜»å¡å½“å‰goroutine, æ‰€ä»¥æ­»é”å’¯ã€‚</p><p>é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯•ç€é¿å…è¿™ç§æƒ…å†µï¼Œæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ˜¯è¯»åˆ°ä¿¡é“ä¸ºç©ºçš„æ—¶å€™å°±ç»“æŸè¯»å–:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ch := make(chan int, 3)</span><br><span class="line">ch &lt;- 1</span><br><span class="line">ch &lt;- 2</span><br><span class="line">ch &lt;- 3</span><br><span class="line">for v := range ch &#123;</span><br><span class="line">    fmt.Println(v)</span><br><span class="line">    if len(ch) &lt;= 0 &#123; // å¦‚æœç°æœ‰æ•°æ®é‡ä¸º0ï¼Œè·³å‡ºå¾ªç¯</span><br><span class="line">        break</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šçš„æ–¹æ³•æ˜¯å¯ä»¥æ­£å¸¸è¾“å‡ºçš„ï¼Œä½†æ˜¯æ³¨æ„æ£€æŸ¥ä¿¡é“å¤§å°çš„æ–¹æ³•ä¸èƒ½åœ¨ä¿¡é“å­˜å–éƒ½åœ¨å‘ç”Ÿçš„æ—¶å€™ç”¨äºå–å‡ºæ‰€æœ‰æ•°æ®ï¼Œè¿™ä¸ªä¾‹å­ æ˜¯å› ä¸ºæˆ‘ä»¬åªåœ¨chä¸­å­˜äº†æ•°æ®ï¼Œç°åœ¨ä¸€ä¸ªä¸€ä¸ªå¾€å¤–å–ï¼Œä¿¡é“å¤§å°æ˜¯é€’å‡çš„ã€‚</p><p>å¦ä¸€ä¸ªæ–¹å¼æ˜¯æ˜¾å¼åœ°å…³é—­ä¿¡é“:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ch := make(chan int, 3)</span><br><span class="line">ch &lt;- 1</span><br><span class="line">ch &lt;- 2</span><br><span class="line">ch &lt;- 3</span><br><span class="line"></span><br><span class="line">// æ˜¾å¼åœ°å…³é—­ä¿¡é“</span><br><span class="line">close(ch)</span><br><span class="line"></span><br><span class="line">for v := range ch &#123;</span><br><span class="line">    fmt.Println(v)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¢«å…³é—­çš„ä¿¡é“ä¼šç¦æ­¢æ•°æ®æµå…¥, æ˜¯åªè¯»çš„ã€‚æˆ‘ä»¬ä»ç„¶å¯ä»¥ä»å…³é—­çš„ä¿¡é“ä¸­å–å‡ºæ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½å†å†™å…¥æ•°æ®äº†ã€‚</p><h2 id="ç­‰å¾…å¤šgorountineçš„æ–¹æ¡ˆ"><a href="#ç­‰å¾…å¤šgorountineçš„æ–¹æ¡ˆ" class="headerlink" title="ç­‰å¾…å¤šgorountineçš„æ–¹æ¡ˆ"></a>ç­‰å¾…å¤šgorountineçš„æ–¹æ¡ˆ</h2><p>é‚£å¥½ï¼Œæˆ‘ä»¬å›åˆ°æœ€åˆçš„ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ä¿¡é“å µå¡ä¸»çº¿ï¼Œç­‰å¾…å¼€å‡ºå»çš„æ‰€æœ‰goroutineè·‘å®Œã€‚</p><p>è¿™æ˜¯ä¸€ä¸ªæ¨¡å‹ï¼Œå¼€å‡ºå¾ˆå¤šå°goroutine, å®ƒä»¬å„è‡ªè·‘å„è‡ªçš„ï¼Œæœ€åè·‘å®Œäº†å‘ä¸»çº¿æŠ¥å‘Šã€‚</p><p>æˆ‘ä»¬è®¨è®ºå¦‚ä¸‹2ä¸ªç‰ˆæœ¬çš„æ–¹æ¡ˆ:</p><ol><li>åªä½¿ç”¨å•ä¸ªæ— ç¼“å†²ä¿¡é“é˜»å¡ä¸»çº¿</li><li>ä½¿ç”¨å®¹é‡ä¸ºgoroutinesæ•°é‡çš„ç¼“å†²ä¿¡é“</li></ol><p>å¯¹äºæ–¹æ¡ˆ1, ç¤ºä¾‹çš„ä»£ç å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">var quit chan int // åªå¼€ä¸€ä¸ªä¿¡é“</span><br><span class="line"></span><br><span class="line">func foo(id int) &#123;</span><br><span class="line">    fmt.Println(id)</span><br><span class="line">    quit &lt;- 0 // ok, finished</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    count := 1000</span><br><span class="line">    quit = make(chan int) // æ— ç¼“å†²</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; count; i++ &#123;</span><br><span class="line">        go foo(i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    for i := 0; i &lt; count; i++ &#123;</span><br><span class="line">        &lt;- quit</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºæ–¹æ¡ˆ2, æŠŠä¿¡é“æ¢æˆç¼“å†²1000çš„:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">quit = make(chan int, count) // å®¹é‡1000</span><br></pre></td></tr></table></figure><p>å…¶å®åŒºåˆ«ä»…ä»…åœ¨äºä¸€ä¸ªæ˜¯ç¼“å†²çš„ï¼Œä¸€ä¸ªæ˜¯éç¼“å†²çš„ã€‚</p><p>å¯¹äºè¿™ä¸ªåœºæ™¯è€Œè¨€ï¼Œä¸¤è€…éƒ½èƒ½å®Œæˆä»»åŠ¡, éƒ½æ˜¯å¯ä»¥çš„ã€‚</p><ul><li>æ— ç¼“å†²çš„ä¿¡é“æ˜¯ä¸€æ‰¹æ•°æ®ä¸€ä¸ªä¸€ä¸ªçš„ã€Œæµè¿›æµå‡ºã€</li><li>ç¼“å†²ä¿¡é“åˆ™æ˜¯ä¸€ä¸ªä¸€ä¸ªå­˜å‚¨ï¼Œç„¶åä¸€èµ·æµå‡ºå»</li></ul><hr>]]></content>
    
    <summary type="html">
    
      golangè¯­è¨€å¹¶å‘ä¸å¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>mysqlä¸­å­—æ®µåä¸ä¿ç•™å­—å†²çª</title>
    <link href="https://cloudsjhan.github.io/2018/12/04/mysql%E4%B8%AD%E5%AD%97%E6%AE%B5%E5%90%8D%E4%B8%8E%E4%BF%9D%E7%95%99%E5%AD%97%E5%86%B2%E7%AA%81/"/>
    <id>https://cloudsjhan.github.io/2018/12/04/mysqlä¸­å­—æ®µåä¸ä¿ç•™å­—å†²çª/</id>
    <published>2018-12-04T07:24:50.000Z</published>
    <updated>2018-12-04T07:51:27.453Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>åœ¨è®¾è®¡æ•°æ®åº“çš„æ—¶å€™ä¸å°å¿ƒå°†æ•°æ®åº“çš„å­—æ®µè®¾ç½®æˆäº†å…¶å†…ç½®çš„ä¿ç•™å­—ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¿™æ®µï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS `test_billing` (</span><br><span class="line">`vendor` varchar(255),</span><br><span class="line">`cn` varchar(255),</span><br><span class="line">`current_date` varchar(255),</span><br><span class="line">`cost` varchar(255)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><ul><li>è¿™æ ·ä½ åœ¨æ‰§è¡Œç±»ä¼¼ä¸‹é¢çš„æŸ¥è¯¢æ—¶ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select cn, cost from test_billing where current_date like&quot;2018-10%&quot;;</span><br></pre></td></tr></table></figure><p>è¿”å›å€¼ä¸­ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè¿˜å¸¦äº†ä¸€ä¸ªwarningï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Empty set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>åŸå› å°±æ˜¯å­—æ®µcurrent_dateä¸MySQLå†…ç½®çš„ä¿ç•™å­—å†²çªäº†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ä½ è¿˜æ€¥éœ€æŸ¥çœ‹è¿™äº›æ•°æ®ï¼Œæ¯”è¾ƒå¿«çš„æ–¹æ³•å°±æ˜¯ï¼šåœ¨å†²çªå­—æ®µä¸ŠåŠ åå¼•å· <code>current_date</code>,å³</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select cn, cost from test_billing where `current_date` like&quot;2018-10%&quot;;</span><br></pre></td></tr></table></figure><p>å°±å¯ä»¥è§£å†³äº†ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      ä¸å°å¿ƒå°†MySQLçš„å­—æ®µä¸ä¿ç•™å­—å†²çªçš„è§£å†³æ–¹æ³•
    
    </summary>
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>gitå¸¸ç”¨æ“ä½œ</title>
    <link href="https://cloudsjhan.github.io/2018/12/02/git%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C/"/>
    <id>https://cloudsjhan.github.io/2018/12/02/gitå¸¸ç”¨æ“ä½œ/</id>
    <published>2018-12-02T02:38:11.000Z</published>
    <updated>2018-12-02T02:40:20.339Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>é¦–å…ˆæ¥ä¸€éä»forkåˆ°pull requestè¿™ä¸ªè¿‡ç¨‹çš„åŸºç¡€æµç¨‹<br>é¦–å…ˆï¼Œfork ä¸€ä¸ªrepositoryï¼Œå®é™…ä¸Šæ˜¯å¤åˆ¶äº†ä¸€ä»½ repository åˆ°è‡ªå·±çš„ GitHub è´¦æˆ·ä¸‹ï¼Œç„¶åå°±å¯ä»¥ä» GitHub å°†å®ƒ clone åˆ°ä½ çš„ç”µè„‘ä¸Šï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><p>git clone <urlfromgithub><br>è¿æ¥åˆ°åŸå§‹çš„Repositoryï¼Œå› ä¸ºå¦‚æœåŸå§‹çš„Repositoryå†…å®¹æœ‰æ‰€æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿpullè¿™äº›å˜åŒ–ï¼Œæ‰€ä»¥æ–°å¢ä¸€ä¸ªè¿œç«¯é“¾æ¥ï¼Œå¹¶æŠŠå®ƒå‘½åä¸ºâ€™upstreamâ€™ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</urlfromgithub></p><p>git remote add upstream <urlfromupstreamgithub><br>æ–°å¢branchåˆ†æ”¯ï¼Œå¹¶é€‰ç”¨æ–°å¢åˆ†æ”¯ã€‚é¿å…ä¸ä¸»åˆ†æ”¯masteré€ æˆå†²çªï¼Œå½“æˆ‘ä»¬åœ¨æ–°å¢åˆ†æ”¯ä¸Šå®Œæˆäº†è‡ªå·±çš„åŠŸèƒ½åå†åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</urlfromupstreamgithub></p><p>git branch <branchname><br>git checkout <branchname><br>git checkout -b <branchname> â€“åˆ›å»ºæ–°çš„åˆ†æ”¯å¹¶åˆ‡æ¢åˆ°æ–°çš„åˆ†æ”¯ä¸Š<br>è®°å½•ï¼Œåœ¨æˆ‘ä»¬è‡ªå·±çš„åˆ†æ”¯ä¸Šä¿®æ”¹åï¼Œéœ€è¦è®°å½•ä¸‹æ¥ã€‚</branchname></branchname></branchname></p><p>git status â€“æŸ¥çœ‹å½“å‰çŠ¶æ€<br>git add -A â€“è®°å½•ä¿®æ”¹æ–‡ä»¶ï¼ŒåŠ ä¸Š -Aï¼Œæœƒå°‡æ–°å¢æª”æ¡ˆè·Ÿåˆªé™¤æª”æ¡ˆçš„å‹•ä½œä¸€èµ·è¨˜éŒ„ä¸‹ä¾†<br>git commit -m â€œadd a fileâ€ â€“æäº¤å…¨éƒ¨ä¿®æ”¹<br>git checkout master â€“ç¬¬äºŒå¤©å¼€å§‹å·¥ä½œå‰ï¼Œåˆ‡æ¢åˆ°masteråˆ†æ”¯<br>git pull origin master â€“ä»masterçš„è¿œç¨‹åˆ†æ”¯æ‹‰å–ä»£ç <br>git checkout <branchname> â€“åˆ‡æ¢åˆ°taskæ‰€åœ¨çš„æœ¬åœ°åˆ†æ”¯<br>git rebase -i master â€“å°†masterä¸Šçš„æœ€æ–°çš„ä»£ç åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ä¸Šï¼Œè¿™é‡Œçš„-içš„ä½œç”¨æ˜¯å°†æˆ‘ä»¬ å½“å‰åˆ†æ”¯ä¹‹å‰çš„commitå‹ç¼©æˆä¸ºä¸€ä¸ªcommitï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºå½“æˆ‘ä»¬ä¹‹ååˆ›å»ºpull requestå¹¶è¿›è¡Œç›¸åº”çš„code reviewçš„æ—¶å€™ï¼Œä»£ç çš„æ”¹åŠ¨ä¼šé›†ä¸­åœ¨ä¸€ä¸ªcommitï¼Œä½¿å¾—code reviewæ›´ç›´è§‚æ–¹ä¾¿<br>git push â€“set-upstream origin <my branch="" name=""> â€“æœ€åï¼Œå½“taskçš„æ‰€æœ‰ç¼–ç å®Œæˆä¹‹åï¼Œå°†ä»£ç pushåˆ°è¿œç¨‹åˆ†æ”¯<br>å…ˆè·å–è¿œç«¯ï¼Œå†æäº¤ï¼Œæ¯æ¬¡æäº¤ä»£ç å‰ï¼Œéƒ½éœ€è¦å…ˆè·å–æœ€æ–°ä»£ç ï¼Œé˜²æ­¢è¦†ç›–ä»–äººä»£ç </my></branchname></p><p>git fetch â€“dry-run â€“æ£€æŸ¥è¿œç«¯æ˜¯å¦æœ‰å˜åŠ¨<br>git pull â€“ä»è¿œç«¯åˆ†æ”¯æ›´æ–°æœ€æ–°ä»£ç <br>å»ºç«‹Pull Requestsï¼Œè¿›å…¥ä½ çš„githubé¡¹ç›®é¡µï¼Œä¸€èˆ¬æƒ…å†µä¸‹ GitHubä¼šæ£€æµ‹åˆ°ä½ æœ‰äº†æ–°çš„æ¨é€ï¼Œä¼šä¸»åŠ¨æç¤ºä½ ï¼Œç‚¹å‡»Create pull requestï¼Œå†™ä¸Šè¯´æ˜ï¼Œå†æŒ‰Send pull requestå°±å®Œæˆäº†ï¼Œå¦‚æœ Pull Request æ²’æœ‰é—®é¢˜çš„è¯ï¼Œå¾ˆå¿«å°±æœƒè¢«è‡ªåŠ¨åˆå¹¶ merged äº†å“¦ï¼</p><p>æœ¬åœ°åˆå¹¶åˆ†æ”¯ï¼Œå¹¶åˆ é™¤åˆ†æ”¯ï¼Œå°†åˆ†æ”¯åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¸Šï¼Œå¹¶åˆ é™¤ä¹‹</p><p>git checkout master â€“é¦–å…ˆåˆ‡æ¢åˆ°ä¸»åˆ†æ”¯ä¸­<br>git merge <branchname> â€“åˆå¹¶å¦ä¸€ä¸ªåˆ†æ”¯è¿›æ¥<br>git branch -d <branchname> â€“åˆ æ‰åˆšåˆšåˆå¹¶çš„åˆ†æ”¯<br>git push <remotename> â€“delete <branchname> â€“ä¹Ÿå¯ä»¥æŠŠåˆå¹¶åˆ†æ”¯ä»GitHubä¸Šçš„å‰¯æœ¬repositoryä¸­åˆªé™¤<br>å…¶ä»–å¸¸ç”¨å‘½ä»¤<br>git init â€“å°†ä¸€ä¸ªæ–‡ä»¶å¤¹åˆå§‹åŒ–ä¸ºgitä»“åº“<br>git status â€“æ£€æŸ¥å½“å‰repositoryä¸­çš„ä¿®æ”¹<br>git diff â€“æŸ¥çœ‹å¯¹æ–‡ä»¶çš„ä¿®æ”¹<br>git add <filename> â€“å‡†å¤‡æäº¤å¯¹äºä¸€ä¸ªæ–‡ä»¶çš„ä¿®æ”¹<br>git add . â€“å‡†å¤‡æäº¤å¯¹æ‰€æœ‰æ–‡ä»¶çš„ä¿®æ”¹<br>git commit -m â€œ<your commit="" message="">â€œ â€“æäº¤ä½ æ‰€å‡†å¤‡å¥½çš„ä¿®æ”¹ï¼Œå¹¶é™„ä¸Šç®€çŸ­è¯´æ˜<br>git config â€“global user.username <username> â€“é…ç½®githubè´¦å·<br>git remote add <remotename> â€“æ–°å¢è¿œç«¯é“¾æ¥<br>git remote set-url <remotename> â€“å¯¹ä¸€ä¸ªè¿œç«¯è®¾å®šåœ°å€<br>git remote add <remotename> <url> â€“æ–°å¢å¸¦åœ°å€çš„è¿œç«¯é“¾æ¥<br>git remote -v â€“æŸ¥çœ‹æ‰€æœ‰è¿œç«¯<br>git pull <remotename> <branchname> â€“ä»ä¸€ä¸ªè¿œç«¯æ”¶å–æ›´æ–°ï¼ˆé»˜è®¤ä¸ºä¸»åˆ†æ”¯ï¼‰<br>git push <remotename> <branchname> â€“æäº¤ä»£ç åˆ°æŒ‡å®šè¿œç«¯ï¼ˆé»˜è®¤ä¸ºä¸»åˆ†æ”¯ï¼‰<br>git branch -M <newbranchname> â€“ä¿®æ”¹å½“å‰åˆ†æ”¯åå­—<br>git branch â€“åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯</newbranchname></branchname></remotename></branchname></remotename></url></remotename></remotename></remotename></username></your></filename></branchname></remotename></branchname></branchname></p><hr>]]></content>
    
    <summary type="html">
    
      gitå¸¸ç”¨åŸºæœ¬æ“ä½œ
    
    </summary>
    
      <category term="git" scheme="https://cloudsjhan.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://cloudsjhan.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>ionic project-Could not find module @angular-devkit/build-angular from XXX</title>
    <link href="https://cloudsjhan.github.io/2018/11/30/ionic-project-Could-not-find-module-angular-devkit-build-angular-from-XXX/"/>
    <id>https://cloudsjhan.github.io/2018/11/30/ionic-project-Could-not-find-module-angular-devkit-build-angular-from-XXX/</id>
    <published>2018-11-30T14:02:49.000Z</published>
    <updated>2018-11-30T14:45:25.088Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li><p>ä»GitHubä¸Šæ‰¾äº†ä¸€ä¸ªionicçš„demoï¼Œå‡†å¤‡è¿è¡Œä¸€ä¸‹ï¼ŒæŠ¥é”™ï¼šCould not find module @angular-devkit/build-angular from XXX</p></li><li><p>æ“ä½œæ­¥éª¤ï¼š</p><ul><li><p>git clone <a href="https://github.com/ionic-team/ionic-conference-app.git" target="_blank" rel="noopener">https://github.com/ionic-team/ionic-conference-app.git</a></p></li><li><p>ionic serve</p></li><li><p>æŠ¥é”™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could not find module &quot;@angular-devkit/build-angular&quot; from</span><br></pre></td></tr></table></figure><p>è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>npm install â€“save @angular-devkit/build-angular</li></ul></li></ul></li></ul><hr>]]></content>
    
    <summary type="html">
    
      ionic project-Could not find module @angular-devkit/build-angular from XXX
    
    </summary>
    
      <category term="frontEnd" scheme="https://cloudsjhan.github.io/categories/frontEnd/"/>
    
    
      <category term="angular" scheme="https://cloudsjhan.github.io/tags/angular/"/>
    
      <category term="ionic" scheme="https://cloudsjhan.github.io/tags/ionic/"/>
    
  </entry>
  
  <entry>
    <title>å¿«æ’ä¹‹golangå®ç°</title>
    <link href="https://cloudsjhan.github.io/2018/11/18/%E5%BF%AB%E6%8E%92%E4%B9%8Bgolang%E5%AE%9E%E7%8E%B0/"/>
    <id>https://cloudsjhan.github.io/2018/11/18/å¿«æ’ä¹‹golangå®ç°/</id>
    <published>2018-11-18T06:36:38.000Z</published>
    <updated>2018-11-19T02:09:59.522Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>å¿«é€Ÿæ’åºç”±C. A. R. Hoareåœ¨1962å¹´æå‡ºã€‚å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šé€šè¿‡ä¸€è¶Ÿæ’åºå°†è¦æ’åºçš„æ•°æ®åˆ†å‰²æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½æ¯”å¦å¤–ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½è¦å°ï¼Œç„¶åå†æŒ‰æ­¤æ–¹æ³•å¯¹è¿™ä¸¤éƒ¨åˆ†æ•°æ®åˆ†åˆ«è¿›è¡Œå¿«é€Ÿæ’åºï¼Œæ•´ä¸ªæ’åºè¿‡ç¨‹å¯ä»¥é€’å½’è¿›è¡Œï¼Œä»¥æ­¤è¾¾åˆ°æ•´ä¸ªæ•°æ®å˜æˆæœ‰åºåºåˆ—ã€‚</li></ul><p>åˆ©ç”¨åˆ†æ²»æ³•å¯å°†å¿«é€Ÿæ’åºçš„åˆ†ä¸ºä¸‰æ­¥ï¼š</p><ul><li>åœ¨æ•°æ®é›†ä¹‹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå…ƒç´ ä½œä¸ºâ€åŸºå‡†â€ï¼ˆpivotï¼‰ã€‚</li><li>æ‰€æœ‰å°äºâ€åŸºå‡†â€çš„å…ƒç´ ï¼Œéƒ½ç§»åˆ°â€åŸºå‡†â€çš„å·¦è¾¹ï¼›æ‰€æœ‰å¤§äºâ€åŸºå‡†â€çš„å…ƒç´ ï¼Œéƒ½ç§»åˆ°â€åŸºå‡†â€çš„å³è¾¹ã€‚è¿™ä¸ªæ“ä½œç§°ä¸ºåˆ†åŒº (partition) æ“ä½œï¼Œåˆ†åŒºæ“ä½œç»“æŸåï¼ŒåŸºå‡†å…ƒç´ æ‰€å¤„çš„ä½ç½®å°±æ˜¯æœ€ç»ˆæ’åºåå®ƒçš„ä½ç½®ã€‚</li><li>å¯¹â€åŸºå‡†â€å·¦è¾¹å’Œå³è¾¹çš„ä¸¤ä¸ªå­é›†ï¼Œä¸æ–­é‡å¤ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ‰€æœ‰å­é›†åªå‰©ä¸‹ä¸€ä¸ªå…ƒç´ ä¸ºæ­¢ã€‚</li></ul><p>å¿«é€Ÿæ’åºå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º<code>O(n log n)</code>,æœ€åæƒ…å†µä¸º<code>O(n2)</code>ï¼Œä¸ç¨³å®šæ’åºã€‚</p><p>è¿™é‡Œå®ç°äº†ä¸¤ç§æ–¹å¼çš„å¿«æ’ï¼Œç¬¬ä¸€ç§æ˜¯å•è·¯çš„ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">partition</span><span class="params">(sortArray []<span class="keyword">int</span>, left, right <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">key := sortArray[right]</span><br><span class="line">i := left - <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j := left; j &lt; right; j++ &#123;</span><br><span class="line"><span class="keyword">if</span> sortArray[j] &lt;= key &#123;</span><br><span class="line">i++</span><br><span class="line">swap(i, j)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">swap(i+<span class="number">1</span>, right)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i + <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒç§æ˜¯åŒè·¯çš„ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">unc partition2(arr []<span class="keyword">int</span>,left,right <span class="keyword">int</span>)(p <span class="keyword">int</span>)  &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> left &gt; right &#123;</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">i,j,pivot := left,right ,arr[left]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i&lt;j  &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i &lt; j &amp;&amp; arr[j] &gt;pivot  &#123;</span><br><span class="line">j--</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i &lt; j &amp;&amp; arr[i] &lt;= pivot  &#123;</span><br><span class="line">i++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> i &lt; j &#123;</span><br><span class="line">arr[i] ,arr[j] = arr[j],arr[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">arr[i],arr[left] = arr[left],arr[i]</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> i</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (<span class="string">"fmt"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> MAX = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> sortArray = []<span class="keyword">int</span>&#123;<span class="number">41</span>, <span class="number">24</span>, <span class="number">76</span>, <span class="number">11</span>, <span class="number">45</span>, <span class="number">64</span>, <span class="number">21</span>, <span class="number">69</span>, <span class="number">19</span>, <span class="number">36</span>&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"before sortï¼š"</span>)</span><br><span class="line"></span><br><span class="line">quickSort(sortArray, <span class="number">0</span>, MAX<span class="number">-1</span>)</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"after sort:"</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">quickSort</span><span class="params">(sortArray []<span class="keyword">int</span>, left, right <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line"><span class="keyword">if</span> left &lt; right &#123;</span><br><span class="line">pos := partition2(sortArray, left, right)<span class="comment">//ä¿®æ”¹æ­¤å¤„æµ‹è¯•ä¸åŒçš„å®ç°æ–¹å¼</span></span><br><span class="line">quickSort(sortArray, left, pos<span class="number">-1</span>)</span><br><span class="line">quickSort(sortArray, pos+<span class="number">1</span>, right)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>BUT!</p><p>è¦è¡¨è¾¾å¿«æ’çš„æ€æƒ³ï¼Œè¿˜æ˜¯ä½¿ç”¨Pythonæ¯”è¾ƒé€å½»ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">quickSort</span><span class="params">(array)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> len(array) &lt; <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> array</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pivot = array[<span class="number">0</span>]</span><br><span class="line">        less = [i <span class="keyword">for</span> i <span class="keyword">in</span> array[<span class="number">1</span>:] <span class="keyword">if</span> i &lt;= pivot]</span><br><span class="line">        greater = [i <span class="keyword">for</span> i <span class="keyword">in</span> array[<span class="number">1</span>:] <span class="keyword">if</span> i &gt; pivot]</span><br><span class="line">    <span class="keyword">return</span> quickSort(less) + [pivot] + quickSort(greater)</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯å°†å¿«æ’çš„åˆ†æ²»æ€æƒ³è¡¨è¾¾åœ°æ·‹æ¼“å°½è‡´ï¼Œç®€æ´ç¾è§‚ã€‚</p><p>â€‹                                        </p><p>â€‹                                    Endï¼</p><hr>]]></content>
    
    <summary type="html">
    
      å¿«é€Ÿæ’åºçš„goå®ç°
    
    </summary>
    
      <category term="æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="https://cloudsjhan.github.io/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
    
      <category term="go æ•°æ®ç»“æ„ä¸ç®—æ³•" scheme="https://cloudsjhan.github.io/tags/go-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/"/>
    
  </entry>
  
  <entry>
    <title>gitå¦‚ä½•æ‰¾å›è¢«åˆ é™¤çš„åˆ†æ”¯</title>
    <link href="https://cloudsjhan.github.io/2018/11/15/git%E5%A6%82%E4%BD%95%E6%89%BE%E5%9B%9E%E8%A2%AB%E5%88%A0%E9%99%A4%E7%9A%84%E5%88%86%E6%94%AF/"/>
    <id>https://cloudsjhan.github.io/2018/11/15/gitå¦‚ä½•æ‰¾å›è¢«åˆ é™¤çš„åˆ†æ”¯/</id>
    <published>2018-11-15T10:37:28.000Z</published>
    <updated>2018-11-15T10:39:44.797Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>åœ¨ä½¿ç”¨gitçš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºäººä¸ºå› ç´ é€ æˆåˆ†æ”¯ï¼ˆcommit)è¢«åˆ é™¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ¢å¤ã€‚</p><p>é¦–å…ˆç”¨ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œä¿®æ”¹ä¸€äº›æ–‡ä»¶ååˆ é™¤ï¼Œä»¥ä¾¿è¿›è¡Œæ¢å¤ã€‚<br>1.åˆ›å»ºåˆ†æ”¯ abc</p><p>git branch abc<br>1</p><p>2.æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨</p><p>git branch -a<br>  abc</p><ul><li>develop<br>remotes/origin-dev/develop<br>1<br>2<br>3<br>4</li></ul><p>3.åˆ‡æ¢åˆ°abcåˆ†æ”¯ï¼Œéšä¾¿ä¿®æ”¹ä¸€ä¸‹ä¸œè¥¿å commit</p><p>åˆ‡æ¢åˆ†æ”¯<br>git checkout abc<br>Switched to branch â€˜abcâ€™</p><p>åˆ›å»ºä¸€ä¸ªæ–‡ä»¶<br>echo â€˜abcâ€™ &gt; test.txt</p><p>commit<br>git add .<br>git commit -m â€˜add test.txtâ€™<br>[abc 3eac14d] add test.txt<br> 1 file changed, 1 insertion(+)<br> create mode 100644 test.txt<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13</p><p>4.åˆ é™¤åˆ†æ”¯abc</p><p>git branch -D abc<br>Deleted branch abc (was 3eac14d).<br>1<br>2</p><p>5.æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨ï¼Œabcåˆ†æ”¯å·²ä¸å­˜åœ¨</p><p>git branch -a</p><ul><li>develop<br>remotes/origin-dev/develop<br>1<br>2<br>3</li></ul><p>æ¢å¤æ­¥éª¤å¦‚ä¸‹ï¼š<br>1.ä½¿ç”¨git log -g æ‰¾å›ä¹‹å‰æäº¤çš„commit<br>commit 3eac14d05bc1264cda54a7c21f04c3892f32406a<br>Reflog: HEAD@{1} (fdipzone <a href="mailto:&#102;&#x64;&#105;&#x70;&#x7a;&#111;&#110;&#x65;&#x40;&#x73;&#x69;&#110;&#x61;&#x2e;&#x63;&#111;&#x6d;" target="_blank" rel="noopener">&#102;&#x64;&#105;&#x70;&#x7a;&#111;&#110;&#x65;&#x40;&#x73;&#x69;&#110;&#x61;&#x2e;&#x63;&#111;&#x6d;</a>)<br>Reflog message: commit: add test.txt<br>Author: fdipzone <a href="mailto:&#x66;&#100;&#x69;&#112;&#122;&#x6f;&#110;&#x65;&#64;&#x73;&#x69;&#x6e;&#x61;&#46;&#99;&#x6f;&#109;" target="_blank" rel="noopener">&#x66;&#100;&#x69;&#112;&#122;&#x6f;&#110;&#x65;&#64;&#x73;&#x69;&#x6e;&#x61;&#46;&#99;&#x6f;&#109;</a><br>Date:   Sun Jan 31 22:26:33 2016 +0800</p><pre><code>add test.txt</code></pre><p>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9</p><p>2.ä½¿ç”¨git branch recover_branch[æ–°åˆ†æ”¯] commit_idå‘½ä»¤ç”¨è¿™ä¸ªcommitåˆ›å»ºä¸€ä¸ªåˆ†æ”¯<br>git branch recover_branch_abc 3eac14d05bc1264cda54a7c21f04c3892f32406a</p><p>git branch -a</p><ul><li>develop<br>recover_branch_abc<br>remotes/origin-dev/develop<br>1<br>2<br>3<br>4<br>5<br>6<br>å¯ä»¥è§åˆ°recover_branch_abcå·²åˆ›å»º </li></ul><p>3.åˆ‡æ¢åˆ°recover_branch_abcåˆ†æ”¯ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨<br>git checkout recover_branch_abc<br>Switched to branch â€˜recover_branch_abcâ€™</p><p>ls -lt<br>total 8<br>-rw-râ€“râ€“   1 fdipzone  staff     4  1 31 22:38 test.txt<br>1<br>2<br>3<br>4<br>5<br>6</p><h2 id="è¿™æ ·å°±å¯ä»¥æ¢å¤è¢«è¯¯åˆ çš„åˆ†æ”¯äº†"><a href="#è¿™æ ·å°±å¯ä»¥æ¢å¤è¢«è¯¯åˆ çš„åˆ†æ”¯äº†" class="headerlink" title="è¿™æ ·å°±å¯ä»¥æ¢å¤è¢«è¯¯åˆ çš„åˆ†æ”¯äº†"></a>è¿™æ ·å°±å¯ä»¥æ¢å¤è¢«è¯¯åˆ çš„åˆ†æ”¯äº†</h2><p>åŸæ–‡ï¼š<a href="https://blog.csdn.net/fdipzone/article/details/50616386" target="_blank" rel="noopener">https://blog.csdn.net/fdipzone/article/details/50616386</a><br>ç‰ˆæƒå£°æ˜ï¼šæœ¬æ–‡ä¸ºåšä¸»åŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·é™„ä¸Šåšæ–‡é“¾æ¥ï¼</p><hr>]]></content>
    
    <summary type="html">
    
      gitæ‰¾å›è¢«åˆ é™¤çš„åˆ†æ”¯
    
    </summary>
    
      <category term="git" scheme="https://cloudsjhan.github.io/categories/git/"/>
    
    
      <category term="git" scheme="https://cloudsjhan.github.io/tags/git/"/>
    
  </entry>
  
  <entry>
    <title>golangè¯»å–å‘½ä»¤è¡Œä¼ æ¥çš„å‚æ•°</title>
    <link href="https://cloudsjhan.github.io/2018/11/06/golang%E8%AF%BB%E5%8F%96%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BC%A0%E6%9D%A5%E7%9A%84%E5%8F%82%E6%95%B0/"/>
    <id>https://cloudsjhan.github.io/2018/11/06/golangè¯»å–å‘½ä»¤è¡Œä¼ æ¥çš„å‚æ•°/</id>
    <published>2018-11-06T06:59:04.000Z</published>
    <updated>2018-11-06T07:13:58.650Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h1 id="Golang-ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°"><a href="#Golang-ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°" class="headerlink" title="Golang-ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°"></a>Golang-ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°</h1><p>Golangæœ‰ä¸¤ä¸ªæ ‡å‡†åŒ…ä¸­éƒ½æœ‰è·å¾—å‘½ä»¤è¡Œå‚æ•°çš„æ–¹æ³•ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[*]os/Argså¯ä»¥ç®€å•åœ°è·å¾—ä¸€ä¸ªç±»ä¼¼ï¼£è¯­è¨€ä¸­çš„argvç»“æ„</span><br><span class="line">[*]flagåˆ™æä¾›äº†ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„æ ‡å¿—ä¸å€¼çš„æ–¹æ³•</span><br></pre></td></tr></table></figure><p>os.Argsos.Argsè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„[] string.</p><p>ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼špackage main</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    fmt.Println(os.Args)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤ï¼šgo run test.go arg1 arg2</p><p>å¯è§è¿”å›äº†ä¸€ä¸ªä¸‰ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œç¬¬ï¼ä¸ªå…ƒç´ æ˜¯ç¨‹åºçš„åå­—åŒ…æ‹¬è·¯å¾„ï¼Œos.Argså°±ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œos.Argså°±æ˜¯ç¬¬äºŒä¸ªå‚æ•°ã€‚</p><hr><p>flagåŒ…flagåŒ…æä¾›çš„åŠŸèƒ½éå¸¸å¤æ‚ã€‚</p><p>å®ƒå°†å‘½ä»¤è¡Œå‚æ•°åˆ†ä¸ºéæ ‡å¿—ç±»å‚æ•°(nonflag arguments)å’ŒFlagsï¼Œæ ‡å¿—å‚æ•°æ˜¯è¿™æ ·çš„-flagname=xï¼Œæ¯”å¦‚è¯´-baudrate=1200ã€‚</p><p>éæ ‡å¿—ç±»å‚æ•°ä¸ºarg1 arg2ã€‚</p><p>flagå‚æ•°å¤„ç†æµç¨‹ç”±äºæ ‡å¿—ç±»å‚æ•°æ˜¯å‚æ•°çš„ä¸€éƒ¨åˆ†ï¼Œä½†åˆç‰¹æ®Šï¼Œä¸ºäº†å°†æ ‡å¿—ç±»å‚æ•°åŒºåˆ«å¤„ç†</p><p>flagåŒ…æœ‰ä¸¤ç±»æ–¹æ³•ï¼Œä¸€ç±»æ˜¯flagå¤„ç†æ–¹æ³•ï¼Œå¦ä¸€ç±»æ˜¯æ­£å¸¸çš„å‚æ•°å¤„ç†æ–¹æ³•ã€‚</p><p>æ­£å¸¸çš„å‚æ•°å¤„ç†æ–¹æ³•æ­£å¸¸å‚æ•°å¤„ç†æ–¹æ³•ä¸os.Argså·®ä¸å¤šï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œflag.Args()ï¼Œè¿”å›ä¹Ÿæ˜¯[]string.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">/*    &quot;os/exec&quot;</span><br><span class="line">    &quot;bytes&quot;*/</span><br><span class="line">    &quot;flag&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    flag.Parse()</span><br><span class="line">    fmt.Println(flag.Args())</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">go run test.go arg1 arg2</span><br></pre></td></tr></table></figure><p>å¦‚æœæœ‰æ ‡å¿—ç±»å‚æ•°å‘¢ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run test.go arg1 arg2ã€€-baudrate=1200</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå……åˆ†è¯æ˜äº†æ ‡å¿—ç±»å‚æ•°ä¹Ÿæ˜¯å‚æ•°ã€‚</p><p>æ ‡å¿—ç±»å‚æ•°Parseå‰å®šä¹‰å¦‚æœä½¿ç”¨æ ‡å¿—ç±»å‚æ•°ï¼Œè¦æå‰å®šä¹‰,å®šä¹‰ä¹‹åå†è°ƒç”¨Parseæ‰èƒ½è§£æå‡ºæ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;flag&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;)</span><br><span class="line">    databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;)</span><br><span class="line">    flag.Parse()</span><br><span class="line">    fmt.Println(*baudrate)</span><br><span class="line">    fmt.Println(*databits)</span><br><span class="line">    fmt.Println(flag.Args())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go run test.go -baudrate=9600 -databits=8 arg1 arg2</span><br></pre></td></tr></table></figure><p>æ ‡å¿—ç±»å‚æ•°å¿…é¡»åœ¨Parseä¹‹å®šä¹‰ï¼Œå¦åˆ™ä¼šå‡ºé”™ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;flag&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    flag.Parse()</span><br><span class="line">    baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;)</span><br><span class="line">    databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;)</span><br><span class="line">    fmt.Println(*baudrate)</span><br><span class="line">    fmt.Println(*databits)</span><br><span class="line">    fmt.Println(flag.Args())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go run test.go -baudrate=9600 -databits=8 arg1 arg2</span><br><span class="line"></span><br><span class="line">flag provided but not defined: -baudrate</span><br><span class="line"></span><br><span class="line">Usage of /tmp/go-build944578075/command-line-arguments/_obj/a.out:</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure><p>flag.Intè¿”å›çš„æ˜¯åœ°å€</p><p>éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œflag.Intè¿”å›çš„å€¼ä¸ºä¸€ä¸ªåœ°å€ï¼Œä½ å¯ä»¥éšæ—¶åˆ°è¿™ä¸ªåœ°å€é‡Œå»å–å€¼</p><p>ä½†åœ¨Parseä¹‹å‰å–å€¼ï¼Œå–åˆ°çš„æ˜¯é»˜è®¤å€¼ï¼ŒParseä¹‹åå»éšå€¼ï¼Œå–åˆ°çš„æ‰æ˜¯çœŸæ­£çš„å€¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;flag&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;)</span><br><span class="line">    databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;)</span><br><span class="line"></span><br><span class="line">    fmt.Println(*baudrate)</span><br><span class="line">    fmt.Println(*databits)</span><br><span class="line">    flag.Parse()</span><br><span class="line">    fmt.Println(flag.Args())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go run test.go -baudrate=9600 -databits=8 arg1 arg2</span><br></pre></td></tr></table></figure><p>æ ‡å¿—ç±»å‚æ•°é¡ºåº</p><p>æ ‡å¿—ç±»å‚æ•°ä¹‹é—´çš„å‰åé¡ºåºå¯ä»¥æ”¹å˜ï¼Œä½†æ˜¯ä¼¼ä¹æ ‡å¿—ç±»å‚æ•°éè¦æ”¾åˆ°éæ ‡å¿—ç±»å‚æ•°ä¹‹å‰æ‰èƒ½æ­£ç¡®è§£æã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;flag&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;)</span><br><span class="line">    baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;)</span><br><span class="line">    flag.Parse()</span><br><span class="line">    fmt.Println(*baudrate)</span><br><span class="line">    fmt.Println(*databits)</span><br><span class="line">    fmt.Println(flag.Args())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">go run test.go -baudrate=9600 -databits=8 arg1 arg2</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å‘½ä»¤æ­£ç¡®è§£æäº†ï¼Œè°ƒæ¢äº†baudrateå’Œdatabitsçš„é¡ºåº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run test.go arg1 -baudrate=9600 -databits=8  arg2</span><br></pre></td></tr></table></figure><p>ä¸Šå‰è¿™é‡Œæ²¡èƒ½æ­£ç¡®è§£æï¼Œå¯ä»¥baudrateå’Œdatabitså¾—åˆ°çš„è¿˜æ˜¯é»˜è®¤å€¼ï¼Œè€Œéæ ‡å¿—ç±»å‚æ•°è·å–åˆ°äº†æ‰€æœ‰çš„å‚æ•°ã€‚</p><p>â€“help</p><p>flag.Intçš„æœ€åä¸€ä¸ªå‚æ•°æ˜¯helpä¿¡æ¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">go run test.go --help</span><br><span class="line"></span><br><span class="line">Usage of /tmp/go-build327358548/command-line-arguments/_obj/a.out:</span><br><span class="line">  -baudrate=1200: help message for flagname</span><br><span class="line">  -databits=10: number of data bits</span><br><span class="line">exit status 2</span><br></pre></td></tr></table></figure><p>flag.Stringä¼ å…¥çš„å‚æ•°æ˜¾ç„¶ä¸èƒ½éƒ½æ˜¯æ•°å­—ï¼Œå®é™…goè¯­è¨€æä¾›çš„ç±»å‹éƒ½æ”¯æŒï¼Œä¸flag.Intç±»ä¼¼ï¼Œæ‰€æœ‰å…¶ä»–å‡½æ•°éƒ½æœ‰ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flag.String flag.Uint flag.Float64....</span><br></pre></td></tr></table></figure><p>flag.IntVarflag.Intè¿”å›çš„æ˜¯æŒ‡é’ˆï¼Œç”¨èµ·æ¥å¯ä»¥æœ‰ç‚¹ä¸å¤ªå¥½ï¼Œflag.IntVarå¯èƒ½ç”¨èµ·æ¥æ›´å¥½çš„äº›ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var baudrate int</span><br><span class="line">flag.IntVar(&amp;baudrate,&quot;baudrate&quot;,1200,&quot;baudrate of serial port&quot;)</span><br><span class="line">flag.Parse()</span><br><span class="line">fmt.Println(baudrate)</span><br></pre></td></tr></table></figure><p>å½“å‰ä½ ä¸€æ ·å¯ä»¥ç”¨flag.UintVar flag.Float64Var flag.StringVar</p><p>å‚æ•°ä¸ªæ•°å‚æ•°ä¸ªæ•°ä¹Ÿåˆ†ä¸ºæ ‡å¿—ç±»å‚æ•°çš„éæ ‡å¿—ç±»å‚æ•°ï¼Œä¸¤ä¸ªæ–¹æ³•ä¸ºNArgå’ŒNFlag,</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">    <span class="string">"flag"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    databits:=flag.Int(<span class="string">"databits"</span>,<span class="number">10</span>,<span class="string">"number of data bits"</span>)</span><br><span class="line">    baudrate:=flag.Int(<span class="string">"baudrate"</span>,<span class="number">1200</span>, <span class="string">"help message for flagname"</span>)</span><br><span class="line">    flag.Parse()</span><br><span class="line">    fmt.Println(*baudrate)</span><br><span class="line">    fmt.Println(*databits)</span><br><span class="line">    fmt.Println(flag.Args())</span><br><span class="line">    fmt.Println(flag.NArg())</span><br><span class="line">    fmt.Println(flag.NFlag())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> run test.<span class="keyword">go</span> -baudrate=<span class="number">9600</span> -databits=<span class="number">8</span> arg1 arg2</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä»£ç çš„æ‰§è¡Œçš„è¿‡ç¨‹ä»¥åŠæ‰§è¡Œç»“æœæ˜¯ï¼š</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwgy1fwycwsdqmrj31ks09iq3t.jpg" alt=""></p><p>ä»ä¸Šåˆ°ä¸‹æ‰“å°å‡ºçš„å‚æ•°å«ä¹‰åˆ†åˆ«æ˜¯ï¼š</p><p>1111ï¼šæŒ‡å®šçš„æ ‡å¿—ç±»å‚æ•°baudrateï¼Œé»˜è®¤å€¼æ˜¯1200ï¼Œå¯éšæ„æ›´æ”¹ï¼›</p><p>1011ï¼š æŒ‡å®šçš„æ ‡å¿—ç±»å‚æ•°databitsï¼Œé»˜è®¤å€¼æ˜¯10ï¼Œå¯éšæ„æ›´æ”¹ï¼›</p><p>[la, la]:éæ ‡å¿—ç±»å‚æ•°ä¸ºarg1 arg2ï¼›</p><p>2ï¼šéæ ‡å¿—ç±»å‚æ•°çš„æ•°é‡</p><p>2ï¼šæ ‡å¿—ç±»å‚æ•°çš„æ•°é‡</p><p>â€‹                                                          The End!</p><hr>]]></content>
    
    <summary type="html">
    
      golangä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
  </entry>
  
  <entry>
    <title>MySQLä½¿ç”¨group byåˆ†ç»„åå¯¹æ¯ç»„æ“ä½œ</title>
    <link href="https://cloudsjhan.github.io/2018/11/05/MySQL%E4%BD%BF%E7%94%A8group-by%E5%88%86%E7%BB%84%E5%90%8E%E5%AF%B9%E6%AF%8F%E7%BB%84%E6%93%8D%E4%BD%9C/"/>
    <id>https://cloudsjhan.github.io/2018/11/05/MySQLä½¿ç”¨group-byåˆ†ç»„åå¯¹æ¯ç»„æ“ä½œ/</id>
    <published>2018-11-05T08:54:14.000Z</published>
    <updated>2018-11-06T02:07:42.708Z</updated>
    
    <content type="html"><![CDATA[<p></p><p class="description"></p><br><a id="more"></a><p></p><h2 id="group-by-æ“ä½œ"><a href="#group-by-æ“ä½œ" class="headerlink" title="group by æ“ä½œ"></a>group by æ“ä½œ</h2><ul><li><p>åˆ†ç»„èƒ½å¤Ÿå°†æ•°æ®åˆ†æˆå‡ ä¸ªé€»è¾‘ç»„ï¼Œç„¶åå¯¹å…¶è¿›è¡Œèšé›†æ“ä½œ</p></li><li><p>å‰å‡ å¤©å¼€å‘çš„æ—¶å€™é‡åˆ°è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰ä¸€ä¸ªvender-costè¡¨ï¼š</p></li></ul><p>mysql&gt; select * from vendor-cost;<br>+â€”â€”â€”+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€“+â€”â€”â€”â€“+â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”-+</p><table><thead><tr><th>vendor</th><th>host</th><th>vendor_id</th><th>start_date</th><th>cost</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td></tr></tbody></table><p>+â€”â€”â€”+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€“+â€”â€”â€”â€“+â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”-+<br>| Tencent | ins-m9faipc4 | 100014390 | 2018-10 | 0.015456 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>| Tencent | ins-r76jxurv | 100015923 | 2018-10 | 0.284697 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>| Tencent | ins-ramdkuqz | 100015923 | 2018-10 | 0.021175 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>| Tencent | ins-q7o1dhsa | 100014390 | 2018-10 | 0.113501 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>| Tencent | ins-5xxrgd65 | 100015923 | 2018-10 | 0.058623 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>| Tencent | ins-79g28kn6 | 100015923 | 2018-10 | 0.03808 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”- |<br>|         |              |           |         |         |<br>| Tencent | ins-rw54ka4k | 100015923 | 2018-10 | 0.150595 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>| Tencent | ins-ggxrtm1v | 100015923 | 2018-10 | 0.068281 |<br>| â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ |<br>|         |              |           |         |          |<br>ä¸ºäº†ç»Ÿè®¡å‡ºæ¯ä¸ªvendor_idçš„costï¼Œå°±éœ€è¦ä½¿ç”¨åˆ†ç»„è¯­å¥ï¼Œå°†åŒä¸€ä¸ªvendor_idçš„costæ±‚å’Œï¼š</p><p>select vendor_id, sum(cost) from vendor_cost group by vendor_id;</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwy3y3ulp2j30lk0dejsn.jpg" alt=""></p><p>å¾—å‡ºçš„ç»“æœå°±æ˜¯æ¯ä¸ªvendor_idçš„æ€»costã€‚</p><ul><li>è¿˜æœ‰ä¸€ç§group byçš„ç”¨æ³•ï¼š<strong>GROUP BY X, Yæ„æ€æ˜¯å°†æ‰€æœ‰å…·æœ‰ç›¸åŒXå­—æ®µå€¼å’ŒYå­—æ®µå€¼çš„è®°å½•æ”¾åˆ°ä¸€ä¸ªåˆ†ç»„é‡Œã€‚</strong></li><li>ä¸¾ä¸ªæ —å­ï¼š</li></ul><p>ç°åœ¨æœ‰è¡¨æ ¼</p><p>Table: Subject_Selection</p><h2 id="Subject-Semester-Attendee"><a href="#Subject-Semester-Attendee" class="headerlink" title="Subject   Semester   Attendee"></a>Subject   Semester   Attendee</h2><p>ITB001    1          John<br>ITB001    1          Bob<br>ITB001    1          Mickey<br>ITB001    2          Jenny<br>ITB001    2          James<br>MKB114    1          John<br>MKB114    1          Erica</p><ul><li>æˆ‘ä»¬ä¸‹é¢å†æ¥ç€è¦æ±‚ç»Ÿè®¡å‡ºæ¯é—¨å­¦ç§‘æ¯ä¸ªå­¦æœŸæœ‰å¤šå°‘äººé€‰æ‹©ï¼Œåº”ç”¨å¦‚ä¸‹SQL</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Subject, Semester, <span class="keyword">Count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span> Subject_Selection</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> Subject, Semester</span><br></pre></td></tr></table></figure><ul><li>å¾—åˆ°çš„ç»“æœæ˜¯ï¼š</li></ul><h3 id="å¾—åˆ°çš„ç»“æœæ˜¯ï¼š"><a href="#å¾—åˆ°çš„ç»“æœæ˜¯ï¼š" class="headerlink" title="å¾—åˆ°çš„ç»“æœæ˜¯ï¼š"></a>å¾—åˆ°çš„ç»“æœæ˜¯ï¼š</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Subject    Semester   Count</span><br><span class="line"><span class="comment">------------------------------</span></span><br><span class="line">ITB001     1          3</span><br><span class="line">ITB001     2          2</span><br><span class="line">MKB114     1          2</span><br></pre></td></tr></table></figure><ul><li>ä»è¡¨ä¸­çš„è®°å½•æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™ä¸ªåˆ†ç»„ç»“æœæ˜¯æ­£ç¡®çš„æœ‰3ä¸ªå­¦ç”Ÿåœ¨ç¬¬ä¸€å­¦æœŸé€‰æ‹©äº†ITB001, 2ä¸ªå­¦ç”Ÿåœ¨ç¬¬äºŒå­¦æœŸé€‰æ‹©äº†ITB001,è¿˜æœ‰ä¸¤ä¸ªå­¦ç”Ÿåœ¨ç¬¬ä¸€å­¦æœŸé€‰æ‹©äº†MKB114, æ²¡äººåœ¨ç¬¬äºŒå­¦æœŸé€‰æ‹©MKB114ã€‚</li></ul><hr>]]></content>
    
    <summary type="html">
    
      åœ¨MySQLä¸­ä½¿ç”¨group byå¯¹å­—æ®µè¿›è¡Œåˆ†ç»„ï¼Œå¹¶å¯¹æ¯ç»„è¿›è¡Œç»Ÿè®¡æ“ä½œ
    
    </summary>
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>golang xorm æ“ä½œæŒ‡å—</title>
    <link href="https://cloudsjhan.github.io/2018/10/31/golang-xorm-%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97/"/>
    <id>https://cloudsjhan.github.io/2018/10/31/golang-xorm-æ“ä½œæŒ‡å—/</id>
    <published>2018-10-31T07:42:15.000Z</published>
    <updated>2018-10-31T07:44:25.132Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p><a href="https://www.kancloud.cn/xormplus/xorm/167077" target="_blank" rel="noopener">https://www.kancloud.cn/xormplus/xorm/167077</a></p><hr>]]></content>
    
    <summary type="html">
    
      golang xorm æ“ä½œæŒ‡å— å®˜æ–¹ç‰ˆ
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯å‘¨åˆŠä¹‹golangä¸­ä¿®æ”¹structçš„sliceçš„å€¼</title>
    <link href="https://cloudsjhan.github.io/2018/10/27/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8Bgolang%E4%B8%AD%E4%BF%AE%E6%94%B9struct%E7%9A%84slice%E7%9A%84%E5%80%BC/"/>
    <id>https://cloudsjhan.github.io/2018/10/27/æŠ€æœ¯å‘¨åˆŠä¹‹golangä¸­ä¿®æ”¹structçš„sliceçš„å€¼/</id>
    <published>2018-10-27T02:30:10.000Z</published>
    <updated>2018-10-29T02:01:09.050Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><ul><li>å‰æ®µæ—¶é—´å†™goçš„æ—¶å€™é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹ç”±structæ„æˆçš„sliceä¸­structçš„æŸä¸ªå­—æ®µå€¼ï¼Œç±»ä¼¼äºä¸‹é¢çš„éœ€æ±‚ï¼š</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Docker <span class="keyword">struct</span> &#123;</span><br><span class="line">Ip  <span class="keyword">string</span></span><br><span class="line">ID <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker1 := Docker&#123;</span><br><span class="line">Ip:  <span class="string">"222"</span>,</span><br><span class="line">ID: <span class="string">"aaa"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">docker2 := Docker&#123;</span><br><span class="line">Ip:  <span class="string">"111"</span>,</span><br><span class="line">ID: <span class="string">"bbb"</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> tmpDocker []Docker</span><br><span class="line">tmpDocker = <span class="built_in">append</span>(tmpDocker, docker1)</span><br><span class="line">tmpDocker = <span class="built_in">append</span>(tmpDocker, docker2)</span><br><span class="line">ç°åœ¨éœ€è¦ä¿®æ”¹tmpDockerä¸­ï¼ŒIpè¿™ä¸ªå­—æ®µçš„å€¼, ä½ å¯ä»¥å…ˆè‡ªå·±å°è¯•ä¿®æ”¹ä¸€ä¸‹ï¼Œç„¶åå†å¾€ä¸‹çœ‹</span><br></pre></td></tr></table></figure><p>ç”±è¿™ä¸ªé—®é¢˜æˆ‘æŸ¥é˜…å¾ˆå¤šèµ„æ–™ï¼Œæˆ‘ä»¬å…ˆä»è¯­è¨€ä¸­ç»å…¸çš„ä¼ å€¼ã€ä¼ å¼•ç”¨è¯´èµ·æ¥</p><ul><li>å¯¹äºä¸€é—¨è¯­è¨€ï¼Œæˆ‘ä»¬å…³å¿ƒä¼ é€’å‚æ•°çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¼ å€¼è¿˜æ˜¯ä¼ å¼•ç”¨ï¼Œå…¶å®å¯¹äºä¼ å€¼å’Œä¼ å¼•ç”¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤è€çš„é—®é¢˜ï¼Œåœ¨å¤§å­¦å…¥é—¨çš„æ—¶å€™ï¼Œä½ å¯èƒ½å°±æ¥è§¦è¿‡è¿™æ ·çš„Cè¯­è¨€ä»£ç ï¼š</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä»¥ä¸‹å“ªä¸ªå‡½æ•°èƒ½å®ç°äº¤æ¢ä¸¤ä¸ªæ•°ï¼Ÿ</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap1</span><span class="params">(<span class="keyword">int</span> p,<span class="keyword">int</span> q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> temp;</span><br><span class="line">    temp=p;</span><br><span class="line">    p=q;</span><br><span class="line">    q=temp;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">swap2</span><span class="params">(<span class="keyword">int</span> *p,<span class="keyword">int</span> *q)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> *temp;</span><br><span class="line">    *temp=*p;</span><br><span class="line">    *p=*q;</span><br><span class="line">    *q=*temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®å¯¹äºCè¯­è¨€æ¥è¯´ï¼Œå¹¶æ²¡æœ‰ä¼ å¼•ç”¨çš„æ¦‚å¿µï¼Œçœ‹ä¼¼ä¼ å¼•ç”¨çš„æ“æ§ï¼Œå®é™…ä¸Šä¼ çš„æ˜¯æŒ‡é’ˆçš„åœ°å€ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§ä¼ å€¼ï¼Œå…ˆçœ‹ä¸€ä¸‹ä¼ å€¼ï¼Œä¼ å¼•ç”¨ï¼Œä¼ æŒ‡é’ˆçš„æ¦‚å¿µï¼š</p><ul><li>ä¼ å€¼ï¼šå¯èƒ½å¾ˆå¤šäººéƒ½å¬è¯´ï¼Œä¼ å€¼æ— éå°±æ˜¯å®å‚æ‹·è´ä¼ é€’ç»™å½¢å‚ã€‚è¿™å¥è¯æ²¡æœ‰é”™ï¼Œä½†æ˜¯ç†è§£èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ã€‚ä¸€å¥è¯ï¼Œä¼ å€¼å°±æ˜¯æŠŠå®å‚èµ‹å€¼ç»™å½¢å‚ï¼Œèµ‹å€¼å®Œæ¯•åå®å‚å°±å’Œå½¢å‚æ²¡æœ‰ä»»ä½•è”ç³»ï¼Œå¯¹å½¢å‚çš„ä¿®æ”¹å°±ä¸ä¼šå½±å“åˆ°å®å‚ã€‚</li><li>ä¼ åœ°å€ï¼šä¸ºä»€ä¹ˆè¯´ä¼ åœ°å€ä¹Ÿæ˜¯ä¸€ç§ä¼ å€¼å‘¢ï¼Ÿå› ä¸ºä¼ åœ°å€æ˜¯æŠŠå®å‚åœ°å€çš„æ‹·è´ä¼ é€’ç»™å½¢å‚ã€‚è¿˜æ˜¯ä¸€å¥è¯ï¼Œä¼ åœ°å€å°±æ˜¯æŠŠå®å‚çš„åœ°å€å¤åˆ¶ç»™å½¢å‚ã€‚å¤åˆ¶å®Œæ¯•åå®å‚çš„åœ°å€å’Œå½¢å‚çš„åœ°å€æ²¡æœ‰ä»»ä½•è”ç³»ï¼Œå¯¹å®å‚å½¢å‚åœ°å€çš„ä¿®æ”¹ä¸ä¼šå½±å“åˆ°å®å‚, ä½†æ˜¯å¯¹å½¢å‚åœ°å€æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®æ”¹å´ç›´æ¥ååº”åœ¨å®å‚ä¸­ï¼Œå› ä¸ºå½¢å‚æŒ‡å‘çš„å¯¹è±¡å°±æ˜¯å½¢å‚çš„å¯¹è±¡ã€‚</li><li>ä¼ å¼•ç”¨ï¼šä¼ å¼•ç”¨æœ¬è´¨æ²¡æœ‰ä»»ä½•å®å‚çš„æ‹·è´ï¼Œä¸€å¥è¯ï¼Œå°±æ˜¯è®©å¦å¤–ä¸€ä¸ªå˜é‡ä¹Ÿæ‰§è¡Œè¯¥å®å‚ã€‚å°±æ˜¯ä¸¤ä¸ªå˜é‡æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚è¿™æ˜¯å¯¹å½¢å‚çš„ä¿®æ”¹ï¼Œå¿…ç„¶åæ˜ åˆ°å®å‚ä¸Šã€‚</li></ul><p>é‚£ä¹ˆå¯¹äºgoè¯­è¨€æ¥è¯´ï¼Œæ˜¯æ²¡æœ‰å¼•ç”¨ä¼ é€’çš„ï¼Œgoä½œä¸ºäº‘è®¡ç®—æ—¶ä»£çš„Cè¯­è¨€ï¼Œé‡‡ç”¨çš„éƒ½æ˜¯å€¼ä¼ é€’ï¼Œå³ä½¿æ˜¯æŒ‡é’ˆï¼Œä¹Ÿæ˜¯å°†æŒ‡é’ˆçš„åœ°å€å³æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œæ‹·è´ä¸€ä»½ä¼ é€’ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡åšæ–‡çš„è®²è§£ï¼šGo<a href="http://www.flysnow.org/2018/02/24/golang-function-parameters-passed-by-value.html" target="_blank" rel="noopener">è¯­è¨€å‚æ•°ä¼ é€’æ˜¯ä¼ å€¼è¿˜æ˜¯ä¼ å¼•ç”¨</a></p><h3 id="å›åˆ°æ­£é¢˜"><a href="#å›åˆ°æ­£é¢˜" class="headerlink" title="å›åˆ°æ­£é¢˜"></a>å›åˆ°æ­£é¢˜</h3><ul><li><p>äº†è§£åŸºæœ¬çš„çŸ¥è¯†èƒŒæ™¯ä¹‹åï¼Œè®©æˆ‘ä»¬å›åˆ°æ–‡ç« å¼€å¤´çš„ä»£ç ï¼Œå³è¦ä¿®æ”¹sliceä¸­structæŸå­—æ®µçš„å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">type Docker struct &#123;</span><br><span class="line">Ip  string</span><br><span class="line">ID string</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">docker1 := Docker&#123;</span><br><span class="line">Ip:  &quot;222&quot;,</span><br><span class="line">ID: &quot;aaa&quot;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">docker2 := Docker&#123;</span><br><span class="line">Ip:  &quot;111&quot;,</span><br><span class="line">ID: &quot;bbb&quot;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var tmpDocker []Docker</span><br><span class="line">tmpDocker = append(tmpDocker, docker1)</span><br><span class="line">tmpDocker = append(tmpDocker, docker2)</span><br></pre></td></tr></table></figure><p>å…ˆå°†æˆ‘æœ€åˆçš„ä»£ç å®ç°è´´å‡ºæ¥ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  </span><br><span class="line"><span class="keyword">for</span> _, dockerInfo := <span class="keyword">range</span> tmpDocker &#123;</span><br><span class="line">dockerInfo.Ip = <span class="string">"192.168,.1.1"</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(tmpDocker)</span><br></pre></td></tr></table></figure><p>è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿è¡Œç»“æœï¼š</p><p><img src="https://ws2.sinaimg.cn/large/006tNbRwly1fwmm2z70f6j30d301ja9z.jpg" alt=""></p><p>å‘ç°structä¸­Ipå­—æ®µçš„å€¼å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><p>åŸå› å°±æ˜¯ï¼šrangeçš„è¿‡ç¨‹ä¸­äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå³dockerInfoæ˜¯temDockerä¸­æ¯ä¸ªå…ƒç´ çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥ä½ æ”¹å˜çš„åªæ˜¯å‰¯æœ¬ä¸­Ipå­—æ®µçš„å€¼ï¼Œå¹¶æ²¡æœ‰æ”¹å˜çœŸå®çš„ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢?</p><p>è¿™é‡Œæˆ‘æå‡ºä¸¤ç§è§£å†³çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ–¹æ³•1ï¼šèµ‹ç»™ä¸€ä¸ªæ–°çš„å¯¹è±¡</span></span><br><span class="line">newTmpDocker := []Docker&#123;&#125;<span class="comment">//æ–°çš„å¯¹è±¡</span></span><br><span class="line"><span class="keyword">for</span> _, dockerInfo := <span class="keyword">range</span> tmpDocker &#123;</span><br><span class="line">    dockerInfo.Ip = <span class="string">"192.168.1.1"</span></span><br><span class="line">    newTmpDocker = <span class="built_in">append</span>(newTmpDocker, dockerInfo)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(newTmpDocker)</span><br></pre></td></tr></table></figure><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwmnl32x44j30dj01imx3.jpg" alt=""></p><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¾“å‡ºçš„structçš„sliceä¸­æˆ‘ä»¬æƒ³è¦æ”¹å˜çš„å­—æ®µå·²ç»ä¿®æ”¹æˆåŠŸã€‚</p><p>ç¬¬äºŒç§æ–¹æ³•æ˜¯å°†å‰¯æœ¬ä¿®æ”¹åèµ‹å€¼</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ³•<span class="number">2</span>ï¼šä¿®æ”¹å‰¯æœ¬åï¼Œå°†å‰¯æœ¬èµ‹å€¼ç»™åŸæ¥çš„</span><br><span class="line"><span class="keyword">for</span> i, dockerInfo := <span class="keyword">range</span> tmpDocker&#123;</span><br><span class="line">    dockerInfo.Ip = <span class="string">"192.168.1.1"</span></span><br><span class="line">    tmpDocker[i] = dockerInfo</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(tmpDocker)</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><p><img src="https://ws3.sinaimg.cn/large/006tNbRwly1fwmnl32x44j30dj01imx3.jpg" alt=""></p><p>å¯ä»¥çœ‹åˆ°åŒæ ·ä¿®æ”¹æˆåŠŸã€‚</p></li></ul><h3 id="æ€»ç»“ï¼Œåœ¨goä¸­ï¼Œæ‰€æœ‰ä¼ å‚éƒ½æ˜¯ä¼ å€¼ï¼Œéƒ½æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œå³ä¸€ä¸ªæ‹·è´ï¼Œå› ä¸ºæ‹·è´çš„å†…å®¹æœ‰æ—¶å€™æ˜¯éå¼•ç”¨ç±»å‹ï¼ˆintã€stringã€structç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±åœ¨å‡½æ•°ä¸­å°±æ— æ³•ä¿®æ”¹åŸå†…å®¹æ•°æ®ï¼›æœ‰çš„æ˜¯å¼•ç”¨ç±»å‹ï¼ˆæŒ‡é’ˆã€mapã€sliceã€chanç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®ã€‚"><a href="#æ€»ç»“ï¼Œåœ¨goä¸­ï¼Œæ‰€æœ‰ä¼ å‚éƒ½æ˜¯ä¼ å€¼ï¼Œéƒ½æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œå³ä¸€ä¸ªæ‹·è´ï¼Œå› ä¸ºæ‹·è´çš„å†…å®¹æœ‰æ—¶å€™æ˜¯éå¼•ç”¨ç±»å‹ï¼ˆintã€stringã€structç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±åœ¨å‡½æ•°ä¸­å°±æ— æ³•ä¿®æ”¹åŸå†…å®¹æ•°æ®ï¼›æœ‰çš„æ˜¯å¼•ç”¨ç±»å‹ï¼ˆæŒ‡é’ˆã€mapã€sliceã€chanç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®ã€‚" class="headerlink" title="æ€»ç»“ï¼Œåœ¨goä¸­ï¼Œæ‰€æœ‰ä¼ å‚éƒ½æ˜¯ä¼ å€¼ï¼Œéƒ½æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œå³ä¸€ä¸ªæ‹·è´ï¼Œå› ä¸ºæ‹·è´çš„å†…å®¹æœ‰æ—¶å€™æ˜¯éå¼•ç”¨ç±»å‹ï¼ˆintã€stringã€structç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±åœ¨å‡½æ•°ä¸­å°±æ— æ³•ä¿®æ”¹åŸå†…å®¹æ•°æ®ï¼›æœ‰çš„æ˜¯å¼•ç”¨ç±»å‹ï¼ˆæŒ‡é’ˆã€mapã€sliceã€chanç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®ã€‚"></a>æ€»ç»“ï¼Œåœ¨goä¸­ï¼Œæ‰€æœ‰ä¼ å‚éƒ½æ˜¯ä¼ å€¼ï¼Œéƒ½æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œå³ä¸€ä¸ªæ‹·è´ï¼Œå› ä¸ºæ‹·è´çš„å†…å®¹æœ‰æ—¶å€™æ˜¯éå¼•ç”¨ç±»å‹ï¼ˆintã€stringã€structç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±åœ¨å‡½æ•°ä¸­å°±æ— æ³•ä¿®æ”¹åŸå†…å®¹æ•°æ®ï¼›æœ‰çš„æ˜¯å¼•ç”¨ç±»å‹ï¼ˆæŒ‡é’ˆã€mapã€sliceã€chanç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®ã€‚</h3><p>æ˜¯å¦å¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®ï¼Œå’Œä¼ å€¼ã€ä¼ å¼•ç”¨æ²¡æœ‰å¿…ç„¶çš„å…³ç³»ã€‚åœ¨C++ä¸­ï¼Œä¼ å¼•ç”¨è‚¯å®šæ˜¯å¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®çš„ï¼Œåœ¨Goè¯­è¨€é‡Œï¼Œè™½ç„¶åªæœ‰ä¼ å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹åŸå†…å®¹æ•°æ®ï¼Œå› ä¸ºå‚æ•°æ˜¯å¼•ç”¨ç±»å‹ã€‚</p><p>è¿™é‡Œä¹Ÿè¦è®°ä½ï¼Œå¼•ç”¨ç±»å‹å’Œä¼ å¼•ç”¨æ˜¯ä¸¤ä¸ªæ¦‚å¿µã€‚</p><p>å†è®°ä½ï¼ŒGoé‡Œåªæœ‰ä¼ å€¼ï¼ˆå€¼ä¼ é€’ï¼‰ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      å¦‚ä½•ä¼˜é›…åœ°ä¿®æ”¹goä¸­structçš„sliceçš„å€¼
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/tags/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
  </entry>
  
  <entry>
    <title>golangä¸­string,rune,byteçš„å…³ç³»</title>
    <link href="https://cloudsjhan.github.io/2018/10/25/golang%E4%B8%ADstring-rune-byte%E7%9A%84%E5%85%B3%E7%B3%BB/"/>
    <id>https://cloudsjhan.github.io/2018/10/25/golangä¸­string-rune-byteçš„å…³ç³»/</id>
    <published>2018-10-25T01:55:40.000Z</published>
    <updated>2018-10-25T02:26:19.271Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ol><li>golangä¸­Stringçš„åº•å±‚æ˜¯ä½¿ç”¨byte[]æ•°ç»„å­˜å‚¨çš„ï¼Œä¸å¯æ”¹å˜</li></ol><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">str := <span class="string">"Golang æµ‹è¯•"</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(str))</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æŒ‰é“ç†åº”è¯¥è¾“å‡º6+1+2.</p><p>å®é™…è¿è¡Œä¹‹åè¾“å‡ºå´æ˜¯13ï¼Œ åŸå› æ˜¯ä¸­æ–‡å­—ç¬¦åœ¨utf-8ç¼–ç çš„ç³»ç»Ÿä¸­æ˜¯3ä¸ªå­—èŠ‚å­˜å‚¨çš„ï¼Œåœ¨Unicodeä¸­æ˜¯2ä¸ªå­—èŠ‚å­˜å‚¨çš„ï¼Œgoçš„é»˜è®¤ç¼–ç æ ¼å¼æ˜¯utf-8ï¼Œsoã€‚ã€‚</p><p>è¿™æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹æ ‡è®¿é—®å­—ç¬¦ä¸²ä¸­çš„ä¸­æ–‡å­—ç¬¦æ˜¯ä¸è¡Œçš„ï¼Œæƒ³è¦ä½¿ç”¨ä¸‹æ ‡è®¿é—®ï¼Œå°±éœ€è¦runeå‡ºé©¬ã€‚</p><ol start="2"><li>åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œruneçš„å®šä¹‰æ˜¯ï¼š</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> rune is an alias for int32 and is equivalent to int32 in all ways. It is</span><br><span class="line"> used, by convention, to distinguish character values from integer values.</span><br><span class="line"></span><br><span class="line">int32çš„åˆ«åï¼Œå‡ ä¹åœ¨æ‰€æœ‰æ–¹é¢ç­‰åŒäºint32</span><br><span class="line">å®ƒç”¨æ¥åŒºåˆ†å­—ç¬¦å€¼å’Œæ•´æ•°å€¼</span><br><span class="line">type rune int32</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬æƒ³è¦å¾—åˆ°é¢„æœŸå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå°±è¦ä½¿ç”¨runeåˆ‡ç‰‡æ¥å®ç°ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(<span class="string">"rune:"</span>, <span class="built_in">len</span>([]<span class="keyword">rune</span>(str)))</span><br></pre></td></tr></table></figure><p>å°±ä¼šè¾“å‡ºé¢„æœŸçš„rune: 9.</p><p>è¿™æ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§ä¸‹æ ‡å»è®¿é—®strä¸­çš„å­—ç¬¦äº†ã€‚å³[7]rune(str) = â€œæµ‹â€ã€‚</p><p>3.æ€»ç»“</p><p>stringçš„åº•å±‚æ˜¯byteï¼Œbyteä¸runeçš„ä¸åŒä¹‹å¤„æ˜¯ï¼š</p><p>byte ç­‰åŒäºint8ï¼Œå¸¸ç”¨æ¥å¤„ç†asciiå­—ç¬¦<br>rune ç­‰åŒäºint32,å¸¸ç”¨æ¥å¤„ç†unicodeæˆ–utf-8å­—ç¬¦</p><p>æˆ–è€…å¯ä»¥è¿™æ ·è¯´ï¼š</p><p>rune èƒ½æ“ä½œä»»ä½•å­—ç¬¦<br>byte ä¸æ”¯æŒä¸­æ–‡çš„æ“ä½œ</p><p>â€‹                                           END</p><hr>]]></content>
    
    <summary type="html">
    
      æµ…ægolangä¸­Stringï¼Œrune, byteçš„å…³ç³»
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>ä¸Šæµ·QConä¹‹Goä¸“å®¶David Cheneyå…³äºGOæœ€ä½³å®è·µçš„æ¼”è®²</title>
    <link href="https://cloudsjhan.github.io/2018/10/21/%E4%B8%8A%E6%B5%B7QCon%E4%B9%8BGo%E4%B8%93%E5%AE%B6David-Cheney%E5%85%B3%E4%BA%8EGO%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E7%9A%84%E6%BC%94%E8%AE%B2/"/>
    <id>https://cloudsjhan.github.io/2018/10/21/ä¸Šæµ·QConä¹‹Goä¸“å®¶David-Cheneyå…³äºGOæœ€ä½³å®è·µçš„æ¼”è®²/</id>
    <published>2018-10-21T14:07:15.000Z</published>
    <updated>2018-10-21T14:17:36.133Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æœ¬å‘¨å…­æœ‰å¹¸å‚åŠ äº†2018QConä¸Šæµ·çš„ä¼šè®®ï¼Œå¬äº†Davidå…³äºGOæœ€ä½³å®è·µçš„ä¸€äº›å»ºè®®ï¼Œä¸‹é¢è´´å‡ºçš„å°±æ˜¯Davidçš„æ¼”è®²ç¨¿ï¼Œå†…å®¹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒåŸºç¡€ï¼Œä½†æ˜¯åˆæ˜¯ç¼–ç¨‹ä¸­ä¸å¯é¿å…çš„ä¸€äº›é—®é¢˜ï¼Œå¸Œæœ›å¯ä»¥ç»™å¤§å®¶å¸¦æ¥ä¸€äº›å¯å‘ã€‚</p><p>Table of Contents </p><p>Introduction<br> \1. Guiding principles </p><p>1.1. Simplicity 1.2. Readability 1.3. Productivity </p><p>\2. Identiers<br> 2.1. Choose identiers for clarity, not brevity 2.2. Identier length<br> 2.3. Donâ€™t name your variables for their types 2.4. Use a consistent naming style<br> 2.5. Use a consistent declaration style<br> 2.6. Be a team player </p><p>\3. Comments<br> 3.1. Comments on variables and constants should describe their contents not their purpose 3.2. Always document public symbols </p><p>\4. Package Design<br> 4.1. A good package starts with its name<br> 4.2. Avoid package names like base , common , or util 4.3. Return early rather than nesting deeply<br> 4.4. Make the zero value useful<br> 4.5. Avoid package level state </p><p>\5. Project Structure<br> 5.1. Consider fewer, larger packages<br> 5.2. Keep package main small as small as possible </p><p>\6. API Design<br> 6.1. Design APIs that are hard to misuse.<br> 6.2. Design APIs for their default use case<br> 6.3. Let functions dene the behaviour they requires </p><p>\7. Error handling<br> 7.1. Eliminate error handling by eliminating errors 7.2. Only handle an error once </p><p>\8. Concurrency<br> 8.1. Keep yourself busy or do the work yourself<br> 8.2. Leave concurrency to the caller<br> 8.3. Never start a goroutine without when it will stop. </p><p>Introduction </p><p>Hello,<br> My goal over the next two sessions is to give you my advice for best practices writing Go code. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 1/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>This is a workshop style presentation, Iâ€™m going to dispense with the usual slide deck and weâ€™ll work directly from the document which you can take away with you today. </p><p>TIP </p><p>You can find the latest version of this presentation at <a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> </p><p>\1. Guiding principles </p><p>If Iâ€™m going to talk about best practices in any programming language I need some way to define what I mean by best. If you came to my keynote yesterday you would have seen this quote from the Go team lead, Russ Cox: </p><p>â€œSoftware engineering is what happens to programming when you add time and other programmers. </p><p>â€” Russ Cox </p><p>Russ is making the distinction between software programming and software engineering. The former is a program you write for yourself. The latter is a product that many people will work on over time. Engineers will come and go, teams will grow and shrink over time, requirements will change, features will be added and bugs fixed. This is the nature of software engineering. </p><p>Iâ€™m possibly one of the earliest users of Go in this room, but to argue that my seniority gives my views more weight is false. Instead, the advice Iâ€™m going to present today is informed by what I believe to be the guiding principles underlying Go itself. They are: </p><p>\1. Simplicity<br> \2. Readability 3. Productivity </p><p>NOTE </p><p>Youâ€™ll note that I didnâ€™t say performance, or concurrency. There are languages which are a bit faster than Go, but theyâ€™re certainly not as simple as Go. There are languages which make concurrency their highest goal, but they are not as readable, nor as productive. </p><p>Performance and concurrency are important attributes, but not as important as simplicity, readability, and productivity. </p><p>1.1. Simplicity </p><p>Why should we strive for simplicity? Why is important that Go programs be simple? </p><p>Weâ€™ve all been in a situation where you say â€œI canâ€™t understand this codeâ€, yes? Weâ€™ve all worked on programs where youâ€™re scared to make a change because youâ€™re worried itâ€™ll break another part of the program; a part you donâ€™t understand and donâ€™t know how to fix. </p><p>This is complexity. Complexity turns reliable software in unreliable software. Complexity is what kills software projects. </p><p>Simplicity is the highest goal of Go. Whatever programs we write, we should be able to agree that they are simple. </p><p>1.2. Readability </p><p>â€œ<a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 2/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>â€œReadability is essential for maintainability. â€” Mark Reinhold </p><p>JVM language summit 2018 </p><p>Why is it important that Go code be readable? Why should we strive for readability? </p><p>â€œPrograms must be written for people to read, and only incidentally for machines to execute. â€” Hal Abelson and Gerald Sussman </p><p>Structure and Interpretation of Computer Programs </p><p>Readability is important because all software, not just Go programs, is written by humans to be read by other humans. The fact that software is also consumed by machines is secondary. </p><p>Code is read many more times than it is written. A single piece of code will, over its lifetime, be read hundreds, maybe thousands of times. </p><p>â€œThe most important skill for a programmer is the ability to effectively communicate ideas. â€” GastoÌn Jorquera [1] </p><p>Readability is key to being able to understand what the program is doing. If you canâ€™t understand what a program is doing, how can you hope to maintain it? If software cannot be maintained, then it will be rewritten; and that could be the last time your company will invest in Go. </p><p>If youâ€™re writing a program for yourself, maybe it only has to run once, or youâ€™re the only person whoâ€™ll ever see it, then do what ever works for you. But if this is a piece of software that more than one person will contribute to, or that will be used by people over a long enough time that requirements, features, or the environment it runs in changes, then your goal must be for your program to be maintainable. </p><p>The first step towards writing maintainable code is making sure the code is readable. </p><p>â€œ1.3. Productivity<br> Design is the art of arranging code to work today, and be changeable forever. </p><p>â€” Sandi Metz </p><p>The last underlying principle I want to highlight is productivity. Developer productivity is a sprawling topic but it boils down to this; how much time do you spend doing useful work verses waiting for your tools or hopelessly lost in a foreign code-base. Go programmers should feel that they can get a lot done with Go. </p><p>The joke goes that Go was designed while waiting for a C++ program to compile. Fast compilation is a key feature of Go and a key recruiting tool to attract new developers. While compilation speed remains a constant battleground, it is fair to say that compilations which take minutes in other languages, take seconds in Go. This helps Go developers feel as productive as their counterparts working in dynamic languages without the reliability issues inherent in those languages. </p><p>More fundamental to the question of developer productivity, Go programmers realise that code is written to be read and so place the act of reading code above the act of writing it. Go goes so far as to enforce, via tooling and custom, that all code be formatted in a specific style. This removes the friction of learning a project specific dialect and helps spot mistakes because they just look incorrect. </p><p>Go programmers donâ€™t spend days debugging inscrutable compile errors. They donâ€™t waste days with complicated build scripts or deploying code to production. And most importantly they donâ€™t spend their time trying to understand what their coworker wrote. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 3/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Productivity is what the Go team talk about when they say the language must scale. 2. Identiers </p><p>The first topic weâ€™re going to discuss is identifiers. An identifier is a fancy word for a name; the name of a variable, the name of a function, the name of a method, the name of a type, the name of a package, and so on. </p><p>â€œPoor naming is symptomatic of poor design. â€” Dave Cheney </p><p>Given the limited syntax of Go, the names we choose for things in our programs have an oversized impact on the readability of our programs. Readability is the defining quality of good code thus choosing good names is crucial to the readability of Go code. </p><p>â€œ2.1. Choose identiers for clarity, not brevity<br> Obvious code is important. What you can do in one line you should do in three. </p><p>â€” Ukiah Smith </p><p>Go is not a language that optimises for clever one liners. Go is not a language which optimises for the least number of lines in a program. Weâ€™re not optimising for the size of the source code on disk, nor how long it takes to type. </p><p>â€œGood naming is like a good joke. If you have to explain it, itâ€™s not funny. â€” Dave Cheney </p><p>Key to this clarity is the names we choose for identifies in Go programs. Letâ€™s talk about the qualities of a good name: </p><p>A good name is concise. A good name need not be the shortest it can possibly be, but a good name should waste no space on things which are extraneous. Good names have a high signal to noise ratio. </p><p>A good name is descriptive. A good name should describe the application of a variable or constant, not their contents. A good name should describe the result of a function, or behaviour of a method, not their operation. A good name should describe the purpose of a package, not its contents. The more accurately a name describes the thing it identifies, the better the name. </p><p>A good name is should be predictable. You should be able to infer the way a name will be used from its name alone. This is a function of choosing descriptive names, but it also about following tradition. This is what Go programmers talk about when they say idiomatic. </p><p>Letâ€™s talk about each of these properties in depth. </p><p>2.2. Identier length </p><p>Sometimes people criticise the Go style for recommending short variable names. As Rob Pike said, â€œGo programmers want the right length identifiersâ€. [1] </p><p>Andrew Gerrand suggests that by using longer identifies for some things we indicate to the reader that they are of higher importance. </p><p>â€œThe greater the distance between a nameâ€™s declaration and its uses, the longer the name should be. </p><p>â€” Andrew Gerrand [2] </p><p>From this we can draw some guidelines: </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 4/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Short variable names work well when the distance between their declaration and last use is short.<br> Long variable names need to justify themselves; the longer they are the more value they need to provide. Lengthy </p><p>bureaucratic names carry a low amount of signal compared to their weight on the page. </p><p>Donâ€™t include the name of your type in the name of your variable. </p><p>Constants should describe the value they hold, not how that value is used. </p><p>Single letter variables for loops and branches, single words for parameters and return values, multiple words for functions and package level declarations </p><p>Single words for methods, interfaces, and packages.<br> Remember that the name of a package is part of the name the caller uses to to refer to it, so make use of that. </p><p>Letâ€™s look at an example to </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type Person struct &#123;</span><br><span class="line">    Name string</span><br></pre></td></tr></table></figure><p>Age int } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// AverageAge returns the average age of people.</span><br><span class="line">func AverageAge(people []Person) int &#123;</span><br><span class="line">    if len(people) == 0 &#123;</span><br><span class="line">        return 0</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var count, sum int</span><br><span class="line">for _, p := range people &#123;</span><br></pre></td></tr></table></figure><p>sum += p.Age </p><p>count += 1 } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return sum / count</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p>In this example, the range variable p is declared on line 10 and only referenced on the following line. p lives for a very short time both on the page, and during the execution of the function. A reader who is interested in the effect values of p have on the program need only read two lines. </p><p>By comparison people is declared in the function parameters and lives for seven lines. The same is true for sum , and count , thus they justify their longer names. The reader has to scan a wider number of lines to locate them so they are </p><p>given more distinctive names. </p><p>I could have chosen s for sum and c (or possibly n ) for but this would have reduced all the variables in the program to the same level of importance. I could have chosen                              instead of                              but that would have left the problem of what to call the for â€¦ range iteration variable. The singular                              would look odd as the loop iteration variable which lives for little time has a longer name than the slice of values it was derived from. </p><p>count </p><p>TIP </p><p>Use blank lines to break up the flow of a function in the same way you use paragraphs to break up the flow of a document. In AverageAge we have three operations occurring in sequence. The first is the precondition, checking that we donâ€™t divide by zero if people is empty, the second is the accumulation of the sum and count, and the final is the computation of the average. </p><p>2.2.1. Context is key </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 5/45 </p><p>p </p><p>people </p><p>person </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Itâ€™s important to recognise that most advice on naming is contextual. I like to say it is a principle, not a rule. </p><p>What is the difference between two identifiers, i , and index . We cannot say conclusively that one is better than another, for example is </p><p>fundamentally more readable than </p><p>I argue it is not, because it is likely the scope of i , and index for that matter, is limited to the body of the for loop and the extra verbosity of the latter adds little to comprehension of the program. </p><p>However, which of these functions is more readable? </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (s *SNMP) Fetch(oid []int, index int) (int, error)</span><br></pre></td></tr></table></figure><p>or </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func (s *SNMP) Fetch(o []int, i int) (int, error)</span><br></pre></td></tr></table></figure><p>In this example, oid is an abbreviation for SNMP Object ID, so shortening it to o would mean programmers have to translate from the common notation that they read in documentation to the shorter notation in your code. Similarly, reducing index to i obscures what i stands for as in SNMP messages a sub value of each OID is called an Index. </p><p>TIP Donâ€™t mix and match long and short formal parameters in the same declaration. 2.3. Donâ€™t name your variables for their types </p><p>You shouldnâ€™t name your variables after their types for the same reason you donâ€™t name your pets â€œdogâ€ and â€œcatâ€. You also probably shouldnâ€™t include the name of your type in the name of your variableâ€™s name for the same reason. </p><p>The name of the variable should describe its contents, not the type of the contents. Consider this example: var usersMap map[string]*User </p><p>Whatâ€™s good about this declaration? We can see that its a map, and it has something to do with the *User type, thatâ€™s probably good. But usersMap is a map, and Go being a statically typed language wonâ€™t let us accidentally use it where a scalar variable is required, so the Map suffix is redundant. </p><p>Now, consider what happens if we were to declare other variables like: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for index := 0; index &lt; len(s); index++ &#123;</span><br><span class="line">    //</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for i := 0; i &lt; len(s); i++ &#123;</span><br><span class="line">    //</span><br></pre></td></tr></table></figure><p>} </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 6/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var (</span><br><span class="line">    companiesMap map[string]*Company</span><br><span class="line">    productsMap map[string]*Products</span><br></pre></td></tr></table></figure><p>) </p><p>Now we have three map type variables in scope, usersMap , companiesMap , and productsMap , all mapping strings to different types. We know they are maps, and we also know that their map declarations prevent us from using one in place of anotherâ€”the compiler will throw an error if we try to use companiesMap where the code is expecting a </p><p>map[string]*User . In this situation itâ€™s clear that the Map suffix does not improve the clarity of the code, its just extra boilerplate to type. </p><p>My suggestion is to avoid any suffix that resembles the type of the variable.<br> TIP If users isnâ€™t descriptive enough, then usersMap wonâ€™t be either. </p><p>This advice also applies to function parameters. For example: </p><p>Naming the <em>Config parameter config is redundant. We know its a </em>Config , it says so right there. In this case consider conf or maybe c will do if the lifetime of the variable is short enough. </p><p>If there is more that one in scope at any one time then calling them conf1 and conf2 is less descriptive than calling them and as the latter are less likely to be mistaken for one another. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type Config struct &#123;</span><br><span class="line">    //</span><br><span class="line">&#125;</span><br><span class="line">func WriteConfig(w io.Writer, config *Config)</span><br></pre></td></tr></table></figure><p>*Config </p><p>original </p><p>updated </p><p>Donâ€™t let package names steal good variable names. </p><p>The name of an imported identifier includes its package name. For example the context package will be known as context.Context . This makes it impossible to use </p><p>a variable or type in your package. </p><p>type in the as </p><p>func WriteLog(context context.Context, message string)<br> Will not compile. This is why the local declaration for context.Context types is traditionally ctx . </p><p>eg. </p><p>func WriteLog(ctx context.Context, message string) </p><p>2.4. Use a consistent naming style </p><p>Another property of a good name is it should be predictable. The reader should be able to understand the use of a name when they encounter it for the first time. When they encounter a common name, they should be able to assume it has not changed meanings since the last time they saw it. </p><p>NOTE </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 7/45 </p><p>Context </p><p>context </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>For example, if your code passes around a database handle, make sure each time the parameter appears, it has the same name. Rather than a combination of d <em>sql.DB , dbase </em>sql.DB , DB <em>sql.DB , and database </em>sql.DB , instead consolidate on something like; </p><p>db <em>sql.DB<br> Doing so promotes familiarity; if you see a db , you know itâ€™s a </em>sql.DB and that it has either been declared locally or </p><p>provided for you by the caller. </p><p>Similarly for method receivers; use the same receiver name every method on that type. This makes it easier for the reader to internalise the use of the receiver across the methods in this type. </p><p>The convention for short receiver names in Go is at odds with the advice provided so far. This is just NOTE one of the choices made early on that has become the preferred style, just like the use of CamelCase </p><p>TIP </p><p>rather than snake_case . </p><p>Go style dictates that receivers have a single letter name, or acronyms derived from their type. You may find that the name of your receiver sometimes conflicts with name of a parameter in a method. In this case, consider making the parameter name slightly longer, and donâ€™t forget to use this new parameter name consistently. </p><p>Finally, certain single letter variables have traditionally been associated with loops and counting. For example, i , j , and k are commonly the loop induction variable for simple for loops. n is commonly associated with a counter or accumulator. v is a common shorthand for a value in a generic encoding function, k is commonly used for the key of a map, and s is often used as shorthand for parameters of type string . </p><p>As with the db example above programmers expect                              to be a loop induction variable. If you ensure that is always a loop variable, not used in other contexts outside a                              loop. When readers encounter a variable called , or j , they know that a loop is close by. </p><p>i </p><p>i </p><p>for </p><p>i </p><p>TIP </p><p>If you found yourself with so many nested loops that you exhaust your supply of i , j , and k variables, its probably time to break your function into smaller units. </p><p>2.5. Use a consistent declaration style </p><p>Go has at least six different ways to declare a variable </p><p>varxint=1 varx=1 varxint;x=1 var x = int(1) x:=1 </p><p>Iâ€™m sure there are more that I havenâ€™t thought of. This is something that Goâ€™s designers recognise was probably a mistake, but its too late to change it now. With all these different ways of declaring a variable, how do we avoid each Go programmer choosing their own style? </p><p>I want to present a suggestions for how I declare variables in my programs. This is the style I try to use where possible. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 8/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>When declaring, but not initialising, a variable, use var . When declaring a variable that will be explicitly initialised later in the function, use the var keyword. </p><p>The var acts as a clue to say that this variable has been deliberately declared as the zero value of the indicated type. This is also consistent with the requirement to declare variables at the package level using var as opposed to the short declaration syntaxâ€”although Iâ€™ll argue later that you shouldnâ€™t be using package level variables at all. </p><p>When declaring and initialising, use := . When declaring and initialising the variable at the same time, that is to say weâ€™re not letting the variable be implicitly initialised to its zero value, I recommend using the short variable declaration form. This makes it clear to the reader that the variable on the left hand side of the := is being deliberately initialised. </p><p>To explain why, Letâ€™s look at the previous example, but this time deliberately initialising each variable: </p><p>In the first and third examples, because in Go there are no automatic conversions from one type to another; the type on the left hand side of the assignment operator must be identical to the type on the right hand side. The compiler can infer the type of the variable being declared from the type on the right hand side, to the example can be written more concisely like this: </p><p>This leaves us with explicitly initialising players to 0 which is redundant because 0 is `playersâ€™ zero value. So its better to make it clear that weâ€™re going to use the zero value by instead writing </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var players int</span><br></pre></td></tr></table></figure><p>What about the second statement? We cannot elide the type and write </p><p>var things = nil<br> Because nil does not have a type. [2] Instead we have a choice, do we want the zero value for a slice? </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var players int    // 0</span><br><span class="line">var things []Thing // an empty slice of Things</span><br><span class="line">var thing Thing    // empty Thing struct</span><br><span class="line">json.Unmarshall(reader, &amp;thing)</span><br><span class="line">var players int = 0</span><br><span class="line">var things []Thing = nil</span><br><span class="line">var thing *Thing = new(Thing)</span><br><span class="line">json.Unmarshall(reader, thing)</span><br><span class="line">var players = 0</span><br><span class="line">var things []Thing = nil</span><br><span class="line">var thing = new(Thing)</span><br><span class="line">json.Unmarshall(reader, thing)</span><br></pre></td></tr></table></figure><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 9/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var things []Thing</span><br></pre></td></tr></table></figure><p>or do we want to create a slice with zero elements? </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">var things = make([]Thing, 0)</span><br></pre></td></tr></table></figure><p>If we wanted the latter then this is not the zero value for a slice so we should make it clear to the reader that weâ€™re making this choice by using the short declaration form: </p><p>things := make([]Thing, 0)<br> Which tells the reader that we have chosen to initialise things explicitly. </p><p>This brings us to the third declaration, </p><p>var thing = new(Thing)<br> Which is both explicitly initialising a variable and introduces the uncommon use of the new keyword which some Go </p><p>programmer dislike. If we apply our short declaration syntax recommendation then the statement becomes </p><p>thing := new(Thing)<br> Which makes it clear that thing is explicitly initialised to the result of new(Thing) â€“a pointer to a Thing â€“but still </p><p>leaves us with the unusual use of new . We could address this by using the compact literal struct initialiser form, thing := &amp;Thing{} </p><p>Which does the same as<br> means weâ€™re explicitly initialising </p><p>, hence why some Go programmers are upset by the duplication. However this with a pointer to a Thing{} , which is the zero value for a Thing . </p><p>new(Thing) </p><p>thing </p><p>Instead we should recognise that                              is being declared as its zero value and use the address of operator to pass the address of thing to </p><p>thing </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">json.Unmarshall</span><br><span class="line">var thing Thing</span><br><span class="line">json.Unmarshall(reader, &amp;thing)</span><br></pre></td></tr></table></figure><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 10/45 </p><p>2018/10/21 </p><p>Practical Go: Real world advice for writing maintainable Go programs </p><p>NOTE </p><p>Of course, with any rule of thumb, there are exceptions. For example, sometimes two variables are closely related so writing </p><p>Would be odd. The declaration may be more readable like this </p><p>min, max := 0, 1000 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var min int</span><br><span class="line">max := 1000</span><br></pre></td></tr></table></figure><p>In summary:<br> When declaring a variable without initialisation, use the var syntax. </p><p>When declaring and explicitly initialising a variable, use := . Make tricky declarations obvious. </p><p>When something is complicated, it should look complicated. var length uint32 = 0x80 </p><p>Here length may be being used with a library which requires a specific numeric type and is more TIP explicit that length is being explicitly chosen to be uint32 than the short declaration form: </p><p>length := uint32(0x80) </p><p>In the first example Iâ€™m deliberately breaking my rule of using the var declaration form with an explicit initialiser. This decision to vary from my usual form is a clue to the reader that something unusual is happening. </p><p>2.6. Be a team player </p><p>I talked about a goal of software engineering to produce readable, maintainable, code. Therefore you will likely spend most of your career working on projects of which you are not the sole author. My advice in this situation is to follow the local style. </p><p>Changing styles in the middle of a file is jarring. Uniformity, even if its not your preferred approach, is more valuable for maintenance than your personal preference. My rule of thumb is; if it fits through gofmt then its usually not worth holding up a code review for. </p><p>If you want to do a renaming across a code-base, do not mix this into another change. If someone is TIP using git bisect they donâ€™t want to wade through thousands of lines of renaming to find the code you </p><p>changed as well. </p><p>\3. Comments </p><p>Before we move on to larger items I want to spend a few minutes talking about comments. </p><p>â€œ<a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 11/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>â€œGood code has lots of comments, bad code requires lots of comments. â€” Dave Thomas and Andrew Hunt </p><p>The Pragmatic Programmer </p><p>Comments are very important to the readability of a Go program. A comments should do one of three things: </p><p>\1. The comment should explain what the thing does.<br> \2. The comment should explain how the thing does what it does. 3. The comment should explain why the thing is why it is. </p><p>The first form is ideal for commentary on public symbols: </p><p>The second form is ideal for commentary inside a method: </p><p>The third form, the why , is unique as it does not displace the first two, but at the same time itâ€™s not a replacement for the what, or the how. The why style of commentary exists to explain the external factors that drove the code you read on the page. Frequently those factors rarely make sense taken out of context, the comment exists to provide that context. </p><p>In this example it may not be immediately clear what the effect of setting HealthyPanicThreshold to zero percent will do. The comment is needed to clarify that the value of 0 will disable the panic threshold behaviour. </p><p>3.1. Comments on variables and constants should describe their contents not their purpose </p><p>I talked earlier that the name of a variable, or a constant, should describe its purpose. When you add a comment to a variable or constant, that comment should describe the variables contents, not the variables purpose. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const randomNumber = 6 // determined from an unbiased die</span><br></pre></td></tr></table></figure><p>In this example the comment describes why                              is assigned the value six, and where the six was derived from. The comment does not describe where                              will be used. Here are some more examples: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// Open opens the named file for reading.</span><br><span class="line">// If successful, methods on the returned file can be used for reading.</span><br><span class="line">// queue all dependant actions</span><br><span class="line">var results []chan error</span><br><span class="line">for _, dep := range a.Deps &#123;</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">results = append(results, execute(seen, dep))</span><br><span class="line">return &amp;v2.Cluster_CommonLbConfig&#123;</span><br><span class="line">    // Disable HealthyPanicThreshold</span><br><span class="line">        HealthyPanicThreshold: &amp;envoy_type.Percent&#123;</span><br><span class="line">            Value: 0,</span><br></pre></td></tr></table></figure><p>}, } </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> </p><p>12/45 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">randomNumber</span><br><span class="line">randomNumber</span><br></pre></td></tr></table></figure><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">const (</span><br><span class="line">    StatusContinue           = 100 // RFC 7231, 6.2.1</span><br><span class="line">    StatusSwitchingProtocols = 101 // RFC 7231, 6.2.2</span><br><span class="line">    StatusProcessing         = 102 // RFC 2518, 10.1</span><br><span class="line">    StatusOK                 = 200 // RFC 7231, 6.3.1</span><br></pre></td></tr></table></figure><p>In the context of HTTP the number 100 is known as StatusContinue , as defined in RFC 7231, section 6.2.1. For variables without an initial value, the comment should describe who is responsible for </p><p>// sizeCalculationDisabled indicates whether it is safe // to calculate Typesâ€™ widths and alignments. See dowidth. var sizeCalculationDisabled bool </p><p>TIP </p><p>initialising this variable. </p><p>Here the comment lets the reader know that the dowidth function is responsible for maintaining the state of sizeCalculationDisabled . </p><p>Hiding in plain sight </p><p>This is a tip from Kate Gregory. [3] Sometimes youâ€™ll find a better name for a variable hiding in a comment. </p><p>The comment was added by the author because registry doesnâ€™t explain enough about its purpose â€”itâ€™s a registry, but a registry of what? </p><p>By renaming the variable to sqlDrivers its now clear that the purpose of this variable is to hold SQL drivers. </p><p>var sqlDrivers = make(map[string]*sql.Driver) </p><p>Now the comment is redundant and can be removed. </p><p>// registry of SQL drivers<br> var registry = make(map[string]*sql.Driver) </p><p>TIP </p><p>3.2. Always document public symbols </p><p>Because godoc is the documentation for your package, you should always add a comment for every public symbolâ€” variable, constant, function, and methodâ€”declared in your package. </p><p>Here are two rules from the Google Style guide </p><p>Any public function that is not both obvious and short must be commented.<br> Any function in a library must be commented regardless of length or complexity </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 13/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">package ioutil</span><br><span class="line">// ReadAll reads from r until an error or EOF and returns the data it read.</span><br><span class="line">// A successful call returns err == nil, not err == EOF. Because ReadAll is</span><br><span class="line">// defined to read from src until EOF, it does not treat an EOF from Read</span><br><span class="line">// as an error to be reported.</span><br><span class="line">func ReadAll(r io.Reader) ([]byte, error)</span><br></pre></td></tr></table></figure><p>There is one exception to this rule; you donâ€™t need to document methods that implement an interface. Specifically donâ€™t do this: </p><p>This comment says nothing. It doesnâ€™t tell you what the method does, in fact itâ€™s worse, it tells you to go look somewhere else for the documentation. In this situation I suggest removing the comment entirely. </p><p>Here is an example from the io package </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">// Read implements the io.Reader interface</span><br><span class="line">func (r *FileReader) Read(buf []byte) (int, error)</span><br><span class="line">// LimitReader returns a Reader that reads from r</span><br><span class="line">// but stops with EOF after n bytes.</span><br><span class="line">// The underlying implementation is a *LimitedReader.</span><br><span class="line">func LimitReader(r Reader, n int64) Reader &#123; return &amp;LimitedReader&#123;r, n&#125; &#125;</span><br><span class="line">// A LimitedReader reads from R but limits the amount of</span><br><span class="line">// data returned to just N bytes. Each call to Read</span><br><span class="line">// updates N to reflect the new amount remaining.</span><br><span class="line">// Read returns EOF when N &lt;= 0 or when the underlying R returns EOF.</span><br><span class="line">type LimitedReader struct &#123;</span><br><span class="line">    R Reader // underlying reader</span><br><span class="line">    N int64  // max bytes remaining</span><br><span class="line">&#125;</span><br><span class="line">func (l *LimitedReader) Read(p []byte) (n int, err error) &#123;</span><br><span class="line">    if l.N &lt;= 0 &#123;</span><br><span class="line">        return 0, EOF</span><br><span class="line">    &#125;</span><br><span class="line">    if int64(len(p)) &gt; l.N &#123;</span><br><span class="line">        p = p[0:l.N]</span><br><span class="line">    &#125;</span><br><span class="line">    n, err = l.R.Read(p)</span><br><span class="line">    l.N -= int64(n)</span><br><span class="line">    return</span><br></pre></td></tr></table></figure><p>} </p><p>Note that the                              declaration is directly preceded by the function that uses it, and the declaration of follows the declaration of LimitedReader itself. Even though LimitedReader.Read has no </p><p>documentation itself, its clear from that it is an implementation of io.Reader . </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LimitedReader</span><br><span class="line">LimitedReader.Read</span><br></pre></td></tr></table></figure><p>TIP </p><p>Before you write the function, write the comment describing the function. If you find it hard to write the comment, then itâ€™s a sign that the code youâ€™re about to write is going to be hard to understand. </p><p>3.2.1. Donâ€™t comment bad code, rewrite it </p><p>â€œ<a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 14/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>â€œ Donâ€™t comment bad code â€” rewrite it â€” Brian Kernighan </p><p>Comments highlighting the grossness of a particular piece of code are not sufficient. If you encounter one of these comments, you should raise an issue as a reminder to refactor it later. It is okay to live with technical debt, as long as the amount of debt is known. </p><p>The tradition in the standard library is to annotate a TODO style comment with the username of the person who noticed it. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">// TODO(dfc) this is O(N^2), find a faster way to do this.</span><br></pre></td></tr></table></figure><p>The username is not a promise that that person has committed to fixing the issue, but they may be the best person to ask when the time comes to address it. Other projects annotate TODOs with a date or an issue number. </p><p>â€œ3.2.2. Rather than commenting a block of code, refactor it </p><p>Good code is its own best documentation. As youâ€™re about to add a comment, ask yourself, â€˜How can I improve the code so that this comment isnâ€™t needed?â€™ Improve the code and then document it to make it even clearer. </p><p>â€” Steve McConnell </p><p>Functions should do one thing only. If you find yourself commenting a piece of code because it is unrelated to the rest of the function, consider extracting it into a function of its own. </p><p>In addition to be easier to comprehend, smaller functions are easier to test in isolation, and now youâ€™ve isolated the orthogonal code into its own function, its name may be all the documentation required. </p><p>â€œ4. Package Design<br> Write shy code - modules that donâ€™t reveal anything unnecessary to other modules and that </p><p>donâ€™t rely on other modulesâ€™ implementations. </p><p>â€” Dave Thomas </p><p>Each Go package is in effect itâ€™s own small Go program. Just as the implementation of a function or method is unimportant to the caller, the implementation of the functions and methods and types that make your packageâ€™s public APIâ€”its behaviourâ€”is unimportant for the caller. </p><p>A good Go package should strive to have a low degree of source level coupling such that, as the project grows, changes to one package do not cascade across the code-base. These stop-the-world refactorings place a hard limit on the rate of change in a code base and thus the productivity of the members working in that code-base. </p><p>In this section weâ€™ll talk about designing a package including the packageâ€™s name, naming types, and tips for writing methods and functions. </p><p>4.1. A good package starts with its name </p><p>Writing a good Go package starts with the packageâ€™s name. Think of your packageâ€™s name as an elevator pitch to describe what it does using just one word. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> </p><p>15/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Just as I talked about names for variables in the previous section, the name of a package is very important. The rule of thumb I follow is not, â€œwhat types should I put in this package?â€. Instead the question I ask â€œwhat does service does package provide?â€ Normally the answer to that question is not â€œthis package provides the X typeâ€, but â€œthis package letâ€™s you speak HTTPâ€. </p><p>TIP Name your package after what is provides, not what it contains. 4.1.1. Good package names should be unique. </p><p>Within your project, each package name should be unique. This advice is pretty easy to follow if the advice that a packageâ€™s name should derive from its purposeâ€”if you find you have two packages which need the same name, it is likely either; </p><p>a. The name of the package is too generic. </p><p>b. The package overlaps another package of a similar name. In this case either you should review your design, or consider merging the packages. </p><p>4.2. Avoid package names like base , common , or util </p><p>A common cause of poor package names is what call utility packages. These are packages where common helpers and utility code congeals over time. As these packages contain an assortment of unrelated functions, their utility is hard to describe in terms of what the package provides. This often leads to the packageâ€™s name being derived from what the package containsâ€“utilities. </p><p>Package names like utils or helpers are commonly found in larger projects which have developed deep package hierarchies and want to share helper functions without encountering import loops. By extracting utility functions to new package the import loop is broken, but because the package stems from a design problem in the project, its name doesnâ€™t reflect its purpose, only its function of breaking the import cycle. </p><p>My recommendation to improve the name of utils or helpers packages is to analyse where they are called and if possible move the relevant functions into their callerâ€™s package. Even if this involves duplicating some helper code this is better than introducing an import dependency between two packages. </p><p>â€œ[A little] duplication is far cheaper than the wrong abstraction. â€” Sandy Metz </p><p>In the case where utility functions are used in many places prefer multiple packages, each focused on a single aspect, to a single monolithic package. </p><p>TIP Use plurals for naming utility packages. For example the strings for string handling utilities. </p><p>Packages with names like base or common are often found when functionality common to two or more implementations, or common types for a client and server, has been refactored into a separate package. I believe the solution to this is to reduce the number of packages, to combine the client, server, and common code into a single package named after the function of the package. </p><p>For example, the net/http package does not have client and                              sub packages, instead it has a client.go and server.go file, each holding their respective types, and a                              file for the common message transport code. </p><p>server </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> </p><p>16/45 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">transport.go</span><br></pre></td></tr></table></figure><p>2018/10/21 </p><p>Practical Go: Real world advice for writing maintainable Go programs </p><p>TIP </p><p>An identifierâ€™s name includes its package name. </p><p>Itâ€™s important to remember that the name of an identifier includes the name of its package. </p><p>The Get function from the net/http package becomes http.Get when referenced by another package. </p><p>The Reader type from the strings package becomes strings.Reader when imported into other packages. </p><p>The Error interface from the net package is clearly related to network errors. 4.3. Return early rather than nesting deeply </p><p>As Go does not use exceptions for control flow there is no requirement to deeply indent your code just to provide a top level structure for the try and catch blocks. Rather than the successful path nesting deeper and deeper to the right, Go code is written in a style where the success path continues down the screen as the function progresses. My friend Mat Ryer calls this practice â€˜line of sightâ€™ coding. [4] </p><p>This is achieved by using guard clauses; conditional blocks with assert preconditions upon entering a function. Here is an example from the bytes package, </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func (b *Buffer) UnreadRune() error &#123;</span><br><span class="line">    if b.lastRead &lt;= opInvalid &#123;</span><br></pre></td></tr></table></figure><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">        return errors.New(&quot;bytes.Buffer: UnreadRune: previous operation was not a successful</span><br><span class="line">ReadRune&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    if b.off &gt;= int(b.lastRead) &#123;</span><br><span class="line">        b.off -= int(b.lastRead)</span><br><span class="line">    &#125;</span><br><span class="line">    b.lastRead = opInvalid</span><br></pre></td></tr></table></figure><p>return nil } </p><p>Upon entering UnreadRune the state of b.lastRead is checked and if the previous operation was not an error is returned immediately. From there the rest of the function proceeds with the assertion that is greater that opInvalid . </p><p>Compare this to the same function written without a guard clause, </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func (b *Buffer) UnreadRune() error &#123;</span><br><span class="line">    if b.lastRead &gt; opInvalid &#123;</span><br><span class="line">        if b.off &gt;= int(b.lastRead) &#123;</span><br><span class="line">            b.off -= int(b.lastRead)</span><br><span class="line">        &#125;</span><br><span class="line">        b.lastRead = opInvalid</span><br><span class="line">        return nil</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return errors.New(&quot;bytes.Buffer: UnreadRune: previous operation was not a successful</span><br><span class="line">ReadRune&quot;)</span><br></pre></td></tr></table></figure><p>} </p><p>GO </p><p>The body of the successful case, the most common, is nested inside the first if condition and the successful exit condition, return nil , has to be discovered by careful matching of closing braces. The final line of the function now returns an error, and the called must trace the execution of the function back to the matching opening brace to know </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 17/45 </p><p>ReadRune </p><p>b.lastRead </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>when control will reach this point. </p><p>This is more error prone for the reader, and the maintenance programmer, hence why Go prefer to use guard clauses and returning early on errors. </p><p>4.4. Make the zero value useful </p><p>Every variable declaration, assuming no explicit initialiser is provided, will be automatically initialised to a value that matches the contents of zeroed memory. This is the values zero value. The type of the value determines its zero value; for numeric types it is zero, for pointer types nil, the same for slices, maps, and channels. </p><p>This property of always setting a value to a known default is important for safety and correctness of your program and can make your Go programs simpler and more compact. This is what Go programmers talk about when they say â€œgive your structs a useful zero valueâ€. </p><p>Consider the sync.Mutex type. sync.Mutex contains two unexported integer fields, representing the mutexâ€™s internal state. Thanks to the zero value those fields will be set to will be set to 0 whenever a sync.Mutex is declared. </p><p>sync.Mutex has been deliberately coded to take advantage of this property, making the type usable without explicit initialisation. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type MyInt struct &#123;</span><br><span class="line">    mu  sync.Mutex</span><br></pre></td></tr></table></figure><p>val int } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    var i MyInt</span><br><span class="line">    // i.mu is usable without explicit initialisation.</span><br><span class="line">    i.mu.Lock()</span><br><span class="line">    i.val++</span><br><span class="line">    i.mu.Unlock()</span><br></pre></td></tr></table></figure><p>} </p><p>GO </p><p>Another example of a type with a useful zero value is bytes.Buffer . You can declare a bytes.Buffer and start writing to it without explicit initialisation. </p><p>A useful property of slices is their zero value is nil . This makes sense if we look at the runtimeâ€™s definition of a slice header. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    var b bytes.Buffer</span><br><span class="line">    b.WriteString(&quot;Hello, world!\n&quot;)</span><br><span class="line">    io.Copy(os.Stdout, &amp;b)</span><br></pre></td></tr></table></figure><p>} </p><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">type slice struct &#123;</span><br><span class="line">        array *[...]T // pointer to the underlying array</span><br><span class="line">        len   int</span><br><span class="line">        cap   int</span><br></pre></td></tr></table></figure><p>} </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 18/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>The zero value of this struct would imply len and cap have the value 0 , and array , the pointer to memory holding the contents of the sliceâ€™s backing array, would be nil . This means you donâ€™t need to explicitly make a slice, you can just declare it. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    // s := make([]string, 0)</span><br><span class="line">    // s := []string&#123;&#125;</span><br><span class="line">    var s []string</span><br><span class="line">    s = append(s, &quot;Hello&quot;)</span><br><span class="line">    s = append(s, &quot;world&quot;)</span><br><span class="line">    fmt.Println(strings.Join(s, &quot; &quot;))</span><br></pre></td></tr></table></figure><p>} </p><p>GO </p><p>var s []string is similar to the two commented lines above it, but not identical. It is possible to detect the difference between a slice value that is nil and a slice value that has zero length. The following code will output false. </p><p>NOTE </p><p>A surprising, but useful, property of uninitialised pointer variablesâ€”nil pointersâ€”is you can call methods on types that have a nil value. This can be used to provide default values simply. </p><p>func main() {<br> var s1 = []string{}<br> var s2 []string fmt.Println(reflect.DeepEqual(s1, s2)) </p><p>} </p><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type Config struct &#123;</span><br><span class="line">    path string</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">func (c *Config) Path() string &#123;</span><br><span class="line">    if c == nil &#123;</span><br><span class="line">        return &quot;/usr/home&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    return c.path</span><br><span class="line">&#125;</span><br><span class="line">func main() &#123;</span><br><span class="line">    var c1 *Config</span><br><span class="line">    var c2 = &amp;Config&#123;</span><br><span class="line">        path: &quot;/export&quot;,</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    fmt.Println(c1.Path(), c2.Path())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p>4.5. Avoid package level state </p><p>The key to writing maintainable programs is that they should be loosely coupledâ€”a change to one package should have a low probability of affecting another package that does not directly depend on the first. </p><p>There are two excellent ways to achieve loose coupling in Go </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> </p><p>19/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>\1. Use interfaces to describe the behaviour your functions or methods require. 2. Avoid the use of global state. </p><p>In Go we can declare variables at the function or method scope, and also at the package scope. When the variable is public, given a identifier starting with a capital letter, then its scope is effectively global to the entire programâ€”any package may observe the type and contents of that variable at any time. </p><p>Mutable global state introduces tight coupling between independent parts of your program as global variables become an invisible parameter to every function in your program! Any function that relies on a global variable can be broken if that variableâ€™s type changes. Any function that relies on the state of a global variable can be broken if another part of the program changes that variable. </p><p>If you want to reduce the coupling a global variable creates, </p><p>\1. Move the relevant variables as fields on structs that need them.<br> \2. Use interfaces to reduce the coupling between the behaviour and the implementation of that behaviour. </p><p>\5. Project Structure </p><p>Letâ€™s talk about combining packages together into a project. Commonly this will be a single git repository, but in the future Go developers will use module and project interchangeably. </p><p>Just like a package, each project should have a clear purpose. If your project is a library, it should provide one thing, say XML parsing, or logging. You should avoid combining multiple purposes into a single package, this will help avoid the dreaded common library. </p><p>In my experience, the common repo ends up tightly coupled to its biggest consumer and that makes TIP it hard to back-port fixes without upgrading both common and consumer in lock step, bringing in a </p><p>lot of unrelated changes and API breakage along the way. </p><p>If your project is an application, like your web application, Kubernetes controller, and so on, then you might have one or more                              packages inside your project. For example, the Kubernetes controller I work on has a single </p><p>package which serves as both the server deployed to a Kubernetes cluster, and a client for debugging </p><p>purposes. </p><p>5.1. Consider fewer, larger packages </p><p>One of the things I tend to pick up in code review for programmers who are transitioning from other languages to Go is they tend to overuse packages. </p><p>Go does not provide elaborate ways of establishing visibility; thing Javaâ€™s public , protected , private , and implicit default access modifiers. There is no equivalent of C++â€™s notion of friend classes. </p><p>In Go we have only two access modifiers, public and private, indicated by the capitalisation of the first letter of the identifier. If an identifier is public, itâ€™s name starts with a capital letter, that identifier can be referenced by any other Go package. </p><p>NOTE You may hear people say exported and not exported as synonyms for public and private.<br> Given the limited controls available to control access to a packageâ€™s symbols, what practices should Go programmers </p><p>follow to avoid creating over-complicated package hierarchies? </p><p>main </p><p>cmd/contour </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 20/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>TIP Every package, with the exception of cmd/ and internal/ , should contain some source code. </p><p>The advice I find myself repeating is to prefer fewer, larger packages. Your default position should be to not create a new package. That will lead to too many types being made public creating a wide, shallow, API surface for your package.. </p><p>The sections below explores this suggestion in more detail. </p><p>TIP </p><p>Coming from Java? </p><p>If youâ€™re coming from a Java or C# background, consider this rule of thumb. - A Java package is equivalent to a single .go source file. - A Go package is equivalent to a whole Maven module or .NET assembly. </p><p>5.1.1. Arrange code into les by import statements </p><p>If youâ€™re arranging your packages by what they provide to callers, should you do the same for files within a Go package? How do you know when you should break up a .go file into multiple ones? How do you know when youâ€™ve gone to far and should consider consolidating .go file? </p><p>Here are the rules of thumb I use:<br> Start each package with one file. Give that file the same name as the name of the folder. eg. package http </p><p>should be placed in a file called in a directory named http . </p><p>As your package grows you may decide to split apart the various responsibilities into different files. eg,<br> contains the `Request and Response types, client.go contains the Client type, server.go </p><p>contains the type. </p><p>If you find your files have similar import declarations, consider combining them. Alternatively, identify the differences between the import sets and move those </p><p>Different files should be responsible for different areas of the package.                              may be responsible for marshalling of HTTP requests and responses on and off the network,                              may contain the low level network handling logic, client.go and server.go implement the HTTP business logic of request construction or routing, and so on. </p><p>TIP Prefer nouns for source file names. </p><p>The Go compiler compiles each package in parallel. Within a package the compiler compiles each NOTE function (methods are just fancy functions in Go) in parallel. Changing the layout of your code within </p><p>a package does not affect compilation time. </p><p>5.1.2. Prefer internal tests to external tests </p><p>The go tool supports writing your testing package tests in two places. Assuming your package is called http2 , you can write a file and use the declaration. Doing so will compile the code in </p><p>as if it were part of the package. This is known colloquially as an internal test. </p><p>The go tool also supports a special package declaration, ending in test , ie., package http_test . This allows your test files to live alongside your code in the same package, however when those tests are compiled they are not part of your packageâ€™s code, they live in their own package. This allows you to write your tests as if you were another package calling into your code. This is known as an _external test. </p><p>.go </p><p>http.go </p><p>messages.go </p><p>Server </p><p>messages.go </p><p>http.go </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http2_test.go</span><br></pre></td></tr></table></figure><p>package http2 </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http2_test.go</span><br></pre></td></tr></table></figure><p>http2 </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 21/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>I recommend using internal tests when writing unit tests for your package. This allows you to test each function or method directly, avoiding the bureaucracy of external testing. </p><p>However, you should place your Example test functions in an external test file. This ensures that when viewed in godoc, the examples have the appropriate package prefix and can be easily copy pasted. </p><p>TIP </p><p>Avoid elaborate package hierarchies, resist the desire to apply taxonomy </p><p>With one exception, which weâ€™ll talk about next, the hierarchy of Go packages has no meaning to the go tool. For example, the net/http package is not a child or sub-package of the net package. </p><p>If you find you have created intermediate directories in your project which contain no .go files, you may have failed to follow this advice. </p><p>5.1.3. Use internal packages to reduce your public API surface </p><p>If your project contains multiple packages you may have some exported functions which are intended to be used by other packages in your project, but are not intended to be part of your projectâ€™s public API. If you find yourself in this situation the go tool recognises a special folder nameâ€”not package nameâ€“, internal/ which can be used to place code which is public to your project, but private to other projects. </p><p>To create such a package, place it in a directory named internal/ or in a sub-directory of a directory named internal/ . When the go command sees an import of a package with                              in its path, it verifies that the </p><p>package doing the import is within the tree rooted at the parent of the                              directory.<br> For example, a package can be imported only by code in the directory tree rooted at â€¦ </p><p>/a/b/c . It cannot be imported by code in                              or in any other repository. [5] 5.2. Keep package main small as small as possible </p><p>Your main function, and                              package should do as little as possible. This is because main.main acts as a singleton; there can only be one                              function in a program, including tests. </p><p>Because main.main is a singleton there are a lot of assumptions built into the things that main.main will call that they will only be called during main.main or main.init, and only called once. This makes it hard to write tests for code written in main.main , thus you should aim to move as much of your business logic out of your main function and ideally out of your main package. </p><p>TIP </p><p>main should parse flags, open connections to databases, loggers, and such, then hand off execution to a high level object. </p><p>\6. API Design </p><p>The last piece of design advice Iâ€™m going to give today I feel is the most important. </p><p>All of the suggestions Iâ€™ve made so far are just that, suggestions. These are the way I try to write my Go, but Iâ€™m not going to push them hard in code review. </p><p>However when it comes to reviewing APIs during code review, I am less forgiving. This is because everything Iâ€™ve talked about so far can be fixed without breaking backward compatibility; they are, for the most part, implementation details. </p><p>When it comes to the public API of a package, it pays to put considerable thought into the initial design, because changing that design later is going to be disruptive for people who are already using your API. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 22/45 </p><p>internal </p><p>main </p><p>â€¦/a/b/g </p><p>internal </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.../a/b/c/internal/d/e/f</span><br></pre></td></tr></table></figure><p>main </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>â€œ6.1. Design APIs that are hard to misuse.<br> APIs should be easy to use and hard to misuse. </p><p>â€” Josh Bloch [3] </p><p>If you take anything away from this presentation, it should be this advice from Josh Bloch. If an API is hard to use for simple things, then every invocation of the API will look complicated. When the actual invocation of the API is complicated it will be less obvious and more likely to be overlooked. </p><p>6.1.1. Be wary of functions which take several parameters of the same type </p><p>A good example of a simple looking, but hard to use correctly API is one which takes two or more parameters of the same type. Letâ€™s compare two function signatures: </p><p>Whatâ€™s the difference between these two functions? Obviously one returns the maximum of two numbers, the other copies a file, but thatâ€™s not the important thing. </p><p>Max is commutative; the order of the parameters does not matter. The maximum of eight and ten is ten regardless of if I compare eight to ten or ten two eight. </p><p>However, this property does not hold true for CopyFile . </p><p>Which one of these statements made a backup of your presentation and which one overwrite your presentation with last weekâ€™s version? You canâ€™t tell without consulting the documentation. A code reviewer cannot know if youâ€™ve got the order correct without consulting the documentation. </p><p>One possible solution to this is to introduce a helper type which will be responsible for calling CopyFile correctly. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func Max(a, b int) int</span><br><span class="line">func CopyFile(to, from string) error</span><br><span class="line">Max(8, 10) // 10</span><br><span class="line">Max(10, 8) // 10</span><br><span class="line">CopyFile(&quot;/tmp/backup&quot;, &quot;presentation.md&quot;)</span><br><span class="line">CopyFile(&quot;presentation.md&quot;, &quot;/tmp/backup&quot;)</span><br><span class="line">type Source string</span><br><span class="line">func (src Source) CopyTo(dest string) error &#123;</span><br><span class="line">    return CopyFile(dest, string(src))</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    var from Source = &quot;presentation.md&quot;</span><br><span class="line">    from.CopyTo(&quot;/tmp/backup&quot;)</span><br></pre></td></tr></table></figure><p>} </p><p>GO </p><p>In this way CopyFile is always called correctlyâ€”this can be asserted with a unit testâ€”and can possibly be made private, further reducing the likelihood of misuse. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 23/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>TIP APIs with multiple parameters of the same type are hard to use correctly. 6.2. Design APIs for their default use case </p><p>A few years ago I gave a talk [6] about using functional options [7] to make APIs easier to use for their default case. </p><p>The gist of this talk was you should design your APIs for the common use case. Sad another way, your API should not require the caller to provide parameters which they donâ€™t care about. </p><p>6.2.1. Discourage the use of nil as a parameter </p><p>I opened this chapter with the suggestion that you shouldnâ€™t force the caller of your API into providing you parameters when they donâ€™t really care what those parameters mean. This is what I mean when I say design APIs for their default use case. </p><p>Hereâ€™s an example from the net/http package </p><p>package http </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// ListenAndServe listens on the TCP network address addr and then calls</span><br><span class="line">// Serve with handler to handle requests on incoming connections.</span><br><span class="line">// Accepted connections are configured to enable TCP keep-alives.</span><br><span class="line">//</span><br><span class="line">// The handler is typically nil, in which case the DefaultServeMux is used.</span><br><span class="line">//</span><br><span class="line">// ListenAndServe always returns a non-nil error.</span><br><span class="line">func ListenAndServe(addr string, handler Handler) error &#123;</span><br></pre></td></tr></table></figure><p>ListenAndServe takes two parameters, a TCP address to listen for incoming connections, and http.Handler to handle the incoming HTTP request. Serve allows the second parameter to be nil , and notes that usually the caller will pass nil indicating that they want to use http.DefaultServeMux as the implicit parameter. </p><p>Now the caller of Serve has two ways to do the same thing. </p><p>Both do exactly the same thing. </p><p>This                              behaviour is viral. The http package also has a http.Serve helper, which you can reasonably imagine that builds upon like this </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.ListenAndServe(&quot;0.0.0.0:8080&quot;, nil)</span><br><span class="line">http.ListenAndServe(&quot;0.0.0.0:8080&quot;, http.DefaultServeMux)</span><br></pre></td></tr></table></figure><p>nil </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ListenAndServe</span><br><span class="line">func ListenAndServe(addr string, handler Handler) error &#123;</span><br><span class="line">    l, err := net.Listen(&quot;tcp&quot;, addr)</span><br><span class="line">    if err != nil &#123;</span><br></pre></td></tr></table></figure><p>return err } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">    defer l.Close()</span><br><span class="line">    return Serve(l, handler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 24/45 </p><p>http.Serve </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ListenAndServe</span><br></pre></td></tr></table></figure><p>nil<br> handler </p><p>DefaultServeMux`â€ logic. </p><p>http.Serve </p><p>Accepting `nil </p><p>nil </p><p>Serve </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.Serve(nil, nil)</span><br><span class="line">          http.ListenAndServe</span><br><span class="line">DefaultServeMux</span><br></pre></td></tr></table></figure><p>nil </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const root = http.Dir(&quot;/htdocs&quot;)</span><br><span class="line">http.Handle(&quot;/&quot;, http.FileServer(root))</span><br><span class="line">http.ListenAndServe(&quot;0.0.0.0:8080&quot;, nil)</span><br></pre></td></tr></table></figure><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">const root = http.Dir(&quot;/htdocs&quot;)</span><br><span class="line">http.Handle(&quot;/&quot;, http.FileServer(root))</span><br><span class="line">http.ListenAndServe(&quot;0.0.0.0:8080&quot;, http.DefaultServeMux)</span><br></pre></td></tr></table></figure><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">const root = http.Dir(&quot;/htdocs&quot;)</span><br><span class="line">mux := http.NewServeMux()</span><br><span class="line">http.Handle(&quot;/&quot;, http.FileServer(root))</span><br><span class="line">http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux)</span><br></pre></td></tr></table></figure><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func ShutdownVMs(ids []string) error</span><br></pre></td></tr></table></figure><p>2018/10/21 </p><p>Practical Go: Real world advice for writing maintainable Go programs </p><p>Because behaviour. In fact, </p><p>permits the caller to pass for the second parameter, also supports this is the one that implements the â€œif is nil , use </p><p>for one parameter may lead the caller into thinking they can pass for both parameters. However calling like this, </p><p>results in an ugly panic.<br> TIP Donâ€™t mix nil and non nil-able parameters in the same function signature. </p><p>The author of was trying to make the API userâ€™s life easier in the common case, but possibly made the package harder to use safely. </p><p>There is no difference in line count between using explicitly, or implicitly via . </p><p>verses </p><p>and a was this confusion really worth saving one line? </p><p>TIP </p><p>Give serious consideration to how much time helper functions will save the programmer. Clear is better than concise. </p><p>Avoid public APIs with test only parameters </p><p>TIP Avoid exposing APIs with values who only differ in test scope. Instead, use Public wrappers to hide those parameters, use test scoped helpers to set the property in test scope. </p><p>6.2.2. Prefer var args to []T parameters </p><p>Itâ€™s very common to write a function or method that takes a slice of values. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> </p><p>25/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>This is just an example I made up, but its common to a lot of code Iâ€™ve worked on. The problem with signatures like these is they presume that they will be called with more than one entry. However, what I have found is many times these type of functions are called with only one argument, which has to be â€œboxedâ€ inside a slice just to meet the requirements of the functions signature. </p><p>Additionally, because the ids parameter is a slice, you can pass an empty slice or nil to the function and the compiler will be happy. This adds extra testing load because you should cover these cases in your testing. </p><p>To give an example of this class of API, recently I was refactoring a piece of logic that required me to set some extra fields if at least one of a set of parameters was non zero. The logic looked like this: </p><p>As the if statement was getting very long I wanted to pull the logic of the check out into its own function. This is what I came up with: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if svc.MaxConnections &gt; 0 || svc.MaxPendingRequests &gt; 0 || svc.MaxRequests &gt; 0 ||</span><br><span class="line">svc.MaxRetries &gt; 0 &#123;</span><br><span class="line">    // apply the non zero parameters</span><br><span class="line">&#125;</span><br><span class="line">// anyPostive indicates if any value is greater than zero.</span><br><span class="line">func anyPositive(values ...int) bool &#123;</span><br><span class="line">    for _, v := range values &#123;</span><br><span class="line">        if v &gt; 0 &#123;</span><br></pre></td></tr></table></figure><p>return true } </p><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p>This enabled me to make the condition where the inner block will be executed clear to the reader: </p><p>However there is a problem with anyPositive , someone could accidentally invoke it like this if anyPositive() { â€¦ } </p><p>In this case anyPositive would return false because it would execute zero iterations and immediately return false . This isnâ€™t the worst thing in the world â€” that would be if anyPositive returned true when passed no </p><p>arguments. </p><p>Nevertheless it would be be better if we could change the signature of anyPositive to enforce that the caller should pass at least one argument. We can do that by combining normal and vararg parameters like this: </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if anyPositive(svc.MaxConnections, svc.MaxPendingRequests, svc.MaxRequests, svc.MaxRetries) &#123;</span><br><span class="line">        // apply the non zero parameters</span><br></pre></td></tr></table></figure><p>} </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 26/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Now anyPositive cannot be called with less than one argument. 6.3. Let functions dene the behaviour they requires </p><p>Letâ€™s say Iâ€™ve been given a task to write a function that persists a Document structure to disk. </p><p>I could specify this function, Save, which takes an *os.File as the destination to write the Document . But this has a few problems </p><p>The signature of Save precludes the option to write the data to a network location. Assuming that network storage is likely to become requirement later, the signature of this function would have to change, impacting all its callers. </p><p>Save is also unpleasant to test, because it operates directly with files on disk. So, to verify its operation, the test would have to read the contents of the file after being written. </p><p>And I would have to ensure that f was written to a temporary location and always removed afterwards. </p><p><em>os.File also defines a lot of methods which are not relevant to , like reading directories and checking to see if a path is a symlink. It would be useful if the signature of the function could describe only the parts of </em>os.File that were relevant. </p><p>What can we do ? </p><p>Using io.ReadWriteCloser we can apply the interface segregation principle to redefine Save to take an interface that describes more general file shaped things. </p><p>With this change, any type that implements the io.ReadWriteCloser interface can be substituted for the previous *os.File . </p><p>This makes Save both broader in its application, and clarifies to the caller of Save which methods of the *os.File type are relevant to its operation. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Save writes the contents of doc to the file f.</span><br><span class="line">func Save(f *os.File, doc *Document) error</span><br></pre></td></tr></table></figure><p>Save </p><p>Save </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// Save writes the contents of doc to the supplied</span><br><span class="line">// ReadWriterCloser.</span><br><span class="line">func Save(rwc io.ReadWriteCloser, doc *Document) error</span><br><span class="line">// anyPostive indicates if any value is greater than zero.</span><br><span class="line">func anyPositive(first int, rest ...int) bool &#123;</span><br><span class="line">    if first &gt; 0 &#123;</span><br><span class="line">        return true</span><br><span class="line">    &#125;</span><br><span class="line">    for _, v := range rest &#123;</span><br><span class="line">        if v &gt; 0 &#123;</span><br><span class="line">            return true</span><br></pre></td></tr></table></figure><p>} } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 27/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>And as the author of I no longer have the option to call those unrelated methods on as it is hidden behind the interface. </p><p>But we can take the interface segregation principle a bit further. </p><p>Firstly, it is unlikely that if Save follows the single responsibility principle, it will read the file it just wrote to verify its contentsâ€”that should be responsibility of another piece of code. </p><p>So we can narrow the specification for the interface we pass to Save to just writing and closing.<br> Secondly, by providing Save with a mechanism to close its stream, which we inherited in this desire to make it still </p><p>look like a file, this raises the question of under what circumstances will wc be closed.<br> Possibly Save will call Close unconditionally, or perhaps Close will be called in the case of success. </p><p>This presents a problem for the caller of Save as it may want to write additional data to the stream after the document is written. </p><p>A better solution would be to redefine Save to take only an io.Writer , stripping it completely of the responsibility to do anything but write data to a stream. </p><p>By applying the interface segregation principle to our Save function, the results has simultaneously been a function which is the most specific in terms of its requirementsâ€”it only needs a thing that is writableâ€”and the most general in its function, we can now use Save to save our data to anything which implements io.Writer. </p><p>\7. Error handling </p><p>Iâ€™ve given several presentations about error handling [8] and written a lot about error handling on my blog. I also spoke a lot about error handling in yesterdayâ€™s session so I wonâ€™t repeat what Iâ€™ve said. </p><p><a href="https://dave.cheney.net/2014/12/24/inspecting-errors" target="_blank" rel="noopener">https://dave.cheney.net/2014/12/24/inspecting-errors</a> <a href="https://dave.cheney.net/2016/04/07/constant-errors" target="_blank" rel="noopener">https://dave.cheney.net/2016/04/07/constant-errors</a> </p><p>Instead I want to cover two other areas related to error handling. </p><p>7.1. Eliminate error handling by eliminating errors </p><p>If you were in my presentation yesterday I talked about the draft proposals for improving error handling. But do you know what is better than an improved syntax for handling errors? Not needing to handle errors at all. </p><p>Save </p><p>*os.File </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Save writes the contents of doc to the supplied</span><br><span class="line">// WriteCloser.</span><br><span class="line">func Save(wc io.WriteCloser, doc *Document) error</span><br><span class="line">// Save writes the contents of doc to the supplied</span><br><span class="line">// Writer.</span><br><span class="line">func Save(w io.Writer, doc *Document) error</span><br></pre></td></tr></table></figure><p>NOTE </p><p>Iâ€™m not saying â€œremove your error handlingâ€. What I am suggesting is, change your code so you do not have errors to handle. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">io.ReadWriteCloser</span><br></pre></td></tr></table></figure><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 28/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>This section draws inspiration from John Ousterhoutâ€™s recently book, A philosophy of Software Design [9]. One of the chapters in that book is called â€œDefine Errors Out of Existenceâ€. Weâ€™re going to try to apply this advice to Go. </p><p>7.1.1. Counting lines </p><p>Letâ€™s write a function to count the number of lines in a file. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func CountLines(r io.Reader) (int, error) &#123;</span><br><span class="line">    var (</span><br><span class="line">        br    = bufio.NewReader(r)</span><br><span class="line">        lines int</span><br><span class="line">        err   error</span><br></pre></td></tr></table></figure><p>) </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for &#123;</span><br><span class="line">    _, err = br.ReadString(&apos;\n&apos;)</span><br><span class="line">    lines++</span><br><span class="line">    if err != nil &#123;</span><br></pre></td></tr></table></figure><p>break } </p><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if err != io.EOF &#123;</span><br><span class="line">    return 0, err</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return lines, nil</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p>Because weâ€™re following our advice from previous sections, CountLines takes an io.Reader, not a *File; its the job of the caller to provide the io.Reader whoâ€™s contents we want to count. </p><p>We construct a bufio.Reader , and then sit in a loop calling the ReadString method, incrementing a counter until we reach the end of the file, then we return the number of lines read. </p><p>At least thatâ€™s the code we want to write, but instead this function is made more complicated by error handling. For example, there is this strange construction, </p><p>We increment the count of lines before checking the errorâ€”that looks odd.<br> The reason we have to write it this way is ReadString will return an error if it encounters and end-of-file before </p><p>hitting a newline character. This can happen if there is no final newline in the file.<br> To try to fix this, we rearrange the logic to increment the line count, then see if we need to exit the loop. </p><p>NOTE this logic still isnâ€™t perfect, can you spot the bug? </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_, err = br.ReadString(&apos;\n&apos;)</span><br><span class="line">lines++</span><br><span class="line">if err != nil &#123;</span><br></pre></td></tr></table></figure><p>break } </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 29/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>But weâ€™re not done checking errors yet. will return when it hits the end of the file. This is expected,                                  needs some way of saying stop, there is nothing more to read. So before we return the error to the caller of                                  , we need to check if the error was not io.EOF , and in that case propagate it up, otherwise we return nil to say that everything worked fine. </p><p>I think this is a good example of Russ Coxâ€™s observation that error handling can obscure the operation of the function. Letâ€™s look at an improved version. </p><p>ReadString </p><p>io.EOF </p><p>ReadString </p><p>CountLine </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func CountLines(r io.Reader) (int, error) &#123;</span><br><span class="line">    sc := bufio.NewScanner(r)</span><br><span class="line">    lines := 0</span><br><span class="line">    for sc.Scan() &#123;</span><br><span class="line">        lines++</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">    return lines, sc.Err()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p>This improved version switches from using bufio.Reader to bufio.Scanner . </p><p>Under the hood bufio.Scanner uses , but it adds a nice layer of abstraction which helps remove the error handling with obscured the operation of                                  . </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bufio.Reader</span><br></pre></td></tr></table></figure><p>CountLines </p><p>NOTE </p><p>The method, the body of our </p><p>bufio.Scanner can scan for any pattern, but by default it looks for newlines. </p><p>returns true if the scanner has matched a line of text and has not encountered an error. So, loop will be called only when there is a line of text in the scannerâ€™s buffer. This means our revised </p><p>sc.Scan() </p><p>for </p><p>CountLines correctly handles the case where there is no trailing newline, and also handles the case where the file was empty. </p><p>Secondly, as sc.Scan returns false once an error is encountered, our for loop will exit when the end-of-file is reached or an error is encountered. The type memoises the first error it encountered and we can recover that error once weâ€™ve exited the loop using the method. </p><p>Lastly, sc.Err() takes care of handling io.EOF and will convert it to a nil if the end of file was reached without encountering another error. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bufio.Scanner</span><br></pre></td></tr></table></figure><p>sc.Err() </p><p>TIP </p><p>When you find yourself faced with overbearing error handling, try to extract some of the operations into a helper type. </p><p>7.1.2. WriteResponse </p><p>My second example is inspired from the Errors are values blog post [10]. </p><p>Earlier in this presentation Weâ€™ve seen examples dealing with opening, writing and closing files. The error handling is present, but not overwhelming as the operations can be encapsulated in helpers like ioutil.ReadFile and </p><p>ioutil.WriteFile . However when dealing with low level network protocols it becomes necessary to build the response directly using I/O primitives the error handling can become repetitive. Consider this fragment of a HTTP server which is constructing the HTTP response. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 30/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>First we construct the status line using fmt.Fprintf , and check the error. Then for each header we write the header key and value, checking the error each time. Lastly we terminate the header section with an additional \r\n , check the error, and copy the response body to the client. Finally, although we donâ€™t need to check the error from io.Copy , we need to translate it from the two return value form that io.Copy returns into the single return value that </p><p>WriteResponse returns.<br> Thatâ€™s a lot of repetitive work. But we can make it easier on ourselves by introducing a small wrapper type, </p><p>errWriter . </p><p>errWriter fulfils the io.Writer contract so it can be used to wrap an existing io.Writer . errWriter passes writes through to its underlying writer until an error is detected. From that point on, it discards any writes and returns the previous error. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">type Header struct &#123;</span><br><span class="line">    Key, Value string</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">type Status struct &#123;</span><br><span class="line">    Code   int</span><br><span class="line">    Reason string</span><br><span class="line">&#125;</span><br><span class="line">func WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error &#123;</span><br><span class="line">    _, err := fmt.Fprintf(w, &quot;HTTP/1.1 %d %s\r\n&quot;, st.Code, st.Reason)</span><br><span class="line">    if err != nil &#123;</span><br></pre></td></tr></table></figure><p>return err } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for _, h := range headers &#123;</span><br><span class="line">    _, err := fmt.Fprintf(w, &quot;%s: %s\r\n&quot;, h.Key, h.Value)</span><br><span class="line">    if err != nil &#123;</span><br></pre></td></tr></table></figure><p>return err } </p><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if _, err := fmt.Fprint(w, &quot;\r\n&quot;); err != nil &#123;</span><br><span class="line">    return err</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">_, err = io.Copy(w, body)</span><br></pre></td></tr></table></figure><p>return err } </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 31/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Applying errWriter to WriteResponse dramatically improves the clarity of the code. Each of the operations no longer needs to bracket itself with an error check. Reporting the error is moved to the end of the function by inspecting the ew.err field, avoiding the annoying translation from `io.Copyâ€™s return values. </p><p>7.2. Only handle an error once </p><p>Lastly, I want to mention that you should only handle errors once. Handling an error means inspecting the error value, and making a single decision. </p><p>If you make less than one decision, youâ€™re ignoring the error. As we see here, the error from w.WriteAll is being discarded. </p><p>But making more than one decision in response to a single error is also problematic. The following is code that I come across frequently. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// WriteAll writes the contents of buf to the supplied writer.</span><br><span class="line">func WriteAll(w io.Writer, buf []byte) &#123;</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">w.Write(buf)</span><br><span class="line">type errWriter struct &#123;</span><br><span class="line">    io.Writer</span><br></pre></td></tr></table></figure><p>err error } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func (e *errWriter) Write(buf []byte) (int, error) &#123;</span><br><span class="line">    if e.err != nil &#123;</span><br><span class="line">        return 0, e.err</span><br><span class="line">    &#125;</span><br><span class="line">    var n int</span><br><span class="line">    n, e.err = e.Writer.Write(buf)</span><br><span class="line">    return n, nil</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error &#123;</span><br><span class="line">    ew := &amp;errWriter&#123;Writer: w&#125;</span><br><span class="line">    fmt.Fprintf(ew, &quot;HTTP/1.1 %d %s\r\n&quot;, st.Code, st.Reason)</span><br><span class="line">    for _, h := range headers &#123;</span><br><span class="line">        fmt.Fprintf(ew, &quot;%s: %s\r\n&quot;, h.Key, h.Value)</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">fmt.Fprint(ew, &quot;\r\n&quot;)</span><br><span class="line">io.Copy(ew, body)</span><br><span class="line">return ew.err</span><br></pre></td></tr></table></figure><p>} </p><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func WriteAll(w io.Writer, buf []byte) error &#123;</span><br><span class="line">    _, err := w.Write(buf)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Println(&quot;unable to write:&quot;, err) // annotated error goes to log file</span><br><span class="line">        return err                           // unannotated error returned to caller</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>return nil } </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 32/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>In this example if an error occurs during , a line will be written to a log file, noting the file and line that the error occurred, and the error is also returned to the caller, who possibly will log it, and return it, all the way back up to the top of the program. </p><p>The caller is probably doing the same </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func WriteConfig(w io.Writer, conf *Config) error &#123;</span><br><span class="line">    buf, err := json.Marshal(conf)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Printf(&quot;could not marshal config: %v&quot;, err)</span><br></pre></td></tr></table></figure><p>return err } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if err := WriteAll(w, buf); err != nil &#123;</span><br><span class="line">    log.Println(&quot;could not write config: %v&quot;, err)</span><br><span class="line">    return err</span><br></pre></td></tr></table></figure><p>} </p><p>return nil } </p><p>GO </p><p>So you get a stack of duplicate lines in your log file, </p><p>but at the top of the program you get the original error without any context. </p><p>I want to dig into this a little further because I donâ€™t see the problems with logging and returning as just a matter of personal preference. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">unable to write: io.EOF</span><br><span class="line">could not write config: io.EOF</span><br><span class="line">err := WriteConfig(f, &amp;conf)</span><br><span class="line">fmt.Println(err) // io.EOF</span><br><span class="line">func WriteConfig(w io.Writer, conf *Config) error &#123;</span><br><span class="line">    buf, err := json.Marshal(conf)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        log.Printf(&quot;could not marshal config: %v&quot;, err)</span><br><span class="line">        // oops, forgot to return</span><br><span class="line">    &#125;</span><br><span class="line">    if err := WriteAll(w, buf); err != nil &#123;</span><br><span class="line">        log.Println(&quot;could not write config: %v&quot;, err)</span><br><span class="line">        return err</span><br></pre></td></tr></table></figure><p>} </p><p>return nil } </p><p>GO </p><p>The problem I see a lot is programmers forgetting to return from an error. As we talked about earlier, Go style is to use guard clauses, checking preconditions as the function progresses and returning early. </p><p>In this example the author checked the error, logged it, but forgot to return. This has caused a subtle bug. </p><p>w.Write </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 33/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>The contract for error handling in Go says that you cannot make any assumptions about the contents of other return values in the presence of an error. As the JSON marshalling failed, the contents of buf are unknown, maybe it contains nothing, but worse it could contain a 1/2 written JSON fragment. </p><p>Because the programmer forgot to return after checking and logging the error, the corrupt buffer will be passed to WriteAll , which will probably succeed and so the config file will be written incorrectly. However the function will </p><p>return just fine, and the only indication that a problem happened will be a single log line complaining about marshalling JSON, not a failure to write the config. </p><p>7.2.1. Adding context to errors </p><p>The bug occurred because the author was trying to add context to the error message. They were trying to leave themselves a breadcrumb to point them back to the source of the error. </p><p>Letâ€™s look at another way to do the same thing using fmt.Errorf . </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func WriteConfig(w io.Writer, conf *Config) error &#123;</span><br><span class="line">    buf, err := json.Marshal(conf)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        return fmt.Errorf(&quot;could not marshal config: %v&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    if err := WriteAll(w, buf); err != nil &#123;</span><br><span class="line">        return fmt.Errorf(&quot;could not write config: %v&quot;, err)</span><br></pre></td></tr></table></figure><p>} </p><p>return nil } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">func WriteAll(w io.Writer, buf []byte) error &#123;</span><br><span class="line">    _, err := w.Write(buf)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        return fmt.Errorf(&quot;write failed: %v&quot;, err)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>return nil } </p><p>GO </p><p>By combining the annotation of the error with returning onto one line there it is harder to forget to return an error and avoid continuing accidentally. </p><p>If an I/O error occurs writing the file, the errorâ€™s `Error() method will report something like this; could not write config: write failed: input/output error </p><p>7.2.2. Wrapping errors with github.com/pkg/errors </p><p>The fmt.Errorf pattern works well for annotating the error message, but it does so at the cost of obscuring the type of the original error. Iâ€™ve argued that treating errors as opaque values is important to producing software which is loosely coupled, so the face that the type of the original error should not matter if the only thing you do with an error value is </p><p>\1. Check that it is not nil . 2. Print or log it. </p><p>However there are some cases, I believe they are infrequent, where you do need to recover the original error. In that case you can use something like my errors package to annotate errors like this </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 34/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Now the error reported will be the nice K&amp;D [11] style error, </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">could not read config: open failed: open /Users/dfc/.settings.xml: no such file or directory</span><br></pre></td></tr></table></figure><p>and the error value retains a reference to the original cause. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    _, err := ReadConfig()</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Printf(&quot;original error: %T %v\n&quot;, errors.Cause(err), errors.Cause(err))</span><br><span class="line">        fmt.Printf(&quot;stack trace:\n%+v\n&quot;, err)</span><br><span class="line">        os.Exit(1)</span><br></pre></td></tr></table></figure><p>} } </p><p>GO </p><p>Thus you can recover the original error and print a stack trace; </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">func ReadFile(path string) ([]byte, error) &#123;</span><br><span class="line">    f, err := os.Open(path)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        return nil, errors.Wrap(err, &quot;open failed&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    defer f.Close()</span><br><span class="line">    buf, err := ioutil.ReadAll(f)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        return nil, errors.Wrap(err, &quot;read failed&quot;)</span><br><span class="line">    &#125;</span><br><span class="line">    return buf, nil</span><br><span class="line">&#125;</span><br><span class="line">func ReadConfig() ([]byte, error) &#123;</span><br><span class="line">    home := os.Getenv(&quot;HOME&quot;)</span><br><span class="line">    config, err := ReadFile(filepath.Join(home, &quot;.settings.xml&quot;))</span><br><span class="line">    return config, errors.WithMessage(err, &quot;could not read config&quot;)</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    _, err := ReadConfig()</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        fmt.Println(err)</span><br></pre></td></tr></table></figure><p>os.Exit(1) } </p><p>} </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 35/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Using the errors package gives you the ability to add context to error values, in a way that is inspectable by both a human and a machine. If you came to my presentation yesterday youâ€™ll know that wrapping is moving into the standard library in an upcoming Go release. </p><p>\8. Concurrency </p><p>Often Go is chosen for a project because of its concurrency features. The Go team have gone to great lengths to make concurrency in Go cheap (in terms of hardware resources) and performant, however it is possible to use Goâ€™s concurrency features to write code which is neither performent or reliable. With the time I have left I want to leave you with some advice for avoid some of the pitfalls that come with Goâ€™s concurrency features. </p><p>Go features first class support for concurrency with channels, and the select and go statements. If youâ€™ve learnt Go formally from a book or training course, you might have noticed that the concurrency section is always one of the last youâ€™ll cover. This workshop is no different, I have chosen to cover concurrency last, as if it is somehow additional to the regular the skills a Go programmer should master. </p><p>There is a dichotomy here; Goâ€™s headline feature is our simple, lightweight concurrency model. As a product, our language almost sells itself on this on feature alone. On the other hand, there is a narrative that concurrency isnâ€™t actually that easy to use, otherwise authors wouldnâ€™t make it the last chapter in their book and we wouldnâ€™t look back on our formative efforts with regret. </p><p>This section discusses some pitfalls of naive usage of Goâ€™s concurrency features. </p><p>8.1. Keep yourself busy or do the work yourself </p><p>What is the problem with this program? </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">original error: *os.PathError open /Users/dfc/.settings.xml: no such file or directory</span><br><span class="line">stack trace:</span><br><span class="line">open /Users/dfc/.settings.xml: no such file or directory</span><br><span class="line">open failed</span><br><span class="line">main.ReadFile</span><br><span class="line">        /Users/dfc/devel/practical-go/src/errors/readfile2.go:16</span><br><span class="line">main.ReadConfig</span><br><span class="line">        /Users/dfc/devel/practical-go/src/errors/readfile2.go:29</span><br><span class="line">main.main</span><br><span class="line">        /Users/dfc/devel/practical-go/src/errors/readfile2.go:35</span><br><span class="line">runtime.main</span><br><span class="line">        /Users/dfc/go/src/runtime/proc.go:201</span><br><span class="line">runtime.goexit</span><br><span class="line">        /Users/dfc/go/src/runtime/asm_amd64.s:1333</span><br><span class="line">could not read config</span><br></pre></td></tr></table></figure><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 36/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>The program does what we intended, it serves a simple web server. However it also does something else at the same time, it wastes CPU in an infinite loop. This is because the for{} on the last line of main is going to block the main goroutine because it doesnâ€™t do any IO, wait on a lock, send or receive on a channel, or otherwise communicate with the scheduler. </p><p>As the Go runtime is mostly cooperatively scheduled, this program is going to spin fruitlessly on a single CPU, and may eventually end up live-locked. </p><p>How could we fix this? Hereâ€™s one suggestion. </p><p>package main </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;log&quot;</span><br></pre></td></tr></table></figure><p>â€œnet/httpâ€ </p><p>â€œruntimeâ€ ) </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123;</span><br><span class="line">            log.Fatal(err)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>}() </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">for &#123;</span><br><span class="line">    runtime.Gosched()</span><br></pre></td></tr></table></figure><p>} } </p><p>GO </p><p>package main </p><p>GO </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;log&quot;</span><br></pre></td></tr></table></figure><p>â€œnet/httpâ€ ) </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123;</span><br><span class="line">            log.Fatal(err)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>}() </p><p>for { </p><p>} } </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 37/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>This might look silly, but itâ€™s a common common solution I see in the wild. Itâ€™s symptomatic of not understanding the underlying problem. </p><p>Now, if youâ€™re a little more experienced with go, you might instead write something like this. </p><p>package main </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;log&quot;</span><br></pre></td></tr></table></figure><p>â€œnet/httpâ€ ) </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123;</span><br><span class="line">            log.Fatal(err)</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>}() </p><p>select {} } </p><p>GO </p><p>An empty select statement will block forever. This is a useful property because now weâ€™re not spinning a whole CPU just to call runtime.GoSched() . However, weâ€™re only treating the symptom, not the cause. </p><p>I want to present to you another solution, one which has hopefully already occurred to you. Rather than run<br> in a goroutine, leaving us with the problem of what to do with the main goroutine, simply run </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http.ListenAndServe</span><br><span class="line">http.ListenAndServe</span><br></pre></td></tr></table></figure><p>TIP </p><p>on the main goroutine itself. </p><p>If the main.main function of a Go program returns then the Go program will unconditionally exit no matter what other goroutines started by the program over time are doing. </p><p>package main </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br><span class="line">    &quot;log&quot;</span><br></pre></td></tr></table></figure><p>â€œnet/httpâ€ ) </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123;</span><br><span class="line">        log.Fatal(err)</span><br></pre></td></tr></table></figure><p>} } </p><p>GO </p><p>So this is my first piece of advice: if your goroutine cannot make progress until it gets the result from another, oftentimes it is simpler to just do the work yourself rather than to delegate it. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 38/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>This often eliminates a lot of state tracking and channel manipulation required to plumb a result back from a goroutine to its initiator. </p><p>TIP </p><p>Many Go programmers overuse goroutines, especially when they are starting out. As with all things in life, moderation is the key the key to success. </p><p>8.2. Leave concurrency to the caller </p><p>What is the difference between these two APIs? </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// ListDirectory returns the contents of dir.</span><br><span class="line">func ListDirectory(dir string) ([]string, error)</span><br><span class="line">// ListDirectory returns a channel over which</span><br><span class="line">// directory entries will be published. When the list</span><br><span class="line">// of entries is exhausted, the channel will be closed.</span><br><span class="line">func ListDirectory(dir string) chan string</span><br></pre></td></tr></table></figure><p>Firstly, the obvious differences; the first example reads a directory into a slice then returns the whole slice, or an error if something went wrong. This happens synchronously, the caller of ListDirectory blocks until all directory entries have been read. Depending on how large the directory, this could take a long time, and could potentially allocate a lot of memory building up the slide of directory entry names. </p><p>Lets look at the second example. This is a little more Go like, ListDirectory returns a channel over which directory entries will be passed. When the channel is closed, that is your indication that there are no more directory entries. As the population of the channel happens after ListDirectory returns, ListDirectory is probably starting a goroutine to populate the channel. </p><p>NOTE </p><p>Its not necessary for the second version to actually use a Go routine; it could allocate a channel sufficient to hold all the directory entries without blocking, fill the channel, close it, then return the channel to the caller. But this is unlikely, as this would have the same problems with consuming a large amount of memory to buffer all the results in a channel. </p><p>The channel version of ListDirectory has two further problems: </p><p>By using a closed channel as the signal that there are no more items to process there is no way for ListDirectory to tell the caller that the set of items returned over the channel is incomplete because an error was encountered partway through. There is no way for the caller to tell the difference between an empty directory and an error to read from the directory entirely. Both result in a channel returned from ListDirectory which appears to be closed immediately. </p><p>The caller must continue to read from the channel until it is closed because that is the only way the caller can know that the goroutine which was started to fill the channel has stopped. This is a serious limitation on the use of </p><p>ListDirectory , the caller has to spend time reading from the channel even though it may have received the answer it wanted. It is probably more efficient in terms of memory usage for medium to large directories, but this method is no faster than the original slice based method. </p><p>The solution to the problems of both implementations is to use a callback, a function that is called in the context of each directory entry as it is executed. </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 39/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Not surprisingly this is how the filepath.WalkDir function works. </p><p>If your function starts a goroutine you must provide the caller with a way to explicitly stop that TIP goroutine. It is often easier to leave decision to execute a function asynchronously to the caller of </p><p>that function. </p><p>8.3. Never start a goroutine without when it will stop. </p><p>The previous example showed using a goroutine when one wasnâ€™t really necessary. But one of the driving reasons for using Go is the first class concurrency features the language offers. Indeed there are many instances where you want to exploit the parallelism available in your hardware. To do so, you must use goroutines. </p><p>This simple application serves http traffic on two different ports, port 8080 for application traffic and port 8001 for access to the /debug/pprof endpoint. </p><p>package main </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">import (</span><br><span class="line">    &quot;fmt&quot;</span><br></pre></td></tr></table></figure><p>â€œnet/httpâ€ </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    _ &quot;net/http/pprof&quot;</span><br><span class="line">)</span><br><span class="line">func main() &#123;</span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(resp, &quot;Hello, QCon!&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    go http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux) // debug</span><br><span class="line">    http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux)                       // app traffic</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>GO </p><p>Although this program isnâ€™t very complicated, it represents the basis of a real application. </p><p>There are a few problems with the application as it stands which will reveal themselves as the application grows, so lets address a few of them now. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">func ListDirectory(dir string, fn func(string))</span><br></pre></td></tr></table></figure><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 40/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>By breaking the serveApp and serveDebug handlers out into their own functions weâ€™ve decoupled them from main.main . Weâ€™ve also followed the advice from above and make sure that serveApp and serveDebug leave their </p><p>concurrency to the caller. </p><p>But there are some operability problems with this program. If serveApp returns then main.main will return causing the program to shutdown and be restarted by whatever process manager youâ€™re using. </p><p>TIP </p><p>Just as functions in Go leave concurrency to the caller, applications should leave the job of monitoring their status and restarting them if they fail to the program that invoked them. Do not make your applications responsible for restarting themselves, this is a procedure best handled from outside the application. </p><p>However, serveDebug is run in a separate goroutine and if it returns just that goroutine will exit while the rest of the program continues on. Your operations staff will not be happy to find that they cannot get the statistics out of your application when they want too because the /debug handler stopped working a long time ago. </p><p>What we want to ensure is that if any of the goroutines responsible for serving this application stop, we shut down the application. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func serveApp() &#123;</span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(resp, &quot;Hello, QCon!&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux)</span><br><span class="line">&#125;</span><br><span class="line">func serveDebug() &#123;</span><br><span class="line">    http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux)</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    go serveDebug()</span><br></pre></td></tr></table></figure><p>serveApp() } </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 41/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Now serverApp and serveDebug check the error returned from ListenAndServe and call if required. Because both handlers are running in goroutines, we park the main goroutine in a . </p><p>This approach has a number of problems: </p><p>\1. If ListenAndServer returns with a nil error, log.Fatal wonâ€™t be called and the HTTP service on that port will shut down without stopping the application. </p><p>\2. log.Fatal calls os.Exit which will unconditionally exit the program; defers wonâ€™t be called, other goroutines wonâ€™t be notified to shut down, the program will just stop. This makes it difficult to write tests for those functions. </p><p>TIP Only use log.Fatal from main.main or init functions. </p><p>What weâ€™d really like is to pass any error that occurs back to the originator of the goroutine so that it can know why the goroutine stopped, can shut down the process cleanly. </p><p>log.Fatal </p><p>select{} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func serveApp() &#123;</span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(resp, &quot;Hello, QCon!&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    if err := http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux); err != nil &#123;</span><br><span class="line">        log.Fatal(err)</span><br></pre></td></tr></table></figure><p>} } </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">func serveDebug() &#123;</span><br><span class="line">    if err := http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux); err != nil &#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    go serveDebug()</span><br><span class="line">    go serveApp()</span><br></pre></td></tr></table></figure><p>select {} } </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 42/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>We can use a channel to collect the return status of the goroutine. The size of the channel is equal to the number of goroutines we want to manage so that sending to the done channel will not block, as this will block the shutdown the of goroutine, causing it to leak. </p><p>As there is no way to safely close the done channel we cannot use the for range idiom to loop of the channel until all goroutines have reported in, instead we loop for as many goroutines we started, which is equal to the capacity of the channel. </p><p>Now we have a way to wait for each goroutine to exit cleanly and log any error they encounter. All that is needed is a way to forward the shutdown signal from the first goroutine that exits to the others. </p><p>It turns out that asking a http.Server to shut down is a little involved, so Iâ€™ve spun that logic out into a helper function. The serve helper takes an address and http.Handler , similar to http.ListenAndServe , and also a stop channel which we use to trigger the Shutdown method. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func serveApp() error &#123;</span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(resp, &quot;Hello, QCon!&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    return http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux)</span><br><span class="line">&#125;</span><br><span class="line">func serveDebug() error &#123;</span><br><span class="line">    return http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux)</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    done := make(chan error, 2)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        done &lt;- serveDebug()</span><br><span class="line">    &#125;()</span><br><span class="line">    go func() &#123;</span><br><span class="line">        done &lt;- serveApp()</span><br></pre></td></tr></table></figure><p>}() </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">for i := 0; i &lt; cap(done); i++ &#123;</span><br><span class="line">    if err := &lt;-done; err != nil &#123;</span><br><span class="line">        fmt.Println(&quot;error: %v&quot;, err)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>} } </p><p>GO </p><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 43/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><p>Now, each time we receive a value on the channel, we close the stop channel which causes all the goroutines waiting on that channel to shut down their . This in turn will cause all the remaining ListenAndServe goroutines to return. Once all the goroutines we started have stopped, main.main returns and the process stops cleanly. </p><p>done </p><p>http.Server </p><p>TIP </p><p>Writing this logic yourself is repetitive and subtle. Consider something like this package, <a href="https://github.com/heptio/workgroup" target="_blank" rel="noopener">https://github.com/heptio/workgroup</a> which will do most of the work for you. </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">func serve(addr string, handler http.Handler, stop &lt;-chan struct&#123;&#125;) error &#123;</span><br><span class="line">    s := http.Server&#123;</span><br></pre></td></tr></table></figure><p>Addr: addr, </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    Handler: handler,</span><br><span class="line">&#125;</span><br><span class="line">go func() &#123;</span><br><span class="line">    &lt;-stop // wait for stop signal</span><br><span class="line">    s.Shutdown(context.Background())</span><br></pre></td></tr></table></figure><p>}() </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    return s.ListenAndServe()</span><br><span class="line">&#125;</span><br><span class="line">func serveApp(stop &lt;-chan struct&#123;&#125;) error &#123;</span><br><span class="line">    mux := http.NewServeMux()</span><br><span class="line">    mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123;</span><br><span class="line">        fmt.Fprintln(resp, &quot;Hello, QCon!&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line">    return serve(&quot;0.0.0.0:8080&quot;, mux, stop)</span><br><span class="line">&#125;</span><br><span class="line">func serveDebug(stop &lt;-chan struct&#123;&#125;) error &#123;</span><br><span class="line">    return serve(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux, stop)</span><br></pre></td></tr></table></figure><p>} </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">    done := make(chan error, 2)</span><br><span class="line">    stop := make(chan struct&#123;&#125;)</span><br><span class="line">    go func() &#123;</span><br><span class="line">        done &lt;- serveDebug(stop)</span><br><span class="line">    &#125;()</span><br><span class="line">    go func() &#123;</span><br><span class="line">        done &lt;- serveApp(stop)</span><br></pre></td></tr></table></figure><p>}() </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">var stopped bool</span><br><span class="line">for i := 0; i &lt; cap(done); i++ &#123;</span><br><span class="line">    if err := &lt;-done; err != nil &#123;</span><br><span class="line">        fmt.Println(&quot;error: %v&quot;, err)</span><br><span class="line">    &#125;</span><br><span class="line">    if !stopped &#123;</span><br><span class="line">        stopped = true</span><br><span class="line">        close(stop)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>} } </p><p>GO </p><ul><li>ä¸‹é¢æ˜¯Davidç»™å‡ºçš„ä¸€ä¸‹å…³äºgoçš„å­¦ä¹ å‚è€ƒèµ„æ–™çš„é“¾æ¥ï¼š</li></ul><p><a href="https://dave.cheney.net/practical-go/presentations/qcon-china.html" target="_blank" rel="noopener">https://dave.cheney.net/practical-go/presentations/qcon-china.html</a> 44/45 </p><p>2018/10/21 Practical Go: Real world advice for writing maintainable Go programs </p><ol><li><p><a href="https://gaston.life/books/effective-programming/" target="_blank" rel="noopener">https://gaston.life/books/effective-programming/</a></p></li><li><p><a href="https://talks.golang.org/2014/names.slide#4" target="_blank" rel="noopener">https://talks.golang.org/2014/names.slide#4</a></p></li><li><p><a href="https://www.infoq.com/articles/API-Design-Joshua-Bloch" target="_blank" rel="noopener">https://www.infoq.com/articles/API-Design-Joshua-Bloch</a></p></li><li><p><a href="https://www.lysator.liu.se/c/pikestyle.html" target="_blank" rel="noopener">https://www.lysator.liu.se/c/pikestyle.html</a></p></li><li><p><a href="https://speakerdeck.com/campoy/understanding-nil" target="_blank" rel="noopener">https://speakerdeck.com/campoy/understanding-nil</a></p></li><li><p><a href="https://www.youtube.com/watch?v=Ic2y6w8lMPA" target="_blank" rel="noopener">https://www.youtube.com/watch?v=Ic2y6w8lMPA</a></p></li><li><p><a href="https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88" target="_blank" rel="noopener">https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88</a></p></li><li><p><a href="https://golang.org/doc/go1.4#internalpackages" target="_blank" rel="noopener">https://golang.org/doc/go1.4#internalpackages</a></p></li><li><p><a href="https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis" target="_blank" rel="noopener">https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis</a></p></li><li><p><a href="https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html" target="_blank" rel="noopener">https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html</a></p></li><li><p><a href="https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully" target="_blank" rel="noopener">https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully</a></p></li><li><p><a href="https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201" target="_blank" rel="noopener">https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201</a></p></li><li><p><a href="https://blog.golang.org/errors-are-values" target="_blank" rel="noopener">https://blog.golang.org/errors-are-values</a></p></li><li><p><a href="http://www.gopl.io/" target="_blank" rel="noopener">http://www.gopl.io/</a></p></li></ol><hr>]]></content>
    
    <summary type="html">
    
      åšå®¢å†…å®¹ä¸ºGOä¸“å®¶Davidå…³äºGoæœ€ä½³å®è·µçš„ä¸€äº›å»ºè®®
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="GO QCon æŠ€æœ¯åˆ†äº«" scheme="https://cloudsjhan.github.io/tags/GO-QCon-%E6%8A%80%E6%9C%AF%E5%88%86%E4%BA%AB/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯å‘¨åˆŠä¹‹æ”¹å–„ Python ç¨‹åºçš„ 91 ä¸ªå»ºè®®ï¼ˆè½¬è½½)</title>
    <link href="https://cloudsjhan.github.io/2018/10/21/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E6%94%B9%E5%96%84-Python-%E7%A8%8B%E5%BA%8F%E7%9A%84-91-%E4%B8%AA%E5%BB%BA%E8%AE%AE%EF%BC%88%E8%BD%AC%E8%BD%BD/"/>
    <id>https://cloudsjhan.github.io/2018/10/21/æŠ€æœ¯å‘¨åˆŠä¹‹æ”¹å–„-Python-ç¨‹åºçš„-91-ä¸ªå»ºè®®ï¼ˆè½¬è½½/</id>
    <published>2018-10-21T13:49:17.000Z</published>
    <updated>2018-10-21T13:54:09.690Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æœ¬ç¯‡åšå®¢è½¬è½½è‡ªzhuanlan.zhihu.com/p/32817459ã€‚</p><p>é™¤äº†Googleçš„Pythonä»£ç è§„èŒƒå¤–ï¼Œä»æ¥æ²¡æœ‰ç±»ä¼¼çš„ä¹¦ç±ã€‚å¶ç„¶çš„æœºä¼šçœ‹åˆ°è¿™ä¹ˆä¸€æœ¬ä¹¦ï¼Œè¯»å®Œä¹‹åè§‰å¾—è¿˜ä¸é”™ï¼Œæ‰€ä»¥åšä¸ªç®€å•çš„ç¬”è®°ã€‚æœ‰æƒ³å­¦ä¹ ç±»ä¼¼çŸ¥è¯†çš„æœ‹å‹ï¼Œåˆæ‡’å¾—å»è¯»å®Œæ•´æœ¬ä¹¦ç±ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚</p><h3 id="1ï¼šå¼•è®º"><a href="#1ï¼šå¼•è®º" class="headerlink" title="1ï¼šå¼•è®º"></a><strong>1ï¼šå¼•è®º</strong></h3><p>å»ºè®®1ã€ç†è§£Pythonicæ¦‚å¿µâ€”-è¯¦è§Pythonä¸­çš„ã€ŠPythonä¹‹ç¦…ã€‹</p><p>å»ºè®®2ã€ç¼–å†™Pythonicä»£ç </p><p>ï¼ˆ1ï¼‰é¿å…ä¸è§„èŒƒä»£ç ï¼Œæ¯”å¦‚åªç”¨å¤§å°å†™åŒºåˆ†å˜é‡ã€ä½¿ç”¨å®¹æ˜“æ··æ·†çš„å˜é‡åã€å®³æ€•è¿‡é•¿å˜é‡åç­‰ã€‚æœ‰æ—¶å€™é•¿çš„å˜é‡åä¼šä½¿ä»£ç æ›´åŠ å…·æœ‰å¯è¯»æ€§ã€‚</p><p>ï¼ˆ2ï¼‰æ·±å…¥å­¦ä¹ Pythonç›¸å…³çŸ¥è¯†ï¼Œæ¯”å¦‚è¯­è¨€ç‰¹æ€§ã€åº“ç‰¹æ€§ç­‰ï¼Œæ¯”å¦‚Pythonæ¼”å˜è¿‡ç¨‹ç­‰ã€‚æ·±å…¥å­¦ä¹ ä¸€ä¸¤ä¸ªä¸šå†…å…¬è®¤çš„Pythonicçš„ä»£ç åº“ï¼Œæ¯”å¦‚Flaskç­‰ã€‚</p><p>å»ºè®®3ï¼šç†è§£Pythonä¸Cçš„ä¸åŒä¹‹å¤„ï¼Œæ¯”å¦‚ç¼©è¿›ä¸{}ï¼Œå•å¼•å·åŒå¼•å·ï¼Œä¸‰å…ƒæ“ä½œç¬¦ï¼Ÿï¼ŒSwitch-Caseè¯­å¥ç­‰ã€‚</p><p>å»ºè®®4ï¼šåœ¨ä»£ç ä¸­é€‚å½“æ·»åŠ æ³¨é‡Š</p><p>å»ºè®®5ï¼šé€‚å½“æ·»åŠ ç©ºè¡Œä½¿ä»£ç å¸ƒå±€æ›´åŠ åˆç†</p><p>å»ºè®®6ï¼šç¼–å†™å‡½æ•°çš„4ä¸ªåŸåˆ™</p><p>ï¼ˆ1ï¼‰å‡½æ•°è®¾è®¡è¦å°½é‡çŸ­å°ï¼ŒåµŒå¥—å±‚æ¬¡ä¸å®œè¿‡æ·±</p><p>ï¼ˆ2ï¼‰å‡½æ•°å£°æ˜åº”è¯¥åšåˆ°åˆç†ã€ç®€å•ã€æ˜“ç”¨</p><p>ï¼ˆ3ï¼‰å‡½æ•°å‚æ•°è®¾è®¡åº”è¯¥è€ƒè™‘å‘ä¸‹å…¼å®¹</p><p>ï¼ˆ4ï¼‰ä¸€ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ï¼Œå°½é‡ä¿è¯å‡½æ•°ç²’åº¦çš„ä¸€è‡´æ€§</p><p>å»ºè®®7ï¼šå°†å¸¸é‡é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸”å¸¸é‡åå°½é‡ä½¿ç”¨å…¨å¤§å†™å­—æ¯</p><h3 id="2ï¼šç¼–ç¨‹æƒ¯ç”¨æ³•"><a href="#2ï¼šç¼–ç¨‹æƒ¯ç”¨æ³•" class="headerlink" title="2ï¼šç¼–ç¨‹æƒ¯ç”¨æ³•"></a><strong>2ï¼šç¼–ç¨‹æƒ¯ç”¨æ³•</strong></h3><p>å»ºè®®8ï¼šåˆ©ç”¨assertè¯­å¥æ¥å‘ç°é—®é¢˜ï¼Œä½†è¦æ³¨æ„ï¼Œæ–­è¨€assertä¼šå½±å“æ•ˆç‡</p><p>å»ºè®®9ï¼šæ•°æ®äº¤æ¢å€¼æ—¶ä¸æ¨èä½¿ç”¨ä¸´æ—¶å˜é‡ï¼Œè€Œæ˜¯ç›´æ¥a, b = b, a</p><p>å»ºè®®10ï¼šå……åˆ†åˆ©ç”¨æƒ°æ€§è®¡ç®—ï¼ˆLazy evaluationï¼‰çš„ç‰¹æ€§ï¼Œä»è€Œé¿å…ä¸å¿…è¦çš„è®¡ç®—</p><p>å»ºè®®11ï¼šç†è§£æšä¸¾æ›¿ä»£å®ç°çš„ç¼ºé™·ï¼ˆæœ€æ–°ç‰ˆPythonä¸­å·²ç»åŠ å…¥äº†æšä¸¾ç‰¹æ€§ï¼‰</p><p>å»ºè®®12ï¼šä¸æ¨èä½¿ç”¨typeæ¥è¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå› ä¸ºæœ‰äº›æ—¶å€™typeçš„ç»“æœå¹¶ä¸ä¸€å®šå¯é ã€‚å¦‚æœæœ‰éœ€æ±‚ï¼Œå»ºè®®ä½¿ç”¨isinstanceå‡½æ•°æ¥ä»£æ›¿</p><p>å»ºè®®13ï¼šå°½é‡å°†å˜é‡è½¬åŒ–ä¸ºæµ®ç‚¹ç±»å‹åå†åšé™¤æ³•ï¼ˆPython3ä»¥åä¸ç”¨è€ƒè™‘ï¼‰</p><p>å»ºè®®14ï¼šè­¦æƒ•eval()å‡½æ•°çš„å®‰å…¨æ¼æ´ï¼Œæœ‰ç‚¹ç±»ä¼¼äºSQLæ³¨å…¥</p><p>å»ºè®®15ï¼šä½¿ç”¨enumerate()åŒæ—¶è·å–åºåˆ—è¿­ä»£çš„ç´¢å¼•å’Œå€¼</p><p>å»ºè®®16ï¼šåˆ†æ¸…==å’Œisçš„é€‚ç”¨åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¯”è¾ƒå­—ç¬¦ä¸²ç­‰ä¸å¯å˜ç±»å‹å˜é‡æ—¶ï¼ˆè¯¦è§è¯„è®ºï¼‰</p><p>å»ºè®®17ï¼šå°½é‡ä½¿ç”¨Unicodeã€‚åœ¨Python2ä¸­ç¼–ç æ˜¯å¾ˆè®©äººå¤´ç—›çš„ä¸€ä»¶äº‹ï¼Œä½†Python3å°±ä¸ç”¨è¿‡å¤šè€ƒè™‘äº†</p><p>å»ºè®®18ï¼šæ„å»ºåˆç†çš„åŒ…å±‚æ¬¡æ¥ç®¡ç†Module</p><h3 id="3ï¼šåŸºç¡€ç”¨æ³•"><a href="#3ï¼šåŸºç¡€ç”¨æ³•" class="headerlink" title="3ï¼šåŸºç¡€ç”¨æ³•"></a><strong>3ï¼šåŸºç¡€ç”¨æ³•</strong></h3><p>å»ºè®®19ï¼šæœ‰èŠ‚åˆ¶çš„ä½¿ç”¨fromâ€¦importè¯­å¥ï¼Œé˜²æ­¢æ±¡æŸ“å‘½åç©ºé—´</p><p>å»ºè®®20ï¼šä¼˜å…ˆä½¿ç”¨absolute importæ¥å¯¼å…¥æ¨¡å—ï¼ˆPython3ä¸­å·²ç»ç§»é™¤äº†relative importï¼‰</p><p>å»ºè®®21ï¼ši+=1ä¸ç­‰äº++iï¼Œåœ¨Pythonä¸­ï¼Œ++iå‰è¾¹çš„åŠ å·ä»…è¡¨ç¤ºæ­£ï¼Œä¸è¡¨ç¤ºæ“ä½œ</p><p>å»ºè®®22ï¼šä¹ æƒ¯ä½¿ç”¨withè‡ªåŠ¨å…³é—­èµ„æºï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡ä»¶è¯»å†™ä¸­</p><p>å»ºè®®23ï¼šä½¿ç”¨elseå­å¥ç®€åŒ–å¾ªç¯ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰</p><p>å»ºè®®24ï¼šéµå¾ªå¼‚å¸¸å¤„ç†çš„å‡ ç‚¹åŸºæœ¬åŸåˆ™</p><p>ï¼ˆ1ï¼‰æ³¨æ„å¼‚å¸¸çš„ç²’åº¦ï¼Œtryå—ä¸­å°½é‡å°‘å†™ä»£ç </p><p>ï¼ˆ2ï¼‰è°¨æ…ä½¿ç”¨å•ç‹¬çš„exceptè¯­å¥ï¼Œæˆ–except Exceptionè¯­å¥ï¼Œè€Œæ˜¯å®šä½åˆ°å…·ä½“å¼‚å¸¸</p><p>ï¼ˆ3ï¼‰æ³¨æ„å¼‚å¸¸æ•è·çš„é¡ºåºï¼Œåœ¨åˆé€‚çš„å±‚æ¬¡å¤„ç†å¼‚å¸¸</p><p>ï¼ˆ4ï¼‰ä½¿ç”¨æ›´åŠ å‹å¥½çš„å¼‚å¸¸ä¿¡æ¯ï¼Œéµå®ˆå¼‚å¸¸å‚æ•°çš„è§„èŒƒ</p><p>å»ºè®®25ï¼šé¿å…finallyä¸­å¯èƒ½å‘ç”Ÿçš„é™·é˜±</p><p>å»ºè®®26ï¼šæ·±å…¥ç†è§£Noneï¼Œæ­£ç¡®åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºç©ºã€‚Pythonä¸­ä¸‹åˆ—æ•°æ®ä¼šåˆ¤æ–­ä¸ºç©ºï¼š</p><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/iciaMJDiaNTbG52ZVEtvvWrJdfxjeHnC0h2nJcvp2sZwpqMdESQCm3pUhzcPcBsOyWfj6NJ0vIT3D6AVHMzZLCjmA/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p><p>å»ºè®®27ï¼šè¿æ¥å­—ç¬¦ä¸²åº”ä¼˜å…ˆä½¿ç”¨joinå‡½æ•°ï¼Œè€Œä¸æ˜¯+æ“ä½œ</p><p>å»ºè®®28ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶å°½é‡ä½¿ç”¨.formatå‡½æ•°ï¼Œè€Œä¸æ˜¯%å½¢å¼</p><p>å»ºè®®29ï¼šåŒºåˆ«å¯¹å¾…å¯å˜å¯¹è±¡å’Œä¸å¯å˜å¯¹è±¡ï¼Œç‰¹åˆ«æ˜¯ä½œä¸ºå‡½æ•°å‚æ•°æ—¶</p><p>å»ºè®®30ï¼š[], {}å’Œ()ï¼šä¸€è‡´çš„å®¹å™¨åˆå§‹åŒ–å½¢å¼ã€‚ä½¿ç”¨åˆ—è¡¨è§£æå¯ä»¥ä½¿ä»£ç æ›´æ¸…æ™°ï¼ŒåŒæ—¶æ•ˆç‡æ›´é«˜</p><p>å»ºè®®31ï¼šå‡½æ•°ä¼ å‚æ•°ï¼Œæ—¢ä¸æ˜¯ä¼ å€¼ä¹Ÿä¸æ˜¯ä¼ å¼•ç”¨ï¼Œè€Œæ˜¯ä¼ å¯¹è±¡æˆ–è€…è¯´å¯¹è±¡çš„å¼•ç”¨</p><p>å»ºè®®32ï¼šè­¦æƒ•é»˜è®¤å‚æ•°æ½œåœ¨çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“é»˜è®¤å‚æ•°ä¸ºå¯å˜å¯¹è±¡æ—¶</p><p>å»ºè®®33ï¼šå‡½æ•°ä¸­æ…ç”¨å˜é•¿å‚æ•°*argså’Œ**kargs</p><p>ï¼ˆ1ï¼‰è¿™ç§ä½¿ç”¨å¤ªçµæ´»ï¼Œä»è€Œä½¿å¾—å‡½æ•°ç­¾åä¸å¤Ÿæ¸…æ™°ï¼Œå¯è¯»æ€§è¾ƒå·®</p><p>ï¼ˆ2ï¼‰å¦‚æœå› ä¸ºå‡½æ•°å‚æ•°è¿‡å¤šè€Œæ˜¯ç”¨å˜é•¿å‚æ•°ç®€åŒ–å‡½æ•°å®šä¹‰ï¼Œé‚£ä¹ˆä¸€èˆ¬è¯¥å‡½æ•°å¯ä»¥é‡æ„</p><p>å»ºè®®34ï¼šæ·±å…¥ç†è§£str()å’Œrepr()çš„åŒºåˆ«</p><p>ï¼ˆ1ï¼‰ä¸¤è€…ä¹‹é—´çš„ç›®æ ‡ä¸åŒï¼šsträ¸»è¦é¢å‘å®¢æˆ·ï¼Œå…¶ç›®çš„æ˜¯å¯è¯»æ€§ï¼Œè¿”å›å½¢å¼ä¸ºç”¨æˆ·å‹å¥½æ€§å’Œå¯è¯»æ€§éƒ½æ¯”è¾ƒé«˜çš„å­—ç¬¦ä¸²å½¢å¼ï¼›è€Œrepræ˜¯é¢å‘Pythonè§£é‡Šå™¨æˆ–è€…è¯´Pythonå¼€å‘äººå‘˜ï¼Œå…¶ç›®çš„æ˜¯å‡†ç¡®æ€§ï¼Œå…¶è¿”å›å€¼è¡¨ç¤ºPythonè§£é‡Šå™¨å†…éƒ¨çš„å®šä¹‰</p><p>ï¼ˆ2ï¼‰åœ¨è§£é‡Šå™¨ä¸­ç›´æ¥è¾“å…¥å˜é‡ï¼Œé»˜è®¤è°ƒç”¨reprå‡½æ•°ï¼Œè€Œprint(var)é»˜è®¤è°ƒç”¨strå‡½æ•°</p><p>ï¼ˆ3ï¼‰reprå‡½æ•°çš„è¿”å›å€¼ä¸€èˆ¬å¯ä»¥ç”¨evalå‡½æ•°æ¥è¿˜åŸå¯¹è±¡</p><p>ï¼ˆ4ï¼‰ä¸¤è€…åˆ†åˆ«è°ƒç”¨å¯¹è±¡çš„å†…å»ºå‡½æ•°<strong>str__()å’Œ__repr</strong>()</p><p>å»ºè®®35ï¼šåˆ†æ¸…é™æ€æ–¹æ³•staticmethodå’Œç±»æ–¹æ³•classmethodçš„ä½¿ç”¨åœºæ™¯</p><h3 id="4ï¼šåº“"><a href="#4ï¼šåº“" class="headerlink" title="4ï¼šåº“"></a><strong>4ï¼šåº“</strong></h3><p>å»ºè®®36ï¼šæŒæ¡å­—ç¬¦ä¸²çš„åŸºæœ¬ç”¨æ³•</p><p>å»ºè®®37ï¼šæŒ‰éœ€é€‰æ‹©sort()å’Œsorted()å‡½æ•°</p><p>ã€‹sort()æ˜¯åˆ—è¡¨åœ¨å°±åœ°è¿›è¡Œæ’åºï¼Œæ‰€ä»¥ä¸èƒ½æ’åºå…ƒç»„ç­‰ä¸å¯å˜ç±»å‹ã€‚</p><p>ã€‹sorted()å¯ä»¥æ’åºä»»æ„çš„å¯è¿­ä»£ç±»å‹ï¼ŒåŒæ—¶ä¸æ”¹å˜åŸå˜é‡æœ¬èº«ã€‚</p><p>å»ºè®®38ï¼šä½¿ç”¨copyæ¨¡å—æ·±æ‹·è´å¯¹è±¡ï¼ŒåŒºåˆ†æµ…æ‹·è´ï¼ˆshallow copyï¼‰å’Œæ·±æ‹·è´ï¼ˆdeep copyï¼‰</p><p>å»ºè®®39ï¼šä½¿ç”¨Counterè¿›è¡Œè®¡æ•°ç»Ÿè®¡ï¼ŒCounteræ˜¯å­—å…¸ç±»çš„å­ç±»ï¼Œåœ¨collectionsæ¨¡å—ä¸­</p><p>å»ºè®®40ï¼šæ·±å…¥æŒæ¡ConfigParser</p><p>å»ºè®®41ï¼šä½¿ç”¨argparseæ¨¡å—å¤„ç†å‘½ä»¤è¡Œå‚æ•°</p><p>å»ºè®®42ï¼šä½¿ç”¨pandaså¤„ç†å¤§å‹CSVæ–‡ä»¶</p><p>ã€‹Pythonæœ¬èº«æä¾›ä¸€ä¸ªCSVæ–‡ä»¶å¤„ç†æ¨¡å—ï¼Œå¹¶æä¾›readerã€writerç­‰å‡½æ•°ã€‚</p><p>ã€‹Pandaså¯æä¾›åˆ†å—ã€åˆå¹¶å¤„ç†ç­‰ï¼Œé€‚ç”¨äºæ•°æ®é‡å¤§çš„æƒ…å†µï¼Œä¸”å¯¹äºŒç»´æ•°æ®æ“ä½œæ›´æ–¹ä¾¿ã€‚</p><p>å»ºè®®43ï¼šä½¿ç”¨ElementTreeè§£æXML</p><p>å»ºè®®44ï¼šç†è§£æ¨¡å—pickleçš„ä¼˜åŠ£</p><p>ã€‹ä¼˜åŠ¿ï¼šæ¥å£ç®€å•ã€å„å¹³å°é€šç”¨ã€æ”¯æŒçš„æ•°æ®ç±»å‹å¹¿æ³›ã€æ‰©å±•æ€§å¼º</p><p>ã€‹åŠ£åŠ¿ï¼šä¸ä¿è¯æ•°æ®æ“ä½œçš„åŸå­æ€§ã€å­˜åœ¨å®‰å…¨é—®é¢˜ã€ä¸åŒè¯­è¨€ä¹‹é—´ä¸å…¼å®¹</p><p>å»ºè®®45ï¼šåºåˆ—åŒ–çš„å¦ä¸€ä¸ªé€‰æ‹©JSONæ¨¡å—ï¼šloadå’Œdumpæ“ä½œ</p><p>å»ºè®®46ï¼šä½¿ç”¨tracebackè·å–æ ˆä¿¡æ¯</p><p>å»ºè®®47ï¼šä½¿ç”¨loggingè®°å½•æ—¥å¿—ä¿¡æ¯</p><p>å»ºè®®48ï¼šä½¿ç”¨threadingæ¨¡å—ç¼–å†™å¤šçº¿ç¨‹ç¨‹åº</p><p>å»ºè®®49ï¼šä½¿ç”¨Queueæ¨¡å—ä½¿å¤šçº¿ç¨‹ç¼–ç¨‹æ›´å®‰å…¨</p><h3 id="5ï¼šè®¾è®¡æ¨¡å¼"><a href="#5ï¼šè®¾è®¡æ¨¡å¼" class="headerlink" title="5ï¼šè®¾è®¡æ¨¡å¼"></a><strong>5ï¼šè®¾è®¡æ¨¡å¼</strong></h3><p>å»ºè®®50ï¼šåˆ©ç”¨æ¨¡å—å®ç°å•ä¾‹æ¨¡å¼</p><p>å»ºè®®51ï¼šç”¨mixinæ¨¡å¼è®©ç¨‹åºæ›´åŠ çµæ´»</p><p>å»ºè®®52ï¼šç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼å®ç°æ¾è€¦åˆ</p><p>å»ºè®®53ï¼šç”¨çŠ¶æ€æ¨¡å¼ç¾åŒ–ä»£ç </p><h3 id="6ï¼šå†…éƒ¨æœºåˆ¶"><a href="#6ï¼šå†…éƒ¨æœºåˆ¶" class="headerlink" title="6ï¼šå†…éƒ¨æœºåˆ¶"></a><strong>6ï¼šå†…éƒ¨æœºåˆ¶</strong></h3><p>å»ºè®®54ï¼šç†è§£build-inå¯¹è±¡</p><p>å»ºè®®55ï¼š<strong>init__()ä¸æ˜¯æ„é€ æ–¹æ³•ï¼Œç†è§£__new</strong>()ä¸å®ƒä¹‹é—´çš„åŒºåˆ«</p><p>å»ºè®®56ï¼šç†è§£å˜é‡çš„æŸ¥æ‰¾æœºåˆ¶ï¼Œå³ä½œç”¨åŸŸ</p><p>ã€‹å±€éƒ¨ä½œç”¨åŸŸ</p><p>ã€‹å…¨å±€ä½œç”¨åŸŸ</p><p>ã€‹åµŒå¥—ä½œç”¨åŸŸ</p><p>ã€‹å†…ç½®ä½œç”¨åŸŸ</p><p>å»ºè®®57ï¼šä¸ºä»€ä¹ˆéœ€è¦selfå‚æ•°</p><p>å»ºè®®58ï¼šç†è§£MROï¼ˆæ–¹æ³•è§£æé¡ºåºï¼‰ä¸å¤šç»§æ‰¿</p><p>å»ºè®®59ï¼šç†è§£æè¿°ç¬¦æœºåˆ¶</p><p>å»ºè®®60ï¼šåŒºåˆ«<strong>getattr__()ä¸__getattribute</strong>()æ–¹æ³•ä¹‹é—´çš„åŒºåˆ«</p><p>å»ºè®®61ï¼šä½¿ç”¨æ›´å®‰å…¨çš„property</p><p>å»ºè®®62ï¼šæŒæ¡å…ƒç±»metaclass</p><p>å»ºè®®63ï¼šç†Ÿæ‚‰Pythonå¯¹è±¡åè®®</p><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/iciaMJDiaNTbG52ZVEtvvWrJdfxjeHnC0h2mTYUZQBgtMVG5BQzVEnnkMDu5U9MzPJp99DzicxZ6hUjT03ib6wicwalw/640?wx_fmt=jpeg&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="img"></p><p>å»ºè®®64ï¼šåˆ©ç”¨æ“ä½œç¬¦é‡è½½å®ç°ä¸­ç¼€è¯­æ³•</p><p>å»ºè®®65ï¼šç†Ÿæ‚‰Pythonçš„è¿­ä»£å™¨åè®®</p><p>å»ºè®®66ï¼šç†Ÿæ‚‰Pythonçš„ç”Ÿæˆå™¨</p><p>å»ºè®®67ï¼šåŸºäºç”Ÿæˆå™¨çš„åç¨‹å’Œgreenletï¼Œç†è§£åç¨‹ã€å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ä¹‹é—´çš„åŒºåˆ«</p><p>å»ºè®®68ï¼šç†è§£GILçš„å±€é™æ€§</p><p>å»ºè®®69ï¼šå¯¹è±¡çš„ç®¡ç†å’Œåƒåœ¾å›æ”¶</p><h3 id="7ï¼šä½¿ç”¨å·¥å…·è¾…åŠ©é¡¹ç›®å¼€å‘"><a href="#7ï¼šä½¿ç”¨å·¥å…·è¾…åŠ©é¡¹ç›®å¼€å‘" class="headerlink" title="7ï¼šä½¿ç”¨å·¥å…·è¾…åŠ©é¡¹ç›®å¼€å‘"></a><strong>7ï¼šä½¿ç”¨å·¥å…·è¾…åŠ©é¡¹ç›®å¼€å‘</strong></h3><p>å»ºè®®70ï¼šä»PyPIå®‰è£…ç¬¬ä¸‰æ–¹åŒ…</p><p>å»ºè®®71ï¼šä½¿ç”¨pipå’Œyolkå®‰è£…ã€ç®¡ç†åŒ…</p><p>å»ºè®®72ï¼šåšpasteråˆ›å»ºåŒ…</p><p>å»ºè®®73ï¼šç†è§£å•å…ƒæµ‹è¯•çš„æ¦‚å¿µ</p><p>å»ºè®®74ï¼šä¸ºåŒ…ç¼–å†™å•å…ƒæµ‹è¯•</p><p>å»ºè®®75ï¼šåˆ©ç”¨æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æé«˜ä»£ç çš„å¯æµ‹æ€§</p><p>å»ºè®®76ï¼šä½¿ç”¨Pylintæ£€æŸ¥ä»£ç é£æ ¼</p><p>ã€‹ä»£ç é£æ ¼å®¡æŸ¥</p><p>ã€‹ä»£ç é”™è¯¯æ£€æŸ¥</p><p>ã€‹å‘ç°é‡å¤ä»¥åŠä¸åˆç†çš„ä»£ç ï¼Œæ–¹ä¾¿é‡æ„</p><p>ã€‹é«˜åº¦çš„å¯é…ç½®åŒ–å’Œå¯å®šåˆ¶åŒ–</p><p>ã€‹æ”¯æŒå„ç§IDEå’Œç¼–è¾‘å™¨çš„é›†æˆ</p><p>ã€‹èƒ½å¤ŸåŸºäºPythonä»£ç ç”ŸæˆUMLå›¾</p><p>ã€‹èƒ½å¤Ÿä¸Jenkinsç­‰æŒç»­é›†æˆå·¥å…·ç›¸ç»“åˆï¼Œæ”¯æŒè‡ªåŠ¨ä»£ç å®¡æŸ¥</p><p>å»ºè®®77ï¼šè¿›è¡Œé«˜æ•ˆçš„ä»£ç å®¡æŸ¥</p><p>å»ºè®®78ï¼šå°†åŒ…å‘å¸ƒåˆ°PyPI</p><h3 id="8ï¼šæ€§èƒ½å‰–æä¸ä¼˜åŒ–"><a href="#8ï¼šæ€§èƒ½å‰–æä¸ä¼˜åŒ–" class="headerlink" title="8ï¼šæ€§èƒ½å‰–æä¸ä¼˜åŒ–"></a><strong>8ï¼šæ€§èƒ½å‰–æä¸ä¼˜åŒ–</strong></h3><p>å»ºè®®79ï¼šäº†è§£ä»£ç ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™</p><p>å»ºè®®80ï¼šå€ŸåŠ©æ€§èƒ½ä¼˜åŒ–å·¥å…·</p><p>å»ºè®®81ï¼šåˆ©ç”¨cProfileå®šä½æ€§èƒ½ç“¶é¢ˆ</p><p>å»ºè®®82ï¼šä½¿ç”¨memory_profilerå’Œobjgraphå‰–æå†…å­˜ä½¿ç”¨</p><p>å»ºè®®83ï¼šåŠªåŠ›é™ä½ç®—æ³•å¤æ‚åº¦</p><p>å»ºè®®84ï¼šæŒæ¡å¾ªç¯ä¼˜åŒ–çš„åŸºæœ¬æŠ€å·§</p><p>ã€‹å‡å°‘å¾ªç¯å†…éƒ¨çš„è®¡ç®—</p><p>ã€‹å°†æ˜¾å¼å¾ªç¯æ”¹ä¸ºéšå¼å¾ªç¯ï¼Œå½“ç„¶è¿™ä¼šç‰ºç‰²ä»£ç çš„å¯è¯»æ€§</p><p>ã€‹åœ¨å¾ªç¯ä¸­å°½é‡å¼•ç”¨å±€éƒ¨å˜é‡</p><p>ã€‹å…³æ³¨å†…å±‚åµŒå¥—å¾ªç¯</p><p>å»ºè®®85ï¼šä½¿ç”¨ç”Ÿæˆå™¨æé«˜æ•ˆç‡</p><p>å»ºè®®86ï¼šä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æ„ä¼˜åŒ–æ€§èƒ½</p><p>å»ºè®®87ï¼šå……åˆ†åˆ©ç”¨setçš„ä¼˜åŠ¿</p><p>å»ºè®®88ï¼šä½¿ç”¨multiprocessingæ¨¡å—å…‹æœGILç¼ºé™·</p><p>å»ºè®®89ï¼šä½¿ç”¨çº¿ç¨‹æ± æé«˜æ•ˆç‡</p><p>å»ºè®®90ï¼šä½¿ç”¨C/C++æ¨¡å—æ‰©å±•æé«˜æ€§èƒ½</p><p>å»ºè®®91ï¼šä½¿ç”¨Cythonbç¼–å†™æ‰©å±•æ¨¡å—</p><hr>]]></content>
    
    <summary type="html">
    
      å¦‚ä½•å†™å‡ºè§„èŒƒä¼˜é›…çš„Pythonä»£ç 
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
      <category term="ç¼–ç¨‹è§„èŒƒ" scheme="https://cloudsjhan.github.io/tags/%E7%BC%96%E7%A8%8B%E8%A7%84%E8%8C%83/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯å‘¨åˆŠä¹‹åŸºäºbeego webæ¡†æ¶çš„RESTful APIçš„æ„å»ºä¹‹æ—…</title>
    <link href="https://cloudsjhan.github.io/2018/10/14/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E5%9F%BA%E4%BA%8Ebeego-web%E6%A1%86%E6%9E%B6%E7%9A%84RESTful-API%E7%9A%84%E6%9E%84%E5%BB%BA%E4%B9%8B%E6%97%85/"/>
    <id>https://cloudsjhan.github.io/2018/10/14/æŠ€æœ¯å‘¨åˆŠä¹‹åŸºäºbeego-webæ¡†æ¶çš„RESTful-APIçš„æ„å»ºä¹‹æ—…/</id>
    <published>2018-10-14T07:44:03.000Z</published>
    <updated>2018-10-14T10:10:09.837Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>â€‹    beegoæ˜¯ä¸€ä¸ªå¿«é€Ÿå¼€å‘GOåº”ç”¨çš„httpæ¡†æ¶ï¼Œä½œè€…æ˜¯goè¯­è¨€æ–¹å‘çš„å¤§ç‰›ï¼Œastaxieã€‚beegoå¯ä»¥ç”¨æ¥å¿«é€Ÿå¼€å‘APIã€webã€åç«¯æœåŠ¡ç­‰åº”ç”¨ï¼Œæ˜¯ä¸€ä¸ªRESTFulé£æ ¼çš„æ¡†æ¶ï¼Œä¸»è¦çš„è®¾è®¡çµæ„Ÿæ¥è‡ªäºPython webå¼€å‘æ¡†æ¶tornadoã€flaskã€sinstraï¼Œå¾ˆå¥½çš„ç»“åˆäº†Goè¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼ˆinterfaceï¼Œstructç»§æ‰¿ç­‰ï¼‰ã€‚</p><p>â€‹    beegoæ˜¯åŸºäºå…«å¤§ç‹¬ç«‹æ¨¡å—æ¥å®ç°çš„ï¼Œå¾ˆå¥½çš„å®ç°äº†æ¨¡å—é—´çš„è§£è€¦ï¼Œå³ä½¿ç”¨æˆ·ä¸ä½¿ç”¨httpçš„é€»è¾‘ï¼Œä¹Ÿå¯ä»¥å¾ˆå¥½çš„ä½¿ç”¨å…¶ä¸­çš„å„ä¸ªæ¨¡å—ã€‚ä½œè€…è‡ªå·±è¯´ï¼Œä»–çš„è¿™ç§æ€æƒ³æ¥è‡ªäºä¹é«˜ç§¯æœ¨ï¼Œè®¾è®¡beegoçš„æ—¶å€™ï¼Œè¿™äº›æ¨¡å—å°±æ˜¯ç§¯æœ¨ï¼Œè€Œæœ€ç»ˆæ­å»ºå¥½çš„æœºå™¨äººå°±æ˜¯beegoã€‚</p><p>â€‹    è¿™ç¯‡åšæ–‡é€šè¿‡ä½¿ç”¨beegoæ¥æ„å»ºAPIï¼Œè®²è§£å®ç°è¿‡ç¨‹ä¸­çš„ç»†èŠ‚ä»¥åŠé‡åˆ°çš„ä¸€äº›å‘ï¼Œè®©æˆ‘ä»¬é©¬ä¸Šå¼€å§‹beegoçš„APIæ„å»ºä¹‹æ—…å§ï¼</p><h3 id="é¡¹ç›®åˆ›å»º"><a href="#é¡¹ç›®åˆ›å»º" class="headerlink" title="é¡¹ç›®åˆ›å»º"></a>é¡¹ç›®åˆ›å»º</h3><ul><li>è¿›å…¥åˆ°ä½ çš„$GOPATH/src</li><li>å®‰è£…beegoå¼€å‘åŒ…è‡ªå·±å¿«é€Ÿå¼€å‘å·¥å…·bee</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get github.com/astaxie/beego</span><br><span class="line"><span class="keyword">go</span> get github.com/astaxie/beego/orm</span><br><span class="line"><span class="keyword">go</span> get github.com/beego/bee</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨å¿«é€Ÿå¼€å‘å·¥å…·beeï¼Œåˆ›å»ºæˆ‘ä»¬çš„APIé¡¹ç›®</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bee <span class="built_in">new</span> firstAPI</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å¾—åˆ°çš„é¡¹ç›®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tNbRwly1fw7uxgc1sqj314q03gwev.jpg" alt=""></p><p>å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„MVCæ¶æ„çš„åº”ç”¨ï¼ŒbeegoæŠŠæˆ‘ä»¬é¡¹ç›®æ‰€éœ€è¦çš„ä¸€äº›éƒ½å‡†å¤‡å¥½äº†ï¼Œä¾‹å¦‚é…ç½®æ–‡ä»¶confï¼Œæµ‹è¯•æ–‡ä»¶testsç­‰ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºAPIä»£ç çš„ç¼–å†™å³å¯ã€‚</p><h3 id="è¿è¡Œé¡¹ç›®å¹¶è·å¾—APIè‡ªåŠ¨åŒ–æ–‡æ¡£"><a href="#è¿è¡Œé¡¹ç›®å¹¶è·å¾—APIè‡ªåŠ¨åŒ–æ–‡æ¡£" class="headerlink" title="è¿è¡Œé¡¹ç›®å¹¶è·å¾—APIè‡ªåŠ¨åŒ–æ–‡æ¡£"></a>è¿è¡Œé¡¹ç›®å¹¶è·å¾—APIè‡ªåŠ¨åŒ–æ–‡æ¡£</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bee run -gendoc=<span class="literal">true</span> -downdoc=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p>è¿è¡Œä¸Šè¿°ä»£ç è¾“å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fw7v5dfquwj31kw0skn3a.jpg" alt=""></p><p>æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼šæœ¬æœºIPï¼š8080/swaggerï¼Œå°±ä¼šçœ‹åˆ°swaggerçš„APIæ–‡æ¡£ï¼Œæˆ‘ä»¬ä»£ç æ›´æ–°åï¼Œè¯¥æ–‡æ¡£å°±ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéå¸¸æ–¹ä¾¿ã€‚</p><h3 id="modelsè®¾è®¡"><a href="#modelsè®¾è®¡" class="headerlink" title="modelsè®¾è®¡"></a>modelsè®¾è®¡</h3><ul><li>å¯¹ æ•°æ®åº“object æ“ä½œæœ‰å››ä¸ªæ–¹æ³• Read / Insert / Update / Delete</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ç¤ºä¾‹ä»£ç ï¼š</span><br><span class="line">o := orm.NewOrm()</span><br><span class="line">user := <span class="built_in">new</span>(User)</span><br><span class="line">user.Name = <span class="string">"slene"</span></span><br><span class="line"></span><br><span class="line">fmt.Println(o.Insert(user))</span><br><span class="line"></span><br><span class="line">user.Name = <span class="string">"Your"</span></span><br><span class="line">fmt.Println(o.Update(user))</span><br><span class="line">fmt.Println(o.Read(user))</span><br><span class="line">fmt.Println(o.Delete(user))</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•å¯ä»¥å‚é˜…beego<a href="https://beego.me/docs/mvc/model/object.md" target="_blank" rel="noopener">å®˜æ–¹æ–‡æ¡£</a>ï¼Œé‡Œé¢å¯¹ormæ“ä½œæœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚</p><ul><li>åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å¹¶è®¾è®¡ä¸€å¼ æ•°æ®åº“è¡¨</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE IF NOT EXISTS `student` (</span><br><span class="line">`Id` int(11),</span><br><span class="line">`Name` varchar(255),</span><br><span class="line">`Birthdate` varchar(255),</span><br><span class="line">`Gender` bool,</span><br><span class="line">`Score` int(11)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><ul><li>åœ¨modelsæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶Student.go,å¹¶å®ç°ä»¥ä¸‹ä»£ç ï¼Œä»£ç ä¸­å…³é”®ç‚¹éƒ½æœ‰æ³¨é‡Š</li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> models</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/astaxie/beego/orm"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//åœ¨modelsæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªstructï¼Œç›®çš„æ˜¯ä½¿ç”¨beegoçš„ormæ¡†æ¶ï¼Œä½¿structä¸æ•°æ®åº“ä¸­çš„å­—æ®µäº§ç”Ÿå¯¹åº”å…³ç³»</span></span><br><span class="line"><span class="keyword">type</span> Student <span class="keyword">struct</span> &#123;</span><br><span class="line">Id <span class="keyword">int</span><span class="string">`orm:"column(Id)"`</span> <span class="comment">//column()æ‹¬å·ä¸­çš„å­—æ®µå°±æ˜¯åœ¨å®šä¹‰æ•°æ®åº“æ—¶çš„ç›¸åº”å­—æ®µï¼Œè¿™ä¸€æ®µå¿…é¡»ä¸¥æ ¼å¡«å†™ï¼Œä¸ç„¶åœ¨APIè¯»å†™æ•°æ®æ—¶å°±ä¼šå‡ºç°è¯»ä¸åˆ°æˆ–è€…å†™ä¸è¿›å»çš„é—®é¢˜</span></span><br><span class="line">Name <span class="keyword">string</span>  <span class="string">`orm:"column(Name)"`</span></span><br><span class="line">BirthDate <span class="keyword">string</span> <span class="string">`orm:"column(Birthdate)"`</span></span><br><span class="line">Gender <span class="keyword">bool</span> <span class="string">`orm:"column(Gender)"`</span></span><br><span class="line">Score <span class="keyword">int</span> <span class="string">`orm:"column(Score)"`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯¥å‡½æ•°è·å¾—æ•°æ®åº“ä¸­æ‰€æœ‰studentçš„ä¿¡æ¯ï¼Œè¿”å›å€¼æ˜¯ä¸€ä¸ªç»“æ„ä½“æ•°ç»„æŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetAllStudents</span><span class="params">()</span> []*<span class="title">Student</span></span> &#123;</span><br><span class="line">o := orm.NewOrm() <span class="comment">//äº§ç”Ÿä¸€ä¸ªormå¯¹è±¡</span></span><br><span class="line">o.Using(<span class="string">"default"</span>) <span class="comment">//è¿™å¥è¯çš„æ„æ€æ˜¯ä½¿ç”¨å®šä¹‰çš„é»˜è®¤æ•°æ®åº“ï¼Œä¸main.goä¸­çš„orm.RegisterDataBase()å¯¹åº”</span></span><br><span class="line"><span class="keyword">var</span> students []*Student <span class="comment">//å®šä¹‰æŒ‡å‘ç»“æ„ä½“æ•°ç»„çš„æŒ‡é’ˆ</span></span><br><span class="line">q := o.QueryTable(<span class="string">"student"</span>)<span class="comment">//è·å¾—ä¸€ä¸ªæ•°æ®åº“è¡¨çš„è¯·æ±‚</span></span><br><span class="line">q.All(&amp;students)<span class="comment">//å–åˆ°è¿™ä¸ªè¡¨ä¸­çš„æ‰€æœ‰æ•°æ®</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> students</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//è¯¥å‡½æ•°æ ¹æ®studentä¸­çš„Idï¼Œè¿”å›è¯¥å­¦ç”Ÿçš„ä¿¡æ¯</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetStudentById</span><span class="params">(id <span class="keyword">int</span>)</span> <span class="title">Student</span></span> &#123;</span><br><span class="line">u := Student&#123;Id:id&#125;<span class="comment">//æ ¹æ®æ‰€ä¼ å…¥çš„Idå¾—åˆ°å¯¹åº”studentçš„å¯¹è±¡</span></span><br><span class="line">o := orm.NewOrm()<span class="comment">//new ä¸€ä¸ªormå¯¹è±¡</span></span><br><span class="line">o.Using(<span class="string">"default"</span>)<span class="comment">//ä½¿ç”¨æœ€å¼€å§‹å®šä¹‰çš„defaultæ•°æ®åº“</span></span><br><span class="line">err := o.Read(&amp;u)<span class="comment">//è¯»å–Id=idçš„studentçš„ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err == orm.ErrNoRows &#123;</span><br><span class="line">fmt.Println(<span class="string">"æŸ¥è¯¢ä¸åˆ°"</span>)<span class="comment">//å¯¹åº”æ“ä½œï¼Œä¸ä¸€å®šæ˜¯print</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> err == orm.ErrMissPK &#123;</span><br><span class="line">fmt.Println(<span class="string">"æ²¡æœ‰ä¸»é”®"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> u</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//æ·»åŠ ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯åˆ°æ•°æ®åº“ä¸­ï¼Œå‚æ•°æ˜¯æŒ‡å‘studentç»“æ„é¢˜çš„æŒ‡é’ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">AddStudent</span><span class="params">(student *Student)</span> <span class="title">Student</span></span> &#123;</span><br><span class="line">o := orm.NewOrm()</span><br><span class="line">o.Using(<span class="string">"default"</span>)</span><br><span class="line">o.Insert(student)<span class="comment">//æ’å…¥æ•°æ®åº“</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> *student</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">UpdateStudent</span><span class="params">(student *Student)</span></span> &#123;</span><br><span class="line">o := orm.NewOrm()</span><br><span class="line">o.Using(<span class="string">"default"</span>)</span><br><span class="line">o.Update(student)<span class="comment">//æ›´æ–°è¯¥studentçš„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DeleteStudent</span><span class="params">(id <span class="keyword">int</span>)</span></span> &#123;</span><br><span class="line">o := orm.NewOrm()</span><br><span class="line">o.Using(<span class="string">"default"</span>)</span><br><span class="line">o.Delete(&amp;Student&#123;Id:id&#125;)<span class="comment">//åˆ é™¤å¯¹åº”idçš„studentçš„ä¿¡æ¯</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span>  &#123;</span><br><span class="line">orm.RegisterModel(<span class="built_in">new</span>(Student))<span class="comment">//å°†æ•°æ®åº“æ³¨å†Œåˆ°orm</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>modelè¿™ä¸€å±‚ä¸»è¦æ˜¯å®šä¹‰structï¼Œå¹¶ä¸ºä¸Šå±‚ç¼–å†™è¯»å†™æ•°æ®åº“ã€‚å¤„ç†æ•°æ®çš„ä»£ç ã€‚</li></ul><h3 id="controllerå±‚å®ç°"><a href="#controllerå±‚å®ç°" class="headerlink" title="controllerå±‚å®ç°"></a>controllerå±‚å®ç°</h3><p>åŸºäº beego çš„ Controller è®¾è®¡ï¼Œåªéœ€è¦åŒ¿åç»„åˆ <code>beego.Controller</code> å°±å¯ä»¥äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> xxxController <span class="keyword">struct</span> &#123;</span><br><span class="line">    beego.Controller</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>beego.Controller</code> å®ç°äº†æ¥å£ <code>beego.ControllerInterface</code>ï¼Œ<code>beego.ControllerInterface</code> å®šä¹‰äº†å¦‚ä¸‹å‡½æ•°ï¼š</p><ul><li><p>Init(ct *context.Context, childName string, app interface{})</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦åˆå§‹åŒ–äº† Contextã€ç›¸åº”çš„ Controller åç§°ï¼Œæ¨¡æ¿åï¼Œåˆå§‹åŒ–æ¨¡æ¿å‚æ•°çš„å®¹å™¨ Dataï¼Œapp å³ä¸ºå½“å‰æ‰§è¡Œçš„ Controller çš„ reflecttypeï¼Œè¿™ä¸ª app å¯ä»¥ç”¨æ¥æ‰§è¡Œå­ç±»çš„æ–¹æ³•ã€‚</p></li><li><p>Prepare()</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†ç”¨æˆ·æ‰©å±•ç”¨çš„ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨ä¸‹é¢å®šä¹‰çš„è¿™äº› Method æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œç”¨æˆ·å¯ä»¥é‡å†™è¿™ä¸ªå‡½æ•°å®ç°ç±»ä¼¼ç”¨æˆ·éªŒè¯ä¹‹ç±»ã€‚</p></li><li><p>Get()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ GETï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Get è¯·æ±‚ã€‚</p></li><li><p>Post()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ POSTï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Post è¯·æ±‚ã€‚</p></li><li><p>Delete()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ DELETEï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Delete è¯·æ±‚ã€‚</p></li><li><p>Put()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ PUTï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Put è¯·æ±‚.</p></li><li><p>Head()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ HEADï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Head è¯·æ±‚ã€‚</p></li><li><p>Patch()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ PATCHï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Patch è¯·æ±‚.</p></li><li><p>Options()</p><p>å¦‚æœç”¨æˆ·è¯·æ±‚çš„HTTP Methodæ˜¯OPTIONSï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®ç°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Options è¯·æ±‚ã€‚</p></li><li><p>Finish()</p><p>è¿™ä¸ªå‡½æ•°æ˜¯åœ¨æ‰§è¡Œå®Œç›¸åº”çš„ HTTP Method æ–¹æ³•ä¹‹åæ‰§è¡Œçš„ï¼Œé»˜è®¤æ˜¯ç©ºï¼Œç”¨æˆ·å¯ä»¥åœ¨å­ struct ä¸­é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œä¾‹å¦‚æ•°æ®åº“å…³é—­ï¼Œæ¸…ç†æ•°æ®ä¹‹ç±»çš„å·¥ä½œã€‚</p></li><li><p>Render() error</p><p>è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨æ¥å®ç°æ¸²æŸ“æ¨¡æ¿ï¼Œå¦‚æœ beego.AutoRender ä¸º true çš„æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œã€‚</p></li></ul><p>æ‰€ä»¥é€šè¿‡å­ struct çš„æ–¹æ³•é‡å†™ï¼Œç”¨æˆ·å°±å¯ä»¥å®ç°è‡ªå·±çš„é€»è¾‘ã€‚</p><h3 id="routerså±‚å®ç°"><a href="#routerså±‚å®ç°" class="headerlink" title="routerså±‚å®ç°"></a>routerså±‚å®ç°</h3><p>ä»€ä¹ˆæ˜¯è·¯ç”±è®¾ç½®å‘¢ï¼Ÿå‰é¢ä»‹ç»çš„ MVC ç»“æ„æ‰§è¡Œæ—¶ï¼Œä»‹ç»è¿‡ beego å­˜åœ¨ä¸‰ç§æ–¹å¼çš„è·¯ç”±:å›ºå®šè·¯ç”±ã€æ­£åˆ™è·¯ç”±ã€è‡ªåŠ¨è·¯ç”±ï¼Œä¸RESTFul APIç›¸å…³çš„å°±æ˜¯å›ºå®šè·¯ç”±å’Œæ­£åˆ™è·¯ç”±ã€‚</p><p>ä¸‹é¢å°±æ˜¯å›ºå®šè·¯ç”±çš„ä¾‹å­</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">beego.Router(<span class="string">"/"</span>, &amp;controllers.MainController&#123;&#125;)</span><br><span class="line">beego.Router(<span class="string">"/admin"</span>, &amp;admin.UserController&#123;&#125;)</span><br><span class="line">beego.Router(<span class="string">"/admin/index"</span>, &amp;admin.ArticleController&#123;&#125;)</span><br><span class="line">beego.Router(<span class="string">"/admin/addpkg"</span>, &amp;admin.AddController&#123;&#125;)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯æ­£åˆ™è·¯ç”±çš„ä¾‹å­ï¼š</p><ul><li><p>beego.Router(â€œ/api/?:idâ€, &amp;controllers.RController{})</p><p>é»˜è®¤åŒ¹é… //ä¾‹å¦‚å¯¹äºURLâ€/api/123â€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:idâ€å€¼ä¸ºâ€123â€</p></li><li><p>beego.Router(â€œ/api/:idâ€, &amp;controllers.RController{})</p><p>é»˜è®¤åŒ¹é… //ä¾‹å¦‚å¯¹äºURLâ€/api/123â€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:idâ€å€¼ä¸ºâ€123â€ï¼Œä½†URLâ€/api/â€œåŒ¹é…å¤±è´¥</p></li><li><p>beego.Router(â€œ/api/:id([0-9]+)â€œ, &amp;controllers.RController{})</p><p>è‡ªå®šä¹‰æ­£åˆ™åŒ¹é… //ä¾‹å¦‚å¯¹äºURLâ€/api/123â€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:idâ€å€¼ä¸ºâ€123â€</p></li><li><p>beego.Router(â€œ/user/:username([\w]+)â€œ, &amp;controllers.RController{})</p><p>æ­£åˆ™å­—ç¬¦ä¸²åŒ¹é… //ä¾‹å¦‚å¯¹äºURLâ€/user/astaxieâ€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:usernameâ€å€¼ä¸ºâ€astaxieâ€</p></li><li><p>beego.Router(â€œ/download/<em>.</em>â€, &amp;controllers.RController{})</p><p>*åŒ¹é…æ–¹å¼ //ä¾‹å¦‚å¯¹äºURLâ€/download/file/api.xmlâ€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:pathâ€å€¼ä¸ºâ€file/apiâ€ï¼Œ â€œ:extâ€å€¼ä¸ºâ€xmlâ€</p></li><li><p>beego.Router(â€œ/download/ceshi/*â€œ, &amp;controllers.RController{})</p><p>*å…¨åŒ¹é…æ–¹å¼ //ä¾‹å¦‚å¯¹äºURLâ€/download/ceshi/file/api.jsonâ€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:splatâ€å€¼ä¸ºâ€file/api.jsonâ€</p></li><li><p>beego.Router(â€œ/:id:intâ€, &amp;controllers.RController{})</p><p>int ç±»å‹è®¾ç½®æ–¹å¼ï¼ŒåŒ¹é… :idä¸ºint ç±»å‹ï¼Œæ¡†æ¶å¸®ä½ å®ç°äº†æ­£åˆ™ ([0-9]+)</p></li><li><p>beego.Router(â€œ/:hi:stringâ€, &amp;controllers.RController{})</p><p>string ç±»å‹è®¾ç½®æ–¹å¼ï¼ŒåŒ¹é… :hi ä¸º string ç±»å‹ã€‚æ¡†æ¶å¸®ä½ å®ç°äº†æ­£åˆ™ ([\w]+)</p></li><li><p>beego.Router(â€œ/cms_:id([0-9]+).htmlâ€, &amp;controllers.CmsController{})</p><p>å¸¦æœ‰å‰ç¼€çš„è‡ªå®šä¹‰æ­£åˆ™ //åŒ¹é… :id ä¸ºæ­£åˆ™ç±»å‹ã€‚åŒ¹é… cms_123.html è¿™æ ·çš„ url :id = 123</p></li></ul><p>ä¸ªäººè§‰å¾—ï¼Œæœ€æ–¹ä¾¿çš„è¿˜æ˜¯ç±»ä¼¼äºPythonæ¡†æ¶flaskçš„æ³¨è§£è·¯ç”±ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨çš„ï¼š</p><ul><li><p>åœ¨routers/routers.goé‡Œé¢æ·»åŠ ä½ æ‰€å¸Œæœ›çš„API</p></li><li><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> routers</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"firstAPI/controllers"</span></span><br><span class="line"></span><br><span class="line"><span class="string">"github.com/astaxie/beego"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">ns := beego.NewNamespace(<span class="string">"/v1"</span>,</span><br><span class="line">beego.NSNamespace(<span class="string">"/object"</span>,</span><br><span class="line">beego.NSInclude(</span><br><span class="line">&amp;controllers.ObjectController&#123;&#125;,</span><br><span class="line">),</span><br><span class="line">),</span><br><span class="line">beego.NSNamespace(<span class="string">"/user"</span>,</span><br><span class="line">beego.NSInclude(</span><br><span class="line">&amp;controllers.UserController&#123;&#125;,</span><br><span class="line">),</span><br><span class="line">),</span><br><span class="line">beego.NSNamespace(<span class="string">"/student"</span>,</span><br><span class="line">beego.NSInclude(</span><br><span class="line">&amp;controllers.StudentController&#123;&#125;,</span><br><span class="line">),</span><br><span class="line">),</span><br><span class="line">)</span><br><span class="line">beego.AddNamespace(ns)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>ä»¥ä¸Šä»£ç å®ç°äº†å¦‚ä¸‹çš„APIï¼š</p><p>/v1/object</p><p>/v1/user</p><p>/v1/student</p><p>éå¸¸æ¸…æ™°æ˜äº†ã€‚</p><h3 id="main-goçš„æ•°æ®åº“é…ç½®"><a href="#main-goçš„æ•°æ®åº“é…ç½®" class="headerlink" title="main.goçš„æ•°æ®åº“é…ç½®"></a>main.goçš„æ•°æ®åº“é…ç½®</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">_ <span class="string">"firstAPI/routers"</span></span><br><span class="line"><span class="string">"github.com/astaxie/beego"</span></span><br><span class="line"><span class="string">"github.com/astaxie/beego/orm"</span></span><br><span class="line">_ <span class="string">"github.com/go-sql-driver/mysql"</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">orm.RegisterDriver(<span class="string">"mysql"</span>, orm.DRMySQL)<span class="comment">//æ³¨å†ŒMySQLçš„driver</span></span><br><span class="line">orm.RegisterDataBase(<span class="string">"default"</span>, <span class="string">"mysql"</span>, <span class="string">"root:test@tcp(127.0.0.1:3306)/restapi_test?charset=utf8"</span>)<span class="comment">//æœ¬åœ°æ•°æ®åº“çš„è´¦å·ã€‚å¯†ç ç­‰</span></span><br><span class="line">orm.RunSyncdb(<span class="string">"default"</span>, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> beego.BConfig.RunMode == <span class="string">"dev"</span> &#123;</span><br><span class="line">beego.BConfig.WebConfig.DirectoryIndex = <span class="literal">true</span></span><br><span class="line">beego.BConfig.WebConfig.StaticDir[<span class="string">"/swagger"</span>] = <span class="string">"swagger"</span><span class="comment">//é™æ€æ–‡æ¡£</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">beego.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…³é”®ç‚¹éƒ½åœ¨ä»£ç ä¸­ä»¥æ³¨é‡Šçš„å½¢å¼å±•ç°ã€‚</p><h3 id="postmanæµ‹è¯•"><a href="#postmanæµ‹è¯•" class="headerlink" title="postmanæµ‹è¯•"></a>postmanæµ‹è¯•</h3><p>bee run è¿è¡Œä»£ç åï¼Œæˆ‘ä»¬ä½¿ç”¨postmanæµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬æ‰€æ„å»ºçš„APIæ•ˆæœå¦‚ä½•ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tNbRwly1fw7w1tcnesj31kw0y90y6.jpg" alt=""></p><p>è¿™é‡ŒèŠ‚çœç¯‡å¹…ï¼Œåªæµ‹è¯•ä¸€ä¸ªæ¥å£ã€‚</p><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬åŸºäºbeegoå°±å®ç°äº†ç®€å•APIæ¥å£çš„æ„å»ºï¼Œæ˜¯ä¸æ˜¯æ—¢æ¸…æ™°åˆç®€å•å‘¢ï¼Ÿèµ¶å¿«è‡ªå·±åŠ¨æ‰‹è¯•è¯•å§ï¼</p><p>æœ¬æœŸæŠ€æœ¯å‘¨åˆŠç»“æŸï¼Œä»£ç å·²ä¸Šä¼ åˆ°<a href="https://github.com/hantmac/beego_api_demo" target="_blank" rel="noopener">GitHub</a>ï¼Œå¯ä»¥æŸ¥é˜…ï¼Œæˆ‘ä»¬ä¸‹æœŸå†ä¼šï¼</p><hr>]]></content>
    
    <summary type="html">
    
      æœ¬æ–‡ä»‹ç»é€šè¿‡ä½¿ç”¨golang webå¼€å‘æ¡†æ¶beegoæ­å»ºRESTFULé£æ ¼çš„API
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="golang beego" scheme="https://cloudsjhan.github.io/tags/golang-beego/"/>
    
  </entry>
  
  <entry>
    <title>æ€»ç»“ç‰ˆå›¾è§£http</title>
    <link href="https://cloudsjhan.github.io/2018/10/12/%E6%80%BB%E7%BB%93%E7%89%88%E5%9B%BE%E8%A7%A3http/"/>
    <id>https://cloudsjhan.github.io/2018/10/12/æ€»ç»“ç‰ˆå›¾è§£http/</id>
    <published>2018-10-12T02:20:37.000Z</published>
    <updated>2018-10-12T02:28:44.744Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p><strong>è¯¥åšå®¢è½¬è½½è‡ªå…¬ä¼—å·<a href="https://mp.weixin.qq.com/s/MvMyH1vTCsxBCdHfH7uv1w" target="_blank" rel="noopener">freeCodeCamp</a></strong></p><p>ä½œä¸ºä¸€ä¸ªå‰ç«¯ï¼Œå¦‚æœå¯¹ä¸€ä¸ªç½‘é¡µä»å‘èµ·è¯·æ±‚åˆ°è¿”å›æ•°æ®è¿™æœŸé—´å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆéƒ½ä¸çŸ¥é“çš„è¯ï¼Œé‚£ä¸æ˜¯ä¸€ä¸ªå¥½å‰ç«¯ã€‚æœ€è¿‘ï¼Œè¯»äº†å›¾è§£httpï¼Œä»¥åŠæœ‰å…³httpç›¸å…³çš„æ–‡ç« ï¼Œè¿˜æœ‰è‡ªå·±ä¹Ÿä¸‹è½½äº†wiresharkæŠ“åŒ…å·¥å…·ï¼Œå®é™…è§‚å¯Ÿäº†ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢å°±æ­¤åšäº›æ€»ç»“ã€‚</p><p><strong>ä¸€.ä»è¾“å…¥ä¸€ä¸ªurlåˆ°è¿”å›æ•°æ®ï¼Œä¸­é—´åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</strong></p><p>å‡è®¾ï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥<a href="http://www.baidu.com:80/index.htmlï¼Œå‡è®¾è§£æå‡ºçš„ipåœ°å€æ˜¯202.43.78.3" target="_blank" rel="noopener">http://www.baidu.com:80/index.htmlï¼Œå‡è®¾è§£æå‡ºçš„ipåœ°å€æ˜¯202.43.78.3</a></p><p><strong>1.æµè§ˆå™¨è§£æå‡ºä¸»æœºå</strong></p><p>è§£æå‡ºçš„ä¸»æœºåæ˜¯<a href="http://www.baidu.com" target="_blank" rel="noopener">www.baidu.com</a></p><p><strong>2.æµè§ˆå™¨æŸ¥è¯¢è¿™ä¸ªä¸»æœºåçš„ipåœ°å€ï¼ˆdnsï¼‰</strong></p><p>dnsè§£æçš„ä½œç”¨å°±æ˜¯æŠŠåŸŸåè§£ææˆipåœ°å€ï¼Œè¿™æ ·æ‰èƒ½åœ¨å¹¿åŸŸç½‘è·¯ç”±å™¨è½¬å‘æŠ¥æ–‡ç»™ç›®æ ‡ipï¼Œä¸ç„¶è·¯ç”±å™¨ä¸çŸ¥é“è¦æŠŠæŠ¥æ–‡å‘ç»™è°ã€‚ä¸‹é¢å°±è®²ä¸‹å¤§æ¦‚çš„è¿‡ç¨‹ï¼Œä¸ä¼šæ¶‰åŠå¤ªå¤šç»†èŠ‚ã€‚ï¼ˆä»¥chromeä¸ºä¾‹å­ï¼‰</p><p>ï¼ˆ1ï¼‰æµè§ˆå™¨å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæµè§ˆå™¨ä¼šå»æ“ä½œç³»ç»Ÿè·å–dnsæœåŠ¡å™¨åœ°å€ï¼Œç„¶åæŠŠè¿™ä¸ªåœ°å€ç¼“å­˜ä¸‹æ¥ã€‚åŒæ—¶æµè§ˆå™¨è¿˜ä¼šå»è¯»å–å’Œè§£æhostsæ–‡ä»¶ï¼ŒåŒæ ·æ”¾åˆ°ç¼“å­˜ä¸­ã€‚æµè§ˆå™¨å¯¹è§£æè¿‡çš„åŸŸåå’Œipåœ°å€ï¼Œéƒ½ä¼šä¿å­˜ç€è¿™ä¸¤è€…çš„æ˜ å°„å…³ç³»ã€‚ï¼ˆå­˜åˆ°cacheä¸­ï¼‰</p><p>ï¼ˆ2ï¼‰å½“è§£æåŸŸåçš„æ—¶å€™ï¼Œé¦–å…ˆæµè§ˆå™¨ä¼šå»cacheä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰ç¼“å­˜å¥½çš„æ˜ å°„å…³ç³»ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°±å»hostsæ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼Œå¦‚æœä¹Ÿæ²¡æœ‰çš„è¯ï¼Œæµè§ˆå™¨å°±ä¼šå‘èµ·è¯·æ±‚å»dnsæœåŠ¡å™¨ç¼“å­˜æŸ¥è¯¢äº†ï¼Œå¦‚æœç¼“å­˜é‡Œé¢ä¹Ÿæ²¡æœ‰ï¼Œé‚£æœ€åå°±æ˜¯dnsæœåŠ¡å™¨å»æŸ¥è¯¢äº†ã€‚</p><p><strong>3.æµè§ˆå™¨è·å–ç«¯å£å·</strong></p><p><strong>4.æµè§ˆå™¨å‘ç›®æ ‡ipåœ°å€å‘èµ·ä¸€æ¡åˆ°202.43.78.3:80çš„tcpè¿æ¥</strong></p><p>ä¸ºäº†ä¼ è¾“çš„å¯é æ€§ï¼Œtcpåè®®è¦æœ‰ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š</p><p>ï¼ˆ1ï¼‰é¦–å…ˆæµè§ˆå™¨ä¼šå‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªè¿æ¥è¯·æ±‚</p><p>ï¼ˆ2ï¼‰æœåŠ¡å™¨ä¼šå¯¹è¿æ¥è¯·æ±‚åšå‡ºå“åº”ï¼Œè¡¨ç¤ºåŒæ„å»ºç«‹è¿æ¥</p><p>ï¼ˆ3ï¼‰æµè§ˆå™¨æ”¶åˆ°å“åº”åï¼Œå†å‘ŠçŸ¥å¯¹æ–¹ï¼Œå®ƒçŸ¥é“æœåŠ¡å™¨åŒæ„å®ƒå»ºç«‹è¿æ¥äº†ã€‚</p><p><strong>5.æ•°æ®åŒ…åœ¨ipå±‚ä¼ è¾“</strong></p><p>æ•°æ®åŒ…åœ¨ipå±‚ä¼ è¾“ï¼Œé€šè¿‡å¤šå°è®¡ç®—æœºå’Œç½‘ç»œè®¾å¤‡ä¸­è½¬ï¼Œåœ¨ä¸­è½¬æ—¶ï¼Œåˆ©ç”¨ä¸­è½¬è®¾å¤‡çš„macåœ°å€æœç´¢ä¸‹ä¸€ä¸ªä¸­è½¬ç›®æ ‡ï¼ˆé‡‡ç”¨ARPåè®®ï¼Œæ ¹æ®é€šä¿¡æ–¹çš„ipåœ°å€å°±å¯ä»¥åæŸ¥å‡ºå¯¹åº”çš„macåœ°å€ï¼‰ï¼Œç›´åˆ°ç›®æ ‡ipåœ°å€ã€‚</p><p><strong>6.æ•°æ®é“¾è·¯å±‚å¤„ç†ç½‘ç»œè¿æ¥çš„ç¡¬ä»¶éƒ¨åˆ†</strong></p><p>æ•°æ®é“¾è·¯å±‚å¤„ç†ç½‘ç»œè¿æ¥çš„ç¡¬ä»¶éƒ¨åˆ†ï¼Œæ¯”å¦‚ç½‘å¡ï¼Œæ‰¾åˆ°æœåŠ¡å™¨çš„ç½‘å¡</p><p><strong>7.æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ä¸€æ¡httpæŠ¥æ–‡</strong></p><p>æ¯ä¸€æ¡httpæŠ¥æ–‡çš„ç»„æˆï¼š</p><p>èµ·å§‹è¡Œ+é¦–éƒ¨+ä¸»ä½“(å¯é€‰)</p><p>èµ·å§‹è¡Œï¼šhttp/1.0 200 ok (ä¸€èˆ¬åŒ…æ‹¬httpç‰ˆæœ¬ï¼Œè¿”å›çŠ¶æ€ç ï¼Œè¿”å›ç åŸå› )</p><p>é¦–éƒ¨ï¼šcontent-type:text/plain content-length:19</p><p>ä¸»ä½“ï¼šname=jane</p><p><strong>8.æœåŠ¡å™¨æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿›è¡Œä¸€äº›å¤„ç†ï¼Œè¿”å›å“åº”æŠ¥æ–‡</strong></p><p>webæœåŠ¡å™¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œå®é™…ä¸Šä¼šåšäº›ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>ï¼ˆ1ï¼‰å»ºç«‹è¿æ¥ï¼Œå¦‚æœæ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥ï¼Œå°±å»ºç«‹è¿æ¥ï¼Œå¦‚æœä¸åŒæ„ï¼Œå°±å°†å…¶å…³é—­ã€‚</p><p>ï¼ˆ2ï¼‰æ¥æ”¶è¯·æ±‚ï¼Œè¯»å–httpè¯·æ±‚æŠ¥æ–‡</p><p>ï¼ˆ3ï¼‰è®¿é—®èµ„æºï¼Œè®¿é—®æŠ¥æ–‡ä¸­æŒ‡å®šçš„èµ„æº</p><p>ï¼ˆ4ï¼‰æ„å»ºå“åº”ï¼Œåˆ›å»ºå¸¦æœ‰é¦–éƒ¨çš„httpå“åº”æŠ¥æ–‡</p><p>ï¼ˆ5ï¼‰å‘é€å“åº”ï¼Œå°†å“åº”å›é€ç»™å®¢æˆ·ç«¯</p><p><strong>9.æµè§ˆå™¨è¯»å–httpå“åº”æŠ¥æ–‡</strong></p><p><strong>10.æµè§ˆå™¨å…³é—­è¿æ¥</strong></p><p>çœ‹äº†ä¸Šé¢çš„ä¸€ä¸ªç®€å•è¿‡ç¨‹ï¼Œå¤§å®¶ä¼šä¸ä¼šæœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œéš¾é“æ¯æ¬¡å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ï¼Œéƒ½è¦å»ºç«‹ä¸€æ¬¡tcpè¿æ¥å—ï¼Œæˆ‘ä»¬ç»å¸¸å†™çš„å¹¶å‘ajaxè¯·æ±‚ï¼Œæ¯æ¡è¯·æ±‚éƒ½æ˜¯å„è‡ªç‹¬ç«‹å»ºç«‹çš„tcpè¿æ¥ï¼Ÿä¸€æ¡tcpè¿æ¥å»ºç«‹ä¹‹åï¼Œæ˜¯ä»€ä¹ˆæ—¶å€™å…³é—­çš„ï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜ï¼Œçœ‹çœ‹ä¸‹é¢è¦è®²çš„httpçš„ç‰¹æ€§</p><p><strong>äºŒ.httpçš„ç‰¹æ€§</strong></p><p><strong>1.httpæ˜¯ä¸ä¿å­˜çŠ¶æ€çš„åè®®</strong></p><p>httpåè®®æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼Œæ„æ€å°±æ˜¯è¯´å®ƒä¸ä¼šå¯¹æ¯æ¬¡çš„è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„é€šä¿¡çŠ¶æ€è¿›è¡Œä¿å­˜ã€‚ä½ ä¹‹å‰å‘è¿‡çš„ä»»ä½•è¯·æ±‚çš„ä¿¡æ¯ï¼Œæ²¡æœ‰ä»»ä½•è®°å½•ã€‚ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œä¹Ÿæ˜¯ä¸ºäº†è®©httpå˜å¾—æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥å¤„ç†å¤§é‡äº‹ç‰©ã€‚ä½†æ˜¯æ— çŠ¶æ€çš„ç‰¹æ€§ï¼Œä¹Ÿä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªç”¨æˆ·ç™»å½•ä¸€å®¶ç½‘ç«™ä¹‹åï¼Œè·³åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œåº”è¯¥è¿˜ä¿æŒç€ç™»å½•çŠ¶æ€ï¼Œæ‰€ä»¥åé¢å°±å‡ºäº†cookieçŠ¶æ€ç®¡ç†æŠ€æœ¯ã€‚ç›¸ä¿¡å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰äº†ã€‚</p><p><strong>2.è¯·æ±‚åªèƒ½ä»å®¢æˆ·ç«¯å¼€å§‹ï¼Œå®¢æˆ·ç«¯ä¸å¯ä»¥æ¥æ”¶é™¤å“åº”ä»¥å¤–çš„æŒ‡ä»¤</strong></p><p>æœåŠ¡å™¨å¿…é¡»ç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰èƒ½ç»™å®¢æˆ·ç«¯å‘é€å“åº”æ•°æ®ï¼Œæ‰€ä»¥è¯´æœåŠ¡å™¨æ˜¯ä¸èƒ½ä¸»åŠ¨ç»™å®¢æˆ·ç«¯æ¨é€æ•°æ®çš„ã€‚å¯¹äºä¸€äº›å®æ—¶ç›‘æ§çš„åŠŸèƒ½ï¼Œå¸¸å¸¸ç”¨websocketæ¥ä»£æ›¿</p><p><strong>3.æ²¡æœ‰ç”¨æˆ·è®¤è¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‘èµ·è¯·æ±‚</strong></p><p>åœ¨httpåè®®é€šä¿¡æ—¶ï¼Œæ˜¯ä¸å­˜åœ¨ç¡®è®¤é€šä¿¡æ–¹çš„å¤„ç†æ­¥éª¤çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‘èµ·è¯·æ±‚ã€‚å¦å¤–ï¼ŒæœåŠ¡å™¨åªè¦æ”¶åˆ°è¯·æ±‚ï¼Œæ— è®ºæ˜¯è°ï¼Œéƒ½ä¼šè¿”å›ä¸€ä¸ªå“åº”ã€‚æ‰€ä»¥ä¼šå­˜åœ¨ä¼ªè£…çš„éšæ‚£ã€‚åé¢å‡ºç°çš„httpså°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p><strong>4.é€šä¿¡ä½¿ç”¨çš„æ˜¯æ˜æ–‡</strong></p><p><strong>5.æ— æ³•è¯æ˜æŠ¥æ–‡å®Œæ•´æ€§</strong></p><p><strong>6.å¯ä»»æ„é€‰æ‹©æ•°æ®å‹ç¼©æ ¼å¼ï¼Œéå¼ºåˆ¶å‹ç¼©å‘é€</strong></p><p><strong>7.httpæŒä¹…è¿æ¥å’Œå¹¶è¡Œè¿æ¥</strong></p><p>ä¸€å¼€å§‹ï¼Œhttpè¯·æ±‚æ˜¯ä¸²è¡Œçš„ï¼Œä¸€ä¸ªhttpè¯·æ±‚ï¼Œå°±ä¼šå»ºç«‹ä¸€æ¡tcpè¿æ¥ï¼Œæµè§ˆå™¨æ”¶åˆ°å“åº”ä¹‹åï¼Œå°±ä¼šæ–­å¼€è¿æ¥ã€‚ç­‰ä¸Šä¸€ä¸ªè¯·æ±‚å›æ¥äº†ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚æ‰èƒ½ç»§ç»­è¯·æ±‚ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯ï¼Œæ¯”è¾ƒè€—æ—¶é—´å’Œå†…å­˜ï¼Œåé¢å°±å‡ºç°äº†ä¸‹é¢ä¸€ç³»åˆ—çš„ä¼˜åŒ–è¿æ¥æ€§èƒ½çš„æ–¹æ³•ã€‚</p><p>ï¼ˆ1ï¼‰å¹¶è¡Œè¿æ¥</p><p>åŸç†ï¼šé€šè¿‡å¤šæ¡tcpè¿æ¥å‘èµ·å¹¶å‘çš„httpè¯·æ±‚</p><p>å¹¶è¡Œè¿æ¥å¯ä»¥åŒæ—¶å‘èµ·å¤šä¸ªhttpè¯·æ±‚ï¼Œæ¯æ¬¡å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ï¼Œå°±ä¼šå»ºç«‹ä¸€ä¸ªtcpè¿æ¥ã€‚æ¯ä¸ªhttpè¯·æ±‚æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç›¸äº’ç­‰å¾…ï¼Œè¿™æ ·åšï¼Œå¾ˆå¯èƒ½ä¼šæé«˜é¡µé¢çš„åŠ è½½é€Ÿåº¦ï¼Œå› ä¸ºäººä»¬ä¼šçœ‹åˆ°é¡µé¢ä¸Šé¢ï¼Œå¾ˆå¤šä¸ªä¸œè¥¿ä¼šåŒæ—¶å‡ºç°ï¼Œæ‰€ä»¥æ„Ÿè§‰é¡µé¢åŠ è½½å˜å¿«äº†ã€‚å®é™…ä¸Šæœ‰æ—¶å€™æ˜¯çœŸçš„å˜å¿«äº†ï¼Œå› ä¸ºå®ƒæ˜¯å¹¶è¡Œå·¥ä½œçš„ã€‚ä½†æ˜¯æœ‰æ—¶å€™ä¸æ˜¯çœŸçš„å¿«äº†ã€‚æ¯”å¦‚è¯´ï¼Œå®¢æˆ·ç«¯çš„ç½‘ç»œå¸¦å®½ä¸è¶³æ—¶ï¼Œï¼ˆæµè§ˆå™¨æ˜¯é€šè¿‡ä¸€ä¸ª28kbpsçš„modemè¿æ¥åˆ°å› ç‰¹ç½‘ä¸Šå»çš„ï¼‰ï¼Œå¦‚æœå¹¶è¡ŒåŠ è½½å¤šä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚å°±ä¼šå»ç«äº‰è¿™ä¸ªæœ‰é™çš„å¸¦å®½ï¼Œæ¯ä¸ªè¯·æ±‚å°±ä¼šä»¥æ¯”è¾ƒæ…¢çš„é€Ÿåº¦åŠ è½½ã€‚è¿™æ ·å¸¦æ¥çš„æ€§èƒ½æå‡å°±å¾ˆå°ã€‚</p><p>ï¼ˆ2ï¼‰æŒä¹…è¿æ¥</p><p>åŸç†ï¼šé‡ç”¨tcpè¿æ¥ï¼Œä»¥æ¶ˆé™¤è¿æ¥åŠå…³é—­æ—¶å»¶</p><p>ä»http1.1å¼€å§‹ï¼Œå°±å…è®¸å½“httpå“åº”ç»“æŸåï¼Œtcpè¿æ¥å¯ä»¥ä¿æŒåœ¨æ‰“å¼€çŠ¶æ€ï¼Œä»¥ä¾¿ç»™æœªæ¥çš„httpè¯·æ±‚é‡ç”¨ç°åœ¨çš„è¿æ¥ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªtcpè¿æ¥ä»€ä¹ˆæ—¶å€™ä¼šå…³é—­å‘¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ40så†…ï¼Œå¦‚æœæ²¡æœ‰æ–°çš„è¯·æ±‚ï¼Œå°±ä¼šå…³é—­ã€‚</p><p>ï¼ˆ3ï¼‰ç®¡é“åŒ–è¿æ¥</p><p>åŸç†ï¼šé€šè¿‡å…±äº«çš„tcpè¿æ¥å‘èµ·å¹¶å‘çš„httpè¯·æ±‚</p><p>å¹¶è¡Œè¿æ¥å¯ä»¥æé«˜å¤åˆé¡µé¢çš„ä¼ è¾“é€Ÿåº¦ï¼Œä½†æ˜¯ä¹Ÿæœ‰è®¸å¤šç¼ºç‚¹ï¼Œæ¯”å¦‚æ¯æ¬¡éƒ½ä¼šå»ºç«‹ä¸€æ¬¡tcpè¿æ¥ï¼Œä¼šè€—è´¹æ—¶é—´å’Œå¸¦å®½ã€‚æŒä¹…è¿æ¥çš„ä¼˜åŠ¿å°±æ˜¯é™ä½äº†æ—¶å»¶å’Œtcpçš„è¿æ¥æ•°é‡ã€‚ä½†æ˜¯æŒä¹…è¿æ¥å¯èƒ½ä¼šå¯¼è‡´çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¯èƒ½ä¼šç´¯ç§¯å¤§é‡çš„ç©ºé—²è¿æ¥ã€‚è€—è´¹èµ„æºã€‚</p><p>æŒä¹…è¿æ¥å’Œå¹¶è¡Œè¿æ¥é…åˆä½¿ç”¨æ‰æ˜¯æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚</p><p>ä¸€èˆ¬æµè§ˆå™¨ä¼šé™åˆ¶ï¼ŒåŒä¸ªåŸŸåä¸‹çš„å¹¶è¡Œè¿æ¥çš„ä¸ªæ•°æ˜¯4ä¸ªï¼Œå³æ‰“å¼€å°‘é‡çš„å¹¶è¡Œè¿æ¥ï¼Œå…¶ä¸­æ¯ä¸ªéƒ½æ˜¯æŒä¹…è¿æ¥ã€‚è¿™ä¹Ÿæ˜¯ç°åœ¨ç”¨çš„æœ€å¤šçš„æ–¹å¼ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      å¯¹äºã€Šå›¾è§£HTTPã€‹ä¸€ä¹¦è¿›è¡Œè¨€ç®€æ„èµ…çš„æ€»ç»“
    
    </summary>
    
      <category term="ç½‘ç»œ" scheme="https://cloudsjhan.github.io/categories/%E7%BD%91%E7%BB%9C/"/>
    
    
      <category term="ç½‘ç»œ" scheme="https://cloudsjhan.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>python apscheduler - skipped: maximum number of running instances reached</title>
    <link href="https://cloudsjhan.github.io/2018/09/28/python-apscheduler-skipped-maximum-number-of-running-instances-reached/"/>
    <id>https://cloudsjhan.github.io/2018/09/28/python-apscheduler-skipped-maximum-number-of-running-instances-reached/</id>
    <published>2018-09-28T08:04:43.000Z</published>
    <updated>2018-09-28T08:14:25.410Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="å‡ºç°é—®é¢˜çš„ä»£ç "><a href="#å‡ºç°é—®é¢˜çš„ä»£ç " class="headerlink" title="å‡ºç°é—®é¢˜çš„ä»£ç "></a>å‡ºç°é—®é¢˜çš„ä»£ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">scheduler = BackgroundScheduler()</span><br><span class="line">scheduler.add_job(runsync, <span class="string">'interval'</span>, seconds=<span class="number">1</span>)</span><br><span class="line">scheduler.start()</span><br></pre></td></tr></table></figure><h3 id="é—®é¢˜å‡ºç°çš„æƒ…å†µ"><a href="#é—®é¢˜å‡ºç°çš„æƒ…å†µ" class="headerlink" title="é—®é¢˜å‡ºç°çš„æƒ…å†µ"></a>é—®é¢˜å‡ºç°çš„æƒ…å†µ</h3><ul><li>è¿è¡Œä¸€æ®µä»£ç ï¼Œæ—¶è€ŒæŠ¥é”™æ—¶è€Œä¸æŠ¥é”™</li><li>æŠ¥é”™æ˜¯ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING:apscheduler.scheduler:Execution of job &quot;runsync (trigger: interval[0:00:01], next run at: 2015-12-01 11:50:42 UTC)&quot; skipped: maximum number of running instances reached (1)</span><br></pre></td></tr></table></figure><h3 id="åˆ†æ"><a href="#åˆ†æ" class="headerlink" title="åˆ†æ"></a>åˆ†æ</h3><ul><li><p>apschedulerè¿™ä¸ªæ¨¡å—ï¼Œåœ¨ä½ çš„ä»£ç è¿è¡Œæ—¶é—´å¤§äºintervalçš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥é”™</p><p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ çš„ä»£ç è¿è¡Œæ—¶é—´è¶…å‡ºäº†ä½ çš„å®šæ—¶ä»»åŠ¡çš„æ—¶é—´é—´éš”ã€‚</p></li></ul><h3 id="è§£å†³"><a href="#è§£å†³" class="headerlink" title="è§£å†³"></a>è§£å†³</h3><ul><li>å¢å¤§æ—¶é—´é—´éš”å³å¯</li></ul><p>### </p><hr>]]></content>
    
    <summary type="html">
    
      python apscheduler - skipped: maximum number of running instances reached
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python çš„loggingæ¨¡å—å®ç°jsonæ ¼å¼çš„æ—¥å¿—è¾“å‡º</title>
    <link href="https://cloudsjhan.github.io/2018/09/27/python-%E7%9A%84logging%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0json%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA/"/>
    <id>https://cloudsjhan.github.io/2018/09/27/python-çš„loggingæ¨¡å—å®ç°jsonæ ¼å¼çš„æ—¥å¿—è¾“å‡º/</id>
    <published>2018-09-27T08:28:21.000Z</published>
    <updated>2018-09-29T01:14:39.201Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h3 id="å‰è¨€ï¼š"><a href="#å‰è¨€ï¼š" class="headerlink" title="å‰è¨€ï¼š"></a>å‰è¨€ï¼š</h3><ul><li>æƒ³è¦è®©å¼€å‘è¿‡ç¨‹æˆ–è€…æ˜¯ä¸Šçº¿åçš„bugæ— å¤„å¯è—ï¼Œæœ€å¥½çš„æ–¹å¼ä¾¿æ˜¯åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸æ–­æ”¶é›†é‡è¦çš„æ—¥å¿—ï¼Œä»¥ä¾›åˆ†æä½¿ç”¨ã€‚Pythonä¸­å†…ç½®çš„logæ”¶é›†æ¨¡å—æ˜¯loggingï¼Œè¯¥æ¨¡å—ä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†æ˜¯ç¾ä¸­ä¸è¶³çš„åœ°æ–¹å°±æ˜¯æ—¥å¿—çš„æ ¼å¼è½¬æˆjsonæ¯”è¾ƒéº»çƒ¦ã€‚äºæ˜¯æˆ‘ç»“åˆloggingå’Œå¦ä¸€ä¸ªæ¨¡å—<a href="https://github.com/madzak/python-json-logger" target="_blank" rel="noopener">python-json-logger</a>(pip install python-json-logger) ï¼Œå®ç°jsonæ ¼å¼çš„æ—¥å¿—è¾“å‡ºã€‚</li></ul><h3 id="æºç ï¼šä»¥ä¸‹ä»£ç å¯ä»¥åšæˆæ¨¡å—ï¼Œç›´æ¥å¯¼å…¥ä½¿ç”¨"><a href="#æºç ï¼šä»¥ä¸‹ä»£ç å¯ä»¥åšæˆæ¨¡å—ï¼Œç›´æ¥å¯¼å…¥ä½¿ç”¨" class="headerlink" title="æºç ï¼šä»¥ä¸‹ä»£ç å¯ä»¥åšæˆæ¨¡å—ï¼Œç›´æ¥å¯¼å…¥ä½¿ç”¨"></a>æºç ï¼šä»¥ä¸‹ä»£ç å¯ä»¥åšæˆæ¨¡å—ï¼Œç›´æ¥å¯¼å…¥ä½¿ç”¨</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging, logging.config, os</span><br><span class="line"><span class="keyword">import</span> structlog</span><br><span class="line"><span class="keyword">from</span> structlog <span class="keyword">import</span> configure, processors, stdlib, threadlocal</span><br><span class="line"><span class="keyword">from</span> pythonjsonlogger <span class="keyword">import</span> jsonlogger</span><br><span class="line">BASE_DIR = BASE_DIR = os.path.dirname(os.path.abspath(__file__))</span><br><span class="line">DEBUG = <span class="keyword">True</span>  <span class="comment"># æ ‡è®°æ˜¯å¦åœ¨å¼€å‘ç¯å¢ƒ</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™è¿‡æ»¤å™¨ä½¿ç”¨çš„åˆ¤æ–­</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequireDebugTrue</span><span class="params">(logging.Filter)</span>:</span></span><br><span class="line">    <span class="comment"># å®ç°filteræ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filter</span><span class="params">(self, record)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> DEBUG</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_logger</span><span class="params">()</span>:</span></span><br><span class="line">    LOGGING = &#123;</span><br><span class="line">    <span class="comment"># åŸºæœ¬è®¾ç½®</span></span><br><span class="line">        <span class="string">'version'</span>: <span class="number">1</span>,  <span class="comment"># æ—¥å¿—çº§åˆ«</span></span><br><span class="line">        <span class="string">'disable_existing_loggers'</span>: <span class="keyword">False</span>,  <span class="comment"># æ˜¯å¦ç¦ç”¨ç°æœ‰çš„è®°å½•å™¨</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># æ—¥å¿—æ ¼å¼é›†åˆ</span></span><br><span class="line">        <span class="string">'formatters'</span>: &#123;</span><br><span class="line">        <span class="comment"># æ ‡å‡†è¾“å‡ºæ ¼å¼</span></span><br><span class="line">            <span class="string">'json'</span>: &#123;</span><br><span class="line">            <span class="comment"># [å…·ä½“æ—¶é—´][çº¿ç¨‹å:çº¿ç¨‹ID][æ—¥å¿—åå­—:æ—¥å¿—çº§åˆ«åç§°(æ—¥å¿—çº§åˆ«ID)] [è¾“å‡ºçš„æ¨¡å—:è¾“å‡ºçš„å‡½æ•°]:æ—¥å¿—å†…å®¹</span></span><br><span class="line">                <span class="string">'format'</span>: <span class="string">'[%(asctime)s][%(threadName)s:%(thread)d][%(name)s:%(levelname)s(%(lineno)d)]\n[%(module)s:%(funcName)s]:%(message)s'</span>,</span><br><span class="line">                <span class="string">'class'</span>: <span class="string">'pythonjsonlogger.jsonlogger.JsonFormatter'</span>,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="comment"># è¿‡æ»¤å™¨</span></span><br><span class="line">        <span class="string">'filters'</span>: &#123;</span><br><span class="line">            <span class="string">'require_debug_true'</span>: &#123;</span><br><span class="line">                <span class="string">'()'</span>: RequireDebugTrue,</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="comment"># å¤„ç†å™¨é›†åˆ</span></span><br><span class="line">        <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="comment"># è¾“å‡ºåˆ°æ§åˆ¶å°</span></span><br><span class="line">        <span class="comment"># è¾“å‡ºåˆ°æ–‡ä»¶</span></span><br><span class="line">            <span class="string">'TimeChecklog'</span>: &#123;</span><br><span class="line">                <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">                <span class="string">'class'</span>: <span class="string">'logging.handlers.RotatingFileHandler'</span>,</span><br><span class="line">                <span class="string">'formatter'</span>: <span class="string">'json'</span>,</span><br><span class="line">                <span class="string">'filename'</span>: os.path.join(<span class="string">"./log/"</span>, <span class="string">'TimeoutCheck.log'</span>),  <span class="comment"># è¾“å‡ºä½ç½®</span></span><br><span class="line">                <span class="string">'maxBytes'</span>: <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">5</span>,  <span class="comment"># æ–‡ä»¶å¤§å° 5M</span></span><br><span class="line">                <span class="string">'backupCount'</span>: <span class="number">5</span>,  <span class="comment"># å¤‡ä»½ä»½æ•°</span></span><br><span class="line">                <span class="string">'encoding'</span>: <span class="string">'utf8'</span>,  <span class="comment"># æ–‡ä»¶ç¼–ç </span></span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">    <span class="comment"># æ—¥å¿—ç®¡ç†å™¨é›†åˆ</span></span><br><span class="line">        <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="comment"># ç®¡ç†å™¨</span></span><br><span class="line">            <span class="string">'proxyCheck'</span>: &#123;</span><br><span class="line">                <span class="string">'handlers'</span>: [<span class="string">'TimeChecklog'</span>],</span><br><span class="line">                <span class="string">'level'</span>: <span class="string">'DEBUG'</span>,</span><br><span class="line">                <span class="string">'propagate'</span>: <span class="keyword">True</span>,  <span class="comment"># æ˜¯å¦ä¼ é€’ç»™çˆ¶è®°å½•å™¨</span></span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    configure(</span><br><span class="line">        logger_factory=stdlib.LoggerFactory(),</span><br><span class="line">        processors=[</span><br><span class="line">            stdlib.render_to_log_kwargs]</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    logging.config.dictConfig(LOGGING)</span><br><span class="line">    logger = logging.getLogger(<span class="string">"proxyCheck"</span>)</span><br><span class="line">    <span class="keyword">return</span> logger</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># æµ‹è¯•ç”¨ä¾‹ï¼Œä½ å¯ä»¥æŠŠget_logger()å°è£…æˆä¸€ä¸ªæ¨¡å—ï¼Œfrom xxx import get_logger()</span></span><br><span class="line">logger1 = get_logger()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        a = <span class="number">1</span> / <span class="number">0</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        logger1.error(e)  <span class="comment"># å†™å…¥é”™è¯¯æ—¥å¿—</span></span><br><span class="line">        <span class="comment">#å¦‚æœéœ€è¦æ·»åŠ é¢å¤–çš„ä¿¡æ¯ï¼Œä½¿ç”¨extraå…³é”®å­—å³å¯</span></span><br><span class="line">        logger1.error(e, extra=&#123;key1: value1, key2:value2&#125;)</span><br><span class="line">        <span class="comment"># å…¶ä»–é”™è¯¯å¤„ç†ä»£ç </span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">test()</span><br></pre></td></tr></table></figure><h3 id="æµ‹è¯•ç»“æœ"><a href="#æµ‹è¯•ç»“æœ" class="headerlink" title="### æµ‹è¯•ç»“æœ"></a>### æµ‹è¯•ç»“æœ</h3><ul><li>æµ‹è¯•çš„ç»“æœï¼Œå¯ä»¥åœ¨./log/xxx.logæ–‡ä»¶ä¸­çœ‹åˆ°è¾“å‡ºçš„æ—¥å¿—</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;asctime&quot;: &quot;2018-09-28 09:52:12,622&quot;, &quot;threadName&quot;: &quot;MainThread&quot;, &quot;thread&quot;: 4338656704, &quot;name&quot;: &quot;proxyCheck&quot;, &quot;levelname&quot;: &quot;ERROR&quot;, &quot;%(lineno&quot;: null, &quot;module&quot;: &quot;mylog&quot;, &quot;funcName&quot;: &quot;test&quot;, &quot;message&quot;: &quot;division by zero&quot;&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯ä»¥çœ‹åˆ°æ—¥å¿—æ˜¯jsonæ ¼å¼ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨grafnaå’ŒESå°†æ—¥å¿—åšæˆçœ‹æ¿æ¥å±•ç¤ºäº†ã€‚</li></ul><hr>]]></content>
    
    <summary type="html">
    
      ä½¿ç”¨Pythonçš„å†…ç½®loggingå®ç°jsonæ ¼å¼çš„æ—¥å¿—è¾“å‡º
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>python å‘é€å„ç§æ ¼å¼çš„é‚®ä»¶</title>
    <link href="https://cloudsjhan.github.io/2018/09/17/python-%E5%8F%91%E9%80%81%E5%90%84%E7%A7%8D%E6%A0%BC%E5%BC%8F%E7%9A%84%E9%82%AE%E4%BB%B6/"/>
    <id>https://cloudsjhan.github.io/2018/09/17/python-å‘é€å„ç§æ ¼å¼çš„é‚®ä»¶/</id>
    <published>2018-09-17T02:55:56.000Z</published>
    <updated>2018-09-28T02:06:31.935Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> smtplib</span><br><span class="line"><span class="keyword">from</span> email.mime.multipart <span class="keyword">import</span> MIMEMultipart</span><br><span class="line"><span class="keyword">from</span> email.mime.text <span class="keyword">import</span> MIMEText</span><br><span class="line"><span class="keyword">from</span> email.mime.application <span class="keyword">import</span> MIMEApplication</span><br><span class="line">_user = <span class="string">"sigeken@qq.com"</span></span><br><span class="line">_pwd  = <span class="string">"***"</span></span><br><span class="line">_to   = <span class="string">"402363522@qq.com"</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#å¦‚åå­—æ‰€ç¤ºMultipartå°±æ˜¯åˆ†å¤šä¸ªéƒ¨åˆ†</span></span><br><span class="line">msg = MIMEMultipart()</span><br><span class="line">msg[<span class="string">"Subject"</span>] = <span class="string">"don't panic"</span></span><br><span class="line">msg[<span class="string">"From"</span>]    = _user</span><br><span class="line">msg[<span class="string">"To"</span>]      = _to</span><br><span class="line"> </span><br><span class="line"><span class="comment">#---è¿™æ˜¯æ–‡å­—éƒ¨åˆ†---</span></span><br><span class="line">part = MIMEText(<span class="string">"ä¹”è£…æ‰“æ‰®ï¼Œä¸æ‹©æ‰‹æ®µ"</span>)</span><br><span class="line">msg.attach(part)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#---è¿™æ˜¯é™„ä»¶éƒ¨åˆ†---</span></span><br><span class="line"><span class="comment">#xlsxç±»å‹é™„ä»¶</span></span><br><span class="line">part = MIMEApplication(open(<span class="string">'foo.xlsx'</span>,<span class="string">'rb'</span>).read())</span><br><span class="line">part.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">"foo.xlsx"</span>)</span><br><span class="line">msg.attach(part)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#jpgç±»å‹é™„ä»¶</span></span><br><span class="line">part = MIMEApplication(open(<span class="string">'foo.jpg'</span>,<span class="string">'rb'</span>).read())</span><br><span class="line">part.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">"foo.jpg"</span>)</span><br><span class="line">msg.attach(part)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#pdfç±»å‹é™„ä»¶</span></span><br><span class="line">part = MIMEApplication(open(<span class="string">'foo.pdf'</span>,<span class="string">'rb'</span>).read())</span><br><span class="line">part.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">"foo.pdf"</span>)</span><br><span class="line">msg.attach(part)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#mp3ç±»å‹é™„ä»¶</span></span><br><span class="line">part = MIMEApplication(open(<span class="string">'foo.mp3'</span>,<span class="string">'rb'</span>).read())</span><br><span class="line">part.add_header(<span class="string">'Content-Disposition'</span>, <span class="string">'attachment'</span>, filename=<span class="string">"foo.mp3"</span>)</span><br><span class="line">msg.attach(part)</span><br><span class="line"> </span><br><span class="line">s = smtplib.SMTP(<span class="string">"smtp.qq.com"</span>, timeout=<span class="number">30</span>)<span class="comment">#è¿æ¥smtpé‚®ä»¶æœåŠ¡å™¨,ç«¯å£é»˜è®¤æ˜¯25</span></span><br><span class="line">s.login(_user, _pwd)<span class="comment">#ç™»é™†æœåŠ¡å™¨</span></span><br><span class="line">s.sendmail(_user, _to, msg.as_string())<span class="comment">#å‘é€é‚®ä»¶</span></span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      ä½¿ç”¨Pythonå‘é€å„ç§æ ¼å¼çš„é‚®ä»¶
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯å‘¨åˆŠä¹‹å½“ä½ pingçš„æ—¶å€™ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</title>
    <link href="https://cloudsjhan.github.io/2018/09/16/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E5%BD%93%E4%BD%A0ping%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F/"/>
    <id>https://cloudsjhan.github.io/2018/09/16/æŠ€æœ¯å‘¨åˆŠä¹‹å½“ä½ pingçš„æ—¶å€™ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ/</id>
    <published>2018-09-16T13:40:02.000Z</published>
    <updated>2018-09-16T13:49:36.202Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><p>æˆ‘ä»¬åœ¨é‡åˆ°ç½‘ç»œä¸é€šçš„æƒ…å†µï¼Œå¤§å®¶éƒ½çŸ¥é“å» ping ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹ç½‘ç»œçŠ¶å†µã€‚é‚£ä½ çŸ¥é“ã€Œpingã€å‘½ä»¤åèƒŒçš„é€»è¾‘æ˜¯ä»€ä¹ˆå—ï¼ŸçŸ¥é“å®ƒæ˜¯å¦‚ä½•å®ç°çš„å—ï¼Ÿæœ¬å‘¨å°±è®©æˆ‘ä»¬æ·±å…¥æµ…å‡ºpingçš„æœºåˆ¶ã€‚</p><h2 id="pingçš„ä½œç”¨å’ŒåŸç†"><a href="#pingçš„ä½œç”¨å’ŒåŸç†" class="headerlink" title="pingçš„ä½œç”¨å’ŒåŸç†"></a>pingçš„ä½œç”¨å’ŒåŸç†</h2><p>ç®€å•æ¥è¯´ï¼Œã€Œpingã€æ˜¯ç”¨æ¥æ¢æµ‹æœ¬æœºä¸ç½‘ç»œä¸­å¦ä¸€ä¸»æœºä¹‹é—´æ˜¯å¦å¯è¾¾çš„å‘½ä»¤ï¼Œå¦‚æœä¸¤å°ä¸»æœºä¹‹é—´pingä¸é€šï¼Œåˆ™è¡¨æ˜è¿™ä¸¤å°ä¸»æœºä¸èƒ½å»ºç«‹èµ·è¿æ¥ã€‚pingæ˜¯å®šä½ç½‘ç»œé€šä¸é€šçš„ä¸€ä¸ªé‡è¦æ‰‹æ®µã€‚</p><p>ping å‘½ä»¤æ˜¯åŸºäº ICMP åè®®æ¥å·¥ä½œçš„ï¼Œã€Œ ICMP ã€å…¨ç§°ä¸º Internet æ§åˆ¶æŠ¥æ–‡åè®®ï¼ˆ Internet Control Message Protocolï¼‰ã€‚ping å‘½ä»¤ä¼šå‘é€ä¸€ä»½ICMPå›æ˜¾è¯·æ±‚æŠ¥æ–‡ç»™ç›®æ ‡ä¸»æœºï¼Œå¹¶ç­‰å¾…ç›®æ ‡ä¸»æœºè¿”å›ICMPå›æ˜¾åº”ç­”ã€‚å› ä¸ºICMPåè®®ä¼šè¦æ±‚ç›®æ ‡ä¸»æœºåœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œå¿…é¡»è¿”å›ICMPåº”ç­”æ¶ˆæ¯ç»™æºä¸»æœºï¼Œå¦‚æœæºä¸»æœºåœ¨ä¸€å®šæ—¶é—´å†…æ”¶åˆ°äº†ç›®æ ‡ä¸»æœºçš„åº”ç­”ï¼Œåˆ™è¡¨æ˜ä¸¤å°ä¸»æœºä¹‹é—´ç½‘ç»œæ˜¯å¯è¾¾çš„ã€‚</p><p>ä¸¾ä¸€ä¸ªä¾‹å­æ¥æè¿°ã€Œpingã€å‘½ä»¤çš„å·¥ä½œè¿‡ç¨‹ï¼š</p><ol><li>å‡è®¾æœ‰ä¸¤ä¸ªä¸»æœºï¼Œä¸»æœºAï¼ˆ192.168.0.1ï¼‰å’Œä¸»æœºBï¼ˆ192.168.0.2ï¼‰ï¼Œç°åœ¨æˆ‘ä»¬è¦ç›‘æµ‹ä¸»æœºAå’Œä¸»æœºBä¹‹é—´ç½‘ç»œæ˜¯å¦å¯è¾¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ä¸»æœºAä¸Šè¾“å…¥å‘½ä»¤ï¼šping 192.168.0.2</li><li>æ­¤æ—¶ï¼Œpingå‘½ä»¤ä¼šåœ¨ä¸»æœºAä¸Šæ„å»ºä¸€ä¸ª ICMPçš„è¯·æ±‚æ•°æ®åŒ…ï¼ˆæ•°æ®åŒ…é‡Œçš„å†…å®¹åé¢å†è¯¦è¿°ï¼‰ï¼Œç„¶å ICMPåè®®ä¼šå°†è¿™ä¸ªæ•°æ®åŒ…ä»¥åŠç›®æ ‡IPï¼ˆ192.168.0.2ï¼‰ç­‰ä¿¡æ¯ä¸€åŒäº¤ç»™IPå±‚åè®®ã€‚</li><li>IPå±‚åè®®å¾—åˆ°è¿™äº›ä¿¡æ¯åï¼Œå°†æºåœ°å€ï¼ˆå³æœ¬æœºIPï¼‰ã€ç›®æ ‡åœ°å€ï¼ˆå³ç›®æ ‡IPï¼š192.168.0.2ï¼‰ã€å†åŠ ä¸Šä¸€äº›å…¶å®ƒçš„æ§åˆ¶ä¿¡æ¯ï¼Œæ„å»ºæˆä¸€ä¸ªIPæ•°æ®åŒ…ã€‚</li><li>IPæ•°æ®åŒ…æ„å»ºå®Œæˆåï¼Œè¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦åŠ ä¸ŠMACåœ°å€ï¼Œå› æ­¤ï¼Œè¿˜éœ€è¦é€šè¿‡ARPæ˜ å°„è¡¨æ‰¾å‡ºç›®æ ‡IPæ‰€å¯¹åº”çš„MACåœ°å€ã€‚å½“æ‹¿åˆ°äº†ç›®æ ‡ä¸»æœºçš„MACåœ°å€å’Œæœ¬æœºMACåï¼Œä¸€å¹¶äº¤ç»™æ•°æ®é“¾è·¯å±‚ï¼Œç»„è£…æˆä¸€ä¸ªæ•°æ®å¸§ï¼Œä¾æ®ä»¥å¤ªç½‘çš„ä»‹è´¨è®¿é—®è§„åˆ™ï¼Œå°†å®ƒä»¬ä¼ é€å‡ºå‡ºå»ã€‚</li><li>å½“ä¸»æœºBæ”¶åˆ°è¿™ä¸ªæ•°æ®å¸§ä¹‹åï¼Œä¼šé¦–å…ˆæ£€æŸ¥å®ƒçš„ç›®æ ‡MACåœ°å€æ˜¯ä¸æ˜¯æœ¬æœºï¼Œå¦‚æœæ˜¯å°±æ¥æ”¶ä¸‹æ¥å¤„ç†ï¼Œæ¥æ”¶ä¹‹åä¼šæ£€æŸ¥è¿™ä¸ªæ•°æ®å¸§ï¼Œå°†æ•°æ®å¸§ä¸­çš„IPæ•°æ®åŒ…å–å‡ºæ¥ï¼Œäº¤ç»™æœ¬æœºçš„IPå±‚åè®®ï¼Œç„¶åIPå±‚åè®®æ£€æŸ¥å®Œä¹‹åï¼Œå†å°†ICMPæ•°æ®åŒ…å–å‡ºæ¥äº¤ç»™ICMPåè®®å¤„ç†ï¼Œå½“è¿™ä¸€æ­¥ä¹Ÿå¤„ç†å®Œæˆä¹‹åï¼Œå°±ä¼šæ„å»ºä¸€ä¸ªICMPåº”ç­”æ•°æ®åŒ…ï¼Œå›å‘ç»™ä¸»æœºA</li><li>åœ¨ä¸€å®šçš„æ—¶é—´å†…ï¼Œå¦‚æœä¸»æœºAæ”¶åˆ°äº†åº”ç­”åŒ…ï¼Œåˆ™è¯´æ˜å®ƒä¸ä¸»æœºBä¹‹é—´ç½‘ç»œå¯è¾¾ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°ï¼Œåˆ™è¯´æ˜ç½‘ç»œä¸å¯è¾¾ã€‚é™¤äº†ç›‘æµ‹æ˜¯å¦å¯è¾¾ä»¥å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨åº”ç­”æ—¶é—´å’Œå‘èµ·æ—¶é—´ä¹‹é—´çš„å·®å€¼ï¼Œè®¡ç®—å‡ºæ•°æ®åŒ…çš„å»¶è¿Ÿè€—æ—¶ã€‚</li></ol><p>é€šè¿‡pingçš„æµç¨‹å¯ä»¥å‘ç°ï¼ŒICMPåè®®æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„åŸºç¡€ï¼Œæ˜¯éå¸¸é‡è¦çš„ï¼Œå› æ­¤ä¸‹é¢å°±æŠŠICMPåè®®å†è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚</p><h2 id="ICMPç®€ä»‹"><a href="#ICMPç®€ä»‹" class="headerlink" title="ICMPç®€ä»‹"></a>ICMPç®€ä»‹</h2><p>æˆ‘ä»¬çŸ¥é“ï¼Œpingå‘½ä»¤æ˜¯åŸºäºICMPåè®®æ¥å®ç°çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ä¸‹å›¾ï¼Œå°±æ˜ç™½äº†ICMPåè®®åˆæ˜¯é€šè¿‡IPåè®®æ¥å‘é€çš„ï¼Œå³ICMPæŠ¥æ–‡æ˜¯å°è£…åœ¨IPåŒ…ä¸­ã€‚</p><p><img src="https://ws1.sinaimg.cn/large/006tNc79ly1fvbpqk4zgbj308b02it8q.jpg" alt=""></p><p>IPåè®®æ˜¯ä¸€ç§æ— è¿æ¥çš„ï¼Œä¸å¯é çš„æ•°æ®åŒ…åè®®ï¼Œå®ƒå¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¸€å®šè¢«é€è¾¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ä¿è¯æ•°æ®é€åˆ°å°±éœ€è¦é€šè¿‡å…¶å®ƒæ¨¡å—æ¥ååŠ©å®ç°ï¼Œè¿™é‡Œå°±å¼•å…¥çš„æ˜¯ICMPåè®®ã€‚</p><p>å½“ä¼ é€çš„IPæ•°æ®åŒ…å‘é€å¼‚å¸¸çš„æ—¶å€™ï¼ŒICMPå°±ä¼šå°†å¼‚å¸¸ä¿¡æ¯å°è£…åœ¨åŒ…å†…ï¼Œç„¶åå›ä¼ ç»™æºä¸»æœºã€‚</p><p>å°†ä¸Šå›¾å†ç»†æ‹†ä¸€ä¸‹å¯è§ï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fvbps2ezmoj30b1028jr6.jpg" alt=""></p><p>å°†ICMPéƒ¨åˆ†æ‹†å¼€ç»§ç»­åˆ†æï¼š</p><p><img src="https://ws4.sinaimg.cn/large/006tNc79ly1fvbptg9n1uj30ci047t8s.jpg" alt=""></p><p>ç”±å›¾å¯çŸ¥ï¼ŒICMPæ•°æ®åŒ…ç”±8bitçš„ç±»å‹å­—æ®µå’Œ8bitçš„ä»£ç å­—æ®µä»¥åŠ16bitçš„æ ¡éªŒå­—æ®µå†åŠ ä¸Šé€‰é¡¹æ•°æ®ç»„æˆã€‚</p><p>ICMPåè®®å¤§è‡´å¯åˆ†ä¸ºä¸¤ç±»ï¼š</p><ul><li>æŸ¥è¯¢æŠ¥æ–‡ç±»å‹</li><li>å·®é”™æŠ¥æ–‡ç±»å‹</li></ul><p><img src="https://ws2.sinaimg.cn/large/006tNc79ly1fvbpuk9vf2j30bo0bv747.jpg" alt=""></p><ol><li>æŸ¥è¯¢æŠ¥æ–‡ç±»å‹ï¼š</li></ol><p>æŸ¥è¯¢æŠ¥æ–‡ä¸»è¦åº”ç”¨äºï¼špingæŸ¥è¯¢ã€å­ç½‘æ©ç æŸ¥è¯¢ã€æ—¶é—´æˆ³æŸ¥è¯¢ç­‰ç­‰ã€‚</p><p>ä¸Šé¢è®²åˆ°çš„pingå‘½ä»¤çš„æµç¨‹å…¶å®å°±å¯¹åº”ICMPåè®®æŸ¥è¯¢æŠ¥æ–‡ç±»å‹çš„ä¸€ç§ä½¿ç”¨ã€‚åœ¨ä¸»æœºAæ„å»ºICMPè¯·æ±‚æ•°æ®åŒ…çš„æ—¶å€™ï¼Œå…¶ICMPçš„ç±»å‹å­—æ®µä¸­ä½¿ç”¨çš„æ˜¯ 8 ï¼ˆå›é€è¯·æ±‚ï¼‰ï¼Œå½“ä¸»æœºBæ„å»ºICMPåº”ç­”åŒ…çš„æ—¶å€™ï¼Œå…¶ICMPç±»å‹å­—æ®µå°±ä½¿ç”¨çš„æ˜¯ 0 ï¼ˆå›é€åº”ç­”ï¼‰ï¼Œæ›´å¤šç±»å‹å€¼å‚è€ƒä¸Šè¡¨ã€‚</p><p>å¯¹ æŸ¥è¯¢æŠ¥æ–‡ç±»å‹ çš„ç†è§£å¯å‚è€ƒä¸€ä¸‹æ–‡ç« æœ€å¼€å§‹è®²çš„pingæµç¨‹ï¼Œè¿™é‡Œå°±ä¸åšèµ˜è¿°ã€‚</p><ol start="2"><li>å·®é”™æŠ¥æ–‡ç±»å‹ï¼š</li></ol><p>å·®é”™æŠ¥æ–‡ä¸»è¦äº§ç”Ÿäºå½“æ•°æ®ä¼ é€å‘é€é”™è¯¯çš„æ—¶å€™ã€‚</p><p>å®ƒåŒ…æ‹¬ï¼šç›®æ ‡ä¸å¯è¾¾ï¼ˆç½‘ç»œä¸å¯è¾¾ã€ä¸»æœºä¸å¯è¾¾ã€åè®®ä¸å¯è¾¾ã€ç«¯å£ä¸å¯è¾¾ã€ç¦æ­¢åˆ†ç‰‡ç­‰ï¼‰ã€è¶…æ—¶ã€å‚æ•°é—®é¢˜ã€é‡å®šå‘ï¼ˆç½‘ç»œé‡å®šå‘ã€ä¸»æœºé‡å®šå‘ç­‰ï¼‰ç­‰ç­‰ã€‚</p><p>å·®é”™æŠ¥æ–‡é€šå¸¸åŒ…å«äº†å¼•èµ·é”™è¯¯çš„IPæ•°æ®åŒ…çš„ç¬¬ä¸€ä¸ªåˆ†ç‰‡çš„IPé¦–éƒ¨ï¼ŒåŠ ä¸Šè¯¥åˆ†ç‰‡æ•°æ®éƒ¨åˆ†çš„å‰8ä¸ªå­—èŠ‚ã€‚</p><p>å½“ä¼ é€IPæ•°æ®åŒ…å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼ˆä¾‹å¦‚ ä¸»æœºä¸å¯è¾¾ï¼‰ï¼ŒICMPåè®®å°±ä¼šæŠŠé”™è¯¯ä¿¡æ¯å°åŒ…ï¼Œç„¶åä¼ é€å›æºä¸»æœºï¼Œé‚£ä¹ˆæºä¸»æœºå°±çŸ¥é“è¯¥æ€ä¹ˆå¤„ç†äº†ã€‚</p><p>é‚£æ˜¯ä¸æ˜¯åªæœ‰é‡åˆ°é”™è¯¯çš„æ—¶å€™æ‰èƒ½ä½¿ç”¨ å·®é”™æŠ¥æ–‡ç±»å‹ å‘¢ï¼Ÿä¹Ÿä¸ä¸€å®šã€‚</p><p>Traceroute å°±æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼ŒTracerouteæ˜¯ç”¨æ¥ä¾¦æµ‹æºä¸»æœºåˆ°ç›®æ ‡ä¸»æœºä¹‹é—´æ‰€ç»è¿‡è·¯ç”±æƒ…å†µçš„å¸¸ç”¨å·¥å…·ã€‚Traceroute çš„åŸç†å°±æ˜¯åˆ©ç”¨ICMPçš„è§„åˆ™ï¼Œåˆ¶é€ ä¸€äº›é”™è¯¯çš„äº‹ä»¶å‡ºæ¥ï¼Œç„¶åæ ¹æ®é”™è¯¯çš„äº‹ä»¶æ¥è¯„ä¼°ç½‘ç»œè·¯ç”±æƒ…å†µã€‚</p><p>å…·ä½“åšæ³•å°±æ˜¯ï¼š</p><p>Tracerouteä¼šè®¾ç½®ç‰¹æ®Šçš„TTLå€¼ï¼Œæ¥è¿½è¸ªæºä¸»æœºå’Œç›®æ ‡ä¸»æœºä¹‹é—´çš„è·¯ç”±æ•°ã€‚é¦–å…ˆå®ƒç»™ç›®æ ‡ä¸»æœºå‘é€ä¸€ä¸ª TTL=1 çš„UDPæ•°æ®åŒ…ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®åŒ…ä¸€æ—¦åœ¨è·¯ä¸Šé‡åˆ°ä¸€ä¸ªè·¯ç”±å™¨ï¼ŒTTLå°±å˜æˆäº†0ï¼ˆTTLè§„åˆ™æ˜¯æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨éƒ½ä¼šå‡1ï¼‰ï¼Œå› ä¸ºTTL=0äº†ï¼Œæ‰€ä»¥è·¯ç”±å™¨å°±ä¼šæŠŠè¿™ä¸ªæ•°æ®åŒ…ä¸¢æ‰ï¼Œç„¶åäº§ç”Ÿä¸€ä¸ªé”™è¯¯ç±»å‹ï¼ˆè¶…æ—¶ï¼‰çš„ICMPæ•°æ®åŒ…å›å‘ç»™æºä¸»æœºï¼Œä¹Ÿå°±æ˜¯å·®é”™åŒ…ã€‚è¿™ä¸ªæ—¶å€™æºä¸»æœºå°±æ‹¿åˆ°äº†ç¬¬ä¸€ä¸ªè·¯ç”±èŠ‚ç‚¹çš„IPå’Œç›¸å…³ä¿¡æ¯äº†ã€‚</p><p>æ¥ç€ï¼Œæºä¸»æœºå†ç»™ç›®æ ‡ä¸»æœºå‘ä¸€ä¸ª TTL=2 çš„UDPæ•°æ®åŒ…ï¼Œä¾æ—§ä¸Šè¿°æµç¨‹èµ°ä¸€éï¼Œå°±çŸ¥é“ç¬¬äºŒä¸ªè·¯ç”±èŠ‚ç‚¹çš„IPå’Œè€—æ—¶æƒ…å†µç­‰ä¿¡æ¯äº†ã€‚</p><p>å¦‚æ­¤åå¤è¿›è¡Œï¼ŒTracerouteå°±å¯ä»¥æ‹¿åˆ°ä»ä¸»æœºAåˆ°ä¸»æœºBä¹‹é—´æ‰€æœ‰è·¯ç”±å™¨çš„ä¿¡æ¯äº†ã€‚</p><p>ä½†æ˜¯æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æœæ•°æ®åŒ…åˆ°è¾¾äº†ç›®æ ‡ä¸»æœºçš„è¯ï¼Œå³ä½¿ç›®æ ‡ä¸»æœºæ¥æ”¶åˆ°TTLå€¼ä¸º1çš„IPæ•°æ®åŒ…ï¼Œå®ƒä¹Ÿæ˜¯ä¸ä¼šä¸¢å¼ƒè¯¥æ•°æ®åŒ…çš„ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿä¸€ä»½è¶…æ—¶çš„ICMPå›å‘æ•°æ®åŒ…çš„ï¼Œå› ä¸ºæ•°æ®åŒ…å·²ç»è¾¾åˆ°äº†ç›®çš„åœ°å˜›ã€‚é‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆè®¤å®šæ•°æ®åŒ…æ˜¯å¦è¾¾åˆ°äº†ç›®æ ‡ä¸»æœºå‘¢ï¼Ÿ</p><p>Tracerouteçš„æ–¹æ³•æ˜¯åœ¨æºä¸»æœºå‘é€UDPæ•°æ®åŒ…ç»™ç›®æ ‡ä¸»æœºçš„æ—¶å€™ï¼Œä¼šè®¾ç½®ä¸€ä¸ªä¸å¯èƒ½è¾¾åˆ°çš„ç›®æ ‡ç«¯å£å·ï¼ˆä¾‹å¦‚å¤§äº30000çš„ç«¯å£å·ï¼‰ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªæ•°æ®åŒ…çœŸçš„åˆ°è¾¾ç›®æ ‡ä¸»æœºçš„æ—¶å€™ï¼Œç›®æ ‡ä¸»æœºå‘ç°æ²¡æœ‰å¯¹åº”çš„ç«¯å£å·ï¼Œå› æ­¤ä¼šäº§ç”Ÿä¸€ä»½â€œç«¯å£ä¸å¯è¾¾â€çš„é”™è¯¯ICMPæŠ¥æ–‡è¿”å›ç»™æºä¸»æœºã€‚</p><p>tracerootçš„å…·ä½“ä½¿ç”¨æ–¹æ³•ç½‘ä¸Šéƒ½æœ‰å¾ˆå¤šè®²è§£ï¼Œå¯ä»¥å®é™…æ“ä½œä¸€ä¸‹ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      æˆ‘ä»¬åœ¨é‡åˆ°ç½‘ç»œä¸é€šçš„æƒ…å†µï¼Œå¤§å®¶éƒ½çŸ¥é“å» ping ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹ç½‘ç»œçŠ¶å†µã€‚é‚£ä½ çŸ¥é“ã€Œpingã€å‘½ä»¤åèƒŒçš„é€»è¾‘æ˜¯ä»€ä¹ˆå—ï¼ŸçŸ¥é“å®ƒæ˜¯å¦‚ä½•å®ç°çš„å—ï¼Ÿ
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="ç½‘ç»œ" scheme="https://cloudsjhan.github.io/tags/%E7%BD%91%E7%BB%9C/"/>
    
  </entry>
  
  <entry>
    <title>CentOS7-å®‰è£…docker-composeæ—¶ç”±äºpip10åŒ…ç®¡ç†å¯¼è‡´çš„é”™è¯¯</title>
    <link href="https://cloudsjhan.github.io/2018/09/13/CentOS7-%E5%AE%89%E8%A3%85docker-compose%E6%97%B6%E7%94%B1%E4%BA%8Epip10%E5%8C%85%E7%AE%A1%E7%90%86%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%99%E8%AF%AF/"/>
    <id>https://cloudsjhan.github.io/2018/09/13/CentOS7-å®‰è£…docker-composeæ—¶ç”±äºpip10åŒ…ç®¡ç†å¯¼è‡´çš„é”™è¯¯/</id>
    <published>2018-09-13T02:11:49.000Z</published>
    <updated>2018-09-13T02:15:53.522Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>ä»Šå¤©åœ¨CentOSä¸‹å®‰è£…docker-composeï¼Œé‡åˆ°äº†Cannot uninstall â€˜requestsâ€™. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.<br>é”™è¯¯çš„åŸå› æ˜¯requestsé»˜è®¤ç‰ˆæœ¬ä¸º2.6.0ï¼Œä½†æ˜¯docker-composeè¦2.9ä»¥ä¸Šæ‰æ”¯æŒï¼Œä½†æ˜¯æ— æ³•æ­£å¸¸å¸è½½2.9ç‰ˆæœ¬ï¼Œæ˜¯pip10å¯¹åŒ…çš„ç®¡ç†å­˜åœ¨å˜åŒ–ã€‚</li><li>è§£å†³æ–¹æ¡ˆï¼š<ul><li>pip install -l requests==2.9</li></ul></li></ul><hr>]]></content>
    
    <summary type="html">
    
      CentOSä¸‹å®‰è£…Docker-composeæ—¶å‡ºç°äº† Cannot uninstall &#39;requests&#39;. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.
    
    </summary>
    
      <category term="Docker" scheme="https://cloudsjhan.github.io/categories/Docker/"/>
    
    
      <category term="Docker" scheme="https://cloudsjhan.github.io/tags/Docker/"/>
    
  </entry>
  
  <entry>
    <title>æŠ€æœ¯å‘¨åˆŠä¹‹è§£æPythonä¸­çš„èµ‹å€¼ã€æµ…æ‹·è´ã€æ·±æ‹·è´</title>
    <link href="https://cloudsjhan.github.io/2018/09/09/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E8%A7%A3%E6%9E%90Python%E4%B8%AD%E7%9A%84%E8%B5%8B%E5%80%BC%E3%80%81%E6%B5%85%E6%8B%B7%E8%B4%9D%E3%80%81%E6%B7%B1%E6%8B%B7%E8%B4%9D/"/>
    <id>https://cloudsjhan.github.io/2018/09/09/æŠ€æœ¯å‘¨åˆŠä¹‹è§£æPythonä¸­çš„èµ‹å€¼ã€æµ…æ‹·è´ã€æ·±æ‹·è´/</id>
    <published>2018-09-09T06:39:05.000Z</published>
    <updated>2018-09-09T08:03:48.727Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><h2 id="äº‹æƒ…çš„èµ·å› "><a href="#äº‹æƒ…çš„èµ·å› " class="headerlink" title="äº‹æƒ…çš„èµ·å› "></a>äº‹æƒ…çš„èµ·å› </h2><ul><li><p>æœ¬å‘¨æˆ‘ä»¬åˆ†äº«çš„ä¸»é¢˜æ˜¯Pythonä¸­å…³äºæµ…æ‹·è´å’Œæ·±æ‹·è´çš„ç‰¹æ€§ï¼Œæƒ³è¦æ·±å…¥ç ”ç©¶Pythonä¸­çš„æµ…æ‹·è´å’Œæ·±æ‹·è´çš„èµ·å› åœ¨äºï¼Œæˆ‘æƒ³ç”Ÿæˆä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²æœªdumpsä¹‹å‰æ˜¯ä¸€ä¸ªPythonçš„æ•°æ®ç»“æ„ï¼Œé‡Œé¢åŒ…å«å­—å…¸ï¼Œä»¥åŠListï¼Œåœ¨éå†ç”Ÿæˆdictionaryæ—¶å€™ï¼Œå‡ºç°ä¸€ä¸ªbugï¼Œå°±æ˜¯æ¯æ¬¡éå†ç”Ÿæˆçš„dictionaryéƒ½æ˜¯ä¸Šä¸€æ¬¡çš„å€¼ï¼Œç°è±¡å¯ä»¥çœ‹ä»¥ä¸‹ä»£ç ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°get_data()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">   ...:     appid_dict = &#123;&#125;</span><br><span class="line">   ...:     appid_all_dict = &#123;&#125;</span><br><span class="line">   ...:     <span class="keyword">import</span> pdb;pdb.set_trace()</span><br><span class="line">   ...:     <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">   ...:         appid_dict[<span class="string">'a'</span>] = i</span><br><span class="line">   ...:         appid_all_dict[i] = appid_dict</span><br><span class="line"><span class="comment"># æˆ‘ä»¬çš„åˆè¡·æ˜¯æƒ³è¦å¾—åˆ°</span></span><br><span class="line"><span class="comment"># &#123;0: &#123;'a': 0&#125;, 1: &#123;'a': 1&#125;, 2: &#123;'a': 2&#125;, 3: &#123;'a': 3&#125;&#125;....è¿™æ ·çš„ä¸€ä¸ªdict</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½†æ˜¯åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå‘ç°å¾—åˆ°çš„ç»“æœæ˜¯è¿™æ ·çš„ï¼š</span></span><br><span class="line"><span class="comment"># (Pdb) appid_all_dict</span></span><br><span class="line"><span class="comment"># &#123;0: &#123;'a': 2&#125;, 1: &#123;'a': 2&#125;, 2: &#123;'a': 2&#125;&#125;</span></span><br><span class="line"><span class="comment"># (Pdb) </span></span><br><span class="line"><span class="comment"># å³ï¼Œåé¢çš„appid_dictéƒ½ä¼šæŠŠå‰é¢çš„è¦†ç›–æ‰ï¼Œè¿™æ˜¯ä»€ä¹ˆåŸå› å‘¢ï¼Ÿ</span></span><br><span class="line"><span class="comment"># æˆ‘ä»¬è¿™é‡Œå…ˆæŠŠåŸå› è¯´ä¸€ä¸‹ï¼šå› ä¸ºPythonä¸­å¯¹dictçš„æ“ä½œé»˜è®¤æ˜¯æµ…æ‹·è´ï¼Œå³åŒæ ·çš„å­—å…¸ï¼Œä½¿ç”¨å¤šæ¬¡çš„è¯ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½æ˜¯æŒ‡å‘åŒä¸€ç‰‡å†…å­˜åœ°å€(å¼•ç”¨)ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„ç¨‹åºä¸­åé¢å¯¹appid_dictçš„èµ‹å€¼ï¼Œéƒ½å°†å‰é¢çš„ç»™è¦†ç›–æ‰äº†ï¼Œå¯¼è‡´æ¯ä¸€ä¸ªappid_dictæŒ‡å‘åŒä¸€ç‰‡å†…å­˜ï¼Œè¯»å–çš„å½“ç„¶å°±æ˜¯æœ€åä¸€æ¬¡çš„appid_dictçš„å€¼ï¼Œå³ä¸Šé¢ç¨‹åºçš„æ‰§è¡Œç»“æœï¼š</span></span><br><span class="line">&#123;<span class="number">0</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">1</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">2</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">3</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">4</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">5</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">6</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">7</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">8</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;, <span class="number">9</span>: &#123;<span class="string">'a'</span>: <span class="number">9</span>&#125;&#125;</span><br></pre></td></tr></table></figure><ul><li><p>é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹è¿™ä¸ªbugï¼Œè®©ç¨‹åºè¾“å‡ºæˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„ç»“æœï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;0: &#123;'a': 0&#125;, 1: &#123;'a': 1&#125;, 2: &#123;'a': 2&#125;, 3: &#123;'a': 3&#125;, 4: &#123;'a': 4&#125;, 5: &#123;'a': 5&#125;, 6: &#123;'a': 6&#125;, 7: &#123;'a': 7&#125;, 8: &#123;'a': 8&#125;, 9: &#123;'a': 9&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>çœ‹å®Œä¸‹é¢å¯¹äºPythonèµ‹å€¼ã€æµ…æ‹·è´ã€æ·±æ‹·è´çš„è§£æï¼Œç›¸ä¿¡ä½ å°±å¯ä»¥è‡ªå·±è§£å†³è¿™ä¸ªé—®é¢˜äº†</p></li></ul><h4 id="Pythonä¸­çš„èµ‹å€¼æ“ä½œ"><a href="#Pythonä¸­çš„èµ‹å€¼æ“ä½œ" class="headerlink" title="Pythonä¸­çš„èµ‹å€¼æ“ä½œ"></a>Pythonä¸­çš„èµ‹å€¼æ“ä½œ</h4><ul><li>èµ‹å€¼ï¼šå°±æ˜¯å¯¹è±¡çš„å¼•ç”¨</li><li>ä¸¾ä¾‹ï¼š a = b: èµ‹å€¼å¼•ç”¨ï¼Œaå’Œbéƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚å›¾æ‰€ç¤º<img src="https://ws4.sinaimg.cn/large/006tNbRwly1fv3bo527hfj30y80lwq7i.jpg" alt=""></li></ul><h2 id="Pythonä¸­æµ…æ‹·è´"><a href="#Pythonä¸­æµ…æ‹·è´" class="headerlink" title="Pythonä¸­æµ…æ‹·è´"></a>Pythonä¸­æµ…æ‹·è´</h2><ul><li>a = b.copy(): a æ˜¯bçš„æµ…æ‹·è´ï¼Œaå’Œbæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä»¬çš„å­å¯¹è±¡è¿˜æ˜¯æŒ‡å‘åŒä¸€ç‰‡å¼•ç”¨ã€‚<img src="https://ws4.sinaimg.cn/large/006tNbRwly1fv3btp4y4ij30zs0neq9f.jpg" alt=""></li><li>Pythonä¸­å¯¹å­—å…¸çš„é»˜è®¤èµ‹å€¼æ“ä½œå°±æ˜¯æµ…æ‹·è´ï¼Œæ‰€ä»¥å¯¼è‡´äº†æ–‡ç« å¼€å¤´æ‰€å‡ºç°çš„æƒ…å†µã€‚</li></ul><h2 id="Pythonä¸­çš„æ·±æ‹·è´"><a href="#Pythonä¸­çš„æ·±æ‹·è´" class="headerlink" title="Pythonä¸­çš„æ·±æ‹·è´"></a>Pythonä¸­çš„æ·±æ‹·è´</h2><ul><li>é¦–å…ˆimport copy,å¯¼å…¥copyæ¨¡å—ï¼ˆPythonä¸­è‡ªå¸¦ï¼‰ï¼Œb = copy.deepcopy(a), æˆ‘ä»¬å°±è¯´bæ˜¯açš„æ·±æ‹·è´ï¼Œbæ‹·è´äº†aæ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼Œå¹¶æ–°å¼€è¾Ÿäº†ä¸€å—åœ°å€ç©ºé—´ï¼Œä¸¤è€…äº’ä¸å¹²æ¶‰ã€‚<img src="https://ws1.sinaimg.cn/large/006tNbRwly1fv3bymsju4j311w0oi100.jpg" alt=""></li></ul><h2 id="å®é™…çš„ä¾‹å­æ¥è¿›ä¸€æ­¥è¯´æ˜"><a href="#å®é™…çš„ä¾‹å­æ¥è¿›ä¸€æ­¥è¯´æ˜" class="headerlink" title="å®é™…çš„ä¾‹å­æ¥è¿›ä¸€æ­¥è¯´æ˜"></a>å®é™…çš„ä¾‹å­æ¥è¿›ä¸€æ­¥è¯´æ˜</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="number">13</span>]: <span class="keyword">import</span> copy</span><br><span class="line"></span><br><span class="line">In [<span class="number">14</span>]: <span class="function"><span class="keyword">def</span> <span class="title">temp</span><span class="params">()</span>:</span></span><br><span class="line">    ...:     a = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>]]</span><br><span class="line">    ...:     b = a <span class="comment"># èµ‹å€¼æ“ä½œï¼Œç›´æ¥ä¼ æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨</span></span><br><span class="line">    ...:     c = copy.copy(a) <span class="comment"># æµ…æ‹·è´ï¼Œå­å¯¹è±¡æŒ‡å‘åŒä¸€å¼•ç”¨</span></span><br><span class="line">    ...:     d = copy.deepcopy(a) <span class="comment"># æ·±æ‹·è´ï¼Œäº’ä¸å¹²æ¶‰</span></span><br><span class="line">    ...:     a.append(<span class="number">5</span>) <span class="comment"># ä¿®æ”¹å¯¹è±¡a</span></span><br><span class="line">    ...:     a[<span class="number">4</span>].append(<span class="string">'c'</span>) <span class="comment"># ä¿®æ”¹aä¸­çš„æ•°ç»„</span></span><br><span class="line">    ...:     print( <span class="string">'a = '</span>, a )</span><br><span class="line">    ...:     print( <span class="string">'b = '</span>, b )</span><br><span class="line">    ...:     print( <span class="string">'c = '</span>, c )</span><br><span class="line">    ...:     print( <span class="string">'d = '</span>, d ) </span><br><span class="line">    ...:     </span><br><span class="line"></span><br><span class="line">In [<span class="number">15</span>]: </span><br><span class="line"></span><br><span class="line">In [<span class="number">15</span>]: temp()</span><br><span class="line">a =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], <span class="number">5</span>]</span><br><span class="line">b =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], <span class="number">5</span>]</span><br><span class="line">c =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>]]</span><br><span class="line">d =  [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, [<span class="string">'a'</span>, <span class="string">'b'</span>]]</span><br></pre></td></tr></table></figure></li></ul><h2 id="è§£å†³æœ€åˆçš„é—®é¢˜"><a href="#è§£å†³æœ€åˆçš„é—®é¢˜" class="headerlink" title="è§£å†³æœ€åˆçš„é—®é¢˜"></a>è§£å†³æœ€åˆçš„é—®é¢˜</h2><ul><li><p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†å›å¤´çœ‹æ–‡ç« æœ€åˆçš„é‚£ä¸ªé—®é¢˜ï¼Œå°±å¯ä»¥å¾ˆeasyåœ°è§£å†³äº†ã€‚</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_data</span><span class="params">()</span>:</span></span><br><span class="line">   ...:     appid_dict = &#123;&#125;</span><br><span class="line">   ...:     appid_all_dict = &#123;&#125;</span><br><span class="line">   ...:     <span class="keyword">import</span> pdb;pdb.set_trace()</span><br><span class="line">   ...:     <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        appid_dict = copy.deepcopy(appid_dict)<span class="comment"># åªéœ€è¦åŠ ä¸Šè¿™ä¸€è¡Œï¼Œä½¿å…¶æˆä¸ºæ·±æ‹·è´ï¼Œé—®é¢˜è§£å†³ï¼</span></span><br><span class="line">   ...:         appid_dict[<span class="string">'a'</span>] = i</span><br><span class="line">   ...:         appid_all_dict[i] = appid_dict</span><br></pre></td></tr></table></figure></li></ul><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¦å¯¹Pythonçš„dictionaryè¿›è¡Œè¿­ä»£åˆ†æï¼Œä¸€å®šè¦æ³¨æ„å…¶ä¸­çš„æ·±æ‹·è´é—®é¢˜ï¼Œå‡ºç°é—®é¢˜åï¼Œä¹Ÿè¦å¤šå¾€è¿™æ–¹é¢è€ƒè™‘ã€‚</p><p>æœ¬æœŸæŠ€æœ¯å‘¨åˆŠåˆ°æ­¤ç»“æŸã€‚</p><p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1536489838162&amp;di=52a5d7c56631ad266740914505a80a32&amp;imgtype=0&amp;src=http%3A%2F%2Ffile.elecfans.com%2Fweb1%2FM00%2F57%2FB6%2Fo4YBAFtMadCAL43RAAHzi5GNn9o475.png" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      è¿™å‘¨è®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹Pythonä¸­å…³äºèµ‹å€¼ã€æµ…æ‹·è´ã€æ·±æ‹·è´çš„ç‰¹æ€§
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="Python" scheme="https://cloudsjhan.github.io/tags/Python/"/>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/tags/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
  </entry>
  
  <entry>
    <title>golang ç¼–è¯‘é’ˆå¯¹ä¸åŒå¹³å°çš„å¯æ‰§è¡Œç¨‹åº</title>
    <link href="https://cloudsjhan.github.io/2018/09/07/golang-%E7%BC%96%E8%AF%91%E9%92%88%E5%AF%B9%E4%B8%8D%E5%90%8C%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F/"/>
    <id>https://cloudsjhan.github.io/2018/09/07/golang-ç¼–è¯‘é’ˆå¯¹ä¸åŒå¹³å°çš„å¯æ‰§è¡Œç¨‹åº/</id>
    <published>2018-09-07T07:46:32.000Z</published>
    <updated>2018-09-07T07:48:43.584Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">Golang æ”¯æŒåœ¨ä¸€ä¸ªå¹³å°ä¸‹ç”Ÿæˆå¦ä¸€ä¸ªå¹³å°å¯æ‰§è¡Œç¨‹åºçš„äº¤å‰ç¼–è¯‘åŠŸèƒ½ã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Macä¸‹ç¼–è¯‘Linux, Windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build test.go</span><br><span class="line">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go</span><br><span class="line">Linuxä¸‹ç¼–è¯‘Mac, Windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build test.go</span><br><span class="line">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.go</span><br><span class="line">Windowsä¸‹ç¼–è¯‘Mac, Linuxå¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SET CGO_ENABLED=0</span><br><span class="line">SET GOOS=darwin3</span><br><span class="line">SET GOARCH=amd64</span><br><span class="line">go build test.go</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SET CGO_ENABLED=0</span><br><span class="line">SET GOOS=linux</span><br><span class="line">SET GOARCH=amd64</span><br><span class="line">go build test.go</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">GOOSï¼šç›®æ ‡å¯æ‰§è¡Œç¨‹åºè¿è¡Œæ“ä½œç³»ç»Ÿï¼Œæ”¯æŒ darwinï¼Œfreebsdï¼Œlinuxï¼Œwindows</span><br><span class="line">GOARCHï¼šç›®æ ‡å¯æ‰§è¡Œç¨‹åºæ“ä½œç³»ç»Ÿæ„æ¶ï¼ŒåŒ…æ‹¬ 386ï¼Œamd64ï¼Œarm</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Golang version 1.5ä»¥å‰ç‰ˆæœ¬åœ¨é¦–æ¬¡äº¤å‰ç¼–è¯‘æ—¶è¿˜éœ€è¦é…ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒï¼š</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CGO_ENABLED=0 GOOS=linux GOARCH=amd64 ./make.bash</span><br><span class="line">CGO_ENABLED=0 GOOS=windows GOARCH=amd64 ./make.bash</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      ä½¿ç”¨go build ç¼–è¯‘åŒä¸€å¥—ä»£ç ï¼Œåœ¨ä¸åŒçš„å¹³å°è¿è¡Œ
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>å¸¸ç”¨çš„Pythonå°æ¨¡å—</title>
    <link href="https://cloudsjhan.github.io/2018/09/06/%E5%B8%B8%E7%94%A8%E7%9A%84Python%E5%B0%8F%E6%A8%A1%E5%9D%97/"/>
    <id>https://cloudsjhan.github.io/2018/09/06/å¸¸ç”¨çš„Pythonå°æ¨¡å—/</id>
    <published>2018-09-06T08:24:41.000Z</published>
    <updated>2018-09-28T02:06:00.780Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>å·¥ä½œæˆ–è€…ç”Ÿæ´»ä¸­æ€»ä¼šé‡åˆ°ä¸€äº›å¸¸ç”¨çš„Pythonæ¨¡å—ï¼Œä¸ºäº†é¿å…é‡å¤çš„å·¥ä½œï¼Œå°†è¿™äº›è‡ªå·±å†™è¿‡çš„Pythonæ¨¡å—è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä½¿ç”¨çš„æ—¶å€™æŸ¥æ‰¾ã€‚</li></ul><h3 id="Pythonå†™CSVæ–‡ä»¶ï¼Œå¹¶é˜²æ­¢ä¸­æ–‡ä¹±ç "><a href="#Pythonå†™CSVæ–‡ä»¶ï¼Œå¹¶é˜²æ­¢ä¸­æ–‡ä¹±ç " class="headerlink" title="Pythonå†™CSVæ–‡ä»¶ï¼Œå¹¶é˜²æ­¢ä¸­æ–‡ä¹±ç "></a>Pythonå†™CSVæ–‡ä»¶ï¼Œå¹¶é˜²æ­¢ä¸­æ–‡ä¹±ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_csv</span><span class="params">(a_list,b_list)</span>:</span></span><br><span class="line">    <span class="keyword">with</span> open(<span class="string">'vm_data.csv'</span>, <span class="string">'w'</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(codecs.BOM_UTF8.decode())</span><br><span class="line">        writer1 = csv.writer(f,  dialect=<span class="string">'excel'</span>)</span><br><span class="line">        <span class="comment">#å†™CVSçš„æ ‡é¢˜</span></span><br><span class="line">        writer1.writerow([<span class="string">'a'</span>, <span class="string">'b'</span>])</span><br><span class="line">        <span class="comment">#å°†æ•°æ®å†™å…¥CSVæ–‡ä»¶</span></span><br><span class="line">        writer1.writerows(zip(a_list, b_list))</span><br></pre></td></tr></table></figure><h3 id="Pythonå°†æ•°æ®ç»“æ„è½¬ä¸ºjson-å¹¶ä¼˜åŒ–jsonå­—ç¬¦ä¸²çš„ç»“æ„ï¼Œå¤„ç†ä¸­æ–‡ä¹±ç "><a href="#Pythonå°†æ•°æ®ç»“æ„è½¬ä¸ºjson-å¹¶ä¼˜åŒ–jsonå­—ç¬¦ä¸²çš„ç»“æ„ï¼Œå¤„ç†ä¸­æ–‡ä¹±ç " class="headerlink" title="Pythonå°†æ•°æ®ç»“æ„è½¬ä¸ºjson,å¹¶ä¼˜åŒ–jsonå­—ç¬¦ä¸²çš„ç»“æ„ï¼Œå¤„ç†ä¸­æ–‡ä¹±ç "></a>Pythonå°†æ•°æ®ç»“æ„è½¬ä¸ºjson,å¹¶ä¼˜åŒ–jsonå­—ç¬¦ä¸²çš„ç»“æ„ï¼Œå¤„ç†ä¸­æ–‡ä¹±ç </h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> open(<span class="string">"appid.json"</span>, <span class="string">'w'</span>, encoding=<span class="string">'utf8'</span>, ) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(json.dumps(final, sort_keys=<span class="keyword">True</span>, indent=<span class="number">2</span>, ensure_ascii=<span class="keyword">False</span>))</span><br><span class="line"><span class="comment"># sort_keys = True: å°†å­—å…¸çš„keyæŒ‰ç…§å­—æ¯æ’åº</span></span><br><span class="line"><span class="comment"># ident = 2: ä¼˜åŒ–jsonå­—ç¬¦ä¸²ç»“æ„ï¼Œçœ‹èµ·æ¥æ›´ç¾è§‚</span></span><br><span class="line"><span class="comment"># ensure_ascii=False: é˜²æ­¢jsonå­—ç¬¦ä¸²ä¸­çš„ä¸­æ–‡ä¹±ç </span></span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨requestsåŒ…è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆä»¥postä¸ºä¾‹ï¼‰"><a href="#ä½¿ç”¨requestsåŒ…è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆä»¥postä¸ºä¾‹ï¼‰" class="headerlink" title="ä½¿ç”¨requestsåŒ…è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆä»¥postä¸ºä¾‹ï¼‰"></a>ä½¿ç”¨requestsåŒ…è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆä»¥postä¸ºä¾‹ï¼‰</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def  get_data(url):</span><br><span class="line">    final = &#123;&#125;</span><br><span class="line">    url = &quot;http://xxxx.com&quot;</span><br><span class="line">    request_body = &#123;</span><br><span class="line">        &apos;access_token&apos;: access_token,</span><br><span class="line">        &apos;request_body&apos;: &#123;&quot;params1&quot;: param1, &apos;params2&apos;: param2&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    headers = &#123;</span><br><span class="line">        &apos;Content-type&apos;: &apos;application/json&apos;</span><br><span class="line">    &#125;</span><br><span class="line">    data = requests.post(url, headers=headers, data=json.dumps(request_body))</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      å¸¸ç”¨çš„Pythonæ¨¡å—ï¼Œå³æŸ¥å³ç”¨
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Mysqlæ— æ³•è¿æ¥[MySql Host is blocked because of many connection errors]</title>
    <link href="https://cloudsjhan.github.io/2018/09/01/Mysql%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5/"/>
    <id>https://cloudsjhan.github.io/2018/09/01/Mysqlæ— æ³•è¿æ¥/</id>
    <published>2018-09-01T05:20:54.000Z</published>
    <updated>2018-09-01T05:38:58.657Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><a id="more"></a><ul><li><p>æµ‹è¯•ç¯å¢ƒï¼Œå‘ç°æ•°æ®åº“ï¼ˆMySQLæ•°æ®åº“ï¼‰æ— æ³•ç™»å½•ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š</p><p>Host is blocked because of many connection errors; unblock with â€˜mysqladmin flush-hostsâ€™</p></li><li><p>è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨mysqladmin flush-hosts å‘½ä»¤æ¸…ç†ä¸€ä¸‹hostsæ–‡ä»¶ï¼ˆä¸çŸ¥é“mysqladminåœ¨å“ªä¸ªç›®å½•ä¸‹å¯ä»¥ä½¿ç”¨å‘½ä»¤æŸ¥æ‰¾ï¼šwhereis mysqladminï¼‰ï¼›</p></li><li><p>ç™»å½•åˆ°MySQLæ•°æ®åº“ä¸­ï¼Œmysql -uroot -h host -p</p></li><li><p>æ‰§è¡Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin <span class="keyword">flush</span>-<span class="keyword">hosts</span></span><br></pre></td></tr></table></figure><p>é—®é¢˜è§£å†³ã€‚</p></li></ul><hr>]]></content>
    
    <summary type="html">
    
      mysql å‡ºç°[MySql Host is blocked because of many connection errors]çš„é”™è¯¯
    
    </summary>
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/categories/MySQL/"/>
    
    
      <category term="mysql" scheme="https://cloudsjhan.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql å¼€å¯è¿œç¨‹è¿æ¥</title>
    <link href="https://cloudsjhan.github.io/2018/08/29/mysql-%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5/"/>
    <id>https://cloudsjhan.github.io/2018/08/29/mysql-å¼€å¯è¿œç¨‹è¿æ¥/</id>
    <published>2018-08-29T03:17:20.000Z</published>
    <updated>2018-09-01T05:35:43.913Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><a id="more"></a><ul><li>èƒŒæ™¯ï¼š å»ºç«™çš„æ—¶å€™ä¼šå‡ºç°æ•°æ®åº“å’Œç½‘ç«™æ˜¯ä¸åŒçš„ipï¼Œå°±éœ€è¦å¼€å¯MySQLçš„è¿œç¨‹è¿æ¥æœåŠ¡ï¼Œä½†æ˜¯MySQLç”±äºå®‰å…¨åŸå› ï¼Œé»˜è®¤è®¾ç½®æ˜¯ä¸å…è®¸è¿œç¨‹åªèƒ½æœ¬åœ°è¿æ¥ï¼Œè¦å¼€å¯è¿œç¨‹è¿æ¥å°±éœ€è¦ä¿®æ”¹æŸäº›é…ç½®æ–‡ä»¶ã€‚</li></ul><h3 id="æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤ï¼Œå¼€å¯MySQLçš„è¿œç¨‹è¿æ¥"><a href="#æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤ï¼Œå¼€å¯MySQLçš„è¿œç¨‹è¿æ¥" class="headerlink" title="æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤ï¼Œå¼€å¯MySQLçš„è¿œç¨‹è¿æ¥"></a>æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤ï¼Œå¼€å¯MySQLçš„è¿œç¨‹è¿æ¥</h3><ul><li><p>è¿›å…¥æ•°æ®åº“cmd</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -h host -p</span><br><span class="line">Enter password:***</span><br></pre></td></tr></table></figure></li><li><p>è¿æ¥åˆ°é»˜è®¤mysqlæ•°æ®åº“</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show databases;</span><br><span class="line"></span><br><span class="line">use mysql;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Grant all privileges on *.* to 'root'@'host' identified by 'password' with grant option;</span><br></pre></td></tr></table></figure><p>hostè¡¨ç¤ºä½ è¿œç¨‹è¿æ¥æ•°æ®åº“è®¾å¤‡çš„ipåœ°å€ï¼ˆå¦‚æœä½ æƒ³è®©æ‰€æœ‰æœºå™¨éƒ½èƒ½è¿œç¨‹è¿æ¥ï¼Œhostæ”¹ä¸ºâ€˜%â€™ï¼Œ<strong>ä¸æ¨èè¿™æ ·ä½¿ç”¨</strong>ï¼‰ï¼Œpasswordè¡¨ç¤ºMySQLçš„rootç”¨æˆ·å¯†ç </p></li><li><p>åˆ·æ–°oré‡å¯MySQL</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">mysql&gt;</span><span class="bash"> flush privileges;</span></span><br></pre></td></tr></table></figure></li><li><p>æœ€åéå¸¸é‡è¦çš„ä¸€ç‚¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/vim /etc/mysql/my.cnf</span><br><span class="line">å±è”½bing-server 127.0.0.0</span><br><span class="line"><span class="meta">#</span><span class="bash">bing-server 127.0.0.0</span></span><br></pre></td></tr></table></figure></li><li><p>å®Œæˆï¼Œå¯ä»¥è¿œç¨‹è¿æ¥ä½ çš„æ•°æ®åº“äº†</p></li></ul><hr>]]></content>
    
    <summary type="html">
    
      ä¸ç®¡æ˜¯åœ¨æµ‹è¯•è¿˜æ˜¯å¼€å‘ä¸­ï¼ŒMySQLç»å¸¸éœ€è¦å¼€å¯è¿œç¨‹è¿æ¥åŠŸèƒ½
    
    </summary>
    
      <category term="MySQL" scheme="https://cloudsjhan.github.io/categories/MySQL/"/>
    
    
      <category term="mysql" scheme="https://cloudsjhan.github.io/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>golang factory design å¼•å‘çš„ä¸€ç³»åˆ—æ€è€ƒ</title>
    <link href="https://cloudsjhan.github.io/2018/08/29/golang-factory-design-%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E7%B3%BB%E5%88%97%E6%80%9D%E8%80%83/"/>
    <id>https://cloudsjhan.github.io/2018/08/29/golang-factory-design-å¼•å‘çš„ä¸€ç³»åˆ—æ€è€ƒ/</id>
    <published>2018-08-29T02:21:56.000Z</published>
    <updated>2018-09-01T07:18:05.039Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><a id="more"></a><ul><li>å†™åœ¨å‰é¢ï¼Œçªç„¶èŒç”Ÿä¸€ä¸ªå¿µå¤´ï¼Œåšä¸€ä¸ªæŠ€æœ¯å‘¨åˆŠç³»åˆ—ï¼Œå°†æ¯å‘¨å·¥ä½œæˆ–è€…ç”Ÿæ´»å½“ä¸­é‡åˆ°çš„æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜è®°å½•ä¸‹æ¥ï¼Œä¸€æ¥æ—¶æ€»ç»“ä¸€ä¸‹ï¼ŒäºŒæ¥æ˜¯ä¸ºäº†ä»¥åé€€å½¹äº†ï¼Œå¯ä»¥å›é¡¾è‡ªå·±çš„æŠ€æœ¯ç”Ÿæ¶¯ã€‚</li><li>æ²¡æœ‰ä»€ä¹ˆæ„å¤–çš„è¯ï¼Œæˆ‘ä¼šæ¯å‘¨å…­æ™šæ›´æ–°ã€‚</li><li>æœ€è¿‘åœ¨æ•´åˆä¸‰å®¶å…¬æœ‰äº‘ï¼ˆAWSï¼Œali, ucloudï¼‰çš„æ¥å£ï¼Œè€ƒè™‘åˆ°ä»£ç å¤ç”¨çš„é—®é¢˜ï¼Œäºæ˜¯å¼€å§‹è€ƒè™‘ä½¿ç”¨ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œè¿™ç§åœºæ™¯ä¸‹ï¼Œæœ€åˆé€‚çš„ä¾¿æ˜¯å·¥å‚æ¨¡å¼ï¼Œå°†ä¸‰å®¶å‚å•†çš„å…¬æœ‰æ¥å£æ”¾å…¥å·¥å‚æ–¹æ³•ä¸­ï¼Œç„¶åå¯¹æ¯ä¸€å®¶newä¸€ä¸ªå®ä¾‹å³å¯ï¼Œä»¥åå†æœ‰æ–°çš„å‚å•†åŠ å…¥ï¼Œæ”¹åŠ¨çš„ä»£ç ä¹Ÿä¸ä¼šå¤ªå¤šã€‚ä½†æ˜¯è®¾è®¡æ¨¡å¼è¿™ç§ä¸œè¥¿å¤©ç„¶é€‚åˆäºjavaï¼Œå¯¹äºgolangè¿™ç§æ¯”è¾ƒæ–°çš„è¯­è¨€æ¥è¯´ï¼Œå®ç°èµ·æ¥ç›¸å¯¹æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œå¯¹äºåˆšæ¥è§¦golangçš„æˆ‘æ¥è¯´ï¼Œå¯¹ä¸€äº›golangçš„ç‰¹æ€§ä¸Šå¹¶ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥åœ¨æ­¤æœŸé—´é‡åˆ°ä¸€äº›ä¸è§£çš„é—®é¢˜ï¼Œå†™å‡ºæ¥åˆ†äº«ä¸€ä¸‹ã€‚</li></ul><h3 id="é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å·¥å‚æ¨¡å¼"><a href="#é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å·¥å‚æ¨¡å¼" class="headerlink" title="é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å·¥å‚æ¨¡å¼"></a>é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å·¥å‚æ¨¡å¼</h3><ul><li>ç®€å•å·¥å‚æ¨¡å¼å°±æ˜¯é€šè¿‡ä¼ é€’ä¸åŒçš„å‚æ•°ï¼Œç”Ÿæˆä¸åŒçš„å®ä¾‹ï¼Œå·¥å‚æ–¹æ³•ä¸ºæ¯ä¸€ä¸ªproductæä¾›ä¸€ä¸ªå·¥ç¨‹ç±»ï¼Œé€šè¿‡ä¸åŒçš„å·¥å‚åˆ›å»ºä¸åŒçš„å®ä¾‹ã€‚</li></ul><h3 id="å…¸å‹å·¥å‚æ¨¡å¼çš„å®ç°æ–¹å¼ï¼ˆå³å…¸å‹oopå®ç°æ–¹å¼ï¼‰"><a href="#å…¸å‹å·¥å‚æ¨¡å¼çš„å®ç°æ–¹å¼ï¼ˆå³å…¸å‹oopå®ç°æ–¹å¼ï¼‰" class="headerlink" title="å…¸å‹å·¥å‚æ¨¡å¼çš„å®ç°æ–¹å¼ï¼ˆå³å…¸å‹oopå®ç°æ–¹å¼ï¼‰"></a>å…¸å‹å·¥å‚æ¨¡å¼çš„å®ç°æ–¹å¼ï¼ˆå³å…¸å‹oopå®ç°æ–¹å¼ï¼‰</h3><ul><li><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProviderModel</span>&#123;</span></span><br><span class="line">    provider <span class="built_in">string</span></span><br><span class="line">        <span class="function">func <span class="title">factory</span><span class="params">(providerName <span class="built_in">string</span>, test <span class="built_in">string</span>)</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> providerName == <span class="string">"AWS"</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> AWS(test)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> providerName == <span class="string">"Ali"</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Ali(test)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class AWS extends ProviderModel &#123;</span><br><span class="line">    func construct(test <span class="built_in">string</span>)&#123;</span><br><span class="line">        <span class="keyword">this</span>.test = test</span><br><span class="line">    &#125;</span><br><span class="line">    func doRequest()&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">awsmodel := ProviderModel::factory(<span class="string">"AWS"</span>)</span><br><span class="line">awsmodel.doRequest()</span><br><span class="line"></span><br><span class="line">alimodel := ProviderModel ::factory(<span class="string">"Ali"</span>)  </span><br><span class="line">alimodel.doRequest()</span><br></pre></td></tr></table></figure></li></ul><h3 id="golangå®ç°å·¥å‚æ¨¡å¼å­˜åœ¨çš„é—®é¢˜"><a href="#golangå®ç°å·¥å‚æ¨¡å¼å­˜åœ¨çš„é—®é¢˜" class="headerlink" title="golangå®ç°å·¥å‚æ¨¡å¼å­˜åœ¨çš„é—®é¢˜"></a>golangå®ç°å·¥å‚æ¨¡å¼å­˜åœ¨çš„é—®é¢˜</h3><ul><li><p>golangçš„ç‰¹æ€§ä¸­å¹¶æ²¡æœ‰åƒjavaä¸€æ ·çš„ç»§æ‰¿å’Œé‡è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åˆ©ç”¨golangå­˜åœ¨çš„ç‰¹æ€§ï¼Œé€è¿‡å·¥å‚æ¨¡å¼çš„è¡¨é¢é€æå…¶æœ¬è´¨ã€‚</p></li><li><p>æˆ‘ä»¬çœ‹ä¸€ä¸‹å·¥å‚æ¨¡å¼å°±çŸ¥é“ï¼Œæ‰€è°“å·¥å‚å…¶å®å°±æ˜¯å®šä¹‰äº†ä¸€äº›éœ€è¦å»å®ç°çš„æ–¹æ³•ï¼Œgolangçš„interfaceæ­£æ˜¯å¯ä»¥åšåˆ°ã€‚äºæ˜¯å…ˆåˆ°Googleä¸Šæœäº†ä¸€æ®µgolangå®ç°çš„å·¥å‚æ¨¡å¼çš„ä»£ç ã€‚</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Operater <span class="keyword">interface</span> &#123;</span><br><span class="line">    Operate(<span class="keyword">int</span>, <span class="keyword">int</span>) <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AddOperate <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *AddOperate)</span> <span class="title">Operate</span><span class="params">(rhs <span class="keyword">int</span>, lhs <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rhs + lhs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MultipleOperate <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *MultipleOperate)</span> <span class="title">Operate</span><span class="params">(rhs <span class="keyword">int</span>, lhs <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rhs * lhs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OperateFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewOperateFactory</span><span class="params">()</span> *<span class="title">OperateFactory</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;OperateFactory&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *OperateFactory)</span> <span class="title">CreateOperate</span><span class="params">(operatename <span class="keyword">string</span>)</span> <span class="title">Operater</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> operatename &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;AddOperate&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;MultipleOperate&#123;&#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"æ— æ•ˆè¿ç®—ç¬¦å·"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Operator := NewOperateFactory().CreateOperate(<span class="string">"+"</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"add result is %d\n"</span>, Operator.Operate(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç çœ‹èµ·æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œåæ¥åˆçœ‹åˆ°ä¸€ç§å®ç°æ–¹å¼ï¼Œ<a href="https://www.jianshu.com/p/9de2cd9bf8f0" target="_blank" rel="noopener">æ¥è‡ªè¿™ç¯‡åšå®¢</a>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> site <span class="keyword">interface</span> &#123;</span><br><span class="line">    fetch()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> siteModel <span class="keyword">struct</span> &#123;</span><br><span class="line">    URL <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> site1 <span class="keyword">struct</span> &#123;</span><br><span class="line">    siteModel</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s site1)</span> <span class="title">fetch</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">"site1 fetch data"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">factory</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">site</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s == <span class="string">"site"</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> site1&#123;</span><br><span class="line">            siteModel&#123;URL: <span class="string">"http://www.xxxx.com"</span>&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := factory(<span class="string">"site"</span>)</span><br><span class="line">    s.fetch()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç åˆçœ‹ä¸Šå»è·Ÿç¬¬ä¸€ä¸ªå®ç°æ²¡ä»€ä¹ˆä¸ä¸€æ ·ï¼Œä½†æ˜¯å½“æˆ‘è¯¦ç»†é˜…è¯»ä»£ç æ—¶ï¼Œä¸‹é¢çš„è¿™å¥ä»£ç ç€å®æŠŠæˆ‘å¼„æ™•äº†</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">factory</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">site</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s == <span class="string">"site"</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> site1&#123;</span><br><span class="line">            siteModel&#123;URL: <span class="string">"http://www.xxxx.com"</span>&#125;,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>factoryå‡½æ•°çš„è¿”å›å€¼å®šä¹‰æ˜æ˜æ˜¯ä¸€ä¸ªinterface, ä½†æ˜¯åœ¨returnçš„æ—¶å€™ï¼Œå´è¿”å›ä¸€ä¸ªstructï¼ŒæŸ¥é˜…å¾ˆå¤šèµ„æ–™åï¼Œ<a href="http://legendtkl.com/2017/06/12/understanding-golang-interface/" target="_blank" rel="noopener">è¿™ç¯‡åšå®¢</a>å¸®äº†æˆ‘çš„å¤§å¿™ï¼Œå…¶ä¸­å¯¹interfaceçš„è§£é‡Šæœ‰è¿™ä¹ˆä¸€å¥è¯ï¼š<strong>åœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç»„ method çš„é›†åˆï¼Œæ˜¯ duck-type programming çš„ä¸€ç§ä½“ç°ã€‚ä¸å…³å¿ƒå±æ€§ï¼ˆæ•°æ®ï¼‰ï¼Œåªå…³å¿ƒè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ã€‚å…·ä½“ä½¿ç”¨ä¸­ä½ å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„ structï¼Œå¹¶æä¾›ç‰¹å®šçš„ interface é‡Œé¢çš„ method å°±å¯ä»¥æŠŠå®ƒå½“æˆ interface æ¥ä½¿ç”¨ã€‚</strong>ä¹‹ååˆè¯¦ç»†çœ‹äº†å‡ éè¿™ç¯‡åšæ–‡ï¼ŒçŠ¹å¦‚é†é†çŒé¡¶ï¼Œå¯¹golanginterfaceçš„ç†è§£æ›´æ·±äº†ä¸€å±‚ã€‚è¯»å®Œè¿™ç¯‡åå†å»å®ç°å·¥å‚æ¨¡å¼ï¼Œæˆ–è€…å†å»å†™golangçš„ä»£ç ï¼Œå¯¹interfaceçš„ä½¿ç”¨å°±ä¼šæ›´è‡ªå¦‚ä¸€äº›ã€‚</p></li></ul><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><p>æœ¬æœŸæŠ€æœ¯å‘¨åˆŠä¸»è¦ç”±golangå·¥å‚æ¨¡å¼çš„è®¨è®ºå¼•èµ·ï¼Œä¹‹ååˆæ¶‰åŠåˆ°golang interfaceç‰¹æ€§çš„è®¨è®ºï¼Œå¯¹ä»¥åä½¿ç”¨golangç¼–å†™æ›´åŠ å¤æ‚çš„ä»£ç å¾ˆæœ‰å¸®åŠ©ã€‚</p></li><li><p>æœ¬æœŸç»“æŸï¼Œæ¬²çŸ¥åäº‹å¦‚ä½•ï¼Œä¸”çœ‹ä¸‹å‘¨åˆ†è§£ã€‚</p><p><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1535796309427&amp;di=a9db53cf71b492f4dd06a57b5ec65229&amp;imgtype=jpg&amp;src=http%3A%2F%2Fimg4.imgtn.bdimg.com%2Fit%2Fu%3D2705270329%2C1518266531%26fm%3D214%26gp%3D0.jpg" alt=""></p></li></ul><hr>]]></content>
    
    <summary type="html">
    
      å·¥ä½œéœ€è¦ï¼Œçœ‹äº†ä¸€ä¸‹golangå¦‚ä½•å®ç°å·¥å‚æ¨¡å¼ï¼Œé‡åˆ°ä¸€äº›éš¾ä»¥ç†è§£çš„çŸ¥è¯†ç‚¹ï¼ŒæŸ¥èµ„æ–™ï¼Œå†™demoéªŒè¯åï¼Œè®°å½•ä¸‹æ¥ä»¥ä¾›å‚è€ƒ
    
    </summary>
    
      <category term="æŠ€æœ¯å‘¨åˆŠ" scheme="https://cloudsjhan.github.io/categories/%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A/"/>
    
    
      <category term="golang design pattern go-interface" scheme="https://cloudsjhan.github.io/tags/golang-design-pattern-go-interface/"/>
    
  </entry>
  
  <entry>
    <title>golangä¸­çš„å·¥å‚æ¨¡å¼</title>
    <link href="https://cloudsjhan.github.io/2018/08/27/golang%E4%B8%AD%E7%9A%84%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F-md/"/>
    <id>https://cloudsjhan.github.io/2018/08/27/golangä¸­çš„å·¥å‚æ¨¡å¼-md/</id>
    <published>2018-08-27T10:53:24.000Z</published>
    <updated>2018-08-27T11:18:09.576Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="https://" alt="" style="width:100%"></p><a id="more"></a><ul><li>ç ”ç©¶goçš„è®¾è®¡æ¨¡å¼ï¼Œå¿…é¡»äº†è§£goçš„structå’Œinterfaceï¼Œè‹¥ä¸ç†Ÿæ‚‰ï¼Œå…ˆé˜…è¯»ä»¥ä¸‹å†…å®¹</li><li><a href="http://blog.csdn.net/wangshubo1989/article/details/70040022" target="_blank" rel="noopener">goè¯­è¨€çš„struct</a></li><li><a href="http://blog.csdn.net/wangshubo1989/article/details/70053086" target="_blank" rel="noopener">goè¯­è¨€çš„interface</a></li></ul><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">* ç®€å•å·¥å‚æ¨¡å¼</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Operater <span class="keyword">interface</span> &#123;</span><br><span class="line">    Operate(<span class="keyword">int</span>, <span class="keyword">int</span>) <span class="keyword">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AddOperate <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *AddOperate)</span> <span class="title">Operate</span><span class="params">(rhs <span class="keyword">int</span>, lhs <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rhs + lhs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MultipleOperate <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *MultipleOperate)</span> <span class="title">Operate</span><span class="params">(rhs <span class="keyword">int</span>, lhs <span class="keyword">int</span>)</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rhs * lhs</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OperateFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewOperateFactory</span><span class="params">()</span> *<span class="title">OperateFactory</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;OperateFactory&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *OperateFactory)</span> <span class="title">CreateOperate</span><span class="params">(operatename <span class="keyword">string</span>)</span> <span class="title">Operater</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> operatename &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"+"</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;AddOperate&#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"*"</span>:</span><br><span class="line">        <span class="keyword">return</span> &amp;MultipleOperate&#123;&#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">"æ— æ•ˆè¿ç®—ç¬¦å·"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Operator := NewOperateFactory().CreateOperate(<span class="string">"+"</span>)</span><br><span class="line">    fmt.Printf(<span class="string">"add result is %d\n"</span>, Operator.Operate(<span class="number">1</span>, <span class="number">2</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">* å·¥å‚æ–¹æ³•</span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">"fmt"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Operation <span class="keyword">struct</span> &#123;</span><br><span class="line">    a <span class="keyword">float64</span></span><br><span class="line">    b <span class="keyword">float64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> OperationI <span class="keyword">interface</span> &#123;</span><br><span class="line">    GetResult() <span class="keyword">float64</span></span><br><span class="line">    SetA(<span class="keyword">float64</span>)</span><br><span class="line">    SetB(<span class="keyword">float64</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(op *Operation)</span> <span class="title">SetA</span><span class="params">(a <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">    op.a = a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(op *Operation)</span> <span class="title">SetB</span><span class="params">(b <span class="keyword">float64</span>)</span></span> &#123;</span><br><span class="line">    op.b = b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AddOperation <span class="keyword">struct</span> &#123;</span><br><span class="line">    Operation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *AddOperation)</span> <span class="title">GetResult</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> this.a + this.b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SubOperation <span class="keyword">struct</span> &#123;</span><br><span class="line">    Operation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *SubOperation)</span> <span class="title">GetResult</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> this.a - this.b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MulOperation <span class="keyword">struct</span> &#123;</span><br><span class="line">    Operation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *MulOperation)</span> <span class="title">GetResult</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> this.a * this.b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DivOperation <span class="keyword">struct</span> &#123;</span><br><span class="line">    Operation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DivOperation)</span> <span class="title">GetResult</span><span class="params">()</span> <span class="title">float64</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> this.a / this.b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IFactory <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateOperation() Operation</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AddFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *AddFactory)</span> <span class="title">CreateOperation</span><span class="params">()</span> <span class="title">OperationI</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;(AddOperation&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SubFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *SubFactory)</span> <span class="title">CreateOperation</span><span class="params">()</span> <span class="title">OperationI</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;(SubOperation&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MulFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *MulFactory)</span> <span class="title">CreateOperation</span><span class="params">()</span> <span class="title">OperationI</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;(MulOperation&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> DivFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(this *DivFactory)</span> <span class="title">CreateOperation</span><span class="params">()</span> <span class="title">OperationI</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;(DivOperation&#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fac := &amp;(AddFactory&#123;&#125;)</span><br><span class="line">    oper := fac.CreateOperation()</span><br><span class="line">    oper.SetA(<span class="number">1</span>)</span><br><span class="line">    oper.SetB(<span class="number">2</span>)</span><br><span class="line">    fmt.Println(oper.GetResult())</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">* æŠ½è±¡å·¥å‚æ–¹æ³•</span><br><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">"fmt"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> GirlFriend <span class="keyword">struct</span> &#123;</span><br><span class="line">    nationality <span class="keyword">string</span></span><br><span class="line">    eyesColor   <span class="keyword">string</span></span><br><span class="line">    language    <span class="keyword">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AbstractFactory <span class="keyword">interface</span> &#123;</span><br><span class="line">    CreateMyLove() GirlFriend</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> IndianGirlFriendFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> KoreanGirlFriendFactory <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a IndianGirlFriendFactory)</span> <span class="title">CreateMyLove</span><span class="params">()</span> <span class="title">GirlFriend</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> GirlFriend&#123;<span class="string">"Indian"</span>, <span class="string">"Black"</span>, <span class="string">"Hindi"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a KoreanGirlFriendFactory)</span> <span class="title">CreateMyLove</span><span class="params">()</span> <span class="title">GirlFriend</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> GirlFriend&#123;<span class="string">"Korean"</span>, <span class="string">"Brown"</span>, <span class="string">"Korean"</span>&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getGirlFriend</span><span class="params">(typeGf <span class="keyword">string</span>)</span> <span class="title">GirlFriend</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> gffact AbstractFactory</span><br><span class="line">    <span class="keyword">switch</span> typeGf &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Indian"</span>:</span><br><span class="line">        gffact = IndianGirlFriendFactory&#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> gffact.CreateMyLove()</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"Korean"</span>:</span><br><span class="line">        gffact = KoreanGirlFriendFactory&#123;&#125;</span><br><span class="line">        <span class="keyword">return</span> gffact.CreateMyLove()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> GirlFriend&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    a := getGirlFriend(<span class="string">"Indian"</span>)</span><br><span class="line"></span><br><span class="line">    fmt.Println(a.eyesColor)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      &lt;p class=&quot;description&quot;&gt;&lt;/p&gt;

&lt;p&gt;&lt;img src=&quot;https://&quot; alt=&quot;&quot; style=&quot;width:100%&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
      <category term="è®¾è®¡æ¨¡å¼" scheme="https://cloudsjhan.github.io/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>Mac os ç¯å¢ƒé…ç½®ruby on rails åŠå…¶Hello world</title>
    <link href="https://cloudsjhan.github.io/2018/08/26/Mac-os-%E9%85%8D%E7%BD%AE-ruby-on-rails-md/"/>
    <id>https://cloudsjhan.github.io/2018/08/26/Mac-os-é…ç½®-ruby-on-rails-md/</id>
    <published>2018-08-26T15:20:33.000Z</published>
    <updated>2018-08-27T15:39:24.975Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><a id="more"></a><p>ä»Šå¤©åœ¨Mac OSç¯å¢ƒä¸­å€’è…¾ruby on railsï¼Œé‡åˆ°ä¸€äº›å‘å¹¶æ’å‘åæ€»ç»“ä¸€ä¸ªæ­å»ºè¿‡ç¨‹ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚</p><h3 id="å¤§çº²"><a href="#å¤§çº²" class="headerlink" title="å¤§çº²"></a>å¤§çº²</h3><ul><li><p>æœ¬ç€ITå±Šèƒ½ç”¨æœ€æ–°çš„å°±ä¸ç”¨å‰é¢çš„ç‰ˆæœ¬çš„å®—æ—¨ï¼Œåœ¨è¿›è¡Œä¹‹å‰å¿…é¡»å°†ä½ çš„Macå‡çº§åˆ°æœ€æ–°çš„macOS High Sierra</p></li><li><p>å®‰è£… XCode Command Line Tools</p></li><li><p>é…ç½®Git</p></li><li><p>å®‰è£…Homebrew</p></li><li><p>å®‰è£…GPG</p></li><li><p>å®‰è£…RVM</p></li><li><p>å®‰è£…ruby</p></li><li><p>å‡çº§RubyGems</p></li><li><p>å®‰è£…rails</p></li><li><p>åŸºæœ¬MVCæ¢ç©¶ä¹‹Hello world</p><h3 id="Ruby-On-rails-for-mac-os-High-Sierra"><a href="#Ruby-On-rails-for-mac-os-High-Sierra" class="headerlink" title="Ruby On rails for mac os High Sierra"></a>Ruby On rails for mac os High Sierra</h3><ul><li><p>Mac OSæ˜¯è‡ªå¸¦rubyçš„ï¼Œä½†æ˜¯è¿™äº›rubyçš„ç‰ˆæœ¬éƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸è¦ç”¨è¿™äº›è¿‡æ—¶çš„ç‰ˆæœ¬</p></li><li><p>é¦–å…ˆï¼Œå‡çº§ä½ çš„Mac OSåˆ°10.13</p></li><li><p>æŸ¥çœ‹æ˜¯å¦å®‰è£…xcode command line toolï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span>:xcode-select -p</span><br><span class="line">å¦‚æœä½ çœ‹åˆ°ï¼š</span><br><span class="line">xcode-select: error: unable to get active developer directory...</span><br><span class="line">è¯´æ˜ä½ æ²¡æœ‰å®‰è£…xcode command line tool,éœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤å®‰è£…ã€‚</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¦‚æœä½ çœ‹åˆ°ï¼š</span><br><span class="line"><span class="meta">$</span>:/Applications/Xcode.app/Contents/Developer æˆ–è€…/Library/Developer/CommandLineTools</span><br><span class="line">æ­å–œä½ ï¼Œxcode command line toolä½ å·²ç»å®‰è£…å¥½äº†</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Butï¼Œå¦‚æœä½ å¾ˆä¸å¹¸è¿åœ°çœ‹åˆ°äº†è¿™å¥è¯ï¼š</span><br><span class="line">$: /Applications/Apple Dev Tools/Xcode.app/Contents/Developer</span><br><span class="line">é‚£ä¹ˆä½ å°±è¦å¸æ‰xcodeé‡æ–°å®‰è£…äº†ï¼Œå…·ä½“åŸå› çœ‹</span><br></pre></td></tr></table></figure><p><a href="http://rvm.io/support/faq#can-i-use-a-path-with-spaces" target="_blank" rel="noopener">è¿™é‡Œ</a></p></li><li><p>å®‰è£…xcode</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcode-select --install</span><br></pre></td></tr></table></figure></li><li><p>ä¸€è·¯ç¡®è®¤ä¹‹åï¼Œå°±å¯ä»¥å®‰å¥½xcodeï¼Œä½†æ˜¯å¦‚æœä½ çš„ç½‘é€Ÿä¸å¥½ï¼Œç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œä½ å¯ä»¥ä»<a href="https://developer.apple.com/downloads/more" target="_blank" rel="noopener">è¿™é‡Œ</a>è¾“å…¥ä½ çš„APPIDä¸‹è½½ã€‚</p></li><li><p>ç¡®è®¤ä¸€ä¸‹æ˜¯å¦å®‰å¥½</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> xcode-select -p</span><br><span class="line">/Library/Developer/CommandLineTools</span><br></pre></td></tr></table></figure></li></ul><h3 id="é…ç½®Git"><a href="#é…ç½®Git" class="headerlink" title="é…ç½®Git"></a>é…ç½®Git</h3><ul><li><p>åœ¨å®‰è£…ruby on rails ä¹‹å‰ï¼Œä½ åº”è¯¥é…ç½®ä½ çš„Gitã€‚Gitåœ¨Mac OSä¸Šä½¿è‡ªåŠ¨å®‰è£…çš„è½¯ä»¶</p></li><li><p>æ£€æŸ¥Gitç‰ˆæœ¬å¹¶ç¡®è®¤å·²ç»å®‰è£…è®©ä½ æ”¾å¿ƒ</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> git version</span><br><span class="line">git version 2.4.9 (Apple Git-60)</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®Gitä¹‹å‰ï¼Œä½ åº”è¯¥åˆ°<a href="https://help.github.com/articles/signing-up-for-a-new-github-account/" target="_blank" rel="noopener">GitHub</a>ä¸Šæ³¨å†Œä½ çš„è´¦å·å¹¶è®°ä½å¯†ç å’Œé‚®ç®±ã€‚å¹¶ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> git config -l --global</span><br><span class="line">fatal: unable to read config file '/Users/.../.gitconfig': No such file or directory</span><br><span class="line"><span class="meta">$</span> git config --global user.name "Your Real Name"</span><br><span class="line"><span class="meta">$</span> git config --global user.email me@example.com</span><br><span class="line"><span class="meta">$</span> git config -l --global</span><br><span class="line">user.name=Your Real Name</span><br><span class="line">user.email=me@example.com</span><br></pre></td></tr></table></figure></li><li><p>Gité…ç½®å®Œæˆï¼Œåœ¨ä½ æƒ³ç”¨Gitçš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¹¦å‡ºæ¥äº†ã€‚</p></li></ul><h3 id="å®‰è£…Homebrow"><a href="#å®‰è£…Homebrow" class="headerlink" title="å®‰è£…Homebrow"></a>å®‰è£…Homebrow</h3><ul><li><p>æ£€æŸ¥homebrowæ˜¯å¦å·²ç»å®‰è£…</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> brew</span><br><span class="line">-bash: brew: command not found</span><br></pre></td></tr></table></figure><p>RVMéœ€è¦<a href="http://brew.sh/" target="_blank" rel="noopener">Homebrow</a>,å…¶å®ä¸€ä¸ªMac OSé¢å®‰è£…åŒ…ç®¡ç†å·¥å…·ï¼Œç”¨æ¥ä¸‹è½½ä¸€äº›è½¯ä»¶ï¼Œç±»ä¼¼äºUbuntuçš„apt-getå’Œcentosçš„yum install.ä¸ºé¿å…å®‰è£…RMå‡ºç°é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…homebrowï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"</span><br></pre></td></tr></table></figure><p>å®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºç°ä¸€äº›warningå¹¶è®©ä½ è¾“å…¥å¯†ç ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WARNING: Improper use of the sudo command could lead to data loss...</span><br><span class="line">To proceed, enter your password...</span><br><span class="line">Password:</span><br></pre></td></tr></table></figure><p>å°½ç®¡è¾“å…¥å¯†ç ï¼Œå¿½ç•¥warningã€‚</p><p>æˆ‘ä»¬è¿™é‡Œæ˜¯ä½¿ç”¨äº†Mac OSå†…ç½®çš„rubyæ¥å®‰è£…homebrowã€‚</p></li></ul><h3 id="å®‰è£…GPG"><a href="#å®‰è£…GPG" class="headerlink" title="å®‰è£…GPG"></a>å®‰è£…GPG</h3><ul><li><p><a href="https://en.wikipedia.org/wiki/GNU_Privacy_Guard" target="_blank" rel="noopener">gpg</a>æ˜¯ä¸€ä¸ªç”¨æ¥æ£€æŸ¥RVMä¸‹è½½åŒ…çš„å®‰å…¨æ€§çš„ç¨‹åºï¼Œæˆ‘ä»¬ä½¿ç”¨homebrewæ¥å®‰è£…gpg:</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> brew install gpg</span><br></pre></td></tr></table></figure></li><li><p>gpgå®‰è£…ä¹‹åï¼Œä¸ºRVMå®‰è£…key:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> command curl -sSL https://rvm.io/mpapis.asc | gpg --import -</span><br></pre></td></tr></table></figure></li></ul><h3 id="å®‰è£…RVM"><a href="#å®‰è£…RVM" class="headerlink" title="å®‰è£…RVM"></a>å®‰è£…RVM</h3><ul><li><p><a href="https://rvm.io/" target="_blank" rel="noopener">RVM</a>ï¼Œæ˜¯Ruby version managerçš„ç®€å†™ï¼Œç”¨æ¥å®‰è£…rubyæˆ–è€…ç®¡ç†railsç‰ˆæœ¬ã€‚<a href="https://rvm.io/rvm/install/" target="_blank" rel="noopener">è¿™ä¸ªç½‘ç«™</a>è¯¦ç»†è¯´æ˜äº†å®‰è£…rubyçš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰ä¸€ç§æœ€ç®€ä¾¿çš„æ–¹å¼ï¼š</p></li><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> \curl -L https://get.rvm.io | bash -s stable</span><br></pre></td></tr></table></figure><p>â€œcurlâ€å‰é¢çš„â€œ\â€ç”¨æ¥é¿å…rubyç‰ˆæœ¬çš„å†²çªï¼Œä¸è¦æ¼æ‰ã€‚</p></li><li><p>å®‰è£…è¿‡ç¨‹ä¸­ä½ å¯èƒ½ä¼šçœ‹åˆ°</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir: /etc/openssl: Permission denied</span><br><span class="line">mkdir -p "/etc/openssl" failed, retrying with sudo</span><br><span class="line">your password required for 'mkdir -p /etc/openssl':</span><br></pre></td></tr></table></figure><p>è¯·è¾“å…¥å¯†ç å¹¶ç»§ç»­ã€‚</p></li><li><p>å¦‚æœä½ å·²ç»å®‰è£…è¿‡RVMï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤updateï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> rvm get stable --autolibs=enable</span><br></pre></td></tr></table></figure></li><li><p>é‡å¯terminalçª—å£æˆ–è€…ä½¿ç”¨ï¼šä½¿RVMç”Ÿæ•ˆ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> source ~/.rvm/scripts/rvm</span><br></pre></td></tr></table></figure></li></ul><h3 id="å®‰è£…ruby"><a href="#å®‰è£…ruby" class="headerlink" title="å®‰è£…ruby"></a>å®‰è£…ruby</h3><ul><li><p>åœ¨å®‰è£…RVMä¹‹åï¼Œæˆ‘ä»¬å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„rubyã€‚ruby 2.5.1æ˜¯å†™æ­¤åšå®¢æ—¶å½“å‰æœ€æ–°çš„rubyç‰ˆæœ¬ï¼Œè¿˜è¯·æŸ¥çœ‹ruby<a href="$ source ~/.rvm/scripts/rvm">å®˜ç½‘</a>æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬çš„rubyã€‚å¿…é¡»æŒ‡å®šrubyçš„ç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> rvm install ruby-2.5.1</span><br></pre></td></tr></table></figure><p>å®‰è£…åæ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> ruby -v</span><br><span class="line">ruby 2.5.1...</span><br></pre></td></tr></table></figure></li></ul><h3 id="å‡çº§rubyGemset"><a href="#å‡çº§rubyGemset" class="headerlink" title="å‡çº§rubyGemset"></a>å‡çº§rubyGemset</h3><ul><li><p><a href="https://rubygems.org/gems/rubygems-update" target="_blank" rel="noopener">RubyGems</a>æ˜¯ä¸€ä¸ªrubyçš„åŒ…ç®¡ç†å·¥å…·ï¼Œç”¨æ¥å®‰è£…rubyçš„å·¥å…·æˆ–è€…é¢å¤–åŠŸèƒ½çš„åŒ…ã€‚</p></li><li><p>æŸ¥çœ‹gemç‰ˆæœ¬ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> gem -v</span><br></pre></td></tr></table></figure><p>å°†gemå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> gem update --system</span><br></pre></td></tr></table></figure></li><li><p>æ˜¾ç¤ºRVM gemsetsçš„æœ€åˆä¸¤ä¸ªè®¾ç½®</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> rvm gemset list</span><br><span class="line">gemsets for ruby-2.5.0</span><br><span class="line">=&gt; (default)</span><br><span class="line">   global</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬ä½¿ç”¨globalï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> rvm gemset use global</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…bundle,<a href="https://rubygems.org/gems/bundler" target="_blank" rel="noopener">Bundle</a>æ˜¯ä¸€ä¸ªç®¡ç†gemçš„å¿…é¡»çš„å·¥å…·</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> gem install Bundler</span><br></pre></td></tr></table></figure></li><li><p>å®‰è£…Nokogiriï¼Œ<a href="http://nokogiri.org/" target="_blank" rel="noopener">Nokogiri</a>éœ€è¦ç¼–è¯‘æˆæŒ‡å®šçš„ç³»ç»Ÿï¼Œåœ¨ä¸Šé¢çš„é…ç½®ä¸‹ï¼Œå·ç§°æœ€éš¾å®‰è£…çš„åŒ…ï¼Œä¹Ÿå°†å®‰è£…å¥½</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ gem install nokogiri</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çœŸçš„ä¸å¹¸è¿åœ¨å®‰è£…æ—¶é‡åˆ°é—®é¢˜ï¼ŒStack <a href="http://stackoverflow.com/questions/tagged/nokogiri" target="_blank" rel="noopener">Overflow</a>èƒ½å¸®åˆ°ä½ ã€‚</p></li></ul><h3 id="å®‰è£…rails"><a href="#å®‰è£…rails" class="headerlink" title="å®‰è£…rails"></a>å®‰è£…rails</h3><ul><li><p><a href="http://rubygems.org/gems/rails" target="_blank" rel="noopener">è¿™é‡Œ</a>æ˜¯ruby On railæœ€æ–°çš„ç‰ˆæœ¬ï¼Œ5.1æ˜¯æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼Œ5.2æ˜¯releaseç‰ˆæœ¬ï¼Œæˆ‘ä»¬å®‰è£…5.1.</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> gem install rails --version=5.1</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ å–œæ¬¢å°é²œï¼Œå¯ä»¥ä½¿ç”¨</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> gem install rails --pre</span><br></pre></td></tr></table></figure><p>å®‰è£…releaseç‰ˆæœ¬ã€‚</p><p>æ£€æŸ¥ä¸€ä¸‹railsæ˜¯å¦è£…å¥½ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> rails -v</span><br><span class="line">Rails 5.2.0</span><br></pre></td></tr></table></figure></li><li><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œruby on rails ä»¥åŠå…¶ç¯å¢ƒé…ç½®éƒ½å·²å¦¥å½“ï¼Œå¯ä»¥å¼€å§‹ä½ çš„rubyä¹‹æ—…äº†ã€‚</p></li></ul><h3 id="ruby-on-rails-çš„Hello-world"><a href="#ruby-on-rails-çš„Hello-world" class="headerlink" title="ruby on rails çš„Hello world"></a>ruby on rails çš„Hello world</h3><ul><li><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span> cd /</span><br><span class="line"><span class="meta">$</span> mkdir worlspace</span><br><span class="line"><span class="meta">$</span> cd workspace</span><br><span class="line"><span class="meta">$</span> rails _5.1.0_ new hello_app</span><br><span class="line"><span class="meta">$</span> cd hello_app</span><br><span class="line"><span class="meta">$</span> rails server</span><br></pre></td></tr></table></figure><p>å°†<a href="http://localhost:3000è¾“å…¥æµè§ˆå™¨ï¼Œå°±èƒ½çœ‹åˆ°ruby" target="_blank" rel="noopener">http://localhost:3000è¾“å…¥æµè§ˆå™¨ï¼Œå°±èƒ½çœ‹åˆ°ruby</a> on railsçš„æ¬¢è¿ç•Œé¢ã€‚</p></li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;p class=&quot;description&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ruby" scheme="https://cloudsjhan.github.io/categories/ruby/"/>
    
    
      <category term="ruby on rails" scheme="https://cloudsjhan.github.io/tags/ruby-on-rails/"/>
    
      <category term="web" scheme="https://cloudsjhan.github.io/tags/web/"/>
    
  </entry>
  
  <entry>
    <title>goå®ç°UNIX command</title>
    <link href="https://cloudsjhan.github.io/2018/08/22/go-unix-cmd-md/"/>
    <id>https://cloudsjhan.github.io/2018/08/22/go-unix-cmd-md/</id>
    <published>2018-08-22T11:27:41.000Z</published>
    <updated>2018-09-01T05:38:25.962Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"bufio"</span></span><br><span class="line"><span class="string">"errors"</span></span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"os"</span></span><br><span class="line"><span class="string">"os/exec"</span></span><br><span class="line"><span class="string">"strings"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">reader := bufio.NewReader(os.Stdin)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">fmt.Print(<span class="string">"&gt; "</span>)</span><br><span class="line"><span class="comment">// è¯»å–é”®ç›˜çš„è¾“å…¥.</span></span><br><span class="line">input, err := reader.ReadString(<span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(os.Stderr, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ‰§è¡Œå¹¶è§£æcommand.</span></span><br><span class="line">err = execInput(input)</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">fmt.Fprintln(os.Stderr, err)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¦‚æœcdå‘½ä»¤æ²¡æœ‰è·¯å¾„çš„è¯ï¼Œå°±æŠ¥ä¸‹é¢çš„é”™è¯¯</span></span><br><span class="line"><span class="keyword">var</span> ErrNoPath = errors.New(<span class="string">"path required"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">execInput</span><span class="params">(input <span class="keyword">string</span>)</span> <span class="title">error</span></span> &#123;</span><br><span class="line"><span class="comment">// ç§»é™¤æ¢è¡Œç¬¦.</span></span><br><span class="line">input = strings.TrimSuffix(input, <span class="string">"\n"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†è¾“å…¥åˆ†å‰²æˆå‚æ•°.</span></span><br><span class="line">args := strings.Split(input, <span class="string">" "</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹cdå‘½ä»¤çš„æƒ…å†µè¿›è¡ŒåŒºåˆ†.</span></span><br><span class="line"><span class="keyword">switch</span> args[<span class="number">0</span>] &#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">"cd"</span>:</span><br><span class="line"><span class="comment">// æš‚æ—¶ä¸æ”¯æŒcdåŠ ç©ºæ ¼è¿›å…¥homeç›®å½•.</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(args) &lt; <span class="number">2</span> &#123;</span><br><span class="line"><span class="keyword">return</span> ErrNoPath</span><br><span class="line">&#125;</span><br><span class="line">err := os.Chdir(args[<span class="number">1</span>])</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Stop further processing.</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"exit"</span>:</span><br><span class="line">os.Exit(<span class="number">0</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Prepare the command to execute.</span></span><br><span class="line">cmd := exec.Command(args[<span class="number">0</span>], args[<span class="number">1</span>:]...)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the correct output device.</span></span><br><span class="line">cmd.Stderr = os.Stderr</span><br><span class="line">cmd.Stdout = os.Stdout</span><br><span class="line"></span><br><span class="line"><span class="comment">// Execute the command and save it's output.</span></span><br><span class="line">err := cmd.Run()</span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//æ‰§è¡Œå¹¶æµ‹è¯•</span><br><span class="line">go run main.go</span><br></pre></td></tr></table></figure><p>æš‚æ—¶ä¸æ”¯æŒtabé”®è‡ªåŠ¨è¡¥å…¨å‘½ä»¤ï¼Œåªæ˜¯æä¾›ä¸€ç§ç®€å•çš„æ€è·¯ã€‚</p><hr>]]></content>
    
    <summary type="html">
    
      ä½¿ç”¨goå®ç°UNIXç¯å¢ƒä¸‹çš„å‘½ä»¤è¡Œå·¥å…·
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="go" scheme="https://cloudsjhan.github.io/tags/go/"/>
    
      <category term="unix" scheme="https://cloudsjhan.github.io/tags/unix/"/>
    
  </entry>
  
  <entry>
    <title>iterm2 çªç„¶æŠ¥å¾ˆå¥‡æ€ªçš„é”™è¯¯-Error  No user exists for uid 501</title>
    <link href="https://cloudsjhan.github.io/2018/08/21/iterm2-strange-err-md-md/"/>
    <id>https://cloudsjhan.github.io/2018/08/21/iterm2-strange-err-md-md/</id>
    <published>2018-08-21T15:18:21.000Z</published>
    <updated>2018-08-21T15:33:12.206Z</updated>
    
    <content type="html"><![CDATA[<p class="description"></p><p><img src="http://www.qqyou.com/view.php?pic=http://p1.qqyou.com/pic/UploadPic/2014-7/9/2014070910421928610.jpg" alt="" style="width:100%"></p><a id="more"></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">No user exists <span class="keyword">for</span> uid <span class="number">501</span></span><br><span class="line">fatal: Could <span class="keyword">not</span> read <span class="keyword">from</span> remote repository.</span><br><span class="line">Please make sure you have the correct access rightsand the repository exists.</span><br></pre></td></tr></table></figure><ul><li>ä¸Šåˆè¿˜å¥½å¥½çš„ï¼Œåˆšåˆšè¿æ¥GitHubæŠ¥è¿™ä¸ªé”™è¯¯ï¼Œæ’æŸ¥åäº†è§£åˆ°æ˜¯iterm2çš„ç¥å‘ã€‚</li><li>é‡å¯itermç»ˆç«¯å°±å¥½ ç³»ç»Ÿæœ‰æ›´æ–°çš„è¯ éœ€è¦é‡å¯ç»ˆç«¯ æ›´æ–°ã€‚</li></ul><hr>]]></content>
    
    <summary type="html">
    
      iterm2 çªç„¶æŠ¥å¾ˆå¥‡æ€ªçš„é”™è¯¯-Error No user exists for uid 501
    
    </summary>
    
      <category term="ç”Ÿæ´»ä¸­å¥‡æ€ªçš„å‘" scheme="https://cloudsjhan.github.io/categories/%E7%94%9F%E6%B4%BB%E4%B8%AD%E5%A5%87%E6%80%AA%E7%9A%84%E5%9D%91/"/>
    
    
      <category term="æ—¥å¸¸çš„å‘ç³»åˆ—" scheme="https://cloudsjhan.github.io/tags/%E6%97%A5%E5%B8%B8%E7%9A%84%E5%9D%91%E7%B3%BB%E5%88%97/"/>
    
  </entry>
  
  <entry>
    <title>golangä¸­interfaceçš„é€šç”¨è®¾è®¡æ–¹æ³•</title>
    <link href="https://cloudsjhan.github.io/2018/08/21/golang%E9%80%9A%E7%94%A8%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95/"/>
    <id>https://cloudsjhan.github.io/2018/08/21/golangé€šç”¨æ¥å£è®¾è®¡æ–¹æ³•/</id>
    <published>2018-08-21T14:18:58.000Z</published>
    <updated>2018-08-21T15:10:30.131Z</updated>
    
    <content type="html"><![CDATA[<p class="description">golangä¸­æ¥å£è®¾è®¡çš„é€šç”¨æ–¹æ³•</p><a id="more"></a><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> æ¥å£å®šä¹‰</span><br><span class="line"><span class="keyword">type</span> XxxManager <span class="keyword">interface</span> &#123;</span><br><span class="line">    Create(args argsType) (*XxxStruct, error)</span><br><span class="line">    Get(args argsType) (**XxxStruct, error)</span><br><span class="line">    Update(args argsType) (*XxxStruct, error)</span><br><span class="line">    Delete(name <span class="keyword">string</span>, options *DeleleOptions) error</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">2.</span> ç»“æ„ä½“å®šä¹‰ </span><br><span class="line"><span class="keyword">type</span> XxxManagerImpl <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="keyword">string</span></span><br><span class="line">    Namespace <span class="keyword">string</span></span><br><span class="line">    kubeCli *kubernetes.Clientset</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">3</span>ï¼Œæ„é€ å‡½æ•°</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewXxxManagerImpl</span> <span class="params">(namespace, name <span class="keyword">string</span>, kubeCli *kubernetes.Clientset)</span> <span class="title">XxxManager</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;XxxManagerImpl&#123;</span><br><span class="line">        Name name,</span><br><span class="line">        Namespace namespace,</span><br><span class="line">        kubeCli: kubeCli,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="number">4.</span> æ–¹æ³•å…·ä½“å®ç°</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(xm *XxxManagerImpl)</span> <span class="title">Create</span><span class="params">(args argsType)</span> <span class="params">(*XxxStruct, error)</span></span> &#123;</span><br><span class="line">    <span class="comment">//å…·ä½“çš„æ–¹æ³•å®ç°</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>golangé€šç”¨æ¥å£è®¾è®¡</strong></p><p>æ ¹æ®ä»¥ä¸Šè®¾è®¡cdosapiå°è£…æ¥å£ï¼š</p>]]></content>
    
    <summary type="html">
    
      golangä¸­interfaceçš„é€šç”¨è®¾è®¡æ–¹æ³•
    
    </summary>
    
      <category term="golang" scheme="https://cloudsjhan.github.io/categories/golang/"/>
    
    
      <category term="golang" scheme="https://cloudsjhan.github.io/tags/golang/"/>
    
  </entry>
  
  <entry>
    <title>python3ä¸­é‡åˆ°&#39;TypeError Unicode-objects must be encoded before hashing&#39;</title>
    <link href="https://cloudsjhan.github.io/2018/08/20/python-md5-err-md/"/>
    <id>https://cloudsjhan.github.io/2018/08/20/python-md5-err-md/</id>
    <published>2018-08-20T14:18:58.000Z</published>
    <updated>2018-09-28T02:06:52.282Z</updated>
    
    <content type="html"><![CDATA[<p class="description">Python3ä¸­è¿›è¡ŒMD5åŠ å¯†ï¼Œé‡åˆ°ç¼–ç é—®é¢˜</p><a id="more"></a><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlencode, quote_plus</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">verfy_ac</span><span class="params">(private_key)</span>:</span></span><br><span class="line"></span><br><span class="line">    item = &#123;</span><br><span class="line">     <span class="string">"Action"</span>     :  <span class="string">"CreateUHostInstance"</span>,</span><br><span class="line">     <span class="string">"CPU"</span>        :  <span class="number">2</span>,</span><br><span class="line">     <span class="string">"ChargeType"</span> :  <span class="string">"Month"</span>,</span><br><span class="line">     <span class="string">"DiskSpace"</span>  :  <span class="number">10</span>,</span><br><span class="line">     <span class="string">"ImageId"</span>    :  <span class="string">"f43736e1-65a5-4bea-ad2e-8a46e18883c2"</span>,</span><br><span class="line">     <span class="string">"LoginMode"</span>  :  <span class="string">"Password"</span>,</span><br><span class="line">     <span class="string">"Memory"</span>     :  <span class="number">2048</span>,</span><br><span class="line">     <span class="string">"Name"</span>       :  <span class="string">"Host01"</span>,</span><br><span class="line">     <span class="string">"Password"</span>   :  <span class="string">"VUNsb3VkLmNu"</span>,</span><br><span class="line">     <span class="string">"PublicKey"</span>  :  <span class="string">"ucloudsomeone%40example.com1296235120854146120"</span>,</span><br><span class="line">     <span class="string">"Quantity"</span>   :  <span class="number">1</span>,</span><br><span class="line">     <span class="string">"Region"</span>     :  <span class="string">"cn-bj2"</span>,</span><br><span class="line">     <span class="string">"Zone"</span>       :  <span class="string">"cn-bj2-04"</span></span><br><span class="line"> &#125;</span><br><span class="line">    <span class="comment"># å°†å‚æ•°ä¸²æ’åº</span></span><br><span class="line"></span><br><span class="line">    params_data = <span class="string">""</span></span><br><span class="line">    <span class="keyword">import</span> pdb;pdb.set_trace()</span><br><span class="line">    <span class="keyword">for</span> key, value <span class="keyword">in</span> item.items():</span><br><span class="line">        params_data = params_data + str(key) + str(value)</span><br><span class="line">    params_data = params_data + private_key</span><br><span class="line">    params_data_en = quote_plus(params_data)</span><br><span class="line"></span><br><span class="line">    sign = hashlib.sha1()</span><br><span class="line">    sign.update(params_data_en.encode(<span class="string">'utf8'</span>))</span><br><span class="line">    signature = sign.hexdigest()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> signature</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">print(verfy_ac(<span class="string">"46f09bb9fab4f12dfc160dae12273d5332b5debe"</span>))</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯<a href="https://docs.ucloud.cn/api/summary/signature" target="_blank" rel="noopener">ucloudå®˜æ–¹çš„APIæ•™ç¨‹</a>ï¼Œæƒ³æ ¹æ®æ­¤æ•™ç¨‹ç”Ÿæˆç­¾åï¼Œæ•™ç¨‹ä¸­çš„ä»£ç æ˜¯åŸºäºPython2.7ç¼–å†™ï¼Œæˆ‘å°†å…¶æ”¹æˆäº†Python3.ä½†æ˜¯åœ¨æ‰§è¡Œæ—¶æŠ¥é”™ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TypeError: Unicode-objects must be encoded before hashing</span><br></pre></td></tr></table></figure><hr><p>æ’é”™åå‘ç°python3ä¸­å­—ç¬¦å¯¹è±¡æ˜¯unicodeå¯¹è±¡ï¼Œä¸èƒ½ç›´æ¥åŠ å¯†ï¼Œéœ€è¦ç¼–ç åæ‰èƒ½è¿›è¡Œupdateã€‚</p><p>å°±æ˜¯æ”¹æˆå¦‚ä¸‹å³å¯ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sign.update(params_data_en.encode(<span class="string">'utf8'</span>))</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      Pythonä¸­è¿›è¡Œmd5åŠ å¯†æ—¶é‡åˆ°çš„ç¼–ç é—®é¢˜
    
    </summary>
    
      <category term="python" scheme="https://cloudsjhan.github.io/categories/python/"/>
    
    
      <category term="python" scheme="https://cloudsjhan.github.io/tags/python/"/>
    
      <category term="md5ç¼–ç " scheme="https://cloudsjhan.github.io/tags/md5%E7%BC%96%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="https://cloudsjhan.github.io/2018/08/18/hello-world/"/>
    <id>https://cloudsjhan.github.io/2018/08/18/hello-world/</id>
    <published>2018-08-18T14:05:08.384Z</published>
    <updated>2018-08-18T14:05:08.384Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p><h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p><h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p><h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p><h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
      
    
    </summary>
    
    
  </entry>
  
</feed>

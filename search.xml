<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title><![CDATA[åœ¨ Confluent Cloud ä¸Šä½¿ç”¨ Databend Kafka Connect æž„å»ºå®žæ—¶æ•°æ®æµåŒæ­¥]]></title>
    <url>%2F2024%2F07%2F25%2F%E5%9C%A8-Confluent-Cloud-%E4%B8%8A%E4%BD%BF%E7%94%A8-Databend-Kafka-Connect-%E6%9E%84%E5%BB%BA%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E6%B5%81%E5%90%8C%E6%AD%A5%2F</url>
    <content type="text"><![CDATA[Confluent CloudConfluent Cloud æ˜¯ç”± Confluent å…¬å¸æä¾›çš„äº‘æœåŠ¡ï¼Œå®ƒæ˜¯åŸºäºŽ Apache Kafka çš„ä¼ä¸šçº§äº‹ä»¶æµå¹³å°ï¼Œå…è®¸ç”¨æˆ·è½»æ¾æž„å»ºå’Œç®¡ç†åˆ†å¸ƒå¼æµå¤„ç†åº”ç”¨ã€‚Confluent ç”± Apache Kafka çš„åŽŸå§‹åˆ›å»ºè€…åˆ›ç«‹ï¼Œä¸“æ³¨äºŽæä¾›å›´ç»• Kafka æŠ€æœ¯çš„äº§å“å’ŒæœåŠ¡ ã€‚ Confluent Cloud æä¾›çš„ä¸»è¦ä¼˜åŠ¿åŒ…æ‹¬ç®€åŒ–çš„éƒ¨ç½²å’Œç®¡ç†ï¼Œé«˜å¯ç”¨æ€§ï¼Œä»¥åŠè‡ªåŠ¨æ‰©å±•èƒ½åŠ›ã€‚å®ƒæ˜¯ä¸€ä¸ªäº‘ç«¯æ‰˜ç®¡æœåŠ¡ï¼Œæ˜¯ Confluent Enterprise çš„äº‘ç«¯ç‰ˆæœ¬ï¼Œå¢žåŠ äº†äº‘ç«¯ç®¡ç†æŽ§åˆ¶å°çš„ç»„ä»¶ï¼Œä½¿å¾—ç”¨æˆ·æ— éœ€æ‹…å¿ƒåº•å±‚åŸºç¡€è®¾æ–½çš„ç»´æŠ¤å’Œæ‰©å±•é—®é¢˜ï¼Œå¯ä»¥æ›´ä¸“æ³¨äºŽä¸šåŠ¡é€»è¾‘çš„å®žçŽ° ã€‚ Confluent Cloud ä¸Žå…¶ä»– Confluent äº§å“ä¸€æ ·ï¼Œæä¾›äº†ä¸€ç³»åˆ—çš„å·¥å…·å’ŒæœåŠ¡ï¼Œä¾‹å¦‚ Kafka Connect ç”¨äºŽè¿žæŽ¥å¤–éƒ¨ç³»ç»Ÿï¼ŒSchema Registry ç”¨äºŽç®¡ç†æ•°æ®æ ¼å¼çš„å˜æ›´ï¼Œä»¥åŠ KSQL ç”¨äºŽæµå¤„ç†æŸ¥è¯¢ç­‰ã€‚è¿™äº›å·¥å…·å’ŒæœåŠ¡å¸®åŠ©ç”¨æˆ·æž„å»ºç»Ÿä¸€è€Œçµæ´»çš„æ•°æ®æµå¹³å°ï¼Œå®žçŽ°æ•°æ®çš„å®žæ—¶å¤„ç†å’Œåˆ†æž ã€‚ æ­¤å¤–ï¼ŒConfluent Cloud è¿˜æä¾›äº†ä¸åŒå±‚çº§çš„æœåŠ¡ï¼Œæ ¹æ®å¯ç”¨æ€§ã€å®‰å…¨ç­‰ä¼ä¸šç‰¹æ€§åˆ†ä¸º Basicã€Standard å’Œ Dedicated ä¸‰ä¸ªç‰ˆæœ¬ï¼Œæ”¯æŒæŒ‰éœ€åˆ›å»ºèµ„æºï¼Œå¹¶ä¸”æŒ‰é‡æ”¶è´¹ï¼Œä¸ºç”¨æˆ·æä¾›äº†çµæ´»çš„ä»˜è´¹é€‰é¡¹ã€‚ Databend Kafka ConnectDatabend æä¾›äº† Databend-Kafka-Connect ä½œä¸º Apache Kafka çš„ Sink connectorï¼Œç›´æŽ¥æŽ¥å…¥åˆ° Confluent Cloud å¹³å°ï¼Œå°±å¯ä»¥å®žæ—¶æ¶ˆè´¹ kafka topic ä¸­çš„æ•°æ®å¹¶å†™å…¥ Databend tableã€‚ Databend kafka connect æä¾›äº†è¯¸å¤šç‰¹æ€§ï¼Œä¾‹å¦‚è‡ªåŠ¨å»ºè¡¨ï¼ŒAppend Only å’Œ Upsert å†™å…¥æ¨¡å¼ï¼Œè‡ªåŠ¨çš„ schema evolutionã€‚ è¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†ä¼šä»‹ç»å¦‚ä½•åœ¨ Confluent Cloud ä¸Šä½¿ç”¨ Databend Kafka Connector æž„å»ºå®žæ—¶çš„æ•°æ®åŒæ­¥ç®¡é“ã€‚ å®žçŽ°åˆ›å»ºè‡ªå®šä¹‰ connectorConfluent æä¾›äº†ä¸€ä¸ª connector hubï¼Œåœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°æ‰€æœ‰å·²ç»å†…ç½®åˆ° Confluent Cloud ä¸­çš„ Connectorã€‚å¯¹äºŽæ²¡æœ‰å†…ç½®çš„ï¼ŒConfluent æ”¯æŒåˆ›å»ºè‡ªå®šä¹‰ connectorã€‚ Add plugin é…ç½® plugin å¡«å†™ connector çš„åç§°ã€æè¿°ä»¥åŠå…¥å£ classï¼Œåœ¨è¿™é‡Œ databend connect çš„å…¥å£ç±»æ˜¯ï¼šcom.databend.kafka.connect.DatabendSinkConnectorã€‚ git clone https://github.com/databendcloud/databend-kafka-connect.git ä¸‹è½½æºç ç¼–è¯‘æˆ–è€…ç›´æŽ¥åˆ° release é¡µé¢ä¸‹è½½æ‰“åŒ…å¥½çš„ jar æ–‡ä»¶ã€‚å°†å…¶ä¸Šä¼ è‡³ Confluent Cloudã€‚ åˆ›å»º Topicåˆ›å»ºä¸€ä¸ªæ–°çš„ kafka topic ä¸ºæ–°åˆ›å»ºçš„ topic å®šä¹‰ä¸€ä¸ª schema ä»¥ç¡®å®šå…¶æ•°æ®ç»“æž„ã€‚è¿™é‡Œæˆ‘ä»¬ç¡®å®š kafka topic ä¸­çš„æ•°æ®æ ¼å¼ä¸º AVROï¼Œå…¶ schema ä¸ºï¼š12345678910111213141516171819202122&#123; &quot;doc&quot;: &quot;Sample schema to help you get started.&quot;, &quot;fields&quot;: [ &#123; &quot;doc&quot;: &quot;The int type is a 32-bit signed integer.&quot;, &quot;name&quot;: &quot;id&quot;, &quot;type&quot;: &quot;int&quot; &#125;, &#123; &quot;doc&quot;: &quot;The string is a unicode character sequence.&quot;, &quot;name&quot;: &quot;name&quot;, &quot;type&quot;: &quot;string&quot; &#125;, &#123; &quot;doc&quot;: &quot;The string is a unicode character sequence.&quot;, &quot;name&quot;: &quot;age&quot;, &quot;type&quot;: &quot;int&quot; &#125; ], &quot;name&quot;: &quot;sampleRecord&quot;, &quot;type&quot;: &quot;record&quot;&#125; Add connector for topicä¸ºåˆšåˆ›å»ºçš„ topic æ·»åŠ ä¸€ä¸ª sink connector é€‰æ‹©ä¸Šé¢æˆ‘ä»¬è‡ªå®šä¹‰çš„ databend connector å¹¶é…ç½® API key å’Œ secretã€‚ æ·»åŠ  databend connector çš„é…ç½®æ–‡ä»¶ 123456789101112131415161718192021&#123; &quot;auto.create&quot;: &quot;true&quot;, &quot;auto.evolve&quot;: &quot;true&quot;, &quot;batch.size&quot;: &quot;1&quot;, &quot;confluent.custom.schema.registry.auto&quot;: &quot;true&quot;, &quot;connection.attempts&quot;: &quot;5&quot;, &quot;connection.backoff.ms&quot;: &quot;10000&quot;, &quot;connection.database&quot;: &quot;testsync&quot;, &quot;connection.password&quot;: &quot;password&quot;, &quot;connection.url&quot;: &quot;jdbc:databend://tn3ftqihs--medium-p8at.gw.aws-us-east-2.default.databend.com:443?ssl=true&quot;, &quot;connection.user&quot;: &quot;cloudapp&quot;, &quot;errors.tolerance&quot;: &quot;all&quot;, &quot;insert.mode&quot;: &quot;upsert&quot;, &quot;key.converter&quot;: &quot;org.apache.kafka.connect.storage.StringConverter&quot;, &quot;max.retries&quot;: &quot;10&quot;, &quot;pk.fields&quot;: &quot;id&quot;, &quot;pk.mode&quot;: &quot;record_value&quot;, &quot;table.name.format&quot;: &quot;testsync.$&#123;topic&#125;&quot;, &quot;topics&quot;: &quot;topic_avrob&quot;, &quot;value.converter&quot;: &quot;io.confluent.connect.avro.AvroConverter&quot;&#125; é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šäº†ç›®æ ‡ç«¯çš„è¿žæŽ¥å‚æ•°ï¼Œæ•°æ®åº“åï¼Œè¡¨åï¼Œkafka ç›¸å…³ä¿¡æ¯ä»¥åŠ connector converter ã€‚key.converter å’Œ value.converter å°±æ˜¯æŒ‡å®šçš„è½¬æ¢å™¨ï¼Œåˆ†åˆ«æŒ‡å®šäº†æ¶ˆæ¯é”®å’Œæ¶ˆæ¯å€¼æ‰€ä½¿ç”¨çš„çš„è½¬æ¢å™¨ï¼Œç”¨äºŽåœ¨ Kafka Connect æ ¼å¼å’Œå†™å…¥ Kafka çš„åºåˆ—åŒ–æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚è¿™æŽ§åˆ¶äº†å†™å…¥ Kafka æˆ–ä»Ž Kafka è¯»å–çš„æ¶ˆæ¯ä¸­é”®å’Œå€¼çš„æ ¼å¼ã€‚ç”±äºŽè¿™ä¸Ž Connector æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå› æ­¤ä»»ä½• Connector å¯ä»¥ä¸Žä»»ä½•åºåˆ—åŒ–æ ¼å¼ä¸€èµ·ä½¿ç”¨ã€‚é»˜è®¤ä½¿ç”¨ Kafka æä¾›çš„ JSONConverterã€‚æœ‰äº›è½¬æ¢å™¨è¿˜åŒ…å«äº†ç‰¹å®šçš„é…ç½®å‚æ•°ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡å°† key.converter.schemas.enable è®¾ç½®æˆ true æˆ–è€… false æ¥æŒ‡å®š JSON æ¶ˆæ¯æ˜¯å¦åŒ…å« schemaã€‚ é…ç½®ç½‘ç»œç™½åå•å°†æ•°æ®å†™å…¥çš„ç›®æ ‡ç«¯çš„ host å¡«å…¥ confluent cloud çš„ connection endpoint é…ç½®ï¼Œconfluent ä¼šåœ¨ kafka å’Œç›®æ ‡ç«¯ä¹‹é—´å»ºç«‹ private link ä»¥ç¡®ä¿ç½‘ç»œé€šç•…ã€‚ ç¡®è®¤é…ç½®å¹¶å¯åŠ¨ kafka connector å‘ topic ä¸­å‘é€æ ·ä¾‹æ•°æ® ç¡®è®¤ kafka connect å¤„äºŽ running çŠ¶æ€åŽï¼Œ æˆ‘ä»¬ä½¿ç”¨ confluent CLI å·¥å…·å¾€ topic ä¸­å‘é€æ•°æ®ï¼š 1confluent kafka topic produce topic_avrob --value-format avro --schema schema.json å…¶ä¸­ schema.json å°±æ˜¯æˆ‘ä»¬ä¸º topic å®šä¹‰çš„ schemaã€‚ é€šè¿‡ confluent cloud çš„æ—¥å¿—æˆ‘ä»¬å¯ä»¥çœ‹åˆ° kafka connect å·²ç»æŽ¥æ”¶åˆ°æ¥è‡ª topic çš„æ¶ˆæ¯å¹¶å¼€å§‹å†™å…¥ databend tableï¼š åŒæ—¶æˆ‘ä»¬åœ¨ databend cloud ä¸­å¯ä»¥çœ‹åˆ° testsync.topic_avrob è¡¨å·²ç»è¢«è‡ªåŠ¨åˆ›å»ºä¸”æ•°æ®å·²å†™å…¥ï¼š æ€»ç»“é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨ Confluent Cloud ä¸Ž Databend Cloud ä¹‹é—´ï¼Œä½¿ç”¨ Databend Kafka Connector æž„å»ºèµ·äºŒè€…ä¹‹é—´çš„å®žæ—¶æ•°æ®åŒæ­¥ç®¡é“ã€‚]]></content>
      <categories>
        <category>databend</category>
      </categories>
      <tags>
        <tag>kafka connect</tag>
        <tag>databend</tag>
        <tag>confluent</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Lambda-Goï¼šå°†å‡½æ•°å¼ç¼–ç¨‹å¼•å…¥ Go]]></title>
    <url>%2F2024%2F07%2F23%2FLambda-Go%EF%BC%9A%E5%B0%86%E5%87%BD%E6%95%B0%E5%BC%8F%E7%BC%96%E7%A8%8B%E5%BC%95%E5%85%A5-Go%2F</url>
    <content type="text"><![CDATA[è¿‘å¹´æ¥ï¼Œå‡½æ•°å¼ç¼–ç¨‹è¶Šæ¥è¶Šå—åˆ°é‡è§†ï¼Œç”šè‡³åœ¨ä¼ ç»Ÿä¸Šä¸Žå‘½ä»¤å¼æˆ–é¢å‘å¯¹è±¡èŒƒå¼ç›¸å…³çš„è¯­è¨€ä¸­ä¹Ÿä¸ä¾‹å¤–ã€‚ä»¥ç®€å•é«˜æ•ˆè‘—ç§°çš„ Go ä¹Ÿä¸ä¾‹å¤–ã€‚Lambda-Go æ˜¯ä¸€ä¸ªæ—¨åœ¨å°†å— Haskell å¯å‘çš„å‡½æ•°å¼ç¼–ç¨‹æŠ€æœ¯å¼•å…¥ Go ç”Ÿæ€ç³»ç»Ÿçš„åº“ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æŽ¢è®¨ Lambda-Go çš„åŠŸèƒ½ï¼Œä»¥åŠå®ƒå¦‚ä½•å¢žå¼ºä½ çš„ Go ç¼–ç¨‹ä½“éªŒã€‚ Lambda-Go ç®€ä»‹Lambda-Go æ˜¯ä¸€ä¸ª Go åº“ï¼Œå®ƒé€šè¿‡å‡½æ•°å¼ç¼–ç¨‹ç»“æž„æ‰©å±•äº† Go è¯­è¨€çš„åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€ç³»åˆ—å·¥å…·å’Œå®žç”¨ç¨‹åºï¼Œå…è®¸å¼€å‘äººå‘˜ç¼–å†™æ›´å…·è¡¨çŽ°åŠ›å’Œæ›´ç®€æ´çš„ä»£ç ï¼ŒåŒæ—¶è¿˜èƒ½åˆ©ç”¨ Go å¼ºå¤§çš„ç±»åž‹å’Œæ€§èƒ½ä¼˜åŠ¿ã€‚è¯¥åº“ä»Ž Haskell ä¸­æ±²å–çµæ„Ÿï¼ŒHaskell æ˜¯ä¸€ç§çº¯å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œä»¥å…¶ä¼˜é›…çš„è¯­æ³•å’Œå¼ºå¤§çš„æŠ½è±¡è€Œè‘—ç§°ã€‚ Lambda-Go çš„ä¸»è¦ç›®æ ‡æ˜¯ä¸º Go å¼€å‘äººå‘˜æä¾›ä¸€ç§å°†å‡½æ•°å¼ç¼–ç¨‹æŠ€æœ¯èžå…¥çŽ°æœ‰ä»£ç åº“çš„æ–¹æ³•ï¼Œè€Œæ— éœ€å®Œå…¨åˆ‡æ¢åˆ°å¦ä¸€ç§è¯­è¨€ã€‚è¿™ç§æ–¹æ³•å¯ä»¥ä½¿ä»£ç æ›´ç®€æ´ã€æ›´æ˜“ç»´æŠ¤ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤æ‚çš„æ•°æ®è½¬æ¢æˆ–é›†åˆæ“ä½œæ—¶ã€‚ Lambda-Go çš„ä¸»è¦åŠŸèƒ½Lambda-Go åˆ†æˆå‡ ä¸ªåŒ…ï¼Œæ¯ä¸ªåŒ…éƒ½ä¾§é‡äºŽå‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ä¸ªç‰¹å®šæ–¹é¢ã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£å…¶ä¸»è¦åŠŸèƒ½ï¼Œçœ‹çœ‹å¦‚ä½•åœ¨å®žè·µä¸­ä½¿ç”¨å®ƒä»¬ã€‚ æ ¸å¿ƒåŠŸèƒ½ç»“æž„æ ¸å¿ƒè½¯ä»¶åŒ…å®žçŽ°äº†åŸºæœ¬çš„å‡½æ•°å¼ç¼–ç¨‹æ“ä½œï¼Œå¦‚ Mapã€Foldl å’Œ Foldrã€‚è¿™äº›å‡½æ•°æ˜¯è®¸å¤šå‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼çš„åŸºçŸ³ã€‚ MapMap å‡½æ•°å¯¹ç‰‡æ®µä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ç»™å®šçš„å‡½æ•°ï¼Œè¿”å›žä¸€ä¸ªåŒ…å«è½¬æ¢åŽå…ƒç´ çš„æ–°ç‰‡æ®µã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Map å°†ç‰‡æ®µä¸­æ¯ä¸ªæ•°å­—åŠ å€çš„ç¤ºä¾‹ï¼š123456789101112package mainimport ( &quot;fmt&quot; &quot;github.com/araujo88/lambda-go/pkg/core&quot;)func main() &#123; numbers := []int&#123;1, 2, 3, 4, 5&#125; doubled := core.Map(numbers, func(x int) int &#123; return x * 2 &#125;) fmt.Println(doubled) // Output: [2 4 6 8 10]&#125; Foldl and FoldrFoldl å’Œ Foldr æ˜¯ä¸¤ä¸ªåŠŸèƒ½å¼ºå¤§çš„å‡½æ•°ï¼Œé€šè¿‡å¯¹æ¯ä¸ªå…ƒç´ åº”ç”¨ä¸€ä¸ªå‡½æ•°å’Œä¸€ä¸ªç´¯åŠ å™¨ï¼Œå¯ä»¥å°†åˆ‡ç‰‡è¿˜åŽŸä¸ºä¸€ä¸ªå•ä¸€å€¼ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„åŒºåˆ«åœ¨äºŽå®ƒä»¬éåŽ†åˆ‡ç‰‡çš„æ–¹å‘ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Foldl æ±‚æ•´æ•°ç‰‡æ®µæ€»å’Œçš„ç¤ºä¾‹ï¼š 123456789101112package mainimport ( &quot;fmt&quot; &quot;github.com/araujo88/lambda-go/pkg/core&quot;)func main() &#123; numbers := []int&#123;1, 2, 3, 4, 5&#125; sum := core.Foldl(func(acc, x int) int &#123; return acc + x &#125;, 0, numbers) fmt.Println(sum) // Output: 15&#125; æ”¯æŒå…ƒç»„tuple åŒ…æä¾›äº†ä¸€ç§é€šç”¨çš„ tuple æ•°æ®ç»“æž„ï¼Œå¯ç”¨äºŽå¤„ç†æˆå¯¹æ•°æ®ã€‚å½“ä½ éœ€è¦ä»Žå‡½æ•°ä¸­è¿”å›žå¤šä¸ªå€¼æˆ–å°†ç›¸å…³æ•°æ®åˆ†ç»„æ—¶ï¼Œè¿™å°¤å…¶æ–¹ä¾¿ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ Zip å‡½æ•°å°†ä¸¤ä¸ªç‰‡æ®µåˆå¹¶ä¸ºä¸€ä¸ªå…ƒç»„ç‰‡æ®µçš„ç¤ºä¾‹ï¼š12345678910111213141516package mainimport ( &quot;fmt&quot; &quot;github.com/araujo88/lambda-go/pkg/tuple&quot;)func main() &#123; names := []string&#123;&quot;Alice&quot;, &quot;Bob&quot;, &quot;Charlie&quot;&#125; ages := []int&#123;25, 30, 35&#125; pairs := tuple.Zip(names, ages) for _, pair := range pairs &#123; fmt.Printf(&quot;%s is %d years old\n&quot;, pair.First, pair.Second) &#125;&#125; utilsutils åŒ…æä¾›äº†ä¸€ç³»åˆ—ç”¨äºŽå¤„ç†åˆ‡ç‰‡çš„å®žç”¨ç¨‹åºã€‚è¿™äº›å‡½æ•°åŒ…æ‹¬åå‘ã€å¹¶é›†å’Œ Unique ç­‰æ“ä½œã€‚è®©æˆ‘ä»¬æ¥çœ‹å‡ ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021package mainimport ( &quot;fmt&quot; &quot;github.com/araujo88/lambda-go/pkg/utils&quot;)func main() &#123; slice1 := []int&#123;1, 2, 3&#125; slice2 := []int&#123;4, 5, 6&#125; reversed := utils.Reverse(slice1) fmt.Println(reversed) // Output: [3 2 1] concatenated := utils.Concat(slice1, slice2) fmt.Println(concatenated) // Output: [1 2 3 4 5 6] withDuplicates := []int&#123;1, 2, 2, 3, 3, 3, 4&#125; unique := utils.Unique(withDuplicates) fmt.Println(unique) // Output: [1 2 3 4]&#125; Predicate Functionsè°“è¯åŒ…åŒ…æ‹¬è¿‡æ»¤ã€ä»»æ„ã€å…¨éƒ¨å’ŒæŸ¥æ‰¾ç­‰å‡½æ•°ã€‚è°“è¯æ˜¯æ ¹æ®æŸäº›æ¡ä»¶è¿”å›žå¸ƒå°”å€¼çš„å‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ â€œè¿‡æ»¤å™¨ â€œå’Œ â€œä»»æ„ â€œçš„ç¤ºä¾‹ï¼š 12345678910111213141516package mainimport ( &quot;fmt&quot; &quot;github.com/araujo88/lambda-go/pkg/predicate&quot;)func main() &#123; numbers := []int&#123;1, 2, 3, 4, 5, 6, 7, 8, 9, 10&#125; evens := predicate.Filter(numbers, func(x int) bool &#123; return x%2 == 0 &#125;) fmt.Println(evens) // Output: [2 4 6 8 10] hasNegative := predicate.Any(numbers, func(x int) bool &#123; return x &lt; 0 &#125;) fmt.Println(hasNegative) // Output: false&#125; Sorting and Groupingsortgroup è½¯ä»¶åŒ…æä¾›äº†æ ¹æ®æŒ‡å®šæ¡ä»¶å¯¹åˆ‡ç‰‡è¿›è¡ŒæŽ’åºå’Œå¯¹å…ƒç´ è¿›è¡Œåˆ†ç»„çš„å‡½æ•°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ groupBy å‡½æ•°çš„ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324package mainimport ( &quot;fmt&quot; &quot;github.com/araujo88/lambda-go/pkg/sortgroup&quot;)func main() &#123; people := []struct &#123; Name string Age int &#125;&#123; &#123;&quot;Alice&quot;, 25&#125;, &#123;&quot;Bob&quot;, 30&#125;, &#123;&quot;Charlie&quot;, 25&#125;, &#123;&quot;David&quot;, 30&#125;, &#125; grouped := sortgroup.groupBy(people, func(p struct&#123; Name string; Age int &#125;) int &#123; return p.Age &#125;) for age, group := range grouped &#123; fmt.Printf(&quot;Age %d: %v\n&quot;, age, group) &#125;&#125; ä½¿ç”¨ Lambda-Go çš„å¥½å¤„1.æé«˜ä»£ç å¯è¯»æ€§ï¼šå‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼é€šå¸¸ä½¿ä»£ç æ›´å…·å£°æ˜Žæ€§ï¼Œæ›´æ˜“äºŽç†è§£ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†å¤æ‚çš„æ•°æ®è½¬æ¢æ—¶ã€‚ 2.å‡å°‘å‰¯ä½œç”¨ï¼šé€šè¿‡é¼“åŠ±ä¸å˜æ€§å’Œçº¯å‡½æ•°ï¼ŒLambda-Go å¯ä»¥å¸®åŠ©å‡å°‘æ„å¤–å‰¯ä½œç”¨å¯¼è‡´çš„é”™è¯¯ã€‚ 3.æ›´å¥½çš„æŠ½è±¡ï¼šç¨‹åºåº“æä¾›é«˜çº§æŠ½è±¡ï¼Œå¯ç®€åŒ–å¸¸è§çš„ç¼–ç¨‹ä»»åŠ¡ï¼Œä½¿ä»£ç æ›´å…·è¡¨çŽ°åŠ›ã€‚ 4.FP çˆ±å¥½è€…ç†Ÿæ‚‰çš„æ¦‚å¿µï¼šç†Ÿæ‚‰å…¶ä»–è¯­è¨€ä¸­å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µçš„å¼€å‘äººå‘˜ä¼šå‘çŽ°åœ¨ Go é¡¹ç›®ä¸­æ›´å®¹æ˜“åº”ç”¨ä»–ä»¬çš„çŸ¥è¯†ã€‚ 5.é€æ­¥é‡‡ç”¨ï¼šæ‚¨å¯ä»¥åœ¨çŽ°æœ‰çš„ Go ä»£ç åº“ä¸­é€æ­¥å¼•å…¥å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µï¼Œè€Œæ— éœ€å®Œå…¨é‡å†™ã€‚ æŒ‘æˆ˜å’Œéœ€è¦è€ƒè™‘çš„å› ç´ è™½ç„¶ Lambda-Go å¸¦æ¥äº†è®¸å¤šå¥½å¤„ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›æŒ‘æˆ˜éœ€è¦è€ƒè™‘ï¼š1.æ€§èƒ½å¼€é”€ï¼šä¸Žå‘½ä»¤å¼ Go ä»£ç ç›¸æ¯”ï¼ŒæŸäº›å‡½æ•°å¼ç¼–ç¨‹æ¨¡å¼å¯èƒ½ä¼šå¸¦æ¥è½»å¾®çš„æ€§èƒ½å¼€é”€ã€‚é‡è¦çš„æ˜¯è¦å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œå‰–æžï¼Œå¹¶è°¨æ…Žä½¿ç”¨è¿™äº›æŠ€æœ¯ã€‚ 2.å­¦ä¹ æ›²çº¿ï¼šä¸ç†Ÿæ‚‰å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µçš„å¼€å‘äººå‘˜å¯èƒ½éœ€è¦ä¸€äº›æ—¶é—´æ¥é€‚åº”å’Œå­¦ä¹ å¦‚ä½•æœ‰æ•ˆåœ°ä½¿ç”¨è¯¥åº“ã€‚ 3.ä¸ŽçŽ°æœ‰ä»£ç é›†æˆï¼šè™½ç„¶å¯ä»¥é€æ­¥é‡‡ç”¨ Lambda-Goï¼Œä½†å¯èƒ½éœ€è¦é‡æž„ä¸€äº›çŽ°æœ‰ä»£ç ï¼Œä»¥å……åˆ†å‘æŒ¥å…¶ä¼˜åŠ¿ã€‚ ç»“è®ºLambda-Go ä¸ºå°†å‡½æ•°å¼ç¼–ç¨‹æŠ€æœ¯å¼•å…¥ Go ç”Ÿæ€ç³»ç»Ÿæä¾›äº†ä¸€ä¸ªä»¤äººå…´å¥‹çš„æœºä¼šã€‚é€šè¿‡æä¾›ä¸€å¥—å— Haskell å¯å‘çš„å·¥å…·ï¼Œå®ƒå…è®¸å¼€å‘äººå‘˜ç¼–å†™æ›´å…·è¡¨çŽ°åŠ›ã€å¯ç»´æŠ¤æ€§å’Œæ½œåœ¨å®‰å…¨æ€§çš„ä»£ç ï¼ŒåŒæ—¶è¿˜èƒ½å……åˆ†åˆ©ç”¨ Go çš„ä¼˜åŠ¿ã€‚ ä¸Žä»»ä½•æ–°å·¥å…·æˆ–èŒƒä¾‹ä¸€æ ·ï¼Œè¯„ä¼° Lambda-Go æ˜¯å¦é€‚åˆæ‚¨çš„é¡¹ç›®éœ€æ±‚å’Œå›¢é˜ŸæŠ€èƒ½éžå¸¸é‡è¦ã€‚ä¸è¿‡ï¼Œå¯¹äºŽå¸Œæœ›å°†å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µèžå…¥ Go é¡¹ç›®çš„å›¢é˜Ÿæ¥è¯´ï¼ŒLambda-Go æä¾›äº†ä¸€ä¸ªåšå®žçš„åŸºç¡€ï¼Œå¹¶æ¸è¿›å¼åœ°ä»‹ç»äº†è¿™äº›å¼ºå¤§çš„æŠ€æœ¯ã€‚ æ— è®ºä½ æ˜¯ä¸€ä½ç»éªŒä¸°å¯Œçš„å‡½æ•°å¼ç¨‹åºå‘˜ï¼Œè¿˜æ˜¯ä¸€ä½å¯¹å‡½æ•°å¼ç¼–ç¨‹å……æ»¡å¥½å¥‡çš„ Go å¼€å‘äººå‘˜ï¼ŒLambda-Go éƒ½å°†ä¸ºæ‚¨æä¾›ä¸€åº§è¿žæŽ¥è¿™ä¸¤ä¸ªä¸–ç•Œçš„æ¡¥æ¢ã€‚é€šè¿‡æŽ¢ç´¢å’Œé‡‡ç”¨å…¶åŠŸèƒ½ï¼Œå¼€å‘è€…è‡ªèº«å¯ä»¥å¢žå¼º Go ç¼–ç¨‹å·¥å…·åŒ…ï¼Œå¹¶æœ‰å¯èƒ½å‘çŽ°è§£å†³å¤æ‚é—®é¢˜çš„æ–°é¢–ã€ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æž„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part 2]]></title>
    <url>%2F2024%2F07%2F15%2F%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C-eBPF-%E5%BA%94%E7%94%A8-Part-2%2F</url>
    <content type="text"><![CDATA[åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç”¨ C è¯­è¨€åˆ›å»ºäº†ä¸€ä¸ª eBPF ç¨‹åºï¼Œä»¥äº†è§£æŸä¸ªè¿›ç¨‹ä½¿ç”¨ CPU çš„æ—¶é—´ã€‚è¿™äº›æ•°æ®éšåŽè¢«å­˜å‚¨åœ¨ BPF HashMap ä¸­ã€‚ä½†è¿™æ˜¯ä¸€ä¸ªä¸æ–­æ›´æ–°çš„çŸ­æœŸå­˜å‚¨ä½ç½®ï¼Œæ•°æ®çš„å¯¿å‘½å¾ˆçŸ­â€¦â€¦æˆ‘ä»¬è¯¥å¦‚ä½•åˆ©ç”¨è¿™äº›æ•°æ®å‘¢ï¼Ÿ è¿™å°±æ˜¯ç”¨æˆ·ç©ºé—´ç¨‹åºçš„ç”¨æ­¦ä¹‹åœ°ã€‚ç”¨æˆ·ç©ºé—´ç¨‹åºä¸åœ¨å†…æ ¸ç©ºé—´è¿è¡Œï¼Œä½†å¯ä»¥é™„åŠ åˆ° eBPF ç¨‹åºå¹¶è®¿é—® BPF HashMapã€‚ çŽ°åœ¨è®©æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•ç”¨ Golang ç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åºã€‚ Bpf2goåœ¨ä½¿ç”¨ Golang æ—¶ï¼Œæœ‰ä¸€ä¸ªå¾ˆå¥½ç”¨çš„å·¥å…·å«åš bpf2goã€‚è¿™ä¸ªå·¥å…·å¯ä»¥å¸®åŠ©æˆ‘ä»¬å°†ä¹‹å‰ç¼–å†™çš„ C ä»£ç ç¼–è¯‘æˆ eBPF å­—èŠ‚ç ã€‚æ­¤å¤–ï¼Œå®ƒè¿˜èƒ½åˆ›å»º Golang å‡½æ•°å’Œç»“æž„çš„éª¨æž¶ï¼Œä»¥ä¾¿æˆ‘ä»¬å°†å…¶æŽ¥å£åˆ°ä»£ç ä¸­ï¼Œä»Žè€ŒèŠ‚çœå¤§é‡æ—¶é—´ã€‚ Step 1: åˆ›å»º gen.go æ–‡ä»¶12package main//go:generate go run github.com/cilium/ebpf/cmd/bpf2go processtime processtime.c gen.go æ–‡ä»¶ä¸­çš„æ³¨é‡Šè¡Œå…è®¸æˆ‘ä»¬è¿è¡Œ go ç”Ÿæˆï¼Œç„¶åŽä½¿ç”¨ bpf2go å·¥å…·è¯»å– C ç¨‹åºï¼ˆåœ¨æœ¬ä¾‹ä¸­ï¼Œç¬¬äºŒä¸ªæ ‡å¿—æ˜¯ processtime.cï¼‰ï¼Œå¹¶è¾“å‡ºç”Ÿæˆçš„ Golang ä»£ç ï¼Œè¿™äº›ä»£ç å°†ä½¿ç”¨å‰ç¼€ processtimeï¼ˆç¬¬ä¸€ä¸ªæ ‡å¿—ï¼‰ã€‚è¿è¡Œ go ç”ŸæˆåŽï¼Œä½ å°†å¾—åˆ°ä»¥ä¸‹æ–‡ä»¶ï¼š 12345678$ tree.|____gen.go|____processtime.c|____processtime_bpfel.o|____processtime_bpfeb.o|____processtime_bpfel.go|____processtime_bpfeb.go è¿™é‡Œç”Ÿæˆäº†å››ä¸ªæ–‡ä»¶ã€‚å¯¹è±¡æ–‡ä»¶ï¼ˆä»¥ .o ç»“å°¾çš„æ–‡ä»¶ï¼‰æ˜¯å°†åŠ è½½åˆ°å†…æ ¸ä¸­çš„ eBPF å­—èŠ‚ç ã€‚ä»¥ Golang ext ç»“å°¾çš„ .go æ–‡ä»¶æ˜¯åˆ›å»ºæ‰€æœ‰ç”¨æˆ·ç©ºé—´æŽ¥å£çš„æ–‡ä»¶ã€‚ æ‰“å¼€è¿™ä¸¤ä¸ª Golang æ–‡ä»¶ï¼Œä½ è¿˜ä¼šå‘çŽ°æ¯ä¸ªæ–‡ä»¶çš„é¡¶éƒ¨éƒ½æœ‰ä¸€ä¸ªæ³¨é‡Šï¼Œè¯´æ˜Žè¯¥æ–‡ä»¶é€‚ç”¨äºŽå“ªç§ CPU æž¶æž„ã€‚ä¾‹å¦‚ï¼Œprocesstime_bpfeb.go çš„æ³¨é‡Šå¦‚ä¸‹ï¼š12// Code generated by bpf2go; DO NOT EDIT.//go:build arm64be || armbe || mips || mips64 || mips64p32 || ppc64 || s390 || s390x || sparc || sparc64 processtime_bpfel.go æœ‰ä¸åŒçš„æž¶æž„ï¼šè¿™æ˜¯å› ä¸ºï¼Œåœ¨å¤„ç†å†…æ ¸æ—¶ï¼Œç¨‹åºçš„ç¼–è¯‘æ–¹å¼åœ¨æ¯ç§æž¶æž„ä¸Šéƒ½æœ‰ç»†å¾®å·®åˆ«ã€‚ æ­¥éª¤ 2ï¼šç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åºæˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨ eBPF ç¨‹åºäº†ã€‚æˆ‘ä»¬å°†åœ¨æ ¹ç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª main.goï¼Œå¹¶é¦–å…ˆå–æ¶ˆèµ„æºé™åˆ¶ï¼š1234// Remove resource limits for kernels &lt;5.11.if err := rlimit.RemoveMemlock(); err != nil &#123; log.Fatal(&quot;Removing memlock:&quot;, err)&#125; è¿™æ˜¯å› ä¸ºå†…æ ¸ v5.11 å‘ç”Ÿäº†å˜åŒ–ï¼ŒBPF è¿›ç¨‹çš„å¯ç”¨å†…å­˜è¿‡åŽ»å— RLIMIT_MEMLOCK é™åˆ¶ï¼Œä½†è¿™ä¸€é€»è¾‘å·²ç§»è‡³å†…å­˜ cgroup (memcg)ã€‚ ä¸‹ä¸€æ­¥æ˜¯åŠ è½½ eBPF ç¨‹åºã€‚è¿™æ˜¯é€šè¿‡ bpf2go å·¥å…·ç”Ÿæˆçš„æŽ¥å£ä»£ç ä¸­çš„ä¸€ä¸ªåä¸º loadProcesstimeObject çš„å‡½æ•°å®Œæˆçš„ã€‚æˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªå˜é‡æ¥å­˜å‚¨è¯¥å‡½æ•°è°ƒç”¨çš„è¾“å‡ºã€‚ 123456// Load the compiled eBPF ELF into the kernel.var objs processtimeObjectsif err := loadProcesstimeObjects(&amp;objs, nil); err != nil &#123; log.Fatal(&quot;Loading eBPF objects:&quot;, err)&#125;defer objs.Close() æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦è¿žæŽ¥åˆ°å·²åŠ è½½çš„ç¨‹åºã€‚è¿™å°±éœ€è¦çŸ¥é“ä½ æŒ‚æŽ¥çš„æ˜¯ä»€ä¹ˆäº‹ä»¶ï¼Œå› ä¸ºä½ éœ€è¦æŒ‡å®šå®ƒã€‚åœ¨æˆ‘ä»¬çš„ C ç¨‹åºä¸­ï¼Œæˆ‘ä»¬æŒ‡å®šäº†ä»¥ä¸‹å†…å®¹ï¼š1SEC(&quot;tracepoint/sched/sched_switch&quot;) å› æ­¤ï¼Œæˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„ç¨‹åºæŒ‚æŽ¥åˆ°äº† sched å‘½åç©ºé—´ä¸­çš„è·Ÿè¸ªç‚¹ sched_switchã€‚è¿™å¯ä»¥è½¬åŒ–ä¸ºä»¥ä¸‹å†…å®¹ï¼š123456// link to the tracepoint program that we loaded into the kerneltp, err := link.Tracepoint(&quot;sched&quot;, &quot;sched_switch&quot;, objs.CpuProcessingTime, nil)if err != nil &#123; log.Fatalf(&quot;opening kprobe: %s&quot;, err)&#125;defer tp.Close() æˆ‘ä»¬éœ€è¦çš„æœ€åŽä¸€é¡¹åŠŸèƒ½æ˜¯è¯»å–å­˜å‚¨åœ¨ BPF HashMap ä¸­çš„æ•°æ®ã€‚è¿™å¯ä»¥é€šè¿‡ä½¿ç”¨ HashMap çš„é”®æ¥æŸ¥çœ‹å­˜å‚¨çš„å€¼ã€‚åœ¨ç”Ÿæˆ Golang ä»£ç æ—¶ï¼Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸¤ç§ç±»åž‹æ¥å¸®åŠ©æˆ‘ä»¬ä¸Ž BPF HashMap äº¤äº’ã€‚1234567// used as HashMap Keytype processtimeKeyT struct&#123; Pid uint32 &#125;// used as HashMap Valuetype processtimeValT struct &#123; StartTime uint64 ElapsedTime uint64&#125; è¿™ä¸Žæˆ‘ä»¬åœ¨ C ç¨‹åºä¸­ä½¿ç”¨çš„ä¸¤ç§ç±»åž‹ç›¸å…³ï¼š123456789// used as Hashmap Keystruct key_t &#123;__u32 pid;&#125;;// used as Hashmap Valuestruct val_t &#123;__u64 start_time;__u64 elapsed_time;&#125;; åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œé”®å€¼åŸºæœ¬ä¸Šå°±æ˜¯è¿›ç¨‹ IDã€‚çŽ°åœ¨ï¼Œåœ¨å¤§å¤šæ•°ç³»ç»Ÿä¸­ï¼ŒPID çš„é»˜è®¤å€¼ä»‹äºŽ 1 å’Œ 32767 ä¹‹é—´ï¼Œä½†ä½ å¯ä»¥é€šè¿‡æŸ¥çœ‹ /proc/sys/kernel/pid_max æ–‡ä»¶æ¥æŸ¥çœ‹è¯¥å€¼ã€‚ é€šè¿‡ä¸Šè¿°é€»è¾‘ï¼Œæˆ‘ä»¬åº”è¯¥å¯ä»¥éåŽ†æ‰€æœ‰æ½œåœ¨çš„ PIDï¼Œå¹¶æ£€æŸ¥ BPF HashMapï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å­˜å‚¨çš„å€¼ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒä»¬æ¥ç¼–å†™æˆ‘ä»¬çš„å¾ªçŽ¯é€»è¾‘ï¼š1234567891011var key processtimeKeyT// Iterate over all PIDs between 1 and 32767 (maximum PID on linux)// found in /proc/sys/kernel/pid_maxfor i := 1; i &lt;= 32767; i++ &#123; key.Pid = uint32(i) // Query the BPF map var mapValue processtimeValT if err := objs.ProcessTimeMap.Lookup(key, &amp;mapValue); err == nil &#123; log.Printf(&quot;CPU time for PID=%d: %dns\n&quot;, key.Pid, mapValue.ElapsedTime) &#125;&#125; è¿™æ®µä»£ç å°†å¾ªçŽ¯å¤„ç†æ¯ä¸ªå¯ç”¨çš„ PIDï¼Œå¹¶åœ¨æˆ‘ä»¬çš„ BPF HashMapï¼ˆç”± objs.ProcessTimeMap æŒ‡å®šï¼‰ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æžœæ²¡æœ‰é”™è¯¯è¿”å›žï¼Œå°†æ‰“å°å‡ºå€¼ã€‚ æ­¥éª¤ 3.å®Œæ•´ä»£ç æœ€ç»ˆä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼šï¼ˆè¯·æ³¨æ„ï¼Œæˆ‘æœ‰ä¸€ä¸ªæ¯ç§’è¿è¡Œä¸€æ¬¡å¾ªçŽ¯çš„ tickerï¼Œå› ä¸º HashMap å¯ä»¥ä¸æ–­æ›´æ–°ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦ä¸æ–­é‡æ–°è¯»å–å®ƒï¼‰ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152package mainimport ( &quot;C&quot; &quot;log&quot; &quot;time&quot; &quot;github.com/cilium/ebpf/link&quot; &quot;github.com/cilium/ebpf/rlimit&quot;)func main() &#123; // Remove resource limits for kernels &lt;5.11. if err := rlimit.RemoveMemlock(); err != nil &#123; log.Fatal(&quot;Removing memlock:&quot;, err) &#125; // Load the compiled eBPF ELF and load it into the kernel. var objs processtimeObjects if err := loadProcesstimeObjects(&amp;objs, nil); err != nil &#123; log.Fatal(&quot;Loading eBPF objects:&quot;, err) &#125; defer objs.Close() // link to the tracepoint program that we loaded into the kernel tp, err := link.Tracepoint(&quot;sched&quot;, &quot;sched_switch&quot;, objs.CpuProcessingTime, nil) if err != nil &#123; log.Fatalf(&quot;opening kprobe: %s&quot;, err) &#125; defer tp.Close() // Read loop reporting the total amount of times the kernel // function was entered, once per second. ticker := time.NewTicker(1 * time.Second) defer ticker.Stop() log.Println(&quot;Waiting for events..&quot;) for range ticker.C &#123; var key processtimeKeyT // Iterate over all PIDs between 1 and 32767 (maximum PID on linux) // found in /proc/sys/kernel/pid_max for i := 1; i &lt;= 32767; i++ &#123; key.Pid = uint32(i) // Query the BPF map var mapValue processtimeValT if err := objs.ProcessTimeMap.Lookup(key, &amp;mapValue); err == nil &#123; log.Printf(&quot;CPU time for PID=%d: %dns\n&quot;, key.Pid, mapValue.ElapsedTime) &#125; &#125; &#125;&#125; æ€»ç»“eBPF æ˜¯ä¸€é¡¹å€¼å¾—å…³æ³¨çš„æŠ€æœ¯ã€‚å®ƒåœ¨ç½‘ç»œã€å¯è§‚æµ‹æ€§å’Œå®‰å…¨æ€§æ–¹é¢èƒ½å¤Ÿå‘æŒ¥é‡è¦ä½œç”¨ã€‚äº†è§£åŸºæœ¬åŽŸç†æ˜¯ç¬¬ä¸€æ­¥ï¼Œä½†è¦æ·±å…¥ç ”ç©¶çš„ä¸œè¥¿è¿˜æœ‰å¾ˆå¤šã€‚å¯ä»¥æœŸå¾…åŽç»­çš„æ–‡ç« åˆ†äº«ðŸ‘€ã€‚]]></content>
      <categories>
        <category>eBPF</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>eBPF</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æž„å»ºå¹¶è¿è¡Œ eBPF åº”ç”¨ - Part one]]></title>
    <url>%2F2024%2F07%2F14%2F%E6%9E%84%E5%BB%BA%E5%B9%B6%E8%BF%90%E8%A1%8C-eBPF-%E5%BA%94%E7%94%A8-Part-one%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•ä½¿ç”¨ C å’Œ Golang ç¼–å†™ç¬¬ä¸€ä¸ª eBPF ç¨‹åºã€‚æˆ‘ä»¬å°†åœ¨ç¬¬ä¸€éƒ¨åˆ†ä»‹ç»å®žé™…çš„ eBPF ç¨‹åºï¼Œåœ¨ç¬¬äºŒéƒ¨åˆ†ä»‹ç»ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºã€‚ å‡†å¤‡å·¥ä½œæœ¬æ–‡è¿è¡Œçš„æ“ä½œç³»ç»Ÿæ˜¯ï¼š12OS: Ubuntu 22.04Linux Header Version: 6.5.0â€“14-generic è¿˜é€šè¿‡ apt å®‰è£…äº†ä¸€äº›ä¾èµ–é¡¹:1sudo apt-get -y install libbpf bpfcc-tools å®Œæˆ ebpf çš„ä»£ç é™¤äº†éœ€è¦ Go çš„çŸ¥è¯†ä¹‹å¤–ï¼Œè¯»è€…å¯¹ C è¯­è¨€ç¼–ç¨‹éœ€è¦ç†Ÿæ‚‰ã€‚ ä»€ä¹ˆæ˜¯ eBPFï¼Ÿæœ‰è®¸å¤šåšå®¢/ç½‘ç«™å¯¹ eBPF è¿›è¡Œäº†æ·±å…¥æŽ¢è®¨ï¼ˆè¯·æŸ¥çœ‹èµ„æºéƒ¨åˆ†ï¼‰ï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å§‘ä¸”è®¤ä¸º eBPF æ˜¯ä¸€ç§åœ¨ä¸ä¿®æ”¹å†…æ ¸æºä»£ç çš„æƒ…å†µä¸‹ä½¿ç”¨æ¨¡å—æ‰©å±• Linux å†…æ ¸çš„æ–¹æ³•ã€‚ ç¬”è€…è®¤ä¸º eBPF å°±æ˜¯æ˜¯å†…æ ¸çš„ä¸€ä¸ªé’©å­ï¼Œå…è®¸åœ¨å†…æ ¸ç©ºé—´è¿è¡Œé€»è¾‘ã€‚ User Space vs Kernel Spaceå½“æˆ‘ä»¬è°ˆè®ºå†…æ ¸ç©ºé—´æ—¶ï¼Œé€šå¸¸æŒ‡çš„æ˜¯æ“ä½œç³»ç»Ÿã€‚è¿™æ˜¯ä¸€ä¸ªç‰¹æƒåŒºåŸŸï¼Œå¯ä»¥å®Œå…¨è®¿é—®ç¡¬ä»¶å’Œè½¯ä»¶èµ„æºã€‚å½“æˆ‘ä»¬è°ˆè®ºç”¨æˆ·ç©ºé—´æ—¶ï¼Œè¿™é‡Œé€šå¸¸æ˜¯ä½ è¿è¡Œæ—¥å¸¸ç¨‹åºï¼ˆå¦‚è°·æ­Œæµè§ˆå™¨ï¼‰çš„åœ°æ–¹ã€‚ç”¨æˆ·ç©ºé—´çš„è®¿é—®æƒé™æ˜¯æœ‰é™åˆ¶çš„ã€‚ é€‰æ‹©è¦æŒ‚é’©çš„äº‹ä»¶è¿™é‡Œç»™å¤§å®¶æŽ¨èä¸€ä¸ªå­¦ä¹ ä¸Šæ‰‹å¼€å‘ eBPF çš„å¥½çš„é¡¹ç›®ï¼škeplerKepler çš„ä¸€é¡¹å·¥ä½œæ˜¯é€šè¿‡ CPU è®¡åˆ’åˆ‡æ¢ï¼Œè®¡ç®—æ¯ä¸ªè¿›ç¨‹ï¼ˆç”± PID æ ‡è¯†ï¼‰ä½¿ç”¨ CPU çš„æ—¶é—´ã€‚ CPU è°ƒåº¦æ˜¯æŒ‡åœ¨æ­£åœ¨æ‰§è¡Œçš„è¿›ç¨‹ä¹‹é—´è¿›è¡Œåˆ‡æ¢ï¼Œä»¥ä¾¿æ›´å¥½åœ°åˆ©ç”¨å¤„ç†èƒ½åŠ›ï¼ˆå½“ä¸€ä¸ªè¿›ç¨‹å—é˜»æ—¶ï¼ŒCPU ä¼šæš‚åœå¤„ç†è¯¥è¿›ç¨‹ï¼Œå¹¶åˆ‡æ¢åˆ°å¦ä¸€ä¸ªè¿›ç¨‹ï¼‰ã€‚ å› æ­¤ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³å¤åˆ¶è¿™ä¸€åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·åšï¼š çŸ¥é“æŸä¸ªè¿›ç¨‹ä½•æ—¶å°†å¼€å§‹ä½¿ç”¨ CPU çŸ¥é“æŸä¸ªè¿›ç¨‹ä½•æ—¶åœæ­¢ä½¿ç”¨ CPU è®¡ç®—è¿™ä¸¤ä¸ªæ—¶åˆ»ä¹‹é—´çš„æ—¶é—´ è¿™æ ·æˆ‘ä»¬å°±èƒ½å¤§è‡´ä¼°ç®—å‡ºæ¯ä¸ªæµç¨‹éœ€è¦å¤šå°‘æ—¶é—´ï¼ŒåŒæ—¶è¦è®°ä½ï¼Œä¸€ä¸ªæµç¨‹ä¼šè¢«å®‰æŽ’å¤šæ¬¡ã€‚ æ ¹æ®ä¸Šè¿°ä¿¡æ¯ï¼Œæˆ‘ä»¬å¸Œæœ›:1tracepoint/sched/sched_switch äº‹ä»¶ï¼Œä»¥ä¾¿åœ¨è®¡åˆ’è¿›ç¨‹æ—¶æ”¶åˆ°é€šçŸ¥ã€‚ äº†è§£ event çš„æ ¼å¼åœ¨ BPF äº‹ä»¶ä¸­ï¼Œæ¯ä¸ªäº‹ä»¶åœ¨è¿è¡Œå‡½æ•°æ—¶éƒ½ä¼šåŒ…å«ä¸€äº›ç§°ä¸º â€œä¸Šä¸‹æ–‡ â€œçš„å†…å®¹ã€‚è¿™äº›ä¸Šä¸‹æ–‡å®žè´¨ä¸Šå°±æ˜¯äº‹ä»¶å‘å‡ºçš„ä¿¡æ¯ã€‚æˆ‘ä»¬éœ€è¦å®šä¹‰ä¸€ä¸ª C ç»“æž„æ¥ä¿å­˜è¿™äº›ä¿¡æ¯ï¼Œä½†é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦èŽ·å¾—è¯¥ç»“æž„çš„æ ¼å¼ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œä¸‹é¢çš„ä»£ç æ¥å®žçŽ°ï¼š 12345678910111213141516$ sudo cat /sys/kernel/debug/tracing/events/sched/sched_switch/formatname: sched_switchID: 327format:field:unsigned short common_type; offset:0; size:2; signed:0;field:unsigned char common_flags; offset:2; size:1; signed:0;field:unsigned char common_preempt_count; offset:3; size:1; signed:0;field:int common_pid; offset:4; size:4; signed:1;field:char prev_comm[16]; offset:8; size:16; signed:0;field:pid_t prev_pid; offset:24; size:4; signed:1;field:int prev_prio; offset:28; size:4; signed:1;field:long prev_state; offset:32; size:8; signed:1;field:char next_comm[16]; offset:40; size:16; signed:0;field:pid_t next_pid; offset:56; size:4; signed:1;field:int next_prio; offset:60; size:4; signed:1;print fmt: &quot;prev_comm=%s prev_pid=%d prev_prio=%d prev_state=%s%s ==&gt; next_comm=%s next_pid=%d next_prio=%d&quot;, REC-&gt;prev_comm, REC-&gt;prev_pid, REC-&gt;prev_prio, (REC-&gt;prev_state &amp; ((((0x00000000 | 0x00000001 | 0x00000002 | 0x00000004 | 0x00000008 | 0x00000010 | 0x00000020 | 0x00000040) + 1) &lt;&lt; 1) - 1)) ? __print_flags(REC-&gt;prev_state &amp; ((((0x00000000 | 0x00000001 | 0x00000002 | 0x00000004 | 0x00000008 | 0x00000010 | 0x00000020 | 0x00000040) + 1) &lt;&lt; 1) - 1), &quot;|&quot;, &#123; 0x00000001, &quot;S&quot; &#125;, &#123; 0x00000002, &quot;D&quot; &#125;, &#123; 0x00000004, &quot;T&quot; &#125;, &#123; 0x00000008, &quot;t&quot; &#125;, &#123; 0x00000010, &quot;X&quot; &#125;, &#123; 0x00000020, &quot;Z&quot; &#125;, &#123; 0x00000040, &quot;P&quot; &#125;, &#123; 0x00000080, &quot;I&quot; &#125;) : &quot;R&quot;, REC-&gt;prev_state &amp; (((0x00000000 | 0x00000001 | 0x00000002 | 0x00000004 | 0x00000008 | 0x00000010 | 0x00000020 | 0x00000040) + 1) &lt;&lt; 1) ? &quot;+&quot; : &quot;&quot;, REC-&gt;next_comm, REC-&gt;next_pid, REC-&gt;next_prio è¦å¤„ç†çš„ä¿¡æ¯ç›¸å½“å¤šï¼Œä½†ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å¯ä»¥è¯´ï¼Œåœ¨è¿™ä¸ªç”¨ä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³å¿ƒä»»ä½•ä»¥ common_ ä¸ºå‰ç¼€çš„å­—æ®µã€‚è¿™æ ·æˆ‘ä»¬å°±æœ‰äº†ä»¥ä¸‹å­—æ®µï¼š1234567char prev_comm[16];pid_t prev_pid;int prev_prio;long prev_state;char next_comm[16];pid_t next_pid;int next_prio; ç„¶åŽæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯åˆ›å»ºä¸‹é¢çš„ C ç»“æž„ï¼š123456789struct sched_switch_args &#123; char prev_comm[16]; int prev_pid; int prev_prio; long prev_state; char next_comm[16]; int next_pid; int next_prio;&#125;; çŽ°åœ¨ï¼Œé¦–å…ˆè¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘å°† pid_t ç±»åž‹æ”¹ä¸º intã€‚è¿™æ˜¯å› ä¸º pid_t çš„åº•å±‚ç±»åž‹æ˜¯ intã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pid_t ç±»åž‹ï¼Œä½†éœ€è¦ä¾èµ– sys/types.hï¼Œè€Œåœ¨æœ¬ä¾‹ä¸­æˆ‘ä»¬å¹¶ä¸éœ€è¦ã€‚æœ‰å…³è¿™æ–¹é¢çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥é˜…è¯»è¿™ç¯‡æ–‡ç« ã€‚ åˆ›å»º BPF Mapè¦ä»Žå†…æ ¸ç©ºé—´æ”¶é›†æ•°æ®å¹¶åœ¨ç”¨æˆ·ç©ºé—´è®¿é—®è¿™äº›æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€ç§å«åš BPF æ˜ å°„çš„ä¸œè¥¿ã€‚BPF æ˜ å°„æ˜¯æŽ¨é€åˆ°ç”¨æˆ·ç©ºé—´çš„æ•°æ®ç»“æž„ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åŸºäºŽ PID çš„å“ˆå¸Œè¡¨ç±»åž‹ã€‚è¿™éœ€è¦æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ªç»“æž„ï¼Œå³: é€šè¿‡ key struct è¯†åˆ«æ•°æ® 123456struct key_t &#123; // This is the process ID // which we will use to identify // in the hash map __u32 pid;&#125;; å­˜å‚¨æ•°æ®çš„æ–¹å¼æ˜¯ value struct 123456struct val_t &#123; // used to understand the start time of the process __u64 start_time; // used to store the elapsed time of the process __u64 elapsed_time;&#125;; eBpf HashMap å°†ä»–ä»¬è”ç³»åœ¨ä¸€èµ· 12345678910111213struct &#123; // The type of BPF map we are creating __uint(type, BPF_MAP_TYPE_HASH); // specifying the type to be used for the key __type(key, struct key_t); // specifying the type to be used as the value __type(value, struct val_t); // max amount of entries to store in the map __uint(max_entries, 10240); // name of the map as well as a section macro // from the bpf lib to designate this type // as a BPF map&#125; process_time_map SEC(&quot;.maps&quot;); æˆ‘å·²ç»æ·»åŠ äº†æ³¨é‡Šï¼Œè§£é‡Šè¿™äº›ç»“æž„ä¸­æ¯ä¸€è¡Œçš„ä½œç”¨ã€‚ åˆ›å»º eBPF å‡½æ•°æœ€åŽä¸€æ­¥æ˜¯åˆ›å»º eBPF å‡½æ•°ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ª eBPF ç¨‹åºã€‚è¿™æ˜¯ä¸€ä¸ª C è¯­è¨€å‡½æ•°ï¼Œå¸¦æœ‰ä¸€äº›å®æ ‡è¯†ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å…ˆå‰å®šä¹‰çš„ç±»åž‹è¿›è¡Œäº¤äº’ï¼Œä¾‹å¦‚:123456789101112131415161718192021222324252627282930313233SEC(&quot;tracepoint/sched/sched_switch&quot;)int cpu_processing_time(struct sched_switch_args *ctx) &#123; // get the current time in ns __u64 ts = bpf_ktime_get_ns(); // we need to check if the process is in our map struct key_t prev_key = &#123; .pid = ctx-&gt;prev_pid, &#125;; struct val_t *val = bpf_map_lookup_elem(&amp;process_time_map, &amp;prev_key); // if the previous PID does not exist it means that we just started // watching or we missed the start somehow // so we ignore it for now if (val) &#123; // Calculate and store the elapsed time for the process and we reset the // start time so we can measure the next cycle of that process __u64 elapsed_time = ts - val-&gt;start_time; struct val_t new_val = &#123;.start_time = ts, .elapsed_time = elapsed_time&#125;; bpf_map_update_elem(&amp;process_time_map, &amp;prev_key, &amp;new_val, BPF_ANY); return 0; &#125;; // we need to check if the next process is in our map // if it&apos;s not we need to set initial time struct key_t next_key = &#123; .pid = ctx-&gt;next_pid, &#125;; struct val_t *next_val = bpf_map_lookup_elem(&amp;process_time_map, &amp;prev_key); if (!next_val) &#123; struct val_t next_new_val = &#123;.start_time = ts&#125;; bpf_map_update_elem(&amp;process_time_map, &amp;next_key, &amp;next_new_val, BPF_ANY); return 0; &#125; return 0;&#125; ä¸‹é¢çš„å®æŒ‡å®šäº†è¯¥å‡½æ•°è¦è¿žæŽ¥çš„äº‹ä»¶ã€‚1SEC(&quot;tracepoint/sched/sched_switch&quot;) è¿™ä¸€è¡Œå°±æ˜¯æˆ‘ä»¬æŸ¥æ‰¾ BPF æ˜ å°„æ•°æ®çš„æ–¹æ³•ã€‚æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„é”®ï¼Œå¹¶å°†å…¶ä¼ é€’ç»™ bpf_map_lookup_elem å‡½æ•°ï¼Œè¯¥å‡½æ•°å°†è¿”å›žä¸€ä¸ª val_t ç±»åž‹çš„å€¼ï¼ˆæˆ‘ä»¬ä¹‹å‰å®šä¹‰çš„ï¼‰ã€‚å¦‚æžœè¯¥é”®ä¸‹æ²¡æœ‰å€¼ï¼Œè¯¥å‡½æ•°å°†è¿”å›ž NULLï¼Œè¯·æ³¨æ„æˆ‘ä»¬éœ€è¦å°† BPF æ˜ å°„ç±»åž‹ä½œä¸º &amp;process_time_map ä¼ é€’ã€‚1struct val_t *val = bpf_map_lookup_elem(&amp;process_time_map, &amp;prev_key); è¿™ä¸€è¡Œæ˜¯æˆ‘ä»¬å‘ BPF åœ°å›¾æ·»åŠ æ•°æ®çš„è¿‡ç¨‹ã€‚æˆ‘ä»¬å°†ä¼ é€’é”®ï¼ˆæœ¬ä¾‹ä¸­ä¸º &amp;prev_keyï¼‰å’Œé”®å€¼ï¼ˆ&amp;new_valï¼‰ï¼ŒåŽè€…å°†æŠŠè¯¥å€¼å­˜å‚¨åˆ° BPF æ˜ å°„ä¸­ã€‚è¯·å†æ¬¡æ³¨æ„ï¼Œæˆ‘ä»¬ä¼ é€’çš„æ˜¯æ˜ å°„ç±»åž‹ã€‚BPF_ANY ç”¨äºŽå°†é”®æ›´æ–°ä¸ºæ–°å€¼ï¼Œæˆ–è€…åœ¨é”®ä¸å­˜åœ¨æ—¶åˆ›å»ºæ–°å€¼ï¼ˆå‚è§æ–‡æ¡£ï¼‰ã€‚ 1bpf_map_update_elem(&amp;process_time_map, &amp;prev_key, &amp;new_val, BPF_ANY); è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†åŠŸèƒ½ï¼Œä¸è¿‡ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åœ¨ä»£ç ä¸­æ·»åŠ æœ€åŽä¸€è¡Œï¼š 1char _license[] SEC(&quot;license&quot;) = &quot;Dual MIT/GPL&quot;; ç”±äºŽ eBPF æ˜¯ä»¥ GPL è®¸å¯çš„ï¼Œè¿™æ„å‘³ç€æ‰€æœ‰é›†æˆè½¯ä»¶ä¹Ÿéœ€è¦ä¸Ž GPL å…¼å®¹ã€‚å¦‚æžœæ²¡æœ‰è¿™ä¸€è¡Œï¼Œå°±æ— æ³•å°†ä»£ç åŠ è½½åˆ°å†…æ ¸ä¸­ã€‚å› æ­¤ï¼Œæˆ‘ä»¬çš„æœ€ç»ˆä»£ç ç‰‡æ®µå¦‚ä¸‹ï¼ˆæˆ‘æ·»åŠ äº†éœ€è¦åŒ…å«çš„ C å¤´æ–‡ä»¶ï¼‰: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172#include &lt;linux/sched.h&gt;#include &lt;linux/bpf.h&gt;#include &lt;bpf/bpf_helpers.h&gt;#include &lt;bpf/bpf_tracing.h&gt;#include &lt;stddef.h&gt;#ifndef TASK_COMM_LEN#define TASK_COMM_LEN 16#endifstruct key_t &#123; __u32 pid;&#125;;struct val_t &#123; __u64 start_time; __u64 elapsed_time;&#125;;struct &#123; __uint(type, BPF_MAP_TYPE_HASH); __type(key, struct key_t); __type(value, struct val_t); __uint(max_entries, 10240);&#125; process_time_map SEC(&quot;.maps&quot;);// this is the structure of the sched_switch eventstruct sched_switch_args &#123; char prev_comm[TASK_COMM_LEN]; int prev_pid; int prev_prio; long prev_state; char next_comm[TASK_COMM_LEN]; int next_pid; int next_prio;&#125;;SEC(&quot;tracepoint/sched/sched_switch&quot;)int cpu_processing_time(struct sched_switch_args *ctx) &#123; // get the current time in ns __u64 ts = bpf_ktime_get_ns(); // we need to check if the process is in our map struct key_t prev_key = &#123; .pid = ctx-&gt;prev_pid, &#125;; struct val_t *val = bpf_map_lookup_elem(&amp;process_time_map, &amp;prev_key); // if the previous PID does not exist it means that we just started // watching or we missed the start somehow // so we ignore it for now if (val) &#123; // Calculate and store the elapsed time for the process and we reset the // start time so we can measure the next cycle of that process __u64 elapsed_time = ts - val-&gt;start_time; struct val_t new_val = &#123;.start_time = ts, .elapsed_time = elapsed_time&#125;; bpf_map_update_elem(&amp;process_time_map, &amp;prev_key, &amp;new_val, BPF_ANY); return 0; &#125;; // we need to check if the next process is in our map // if it&apos;s not we need to set initial time struct key_t next_key = &#123; .pid = ctx-&gt;next_pid, &#125;; struct val_t *next_val = bpf_map_lookup_elem(&amp;process_time_map, &amp;prev_key); if (!next_val) &#123; struct val_t next_new_val = &#123;.start_time = ts&#125;; bpf_map_update_elem(&amp;process_time_map, &amp;next_key, &amp;next_new_val, BPF_ANY); return 0; &#125; return 0;&#125;char _license[] SEC(&quot;license&quot;) = &quot;Dual MIT/GPL&quot;; è¿™æ ·ï¼Œæˆ‘ä»¬å°±å®Œæˆäº† BPF ç¨‹åºã€‚åœ¨æœ¬ç³»åˆ—çš„ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘å°†ä»‹ç»ç”¨ GO è¯­è¨€ç¼–å†™ç”¨æˆ·ç©ºé—´ç¨‹åºï¼Œå¹¶ä½¿ç”¨åä¸º bpf2go çš„å·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬å®žçŽ°ç¨‹åºç»‘å®šã€‚]]></content>
      <categories>
        <category>eBPF</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>eBPF</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang å¹¶å‘çš„ fork/join æ¨¡å¼]]></title>
    <url>%2F2024%2F06%2F30%2FGolang-%E5%B9%B6%E5%8F%91%E7%9A%84-fork-join-%E6%A8%A1%E5%BC%8F%2F</url>
    <content type="text"><![CDATA[åœ¨è½¯ä»¶å¼€å‘é¢†åŸŸï¼Œå¯¹æ›´å¿«ã€æ›´é«˜æ•ˆåœ°å¤„ç†æ•°æ®çš„éœ€æ±‚ä¸Žæ—¥ä¿±å¢žã€‚å¹¶è¡Œè®¡ç®—æŠ€æœ¯ï¼ˆå¦‚ fork/join æ¨¡å¼ï¼‰ä¸ºåˆ©ç”¨å¤šä¸ª CPU å†…æ ¸å¹¶å‘æ‰§è¡Œä»»åŠ¡æä¾›äº†å¼ºå¤§çš„è§£å†³æ–¹æ¡ˆï¼Œä»Žè€Œå¤§å¤§ç¼©çŸ­äº†å¤§è§„æ¨¡è®¡ç®—çš„æ‰§è¡Œæ—¶é—´ã€‚æœ¬æ–‡é€šè¿‡åˆ†è§£ä¸€ä¸ªä½¿ç”¨å¹¶å‘ goroutines å¯¹æ•°ç»„æ±‚å’Œçš„ç¤ºä¾‹ï¼ŒæŽ¢è®¨äº† fork/join æ¨¡å¼åœ¨ Go ä¸­çš„å®žçŽ°ã€‚ Fork/Join å¹¶å‘æ¨¡åž‹ä»‹ç»Fork/Join æ¨¡å¼æ˜¯ä¸€ç§å¹¶è¡ŒæŠ€æœ¯ï¼ŒåŒ…æ‹¬å°†ä»»åŠ¡åˆ†æˆè¾ƒå°çš„ä»»åŠ¡å—ï¼Œå¹¶è¡Œå¤„ç†è¿™äº›ä»»åŠ¡å—ï¼ˆåˆ†å‰ï¼‰ï¼Œç„¶åŽå°†è¿™äº›ä»»åŠ¡çš„ç»“æžœåˆå¹¶ä¸ºæœ€ç»ˆç»“æžœï¼ˆjoinï¼‰ã€‚è¿™ç§æ¨¡å¼å°¤å…¶é€‚ç”¨äºŽä»»åŠ¡ç›¸äº’ç‹¬ç«‹ï¼Œå¯ä»¥å¹¶å‘æ‰§è¡Œè€Œäº’ä¸å½±å“çš„æƒ…å†µã€‚ ç®€å•çš„ç¤ºä¾‹ï¼šå¹¶å‘å¯¹æ•°ç»„æ±‚å’Œ1. åˆå§‹åŒ–ï¼šç¨‹åºåˆå§‹åŒ–ä¸€ä¸ªæ•´æ•°æ•°ç»„ã€‚ç¨‹åºè¿˜è®¾ç½®äº†æ•°ç»„åº”åˆ’åˆ†çš„éƒ¨åˆ†æ•°ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”±ä¸€ä¸ªç‹¬ç«‹çš„ç¨‹åºå¤„ç†ã€‚2.å¹¶å‘è®¾ç½®ï¼š2.1 Fork: å°†æ•°ç»„åˆ’åˆ†ä¸ºæŒ‡å®šçš„éƒ¨åˆ†ï¼Œå¹¶ä¸ºæ¯ä¸ªéƒ¨åˆ†å¯åŠ¨ä¸€ä¸ª goroutine æ¥è®¡ç®—è¯¥éƒ¨åˆ†çš„æ€»å’Œã€‚ 2.2 Channel é€šä¿¡ï¼šæ¯ä¸ª â€œç¨‹åº â€œéƒ½ä¼šé€šè¿‡é€šé“å°†è®¡ç®—å‡ºçš„æ€»å’Œå‘é€å›žä¸»è¿›ç¨‹ï¼Œä»¥ç¡®ä¿åŒæ­¥é€šä¿¡ã€‚ 2.3 Join: å½“æ‰€æœ‰ Goroutine å®Œæˆè®¡ç®—åŽï¼Œä¸»è¿›ç¨‹æ”¶é›†å¹¶æ±‡æ€»è¿™äº›éƒ¨åˆ†ç»“æžœï¼Œå¾—å‡ºæ€»å’Œã€‚2.4 Logging: æ—¥å¿—è®°å½•åœ¨æ•´ä¸ªè¿‡ç¨‹ä¸­ï¼Œç¨‹åºä¼šæ‰“å°ä¿¡æ¯ï¼Œæ˜¾ç¤ºæ•°ç»„çš„åˆ’åˆ†ã€æ¯ä¸ªå·¥ä½œè€…è®¡ç®—çš„æ€»å’Œä»¥åŠæ”¶åˆ°çš„éƒ¨åˆ†æ€»å’Œã€‚ ä»£ç ç¤ºä¾‹1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162import ( &quot;fmt&quot; &quot;sync&quot;)var ( parts = 4)func main() &#123; numbers := []int&#123;3, 1, 4, 1, 5, 9, 2, 6, 5, 3, 5&#125; // Example array totalSum := concurrentSum(numbers, parts) // Divide the array into 4 parts for summing fmt.Println(&quot;Total Sum:&quot;, totalSum)&#125;// sumPart sums a part of the array and sends the result to a channel.func sumPart(workerId int, nums []int, result chan&lt;- int, wg *sync.WaitGroup) &#123; defer wg.Done() // Ensure the WaitGroup counter decrements on function completion. sum := 0 for _, num := range nums &#123; sum += num &#125; fmt.Printf(&quot;Worker %d calculated sum: %d\n&quot;, workerId, sum) result &lt;- sum // Send the partial sum to the result channel.&#125;// concurrentSum takes an array and the number of parts to divide it into,// then sums the array elements using concurrent goroutines.func concurrentSum(numbers []int, parts int) int &#123; n := len(numbers) partSize := n / parts // Determine the size of each subarray fmt.Printf(&quot;Dividing the array of size %d into %d parts of size %d\n&quot;, n, parts, partSize) results := make(chan int, parts) // Channel to collect results with a buffer size var wg sync.WaitGroup // Fork step: Launch a goroutine for each part of the array for i := 0; i &lt; parts; i++ &#123; start := i * partSize end := start + partSize if i == parts-1 &#123; // Ensure the last goroutine covers the remainder of the array end = n &#125; wg.Add(1) go sumPart(i, numbers[start:end], results, &amp;wg) &#125; // Close the results channel once all goroutines are done go func() &#123; wg.Wait() close(results) &#125;() // Join step: Combine results totalSum := 0 for sum := range results &#123; fmt.Printf(&quot;Received partial sum: %d\n&quot;, sum) totalSum += sum &#125; return totalSum&#125; ç»“è®ºä¸Šé¢çš„ç¤ºä¾‹å±•ç¤ºäº†ä½¿ç”¨ Go è¿›è¡Œå¹¶å‘ç¼–ç¨‹æ—¶ fork/join æ¨¡å¼çš„æ•ˆçŽ‡ã€‚é€šè¿‡å°†æ•°ç»„æ±‚å’Œçš„ä»»åŠ¡åˆ†ç»™å¤šä¸ª Workerï¼Œç¨‹åºåœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šçš„è¿è¡Œé€Ÿåº¦æ˜Žæ˜¾åŠ å¿«ï¼Œä½¿ç”¨ Go è¿›è¡Œå¹¶å‘ç¼–ç¨‹ä»»åŠ¡å…·æœ‰çš„å¼ºå¤§åŠŸèƒ½å’Œç®€ä¾¿æ€§ã€‚è¿™ç§æ¨¡å¼åŒæ ·å¯åº”ç”¨äºŽå…¶ä»–å„ç§è®¡ç®—é—®é¢˜ã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go 1.22 æä¾›çš„æ›´åŠ å¼ºå¤§çš„ Tracing èƒ½åŠ›]]></title>
    <url>%2F2024%2F06%2F21%2FGo-1-22-%E6%8F%90%E4%BE%9B%E7%9A%84%E6%9B%B4%E5%8A%A0%E5%BC%BA%E5%A4%A7%E7%9A%84-Tracing-%E8%83%BD%E5%8A%9B%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡æ˜¯ç”± Go Team çš„ Michael Knyszek åœ¨ 2024å¹´3æœˆ14æ—¥å‘è¡¨äºŽ go official blogï¼ŒåŽŸæ–‡åœ°å€ï¼š https://go.dev/blog/execution-traces-2024 runtime/trace packageruntime/trace packageåŒ…å«äº†ç†è§£å¹¶æŽ’æŸ¥ Go ç¨‹åºçš„å¼ºå¤§å·¥å…·ã€‚å…¶åŠŸèƒ½å¯ä»¥ç”Ÿæˆæ¯ä¸ª goroutine åœ¨ä¸€æ®µæ—¶é—´å†…çš„æ‰§è¡Œè¿½è¸ªã€‚é€šè¿‡ä½¿ç”¨ go tool trace å‘½ä»¤ï¼ˆæˆ–ä¼˜ç§€çš„å¼€æº gotraceuiå·¥å…·ï¼‰ï¼Œä½ å¯ä»¥å¯è§†åŒ–å¹¶æŽ¢ç´¢è¿™äº›è¿½è¸ªä¸­çš„æ•°æ®ã€‚ Trace çš„ä¼˜åŠ¿åœ¨äºŽå®ƒå¯ä»¥å¾ˆå®¹æ˜“å±•ç¤ºå‡ºç¨‹åºä¸­éš¾ä»¥ä»¥å…¶ä»–æ–¹å¼çœ‹åˆ°çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œè®¸å¤š goroutine é˜»å¡žåœ¨åŒä¸€é€šé“ä¸Šçš„å¹¶å‘ç“¶é¢ˆå¯èƒ½åœ¨ CPU åˆ†æžä¸­å¾ˆéš¾çœ‹åˆ°ï¼Œå› ä¸ºæ ¹æœ¬æ²¡æœ‰æ‰§è¡Œå¯ä¾›é‡‡æ ·ã€‚ä½†åœ¨æ‰§è¡Œè¿½è¸ªä¸­ï¼Œè®¸å¤šå †æ ˆå¯ä»¥æ¸…æ™°åº¦æ˜¾ç¤ºå‡ºæ¥ï¼Œå¹¶ä¸”é˜»å¡žçš„ goroutine çš„å †æ ˆè·Ÿè¸ªå°†è¿…é€ŸæŒ‡å‘ç½ªé­ç¥¸é¦–ã€‚ Go å¼€å‘è€…ç”šè‡³èƒ½å¤Ÿä½¿ç”¨ taskã€regionså’Œ logs æ¥å¯¹ä»–ä»¬è‡ªå·±çš„ç¨‹åºè¿›è¡Œå·¥å…·åŒ–ï¼Œä»–ä»¬å¯ä»¥ä½¿ç”¨è¿™äº›æ¥å°†ä»–ä»¬çš„é«˜çº§å…³æ³¨ç‚¹ä¸Žä½Žçº§æ‰§è¡Œç»†èŠ‚ç›¸å…³è”ã€‚ å­˜åœ¨çš„é—®é¢˜ä¸å¹¸çš„æ˜¯ï¼Œæ‰§è¡Œè¿½è¸ªä¸­çš„ä¸°å¯Œä¿¡æ¯å¸¸å¸¸éš¾ä»¥èŽ·å¾—ã€‚åŽ†å²ä¸Šï¼Œè¿½è¸ªå­˜åœ¨å››ä¸ªä¸»è¦é—®é¢˜ã€‚ è¿½è¸ªæœ‰é«˜å¼€é”€ã€‚ è¿½è¸ªæ²¡æœ‰å¾ˆå¥½åœ°æ‰©å±•ï¼Œå¹¶ä¸”å¯èƒ½å˜å¾—å¤ªå¤§è€Œæ— æ³•åˆ†æžã€‚ é€šå¸¸ä¸æ¸…æ¥šä½•æ—¶å¼€å§‹è¿½è¸ªä»¥æ•èŽ·ç‰¹å®šçš„ä¸è‰¯è¡Œä¸ºã€‚ åªæœ‰ä¸€éƒ¨åˆ† gopher èƒ½å¤Ÿç¨‹åºåŒ–åœ°åˆ†æžè¿½è¸ªï¼Œå› ä¸ºç¼ºä¹é€šç”¨çš„å…¬å…±åŒ…æ¥è§£æžå’Œè§£é‡Šæ‰§è¡Œè¿½è¸ªã€‚ å¦‚æžœä½ åœ¨è¿‡åŽ»å‡ å¹´ä¸­ä½¿ç”¨è¿‡è¿½è¸ªï¼Œä½ å¾ˆå¯èƒ½å› ä¸ºè¿™äº›é—®é¢˜ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªè€Œæ„Ÿåˆ°æ²®ä¸§ã€‚ä½†æˆ‘ä»¬å¾ˆé«˜å…´åœ°åˆ†äº«ï¼Œåœ¨è¿‡åŽ»ä¸¤ä¸ª Go ç‰ˆæœ¬ä¸­ï¼Œæˆ‘ä»¬åœ¨æ‰€æœ‰è¿™å››ä¸ªé¢†åŸŸéƒ½å–å¾—äº†å·¨å¤§è¿›å±•ã€‚ ä½Žå¼€é”€è¿½è¸ªåœ¨ Go 1.21 ä¹‹å‰ï¼Œè¿½è¸ªçš„è¿è¡Œæ—¶å¼€é”€å¯¹äºŽè®¸å¤šåº”ç”¨ç¨‹åºæ¥è¯´åœ¨ 10-20% çš„ CPU ä¹‹é—´ï¼Œè¿™é™åˆ¶äº†è¿½è¸ªçš„ä½¿ç”¨æƒ…å†µï¼Œè€Œä¸æ˜¯åƒ CPU åˆ†æžé‚£æ ·çš„æŒç»­ä½¿ç”¨ã€‚äº‹å®žè¯æ˜Žï¼Œè¿½è¸ªæˆæœ¬çš„å¾ˆå¤§ä¸€éƒ¨åˆ†æ¥è‡ªäºŽå›žæº¯ã€‚è¿è¡Œæ—¶äº§ç”Ÿçš„è®¸å¤šäº‹ä»¶éƒ½é™„æœ‰å †æ ˆè·Ÿè¸ªï¼Œè¿™å¯¹äºŽå®žé™…è¯†åˆ« goroutine åœ¨å…³é”®æ—¶åˆ»æ­£åœ¨åšä»€ä¹ˆéžå¸¸æœ‰ä»·å€¼ã€‚ å¾—ç›ŠäºŽ Felix GeisendÃ¶rfer å’Œ Nick Ripley åœ¨ä¼˜åŒ–å›žæº¯æ•ˆçŽ‡æ–¹é¢çš„å·¥ä½œï¼Œæ‰§è¡Œè¿½è¸ªçš„è¿è¡Œæ—¶ CPU å¼€é”€å·²ç»å¤§å¹…é™ä½Žï¼Œå¯¹äºŽè®¸å¤šåº”ç”¨ç¨‹åºé™è‡³ 1-2%ã€‚ä½ å¯ä»¥åœ¨ Felix å…³äºŽæ­¤ä¸»é¢˜çš„ä¼˜ç§€åšå®¢æ–‡ç« ä¸­é˜…è¯»æ›´å¤šå…³äºŽè¿™é¡¹å·¥ä½œçš„å†…å®¹ã€‚ å¯æ‰©å±•è¿½è¸ªè¿½è¸ªæ ¼å¼åŠå…¶äº‹ä»¶çš„è®¾è®¡å›´ç»•ç›¸å¯¹é«˜æ•ˆçš„å‘å°„ï¼Œä½†éœ€è¦å·¥å…·æ¥è§£æžå¹¶ä¿ç•™æ•´ä¸ªè¿½è¸ªçš„çŠ¶æ€ã€‚å‡ ç™¾ MB çš„è¿½è¸ªå¯èƒ½éœ€è¦å‡ ä¸ª Gi Bçš„ RAM æ¥åˆ†æžï¼ è¿™ä¸ªé—®é¢˜ä¸å¹¸åœ°æ˜¯è¿½è¸ªç”Ÿæˆæ–¹å¼çš„åŸºæœ¬é—®é¢˜ã€‚ä¸ºäº†ä¿æŒè¿è¡Œæ—¶å¼€é”€ä½Žï¼Œæ‰€æœ‰äº‹ä»¶éƒ½è¢«å†™å…¥ç›¸å½“äºŽçº¿ç¨‹æœ¬åœ°ç¼“å†²åŒºçš„åœ°æ–¹ã€‚ä½†è¿™æ„å‘³ç€äº‹ä»¶ä»¥éžçœŸå®žé¡ºåºå‡ºçŽ°ï¼Œè¿½è¸ªå·¥å…·éœ€è¦å¼„æ¸…æ¥šçœŸæ­£å‘ç”Ÿäº†ä»€ä¹ˆã€‚ ä½¿è¿½è¸ªåœ¨ä¿æŒå¼€é”€ä½Žçš„åŒæ—¶æ‰©å±•çš„å…³é”®è§è§£æ˜¯å¶å°”åˆ†å‰²æ­£åœ¨ç”Ÿæˆçš„è¿½è¸ªã€‚æ¯ä¸ªåˆ†å‰²ç‚¹çš„è¡Œä¸ºæœ‰ç‚¹åƒåŒæ—¶ç¦ç”¨å’Œé‡æ–°å¯ç”¨ä¸€ä¸ªgoroutineä¸­çš„è¿½è¸ªã€‚åˆ°ç›®å‰ä¸ºæ­¢çš„æ‰€æœ‰è¿½è¸ªæ•°æ®å°†ä»£è¡¨ä¸€ä¸ªå®Œæ•´ä¸”è‡ªåŒ…å«çš„è¿½è¸ªï¼Œè€Œæ–°çš„è¿½è¸ªæ•°æ®å°†æ— ç¼åœ°ä»Žå®ƒç¦»å¼€çš„åœ°æ–¹ç»§ç»­ã€‚ æ­£å¦‚ä½ æ‰€èƒ½æƒ³è±¡çš„ï¼Œä¿®å¤è¿™ä¸ªé—®é¢˜éœ€è¦é‡æ–°æ€è€ƒå’Œé‡å†™è¿è¡Œæ—¶è¿½è¸ªå®žçŽ°çš„è®¸å¤šåŸºç¡€ã€‚æˆ‘ä»¬å¾ˆé«˜å…´åœ°è¯´ï¼Œè¿™é¡¹å·¥ä½œå·²ç»åœ¨ Go 1.22 ä¸­è½åœ°ï¼Œå¹¶ä¸”çŽ°åœ¨æ™®éå¯ç”¨ã€‚é‡å†™å¸¦æ¥äº†è®¸å¤šä¸é”™çš„æ”¹è¿›ï¼ŒåŒ…æ‹¬å¯¹ go tool trace å‘½ä»¤çš„ä¸€äº›æ”¹è¿›ã€‚å¦‚æžœä½ å¥½å¥‡ï¼Œæ‰€æœ‰ç»†èŠ‚éƒ½åœ¨è®¾è®¡æ–‡æ¡£ä¸­ã€‚ ï¼ˆæ³¨ï¼šgo tool traceä»ç„¶å°†å®Œæ•´è¿½è¸ªåŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä½†ä¸ºç”± Go 1.22+ ç¨‹åºç”Ÿæˆçš„è¿½è¸ªåŽ»é™¤è¿™ä¸ªé™åˆ¶çŽ°åœ¨æ˜¯å¯è¡Œçš„ã€‚ï¼‰ é£žè¡Œè®°å½•å‡è®¾ä½ åœ¨å¤„ç†ä¸€ä¸ªwebæœåŠ¡ï¼Œä¸€ä¸ª RPC èŠ±è´¹äº†å¾ˆé•¿æ—¶é—´ã€‚ä½ ä¸èƒ½åœ¨ä½ çŸ¥é“ RPC å·²ç»èŠ±è´¹äº†å¾ˆé•¿æ—¶é—´çš„ç‚¹å¼€å§‹è¿½è¸ªï¼Œå› ä¸ºæ…¢è¯·æ±‚çš„æ ¹æœ¬åŽŸå› å·²ç»å‘ç”Ÿäº†ï¼Œå¹¶æ²¡æœ‰è¢«è®°å½•ã€‚ æœ‰ä¸€ç§ç§°ä¸ºé£žè¡Œè®°å½•çš„æŠ€æœ¯å¯ä»¥å¸®åŠ©è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½ å¯èƒ½å·²ç»ä»Žå…¶ä»–ç¼–ç¨‹çŽ¯å¢ƒä¸­ç†Ÿæ‚‰äº†å®ƒã€‚é£žè¡Œè®°å½•çš„è§è§£æ˜¯æŒç»­å¼€å¯è¿½è¸ªï¼Œå¹¶å§‹ç»ˆä¿ç•™æœ€è¿‘çš„è¿½è¸ªæ•°æ®ï¼Œä»¥é˜²ä¸‡ä¸€ã€‚ç„¶åŽï¼Œä¸€æ—¦å‘ç”Ÿæœ‰è¶£çš„äº‹æƒ…ï¼Œç¨‹åºå°±å¯ä»¥ç®€å•åœ°å†™å…¥å®ƒæ‰€æ‹¥æœ‰çš„ä»»ä½•ä¸œè¥¿ï¼ åœ¨è¿½è¸ªå¯ä»¥åˆ†å‰²ä¹‹å‰ï¼Œè¿™å‡ ä¹Žæ˜¯ä¸å¯èƒ½çš„ã€‚ä½†æ˜¯ï¼Œç”±äºŽè¿žç»­è¿½è¸ªçŽ°åœ¨ç”±äºŽä½Žå¼€é”€è€Œå˜å¾—å¯è¡Œï¼Œå¹¶ä¸”è¿è¡Œæ—¶çŽ°åœ¨å¯ä»¥åœ¨ä»»ä½•éœ€è¦çš„æ—¶å€™åˆ†å‰²è¿½è¸ªï¼Œäº‹å®žè¯æ˜Žå®žçŽ°é£žè¡Œè®°å½•æ˜¯ç›´æŽ¥çš„ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬å¾ˆé«˜å…´åœ°å®£å¸ƒä¸€ä¸ªé£žè¡Œè®°å½•å™¨å®žéªŒï¼Œå¯åœ¨ golang.org/x/exp/traceåŒ…ä¸­ä½¿ç”¨ã€‚ è¯·å°è¯•å®ƒï¼ä»¥ä¸‹æ˜¯è®¾ç½®é£žè¡Œè®°å½•å™¨ä»¥æ•èŽ·é•¿æ—¶é—´ HTTP è¯·æ±‚çš„ç¤ºä¾‹ï¼Œä»¥å¸®åŠ©ä½ å…¥é—¨ã€‚ 1234567891011121314151617181920212223242526272829303132// è®¾ç½®é£žè¡Œè®°å½•å™¨ã€‚fr := trace.NewFlightRecorder()fr.Start()// è®¾ç½®å¹¶è¿è¡ŒHTTPæœåŠ¡å™¨ã€‚var once sync.Oncehttp.HandleFunc("/my-endpoint", func(w http.ResponseWriter, r *http.Request) &#123; start := time.Now() // è¿›è¡Œå·¥ä½œ... doWork(w, r) // æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ªé•¿æ—¶é—´çš„è¯·æ±‚ã€‚æ‹æ‘„å¿«ç…§ï¼ if time.Since(start) &gt; 300*time.Millisecond &#123; // ä¸ºäº†ç®€å•èµ·è§ï¼Œåªåšä¸€æ¬¡ï¼Œä½†ä½ å¯ä»¥æ‹æ‘„å¤šä¸ªã€‚ once.Do(func() &#123; // æŠ“å–å¿«ç…§ã€‚ var b bytes.Buffer _, err = fr.WriteTo(&amp;b) if err != nil &#123; log.Print(err) return &#125; // å†™å…¥æ–‡ä»¶ã€‚ if err := os.WriteFile("trace.out", b.Bytes(), 0o755); err != nil &#123; log.Print(err) return &#125; &#125;) &#125;&#125;)log.Fatal(http.ListenAndServe(":8080", nil)) å¦‚æžœä½ æœ‰ä»»ä½•åé¦ˆï¼Œæ— è®ºæ˜¯ç§¯æžçš„è¿˜æ˜¯æ¶ˆæžçš„ï¼Œè¯·åˆ†äº«åˆ°ææ¡ˆ issue ä¸Šï¼ Trace reader APIéšç€è¿½è¸ªå®žçŽ°çš„é‡å†™ï¼Œä¹Ÿè¿›è¡Œäº†æ¸…ç†å…¶ä»–è¿½è¸ªå†…éƒ¨çš„å·¥ä½œï¼Œæ¯”å¦‚go tool traceã€‚è¿™å‚¬ç”Ÿäº†ä¸€ä¸ªå°è¯•ï¼Œåˆ›å»ºä¸€ä¸ªè¶³å¤Ÿå¥½çš„è¿½è¸ªè¯»å–å™¨APIï¼Œä»¥ä¾¿å…±äº«ï¼Œå¹¶å¯ä»¥ä½¿è¿½è¸ªæ›´åŠ æ˜“äºŽè®¿é—®ã€‚ å°±åƒé£žè¡Œè®°å½•å™¨ä¸€æ ·ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆé«˜å…´åœ°å®£å¸ƒæˆ‘ä»¬è¿˜æœ‰ä¸€ä¸ªå®žéªŒæ€§çš„è¿½è¸ªè¯»å–å™¨APIï¼Œæˆ‘ä»¬æƒ³åˆ†äº«ã€‚å®ƒä¸Žé£žè¡Œè®°å½•å™¨åœ¨åŒä¸€ä¸ªåŒ…ä¸­ï¼Œgolang.org/x/exp/traceã€‚ æˆ‘ä»¬è®¤ä¸ºå®ƒè¶³å¤Ÿå¥½ï¼Œå¯ä»¥å¼€å§‹åœ¨å…¶ä¸Šæž„å»ºä¸œè¥¿ï¼Œæ‰€ä»¥è¯·å°è¯•å®ƒï¼ä»¥ä¸‹æ˜¯æµ‹é‡é˜»å¡žäº‹ä»¶ä¸­goroutineé˜»å¡žç­‰å¾…ç½‘ç»œçš„æ¯”ä¾‹çš„ç¤ºä¾‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536// ä»Žæ ‡å‡†è¾“å…¥å¼€å§‹è¯»å–ã€‚r, err := trace.NewReader(os.Stdin)if err != nil &#123; log.Fatal(err)&#125;var blocked intvar blockedOnNetwork intfor &#123; // è¯»å–äº‹ä»¶ã€‚ ev, err := r.ReadEvent() if err == io.EOF &#123; break &#125; else if err != nil &#123; log.Fatal(err) &#125; // å¤„ç†å®ƒã€‚ if ev.Kind() == trace.EventStateTransition &#123; st := ev.StateTransition() if st.Resource.Kind == trace.ResourceGoroutine &#123; from, to := st.Goroutine() // æŸ¥æ‰¾é˜»å¡žçš„goroutineï¼Œå¹¶è®¡æ•°ã€‚ if from.Executing() &amp;&amp; to == trace.GoWaiting &#123; blocked++ if strings.Contains(st.Reason, "network") &#123; blockedOnNetwork++ &#125; &#125; &#125; &#125;&#125;// æ‰“å°æˆ‘ä»¬å‘çŽ°çš„å†…å®¹ã€‚p := 100 * float64(blockedOnNetwork) / float64(blocked)fmt.Printf("%2.3f%% instances of goroutines blocking were to block on the network\n", p) å°±åƒé£žè¡Œè®°å½•å™¨ä¸€æ ·ï¼Œæœ‰ä¸€ä¸ªææ¡ˆé—®é¢˜ï¼Œæ˜¯ç•™ä¸‹åé¦ˆçš„å¥½åœ°æ–¹ï¼ æˆ‘ä»¬æƒ³å¿«é€Ÿæåˆ°Dominik Honnefï¼Œä»–æ—©æœŸå°è¯•äº†å®ƒï¼Œæä¾›äº†å¾ˆå¥½çš„åé¦ˆï¼Œå¹¶ä¸ºAPIè´¡çŒ®äº†å¯¹æ—§ç‰ˆæœ¬è¿½è¸ªçš„æ”¯æŒã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang ç©ºç»“æž„ä½“çš„åº•å±‚åŽŸç†å’Œå…¶ä½¿ç”¨]]></title>
    <url>%2F2024%2F06%2F20%2FGolang-%E7%A9%BA%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%E5%92%8C%E5%85%B6%E4%BD%BF%E7%94%A8%2F</url>
    <content type="text"><![CDATA[åœ¨ Go ä¸­ï¼Œæ™®é€šç»“æž„ä½“é€šå¸¸å æ®ä¸€ä¸ªå†…å­˜å—ã€‚ä½†æœ‰ä¸€ç§ç‰¹æ®Šæƒ…å†µï¼šå¦‚æžœæ˜¯ç©ºç»“æž„ä½“ï¼Œå…¶å¤§å°ä¸ºé›¶ã€‚è¿™æ€Žä¹ˆå¯èƒ½ï¼Ÿç©ºç»“æž„ä½“æœ‰ä»€ä¹ˆç”¨ï¼Ÿ1234567891011121314type Test struct &#123; A int B string &#125; â€‹ func main() &#123; fmt.Println(unsafe.Sizeof(Test&#123;&#125;)) fmt.Println(unsafe.Sizeof(struct&#123;&#125;&#123;&#125;)) &#125; â€‹ /* 24 0 */ ç©ºç»“æž„çš„ç§˜å¯†ç‰¹æ®Šå˜é‡ï¼šé›¶åŸºæ•°ç©ºç»“æž„ä½“æ˜¯æ²¡æœ‰å†…å­˜å¤§å°çš„ç»“æž„ä½“ã€‚è¿™ç§è¯´æ³•æ˜¯æ­£ç¡®çš„ï¼Œä½†æ›´å‡†ç¡®åœ°è¯´ï¼Œå®ƒæœ‰ä¸€ä¸ªç‰¹æ®Šçš„èµ·ç‚¹ï¼šzerobase å˜é‡ã€‚è¿™æ˜¯ä¸€ä¸ªå  8 å­—èŠ‚çš„ uintptr å…¨å±€å˜é‡ã€‚æ¯å½“å®šä¹‰æ— æ•°ä¸ª struct {} å˜é‡æ—¶ï¼Œç¼–è¯‘å™¨éƒ½ä¼šåˆ†é…è¿™ä¸ª zerobase å˜é‡çš„åœ°å€ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ Go è¯­è¨€ä¸­ï¼Œä»»ä½•å¤§å°ä¸º 0 çš„å†…å­˜åˆ†é…éƒ½ä½¿ç”¨ç›¸åŒçš„åœ°å€ &amp;zerobaseã€‚ Example12345678910111213141516171819package main â€‹ import &quot;fmt&quot; â€‹ type emptyStruct struct &#123;&#125; â€‹ func main() &#123; a := struct&#123;&#125;&#123;&#125; b := struct&#123;&#125;&#123;&#125; c := emptyStruct&#123;&#125; â€‹ fmt.Printf(&quot;%p\n&quot;, &amp;a) fmt.Printf(&quot;%p\n&quot;, &amp;b) fmt.Printf(&quot;%p\n&quot;, &amp;c) &#125; â€‹ // 0x58e360 // 0x58e360 // 0x58e360 ç©ºç»“æž„ä½“å˜é‡çš„å†…å­˜åœ°å€éƒ½æ˜¯ç›¸åŒçš„ã€‚è¿™æ˜¯å› ä¸ºç¼–è¯‘å™¨åœ¨é‡åˆ°è¿™ç§ç‰¹æ®Šç±»åž‹çš„å†…å­˜åˆ†é…æ—¶ï¼Œä¼šåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­åˆ†é… &amp;zerobaseã€‚è¿™ä¸€é€»è¾‘å­˜åœ¨äºŽ mallocgc å‡½æ•°ä¸­ï¼š 1234567//go:linkname mallocgc func mallocgc(size uintptr, typ *_type, needzero bool) unsafe.Pointer &#123; ... if size == 0 &#123; return unsafe.Pointer(&amp;zerobase) &#125; ... è¿™å°±æ˜¯ Empty struct çš„ç§˜å¯†ã€‚åˆ©ç”¨è¿™ä¸ªç‰¹æ®Šå˜é‡ï¼Œæˆ‘ä»¬å¯ä»¥å®žçŽ°è®¸å¤šåŠŸèƒ½ã€‚ ç©ºç»“æž„å’Œå†…å­˜å¯¹é½é€šå¸¸æƒ…å†µä¸‹ï¼Œå¦‚æžœç©ºç»“æž„ä½“æ˜¯è¾ƒå¤§ç»“æž„ä½“çš„ä¸€éƒ¨åˆ†ï¼Œåˆ™ä¸ä¼šå ç”¨å†…å­˜ã€‚ä½†æ˜¯ï¼Œå½“ç©ºç»“æž„ä½“æ˜¯æœ€åŽä¸€ä¸ªå­—æ®µæ—¶ï¼Œå°±ä¼šè§¦å‘å†…å­˜å¯¹é½ã€‚ Example 123456789101112131415161718192021222324type A struct &#123; x int y string z struct&#123;&#125; &#125; type B struct &#123; x int z struct&#123;&#125; y string &#125; â€‹ func main() &#123; println(unsafe.Alignof(A&#123;&#125;)) println(unsafe.Alignof(B&#123;&#125;)) println(unsafe.Sizeof(A&#123;&#125;)) println(unsafe.Sizeof(B&#123;&#125;)) &#125; â€‹ /** 8 8 32 24 **/ å½“å­˜åœ¨æŒ‡å‘å­—æ®µçš„æŒ‡é’ˆæ—¶ï¼Œè¿”å›žçš„åœ°å€å¯èƒ½åœ¨ç»“æž„ä½“ä¹‹å¤–ï¼Œå¦‚æžœé‡Šæ”¾ç»“æž„ä½“æ—¶æ²¡æœ‰é‡Šæ”¾è¯¥å†…å­˜ï¼Œåˆ™å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚å› æ­¤ï¼Œå½“ç©ºç»“æž„ä½“æ˜¯å¦ä¸€ä¸ªç»“æž„ä½“çš„æœ€åŽä¸€ä¸ªå­—æ®µæ—¶ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œä¼šåˆ†é…é¢å¤–çš„å†…å­˜ã€‚å¦‚æžœç©ºç»“æž„ä½“ä½äºŽç»“æž„ä½“çš„å¼€å¤´æˆ–ä¸­é—´ï¼Œåˆ™å…¶åœ°å€ä¸Žä¸‹é¢çš„å˜é‡ç›¸åŒã€‚ 1234567891011121314151617181920212223242526type A struct &#123; x int y string z struct&#123;&#125; &#125; type B struct &#123; x int z struct&#123;&#125; y string &#125; func main() &#123; a := A&#123;&#125; b := B&#123;&#125; fmt.Printf(&quot;%p\n&quot;, &amp;a.y) fmt.Printf(&quot;%p\n&quot;, &amp;a.z) fmt.Printf(&quot;%p\n&quot;, &amp;b.y) fmt.Printf(&quot;%p\n&quot;, &amp;b.z) &#125; â€‹ /** 0x1400012c008 0x1400012c018 0x1400012e008 0x1400012e008 **/ ç©ºç»“æž„ä½¿ç”¨æ¡ˆä¾‹ç©ºç»“æž„ struct struct{} å­˜åœ¨çš„æ ¸å¿ƒåŽŸå› æ˜¯ä¸ºäº†èŠ‚çœå†…å­˜ã€‚å½“ä½ éœ€è¦ä¸€ä¸ªç»“æž„ä½†ä¸å…³å¿ƒå…¶å†…å®¹æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ç©ºç»“æž„ã€‚Go çš„æ ¸å¿ƒå¤åˆç»“æž„ï¼Œå¦‚ mapã€chan å’Œ sliceï¼Œéƒ½å¯ä»¥ä½¿ç”¨ struct{}ã€‚ map &amp; struct{}123456// Create map m := make(map[int]struct&#123;&#125;) // Assign value m[1] = struct&#123;&#125;&#123;&#125; // Check if key exists _, ok := m[1] chan &amp; struct{}å…¸åž‹çš„æƒ…å†µæ˜¯å°† channel å’Œ struct{} ç»“åˆåœ¨ä¸€èµ·ï¼Œå…¶ä¸­ struct{} ç»å¸¸è¢«ç”¨ä½œä¿¡å·ï¼Œè€Œä¸å…³å¿ƒå…¶å†…å®¹ã€‚æ­£å¦‚å‰å‡ ç¯‡æ–‡ç« æ‰€åˆ†æžçš„ï¼Œé€šé“çš„åŸºæœ¬æ•°æ®ç»“æž„æ˜¯ä¸€ä¸ªç®¡ç†ç»“æž„åŠ ä¸€ä¸ªçŽ¯å½¢ç¼“å†²åŒºã€‚å¦‚æžœ struct{} è¢«ç”¨ä½œå…ƒç´ ï¼Œåˆ™çŽ¯å½¢ç¼“å†²åŒºä¸ºé›¶åˆ†é…ã€‚ chan å’Œ struct{} æ”¾åœ¨ä¸€èµ·çš„å”¯ä¸€ç”¨é€”æ˜¯ä¿¡å·ä¼ è¾“ï¼Œå› ä¸ºç©ºç»“æž„ä½“æœ¬èº«ä¸èƒ½æºå¸¦ä»»ä½•å€¼ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒä¸ç”¨äºŽç¼“å†²é€šé“ã€‚ 123456789101112131415// Create a signal channel waitc := make(chan struct&#123;&#125;) â€‹ // ... goroutine 1: // Send signal: push element waitc &lt;- struct&#123;&#125;&#123;&#125; // Send signal: close close(waitc) â€‹ goroutine 2: select &#123; // Receive signal and perform corresponding actions case &lt;-waitc: &#125; åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæœ‰å¿…è¦ä½¿ç”¨ struct{} å—ï¼Ÿå…¶å®žä¸ç„¶ï¼ŒèŠ‚çœçš„å†…å­˜å‡ ä¹Žå¯ä»¥å¿½ç•¥ä¸è®¡ã€‚å…³é”®åœ¨äºŽï¼Œæˆ‘ä»¬å¹¶ä¸å…³å¿ƒ chan çš„å…ƒç´ å€¼ï¼Œå› æ­¤ä½¿ç”¨äº† struct{}ã€‚ æ€»ç»“ ç©ºç»“æž„ä½“ä»ç„¶æ˜¯å¤§å°ä¸º 0 çš„ç»“æž„ä½“ã€‚ æ‰€æœ‰ç©ºç»“æž„ä½“å…±äº«åŒä¸€ä¸ªåœ°å€ï¼šzerobase çš„åœ°å€ã€‚ æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ empty ç»“æž„ä¸å ç”¨å†…å­˜çš„ç‰¹æ€§æ¥ä¼˜åŒ–ä»£ç ï¼Œä¾‹å¦‚ä½¿ç”¨æ˜ å°„æ¥å®žçŽ°é›†åˆå’Œé€šé“ã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go å¦‚ä½•åŸºäºŽ MVS è§£å†³ä¾èµ–å…³ç³»é—®é¢˜]]></title>
    <url>%2F2024%2F06%2F20%2FGo-%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8E-MVS-%E8%A7%A3%E5%86%B3%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[æ‘˜è¦ï¼šæ–‡ç« ä¸»è¦ä»‹ç»äº† Go å¦‚ä½•è§£å†³ä¾èµ–å…³ç³»å’Œç‰ˆæœ¬å†²çªé—®é¢˜ï¼Œä»¥åŠæ¨¡å—ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ go.mod æ–‡ä»¶çš„ä½œç”¨ã€go get å’Œ go install å‘½ä»¤çš„ä½¿ç”¨ Go ä½¿ç”¨ä¸€ç§åä¸º â€œæœ€å°ç‰ˆæœ¬é€‰æ‹©(Minimal version selection)â€ï¼ˆMVSï¼‰çš„æ–¹æ³•æ¥å¤„ç†ä¾èµ–å…³ç³»å’Œè§£å†³ç‰ˆæœ¬å†²çªã€‚MVS å¬èµ·æ¥å¾ˆå¤æ‚ï¼Œä½†è¦ç‚¹å¦‚ä¸‹ï¼šå®ƒä¸ºæ¯ä¸ªæ¨¡å—æŒ‘é€‰æœ€ä½Žç‰ˆæœ¬ï¼Œä»¥æ»¡è¶³å…¶ä»–æ¨¡å—çš„æ‰€æœ‰è¦æ±‚ã€‚è¿™æ ·ï¼Œå®ƒå°±èƒ½åœ¨æ»¡è¶³æ‰€æœ‰ç›¸å…³éœ€æ±‚çš„åŒæ—¶ï¼Œå°½å¯èƒ½å‡å°‘ä¾èµ–æ€§ã€‚ ä¾‹å¦‚ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸‰ä¸ªæ¨¡å—ï¼šAã€B å’Œ Cã€‚ æ¨¡å— A@1.3.2 å’Œæ¨¡å— B@1.0.0 éƒ½ä¾èµ–äºŽæ¨¡å— Cã€‚ ä½† A éœ€è¦ C@2.3.2ï¼ŒB éœ€è¦ C@2.3.0ã€‚ åŒæ—¶ C ä¹Ÿæœ‰ä¸€ä¸ªæ›´æ–°çš„ç‰ˆæœ¬ï¼Œå³ 2.4.1ã€‚ Go å¦‚ä½•å†³å®šä½¿ç”¨å“ªä¸ªç‰ˆæœ¬çš„ Cï¼Ÿ å¦‚æžœé€‰æ‹©çš„ 2.3.2 ç‰ˆæœ¬ä¸Žæ¨¡å— B ä¸å…¼å®¹æ€Žä¹ˆåŠžï¼Ÿ Go æ¨¡å—ä½¿ç”¨è¯­ä¹‰ç‰ˆæœ¬æŽ§åˆ¶ï¼ˆsemverï¼‰æ¥å¤„ç†å…¼å®¹æ€§é—®é¢˜ã€‚å¦‚æžœæ¨¡å—éµå¾ª semverï¼Œåˆ™ä»»ä½•ç ´åæ€§ä¿®æ”¹éƒ½åº”ä¿®æ”¹ä¸»ç‰ˆæœ¬ï¼ˆmajor.minor.patchï¼‰ã€‚ç”±äºŽ 2.3.0 å’Œ 2.3.2 ä¸¤ä¸ªç‰ˆæœ¬çš„ä¸»è¦ç‰ˆæœ¬ï¼ˆ2.3.xï¼‰ç›¸åŒï¼Œå› æ­¤å®ƒä»¬åº”è¯¥ç›¸äº’å‘åŽå…¼å®¹ã€‚æ¨¡å—ä½œè€…æœ‰è´£ä»»ç¡®ä¿ä¸åŒç‰ˆæœ¬ä¿æŒå…¼å®¹ã€‚ å¦‚æžœ A éœ€è¦ 3.0.0 ç‰ˆæœ¬çš„ Cï¼Œè¿™ä¼šç ´åä¸Ž B çš„å…¼å®¹æ€§ï¼Œæ€Žä¹ˆåŠžï¼Ÿ å½“æ¨¡å—è¾¾åˆ°ä¸»ç‰ˆæœ¬ 2 æˆ–æ›´é«˜ç‰ˆæœ¬æ—¶ï¼Œå…¶è·¯å¾„ä¼šåŒ…å«ä¸»ç‰ˆæœ¬å·ï¼ˆå¦‚ /v2 æˆ– /v3ï¼‰ï¼š12github.com/user/project/v2github.com/user/project/v3 ä¸åŒä¸»è¦ç‰ˆæœ¬çš„æ¨¡å—è¢«è§†ä¸ºä¸åŒçš„æ¨¡å—ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨åŒä¸€é¡¹ç›®ä¸­åŒæ—¶ä½¿ç”¨ C@2.3.2 å’Œ C@3.0.0ã€‚ ä¾‹å¦‚ï¼Œæˆ‘ä»¬çš„ go.mod æ–‡ä»¶å¯èƒ½å¦‚ä¸‹æ‰€ç¤ºï¼š12345678910module yourprojectrequire ( github.com/user/A v1.0.0 github.com/user/B v1.0.0)require ( github.com/user/C/v2 v2.3.2 // indirect github.com/user/C/v3 v3.0.0 // indirect) // indirect æ³¨é‡Šè¡¨ç¤ºè¿™é‡Œçš„é¡¹ç›®æ²¡æœ‰ç›´æŽ¥å¯¼å…¥ C æ¨¡å—ï¼Œè€Œæ˜¯å› ä¸º A æˆ– B éœ€è¦å®ƒæ‰å¯¼å…¥çš„ã€‚ è¿˜æœ‰ä¸€ä¸ªè¦æ³¨æ„ç‚¹ï¼šgo get ä¸ä¼šæ›´æ–°æˆ–æ·»åŠ ç¼ºå¤±çš„æµ‹è¯•ä¾èµ–é¡¹ã€‚è¦åŒ…å«è¿™äº›ä¾èµ–é¡¹ï¼Œè¯·ä½¿ç”¨ -t æ ‡å¿—ï¼Œå¦‚ go get -t ./... go getè¿™é‡Œä¸¾å‡ ä¸ªä¾‹å­ï¼Œçœ‹çœ‹ go get åœ¨ä¸åŒæƒ…å†µä¸‹æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ ä½¿ç”¨ go get .æˆ– go get ./â€¦æŸ¥æ‰¾å½“å‰ç›®å½•æˆ–å…¶å­ç›®å½•ä¸­æ‰€æœ‰ç¼ºå¤±çš„ä¾èµ–é¡¹ï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° go.mod æ–‡ä»¶ä¸­ã€‚è¿™æ„å‘³ç€å®ƒä¼šæ£€æŸ¥ä»»ä½•å°šæœªåˆ—å‡ºçš„ä¾èµ–é¡¹ï¼Œå¹¶å°†å…¶æ·»åŠ è¿›æ¥ã€‚é™¤éžä½ ç‰¹åˆ«è¦æ±‚ï¼Œå¦åˆ™å®ƒä¸ä¼šå°†çŽ°æœ‰çš„ä¾èµ–é¡¹æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œæ¯”å¦‚ä¸‹ä¸€ä¸ªä¾‹å­ä¸­çš„ -u æ ‡å¿—ã€‚ 1go get -u . åœ¨ go get .ä¸­ä½¿ç”¨ -u æ ‡å¿—ï¼Œä¼šå°†å½“å‰ç›®å½•ä¸­çš„çŽ°æœ‰ä¾èµ–é¡¹æ›´æ–°åˆ°æœ€æ–°çš„æ¬¡ç‰ˆæœ¬æˆ–è¡¥ä¸ç‰ˆæœ¬ã€‚è¯·è®°ä½ï¼Œå®ƒä¸ä¼šæ›´æ–°åˆ°æ–°çš„ä¸»ç‰ˆæœ¬ï¼Œå› ä¸ºå®ƒä»¬è¢«è§†ä¸ºä¸åŒçš„æ¨¡å—ã€‚è¦å°†ä¸»æ¨¡å—çš„æ‰€æœ‰ä¾èµ–é¡¹æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨ go get -u ./... åœ¨ä¸‹é¢çš„å‡ ä¸ªæƒ…å†µä¸‹ï¼Œå³ä½¿ä¸æŒ‡å®š -u æ ‡å¿—ï¼Œgo get ä»ä¼šæ›´æ–°è¿‡æ—¶æˆ–ä¸¢å¤±çš„ä¾èµ–é¡¹ã€‚ go get github.com/user/projectæ­¤å‘½ä»¤ä¸‹è½½æ¨¡å— github.com/user/projectï¼Œå¹¶å°†å…¶æ·»åŠ åˆ° go.mod æ–‡ä»¶ä¸­ã€‚å¦‚æžœè¯¥æ¨¡å—å·²åˆ—åœ¨è¯¥æ–‡ä»¶ä¸­ï¼Œåˆ™ä¼šå°†å…¶æ›´æ–°ä¸ºæœ€æ–°çš„æ¬¡ç‰ˆæœ¬æˆ–è¡¥ä¸ç‰ˆæœ¬ã€‚åŸºæœ¬ä¸Šï¼Œå¦‚æžœä½ ä¸æŒ‡å®šç‰ˆæœ¬ï¼ˆæˆ–ç‰ˆæœ¬æŸ¥è¯¢åŽç¼€ï¼‰ï¼Œå®ƒä¼šå‡å®šä½ æƒ³å‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ï¼Œå°±åƒä½¿ç”¨ go get github.com/user/project@upgrade ä¸€æ ·ã€‚ go get github.com/user/project@v1.2.3æ­¤å‘½ä»¤å°†æ¨¡å—æ›´æ–°åˆ°æŒ‡å®šç‰ˆæœ¬ï¼Œå³ v1.2.3ã€‚æ ¹æ®å½“å‰çš„ç‰ˆæœ¬ï¼Œå®ƒå¯èƒ½ä¼šå‡çº§æˆ–é™çº§æ¨¡å—ä»¥åŒ¹é…è¯¥ç‰ˆæœ¬ã€‚ go install: build and install packagesä¸Žä¸‹è½½ä¾èµ–é¡¹ä»¥ä¾¿åœ¨é¡¹ç›®ä¸­ä½¿ç”¨å…¶æºä»£ç ä¸åŒï¼Œgo install ä¼šå°†ä¾èµ–é¡¹çš„æºä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¹¶å°†å…¶ç§»åŠ¨åˆ° $GOPATH/bin ç›®å½•ä¸­è¿›è¡Œå®‰è£…ã€‚è¿™æ ·å°±å¯ä»¥åœ¨ç»ˆç«¯ä¸Šä½¿ç”¨å®ƒäº†ã€‚ ä¾‹å¦‚ï¼š1$ go install golang.org/x/tools/gopls@latest è¿è¡Œè¯¥å‘½ä»¤å¹¶æŸ¥çœ‹ $GOBIN æ–‡ä»¶å¤¹ï¼ˆæˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ï¼‰åŽï¼Œä½ ä¼šåœ¨å…¶ä¸­çœ‹åˆ°ä¸€ä¸ªåä¸º gopls çš„å¯æ‰§è¡Œæ–‡ä»¶ã€‚å¦‚æžœ $GOBIN åœ¨æ‚¨çš„ $PATH ä¸­ï¼Œæ‚¨å°±å¯ä»¥åœ¨ç»ˆç«¯ä¸­è¿è¡Œ goplsã€‚ å¦‚æžœåªæ˜¯åœ¨æ²¡æœ‰ä»»ä½•å‚æ•°çš„æƒ…å†µä¸‹è¿è¡Œ go install ä¼šæ€Žæ ·å‘¢ï¼Ÿgo install å°±ä¼šä¸‹è½½ç¼ºå¤±çš„ä¾èµ–é¡¹ï¼Œå¹¶åœ¨å½“å‰ç›®å½•ä¸‹æž„å»ºå½“å‰æ¨¡å—ã€‚è¿™å¯¼è‡´ä¸€äº›äººè¯¯ç”¨ go install æ¥ç®¡ç†ä¾èµ–å…³ç³»ï¼Œå› ä¸ºå®ƒç¡®å®žä¼šä¸‹è½½ä¾èµ–å…³ç³»ã€‚ä½†è¿™å¹¶ä¸æ˜¯å®ƒçš„ä¸»è¦å·¥ä½œï¼Œå®ƒå®žé™…ä¸Šæ˜¯è¦æž„å»ºä½ çš„é¡¹ç›®ï¼Œå¹¶å°†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶å®‰è£…åˆ° $GOBIN ç›®å½•ä¸­ã€‚ go install ç”¨äºŽæž„å»ºå’Œå®‰è£…è½¯ä»¶åŒ…ï¼Œè€Œ go get ç”¨äºŽç®¡ç†ä¾èµ–å…³ç³»ã€‚æœ‰äº›å¼€å‘è€…ç»å¸¸ä¼šæ„Ÿåˆ°å›°æƒ‘ï¼Œè¿™æ˜¯å› ä¸ºåœ¨æ—§ç‰ˆæœ¬çš„ Go ä¸­ï¼Œgo get ç¡®å®žæ˜¯ç”¨æ¥åœ¨æ›´æ–° go.mod æ–‡ä»¶åŽæž„å»ºè½¯ä»¶åŒ…ï¼Œç„¶åŽå°†å®ƒä»¬å®‰è£…åˆ° $GOPATH/binã€‚ ä½†ä»Ž Go 1.16 å¼€å§‹ï¼Œgo install æˆä¸ºäº†æž„å»ºå’Œå®‰è£…çš„é¦–é€‰å‘½ä»¤ï¼Œè€Œ go get åˆ™ä¸“æ³¨äºŽç®¡ç† go.mod æ–‡ä»¶ä¸­çš„éœ€æ±‚ã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Robust generic functions on slices]]></title>
    <url>%2F2024%2F06%2F19%2FRobust-generic-functions-on-slices%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡æ˜¯ç”± Go Team çš„ Valentin Deleplace åœ¨ 2024å¹´2æœˆ22æ—¥å‘è¡¨äºŽ go official blogï¼ŒåŽŸæ–‡åœ°å€ï¼šhttps://go.dev/blog/generic-slice-functions åˆ‡ç‰‡åŒ…æä¾›äº†é€‚ç”¨äºŽä»»ä½•ç±»åž‹åˆ‡ç‰‡çš„å‡½æ•°ã€‚åœ¨è¿™ç¯‡åšå®¢æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•é€šè¿‡ç†è§£åˆ‡ç‰‡åœ¨å†…å­˜ä¸­çš„è¡¨ç¤ºæ–¹å¼ä»¥åŠè¿™å¦‚ä½•å½±å“åžƒåœ¾å›žæ”¶å™¨ï¼Œä»Žè€Œæ›´æœ‰æ•ˆåœ°ä½¿ç”¨è¿™äº›å‡½æ•°ã€‚å¹¶ä¸”ï¼Œæˆ‘ä»¬å°†ä»‹ç»æˆ‘ä»¬æœ€è¿‘å¦‚ä½•è°ƒæ•´è¿™äº›å‡½æ•°ï¼Œä½¿å®ƒä»¬æ›´åŠ ä¾¿äºŽä½¿ç”¨ã€‚ ä½¿ç”¨ç±»åž‹å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºæ‰€æœ‰å¯æ¯”è¾ƒå…ƒç´ çš„åˆ‡ç‰‡ç¼–å†™ä¸€æ¬¡å‡½æ•°ï¼Œä¾‹å¦‚slices.Indexï¼š 12345678910// Index è¿”å›ž v åœ¨ s ä¸­é¦–æ¬¡å‡ºçŽ°çš„ç´¢å¼•ï¼Œ// å¦‚æžœä¸å­˜åœ¨ï¼Œåˆ™è¿”å›ž -1ã€‚func Index[S ~[]E, E comparable](s S, v E) int &#123; for i := range s &#123; if v == s[i] &#123; return i &#125; &#125; return -1&#125; ä¸å†éœ€è¦ä¸ºæ¯ç§ä¸åŒç±»åž‹çš„å…ƒç´ é‡æ–°å®žçŽ°Indexã€‚ åˆ‡ç‰‡åŒ…åŒ…å«è®¸å¤šå¼€ç®±å³ç”¨çš„å‡½æ•°ï¼Œç”¨äºŽæ‰§è¡Œåˆ‡ç‰‡ä¸Šçš„å¸¸è§æ“ä½œï¼š 1234567s := []string&#123;"Bat", "Fox", "Owl", "Fox"&#125;s2 := slices.Clone(s)slices.Sort(s2)fmt.Println(s2) // [Bat Fox Fox Owl]s2 = slices.Compact(s2)fmt.Println(s2) // [Bat Fox Owl]fmt.Println(slices.Equal(s, s2)) // false å‡ ä¸ªæ–°å‡½æ•°ï¼ˆInsert, Replace, Delete ç­‰ï¼‰ä¼šä¿®æ”¹åˆ‡ç‰‡ã€‚ä¸ºäº†ç†è§£å®ƒä»¬çš„å·¥ä½œåŽŸç†ä»¥åŠå¦‚ä½•æ­£ç¡®ä½¿ç”¨å®ƒä»¬ï¼Œæˆ‘ä»¬éœ€è¦æ£€æŸ¥åˆ‡ç‰‡çš„åº•å±‚ç»“æž„ã€‚ åˆ‡ç‰‡æ˜¯æ•°ç»„çš„ä¸€éƒ¨åˆ†è§†å›¾ã€‚åœ¨å†…éƒ¨ï¼Œåˆ‡ç‰‡åŒ…å«ä¸€ä¸ªæŒ‡å‘æ•°ç»„çš„æŒ‡é’ˆã€é•¿åº¦å’Œå®¹é‡ã€‚ä¸¤ä¸ªåˆ‡ç‰‡å¯ä»¥æœ‰ç›¸åŒçš„åº•å±‚æ•°ç»„ï¼Œå¹¶ä¸”å¯ä»¥æŸ¥çœ‹é‡å çš„éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼Œè¿™ä¸ªåˆ‡ç‰‡sæ˜¯å¤§å°ä¸º6çš„æ•°ç»„ä¸­4ä¸ªå…ƒç´ çš„è§†å›¾ï¼š å¦‚æžœä¸€ä¸ªå‡½æ•°æ›´æ”¹äº†ä½œä¸ºå‚æ•°ä¼ é€’çš„åˆ‡ç‰‡çš„é•¿åº¦ï¼Œé‚£ä¹ˆå®ƒéœ€è¦è¿”å›žä¸€ä¸ªæ–°çš„åˆ‡ç‰‡ç»™è°ƒç”¨è€…ã€‚å¦‚æžœä¸éœ€è¦å¢žé•¿ï¼Œåº•å±‚æ•°ç»„å¯èƒ½ä¿æŒä¸å˜ã€‚è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆappendå’Œslices.Compactè¿”å›žä¸€ä¸ªå€¼ï¼Œè€Œä»…ä»…é‡æ–°æŽ’åºå…ƒç´ çš„slices.Sortå´ä¸è¿”å›žã€‚ è€ƒè™‘åˆ é™¤åˆ‡ç‰‡çš„ä¸€éƒ¨åˆ†çš„ä»»åŠ¡ã€‚åœ¨æ³›åž‹ä¹‹å‰ï¼Œä»Žåˆ‡ç‰‡sä¸­åˆ é™¤éƒ¨åˆ†s[2:5]çš„æ ‡å‡†æ–¹æ³•æ˜¯è°ƒç”¨appendå‡½æ•°æ¥å¤åˆ¶æœ«ç«¯éƒ¨åˆ†è¦†ç›–ä¸­é—´éƒ¨åˆ†ï¼š 1s = append(s[:2], s[5:]...) è¯­æ³•å¤æ‚ä¸”å®¹æ˜“å‡ºé”™ï¼Œæ¶‰åŠå­åˆ‡ç‰‡å’Œå¯å˜å‚æ•°ã€‚æˆ‘ä»¬æ·»åŠ äº†slice.Deleteæ¥ä½¿åˆ é™¤å…ƒç´ å˜å¾—æ›´å®¹æ˜“ï¼š 123func Delete[S ~[]E, E any](s S, i, j int) S &#123; return append(s[:i], s[j:]...)&#125; ä¸€è¡Œå‡½æ•°Deleteæ›´æ¸…æ™°åœ°è¡¨è¾¾äº†ç¨‹åºå‘˜çš„æ„å›¾ã€‚è®©æˆ‘ä»¬è€ƒè™‘ä¸€ä¸ªé•¿åº¦ä¸º6ã€å®¹é‡ä¸º8çš„åˆ‡ç‰‡sï¼ŒåŒ…å«æŒ‡é’ˆï¼š 1s = slices.Delete(s, 2, 5) è¿™ä¸ªè°ƒç”¨ä»Žåˆ‡ç‰‡sä¸­åˆ é™¤äº†å…ƒç´ s[2]ã€s[3]ã€s[4]ï¼š åˆ é™¤åœ¨ç´¢å¼•2ã€3ã€4çš„é—´éš™é€šè¿‡å°†å…ƒç´ s[5]å‘å·¦ç§»åŠ¨æ¥å¡«è¡¥ï¼Œå¹¶å°†æ–°é•¿åº¦è®¾ç½®ä¸º3ã€‚ Deleteä¸éœ€è¦åˆ†é…ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œå› ä¸ºå®ƒæ˜¯å°±åœ°ç§»åŠ¨å…ƒç´ ã€‚åƒappendä¸€æ ·ï¼Œå®ƒè¿”å›žä¸€ä¸ªæ–°çš„åˆ‡ç‰‡ã€‚åˆ‡ç‰‡åŒ…ä¸­çš„è®¸å¤šå…¶ä»–å‡½æ•°éµå¾ªè¿™ä¸€æ¨¡å¼ï¼ŒåŒ…æ‹¬Compactã€CompactFuncã€DeleteFuncã€Growã€Insertå’ŒReplaceã€‚ è°ƒç”¨è¿™äº›å‡½æ•°æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»è®¤ä¸ºåŽŸå§‹åˆ‡ç‰‡æ— æ•ˆï¼Œå› ä¸ºåº•å±‚æ•°ç»„å·²ç»è¢«ä¿®æ”¹ã€‚å¦‚æžœè°ƒç”¨å‡½æ•°ä½†å¿½ç•¥è¿”å›žå€¼ï¼Œå°†æ˜¯ä¸€ä¸ªé”™è¯¯ï¼š 12slices.Delete(s, 2, 5) // é”™è¯¯ï¼// sä»ç„¶å…·æœ‰ç›¸åŒçš„é•¿åº¦ï¼Œä½†å†…å®¹å·²è¢«ä¿®æ”¹ A problem of unwanted livenessåœ¨Go 1.22ä¹‹å‰ï¼Œslices.Deleteæ²¡æœ‰ä¿®æ”¹åˆ‡ç‰‡çš„æ–°æ—§é•¿åº¦ä¹‹é—´çš„å…ƒç´ ã€‚è™½ç„¶è¿”å›žçš„åˆ‡ç‰‡ä¸åŒ…æ‹¬è¿™äº›å…ƒç´ ï¼Œä½†åœ¨åŽŸå§‹çš„ã€çŽ°åœ¨æ— æ•ˆçš„åˆ‡ç‰‡æœ«ç«¯åˆ›å»ºçš„â€œé—´éš™â€ä»ç„¶ä¿ç•™äº†å®ƒä»¬ã€‚è¿™äº›å…ƒç´ å¯èƒ½åŒ…å«æŒ‡å‘å¤§å¯¹è±¡ï¼ˆä¸€ä¸ª20MBçš„å›¾åƒï¼‰çš„æŒ‡é’ˆï¼Œåžƒåœ¾å›žæ”¶å™¨ä¸ä¼šé‡Šæ”¾ä¸Žè¿™äº›å¯¹è±¡å…³è”çš„å†…å­˜ã€‚è¿™å¯¼è‡´äº†ä¸€ä¸ªå†…å­˜æ³„æ¼ï¼Œå¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„æ€§èƒ½é—®é¢˜ã€‚ åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸåœ°é€šè¿‡å°†ä¸€ä¸ªå…ƒç´ å‘å·¦ç§»åŠ¨æ¥åˆ é™¤æŒ‡é’ˆp2ã€p3ã€p4ä»Žs[2:5]ã€‚ä½†æ˜¯p3å’Œp4ä»ç„¶å­˜åœ¨äºŽåº•å±‚æ•°ç»„ä¸­ï¼Œåœ¨sçš„æ–°é•¿åº¦ä¹‹å¤–ã€‚åžƒåœ¾å›žæ”¶å™¨ä¸ä¼šå›žæ”¶å®ƒä»¬ã€‚ä¸å¤ªæ˜Žæ˜¾çš„æ˜¯ï¼Œp5ä¸æ˜¯è¢«åˆ é™¤çš„å…ƒç´ ä¹‹ä¸€ï¼Œä½†æ˜¯ç”±äºŽæ•°ç»„ç°è‰²éƒ¨åˆ†ä¸­ä¿ç•™çš„p5æŒ‡é’ˆï¼Œå®ƒçš„å†…å­˜å¯èƒ½ä»ç„¶ä¼šæ³„æ¼ã€‚ å¦‚æžœå¼€å‘è€…æ²¡æœ‰æ„è¯†åˆ°â€œçœ‹ä¸è§â€çš„å…ƒç´ ä»åœ¨ä½¿ç”¨å†…å­˜ï¼Œè¿™å¯èƒ½ä¼šä»¤äººå›°æƒ‘ã€‚ æ‰€ä»¥æˆ‘ä»¬æœ‰ä¸¤ä¸ªé€‰æ‹©ï¼š è¦ä¹ˆä¿ç•™Deleteçš„é«˜æ•ˆå®žçŽ°ã€‚å¦‚æžœç”¨æˆ·æƒ³ç¡®ä¿æ‰€æŒ‡å‘çš„å€¼å¯ä»¥è¢«é‡Šæ”¾ï¼Œä»–ä»¬å¯ä»¥è‡ªå·±å°†è¿‡æ—¶çš„æŒ‡é’ˆè®¾ç½®ä¸ºnilã€‚æˆ–è€…æ›´æ”¹Deleteä»¥å§‹ç»ˆå°†è¿‡æ—¶çš„å…ƒç´ è®¾ç½®ä¸ºé›¶ã€‚è¿™æ˜¯é¢å¤–çš„å·¥ä½œï¼Œä½¿Deleteç¨å¾®ä½Žæ•ˆä¸€äº›ã€‚å°†æŒ‡é’ˆï¼ˆå°†å®ƒä»¬è®¾ç½®ä¸ºnilï¼‰å½’é›¶å¯ä»¥å¯ç”¨åžƒåœ¾å›žæ”¶ï¼Œå½“å®ƒä»¬å˜å¾—æ— æ³•è®¿é—®æ—¶ã€‚ä¸æ˜Žæ˜¾å“ªä¸ªé€‰é¡¹æ˜¯æœ€å¥½çš„ã€‚ç¬¬ä¸€ä¸ªé»˜è®¤æä¾›æ€§èƒ½ï¼Œç¬¬äºŒä¸ªé»˜è®¤æä¾›å†…å­˜èŠ‚ä¿­ã€‚ ä¿®å¤ä¸€ä¸ªå…³é”®çš„è§‚å¯Ÿæ˜¯â€œå°†è¿‡æ—¶çš„æŒ‡é’ˆè®¾ç½®ä¸ºnilâ€å¹¶ä¸åƒçœ‹èµ·æ¥é‚£ä¹ˆå®¹æ˜“ã€‚å®žé™…ä¸Šï¼Œè¿™ä¸ªä»»åŠ¡éžå¸¸å®¹æ˜“å‡ºé”™ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è®©ç”¨æˆ·è‡ªå·±æ¥å†™ã€‚å‡ºäºŽå®žç”¨ä¸»ä¹‰ï¼Œæˆ‘ä»¬é€‰æ‹©ä¿®æ”¹äº”ä¸ªå‡½æ•°Compactã€CompactFuncã€Deleteã€DeleteFuncã€Replaceçš„å®žçŽ°ï¼Œä»¥â€œæ¸…é™¤å°¾éƒ¨â€ã€‚ä½œä¸ºä¸€ä¸ªä¸é”™çš„å‰¯ä½œç”¨ï¼Œè®¤çŸ¥è´Ÿè·å‡å°‘äº†ï¼Œç”¨æˆ·çŽ°åœ¨ä¸éœ€è¦æ‹…å¿ƒè¿™äº›å†…å­˜æ³„æ¼ã€‚ åœ¨Go 1.22ä¸­ï¼Œè°ƒç”¨DeleteåŽçš„å†…å­˜æ˜¯è¿™æ ·çš„ï¼š ä¿®æ”¹åŽçš„äº”ä¸ªå‡½æ•°ä¸­çš„ä»£ç ä½¿ç”¨æ–°çš„å†…ç½®å‡½æ•°clearï¼ˆGo 1.21ï¼‰å°†è¿‡æ—¶çš„å…ƒç´ è®¾ç½®ä¸ºså…ƒç´ ç±»åž‹çš„é›¶å€¼ï¼š 1The zero value of E is nil when E is a type of pointer, slice, map, chan, or interface. æŸäº›æµ‹è¯•å¤±è´¥è¿™ä¸€å˜åŒ–å¯¼è‡´äº†ä¸€äº›åœ¨Go 1.21ä¸­é€šè¿‡çš„æµ‹è¯•åœ¨Go 1.22ä¸­å¤±è´¥ã€‚ å¦‚æžœä½ å¿½ç•¥äº†Deleteçš„è¿”å›žå€¼ï¼š 1slices.Delete(s, 2, 3) // !! é”™è¯¯ !! ç„¶åŽä½ å¯èƒ½ä¼šé”™è¯¯åœ°å‡è®¾sä¸åŒ…å«ä»»ä½•nilæŒ‡é’ˆã€‚åœ¨Go Playground ä¸­çš„ç¤ºä¾‹ã€‚ å¦‚æžœä½ å¿½ç•¥äº†Compactçš„è¿”å›žå€¼ï¼š 12slices.Sort(s) // æ­£ç¡®slices.Compact(s) // !! é”™è¯¯ !! ç„¶åŽä½ å¯èƒ½ä¼šé”™è¯¯åœ°å‡è®¾så·²ç»æ­£ç¡®æŽ’åºå’ŒåŽ‹ç¼©ã€‚ç¤ºä¾‹ã€‚ å¦‚æžœä½ å°†Deleteçš„è¿”å›žå€¼åˆ†é…ç»™å¦ä¸€ä¸ªå˜é‡ï¼Œå¹¶ç»§ç»­ä½¿ç”¨åŽŸå§‹åˆ‡ç‰‡ï¼š 1u := slices.Delete(s, 2, 3) // !! é”™è¯¯ï¼Œå¦‚æžœä½ ç»§ç»­ä½¿ç”¨ s !! ç„¶åŽä½ å¯èƒ½ä¼šé”™è¯¯åœ°å‡è®¾sä¸åŒ…å«ä»»ä½•nilæŒ‡é’ˆã€‚ç¤ºä¾‹ã€‚ å¦‚æžœä½ ä¸å°å¿ƒé®æŒ¡äº†åˆ‡ç‰‡å˜é‡ï¼Œå¹¶ç»§ç»­ä½¿ç”¨åŽŸå§‹åˆ‡ç‰‡ï¼š 1s := slices.Delete(s, 2, 3) // !! é”™è¯¯ï¼Œä½¿ç”¨ := è€Œä¸æ˜¯ = !! ç„¶åŽä½ å¯èƒ½ä¼šé”™è¯¯åœ°å‡è®¾sä¸åŒ…å«ä»»ä½•nilæŒ‡é’ˆã€‚ç¤ºä¾‹ã€‚ ç»“è®ºåˆ‡ç‰‡åŒ…çš„ API æ˜¯ä¼ ç»Ÿéžæ³›åž‹è¯­æ³•åˆ é™¤æˆ–æ’å…¥å…ƒç´ çš„æ”¹è¿›ã€‚ æˆ‘ä»¬é¼“åŠ±å¼€å‘è€…ä½¿ç”¨æ–°å‡½æ•°ï¼ŒåŒæ—¶é¿å…ä¸Šè¿°åˆ—å‡ºçš„â€œé™·é˜±â€ã€‚ ç”±äºŽæœ€è¿‘çš„å®žçŽ°å˜åŒ–ï¼Œä¸€ç±»å†…å­˜æ³„æ¼è¢«è‡ªåŠ¨é¿å…äº†ï¼Œæ— éœ€å¯¹APIè¿›è¡Œä»»ä½•æ›´æ”¹ï¼Œå¼€å‘è€…ä¹Ÿä¸éœ€è¦åšä»»ä½•é¢å¤–çš„å·¥ä½œã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åˆ†äº«æœ€è¿‘å­¦åˆ°çš„ 5 ä¸ª Golang å°æŠ€å·§]]></title>
    <url>%2F2024%2F06%2F12%2F%E5%88%86%E4%BA%AB%E6%9C%80%E8%BF%91%E5%AD%A6%E5%88%B0%E7%9A%84-5-%E4%B8%AA-Golang-%E5%B0%8F%E6%8A%80%E5%B7%A7%2F</url>
    <content type="text"><![CDATA[ä»¥ä¸‹æ˜¯æˆ‘æœ€è¿‘åœ¨ Go ä¸­å­¦åˆ°çš„ 5 ä¸ªå°æŠ€å·§ï¼Œæ„Ÿè§‰æŒºæœ‰ç”¨ä¸”å®¹æ˜“è¢«å¤§å®¶å¿½ç•¥ï¼Œåœ¨è¿™é‡Œåˆ†äº«ç»™å¤§å®¶ã€‚ è®¡ç®—æ•°ç»„å…ƒç´ çš„æ´»å¯ä»¥äº¤ç»™ç¼–è¯‘å™¨åœ¨ Go ä¸­ï¼Œæ•°ç»„çš„ä½¿ç”¨å¹¶ä¸å¤šï¼Œå¤§å®¶éƒ½ä¼šé€‰æ‹©ä½¿ç”¨ sliceã€‚åœ¨ä½¿ç”¨ slice æ—¶ï¼Œå¦‚æžœä¸æƒ³è‡ªå·±å†™æ•°ç»„ä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œå¯ä»¥ä½¿ç”¨ [â€¦] ï¼Œç¼–è¯‘å™¨ä¼šå¸®ä½ è®¡æ•°ï¼š 123456789101112package mainimport &quot;fmt&quot;func main() &#123; arr := [3]int&#123;1, 2, 3&#125; sameArr := [...]int&#123;1, 2, 3&#125; // Use ... instead of 3 // Arrays are equivalent fmt.Println(arr) fmt.Println(sameArr)&#125; ä½¿ç”¨ go run .ä»£æ›¿ go run main.goæ¯å½“æˆ‘å¼€å§‹ç”¨ Go åˆ›å»ºé¡¹ç›®æ—¶ï¼Œæˆ‘éƒ½ä¼šå…ˆåˆ›å»ºä¸€ä¸ª main.go æ–‡ä»¶ï¼š1234567891011package mainimport &quot;fmt&quot;func main() &#123; sayHello()&#125;func sayHello() &#123; fmt.Println(&quot;Hello!&quot;)&#125; ä½†å½“ main.go æ–‡ä»¶å˜å¤§æ—¶ï¼Œå°±è¦ä½¿ç”¨åŒä¸€ä¸ª main å°†ç»“æž„ä½“åˆ†å‰²åˆ°å¤šä¸ªæ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œå¦‚æžœæˆ‘æœ‰ä»¥ä¸‹æ–‡ä»¶ï¼š main.go12345package mainfunc main() &#123; sayHello()&#125; say_hello.go1234567package mainimport &quot;fmt&quot;func sayHello() &#123; fmt.Println(&quot;Hello!&quot;)&#125; è¾“å…¥ go run main.go ä¼šå‡ºçŽ°ä»¥ä¸‹é”™è¯¯ï¼š12# command-line-arguments./main.go:4:2: undefined: sayHello è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦ä½¿ç”¨ go run . ä½¿ç”¨ä¸‹åˆ’çº¿ä½¿æ•°å­—æ¸…æ™°æ˜“è¯»12345678910package mainimport &quot;fmt&quot;func main() &#123; number := 10000000 better := 10_000_000 fmt.Println(number == better)&#125; åœ¨åŒä¸€ä¸ªåŒ…ä¸­ä½¿ç”¨ä¸åŒçš„ test packageä¹‹å‰ä»¥ä¸ºæ¯ä¸ªæ–‡ä»¶å¤¹åªèƒ½æœ‰ä¸€ä¸ª go packageã€‚åŽæ¥å‘çŽ°å¯¹äºŽåä¸º yourpackage çš„åŒ…ï¼Œä½ å¯ä»¥åœ¨åŒä¸€ç›®å½•ä¸‹æ‹¥æœ‰å¦ä¸€ä¸ªåä¸º yourpackage_test çš„åŒ…ï¼Œå¹¶åœ¨å…¶ä¸­ç¼–å†™æµ‹è¯•ã€‚ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšå‘¢ï¼Ÿå› ä¸ºè¿™æ ·å¯ä»¥ä½¿ç”¨ç›¸åŒçš„åŒ… yourpackage æ¥ç¼–å†™æµ‹è¯•ï¼Œæ‰€ä»¥æœªå¯¼å‡ºçš„å‡½æ•°ä¹Ÿä¼šå¯ç”¨ã€‚é€šè¿‡åœ¨ yourpackage_test ä¸­ç¼–å†™æµ‹è¯•ï¼Œå¯ä»¥ç¡®ä¿åªæµ‹è¯•æš´éœ²çš„è¡Œä¸ºã€‚ å¤šæ¬¡ä¼ é€’ç›¸åŒå‚æ•°åœ¨ä½¿ç”¨å­—ç¬¦ä¸²æ ¼å¼åŒ–å‡½æ•°æ—¶ï¼Œæ€»è§‰å¾—å¿…é¡»é‡å¤ä½¿ç”¨å¤šæ¬¡çš„å‚æ•°æ˜¯å¾ˆç¹ççš„äº‹æƒ…ï¼š12345678package mainimport &quot;fmt&quot;func main() &#123; name := &quot;Bob&quot; fmt.Printf(&quot;My name is %s. Yes, you heard that right: %s\n&quot;, name, name)&#125; è¿˜æœ‰ä¸€ç§æ›´æ–¹ä¾¿çš„æ–¹æ³•ã€‚å¯ä»¥åªä¼ é€’ä¸€æ¬¡å‚æ•°ï¼Œå¹¶åœ¨ %s åŠ¨è¯ä¸­ä½¿ç”¨ %[order]sï¼š 12345678package mainimport &quot;fmt&quot;func main() &#123; name := &quot;Bob&quot; fmt.Printf(&quot;My name is %[1]s. Yes, you heard that right: %[1]s\n&quot;, name)&#125; å¸Œæœ›å¤§å®¶ä»Šå¤©èƒ½å­¦åˆ°ä¸€äº›æ–°ä¸œè¥¿ã€‚å¦‚æžœä½ ä¹Ÿæœ‰ä¸€äº› golang å°æŠ€å·§ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€åˆ†äº«ï¼]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¿«é€Ÿåƒé€ Golang Channels]]></title>
    <url>%2F2024%2F06%2F08%2F%E5%BF%AB%E9%80%9F%E5%90%83%E9%80%8F-Golang-Channels%2F</url>
    <content type="text"><![CDATA[Golang å¯ä»¥é€šè¿‡å¯åŠ¨ goroutines æ¥å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚å®ƒä»¬å¯ä»¥é€šè¿‡ä¸€ç§åä¸º â€œé€šé“â€çš„é€šä¿¡åª’ä»‹ç›¸äº’é€šä¿¡ã€‚è¯ä¸å¤šè¯´ï¼Œä¸‹é¢æˆ‘åˆ—ä¸¾äº†å‡ ç§ä¸åŒæƒ…å†µä¸‹ channel çš„ä½¿ç”¨ä»¥åŠå…¶é€‚ç”¨æ¡ä»¶ï¼Œæœ€åŽæ€»ç»“å‡ºä¸€å¼  channel tableï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ å¿«é€Ÿåƒé€ channel çš„æ‰€æœ‰è¦ç‚¹ã€‚Letâ€™t go! Nil Channelså¦‚æžœä½ åƒåˆ›å»ºæ™®é€šå˜é‡ä¸€æ ·åˆ›å»ºä¸€ä¸ªé€šé“ï¼Œé€šé“å°†è¢«åˆå§‹åŒ–ä¸ºé›¶å€¼ã€‚è¿™é‡Œè¦æåˆ°çš„å¦ä¸€ä¸ªé‡è¦ç»†èŠ‚æ˜¯ï¼Œé€šé“çš„å‘é€æ–¹å’ŒæŽ¥æ”¶æ–¹éƒ½å¿…é¡»åšå¥½é€šä¿¡å‡†å¤‡ï¼Œå¦åˆ™æˆ‘ä»¬å°†æ”¶åˆ°ä¸€ä¸ªæ­»é”é”™è¯¯ã€‚è¿™å¯ä»¥é€šè¿‡ç¼“å†²é€šé“æ¥é¿å…ï¼Œæˆ‘ä»¬å°†åœ¨åŽé¢è®¨è®ºã€‚ 1234567891011// NOTE: Deadlockfunc nilChannel() &#123; var ch chan int// creating a goroutine and sending value on the channel go func() &#123; ch &lt;- 1 &#125;() fmt.Println(&lt;-ch)&#125; å¦‚æžœä½ åœ¨ main ä¸­è°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œä½ ä¼šå¾—åˆ°ä»¥ä¸‹é”™è¯¯å’Œä¸€äº›å…¶ä»–ä¿¡æ¯ã€‚1fatal error: all goroutines are asleep - deadlock! è¿™æ˜¯å› ä¸ºæˆ‘ä»¬è¯•å›¾åœ¨å¾€ nil channelä¸Šå‘é€ä¸€ä¸ªå€¼ï¼Œè¿™æ˜¯åšå†³ä¸å…è®¸çš„æ“ä½œã€‚ Empty Channelåœ¨ä»¥ä¸‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬å°†æ”¶åˆ°åŒæ ·çš„æ­»é”é”™è¯¯ï¼Œå› ä¸ºæˆ‘ä»¬æ­£è¯•å›¾åœ¨ channel receiver å°šæœªå‡†å¤‡å¥½çš„é€šé“ä¸Šå‘é€å€¼ã€‚ä»Žä¸‹é¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œåœ¨æŽ¥æ”¶å™¨åˆ›å»ºä¹‹å‰ï¼Œå€¼å°±å·²ç»åœ¨é€šé“ä¸Šå‘é€äº†ã€‚ 12345678// NOTE: Deadlockfunc emptyChannel() &#123; var ch = make(chan int) ch &lt;- 1 fmt.Println(&lt;-ch)&#125; UN Buffered Channelé”™è¯¯çš„ä»£ç å·²ç»å¤Ÿå¤šäº†ã€‚è¿™æ¬¡è®©æˆ‘ç»™å‡ºä¸€ä¸ªæœ‰æ•ˆçš„ä»£ç ã€‚åœ¨ä¸‹é¢çš„ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç¼–å†™äº†ä¸Žä¸Šä¸€ä¸ªç¤ºä¾‹ç›¸åŒçš„ä»£ç ï¼Œä½†ä¸æ˜¯åˆ›å»ºä¸€ä¸ª nil é€šé“ï¼Œè€Œæ˜¯ä½¿ç”¨ make å‡½æ•°åˆ›å»ºäº†ä¸€ä¸ªç”¨é»˜è®¤å€¼åˆå§‹åŒ–çš„é€šé“ã€‚ ä¸è¿‡ï¼Œå¦‚æžœåœ¨è¿™ç§æƒ…å†µä¸‹æ²¡æœ‰æŽ¥æ”¶å™¨ï¼Œå°±ä¼šé”™è¿‡ç»“æžœï¼Œä½†ä¸ä¼šäº§ç”Ÿæ­»é”é”™è¯¯ã€‚1234567891011// NOTE: send single value through goroutinefunc simpleChannel() &#123; var ch = make(chan int) go func() &#123; ch &lt;- 1 &#125;()// NOTE: if you comment this line. You will not be able to receive the result but code will not crash fmt.Println(&lt;-ch)&#125; Channel æ–¹å‘é»˜è®¤æƒ…å†µä¸‹é€šé“æ˜¯åŒå‘çš„ã€‚ä¸‹é¢çš„ä»£ç æ˜¾ç¤ºäº†ä¸€ä¸ªåªèƒ½ç”¨äºŽå‘é€å€¼çš„é€šé“ã€‚å¦‚æžœæˆ‘ä»¬è¯•å›¾ä»Žä¸­èŽ·å–å€¼ï¼Œå°±ä¼šå‡ºé”™ã€‚1234567891011func uniDirectionalChannel() &#123;// Bidirectional [outside goroutine] var ch = make(chan int) go func(ch chan&lt;- int) &#123; // unidirectinal [within goroutine] ch &lt;- 1 &#125;(ch) fmt.Println(&lt;-ch)&#125; Buffered Channelè¿™äº›é€šé“å¯ä»¥åƒæ•°ç»„ä¸€æ ·å®¹çº³å¤šä¸ªå€¼ï¼Œå› æ­¤åœ¨éžç¼“å†²é€šé“ä¸­ï¼Œå¦‚æžœæˆ‘ä»¬å°è¯•åœ¨æ²¡æœ‰æŽ¥æ”¶å™¨çš„æƒ…å†µä¸‹å‘å…¶å†™å…¥æ•°æ®ï¼Œå°±ä¼šå‡ºé”™ï¼Œä½†åœ¨ç¼“å†²é€šé“ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å‘å…¶å†™å…¥æ•°æ®ï¼Œç›´åˆ°ç¼“å†²åŒºæ»¡ä¸ºæ­¢ã€‚å½“ç¼“å†²åŒºå·²æ»¡æ—¶ï¼Œå¦‚æžœæˆ‘ä»¬å°è¯•å‘å…¶ä¸­å†™å…¥æ–°å€¼ï¼Œå°±ä¼šå‡ºé”™ã€‚å¦‚æžœæˆ‘ä»¬è¿™é‡Œä¸æ³¨é‡Šè¯¥å‡½æ•°çš„æœ€åŽä¸€è¡Œï¼Œå°±ä¼šå‡ºçŽ°æ­»é”é”™è¯¯ï¼Œå› ä¸ºè¿™é‡Œå°†ä»Žç©ºé€šé“è¯»å–æ•°æ®ã€‚ 1234567891011// using buffered channelfunc bufferdChannelWithoutLoop() &#123; var ch = make(chan int, 2) ch &lt;- 1 ch &lt;- 2 fmt.Println(&lt;-ch) fmt.Println(&lt;-ch) // fmt.Println(&lt;-ch) // NOTE: Deadlock, Reading from empty channel&#125; ä»Žé€šé“è¯»å–æ•°å€¼è¿˜æœ‰å¦ä¸€ç§æ–¹æ³•ï¼Œå³ä½¿ç”¨å¾ªçŽ¯ã€‚åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬é€ä¸ªè¯»å–æ•°å€¼ï¼Œä½†æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡å¾ªçŽ¯è¯»å–æŽ¥æ”¶é€šé“ä¸­çš„æ•°å€¼ï¼Œå› æ­¤æ¯å½“é€šé“ä¸­å‘é€ä¸€ä¸ªæ–°æ•°å€¼æ—¶ï¼Œå¾ªçŽ¯å°±ä¼šè¿­ä»£ï¼Œæ‰§è¡Œå®Œæ­£æ–‡ä¸­çš„ä»£ç åŽï¼Œå°±ä¼šç­‰å¾…ä¸‹ä¸€ä¸ªæ•°å€¼ã€‚å¦‚æžœæŽ¥æ”¶å™¨è¯•å›¾è¯»å–ï¼Œä½†é€šé“ä¸Šå·²æ²¡æœ‰å…¶ä»–å€¼ï¼Œåˆ™ä¼šå‡ºçŽ°åŒæ ·çš„æ­»é”é”™è¯¯ã€‚ å¼€å‘äººå‘˜çš„èŒè´£æ˜¯åœ¨é€šé“ä½¿ç”¨åŽå°†å…¶å…³é—­ï¼Œå› ä¸ºå¦‚æžœæŽ¥æ”¶å™¨è¯•å›¾è¯»å–å·²ç»å…³é—­çš„é€šé“ï¼Œå°±ä¼šå‡ºçŽ°ä¸Šè¿°æ­»é”é—®é¢˜ã€‚ Channels Tableæˆ‘ä»¬å·²ç»è®¨è®ºäº†é€šé“çš„æ‰€æœ‰æƒ…å†µï¼Œä½†æ€Žä¹ˆæ‰èƒ½å¿«é€Ÿè®°ä½å®ƒä»¬å‘¢ï¼Ÿ åˆ«ç´§å¼ ðŸ˜Žï¼Œæœ‰æˆ‘åœ¨ï¼Œä¸‹è¡¨å¯ä»¥ä½œä¸ºå¿«é€ŸæŒ‡å—ï¼Œå¯¹ç…§ç€è¡¨ç›˜ä¸€ä¸‹æˆ‘ä»¬å†™çš„ channel å°±èƒ½é¿å…å‡ºçŽ°æ­»é”ï¼Œå¹¶æ˜¾ç¤ºå®ƒä»¬åœ¨ä¸åŒæƒ…å†µä¸‹çš„è¡Œä¸ºã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang GC åŸºç¡€: ä¸‰è‰²æ ‡è®°æ¸…é™¤å’Œ STW]]></title>
    <url>%2F2024%2F06%2F06%2FGolang-GC-%E5%9F%BA%E7%A1%80-%E4%B8%89%E8%89%B2%E6%A0%87%E8%AE%B0%E6%B8%85%E9%99%A4%E5%92%8C-STW%2F</url>
    <content type="text"><![CDATA[ä»Šå¤©å¤§å®¶è®¨è®ºä¸€ä¸‹ Golang ä¸­åžƒåœ¾å›žæ”¶çš„ä¸€äº›åŸºç¡€çŸ¥è¯†ï¼Œè¿™äº›çŸ¥è¯†å¾€å¾€è®©äººéš¾ä»¥ç†è§£ã€‚è¦çŸ¥é“ï¼Œåœ¨åžƒåœ¾å›žæ”¶è¿‡ç¨‹ä¸­ï¼ŒGo ä¼šé¦–å…ˆ:ï¼ˆ1ï¼‰å°†æ ¹å¯¹è±¡æ ‡è®°ä¸ºç°è‰²ï¼Œï¼ˆ2ï¼‰ç„¶åŽå°†å®ƒä»¬è‡ªå·±æ ‡è®°ä¸ºé»‘è‰²ï¼Œå°†å®ƒä»¬çš„åŽä»£æ ‡è®°ä¸ºç°è‰²ï¼Œï¼ˆ3ï¼‰æœ€åŽåˆ é™¤å‰©ä½™çš„ï¼ˆç™½è‰²ï¼‰å¯¹è±¡ã€‚è¿™å°±æ˜¯æ‰€è°“çš„æ ‡è®°å’Œæ¸…é™¤ã€‚ä½†ä¸ºä»€ä¹ˆæˆ‘ä»¬éœ€è¦ä¸‰ç§é¢œè‰²å‘¢ï¼Ÿä¸ºä»€ä¹ˆä¸æ˜¯ä¸¤ç§å‘¢ï¼Ÿè®©æˆ‘ä»¬åœ¨ä¸‹æ–‡ä¸­è¿›ä¸€æ­¥è®¨è®ºè¿™ä¸ªé—®é¢˜ï¼Œå¹¶ç¡®å®š STW (stop the world)çš„å®žé™…å¼€é”€ã€‚ æ ‡è®°å’Œæ¸…é™¤å¦‚æžœ GC çš„å…¨éƒ¨ä»»åŠ¡éƒ½å½’ç»“ä¸ºæ ‡è®°ä¸èƒ½åˆ é™¤çš„å¯¹è±¡å’Œåˆ é™¤æœªæ ‡è®°çš„å¯¹è±¡ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸ä½¿ç”¨åŒè‰²ç®—æ³•å‘¢ï¼Ÿäº‹å®žä¸Šï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°ç”¨é»‘è‰²æ ‡è®°æ‰€æœ‰å¯åˆ°è¾¾çš„å¯¹è±¡ï¼Œç„¶åŽåˆ é™¤ç™½è‰²çš„å¯¹è±¡ã€‚ è¿™ä¸€åˆ‡ä¼¼ä¹Žéƒ½åˆä¹Žé€»è¾‘ï¼Œä½†çŽ°åœ¨æˆ‘ä»¬å†³å®šè®©åžƒåœ¾å›žæ”¶å™¨å¢žé‡è¿è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬èµ‹äºˆå®ƒå°†æ ‡è®°é˜¶æ®µåˆ†æˆå‡ ä¸ªä½Žå»¶è¿Ÿé˜¶æ®µçš„èƒ½åŠ›ã€‚ å¦‚å›¾æ‰€ç¤ºï¼Œåœ¨ç¬¬ä¸€é˜¶æ®µï¼Œæˆ‘ä»¬é¦–å…ˆå°†èŠ‚ç‚¹ 1 æ ‡è®°ä¸ºé»‘è‰²ï¼Œç„¶åŽæŸ¥æ‰¾è¯¥èŠ‚ç‚¹çš„è¿žæŽ¥ï¼Œæ‰¾åˆ°èŠ‚ç‚¹ 2ï¼Œå¹¶å°†å…¶ä¹Ÿæ ‡è®°ä¸ºé»‘è‰²ã€‚ç„¶åŽï¼Œæ ‡è®°æš‚åœï¼Œç»™åº”ç”¨ç¨‹åºä¸€ç‚¹ CPU æ—¶é—´æ¥æ‰§è¡Œå…¶ä¸»è¦ä»»åŠ¡ã€‚æœ€åŽï¼Œæˆ‘ä»¬è¿›å…¥ç¬¬äºŒé˜¶æ®µæ ‡è®°ã€‚ç”±äºŽæ²¡æœ‰ç°è‰²/é»‘è‰²ä¹‹åˆ†ï¼Œæˆ‘ä»¬ä¸çŸ¥é“èŠ‚ç‚¹ 1 çš„å¼•ç”¨æ˜¯å¦å·²è¢«æ£€æŸ¥è¿‡ï¼Œå› æ­¤å¿…é¡»å†æ¬¡æ£€æŸ¥ã€‚ç®—æ³•æœ€ç»ˆå¾ˆå¯èƒ½ä¼šå®Œæˆï¼Œä½†ä¸èƒ½ä¿è¯å®ƒä¼šåœ¨ç¨‹åºæœ¬èº«å®Œæˆä¹‹å‰å®Œæˆï¼ˆå¯¼è‡´ OOMï¼‰ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¢žåŠ äº†ä¸€ä¸ªä¸å˜é‡ï¼šé»‘è‰²ç‰©ä½“åº”è¢«è§†ä¸ºæ‰«æå¯¹è±¡ã€‚ è¿™ä¸ªç®—æ³•ä¼¼ä¹Žæ˜¯æœ‰æ•ˆçš„ï¼Œå³ä½¿åœ¨å¢žé‡åžƒåœ¾å›žæ”¶çš„æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£ç¡®ç»ˆæ­¢ã€‚ä½†æœ‰ä¸€ä¸ªé—®é¢˜å´æ‰“ç ´äº†ä¸€åˆ‡ï¼šåœ¨è¿™ç§å¤©çœŸç‰ˆæœ¬çš„æ ‡è®°å’Œæ¸…æ‰«ç®—æ³•çš„æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»ä¿æŒç¨‹åºå¤„äºŽ â€œSTWâ€çŠ¶æ€ã€‚ å¦‚æžœåœ¨æ²¡æœ‰ STW çš„æƒ…å†µä¸‹è¿›è¡Œæ ‡è®°å’Œæ¸…æ‰«ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆæƒ…å†µï¼Ÿ æ­£å¦‚ä½ æ‰€çœ‹åˆ°çš„ï¼Œåœ¨è¿™ä¸¤ä¸ªæ ‡è®°é˜¶æ®µä¹‹é—´ï¼Œå·²ç»æ·»åŠ äº†è®¸å¤šæ–°å¯¹è±¡ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰æ ‡è®°è¡¨æ˜Žéœ€è¦å¯¹å®ƒä»¬è¿›è¡Œæ‰«æã€‚è¿™å°±å¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚å”¯ä¸€çš„è§£å†³åŠžæ³•å°±æ˜¯ç¦æ­¢æˆ‘ä»¬çš„ç¨‹åºï¼ˆçªå˜å™¨ï¼‰åœ¨åžƒåœ¾å›žæ”¶å™¨è¿è¡Œæ—¶è¿›è¡Œä»»ä½•æ›´æ”¹ã€‚ ä¸‰è‰²æ ‡è®°å’Œæ¸…æ‰«æ˜¯å¦‚ä½•å®žçŽ°å¹¶å‘åžƒåœ¾å›žæ”¶çš„ï¼Ÿæ­£å¦‚æˆ‘ä»¬ä¹‹å‰æ‰€å‘çŽ°çš„ï¼Œåœ¨æ ‡è®°å’Œæ‰«æç®—æ³•ä¸­ï¼Œæˆ‘ä»¬é‡åˆ°äº† â€œä¸–ç•Œåœæ­¢â€ï¼ˆSTWï¼‰çš„é—®é¢˜ã€‚ä¸è¿‡ï¼Œå¦‚æžœæˆ‘ä»¬å¼•å…¥ä¸€ä¸ªé¢å¤–çš„æ ‡è®° â€œæœªæ‰«æä½†ä¸ç¬¦åˆåˆ é™¤æ¡ä»¶â€ï¼ˆç°è‰²ï¼‰ï¼ŒSTW é—®é¢˜å°±ä¼šè‡ªåŠ¨è§£å†³ï¼ éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨ Golang ä¸­ï¼ŒGC ä¸ä»…æ˜¯å¢žé‡å¼çš„ï¼Œè€Œä¸”æ˜¯å¹¶å‘å¼çš„ã€‚å…¶é€»è¾‘ä¸Žå¢žé‡æ–¹æ³•ç›¸åŒâ€“GC å·¥ä½œè¢«åˆ†ä¸ºä¸åŒçš„éƒ¨åˆ†ï¼Œä½†å®ƒä»¬ä¸æ˜¯æŒ‰é¡ºåºæ‰§è¡Œï¼Œè€Œæ˜¯ç”±åŽå°å·¥ä½œè€…å¹¶å‘æ‰§è¡Œã€‚ ä¸‹é¢æ˜¯ Golang ä¸­çš„ä¸‰è‰²æ ‡è®°ï¼š æˆ‘ä»¬å°†é»‘è‰²èŠ‚ç‚¹å¼•ç”¨ä½†å°šæœªæ‰«æçš„å¯¹è±¡æ ‡è®°ä¸ºç°è‰²èŠ‚ç‚¹ã€‚è®©æˆ‘ä»¬çœ‹çœ‹è¿™å¦‚ä½•å¸®åŠ©æˆ‘ä»¬æ¶ˆé™¤ STWã€‚ æ–°æ·»åŠ çš„å¯¹è±¡ä¼šè¢«æ ‡è®°ä¸ºç°è‰²ï¼Œå¹¶ç”± gcBgMarkWorker2 æˆ–å…¶ä»–å¯ç”¨çš„å·¥ä½œç¨‹åºè¿›è¡Œæ‰«æã€‚è¿™å¹¶ä¸èƒ½å®Œå…¨æ¶ˆé™¤å¯¹ STW çš„éœ€æ±‚ï¼Œä½†ä¼šå¤§å¤§å‡å°‘èŠ±è´¹åœ¨ STW ä¸Šçš„æ—¶é—´ã€‚è‡³å°‘åœ¨æ ‡è®°é˜¶æ®µï¼Œæˆ‘ä»¬ä¸éœ€è¦è®©ä¸–ç•Œåœæ­¢è¿è¡Œï¼Œä»¥é˜²æ­¢å †å‘ç”Ÿå˜åŒ–ã€‚æŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥æŽ¢è®¨ Golang ä¸­ä»ä¼šå‡ºçŽ°çš„ç‰¹å®š STWã€‚ â€œStop the worldâ€ in Go is not a problemå…¶å®žï¼Œä»”ç»†æƒ³æƒ³ï¼Œåœ¨ 99% çš„æƒ…å†µä¸‹ï¼Œè¿™éƒ½ä¸Žä½ æ— å…³ã€‚åžƒåœ¾å›žæ”¶å™¨çš„ä¸»è¦å·¥ä½œä¸Žç¨‹åºçš„æ‰§è¡ŒåŒæ—¶è¿›è¡Œï¼Œè€Œ STW åœ¨ä¸¤ä¸ªé˜¶æ®µä¹‹é—´å‘ç”Ÿçš„æ—¶é—´å¾ˆçŸ­ï¼š ä»Žæ‰«é¢‘è¿‡æ¸¡åˆ°æ ‡è®°ï¼ˆæ‰«é¢‘ç»ˆæ­¢ï¼‰ã€‚ ä»Žæ ‡è®°è¿‡æ¸¡åˆ°æ‰«æï¼ˆæ ‡è®°ç»ˆæ­¢ï¼‰ã€‚ åœ¨è¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œä¸–ç•Œçš„åœé¡¿éƒ½æ˜¯ä¸ºäº†ä¸‹ä¸€é˜¶æ®µåšå‡†å¤‡ï¼šå¯åŠ¨ Workerã€æ¸…é™¤ P ç¼“å­˜ï¼ˆç”¨ Go è°ƒåº¦å™¨æœ¯è¯­æ¥è¯´å°±æ˜¯å¤„ç†å™¨ï¼‰ã€ç­‰å¾…æ¸…æ‰«é˜¶æ®µå®Œæˆï¼ˆå¯¹äºŽåœ¨è¿è¡Œæ—¶å¯åŠ¨åžƒåœ¾å›žæ”¶çš„åŒæ—¶ä»Žç¨‹åºä»£ç ä¸­è§¦å‘ runtime.GC()çš„æƒ…å†µï¼‰ã€è®¾ç½®/å–æ¶ˆå†™å…¥éšœç¢â€“è€Œè¿™ä¸€åˆ‡éƒ½ä¸Žå·²åˆ†é…å¯¹è±¡çš„æ•°é‡æ— å…³ã€‚ å¦‚æžœä½ åˆ†é…äº† 1 å…†å­—èŠ‚ï¼Œç„¶åŽå¼€å§‹åˆ†é…åƒå…†å­—èŠ‚çš„å¯¹è±¡ï¼Œè¿™å¹¶ä¸æ„å‘³ç€ STW ä¼šæŒ‰æ¯”ä¾‹å¢žé•¿ï¼Œå› ä¸º STW åªåœ¨ä¸‹ä¸€ä¸ªæ ‡è®°æˆ–æ‰«æé˜¶æ®µçš„åˆå§‹åŒ–è¿‡ç¨‹ä¸­çŸ­æš‚éœ€è¦ã€‚è¯¥æ•°æ®æ•°ç»„çš„å®žé™…æ ‡è®°å’Œæ‰«ææ˜¯åœ¨åŽå°è¿›è¡Œçš„ã€‚ STW çš„æŒç»­æ—¶é—´å–å†³äºŽæ‰€æ¶‰åŠçš„ P çš„æ•°é‡å’Œ goroutines çš„æ•°é‡ï¼Œå¹¶ä¸Žç®¡ç†å…¶çŠ¶æ€çš„éœ€è¦æœ‰å…³ã€‚STW ä¸å—å †ä¸Šåˆ†é…æ•°é‡çš„å½±å“ã€‚ ä¸–ç•Œåªåœ¨ä¸¤ä¸ªçŸ­æ—¶é—´å†…åœæ­¢ï¼šæ ‡è®°ç»ˆæ­¢å’Œæ‰«æç»ˆæ­¢ã€‚æ ‡è®°å’Œæ‰«æåœ¨åŽå°è¿›è¡Œï¼Œä¸ä¼šé˜»å¡žåº”ç”¨ç¨‹åºã€‚ Benchmarkè¿™é‡Œåšä¸€ä¸ªç®€å•çš„æµ‹è¯•ï¼Œæµ‹è¯•ä¸¤ç§åˆ†é…å°å¯¹è±¡çš„æƒ…å†µã€‚æˆ‘ä½¿ç”¨ env GOGC=off ç¦ç”¨äº†åžƒåœ¾å›žæ”¶å™¨ï¼Œå¹¶åœ¨æ¯æ¬¡æµ‹è¯•ç»“æŸæ—¶ç›´æŽ¥è°ƒç”¨ runtime.GC() æ¥è§¦å‘åžƒåœ¾å›žæ”¶ï¼š 12345678910111213141516171819202122232425262728293031323334353637func Test1000Allocs(t *testing.T) &#123; go func() &#123; for &#123; i := 123 reader(&amp;i) &#125; &#125;() for i := 0; i &lt; 1000; i++ &#123; ii := i i = *reader(&amp;ii) &#125; runtime.GC()&#125;func Test10000000000Allocs(t *testing.T) &#123; go func() &#123; for &#123; i := 123 reader(&amp;i) &#125; &#125;() for i := 0; i &lt; 10000000000; i++ &#123; ii := i i = *reader(&amp;ii) &#125; runtime.GC()&#125;//go:noinlinefunc reader(i *int) *int &#123; ii := i return ii&#125; æˆ‘ä»¬è¿è¡Œæ¯ä¸ªæµ‹è¯•æ—¶éƒ½å¯ç”¨äº†è·Ÿè¸ªä¿¡æ¯ï¼š 1234GOGC=off go test -run=Test1000Allocs -trace=trace1.outGOGC=off go test -run=Test10000000000Allocs -trace=trace2.outgo tool trace trace1.outgo tool trace trace2.out Test1000Allocs Test10000000000Allocs Test10000000000Allocs åœ¨ Test1000Allocs æµ‹è¯•çš„æ‰«æç»ˆæ­¢é˜¶æ®µï¼ŒSTW ä¸º 80384 nsã€‚æµ‹è¯• 10000000000Allocs æ—¶ä¸º 88384 nsã€‚æœ‰åŒºåˆ«å—ï¼Ÿæˆ‘ä¹Ÿæ²¡å‘çŽ°ã€‚ åœ¨ Test1000Allocs æµ‹è¯•çš„æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼ŒSTW ä¸º 87616 nsã€‚æµ‹è¯• 10000000000Allocs æ—¶ä¸º 120128 æ¯«å¾®ç§’ã€‚è¿™é‡Œçš„å·®å¼‚æ›´ä¸ºæ˜Žæ˜¾ï¼Œä½†æˆ‘ä»¬è°ˆè®ºçš„è¿˜æ˜¯æ¯«ç§’çº§çš„å¾®å°å·®å¼‚ã€‚åœ¨ GC è¿è¡Œçš„å¤§éƒ¨åˆ†æ—¶é—´é‡Œï¼Œæˆ‘ä»¬çš„ç¨‹åºæˆåŠŸå¹¶è¡Œè¿è¡Œã€‚ åœ¨åˆ†é…æ•°é‡å¤šã€GOGC å€¼ä½Žçš„æƒ…å†µä¸‹ï¼Œè¿™äº›å¸¦æœ‰å° STW é˜¶æ®µçš„çŸ­ GC å¾ªçŽ¯å¯èƒ½ä¼šé¢‘ç¹å‡ºçŽ°ï¼Œå¹¶å¯èƒ½è¢«è§†ä¸ºä¸€ä¸ªé—®é¢˜ã€‚ç”±äºŽæˆ‘ç¦ç”¨äº† GCï¼Œå¹¶ä¸”åªé€šè¿‡ç›´æŽ¥è°ƒç”¨è§¦å‘äº†ä¸€æ¬¡ï¼Œæ‰€ä»¥æµ‹è¯•æœ‰ç‚¹åƒæ˜¯åˆæˆçš„ã€‚ä½†è¿™æ°æ°è¯´æ˜Žï¼Œæœ‰æ—¶å€¼å¾—è€ƒè™‘æ‰€é€‰çš„ GOGC å€¼ã€‚ æ€»ä¹‹ï¼ŒGolang ä¸­çš„åžƒåœ¾å›žæ”¶å™¨æ˜¾ç„¶æ˜¯å¹¶å‘è¿è¡Œçš„ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒSTW æ—¶çš„åœé¡¿éƒ½æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„é—®é¢˜ã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨ Golang æž„å»ºä½ çš„ç¬¬ä¸€ä¸ª k8s Operator]]></title>
    <url>%2F2024%2F06%2F03%2F%E4%BD%BF%E7%94%A8-Golang-%E6%9E%84%E5%BB%BA%E4%BD%A0%E7%9A%84%E7%AC%AC%E4%B8%80%E4%B8%AA-k8s-Operator%2F</url>
    <content type="text"><![CDATA[ä½¿ç”¨ Golang æž„å»ºä½ çš„ç¬¬ä¸€ä¸ª k8s Operator æœ¬æ–‡å°†å±•ç¤ºå¦‚ä½•ä½¿ç”¨ Operator SDK æ­å»ºä¸€ä¸ªåŸºæœ¬çš„ k8s Operatorã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæ‚¨å°†äº†è§£å¦‚ä½•åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œå¹¶é€šè¿‡åˆ›å»ºè‡ªå®šä¹‰èµ„æºå®šä¹‰ (CRD) å’ŒåŸºæœ¬æŽ§åˆ¶å™¨æ¥æ·»åŠ  APIã€‚ æˆ‘ä»¬å°†åœ¨ CRD ä¸­æ·»åŠ å­—æ®µï¼Œä»¥åŒ…å«ä¸€äº›æœ‰å…³æœŸæœ›çŠ¶æ€å’Œå®žé™…çŠ¶æ€çš„ä¿¡æ¯ï¼Œä¿®æ”¹æŽ§åˆ¶å™¨ä»¥è°ƒå’Œæ–°èµ„æºçš„å®žä¾‹ï¼Œç„¶åŽå°† operator éƒ¨ç½²åˆ° Kubernetes é›†ç¾¤ã€‚ Prerequisites å®‰è£… Operator-sdk v1.5.0+ å®‰è£… Kubectl v1.17.0+ ä¸€ä¸ª Kubernetes é›†ç¾¤ä»¥åŠå…¶ç®¡ç†è®¿é—®æƒé™ å®‰è£… Docker v3.2.2+ ç‰ˆæœ¬ å®‰è£… Golang v1.16.0+ ç‰ˆæœ¬ Step 1: Create a projectå»ºä¸€ä¸ªç›®å½•ï¼Œå¹¶åˆå§‹åŒ–ä¸€ä¸ª operator é¡¹ç›®ï¼š 123456789101112131415161718$ mkdir memcached-operator$ cd memcached-operator$ operator-sdk init --domain=example.com --repo=github.com/example/memcached-operatorWriting scaffold for you to edit...Get controller runtime:$ go get sigs.k8s.io/controller-runtime@v0.7.0Update go.mod:$ go mod tidyRunning make:$ makego: creating new go.mod: module tmpDownloading sigs.k8s.io/controller-tools/cmd/controller-gen@v0.4.1go: found sigs.k8s.io/controller-tools/cmd/controller-gen in sigs.k8s.io/controller-tools v0.4.1/Users/username/workspace/projects/memcached-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;go fmt ./...go vet ./...go build -o bin/manager main.go 1operator-sdk init â€” domain=example.com â€” repo=github.com/example/memcached-operator domin ç”¨äºŽ operator åˆ›å»ºçš„ä»»ä½• API Groupï¼Œå› æ­¤è¿™é‡Œçš„ API Group æ˜¯ *.example.comã€‚ å¤§å®¶å¯èƒ½ç†Ÿæ‚‰çš„ä¸€ä¸ª API Group æ˜¯ rbac.authorization.k8s.ioï¼Œåˆ›å»º RBAC èµ„æºï¼ˆå¦‚ ClusterRoles å’Œ ClusterBindingsï¼‰çš„åŠŸèƒ½é€šå¸¸å°±è®¾ç½®åœ¨ Kubernetes é›†ç¾¤ä¸Šã€‚operator-sdk å…è®¸æ‚¨æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰åŸŸï¼Œå°†å…¶é™„åŠ åˆ°æ‚¨å®šä¹‰çš„ä»»ä½• API ç»„ï¼Œä»¥å¸®åŠ©é¿å…åç§°å†²çªã€‚ è¿™é‡Œä½¿ç”¨çš„ â€“repo å€¼åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚å¦‚æžœä½ æƒ³æäº¤é¡¹ç›®å¹¶ä¿ç•™å®ƒï¼Œå¯ä»¥å°†å…¶è®¾ç½®ä¸ºä½ å¯ä»¥è®¿é—®çš„ Git ä»“åº“ã€‚ é¡¹ç›®åˆå§‹åŒ–åŽä¼šç”Ÿç”Ÿä¸€ä¸ª Operator é¡¹ç›®çš„å£³å­ï¼Œæˆ‘ä»¬å‰©ä¸‹çš„å·¥ä½œå°±æ˜¯åœ¨è¿™ä¸ªæ¡†æž¶ä¹‹ä¸Šï¼Œå®žçŽ° operator çš„åŠŸèƒ½ã€‚ Step 2: Create an APIä½¿ç”¨ create å‘½ä»¤ç”Ÿæˆ CRD å’ŒæŽ§åˆ¶å™¨ï¼š æ³¨æ„ï¼šâ€“version æ ‡å¿—é’ˆå¯¹çš„æ˜¯æ“ä½œç¬¦çš„ Kubernetes API ç‰ˆæœ¬ï¼Œè€Œä¸æ˜¯è¯­ä¹‰ç‰ˆæœ¬ã€‚å› æ­¤ï¼Œè¯·å‹¿åœ¨ â€“version ä¸­ä½¿ç”¨ 12345678910111213$ operator-sdk create api --group cache --version v1alpha1 --kind Memcached --resource=true --controller=trueWriting scaffold for you to edit...api/v1alpha1/memcached_types.gocontrollers/memcached_controller.goRunning make:$ make/Users/username/workspace/projects/memcached-operator/bin/controller-gen object:headerFile=&quot;hack/boilerplate.go.txt&quot; paths=&quot;./...&quot;go fmt ./...go vet ./...go build -o bin/manager main.go --group æ˜¯è‡ªå®šä¹‰èµ„æºæ‰€åœ¨çš„ç»„ï¼Œå› æ­¤å®ƒæœ€ç»ˆä¼šå‡ºçŽ°åœ¨ API Group â€œcache.example.com â€œä¸­ã€‚ --version å†³å®š API Group çš„ç‰ˆæœ¬ã€‚å¯ä»¥ä½¿ç”¨ä¸åŒçš„ç‰ˆæœ¬è¿žç»­å‡çº§è‡ªå®šä¹‰èµ„æºã€‚ -resource å’Œ --controller æ ‡å¿—è®¾ç½®ä¸º â€œtrueâ€ï¼Œä»¥ä¾¿ä¸ºè¿™ä¸¤æ ·ä¸œè¥¿ç”Ÿæˆè„šæ‰‹æž¶ã€‚ çŽ°åœ¨æˆ‘ä»¬å·²ç»æœ‰äº†ç»„ä»¶çš„è½®å»“ï¼Œè®©æˆ‘ä»¬å¼€å§‹ç”¨å®žé™…åŠŸèƒ½æ¥å¡«å……å®ƒä»¬ã€‚é¦–å…ˆæ˜¯ CRDã€‚åœ¨ api/v1alpha1/memcached_types.go ä¸­ï¼Œæ‚¨åº”è¯¥èƒ½çœ‹åˆ°ä¸€äº›å®šä¹‰è‡ªå®šä¹‰èµ„æºç±»åž‹è§„æ ¼å’ŒçŠ¶æ€çš„ç»“æž„ï¼š 1234567891011121314// EDIT THIS FILE! THIS IS SCAFFOLDING FOR YOU TO OWN!// NOTE: json tags are required. Any new fields you add must have json tags for the fields to be serialized.// MemcachedSpec defines the desired state of Memcachedtype MemcachedSpec struct &#123; // INSERT ADDITIONAL SPEC FIELDS - desired state of cluster // Important: Run &quot;make&quot; to regenerate code after modifying this file // Foo is an example field of Memcached. Edit Memcached_types.go to remove/update Foo string `json:&quot;foo,omitempty&quot;`&#125;// MemcachedStatus defines the observed state of Memcachedtype MemcachedStatus struct &#123; // INSERT ADDITIONAL STATUS FIELD - define observed state of cluster // Important: Run &quot;make&quot; to regenerate code after modifying this file&#125; è¯·æ³¨æ„æ–‡ä»¶é¡¶éƒ¨çš„ä¿¡æ¯ã€‚è¯¥æ–‡ä»¶æ˜¯ç”± Operator-SDK æ­å»ºçš„è„šæ‰‹æž¶ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„é¡¹ç›®éœ€æ±‚åŽ»ä¿®æ”¹ã€‚Spec åŒ…å«æŒ‡å®šèµ„æºæ‰€éœ€çŠ¶æ€çš„ä¿¡æ¯ï¼Œè€Œ Status åˆ™åŒ…å«ç³»ç»Ÿçš„å¯è§‚æµ‹çŠ¶æ€ï¼Œå°¤å…¶æ˜¯å…¶ä»–èµ„æºå¯èƒ½æƒ³è¦ä½¿ç”¨çš„ä¿¡æ¯ã€‚è¿™äº› Golang ç»“æž„ä¸Ž Kubernetes ç”¨æˆ·ä¸ºåˆ›å»ºè‡ªå®šä¹‰èµ„æºç±»åž‹å®žä¾‹è€Œç¼–å†™çš„ YAML ç›´æŽ¥å¯¹åº”ã€‚ è®©æˆ‘ä»¬ä¸ºç±»åž‹æ·»åŠ ä¸€äº›åŸºæœ¬å­—æ®µã€‚1234567891011// MemcachedSpec defines the desired state of Memcachedtype MemcachedSpec struct &#123; // +kubebuilder:validation:Minimum=0 // Size is the size of the memcached deployment Size int32 `json:&quot;size&quot;`&#125;// MemcachedStatus defines the observed state of Memcachedtype MemcachedStatus struct &#123; // Nodes are the names of the memcached pods Nodes []string `json:&quot;nodes&quot;`&#125; Size æ˜¯ä¸€ä¸ªæ•´æ•°ï¼Œç”¨äºŽç¡®å®š Memcached é›†ç¾¤ä¸­çš„èŠ‚ç‚¹æ•°é‡ã€‚æˆ‘ä»¬åœ¨ Status ä¸­æ·»åŠ äº†ä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„ï¼Œç”¨äºŽå­˜å‚¨é›†ç¾¤ä¸­åŒ…å«çš„èŠ‚ç‚¹çš„ IP åœ°å€ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç‰¹å®šçš„å®žçŽ°æ–¹å¼åªæ˜¯ä¸€ä¸ªç¤ºä¾‹ã€‚æ³¨æ„çˆ¶ Memcached ç»“æž„ Status å­—æ®µçš„ Kubebuilder å­èµ„æºæ ‡è®°ã€‚è¿™å°†åœ¨ç”Ÿæˆçš„ CRD æ¸…å•ä¸­æ·»åŠ  Kubernetes çŠ¶æ€å­èµ„æºã€‚è¿™æ ·ï¼ŒæŽ§åˆ¶å™¨å°±å¯ä»¥åªæ›´æ–°çŠ¶æ€å­—æ®µï¼Œè€Œæ— éœ€æ›´æ–°æ•´ä¸ªå¯¹è±¡ï¼Œä»Žè€Œæé«˜æ€§èƒ½ã€‚ 12345678// Memcached is the Schema for the memcacheds API// +kubebuilder:subresource:statustype Memcached struct &#123; metav1.TypeMeta `json:&quot;,inline&quot;` metav1.ObjectMeta `json:&quot;metadata,omitempty&quot;` Spec MemcachedSpec `json:&quot;spec,omitempty&quot;` Status MemcachedStatus `json:&quot;status,omitempty&quot;`&#125; æ›´æ”¹ types.go æ–‡ä»¶åŽï¼Œåº”å§‹ç»ˆåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹è¿è¡Œä»¥ä¸‹å‘½ä»¤ï¼š1make generate æ­¤ make target ä¼šè°ƒç”¨ controller-gen æ›´æ–° api/v1alpha1/zz_generated.deepcopy.goï¼Œä½¿å…¶åŒ…å«æ‚¨åˆšåˆšæ·»åŠ çš„å­—æ®µçš„å¿…è¦å®žçŽ°ã€‚å®Œæˆæ›´æ–°åŽï¼Œæˆ‘ä»¬åº”è¿è¡Œä»¥ä¸‹å‘½ä»¤ä¸º CRD ç”Ÿæˆ YAML æ¸…å•ï¼š 1$ make manifests ä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š 123New: config/crd/bases/cache.example.com_memcacheds.yaml config/rbac/role.yaml config/crd/bases/cache.example.com_memcacheds.yaml æ˜¯ memcached CRD çš„æ¸…å•ã€‚config/rbac/role.yaml æ˜¯ RBAC æ¸…å•ï¼Œå…¶ä¸­åŒ…å«æŽ§åˆ¶å™¨æ‰€éœ€çš„ç®¡ç† memcached ç±»åž‹çš„æƒé™ã€‚ Step 3: Create a controllerè®©æˆ‘ä»¬çœ‹çœ‹ controllers/memcached_controller.go ä¸­ç›®å‰åŒ…å«çš„å†…å®¹ï¼š12345678910111213// Reconcile is part of the main kubernetes reconciliation loop which aims to// move the current state of the cluster closer to the desired state.// TODO(user): Modify the Reconcile function to compare the state specified by// the Memcached object against the actual cluster state, and then// perform operations to make the cluster state reflect the state specified by// the user.//// For more details, check Reconcile and its Result here:// - https://pkg.go.dev/sigs.k8s.io/controller-runtime@v0.7.0/pkg/reconcilefunc (r *MemcachedReconciler) Reconcile(ctx context.Context, req ctrl.Request) (ctrl.Result, error) &#123; _ = r.Log.WithValues(&quot;memcached&quot;, req.NamespacedName) // your logic here return ctrl.Result&#123;&#125;, nil&#125; Reconcile æ–¹æ³•è´Ÿè´£å°†è‡ªå®šä¹‰èµ„æºçŠ¶æ€ä¸­åŒ…å«çš„æœŸæœ›çŠ¶æ€ä¸Žç³»ç»Ÿä¸Šè¿è¡Œçš„å®žé™…çŠ¶æ€è¿›è¡Œæ ¸å¯¹ï¼Œä¹Ÿæ˜¯å®žçŽ°æŽ§åˆ¶å™¨é€»è¾‘çš„ä¸»è¦éƒ¨åˆ†ã€‚å®žçŽ°è°ƒå’Œå¾ªçŽ¯çš„å…·ä½“ç»†èŠ‚è¶…å‡ºäº†æœ¬æ•™ç¨‹çš„èŒƒå›´ï¼Œå°†åœ¨è¿›é˜¶çš„æ–‡ç« ä¸­ä»‹ç»ã€‚çŽ°åœ¨ï¼Œè¯·ç”¨æ­¤å‚è€ƒå®žçŽ°æ›¿æ¢ controllers/memcached_controller.goã€‚æ³¨æ„ï¼Œå¦‚æžœä½ åœ¨åˆå§‹åŒ–é¡¹ç›®æ—¶æŒ‡å®šäº†ä¸åŒçš„ repoï¼Œå¯èƒ½éœ€è¦æ›´æ”¹ github.com/example/memcached-operator/api/v1alpha1 çš„å¯¼å…¥è·¯å¾„ï¼Œä»¥ä¾¿æ­£ç¡®æŒ‡å‘ä½ å®šä¹‰ memcached_types.goin çš„ç›®å½•ã€‚ç²˜è´´åŽï¼Œç¡®ä¿é‡æ–°ç”Ÿæˆæ¸…å•ï¼š 1make manifests Step 4: Build and deploy your operatorçŽ°åœ¨æ‚¨å·²ç»å¡«å†™äº†æ‰€æœ‰éœ€è¦çš„ç»„ä»¶ï¼Œæ˜¯æ—¶å€™éƒ¨ç½² operator äº†ï¼ä¸€èˆ¬æ¥è¯´ï¼Œæœ‰ä¸‰ç§ä¸åŒçš„æ–¹æ³•æ¥éƒ¨ç½²ï¼š ä½œä¸ºåœ¨ Kubernetes é›†ç¾¤å¤–æ‰§è¡Œçš„ç¨‹åºã€‚è¿™æ ·åšå¯èƒ½æ˜¯å‡ºäºŽå¼€å‘ç›®çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å‡ºäºŽé›†ç¾¤ä¸­æ•°æ®çš„å®‰å…¨è€ƒè™‘ã€‚Makefile åŒ…å«ç›®æ ‡ make install runï¼Œç”¨äºŽåœ¨æœ¬åœ°è¿è¡Œè¿ç®—ç¬¦ï¼Œä½†è¿™ç§æ–¹æ³•ä¸æ˜¯è¿™é‡Œçš„é‡ç‚¹ã€‚ ä½œä¸º Kubernetes é›†ç¾¤å†…çš„éƒ¨ç½²è¿è¡Œã€‚è¿™å°±æ˜¯æˆ‘çŽ°åœ¨è¦å‘ä½ å±•ç¤ºçš„å†…å®¹ã€‚ ç”± operator ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨éƒ¨ç½²å’Œç®¡ç†ã€‚å»ºè®®åœ¨ç”Ÿäº§ä¸­ä½¿ç”¨ï¼Œå› ä¸º OLM å…·æœ‰ç®¡ç†å’Œå‡çº§è¿è¡Œä¸­çš„ operator çš„é™„åŠ åŠŸèƒ½ã€‚ çŽ°åœ¨ï¼Œå…ˆæž„å»ºå¹¶æŽ¨é€æŽ§åˆ¶å™¨çš„ Docker imageã€‚æœ¬ç¤ºä¾‹ä½¿ç”¨äº†åŸºç¡€ Dockerfileï¼Œä½†ä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€è¦è¿›è¡Œä¿®æ”¹ã€‚æˆ‘ä½¿ç”¨ Docker Hub ä½œä¸ºé•œåƒä»“åº“ï¼Œä½†ä½ èƒ½æŽ¨/æ‹‰è®¿é—®çš„ä»»ä½•ä»“åº“éƒ½å¯ä»¥ã€‚ 12$ export USERNAME=&lt;docker-username&gt;$ make docker-build docker-push IMG=docker.io/$USERNAME/memcached-operator:v1.0.0 å¦‚æžœå‡ºçŽ°å¦‚ä¸‹é”™è¯¯ï¼Œåˆ™å¯èƒ½éœ€è¦èŽ·å–å…¶ä»–ä¾èµ–é¡¹ã€‚è¿è¡Œå»ºè®®çš„å‘½ä»¤ä¸‹è½½ä¾èµ–é¡¹ã€‚12/controllers: package k8s.io/api/apps/v1 imported from implicitly required module; to add missing requirements, run: go get k8s.io/api/apps/v1@v0.19.2 æˆ‘ä»¬è¿˜å¯ä»¥åœ¨ Makefile ä¸­è®¾ç½®é•œåƒçš„é»˜è®¤åç§°å’Œæ ‡ç­¾ã€‚é•œåƒæž„å»ºå®ŒæˆåŽï¼Œå°±å¯ä»¥éƒ¨ç½² operator äº†ï¼š1$ make deploy IMG=docker.io/$USERNAME/memcached-operator:v1.0.0 å®ƒä½¿ç”¨ config/ ä¸­çš„æ¸…å•åˆ›å»º CRDï¼Œåœ¨ Pod ä¸­éƒ¨ç½²æŽ§åˆ¶å™¨ï¼Œåˆ›å»ºæŽ§åˆ¶å™¨ç®¡ç† CRD æ‰€éœ€çš„ RBAC è§’è‰²ï¼Œå¹¶å°†å…¶åˆ†é…ç»™æŽ§åˆ¶å™¨ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹ã€‚æˆ‘ä»¬çš„ CRD ç±»åž‹ä¸º memcacheds.cache.example.comï¼š123456789$ kubectl get crdsNAME CREATED ATcatalogsources.operators.coreos.com 2021-01-22T00:13:22Zclusterserviceversions.operators.coreos.com 2021-01-22T00:13:22Zinstallplans.operators.coreos.com 2021-01-22T00:13:22Zmemcacheds.cache.example.com 2021-02-06T00:52:38Zoperatorgroups.operators.coreos.com 2021-01-22T00:13:22Zrbacsyncs.ibm.com 2021-01-22T00:08:59Zsubscriptions.operators.coreos.com 2021-01-22T00:13:22Z è¿è¡ŒæŽ§åˆ¶å™¨çš„éƒ¨ç½²å’Œ Podï¼š 1234567$ kubectl --namespace memcached-operator-system get deploymentsNAME READY UP-TO-DATE AVAILABLE AGEmemcached-operator-controller-manager 1/1 1 1 2m18s$ kubectl --namespace memcached-operator-system get pods NAME READY STATUS RESTARTS AGEmemcached-operator-controller-manager-76b588bbb5-wvl7b 2/2 Running 0 2m44s å½“ pod å¼€å§‹è¿è¡Œï¼Œæˆ‘ä»¬çš„ Operator å°±å¯ä»¥ä½¿ç”¨äº†ã€‚ç¼–è¾‘ config/samples/cache_v1alpha1_memcached.yaml ä¸­çš„ç¤ºä¾‹ YAMLï¼ŒåŠ å…¥ä¸€ä¸ªå¤§å°æ•´æ•°ï¼Œå°±åƒåœ¨è‡ªå®šä¹‰èµ„æºè§„èŒƒä¸­å®šä¹‰çš„é‚£æ ·ï¼š 123456apiVersion: cache.example.com/v1alpha1kind: Memcachedmetadata: name: memcached-samplespec: size: 1 ç„¶åŽåˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰èµ„æºçš„æ–°å®žä¾‹ï¼š12$ kubectl apply -f config/samples/cache_v1alpha1_memcached.yaml memcached.cache.example.com/memcached-sample created å†çœ‹çœ‹æ–°çš„è‡ªå®šä¹‰èµ„æºå’ŒæŽ§åˆ¶å™¨åœ¨åŽå°åˆ›å»ºçš„å¯¹è±¡ï¼š1234567891011$ kubectl get memcachedNAME AGEmemcached-sample 18s$ kubectl get deploymentsNAME READY UP-TO-DATE AVAILABLE AGEmemcached-sample 1/1 1 1 33s$ kubectl get podsNAME READY STATUS RESTARTS AGEmemcached-sample-9b765dfc8-2hvf8 1/1 Running 0 44s å¦‚æžœæŸ¥çœ‹ä¸€ä¸‹ Memcached å¯¹è±¡ï¼Œå°±ä¼šå‘çŽ°çŠ¶æ€å·²ç”¨è¿è¡ŒèŠ‚ç‚¹çš„åç§°æ›´æ–°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041$ kubectl get memcached memcached-sample -o yamlapiVersion: cache.example.com/v1alpha1kind: Memcachedmetadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | &#123;&quot;apiVersion&quot;:&quot;cache.example.com/v1alpha1&quot;,&quot;kind&quot;:&quot;Memcached&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;memcached-sample&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;size&quot;:1&#125;&#125; creationTimestamp: &quot;2021-03-29T19:22:53Z&quot; generation: 1 managedFields: - apiVersion: cache.example.com/v1alpha1 fieldsType: FieldsV1 fieldsV1: f:metadata: f:annotations: .: &#123;&#125; f:kubectl.kubernetes.io/last-applied-configuration: &#123;&#125; f:spec: .: &#123;&#125; f:size: &#123;&#125; manager: kubectl operation: Update time: &quot;2021-03-29T19:22:53Z&quot; - apiVersion: cache.example.com/v1alpha1 fieldsType: FieldsV1 fieldsV1: f:status: .: &#123;&#125; f:nodes: &#123;&#125; manager: manager operation: Update time: &quot;2021-03-29T19:22:58Z&quot; name: memcached-sample namespace: default resourceVersion: &quot;1374&quot; uid: 63c7b1b1-1a75-49e6-8132-2164807a1b78spec: size: 1status: nodes:- memcached-sample-9b765dfc8-2hvf8 è¦æŸ¥çœ‹æŽ§åˆ¶å™¨çš„è¿è¡Œæƒ…å†µï¼Œå¯ä»¥åœ¨é›†ç¾¤ä¸­æ·»åŠ å¦ä¸€ä¸ªèŠ‚ç‚¹ã€‚å°† config/samples/cache_v1alpha1_memcached.yaml ä¸­çš„å¤§å°æ”¹ä¸º 2ï¼Œç„¶åŽè¿è¡Œï¼š12$ kubectl apply -f config/samples/cache_v1alpha1_memcached.yamlmemcached.cache.example.com/memcached-sample configured æŸ¥çœ‹åˆ›å»ºçš„æ–° podï¼š1234$ kubectl get podsNAME READY STATUS RESTARTS AGEmemcached-sample-9b765dfc8-2hvf8 1/1 Running 0 50smemcached-sample-9b765dfc8-jdhlq 1/1 Running 0 3s ç„¶åŽçœ‹åˆ° Memcached å¯¹è±¡å†æ¬¡æ›´æ–°ä¸ºæ–° pod çš„åç§°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142$ kubectl get memcached memcached-sample -o yamlapiVersion: cache.example.com/v1alpha1kind: Memcachedmetadata: annotations: kubectl.kubernetes.io/last-applied-configuration: | &#123;&quot;apiVersion&quot;:&quot;cache.example.com/v1alpha1&quot;,&quot;kind&quot;:&quot;Memcached&quot;,&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&#125;,&quot;name&quot;:&quot;memcached-sample&quot;,&quot;namespace&quot;:&quot;default&quot;&#125;,&quot;spec&quot;:&#123;&quot;size&quot;:1&#125;&#125; creationTimestamp: &quot;2021-03-29T19:22:53Z&quot; generation: 2 managedFields: - apiVersion: cache.example.com/v1alpha1 fieldsType: FieldsV1 fieldsV1: f:metadata: f:annotations: .: &#123;&#125; f:kubectl.kubernetes.io/last-applied-configuration: &#123;&#125; f:spec: .: &#123;&#125; f:size: &#123;&#125; manager: kubectl operation: Update time: &quot;2021-03-29T19:22:53Z&quot; - apiVersion: cache.example.com/v1alpha1 fieldsType: FieldsV1 fieldsV1: f:status: .: &#123;&#125; f:nodes: &#123;&#125; manager: manager operation: Update time: &quot;2021-03-29T19:22:58Z&quot; name: memcached-sample namespace: default resourceVersion: &quot;1712&quot; uid: 63c7b1b1-1a75-49e6-8132-2164807a1b78spec: size: 2status: nodes: - memcached-sample-9b765dfc8-2hvf8 - memcached-sample-9b765dfc8-jdhlq Step 5: Cleanupå®ŒæˆåŽï¼Œå¯ä»¥é€šè¿‡è¿è¡Œè¿™äº›å‘½ä»¤æ¥æ¸…ç†å·²éƒ¨ç½²çš„ operatorï¼š123$ kubectl delete memcached memcached-sample$ make undeploy DebuggingæŸ¥çœ‹æ“ä½œå‘˜ç®¡ç†å™¨æ—¥å¿—: 1$ kubectl logs deployment.apps/memcached-operator-controller-manager -n memcached-operator-system -c manager]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¦‚ä½•ç”¨ golang ä»Ž OpenAI,Ollama å’Œ Claude èŽ·å–å¯é çš„ç»“æž„åŒ–è¾“å‡º?]]></title>
    <url>%2F2024%2F06%2F03%2F%E5%A6%82%E4%BD%95%E7%94%A8-golang-%E4%BB%8E-OpenAI-Ollama-%E5%92%8C-Claude-%E8%8E%B7%E5%8F%96%E5%8F%AF%E9%9D%A0%E7%9A%84%E7%BB%93%E6%9E%84%E5%8C%96%E8%BE%93%E5%87%BA%2F</url>
    <content type="text"><![CDATA[OpenAI å¤§ç«åŽæœ‰è®¸å¤šå¼€å‘è€…æ­£åœ¨æ´»æƒ³è¦åŸºäºŽ OpenAI åšå¾ˆå¤šä¸Šå±‚åº”ç”¨çš„å¼€å‘ï¼Œè¿™æ–¹é¢åœ¨ Python çš„ç”Ÿæ€ç¡®å®žæ¯”è¾ƒå®Œå–„ï¼Œä½†å¯¹äºŽ Gopher æ¥è¯´è¦èŽ·å¾—ç»“æž„åŒ–çš„ç»“æžœè¿˜éœ€è¦é¢å¤–çš„å·¥ä½œï¼Œæ²¡æœ‰æ—¢å®šçš„æœ€ä½³å®žè·µã€‚åœ¨ golang ä¸–ç•Œä¸­ï¼Œè¿˜æ²¡æœ‰è¿™æ ·çš„åè®®ã€‚ä½†æœ‰ä¸€ç§éžå¸¸æˆç†Ÿã€ç¨³å®šã€å¹¿æ³›ä½¿ç”¨çš„åè®®å¯ä»¥å®žçŽ°æˆ‘ä»¬æƒ³è¦çš„å¤§éƒ¨åˆ†åŠŸèƒ½ï¼šprotobufs å’Œ protojsonï¼ˆç”¨äºŽå°†ç»“æž„åŒ–å†…å­˜ä¸­çš„ç»“æž„è½¬æ¢ä¸º JSONï¼‰ã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†é€šè¿‡ä»£ç æ¥å®žçŽ°è¿™ç§ç»„åˆï¼šOpenAIï¼ˆåŒ…æ‹¬ ollama + open weightsï¼‰+ protobufs + golangã€‚ å®žçŽ°æˆ‘ä»¬å¸Œæœ›åˆ›å»ºä¸€ä¸ª POCï¼Œå¯¹è¾“å…¥å’Œè¾“å‡ºè¿›è¡Œç¨³å¥çš„ç±»åž‹åŒ–éªŒè¯ï¼šè¾“å…¥åº”ä¸ºå›½å®¶åç§°ï¼Œè¾“å‡ºåº”ä¸ºå›½å®¶åç§°å’Œå…¶ä»–ç»Ÿè®¡æ•°æ®ã€‚ å¦‚ä½•åœ¨ Golang ä¸­ä½¿ç”¨ OpenAIè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Sasha Baranov å¼€å‘çš„éžå®˜æ–¹ Golang OpenAI å®¢æˆ·ç«¯ã€‚ è®¾è®¡åè®®åˆ›å»º protobuf æ–‡ä»¶ï¼š 1234567891011121314151617syntax = &quot;proto3&quot;;package countryinfo;option go_package = &quot;./protobuf&quot;;message CountryRequest &#123; string country = 1;&#125;message CountryResponse &#123; string country = 1; int32 country_population = 2; string capital = 3; int32 capital_population = 4; int64 gdp_usd = 5;&#125; çŽ°åœ¨åˆ›å»º go å¯¹åº”ç¨‹åºï¼ˆéœ€è¦å®‰è£… protoc æ‰èƒ½ä½¿ç”¨ï¼‰ï¼š1protoc --go_out=. countryinfo.proto è¿™å°†ä¸ºæˆ‘ä»¬åœ¨ main.go æ–‡ä»¶ä¸­ä½¿ç”¨çš„å†…å®¹åˆ›å»ºä¸€ä¸ª go åŽŸç”Ÿç±»åž‹éªŒè¯ã€‚æˆ‘ä»¬çš„åŒ…å«æ–‡ä»¶éœ€è¦åŒ…å« protobufï¼Œæˆ‘ä»¬è¿˜éœ€è¦ protojson æ¥è§£æž LLM çš„è¾“å…¥å’Œè¾“å‡ºï¼š 12&quot;countryinfo/protobuf&quot; &quot;google.golang.org/protobuf/encoding/protojson&quot; system promptæˆ‘ä»¬éœ€è¦è®© OpenAI ä¸Ž protobuf å¯¹è¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ç³»ç»Ÿæç¤ºå®Œæˆè¿™é¡¹å·¥ä½œ: æˆ‘ä»¬éªŒè¯è¾“å‡ºï¼ˆä»¥åŠè¾“å…¥ï¼‰ åœ¨ç³»ç»Ÿæç¤ºä¸­åŒ…å«äº†ä¸€ä»½åŽŸç”Ÿæ•°æ®åº“çš„æ–‡æœ¬å‰¯æœ¬ï¼Œæ˜¾ç„¶æ¯æ¬¡é‡æ–°ç”ŸæˆåŽŸç”Ÿæ•°æ®åº“æ—¶éƒ½éœ€è¦æ‰‹åŠ¨åŒæ­¥ã€‚1234567891011121314systemPrompt := `You are a programmatic country information API used software applications. All input messages provided MUST adhere to the CountryRequest schema: validate them and throw an error if not. Your responses MUST adhere to the CountryResponse schema ONLY with no additional narrative or markup, backquotes or anything.message CountryRequest &#123; string country = 1; &#125; message CountryResponse &#123; string country = 1; int32 country_population = 2; string capital = 3; int32 capital_population = 4; int64 gdp_usd = 5; &#125; åˆ›å»ºç±»åž‹å®‰å…¨è¯·æ±‚1234567891011121314req := openai.ChatCompletionRequest&#123; Model: openai.GPT3Dot5Turbo, MaxTokens: 1000, // Increased max tokens to 1000 Messages: []openai.ChatCompletionMessage&#123; &#123; Role: openai.ChatMessageRoleSystem, Content: systemPrompt, &#125;, &#123; Role: openai.ChatMessageRoleUser, Content: encodeCountryRequest(*country), &#125;, &#125;, &#125; è¿™æ˜¯æ–¹æ³•å®šä¹‰ã€‚çœ‹ä¸€ä¸‹æˆ‘ä»¬æ˜¯å¦‚ä½•ä½¿ç”¨è‡ªåŠ¨ç”Ÿæˆçš„ protobuf æ¥éªŒè¯å†…å®¹çš„: 123456789101112func encodeCountryRequest(country string) string &#123; req := &amp;protobuf.CountryRequest&#123; Country: country, &#125; data, err := protojson.Marshal(req) if err != nil &#123; log.Fatalf(&quot;Protobuf JSON encoding error: %v\n&quot;, err) &#125; resultStr := string(data) fmt.Println(&quot;Encoded Protobuf JSON Message: &quot;, resultStr) return resultStr&#125; å¤„ç† response12345678func decodeCountryResponse(data string) (*protobuf.CountryResponse, error) &#123; resp := &amp;protobuf.CountryResponse&#123;&#125; err := protojson.Unmarshal([]byte(data), resp) if err != nil &#123; return nil, err &#125; return resp, nil&#125; å…¼å®¹æ€§ä¸Šé¢çš„ä»£ç é»˜è®¤ä½¿ç”¨ GPT 3.5ï¼Œä½†å¦‚æžœä½ æœ‰è¶³å¤Ÿçš„é¢„ç®—ï¼Œä¹Ÿå¯ä»¥é‡å†™æ¨¡åž‹ä½¿ç”¨ GPT 4ï¼Œè¿˜å¯ä»¥é‡å†™ä¸»æœºç½‘å€æŒ‡å‘ ollamaï¼ˆå› ä¸ºå®ƒä¸Ž OpenAI-API å…¼å®¹ï¼‰ã€‚ ä¸‹é¢æ˜¯æˆåŠŸæµ‹è¯•è¿‡çš„æ¨¡åž‹ï¼š GPT 3.5 GPT 4 æœ¬åœ°å®‰è£…çš„ llama3-instruct Claude Haiku claude-3-haiku-20240307 ï¼ˆæœ€ä¾¿å®œçš„åž‹å·ï¼‰]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
        <tag>OpenAI</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[go1.23: å¯¹ //go:linkname çš„ä¿®æ”¹åŠå…¶å¯¹å¼€å‘äººå‘˜çš„å½±å“]]></title>
    <url>%2F2024%2F05%2F30%2Fgo1-23-%E5%AF%B9-go-linkname-%E7%9A%84%E4%BF%AE%E6%94%B9%E5%8F%8A%E5%85%B6%E5%AF%B9%E5%BC%80%E5%8F%91%E4%BA%BA%E5%91%98%E7%9A%84%E5%BD%B1%E5%93%8D%2F</url>
    <content type="text"><![CDATA[ä¸Šå‘¨ï¼ŒGo 1.23 è¿›å…¥å†»ç»“æœŸï¼Œè¿™æ„å‘³ç€ä¸ä¼šæ·»åŠ ä»»ä½•æ–°åŠŸèƒ½ï¼Œå·²ç»æ·»åŠ çš„åŠŸèƒ½ä¹Ÿä¸å¤ªå¯èƒ½è¢«åˆ é™¤ã€‚ä»Šå¤©ï¼Œæˆ‘ä»¬å°†è®¨è®º Go 1.23 ä¸­ //go:linkname æŒ‡ä»¤çš„å˜åŒ–ã€‚ç›¸å…³çš„ issue æ˜¯ï¼šcmd/link: lock down future uses of linkname Â· Issue #67401 Â· golang/go æ³¨ï¼š//go:linkname æŒ‡ä»¤ä¸æ˜¯å®˜æ–¹æŽ¨èä½¿ç”¨çš„æŒ‡ä»¤ï¼Œä¸èƒ½ä¿è¯å‘å‰æˆ–å‘åŽçš„å…¼å®¹æ€§ã€‚æ˜Žæ™ºçš„åšæ³•æ˜¯å°½å¯èƒ½é¿å…ä½¿ç”¨è¯¥æŒ‡ä»¤ã€‚ æœ‰é‰´äºŽæ­¤ï¼Œè®©æˆ‘ä»¬æ·±å…¥äº†è§£è¿™äº›æ–°å˜åŒ–ã€‚ linkname çš„ä½œç”¨æ˜¯ä»€ä¹ˆç®€å•æ¥è¯´ï¼Œé“¾æŽ¥åæŒ‡ä»¤ç”¨äºŽå‘ç¼–è¯‘å™¨å’Œé“¾æŽ¥å™¨ä¼ é€’ä¿¡æ¯ã€‚æ ¹æ®ä½¿ç”¨æƒ…å†µï¼Œå¯å°†å…¶åˆ†ä¸ºä¸‰ç±»ï¼š 1. Pullpull çš„ç”¨æ³•æ˜¯ï¼š 123456import _ &quot;unsafe&quot; // Required to use linkname â€‹ import _ &quot;fmt&quot; // The pulled package must be explicitly imported (except the runtime package) â€‹ //go:linkname my_func fmt.Println func my_func(...any) (n int, err error) è¯¥æŒ‡ä»¤æ ¼å¼ä¸º //go:linkname &lt;æœ¬åœ°å‡½æ•°æˆ–åŒ…çº§å˜é‡&gt; &lt;æœ¬åŒ…æˆ–å…¶ä»–åŒ…ä¸­å®Œå…¨å®šä¹‰çš„å‡½æ•°æˆ–å˜é‡&gt;ã€‚å®ƒå‘Šè¯‰ç¼–è¯‘å™¨å’Œé“¾æŽ¥å™¨ my_func åº”ç›´æŽ¥ä½¿ç”¨ fmt.Printlnï¼Œä½¿ my_func æˆä¸º fmt.Println çš„åˆ«åã€‚ è¿™ç§ç”¨æ³•å¯ä»¥å¿½ç•¥å‡½æ•°æˆ–å˜é‡æ˜¯å¦è¢«å¯¼å‡ºï¼Œç”šè‡³å¯ä»¥ä½¿ç”¨åŒ…ç§æœ‰å…ƒç´ ã€‚ä¸è¿‡ï¼Œè¿™ç§æ–¹æ³•æœ‰é£Žé™©ï¼Œå¦‚æžœå‡ºçŽ°ç±»åž‹ä¸åŒ¹é…ï¼Œå¯èƒ½ä¼šå¼•èµ· panicã€‚ 2. Push1234567891011import _ &quot;unsafe&quot; // Required to use linkname â€‹ //go:linkname main.fastHandle func fastHandle(input io.Writer) error &#123; ... &#125; â€‹ // package main func fastHandle(input io.Writer) error â€‹ // The main package can directly use fastHandle åœ¨è¿™é‡Œï¼Œåªéœ€å°†å‡½æ•°æˆ–å˜é‡åä½œä¸ºç¬¬ä¸€ä¸ªå‚æ•°ä¼ é€’ç»™æŒ‡ä»¤ï¼Œå¹¶æŒ‡å®šä½¿ç”¨è¯¥å‡½æ•°æˆ–å˜é‡çš„è½¯ä»¶åŒ…åç§°ã€‚è¿™ç§ç”¨æ³•è¡¨ç¤ºå‡½æ•°æˆ–å˜é‡å°†è¢«å‘½åä¸º xxx.yyyã€‚ 3. HandShake12345678910111213141516package mypkg â€‹ import _ &quot;unsafe&quot; // Required to use linkname â€‹ //go:linkname fastHandle func fastHandle(input io.Writer) error &#123; ... &#125; â€‹ package main â€‹ import _ &quot;unsafe&quot; // Required to use linkname â€‹ //go:linkname fastHandle mypkg.fastHandle func fastHandle(input io.Writer) error è¿™ç§ç”¨æ³•æ„å‘³ç€ä¸¤ç«¯è¦æ¡æ‰‹ï¼Œæ˜Žç¡®æ ‡è®°å“ªä¸ªå‡½æ•°æˆ–å˜é‡åº”è¢«é“¾æŽ¥ã€‚ ä½¿ç”¨ linkname çš„é£Žé™©ä¸»è¦é£Žé™©æ˜¯åœ¨è½¯ä»¶åŒ…ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹ä½¿ç”¨è½¯ä»¶åŒ…ç§æœ‰å‡½æ•°æˆ–å˜é‡çš„èƒ½åŠ›ã€‚ ä¾‹å¦‚ï¼š 12345678910111213141516171819202122// pkg/mymath/mymath.go package mymath â€‹ func uintPow(n uint) uint &#123; return n * n &#125; â€‹ // main.go package main â€‹ import ( &quot;fmt&quot; _ &quot;linkname/pkg/mymath&quot; _ &quot;unsafe&quot; ) â€‹ //go:linkname pow linkname/pkg/mymath.uintPow func pow(n uint) uint â€‹ func main() &#123; fmt.Println(pow(6)) // 36 &#125; é€šå¸¸ï¼ŒuintPow ä¸åº”åœ¨å…¶è½¯ä»¶åŒ…ä¹‹å¤–è¢«è®¿é—®ã€‚ä½† linkname ç»•è¿‡äº†è¿™ä¸€é™åˆ¶ï¼Œå¯èƒ½å¯¼è‡´ä¸¥é‡çš„ç±»åž‹ç›¸å…³å†…å­˜é”™è¯¯æˆ–è¿è¡Œæ—¶ panicã€‚ linkname ä¹Ÿæœ‰æœ‰ç”¨çš„æ—¶å€™å°½ç®¡å­˜åœ¨é£Žé™©ï¼Œä½† linkname çš„å­˜åœ¨è¿˜æ˜¯æœ‰å…¶åˆç†çš„åŽŸå› ï¼Œä¾‹å¦‚åœ¨ Go ç¨‹åºå¯åŠ¨æ—¶ã€‚ä¾‹å¦‚ï¼Œåœ¨ Go çš„è¿è¡Œæ—¶ï¼š12345678910// runtime/proc.go â€‹ //go:linkname main_main main.main func main_main() â€‹ // runtime.main func main() &#123; fn := main_main fn() &#125; è¿™é‡Œï¼Œlinkname å…è®¸è¿è¡Œæ—¶è°ƒç”¨ç”¨æˆ·å®šä¹‰çš„ä¸»å‡½æ•°ã€‚ Go 1.23 ä¸­å¯¹ linkname çš„æ›´æ”¹è€ƒè™‘åˆ°ä¸Šè¿°é£Žé™©ï¼ŒGo æ ¸å¿ƒå›¢é˜Ÿå†³å®šé™åˆ¶é“¾æŽ¥åçš„ä½¿ç”¨ï¼š æ–°çš„æ ‡å‡†åº“è½¯ä»¶åŒ…å°†ç¦æ­¢ linknameã€‚ æ–°å¢žäº†ä¸€ä¸ª ldflag -checklinkname=1 æ¥æ‰§è¡Œé™åˆ¶ã€‚é»˜è®¤å€¼ä¸º 0ï¼Œä½†åœ¨ 1.23 çš„æœ€ç»ˆç‰ˆæœ¬ä¸­å°†è®¾ç½®ä¸º 1ã€‚ æ ‡å‡†åº“å°†ç¦æ­¢åªæ‹‰é“¾æŽ¥åï¼Œåªå…è®¸æ¡æ‰‹æ¨¡å¼ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹ä»£ç åœ¨ 1.23 ç‰ˆä¸­å°±æ— æ³•ç¼–è¯‘ï¼š 12345678package main import _ &quot;unsafe&quot; //go:linkname corostart runtime.corostart func corostart() â€‹ func main() &#123; corostart() &#125; linkname çš„æœªæ¥é•¿æœŸç›®æ ‡æ˜¯åªå…è®¸ä½¿ç”¨æ¡æ‰‹æ¨¡å¼ã€‚ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘ä»¬åº”è¯¥: ä½¿ç”¨ -checklinkname=1 å®¡æ ¸å¹¶åˆ é™¤ä¸å¿…è¦çš„é“¾æŽ¥åä½¿ç”¨ã€‚ å»ºè®®åœ¨å¿…è¦æ—¶å…¬å¼€ç§æœ‰ APIã€‚ æœ€åŽï¼Œä½¿ç”¨ -ldflags=-checklinkname=0 ç¦ç”¨é™åˆ¶ã€‚ æ€»ç»“æ€»ä¹‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯åº”é¿å…ä½¿ç”¨ //go:linkname ä»¥é˜²æ­¢å‡ºçŽ°ä¸å¯é¢„è§çš„é—®é¢˜ã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŽŒæ¡ Golang Mutexï¼šå®‰å…¨å¹¶å‘çš„æœ€ä½³å®žè·µ]]></title>
    <url>%2F2024%2F05%2F29%2F%E6%8E%8C%E6%8F%A1-Golang-Mutex%EF%BC%9A%E5%AE%89%E5%85%A8%E5%B9%B6%E5%8F%91%E7%9A%84%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%2F</url>
    <content type="text"><![CDATA[æŽŒæ¡ Golang Mutexï¼šå®‰å…¨å¹¶å‘çš„æœ€ä½³å®žè·µ å¹¶å‘æ˜¯ Go çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œå®ƒä½¿å¼€å‘äººå‘˜èƒ½å¤Ÿé«˜æ•ˆåœ°åŒæ—¶æ‰§è¡Œå¤šä¸ªè¿›ç¨‹ã€‚ç„¶è€Œï¼Œç®¡ç†å¹¶å‘æ€§éœ€è¦è°¨æ…Žçš„åŒæ­¥ï¼Œä»¥é¿å…å¸¸è§çš„éšæ‚£ï¼Œå¦‚ç«žèµ›æ¡ä»¶ï¼Œå³ä¸¤ä¸ªæˆ–å¤šä¸ªè¿›ç¨‹è¯•å›¾åŒæ—¶ä¿®æ”¹å…±äº«æ•°æ®ã€‚Mutexï¼ˆäº’æ–¥é”ï¼‰æ˜¯ Go ç¨‹åºå‘˜å¹¶å‘å·¥å…·åŒ…ä¸­çš„ä¸€ä¸ªé‡è¦å·¥å…·ã€‚æœ¬æ–‡å°†æŽ¢è®¨ Golang Mutex çš„å¤æ‚æ€§ï¼Œè¯´æ˜Žä½•æ—¶ä»¥åŠå¦‚ä½•æ­£ç¡®ä½¿ç”¨å®ƒï¼Œä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œç¨‹åºç¨³å®šæ€§ã€‚ Understanding Golang MutexMutex æ˜¯ä¸€ç§åŒæ­¥åŽŸè¯­ï¼Œå¯ç”¨äºŽç¡®ä¿æ¯æ¬¡åªæœ‰ä¸€ä¸ª goroutine è®¿é—®ä»£ç çš„å…³é”®éƒ¨åˆ†ã€‚å®ƒç”¨äºŽä¿æŠ¤å¹¶å‘ç¨‹åºï¼ˆç”± Go è¿è¡Œæ—¶ç®¡ç†çš„è½»é‡çº§çº¿ç¨‹ï¼‰å¯¹æ•°æ®å’Œå…¶ä»–èµ„æºçš„è®¿é—®ã€‚ åœ¨ Go ä¸­ï¼Œäº’æ–¥ç”± sync åŒ…æä¾›ï¼Œä¸»è¦ç±»åž‹æ˜¯ sync.Mutex å’Œ sync.RWMutexï¼š sync.Mutex æä¾›äº†ä¸€ç§åŸºæœ¬çš„é”å®šæœºåˆ¶ï¼›å½“ä¸€ä¸ª goroutine é”å®šä¸€ä¸ª Mutex æ—¶ï¼Œä»»ä½•å…¶ä»–è¯•å›¾é”å®šå®ƒçš„ goroutine éƒ½ä¼šé˜»å¡žï¼Œç›´åˆ°å®ƒè¢«è§£é”ã€‚ sync.RWMutex æ˜¯ä¸€ç§è¯»/å†™äº’æ–¥å™¨ï¼Œå…è®¸å¤šä¸ªè¯»å–å™¨æˆ–ä¸€ä¸ªå†™å…¥å™¨ï¼Œä½†ä¸èƒ½åŒæ—¶è¯»å†™ã€‚ When to Use a Mutexåœ¨ä¸‹åˆ—æƒ…å†µä¸‹åº”ä½¿ç”¨ mutex: ä»£ç ä¸­æœ‰ä¸€äº›å…³é”®éƒ¨åˆ†éœ€è¦è®¿é—®å…±äº«æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®å¯èƒ½ä¼šè¢«å¤šä¸ªç¨‹åºåŒæ—¶è®¿é—®ã€‚ éœ€è¦ç¡®ä¿åœ¨ä»»ä½•ç»™å®šæ—¶é—´å†…åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥è®¿é—®æˆ–ä¿®æ”¹å…±äº«æ•°æ®ï¼Œä»¥é˜²æ­¢æ•°æ®ç«žäº‰ã€‚ è¦å¤„ç†çš„æ˜¯å¹¶å‘çŽ¯å¢ƒä¸­çš„æœ‰çŠ¶æ€ç»„ä»¶æˆ–èµ„æºã€‚ How to Use a Mutex: Guidelines and Best PracticesåŸºæœ¬ç”¨æ³•ä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ sync.Mutex ä¿æŠ¤å…±äº«æ•°æ®ç»“æž„çš„ç®€å•ç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142package mainimport ( &quot;fmt&quot; &quot;sync&quot;)type SafeCounter struct &#123; val int mux sync.Mutex&#125;// Inc increments the counter safely.func (c *SafeCounter) Inc() &#123; c.mux.Lock() c.val++ c.mux.Unlock()&#125;// Value returns the current value of the counter safely.func (c *SafeCounter) Value() int &#123; c.mux.Lock() defer c.mux.Unlock() return c.val&#125;func main() &#123; c := SafeCounter&#123;&#125; var wg sync.WaitGroup // Start 100 goroutines to increment the counter. for i := 0; i &lt; 100; i++ &#123; wg.Add(1) go func() &#123; c.Inc() wg.Done() &#125;() &#125; wg.Wait() fmt.Println(c.Value()) // Output: 100&#125; Lock å’ŒUnlock è¦é è¿‘ï¼šå°½å¯èƒ½ç¼©å°é”å®šçš„éƒ¨åˆ†ï¼Œå¹¶åœ¨æœ€è¿‘çš„æœºä¼šè§£é”äº’æ–¥ï¼Œå¯ä»¥æ˜Žç¡®ä½¿ç”¨ Unlock() æˆ–åœ¨é”å®šåŽä½¿ç”¨ deferï¼ˆå¦‚æžœå‡½æ•°æœ‰å¤šä¸ªé€€å‡ºç‚¹ï¼‰ã€‚ ä½¿ç”¨ defer æ¥ Unlockè¦ç¡®ä¿å§‹ç»ˆè§£é”äº’æ–¥é¡¹ï¼Œå³ä½¿å‘ç”Ÿ panicï¼Œä¹Ÿè¦åœ¨é”å®šåŽç«‹å³ä½¿ç”¨å»¶è¿Ÿã€‚ é¿å…åµŒå¥—é”åµŒå¥—é”å¯èƒ½å¯¼è‡´æ­»é”ï¼Œå³ä¸¤ä¸ªæˆ–å¤šä¸ªç¨‹åºäº’ç›¸ç­‰å¾…å¯¹æ–¹é‡Šæ”¾é”ã€‚è¯·è°¨æ…Žè®¾è®¡å¹¶å‘æ¨¡åž‹ï¼Œä»¥é˜²æ­¢å‡ºçŽ°è¿™ç§æƒ…å†µã€‚ ä½¿ç”¨ RWMutex å¤„ç†è¯»å–ç¹é‡çš„å·¥ä½œè´Ÿè½½å½“å…±äº«èµ„æºçš„è¯»å–æ¬¡æ•°å¤šäºŽå†™å…¥æ¬¡æ•°æ—¶ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ sync.RWMutexã€‚å®ƒå…è®¸å¤šä¸ªç¨‹åºåŒæ—¶è¯»å–èµ„æºï¼Œåªåœ¨å†™å…¥æ—¶é”å®šï¼Œä»Žè€Œæé«˜äº†æ•ˆçŽ‡ã€‚ ç»“è®ºåœ¨ Go çš„å¹¶å‘é¢†åŸŸï¼Œmutex å°±åƒä¸€ä¸ªå“¨å…µï¼Œä¿æŠ¤ç€å…±äº«æ•°æ®ã€‚è¦é¿å…å¹¶å‘ç¼–ç¨‹ä¸­çš„å±é™©é™·é˜±ï¼ˆå¦‚ç«žäº‰æ¡ä»¶ï¼‰ï¼Œæ­£ç¡®ä½¿ç”¨äº’æ–¥æ˜¯è‡³å…³é‡è¦çš„ã€‚é€šè¿‡éµå®ˆæœ¬æ–‡æ¦‚è¿°çš„åŽŸåˆ™å’Œå®žè·µï¼Œå¼€å‘äººå‘˜å¯ä»¥åˆ©ç”¨ Go å¹¶å‘æ¨¡åž‹çš„å¼ºå¤§åŠŸèƒ½ï¼ŒåŒæ—¶ç¡®ä¿æ•°æ®å®Œæ•´æ€§å’Œç¨‹åºå¯é æ€§]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang ä¸­ JSON æ“ä½œçš„ 5 ä¸ªå¸¸è§é™·é˜±]]></title>
    <url>%2F2024%2F05%2F25%2FGolang-%E4%B8%AD-JSON-%E6%93%8D%E4%BD%9C%E7%9A%84-5-%E4%B8%AA%E5%B8%B8%E8%A7%81%E9%99%B7%E9%98%B1%2F</url>
    <content type="text"><![CDATA[JSON æ˜¯è®¸å¤šå¼€å‘äººå‘˜åœ¨å·¥ä½œä¸­ç»å¸¸ä½¿ç”¨çš„ä¸€ç§æ•°æ®æ ¼å¼ã€‚å®ƒä¸€èˆ¬ç”¨äºŽé…ç½®æ–‡ä»¶æˆ–ç½‘ç»œæ•°æ®ä¼ è¾“ç­‰åœºæ™¯ã€‚ç”±äºŽå…¶ç®€å•ã€æ˜“æ‡‚ã€å¯è¯»æ€§å¥½ï¼ŒJSON å·²æˆä¸ºæ•´ä¸ª IT ç•Œæœ€å¸¸ç”¨çš„æ ¼å¼ä¹‹ä¸€ã€‚å¯¹äºŽè¿™ç§æƒ…å†µï¼ŒGolang å’Œè®¸å¤šå…¶ä»–è¯­è¨€ä¸€æ ·ï¼Œä¹Ÿæä¾›äº†æ ‡å‡†åº“çº§åˆ«çš„æ”¯æŒ, encoding/jsonã€‚ å°±åƒ JSON æœ¬èº«å¾ˆå®¹æ˜“ç†è§£ä¸€æ ·ï¼Œç”¨äºŽæ“ä½œ JSON çš„ç¼–ç /JSON åº“ä¹Ÿéžå¸¸å®¹æ˜“ä½¿ç”¨ã€‚ä½†æˆ‘ç›¸ä¿¡ï¼Œå¾ˆå¤šå¼€å‘è€…å¯èƒ½ä¼šåƒæˆ‘ç¬¬ä¸€æ¬¡ä½¿ç”¨è¿™ä¸ªåº“æ—¶ä¸€æ ·ï¼Œé‡åˆ°å„ç§å¥‡æ€ªçš„é—®é¢˜æˆ– bugã€‚æœ¬æ–‡æ€»ç»“äº†æˆ‘ä¸ªäººåœ¨ä½¿ç”¨ Golang æ“ä½œ JSON æ—¶é‡åˆ°çš„é—®é¢˜å’Œé”™è¯¯ã€‚å¸Œæœ›èƒ½å¸®åŠ©æ›´å¤šé˜…è¯»æœ¬æ–‡çš„å¼€å‘è€…æŽŒæ¡ Golang çš„ä½¿ç”¨æŠ€å·§ï¼Œæ›´æ­£ç¡®åœ°æ“ä½œ JSONï¼Œé¿å…è°ƒç”¨ä¸å¿…è¦çš„â€å‘â€ã€‚ æœ¬æ–‡å†…å®¹åŸºäºŽ Go 1.22ã€‚ä¸åŒç‰ˆæœ¬ä¹‹é—´å¯èƒ½å­˜åœ¨ç»†å¾®å·®åˆ«ã€‚è¯»è€…åœ¨é˜…è¯»å’Œä½¿ç”¨æ—¶è¯·æ³¨æ„ã€‚åŒæ—¶ï¼Œæœ¬æ–‡åˆ—å‡ºçš„æ‰€æœ‰æ¡ˆä¾‹å‡ä½¿ç”¨ encoding/jsonï¼Œä¸æ¶‰åŠä»»ä½•ç¬¬ä¸‰æ–¹ JSON åº“ã€‚ åŸºæœ¬ç”¨æ³•å…ˆæ¥çœ‹ä¸‹ encoding/json çš„åŸºæœ¬ç”¨æ³•ã€‚ä½œä¸ºä¸€ç§æ•°æ®æ ¼å¼ï¼ŒJSON çš„æ ¸å¿ƒæ“ä½œåªæœ‰ä¸¤ä¸ªï¼šåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚åºåˆ—åŒ–æ˜¯å°† Go å¯¹è±¡è½¬æ¢ä¸º JSON æ ¼å¼çš„å­—ç¬¦ä¸²ï¼ˆæˆ–å­—èŠ‚åºåˆ—ï¼‰ã€‚ååºåˆ—åŒ–åˆ™ç›¸åï¼Œæ˜¯å°† JSON æ ¼å¼çš„æ•°æ®è½¬æ¢æˆ Go å¯¹è±¡ã€‚ è¿™é‡Œæåˆ°çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå®½æ³›çš„æ¦‚å¿µã€‚å®ƒä¸ä»…æŒ‡ç»“æž„å¯¹è±¡ï¼Œè¿˜åŒ…æ‹¬åˆ‡ç‰‡å’Œæ˜ å°„ç±»åž‹çš„æ•°æ®ã€‚å®ƒä»¬ä¹Ÿæ”¯æŒ JSON åºåˆ—åŒ–ã€‚ 12345678910111213141516171819202122232425262728293031import ( "encoding/json" "fmt")type Person struct &#123; ID uint Name string Age int&#125;func MarshalPerson() &#123; p := Person&#123; ID: 1, Name: "Bruce", Age: 18, &#125; output, err := json.Marshal(p) if err != nil &#123; panic(err) &#125; println(string(output))&#125;func UnmarshalPerson() &#123; str := `&#123;"ID":1,"Name":"Bruce","Age":18&#125;` var p Person err := json.Unmarshal([]byte(str), &amp;p) if err != nil &#123; panic(err) &#125; fmt.Printf("%+v\n", p)&#125; æ ¸å¿ƒæ˜¯ä¸¤ä¸ªå‡½æ•° json.Marshal å’Œ json.Unmarshalï¼Œåˆ†åˆ«ç”¨äºŽåºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ä¼šè¿”å›žé”™è¯¯ï¼Œåœ¨è¿™é‡Œæˆ‘åªæ˜¯ç®€å•åœ° panic ä¸€ä¸‹ã€‚ä½¿ç”¨è¿‡ encoding/json çš„è¯»è€…å¯èƒ½çŸ¥é“ï¼Œè¿˜æœ‰å¦ä¸€å¯¹å·¥å…·ä¼šç»å¸¸ç”¨åˆ°ï¼šNewEncoder å’Œ NewDecoderã€‚ç®€å•çœ‹ä¸€ä¸‹æºä»£ç å°±ä¼šå‘çŽ°ï¼Œè¿™ä¸¤ä¸ªå·¥å…·çš„åº•å±‚æ ¸å¿ƒé€»è¾‘è°ƒç”¨ä¸Ž Marshal æ˜¯ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘å°±ä¸åœ¨è¿™é‡Œä¸¾ä¾‹è¯´æ˜Žäº†ã€‚ å¸¸è§çš„ â€˜å‘â€™1. public or private å­—æ®µå¤„ç†è¿™å¯èƒ½æ˜¯åˆšæŽ¥è§¦ Go çš„å¼€å‘äººå‘˜æœ€å®¹æ˜“çŠ¯çš„é”™è¯¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœæˆ‘ä»¬ä½¿ç”¨ç»“æž„ä½“å¤„ç† JSONï¼Œé‚£ä¹ˆç»“æž„ä½“çš„æˆå‘˜å­—æ®µå¿…é¡»æ˜¯å…¬æœ‰çš„ï¼Œå³é¦–å­—æ¯å¤§å†™çš„ï¼Œè€Œç§æœ‰æˆå‘˜æ˜¯æ— æ³•è§£æžçš„ã€‚ä¾‹å¦‚ï¼š 12345678910111213141516171819202122232425262728293031type Person struct &#123; ID uint Name string age int&#125;func MarshalPerson() &#123; p := Person&#123; ID: 1, Name: &quot;Bruce&quot;, age: 18, &#125; output, err := json.Marshal(p) if err != nil &#123; panic(err) &#125; println(string(output))&#125;func UnmarshalPerson() &#123; str := `&#123;&quot;ID&quot;:1,&quot;Name&quot;:&quot;Bruce&quot;,&quot;age&quot;:18&#125;` var p Person err := json.Unmarshal([]byte(str), &amp;p) if err != nil &#123; panic(err) &#125; fmt.Printf(&quot;%+v\n&quot;, p)&#125;// Output Marshal:&#123;&quot;ID&quot;:1,&quot;Name&quot;:&quot;Bruce&quot;&#125;// Output Unmarshal:&#123;ID:1 Name:Bruce age:0&#125; åœ¨è¿™é‡Œï¼Œage è¢«è®¾ç½®ä¸ºç§æœ‰å˜é‡ï¼Œå› æ­¤åºåˆ—åŒ–çš„ JSON å­—ç¬¦ä¸²ä¸­æ²¡æœ‰ age å­—æ®µã€‚åŒæ ·ï¼Œåœ¨å°† JSON å­—ç¬¦ä¸²ååºåˆ—åŒ–ä¸º Person æ—¶ï¼Œä¹Ÿæ— æ³•æ­£ç¡®è¯»å– age çš„å€¼ã€‚åŽŸå› å¾ˆç®€å•ã€‚å¦‚æžœæˆ‘ä»¬æ·±å…¥ç ”ç©¶ Marshal ä¸‹çš„æºä»£ç ï¼Œå°±ä¼šå‘çŽ°å®ƒå®žé™…ä¸Šä½¿ç”¨äº† reflect æ¥åŠ¨æ€è§£æž struct å¯¹è±¡ï¼š1234567// .../src/encoding/json/encode.gofunc (e *encodeState) marshal(v any, opts encOpts) (err error) &#123; // ...skip e.reflectValue(reflect.ValueOf(v), opts) return nil&#125; è€Œ Golang åœ¨è¯­è¨€è®¾è®¡å±‚é¢ç¦æ­¢å¯¹ç»“æž„çš„ç§æœ‰æˆå‘˜è¿›è¡Œåå°„å¼è®¿é—®ï¼Œå› æ­¤è¿™ç§åå°„å¼è§£æžè‡ªç„¶ä¼šå¤±è´¥ï¼Œååºåˆ—åŒ–ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ 2. è­¦æƒ•ç»“æž„ä½“ç»„åˆGo æ˜¯é¢å‘å¯¹è±¡çš„ï¼Œä½†å®ƒæ²¡æœ‰ç±»ï¼Œåªæœ‰ç»“æž„ï¼Œè€Œç»“æž„æ²¡æœ‰ç»§æ‰¿æ€§ã€‚å› æ­¤ï¼ŒGo ä½¿ç”¨ä¸€ç§ç»„åˆæ¥é‡ç”¨ä¸åŒçš„ç»“æž„ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œè¿™ç§ç»„åˆéžå¸¸æ–¹ä¾¿ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åƒæ“ä½œç»“æž„æœ¬èº«çš„æˆå‘˜ä¸€æ ·æ“ä½œç»„åˆä¸­çš„å…¶ä»–æˆå‘˜ï¼Œå°±åƒä¸‹é¢è¿™æ ·ï¼š 1234567891011121314151617181920212223242526272829type Person struct &#123; ID uint Name string address&#125;type address struct &#123; Code int Street string&#125;func (a address) PrintAddr() &#123; fmt.Println(a.Code, a.Street)&#125;func Group() &#123; p := Person&#123; ID: 1, Name: &quot;Bruce&quot;, address: address&#123; Code: 100, Street: &quot;Main St&quot;, &#125;, &#125; // Access all address&apos;s fields and methods directly fmt.Println(p.Code, p.Street) p.PrintAddr()&#125;// Output100 Main St100 Main St ç»“æž„ä½“ç»„åˆä½¿ç”¨èµ·æ¥ç¡®å®žæŒºæ–¹ä¾¿ã€‚ä¸è¿‡ï¼Œåœ¨ä½¿ç”¨ JSON è§£æžæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€ä¸ªå°é—®é¢˜ã€‚è¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031// The structure used here is the same as the previous one, // so I won&apos;t repeat it. error is also not captured to save space.func MarshalPerson() &#123; p := Person&#123; ID: 1, Name: &quot;Bruce&quot;, address: address&#123; Code: 100, Street: &quot;Main St&quot;, &#125;, &#125; // It would be more pretty by MarshalIndent output, _ := json.MarshalIndent(p, &quot;&quot;, &quot; &quot;) println(string(output))&#125;func UnmarshalPerson() &#123; str := `&#123;&quot;ID&quot;:1,&quot;Name&quot;:&quot;Bruce&quot;,&quot;address&quot;:&#123;&quot;Code&quot;:100,&quot;Street&quot;:&quot;Main St&quot;&#125;&#125;` var p Person _ = json.Unmarshal([]byte(str), &amp;p) fmt.Printf(&quot;%+v\n&quot;, p)&#125;// Output MarshalPerson:&#123; &quot;ID&quot;: 1, &quot;Name&quot;: &quot;Bruce&quot;, &quot;Code&quot;: 100, &quot;Street&quot;: &quot;Main St&quot;&#125;// Ouptput UnmarshalPerson:&#123;ID:1 Name:Bruce address:&#123;Code:0 Street:&#125;&#125; è¿™é‡Œå…ˆå£°æ˜Žä¸€ä¸ª Person å¯¹è±¡ï¼Œç„¶åŽä½¿ç”¨ MarshalIndent ç¾ŽåŒ–åºåˆ—åŒ–ç»“æžœå¹¶æ‰“å°å‡ºæ¥ã€‚ä»Žæ‰“å°è¾“å‡ºä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œæ•´ä¸ª Person å¯¹è±¡éƒ½è¢«æ‰å¹³åŒ–äº†ã€‚å°± Person ç»“æž„è€Œè¨€ï¼Œå°½ç®¡è¿›è¡Œäº†ç»„åˆï¼Œä½†å®ƒçœ‹èµ·æ¥ä»æœ‰ä¸€ä¸ªåœ°å€æˆå‘˜å­—æ®µã€‚å› æ­¤ï¼Œæœ‰æ—¶æˆ‘ä»¬ä¼šæƒ³å½“ç„¶åœ°è®¤ä¸º Person çš„åºåˆ—åŒ– JSON çœ‹èµ·æ¥æ˜¯è¿™æ ·çš„ï¼š123456789// The imagine of JSON serialization result&#123; &quot;ID&quot;: 1, &quot;Name&quot;: &quot;Bruce&quot;, &quot;address&quot;: &#123; &quot;Code&quot;: 100, &quot;Street&quot;: &quot;Main St&quot; &#125;&#125; ä½†äº‹å®žå¹¶éžå¦‚æ­¤ï¼Œå®ƒè¢«æ‰å¹³åŒ–äº†ã€‚è¿™æ›´ç¬¦åˆæˆ‘ä»¬ä¹‹å‰ç›´æŽ¥é€šè¿‡ Person è®¿é—®åœ°å€æˆå‘˜æ—¶çš„æ„Ÿè§‰ï¼Œå³åœ°å€æˆå‘˜ä¼¼ä¹Žç›´æŽ¥æˆä¸ºäº† Person çš„æˆå‘˜ã€‚è¿™ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå› ä¸ºè¿™ç§ç»„åˆä¼šä½¿åºåˆ—åŒ–åŽçš„ JSON ç»“æžœæ‰å¹³åŒ–ã€‚ å¦ä¸€ä¸ªæœ‰ç‚¹è¿åç›´è§‰çš„é—®é¢˜æ˜¯ï¼Œåœ°å€ç»“æž„æ˜¯ä¸€ä¸ªç§æœ‰ç»“æž„ï¼Œè€Œç§æœ‰æˆå‘˜ä¼¼ä¹Žä¸åº”è¯¥è¢«åºåˆ—åŒ–ï¼Ÿæ²¡é”™ï¼Œè¿™ä¹Ÿæ˜¯è¿™ç§ç»„åˆç»“æž„ä½“åš JSON è§£æžçš„ç¼ºç‚¹ä¹‹ä¸€ï¼šå®ƒæš´éœ²äº†ç§æœ‰ç»„åˆå¯¹è±¡çš„å…¬å…±æˆå‘˜ã€‚å¦‚æžœæ²¡æœ‰ç‰¹æ®Šéœ€è¦ï¼ˆä¾‹å¦‚ï¼ŒåŽŸå§‹ JSON æ•°æ®å·²è¢«æ‰å¹³åŒ–ï¼Œå¹¶ä¸”æœ‰å¤šä¸ªç»“æž„ä½“çš„é‡å¤å­—æ®µéœ€è¦é‡å¤ä½¿ç”¨ï¼‰ï¼Œä»Žæˆ‘ä¸ªäººçš„è§’åº¦æ¥çœ‹ï¼Œå»ºè®®è¿™æ ·ç¼–å†™ï¼š12345type Person struct &#123; ID int Name string Address address&#125; 3. ååºåˆ—åŒ–éƒ¨åˆ†æˆå‘˜å­—æ®µç›´æŽ¥æŸ¥çœ‹ä»£ç ï¼š 1234567891011121314151617181920212223type Person struct &#123; ID uint Name string&#125;// PartUpdateIssue simulates parsing two different // JSON strings with the same structurefunc PartUpdateIssue() &#123; var p Person // The first data has the ID field and is not 0 str := `&#123;&quot;ID&quot;:1,&quot;Name&quot;:&quot;Bruce&quot;&#125;` _ = json.Unmarshal([]byte(str), &amp;p) fmt.Printf(&quot;%+v\n&quot;, p) // The second data does not have an ID field, // deserializing it again with p preserves the last value str = `&#123;&quot;Name&quot;:&quot;Jim&quot;&#125;` _ = json.Unmarshal([]byte(str), &amp;p) // Notice the output ID is still 1 fmt.Printf(&quot;%+v\n&quot;, p)&#125;// Output&#123;ID:1 Name:Bruce&#125;&#123;ID:1 Name:Jim&#125; ä»Žä»£ç æ³¨é‡Šä¸­å¯ä»¥çŸ¥é“ï¼Œå½“æˆ‘ä»¬é‡å¤ä½¿ç”¨åŒä¸€ç»“æž„æ¥ååºåˆ—åŒ–ä¸åŒçš„ JSON æ•°æ®æ—¶ï¼Œä¸€æ—¦æŸä¸ª JSON æ•°æ®çš„å€¼åªåŒ…å«éƒ¨åˆ†æˆå‘˜å­—æ®µï¼Œé‚£ä¹ˆæœªåŒ…å«çš„æˆå‘˜å°±ä¼šä½¿ç”¨æœ€åŽä¸€æ¬¡ååºåˆ—åŒ–çš„å€¼ï¼Œä¼šäº§ç”Ÿè„æ•°æ®æ±¡æŸ“é—®é¢˜ã€‚ 4. å¤„ç†æŒ‡é’ˆå­—æ®µè®¸å¤šå¼€å‘äººå‘˜ä¸€å¬åˆ°æŒ‡é’ˆè¿™ä¸ªè¯å°±å¤´ç–¼ä¸å·²ï¼Œå…¶å®žå¤§å¯ä¸å¿…ã€‚ä½† Go ä¸­çš„æŒ‡é’ˆç¡®å®žç»™å¼€å‘äººå‘˜å¸¦æ¥äº† Go ç¨‹åºä¸­æœ€å¸¸è§çš„ panic ä¹‹ä¸€ï¼šç©ºæŒ‡é’ˆå¼‚å¸¸ã€‚å½“æŒ‡é’ˆä¸Ž JSON ç»“åˆæ—¶ä¼šå‘ç”Ÿä»€ä¹ˆå‘¢ï¼Ÿ çœ‹ä¸‹é¢çš„ä»£ç :12345678910111213141516type Person struct &#123; ID uint Name string Address *Address&#125;func UnmarshalPtr() &#123; str := `&#123;&quot;ID&quot;:1,&quot;Name&quot;:&quot;Bruce&quot;&#125;` var p Person _ = json.Unmarshal([]byte(str), &amp;p) fmt.Printf(&quot;%+v\n&quot;, p) // It would panic this line // fmt.Printf(&quot;%+v\n&quot;, p.Address.Street)&#125;// Output&#123;ID:1 Name:Bruce Address:&lt;nil&gt;&#125; æˆ‘ä»¬å°† Address æˆå‘˜å®šä¹‰ä¸ºæŒ‡é’ˆï¼Œå½“æˆ‘ä»¬ååºåˆ—åŒ–ä¸€æ®µä¸åŒ…å« Address çš„ JSON æ•°æ®æ—¶ï¼ŒæŒ‡é’ˆå­—æ®µä¼šè¢«è®¾ç½®ä¸º nilï¼Œå› ä¸ºå®ƒæ²¡æœ‰å¯¹åº”çš„æ•°æ®ã€‚å¦‚æžœæˆ‘ä»¬ç›´æŽ¥è°ƒç”¨ p.Address.xxxï¼Œç¨‹åºä¼šå› ä¸º p.Address ä¸ºç©ºè€Œå´©æºƒã€‚ å› æ­¤ï¼Œå¦‚æžœæœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘æˆ‘ä»¬ç»“æž„ä¸­çš„ä¸€ä¸ªæˆå‘˜ï¼Œè¯·è®°ä½åœ¨ä½¿ç”¨å®ƒä¹‹å‰å…ˆç¡®å®šæŒ‡é’ˆæ˜¯å¦ä¸º nilã€‚è¿™æœ‰ç‚¹ç¹çï¼Œä½†ä¹Ÿæ²¡åŠžæ³•ã€‚æ¯•ç«Ÿï¼Œç¼–å†™å‡ è¡Œä»£ç ä¸Žç”Ÿäº§çŽ¯å¢ƒä¸­çš„ panic æ‰€é€ æˆçš„æŸå¤±ç›¸æ¯”å¯èƒ½å¹¶ä¸ç®—ä»€ä¹ˆã€‚ æ­¤å¤–ï¼Œåœ¨åˆ›å»ºå¸¦æœ‰æŒ‡é’ˆå­—æ®µçš„ç»“æž„æ—¶ï¼ŒæŒ‡é’ˆå­—æ®µçš„èµ‹å€¼ä¹Ÿä¼šç›¸å¯¹ç¹çï¼š 123456789101112131415type Person struct &#123; ID int Name string Age *int &#125;func Foo() &#123; p := Person&#123; ID: 1, Name: &quot;Bruce&quot;, Age: new(int), &#125; *p.Age = 20 // ...&#125; 5. é›¶å€¼ï¼ˆé»˜è®¤å€¼ï¼‰å¯èƒ½é€ æˆçš„é—®é¢˜é›¶å€¼æ˜¯ Golang å˜é‡çš„ä¸€ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†å…¶è§†ä¸ºé»˜è®¤å€¼ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æžœæˆ‘ä»¬æ²¡æœ‰æ˜¾å¼åœ°ç»™å˜é‡èµ‹å€¼ï¼ŒGolang å°±ä¼šç»™å®ƒèµ‹ä¸€ä¸ªé»˜è®¤å€¼ã€‚ä¾‹å¦‚ï¼Œæˆ‘ä»¬åœ¨å‰é¢çš„ä¾‹å­ä¸­çœ‹åˆ°ï¼Œint çš„é»˜è®¤å€¼ä¸º 0ï¼Œstring çš„é»˜è®¤å€¼ä¸ºç©ºå­—ç¬¦ä¸²ï¼ŒæŒ‡é’ˆçš„é›¶å€¼ä¸º nilï¼Œç­‰ç­‰ã€‚ å¤„ç†å¸¦æœ‰é›¶å€¼çš„ JSON æœ‰å“ªäº›éšæ‚£ï¼Ÿè¯·çœ‹ä¸‹é¢çš„ä¾‹å­ï¼š123456789101112131415161718type Person struct &#123; Name string ChildrenCnt int&#125;func ZeroValueConfusion() &#123; str := `&#123;&quot;Name&quot;:&quot;Bruce&quot;&#125;` var p Person _ = json.Unmarshal([]byte(str), &amp;p) fmt.Printf(&quot;%+v\n&quot;, p) str2 := `&#123;&quot;Name&quot;:&quot;Jim&quot;,&quot;ChildrenCnt&quot;:0&#125;` var p2 Person _ = json.Unmarshal([]byte(str2), &amp;p2) fmt.Printf(&quot;%+v\n&quot;, p2)&#125;// Output&#123;Name:Bruce ChildrenCnt:0&#125;&#123;Name:Jim ChildrenCnt:0&#125; æˆ‘ä»¬åœ¨ Person ç»“æž„ä¸­æ·»åŠ äº†ä¸€ä¸ª ChildrenCnt å­—æ®µï¼Œç”¨äºŽè®¡ç®—è¯¥äººçš„å­å¥³æ•°é‡ã€‚ç”±äºŽè¯¥å­—æ®µçš„å€¼ä¸ºé›¶ï¼Œå½“ p åŠ è½½çš„ JSON æ•°æ®ä¸­æ²¡æœ‰ ChildrenCnt æ•°æ®æ—¶ï¼Œè¯¥å­—æ®µçš„èµ‹å€¼ä¸º 0ã€‚åœ¨ Bruce å’Œ Jim çš„ä¾‹å­ä¸­ï¼Œç”±äºŽæ•°æ®ç¼ºå¤±ï¼Œå…¶ä¸­ä¸€ä¸ªçš„å­å¥³æ•°ä¸º 0ï¼Œè€Œå¦ä¸€ä¸ªçš„å­å¥³æ•°ä¸º 0ã€‚è€Œå®žé™…ä¸Šå¸ƒé²æ–¯çš„å­å¥³æ•°åº”è¯¥æ˜¯ â€œæœªçŸ¥â€ï¼Œå¦‚æžœæˆ‘ä»¬çœŸçš„å°†å…¶è§†ä¸º 0ï¼Œå¯èƒ½ä¼šåœ¨ä¸šåŠ¡ä¸Šé€ æˆé—®é¢˜ã€‚åœ¨ä¸€äº›å¯¹æ•°æ®æœ‰ä¸¥æ ¼è¦æ±‚çš„åœºæ™¯ä¸­ï¼Œè¿™ç§æ··æ·†æ˜¯éžå¸¸è‡´å‘½çš„ã€‚é‚£ä¹ˆï¼Œæœ‰æ²¡æœ‰åŠžæ³•é¿å…è¿™ç§é›¶å€¼å¹²æ‰°å‘¢ï¼Ÿè®©æˆ‘ä»¬å°† Person çš„ ChildrenCnt ç±»åž‹æ”¹ä¸º *int å¹¶çœ‹çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š 1234567type Person struct &#123; Name string ChildrenCnt *int&#125;// Output&#123;Name:Bruce ChildrenCnt:&lt;nil&gt;&#125;&#123;Name:Jim ChildrenCnt:0xc0000124c8&#125; ä¸åŒä¹‹å¤„åœ¨äºŽ Bruce æ²¡æœ‰æ•°æ®ï¼Œå› æ­¤ ChildrenCnt ä¸ºé›¶ï¼Œè€Œ Jim æ˜¯ä¸€ä¸ªéžé›¶æŒ‡é’ˆã€‚è¿™æ ·å°±å¾ˆæ˜Žæ˜¾äº†ï¼ŒBruc çš„å­©å­æ•°é‡æ˜¯æœªçŸ¥çš„ã€‚ ä»Žæœ¬è´¨ä¸Šè®²ï¼Œè¿™ç§æ–¹æ³•ä»ç„¶ä½¿ç”¨é›¶å€¼ï¼Œå³æŒ‡é’ˆçš„é›¶å€¼ï¼Œæœ‰ç‚¹åƒä»¥æ¯’æ”»æ¯’ï¼ˆç¬‘ï¼‰ã€‚ æ€»ç»“ åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘åˆ—ä¸¾äº†è‡ªå·±åœ¨ä½¿ç”¨ç¼–ç /json åº“æ—¶çŠ¯è¿‡çš„ 7 ä¸ªé”™è¯¯ï¼Œå…¶ä¸­å¤§éƒ¨åˆ†éƒ½æ˜¯æˆ‘åœ¨å·¥ä½œä¸­é‡åˆ°çš„ã€‚å¦‚æžœä½ è¿˜æ²¡æœ‰é‡åˆ°è¿‡ï¼Œé‚£ä¹ˆæ­å–œä½ ï¼è¿™ä¹Ÿæé†’æˆ‘ä»¬ä»ŠåŽåœ¨ä½¿ç”¨ JSON æ—¶è¦å°å¿ƒè°¨æ…Žï¼›å¦‚æžœä½ é‡åˆ°è¿‡è¿™äº›é—®é¢˜ï¼Œå¹¶ä¸ºæ­¤æ„Ÿåˆ°å›°æƒ‘ï¼Œå¸Œæœ›æœ¬æ–‡èƒ½å¯¹ä½ æœ‰æ‰€å¸®åŠ©ã€‚]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨ Golang åˆ›å»ºåå‘ä»£ç†]]></title>
    <url>%2F2024%2F05%2F17%2F%E4%BD%BF%E7%94%A8-Golang-%E5%88%9B%E5%BB%BA%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%2F</url>
    <content type="text"><![CDATA[ä¸ºäº†è®© API è¿žæŽ¥æ­£å¸¸å·¥ä½œï¼Œæˆ‘éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æä¾›å®¢æˆ·ç«¯ IDï¼ŒåŸºäºŽç”¨æˆ·åæˆ–å®¢æˆ·ç«¯è¯ä¹¦ï¼Œç„¶åŽå°†æµé‡é‡å®šå‘åˆ°å®ƒã€‚å¬èµ·æ¥åƒæ˜¯ä¸“ç”¨åå‘ä»£ç†è½¯ä»¶ Nginx æˆ– Traefik è¦æ‰§è¡Œçš„ä»»åŠ¡ã€‚çŽ°åœ¨æˆ‘ä»¬æ¥æŽ¢ç´¢ç”¨ Golang æ¥å®žçŽ°åå‘ä»£ç†çš„åŠŸèƒ½ã€‚ å•ä¸»æœºåå‘ä»£ç†å¾—ç›ŠäºŽ Golang æ ‡å‡†åº“ï¼Œä¸€ä¸ªå¼€ç®±å³ç”¨çš„å•ä¸»æœºåå‘ä»£ç†å¯ä»¥å¾ˆå®¹æ˜“åœ°å®žçŽ°ã€‚ 12rp := httputil.NewSingleHostReverseProxy(targetUrl)rp.ServeHTTP(w, r) è¿™æ®µä»£ç åº”è¯¥æ’å…¥æ ‡å‡†çš„ HTTP å¤„ç†ç¨‹åºä¸­ã€‚è¿™é‡Œçš„â€œå•ä¸€ä¸»æœºâ€æ›´å¤šæŒ‡çš„æ˜¯åå‘ä»£ç†åŠŸèƒ½ï¼Œæ²¡æœ‰æä¾›è´Ÿè½½å‡è¡¡åŠŸèƒ½ã€‚ æºå¸¦ header çš„åå‘ä»£ç†è¿™é‡Œä¼šå®žçŽ°ä¸€ä¸ª HTTP å¤„ç†ç¨‹åºï¼Œè¯»å–å®¢æˆ·ç«¯è¯ä¹¦ï¼Œå¹¶æ ¹æ® CN åç§°é€‰æ‹©ä¸€ä¸ªå®¢æˆ·ç«¯ ID å€¼ï¼Œåœ¨ HTTP å¤´éƒ¨ä¸­æ›´æ–°å®ƒï¼Œå¹¶å°†æµé‡é‡å®šå‘åˆ°ç›®æ ‡ URLã€‚ ç»™å‡ºä»¥ä¸‹ç¤ºä¾‹é…ç½®ã€‚ 12345678910111213141516mapping:- name: client1-app1 certCN: user1 clientID: 2a3977e9c4dd4631c9233f2e9387a103- name: client2-app1 certCN: user2 clientID: 939f15e518e75d3c251a1245141c1c48server: port: 8443 certFile: ../certs/server.pem keyFile: ../certs/server-key.pemreverseProxy: targetUrl: https://apis-gw-gateway-apic.apps.dev-ocp414.ibmcloud.io.cpak/porg/mycat/myapi 1234567891011121314151617181920212223func main() &#123; config.WithOptions(config.ParseEnv, func(opt *config.Options) &#123; opt.DecoderConfig.TagName = "yaml" &#125;) config.AddDriver(yaml.Driver) try.E(config.LoadFiles("config.yaml")) var mapping []CnToClientID try.E(config.BindStruct("mapping", &amp;mapping)) targetUrl := try.E1(url.Parse(config.String("reverseProxy.targetUrl"))) http.HandleFunc("/", rpHandler(mapping, targetUrl)) srv := &amp;http.Server&#123; Addr: fmt.Sprintf(":%d", config.Int("server.port")), TLSConfig: &amp;tls.Config&#123; ClientAuth: tls.RequireAnyClientCert, &#125;, &#125; try.E(srv.ListenAndServeTLS(config.String("server.certFile"), config.String("server.keyFile")))&#125; æˆ‘ä»¬ä½¿ç”¨å¸¦æœ‰è¯ä¹¦å’Œå¯†é’¥çš„åŸº äºŽHTTPs çš„æœåŠ¡å™¨ã€‚è¯·æ³¨æ„ TLS é€‰é¡¹ï¼Œæˆ‘ä»¬å°†è¦æ±‚å®¢æˆ·ç«¯æä¾›å…¶è¯ä¹¦ä»¥æå–å…¶ CN åç§°ï¼Œå°½ç®¡æˆ‘ä»¬ä¸æ‰§è¡ŒmTLSã€‚ å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®žçŽ°httpå¤„ç†ç¨‹åº: 123456789101112131415161718192021222324252627282930313233func rpHandler(mapping []CnToClientID, targetUrl *url.URL) func(w http.ResponseWriter, r *http.Request) &#123; return func(w http.ResponseWriter, r *http.Request) &#123; dump, _ := httputil.DumpRequest(r, true) log.Printf("request: %s", dump) if r.TLS == nil &#123; log.Printf("Request must be over TLS") http.Error(w, "Request must be over TLS", http.StatusForbidden) return &#125; if len(r.TLS.PeerCertificates) == 0 &#123; log.Printf("Request must contain a client certificate") http.Error(w, "Request must contain a client certificate", http.StatusForbidden) return &#125; cnName := r.TLS.PeerCertificates[0].Subject.CommonName log.Printf("Client CN: %s", cnName) for _, v := range mapping &#123; if v.CertCN == cnName &#123; rp := httputil.NewSingleHostReverseProxy(targetUrl) r.Header.Set("X-IBM-Client-Id", v.ClientID) rp.ServeHTTP(w, r) return &#125; &#125; // if no match found http.Error(w, "client id not found", http.StatusForbidden) &#125;&#125; åœ¨å¤„ç†ç¨‹åºä¸­ï¼Œé¦–å…ˆæˆ‘ä»¬è¯»å–å®¢æˆ·ç«¯è¯ä¹¦ä»¥èŽ·å–å…¶ CN åç§°ï¼Œç„¶åŽå¾ªçŽ¯éåŽ†é…ç½®ä»¥æ‰¾åˆ°å®¢æˆ·ç«¯ ID å€¼ï¼Œå°†å…¶æ·»åŠ åˆ°è¯·æ±‚å¤´ä¸­ï¼Œç„¶åŽåˆ›å»ºä¸€ä¸ªåå‘ä»£ç†å¯¹è±¡ï¼Œç›®æ ‡ URL æ˜¯è®©å®ƒå¤„ç†è¯¥è¯·æ±‚ã€‚ è‡ªå®šä¹‰ Round Tripæˆ‘ä»¬éœ€è¦ä¸€äº›è‡ªå®šä¹‰æ¥è§£å†³åå‘ä»£ç†çš„é—®é¢˜ï¼Œå¯èƒ½éœ€è¦è·³è¿‡è¯ä¹¦éªŒè¯ï¼Œå› ä¸ºç›®æ ‡ç«¯å¯èƒ½ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ã€‚ è¿™äº›å¯ä»¥é€šè¿‡ RoundTrip çš„æŽ¥å£å®žçŽ°ã€‚ RoundTripperæ˜¯ä¸€ä¸ªæŽ¥å£ï¼Œä»£è¡¨ç€æ‰§è¡Œå•ä¸ªHTTPäº‹åŠ¡çš„èƒ½åŠ›ï¼ŒèŽ·å–ç»™å®šè¯·æ±‚çš„å“åº”ã€‚ 1234567891011type MyRoundTripper struct&#123;&#125;func (MyRoundTripper) RoundTrip(r *http.Request) (*http.Response, error) &#123; dump, _ := httputil.DumpRequest(r, true) log.Printf("request to proxy: %s", dump) insecureTransport := http.DefaultTransport.(*http.Transport).Clone() insecureTransport.TLSClientConfig = &amp;tls.Config&#123;InsecureSkipVerify: true&#125; return insecureTransport.RoundTrip(r)&#125; åœ¨ Roundtrip() ä¸­ï¼Œæˆ‘ä»¬è°ƒç”¨ httputil.DumpRequest æ¥ä¸ºäº†è°ƒè¯•ç›®çš„è€Œè½¬å‚¨è¯·æ±‚ã€‚ ç„¶åŽé‡ç½®å…¶ TLS é…ç½®ä»¥è·³è¿‡è¯ä¹¦éªŒè¯ï¼Œä»¥å…è®¸è‡ªç­¾åè¯ä¹¦é€šè¿‡ã€‚ç„¶åŽæˆ‘ä»¬è°ƒç”¨åŽŸå§‹çš„ RoundTrip() æ¥å¤„ç†è¯·æ±‚ã€‚ ç„¶åŽå¯ä»¥ä½¿ç”¨è‡ªå®šä¹‰çš„ roundtrip æ›´æ–° http å¤„ç†ç¨‹åºã€‚ 12345678...rp := httputil.NewSingleHostReverseProxy(targetUrl)rp.Transport = &amp;MyRoundTripper&#123;&#125;r.Header.Set("X-IBM-Client-Id", v.ClientID)rp.ServeHTTP(w, r)...]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Observability with OpenTelemetry and Go]]></title>
    <url>%2F2024%2F05%2F13%2FObservability-with-OpenTelemetry-and-Go%2F</url>
    <content type="text"><![CDATA[è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä¼šè®¨è®ºå¯è§‚æµ‹æ€§æ¦‚å¿µï¼Œå¹¶äº†è§£äº†æœ‰å…³ OpenTelemetry çš„ä¸€äº›ç»†èŠ‚ï¼Œç„¶åŽä¼šåœ¨ Golang æœåŠ¡ä¸­å¯¹æŽ¥ OpenTelemetry å®žçŽ°åˆ†å¸ƒå¼ç³»ç»Ÿå¯è§‚æµ‹æ€§ã€‚ Test Projectæˆ‘ä»¬å°†ä½¿ç”¨ Go 1.22 å¼€å‘æˆ‘ä»¬çš„æµ‹è¯•æœåŠ¡ã€‚æˆ‘ä»¬å°†æž„å»ºä¸€ä¸ª APIï¼Œè¿”å›žæœåŠ¡çš„åç§°åŠå…¶ç‰ˆæœ¬ã€‚ æˆ‘ä»¬å°†æŠŠæˆ‘ä»¬çš„é¡¹ç›®åˆ†æˆä¸¤ä¸ªç®€å•çš„æ–‡ä»¶ï¼ˆmain.go å’Œ info.goï¼‰ã€‚ 1234567891011121314151617181920212223242526272829// file: main.gopackage mainimport ( "log" "net/http")const portNum string = ":8080"func main() &#123; log.Println("Starting http server.") mux := http.NewServeMux() mux.HandleFunc("/info", info) srv := &amp;http.Server&#123; Addr: portNum, Handler: mux, &#125; log.Println("Started on port", portNum) err := srv.ListenAndServe() if err != nil &#123; log.Println("Fail start http server.") &#125;&#125; 12345678910111213141516171819// file: info.gopackage mainimport ( "encoding/json" "net/http")type InfoResponse struct &#123; Version string `json:"version"` ServiceName string `json:"service-name"`&#125;func info(w http.ResponseWriter, r *http.Request) &#123; w.Header().Set("Content-Type", "application/json") response := InfoResponse&#123;Version: "0.1.0", ServiceName: "otlp-sample"&#125; json.NewEncoder(w).Encode(response)&#125; ä½¿ç”¨ go run . è¿è¡ŒåŽï¼Œåº”è¯¥åœ¨ console ä¸­è¾“å‡ºï¼š 12Starting http server.Started on port :8080 è®¿é—® localhost:8080 ä¼šæ˜¾ç¤ºï¼š 12345// http://localhost:8080/info&#123; "version": "0.1.0", "service-name": "otlp-sample"&#125; çŽ°åœ¨æˆ‘ä»¬çš„æœåŠ¡å·²ç»å¯ä»¥è¿è¡Œäº†ï¼ŒçŽ°åœ¨è¦ä»¥å¯¹å…¶è¿›è¡Œç›‘æŽ§ï¼ˆæˆ–è€…é…ç½®æˆ‘ä»¬çš„æµæ°´çº¿ï¼‰ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°†æ‰§è¡Œæ‰‹åŠ¨ç›‘æŽ§ä»¥ç†è§£ä¸€äº›è§‚æµ‹ç»†èŠ‚ã€‚ First Stepsç¬¬ä¸€æ­¥æ˜¯å®‰è£… Open Telemetry çš„ä¾èµ–ã€‚ 123456go get "go.opentelemetry.io/otel" \ "go.opentelemetry.io/otel/exporters/stdout/stdouttrace" \ "go.opentelemetry.io/otel/metric" \ "go.opentelemetry.io/otel/sdk" \ "go.opentelemetry.io/otel/trace" \ "go.opentelemetry.io/contrib/instrumentation/net/http/otelhttp" ç›®å‰ï¼Œæˆ‘ä»¬åªä¼šå®‰è£…é¡¹ç›®çš„åˆå§‹ä¾èµ–ã€‚è¿™é‡Œæˆ‘ä»¬å°† OpenTelemetry é…ç½® otel.goæ–‡ä»¶ã€‚ åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰ï¼Œå…ˆçœ‹ä¸‹é…ç½®çš„æµæ°´çº¿ï¼š å®šä¹‰ Exporterä¸ºäº†æ¼”ç¤ºç®€å•ï¼Œæˆ‘ä»¬å°†åœ¨è¿™é‡Œä½¿ç”¨ console Exporter ã€‚ 12345678910111213// file: otel.gopackage mainimport ( "context" "go.opentelemetry.io/otel/exporters/stdout/stdouttrace" "go.opentelemetry.io/otel/sdk/trace")func newTraceExporter() (trace.SpanExporter, error) &#123; return stdouttrace.New(stdouttrace.WithPrettyPrint())&#125; main.go çš„ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637// file: main.gopackage mainimport ( "context" "log" "net/http")const portNum string = ":8080"func main() &#123; log.Println("Starting http server.") mux := http.NewServeMux() _, err := newTraceExporter() if err != nil &#123; log.Println("Failed to get console exporter.") &#125; mux.HandleFunc("/info", info) srv := &amp;http.Server&#123; Addr: portNum, Handler: mux, &#125; log.Println("Started on port", portNum) err := srv.ListenAndServe() if err != nil &#123; log.Println("Fail start http server.") &#125;&#125; Traceæˆ‘ä»¬çš„é¦–ä¸ªä¿¡å·å°†æ˜¯ Traceã€‚ä¸ºäº†ä¸Žè¿™ä¸ªä¿¡å·äº’åŠ¨ï¼Œæˆ‘ä»¬å¿…é¡»åˆ›å»ºä¸€ä¸ª providerï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä½œä¸ºä¸€ä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å°†æ‹¥æœ‰ä¸€ä¸ª Exporterï¼Œå®ƒå°†æŽ¥æ”¶æ”¶é›†åˆ°çš„ä¿¡æ¯ã€‚ 12345678910111213141516171819202122// file: otel.gopackage mainimport ( "context" "go.opentelemetry.io/otel/exporters/stdout/stdouttrace" "go.opentelemetry.io/otel/sdk/trace" "time")func newTraceExporter() (trace.SpanExporter, error) &#123; return stdouttrace.New(stdouttrace.WithPrettyPrint())&#125;func newTraceProvider(traceExporter trace.SpanExporter) *trace.TracerProvider &#123; traceProvider := trace.NewTracerProvider( trace.WithBatcher(traceExporter, trace.WithBatchTimeout(time.Second)), ) return traceProvider&#125; åœ¨ main.go æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨åˆ›å»ºè·Ÿè¸ªæä¾›ç¨‹åºçš„å‡½æ•°ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344// file: main.gopackage mainimport ( "context" "go.opentelemetry.io/otel" "log" "net/http")const portNum string = ":8080"func main() &#123; log.Println("Starting http server.") mux := http.NewServeMux() ctx := context.Background() consoleTraceExporter, err := newTraceExporter() if err != nil &#123; log.Println("Failed get console exporter.") &#125; tracerProvider := newTraceProvider(consoleTraceExporter) defer tracerProvider.Shutdown(ctx) otel.SetTracerProvider(tracerProvider) mux.HandleFunc("/info", info) srv := &amp;http.Server&#123; Addr: portNum, Handler: mux, &#125; log.Println("Started on port", portNum) err = srv.ListenAndServe() if err != nil &#123; log.Println("Fail start http server.") &#125;&#125; è¯·æ³¨æ„ï¼Œåœ¨å®žä¾‹åŒ–ä¸€ä¸ª provider æ—¶ï¼Œæˆ‘ä»¬å¿…é¡»ä¿è¯å®ƒä¼šâ€œå…³é—­â€ã€‚è¿™æ ·å¯ä»¥é¿å…å†…å­˜æ³„éœ²ã€‚ çŽ°åœ¨æˆ‘ä»¬çš„æœåŠ¡å·²ç»é…ç½®äº†ä¸€ä¸ª trace providerï¼Œæˆ‘ä»¬å‡†å¤‡å¥½æ”¶é›†æ•°æ®äº†ã€‚è®©æˆ‘ä»¬è°ƒç”¨ â€œ/infoâ€ æŽ¥å£æ¥äº§ç”Ÿæ•°æ®ã€‚ 123456789101112131415161718192021222324252627// file: info.gopackage mainimport ( "encoding/json" "go.opentelemetry.io/otel" "net/http")type InfoResponse struct &#123; Version string `json:"version"` ServiceName string `json:"service-name"`&#125;var ( tracer = otel.Tracer("info-service"))func info(w http.ResponseWriter, r *http.Request) &#123; _, span := tracer.Start(r.Context(), "info") defer span.End() w.Header().Set("Content-Type", "application/json") response := InfoResponse&#123;Version: "0.1.0", ServiceName: "otlp-sample"&#125; json.NewEncoder(w).Encode(response)&#125; tracer = otel.Tracer(â€œinfo-serviceâ€) å°†åœ¨æˆ‘ä»¬å·²ç»åœ¨main.go ä¸­æ³¨å†Œçš„å…¨å±€ trace provider ä¸­åˆ›å»ºä¸€ä¸ªå‘½åçš„è·Ÿè¸ªå™¨ã€‚å¦‚æžœæœªæä¾›åç§°ï¼Œåˆ™å°†ä½¿ç”¨é»˜è®¤åç§°ã€‚ tracer.Start(r.Context(), â€œinfoâ€) åˆ›å»ºä¸€ä¸ª Span å’Œä¸€ä¸ªåŒ…å«æ–°åˆ›å»ºçš„ span çš„ context.Contextã€‚å¦‚æžœ â€œctxâ€ ä¸­æä¾›çš„ context.Context åŒ…å«ä¸€ä¸ª Spanï¼Œé‚£ä¹ˆæ–°åˆ›å»ºçš„ Span å°†æ˜¯è¯¥ Span çš„å­Spanï¼Œå¦åˆ™å®ƒå°†æ˜¯æ ¹ Spanã€‚ Span å¯¹æˆ‘ä»¬æ¥è¯´æ˜¯ä¸€ä¸ªæ–°çš„æ¦‚å¿µã€‚Span ä»£è¡¨ä¸€ä¸ªå·¥ä½œå•å…ƒæˆ–æ“ä½œã€‚Span æ˜¯è·Ÿè¸ªï¼ˆTracesï¼‰çš„æž„å»ºå—ã€‚ åŒæ ·åœ°ï¼Œæ­£å¦‚æä¾›ç¨‹åºä¸€æ ·ï¼Œæˆ‘ä»¬å¿…é¡»å§‹ç»ˆå…³é—­ Spans ä»¥é¿å…â€œå†…å­˜æ³„æ¼â€ã€‚ çŽ°åœ¨ï¼Œæˆ‘ä»¬çš„ç«¯ç‚¹å·²ç»è¢«ç›‘æŽ§ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æŽ§åˆ¶å°ä¸­æŸ¥çœ‹æˆ‘ä»¬çš„è§‚æµ‹æ•°æ®ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566&#123; "Name":"info", "SpanContext":&#123; "TraceID":"6216cbe99bfd1165974dc2bda24e0d5c", "SpanID":"728454ee6b9a72e3", "TraceFlags":"01", "TraceState":"", "Remote":false &#125;, "Parent":&#123; "TraceID":"00000000000000000000000000000000", "SpanID":"0000000000000000", "TraceFlags":"00", "TraceState":"", "Remote":false &#125;, "SpanKind":1, "StartTime":"2024-03-02T23:39:51.791979-03:00", "EndTime":"2024-03-02T23:39:51.792140908-03:00", "Attributes":null, "Events":null, "Links":null, "Status":&#123; "Code":"Unset", "Description":"" &#125;, "DroppedAttributes":0, "DroppedEvents":0, "DroppedLinks":0, "ChildSpanCount":0, "Resource":[ &#123; "Key":"service.name", "Value":&#123; "Type":"STRING", "Value":"unknown_service:otlp-golang" &#125; &#125;, &#123; "Key":"telemetry.sdk.language", "Value":&#123; "Type":"STRING", "Value":"go" &#125; &#125;, &#123; "Key":"telemetry.sdk.name", "Value":&#123; "Type":"STRING", "Value":"opentelemetry" &#125; &#125;, &#123; "Key":"telemetry.sdk.version", "Value":&#123; "Type":"STRING", "Value":"1.24.0" &#125; &#125; ], "InstrumentationLibrary":&#123; "Name":"info-service", "Version":"", "SchemaURL":"" &#125;&#125; æ·»åŠ  Metricsæˆ‘ä»¬å·²ç»æœ‰äº†æˆ‘ä»¬çš„ tracing é…ç½®ã€‚çŽ°åœ¨æ¥æ·»åŠ æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæŒ‡æ ‡ã€‚ é¦–å…ˆï¼Œå®‰è£…å¹¶é…ç½®ä¸€ä¸ªä¸“é—¨ç”¨äºŽæŒ‡æ ‡çš„å¯¼å‡ºå™¨ã€‚ 1go get "go.opentelemetry.io/otel/exporters/stdout/stdoutmetric" é€šè¿‡ä¿®æ”¹æˆ‘ä»¬çš„ otel.go æ–‡ä»¶ï¼Œæˆ‘ä»¬å°†æœ‰ä¸¤ä¸ªå¯¼å‡ºå™¨ï¼šä¸€ä¸ªä¸“é—¨ç”¨äºŽ tracingï¼Œå¦ä¸€ä¸ªç”¨äºŽ metricsã€‚ 123456789// file: otel.gofunc newTraceExporter() (trace.SpanExporter, error) &#123; return stdouttrace.New(stdouttrace.WithPrettyPrint())&#125;func newMetricExporter() (metric.Exporter, error) &#123; return stdoutmetric.New()&#125; çŽ°åœ¨æ·»åŠ æˆ‘ä»¬çš„ metrics Provider å®žä¾‹åŒ–ï¼š 123456789// file: otel.gofunc newMeterProvider(meterExporter metric.Exporter) *metric.MeterProvider &#123; meterProvider := metric.NewMeterProvider( metric.WithReader(metric.NewPeriodicReader(meterExporter, metric.WithInterval(10*time.Second))), ) return meterProvider&#125; æˆ‘å°†æä¾›å•†çš„è¡Œä¸ºæ›´æ”¹ä¸ºæ¯10ç§’è¿›è¡Œä¸€æ¬¡å®šæœŸè¯»å–ï¼ˆé»˜è®¤ä¸º1åˆ†é’Ÿï¼‰ã€‚ åœ¨å®žä¾‹åŒ–ä¸€ä¸ª MeterProvide ræ—¶ï¼Œæˆ‘ä»¬å°†åˆ›å»ºä¸€ä¸ªMeterã€‚Meters å…è®¸æ‚¨åˆ›å»ºæ‚¨å¯ä»¥ä½¿ç”¨çš„ä»ªå™¨ï¼Œä»¥åˆ›å»ºä¸åŒç±»åž‹çš„æŒ‡æ ‡ï¼ˆè®¡æ•°å™¨ã€å¼‚æ­¥è®¡æ•°å™¨ã€ç›´æ–¹å›¾ã€å¼‚æ­¥ä»ªè¡¨ã€å¢žå‡è®¡æ•°å™¨ã€å¼‚æ­¥å¢žå‡è®¡æ•°å™¨â€¦â€¦ï¼‰ã€‚ çŽ°åœ¨æˆ‘ä»¬å¯ä»¥åœ¨ main.go ä¸­é…ç½®æˆ‘ä»¬çš„æ–° exporter å’Œ providerã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041// file: main.gofunc main() &#123; log.Println("Starting http server.") mux := http.NewServeMux() ctx := context.Background() consoleTraceExporter, err := newTraceExporter() if err != nil &#123; log.Println("Failed get console exporter (trace).") &#125; consoleMetricExporter, err := newMetricExporter() if err != nil &#123; log.Println("Failed get console exporter (metric).") &#125; tracerProvider := newTraceProvider(consoleTraceExporter) defer tracerProvider.Shutdown(ctx) otel.SetTracerProvider(tracerProvider) meterProvider := newMeterProvider(consoleMetricExporter) defer meterProvider.Shutdown(ctx) otel.SetMeterProvider(meterProvider) mux.HandleFunc("/info", info) srv := &amp;http.Server&#123; Addr: portNum, Handler: mux, &#125; log.Println("Started on port", portNum) err = srv.ListenAndServe() if err != nil &#123; log.Println("Fail start http server.") &#125;&#125; æœ€åŽï¼Œè®©æˆ‘ä»¬æµ‹é‡æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚æˆ‘ä»¬å°†åœ¨ info.go ä¸­åšè¿™ä»¶äº‹ï¼Œè¿™ä¸Žæˆ‘ä»¬ä¹‹å‰åœ¨ trace ä¸­æ‰€åšçš„éžå¸¸ç›¸ä¼¼ã€‚ æˆ‘ä»¬å°†ä½¿ç”¨ otel.Meter(&quot;info-service&quot;) åœ¨å·²ç»æ³¨å†Œçš„å…¨å±€æä¾›è€…ä¸Šåˆ›å»ºä¸€ä¸ªå‘½åçš„è®¡é‡å™¨ã€‚æˆ‘ä»¬è¿˜å°†é€šè¿‡ metric.Int64Counter å®šä¹‰æˆ‘ä»¬çš„æµ‹é‡å·¥å…·ã€‚Int64Counter æ˜¯ä¸€ç§è®°å½•é€’å¢žçš„ int64 å€¼çš„å·¥å…·ã€‚ ç„¶è€Œï¼Œä¸Ž traceä¸åŒï¼Œæˆ‘ä»¬éœ€è¦åˆå§‹åŒ–æˆ‘ä»¬çš„æµ‹é‡å·¥å…·ã€‚æˆ‘ä»¬å°†ä¸ºæˆ‘ä»¬çš„åº¦é‡é…ç½®åç§°ã€æè¿°å’Œå•ä½ã€‚ 1234567891011121314151617// file: info.govar ( tracer = otel.Tracer("info-service") meter = otel.Meter("info-service") viewCounter metric.Int64Counter)func init() &#123; var err error viewCounter, err = meter.Int64Counter("user.views", metric.WithDescription("The number of views"), metric.WithUnit("&#123;views&#125;")) if err != nil &#123; panic(err) &#125;&#125; ä¸€æ—¦å®Œæˆè¿™ä¸ªæ­¥éª¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹æµ‹é‡äº†ã€‚æœ€ç»ˆä»£ç çœ‹èµ·æ¥ä¼šåƒè¿™æ ·ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142// file: info.gopackage mainimport ( "encoding/json" "go.opentelemetry.io/otel" "go.opentelemetry.io/otel/metric" "net/http")type InfoResponse struct &#123; Version string `json:"version"` ServiceName string `json:"service-name"`&#125;var ( tracer = otel.Tracer("info-service") meter = otel.Meter("info-service") viewCounter metric.Int64Counter)func init() &#123; var err error viewCounter, err = meter.Int64Counter("user.views", metric.WithDescription("The number of views"), metric.WithUnit("&#123;views&#125;")) if err != nil &#123; panic(err) &#125;&#125;func info(w http.ResponseWriter, r *http.Request) &#123; ctx, span := tracer.Start(r.Context(), "info") defer span.End() viewCounter.Add(ctx, 1) w.Header().Set("Content-Type", "application/json") response := InfoResponse&#123;Version: "0.1.0", ServiceName: "otlp-sample"&#125; json.NewEncoder(w).Encode(response)&#125; è¿è¡Œæˆ‘ä»¬çš„æœåŠ¡æ—¶ï¼Œæ¯10ç§’ç³»ç»Ÿå°†åœ¨æŽ§åˆ¶å°æ˜¾ç¤ºæˆ‘ä»¬çš„æ•°æ®ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263&#123; "Resource":[ &#123; "Key":"service.name", "Value":&#123; "Type":"STRING", "Value":"unknown_service:otlp-golang" &#125; &#125;, &#123; "Key":"telemetry.sdk.language", "Value":&#123; "Type":"STRING", "Value":"go" &#125; &#125;, &#123; "Key":"telemetry.sdk.name", "Value":&#123; "Type":"STRING", "Value":"opentelemetry" &#125; &#125;, &#123; "Key":"telemetry.sdk.version", "Value":&#123; "Type":"STRING", "Value":"1.24.0" &#125; &#125; ], "ScopeMetrics":[ &#123; "Scope":&#123; "Name":"info-service", "Version":"", "SchemaURL":"" &#125;, "Metrics":[ &#123; "Name":"user.views", "Description":"The number of views", "Unit":"&#123;views&#125;", "Data":&#123; "DataPoints":[ &#123; "Attributes":[ ], "StartTime":"2024-03-03T08:50:39.07383-03:00", "Time":"2024-03-03T08:51:45.075332-03:00", "Value":1 &#125; ], "Temporality":"CumulativeTemporality", "IsMonotonic":true &#125; &#125; ] &#125; ]&#125; Contextä¸ºäº†å°†è¿½è¸ªä¿¡æ¯å‘é€å‡ºåŽ»ï¼Œæˆ‘ä»¬éœ€è¦ä¼ æ’­ä¸Šä¸‹æ–‡ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å¿…é¡»æ³¨å†Œä¸€ä¸ªä¼ æ’­å™¨ã€‚æˆ‘ä»¬å°†åœ¨ otel.goå’Œmain.go ä¸­å®žçŽ°ï¼Œè·Ÿè¿½ Tracing å’Œ metric çš„å®žçŽ°å·®ä¸å¤šã€‚ 1234567// file: otel.gofunc newPropagator() propagation.TextMapPropagator &#123; return propagation.NewCompositeTextMapPropagator( propagation.TraceContext&#123;&#125;, )&#125; 1234// file: main.go prop := newPropagator()otel.SetTextMapPropagator(prop) HTTP Serveræˆ‘ä»¬å°†é€šè¿‡è§‚æµ‹æ•°æ®æ¥ä¸°å¯Œæˆ‘ä»¬çš„ HTTP æœåŠ¡å™¨ä»¥å®Œæˆæˆ‘ä»¬çš„ç›‘æŽ§ã€‚ä¸ºæ­¤æˆ‘ä»¬å°†ä½¿ç”¨å¸¦æœ‰ OTel çš„ http handler ã€‚ 1234567891011121314151617// main.gohandleFunc := func(pattern string, handlerFunc func(http.ResponseWriter, *http.Request)) &#123; handler := otelhttp.WithRouteTag(pattern, http.HandlerFunc(handlerFunc)) mux.Handle(pattern, handler)&#125;handleFunc("/info", info)newHandler := otelhttp.NewHandler(mux, "/")srv := &amp;http.Server&#123; Addr: portNum, Handler: newHandler,&#125; å› æ­¤ï¼Œæˆ‘ä»¬å°†åœ¨æˆ‘ä»¬çš„æ”¶é›†åˆ°çš„æ•°æ®ä¸­èŽ·å¾—æ¥è‡ª HTTP æœåŠ¡å™¨çš„é¢å¤–ä¿¡æ¯ï¼ˆç”¨æˆ·ä»£ç†ã€HTTPæ–¹æ³•ã€åè®®ã€è·¯ç”±ç­‰ï¼‰ã€‚ Conclusionè¿™ç¯‡æ–‡ç« æˆ‘ä»¬è¯¦ç»†å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Go æ¥å¯¹æŽ¥ OpenTelemetry ä»¥å®žçŽ°å®Œæ•´çš„å¯è§‚æµ‹ç³»ç»Ÿï¼Œè¿™é‡Œä½¿ç”¨ console Exporter ä»…ä½œæ¼”ç¤ºä½¿ç”¨ ï¼Œåœ¨å®žé™…çš„å¼€å‘ä¸­æˆ‘ä»¬å¯èƒ½éœ€è¦ä½¿ç”¨æ›´åŠ å¼ºå¤§çš„ Exporter å°†æ•°æ®å¯è§†åŒ–ï¼Œæ¯”å¦‚å¯ä»¥ä½¿ç”¨ Google Cloud Trace æ¥å°†æ•°æ®ç›´æŽ¥å¯¼å‡ºåˆ° Goole Cloud Monitoring ã€‚ ReferencesOpenTelemetryThe Future of Observability with OpenTelemetryCloud-Native Observability with OpenTelemetryLearning OpenTelemetry]]></content>
      <categories>
        <category>GO</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨ ErrGroup VS waitGroupï¼Ÿ]]></title>
    <url>%2F2024%2F05%2F11%2F%E4%BB%80%E4%B9%88%E6%83%85%E5%86%B5%E4%B8%8B%E4%BD%BF%E7%94%A8-ErrGroup-VS-waitGroup%EF%BC%9F%2F</url>
    <content type="text"><![CDATA[Goroutine æ˜¯ç¼–å†™ Go è¯­è¨€å¹¶å‘ç¨‹åºçš„å¼ºå¤§å·¥å…·ã€‚ç„¶è€Œç®¡ç†åç¨‹ï¼Œç‰¹åˆ«æ˜¯åœ¨å¤„ç†åç¨‹çš„é”™è¯¯æ—¶ï¼Œå¯èƒ½ä¼šå˜å¾—ç¹çã€‚è¿™æ—¶ï¼Œx/sync åŒ…ä¸­çš„ errgroup å°±æ´¾ä¸Šç”¨åœºäº†ã€‚å®ƒæä¾›äº†ä¸€ç§ç®€åŒ–çš„æ–¹æ³•æ¥å¤„ç†å¹¶å‘ä»»åŠ¡åŠå…¶é”™è¯¯ã€‚ Example for ErrGroupä¸‹é¢æ˜¯ä¸€ä¸ªä½¿ç”¨ errorGroup çš„ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package mainimport ( "context" "errors" "fmt" "time" "golang.org/x/sync/errgroup")func task1(ctx context.Context) error &#123; fmt.Println("Task 1 started successfully") select &#123; case &lt;-time.After(1 * time.Second): fmt.Println("Task 1 completed successfully") return nil case &lt;-ctx.Done(): fmt.Println("Task 1 canceled") return ctx.Err() &#125;&#125;func task2(ctx context.Context) error &#123; fmt.Println("Task 2 started successfully") select &#123; case &lt;-time.After(2 * time.Second): fmt.Println("Task 2 processed failed") return errors.New("Task 2 processed failed due to error") case &lt;-ctx.Done(): fmt.Println("Task 2 canceled") return ctx.Err() &#125;&#125;func task3(ctx context.Context) error &#123; fmt.Println("Task 3 started successfully") select &#123; case &lt;-time.After(3 * time.Second): fmt.Println("Task 3 completed successfully") return nil case &lt;-ctx.Done(): fmt.Println("Task 3 canceled") return ctx.Err() &#125;&#125;func main() &#123; ctx, cancel := context.WithCancel(context.Background()) defer cancel() // Ensure cancellation happens when main() exits g, ctx := errgroup.WithContext(ctx) g.Go(func() error &#123; return task1(ctx) &#125;) g.Go(func() error &#123; return task2(ctx) &#125;) g.Go(func() error &#123; return task3(ctx) &#125;) if err := g.Wait(); err != nil &#123; fmt.Println("Encountered error:", err) cancel() &#125; else &#123; fmt.Println("All tasks completed successfully") &#125;&#125; ä¸Šé¢ç¨‹åºçš„è¾“å‡ºæ˜¯ï¼š 123456Task 1 started successfullyTask 2 started successfullyTask 3 started successfullyTask 1 completed successfullyTask 2 processed failedEncountered error: Task 2 processed failed due to error åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼š æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªå¸¦æœ‰å¯å–æ¶ˆä¸Šä¸‹æ–‡çš„ errgroupã€‚ å®šä¹‰äº†3ä¸ªä»»åŠ¡ï¼Œtask1 å’Œ task3 åœ¨ä¸€å®šæ—¶é—´åŽæ¨¡æ‹ŸæˆåŠŸå®Œæˆï¼Œè€Œ task2 åœ¨æ›´é•¿çš„æ—¶é—´åŽé€šè¿‡è¿”å›žé”™è¯¯æ¥æ¨¡æ‹Ÿå¤±è´¥ã€‚ ä½¿ç”¨ g.Go åœ¨å•ç‹¬çš„ goroutine ä¸­å¯åŠ¨æ¯ä¸ªä»»åŠ¡ã€‚ è°ƒç”¨ g.Wait ç­‰å¾…æ‰€æœ‰ä»»åŠ¡å®Œæˆã€‚å¦‚æžœä»»ä½•ä»»åŠ¡é‡åˆ°é”™è¯¯ï¼Œg.Wait() ä¼šç«‹å³è¿”å›žè¯¥é”™è¯¯ã€‚åœ¨ä¸»æ‰§è¡Œä¹‹åŽï¼Œtask1 æˆåŠŸå®Œæˆï¼Œtask2 é‡åˆ°äº†å¤„ç†å¤±è´¥ï¼Œè€Œ task3 ç”±äºŽ task2 ä¸­çš„ä¸Šè¿°å¤±è´¥è€Œè¢«å–æ¶ˆã€‚ ErrGroup vs WaitGroupErrGroup: ä½¿ç”¨ ErrGroup æ¥ç®¡ç†å¹¶å‘ä»»åŠ¡ä¸­çš„é”™è¯¯ã€‚å®ƒèšåˆäº†æ‰€æœ‰åç¨‹ä¸­çš„é”™è¯¯ï¼Œå¹¶è¿”å›žé‡åˆ°çš„ç¬¬ä¸€ä¸ªé”™è¯¯ã€‚ éœ€è¦ç®¡ç†å¤šä¸ªå¯èƒ½äº§ç”Ÿé”™è¯¯çš„å¹¶å‘ä»»åŠ¡ã€‚ æƒ³è¦åˆ©ç”¨ä¸Šä¸‹æ–‡å–æ¶ˆåŠŸèƒ½æ¥ä¼˜é›…åœ°å…³é—­ç¨‹åºã€‚ ä¸æƒ³æ‰‹åŠ¨æ£€æŸ¥å¤šä¸ª WaitGroup è°ƒç”¨çš„é”™è¯¯ å®ƒä¸Ž Go çš„ä¸Šä¸‹æ–‡åŒ…æ— ç¼é›†æˆã€‚ä»»ä½•æ¥è‡ªåç¨‹çš„é”™è¯¯éƒ½ä¼šå–æ¶ˆä¸Šä¸‹æ–‡ï¼Œè‡ªåŠ¨åœæ­¢å…¶ä»–æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡ã€‚ WaitGroup ä½¿ç”¨ WaitGroup è¿›è¡ŒåŸºæœ¬åŒæ­¥ã€‚å®ƒç®€å•åœ°ç­‰å¾…æŒ‡å®šæ•°é‡çš„ goroutine å®ŒæˆåŽå†ç»§ç»­ã€‚ ]å½“ä½ åªå…³å¿ƒä»»åŠ¡å®Œæˆè€Œä¸é¢„æœŸé”™è¯¯æ—¶ï¼Œå®ƒæ˜¯ç†æƒ³çš„é€‰æ‹©ã€‚ å®ƒä¸ç›´æŽ¥å¤„ç†é”™è¯¯ã€‚ä½ éœ€è¦åœ¨æ¯ä¸ª goroutine ä¸­æ£€æŸ¥é”™è¯¯å¹¶å•ç‹¬å¤„ç†å®ƒä»¬ã€‚ æ€»ç»“ ä½¿ç”¨ WaitGroup è¿›è¡Œç®€å•çš„åŒæ­¥ ä½¿ç”¨ ErrGroup è¿›è¡Œé”™è¯¯ç®¡ç†ï¼Œå¹¶å¸Œæœ›åœ¨ä¼˜é›…å…³é—­æ—¶æœ‰ä¸Šä¸‹æ–‡æ„ŸçŸ¥çš„å–æ¶ˆã€‚ ä¹Ÿå¯ä»¥åŒæ—¶ä½¿ç”¨å®ƒä»¬ï¼ŒWaitGroup ç”¨äºŽåŸºæœ¬åŒæ­¥ï¼ŒErrGroup ç”¨äºŽä¸€ç»„ä»»åŠ¡ä¸­çš„è¯¦ç»†é”™è¯¯å¤„ç†ã€‚ ç›¸å…³çš„ issue]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang å®žçŽ°æžšä¸¾çš„å„ç§æ–¹æ³•åŠæœ€ä½³å®žè·µ]]></title>
    <url>%2F2024%2F05%2F07%2FGolang-%E5%AE%9E%E7%8E%B0%E6%9E%9A%E4%B8%BE%E7%9A%84%E5%90%84%E7%A7%8D%E6%96%B9%E6%B3%95%E5%8F%8A%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%2F</url>
    <content type="text"><![CDATA[æžšä¸¾æä¾›äº†ä¸€ç§è¡¨ç¤ºä¸€ç»„å‘½åå¸¸é‡çš„æ–¹å¼ã€‚è™½ç„¶ Go è¯­è¨€æ²¡æœ‰å†…ç½®çš„æžšä¸¾ç±»åž‹ï¼Œä½†å¼€å‘è€…å¯ä»¥é€šè¿‡å¸¸é‡/è‡ªå®šä¹‰ç±»åž‹æ¥æ¨¡æ‹Ÿç±»ä¼¼æžšä¸¾çš„è¡Œä¸ºã€‚ æžšä¸¾åœ¨ç¼–ç¨‹è¯­è¨€ä¸­æ‰®æ¼”ç€è‡³å…³é‡è¦çš„è§’è‰²ï¼Œæä¾›äº†ä¸€ç§ç®€æ´è€Œå¯Œæœ‰è¡¨çŽ°åŠ›çš„æ–¹å¼æ¥å®šä¹‰ä¸€ç»„å‘½åå¸¸é‡ã€‚è™½ç„¶åƒJavaæˆ–C#è¿™æ ·çš„è¯­è¨€æä¾›äº†å¯¹æžšä¸¾çš„å†…ç½®æ”¯æŒï¼Œä½†Goé‡‡ç”¨äº†ä¸åŒçš„æ–¹æ³•ã€‚åœ¨ Go ä¸­ï¼Œæžšä¸¾å¹¶ä¸æ˜¯ä¸€ç§åŽŸç”Ÿçš„è¯­è¨€ç‰¹æ€§ï¼Œä½†å¼€å‘è€…æœ‰å‡ ç§æŠ€æœ¯å¯ä¾›ä½¿ç”¨ï¼Œä»¥å®žçŽ°ç±»ä¼¼çš„åŠŸèƒ½ã€‚æœ¬æ–‡æ·±å…¥æŽ¢è®¨äº† Go è¯­è¨€ä¸­çš„æžšä¸¾ï¼ŒæŽ¢ç´¢äº†å®šä¹‰å’Œæœ‰æ•ˆä½¿ç”¨å®ƒä»¬çš„å„ç§æŠ€æœ¯ã€‚é€šè¿‡ä»£ç ç¤ºä¾‹ã€æ¯”è¾ƒå’Œå®žé™…ç”¨ä¾‹ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯æŽŒæ¡æžšä¸¾å¹¶åœ¨ Go é¡¹ç›®ä¸­é«˜æ•ˆä½¿ç”¨å®ƒä»¬ã€‚ Understanding Enumåœ¨ Go è¯­è¨€ä¸­ï¼Œæžšä¸¾ï¼ˆenumerations çš„ç¼©å†™ï¼‰æä¾›äº†ä¸€ç§è¡¨ç¤ºä¸€ç»„å‘½åå¸¸é‡çš„æ–¹å¼ã€‚è™½ç„¶ Go è¯­è¨€æ²¡æœ‰åƒå…¶ä»–ä¸€äº›è¯­è¨€é‚£æ ·å†…å»ºçš„æžšä¸¾ç±»åž‹ï¼Œä½†å¼€å‘è€…å¯ä»¥ä½¿ç”¨å¸¸é‡æˆ–è‡ªå®šä¹‰ç±»åž‹æ¥æ¨¡æ‹Ÿç±»ä¼¼æžšä¸¾çš„è¡Œä¸ºã€‚è®©æˆ‘ä»¬æ·±å…¥äº†è§£ Go ä¸­æžšä¸¾çš„ç›®çš„å’Œè¯­æ³•ï¼š ç›®çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼šé€šè¿‡ç»™ç‰¹å®šå€¼åˆ†é…æœ‰æ„ä¹‰çš„åç§°ï¼Œæžšä¸¾ä½¿ä»£ç æ›´å…·å¯è¯»æ€§å’Œè‡ªè§£é‡Šæ€§ã€‚è¿™å¢žå¼ºäº†ä»£ç çš„å¯ç»´æŠ¤æ€§ï¼Œå› ä¸ºæ›´å®¹æ˜“ç†è§£æ¯ä¸ªå¸¸é‡çš„ç›®çš„ã€‚ç±»åž‹å®‰å…¨æ€§ï¼šæžšä¸¾æœ‰åŠ©äºŽé€šè¿‡å°†å˜é‡é™åˆ¶ä¸ºé¢„å®šä¹‰çš„ä¸€ç»„å€¼æ¥å¼ºåŒ–ç±»åž‹å®‰å…¨æ€§ã€‚è¿™å‡å°‘äº†å› ä½¿ç”¨é”™è¯¯å€¼è€Œå¼•èµ·çš„è¿è¡Œæ—¶é”™è¯¯çš„å¯èƒ½æ€§ã€‚ å®žçŽ°è¯­æ³• ä½¿ç”¨å¸¸é‡ 1234567891011121314package mainimport "fmt"// Enum defining colors using constantsconst ( Red = iota // 0 Green // 1 Blue // 2)func main() &#123; fmt.Println(Red, Green, Blue)&#125; ä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹ 12345678910111213141516package mainimport "fmt"// Enum defining colors using custom typestype CardType intconst ( VISA CardType = iota // 0 MASTER // 1 JCB // 2)func main() &#123; fmt.Println(VISA, MASTER, BlueJCB&#125; åœ¨ä¸Šè¿°ç¤ºä¾‹ä¸­ï¼š æˆ‘ä»¬ä½¿ç”¨å¸¸é‡å’Œè‡ªå®šä¹‰ç±»åž‹å®šä¹‰é¢œè‰²æžšä¸¾ã€‚ iota ç”¨äºŽè‡ªåŠ¨ç”Ÿæˆä»Ž 0 å¼€å§‹é€’å¢žçš„å€¼ã€‚ å¸¸é‡è¢«åˆ†é…ç»™æ¯ä¸ªæžšä¸¾å€¼ï¼Œè€Œåœ¨è‡ªå®šä¹‰ç±»åž‹çš„æƒ…å†µä¸‹ï¼Œä¼šæŒ‡å®šä¸€ä¸ªåº•å±‚ç±»åž‹ï¼ˆé€šå¸¸æ˜¯ intï¼‰ã€‚ Go è¯­è¨€ä¸­çš„æžšä¸¾æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ç»„å›ºå®šå€¼ï¼Œæé«˜äº†ä»£ç çš„æ¸…æ™°åº¦å’Œç±»åž‹å®‰å…¨æ€§ã€‚ç„¶è€Œï¼Œæ ¹æ®ä½ é¡¹ç›®çš„å…·ä½“éœ€æ±‚ï¼Œé€‰æ‹©é€‚å½“çš„æ–¹æ³•ï¼ˆå¸¸é‡æˆ–è‡ªå®šä¹‰ç±»åž‹ï¼‰è‡³å…³é‡è¦ã€‚ åœ¨ Go ä¸­ä½¿ç”¨ Enum ç±»åž‹çš„ä¼˜ç¼ºç‚¹ä¼˜ç‚¹ æé«˜å¯è¯»æ€§ï¼šæžšä¸¾é€šè¿‡ä¸ºç‰¹å®šå€¼æä¾›æœ‰æ„ä¹‰çš„åç§°æ¥å¢žå¼ºä»£ç çš„å¯è¯»æ€§ã€‚è¿™ä½¿å¾—ä»£ç æ›´åŠ è‡ªè§£é‡Šï¼Œæ›´æ˜“äºŽå¼€å‘äººå‘˜ç†è§£ã€‚ ç±»åž‹å®‰å…¨æ€§ï¼šæžšä¸¾æœ‰åŠ©äºŽé€šè¿‡é™åˆ¶å˜é‡ä¸ºé¢„å®šä¹‰çš„ä¸€ç»„å€¼æ¥å¼ºåŒ–ç±»åž‹å®‰å…¨æ€§ã€‚è¿™å‡å°‘äº†ä½¿ç”¨ä¸æ­£ç¡®æˆ–æ„å¤–å€¼çš„é£Žé™©ï¼Œä»Žè€Œå‡å°‘äº†è¿è¡Œæ—¶é”™è¯¯ã€‚ æ˜Žç¡®å®šä¹‰å¸¸é‡ï¼šæžšä¸¾å…è®¸å¼€å‘äººå‘˜æ˜Žç¡®å®šä¹‰ä¸€ç»„å¸¸é‡ï¼Œæ˜Žç¡®æŒ‡å‡ºå“ªäº›å€¼å¯¹äºŽç‰¹å®šå˜é‡æˆ–å‚æ•°æ˜¯æœ‰æ•ˆçš„ã€‚ å¢žå¼ºå¯ç»´æŠ¤æ€§ï¼šé€šè¿‡ä½¿ç”¨æžšä¸¾ï¼Œå¼€å‘äººå‘˜å¯ä»¥è½»æ¾åœ°åœ¨å•ä¸€ä½ç½®æ›´æ–°æˆ–ä¿®æ”¹å…è®¸çš„å€¼é›†ï¼Œå‡å°‘ä»£ç åº“ä¸­ä¸ä¸€è‡´æˆ–é”™è¯¯çš„å¯èƒ½æ€§ã€‚ ç¼ºç‚¹ æ²¡æœ‰å†…ç½®æžšä¸¾ç±»åž‹ï¼šä¸Žå…¶ä»–ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸åŒï¼ŒGoè¯­è¨€æ²¡æœ‰å†…ç½®çš„æžšä¸¾ç±»åž‹ã€‚å¼€å‘è€…å¿…é¡»ä½¿ç”¨è¯¸å¦‚å¸¸é‡æˆ–è‡ªå®šä¹‰ç±»åž‹ä¹‹ç±»çš„è§£å†³æ–¹æ³•æ¥æ¨¡æ‹Ÿç±»ä¼¼æžšä¸¾çš„è¡Œä¸ºã€‚ å†—é•¿è¯­æ³•ï¼šä½¿ç”¨å¸¸é‡æˆ–è‡ªå®šä¹‰ç±»åž‹åœ¨ Go ä¸­å®žçŽ°æžšä¸¾æœ‰æ—¶ä¼šå¯¼è‡´å†—é•¿çš„è¯­æ³•ï¼Œç‰¹åˆ«æ˜¯å½“å®šä¹‰äº†ä¸€ç»„å¤§åž‹çš„æžšä¸¾å€¼æ—¶ã€‚ è¡¨è¾¾åŠ›æœ‰é™ï¼šGo ä¸­çš„æžšä¸¾ç¼ºä¹å…¶ä»–è¯­è¨€æžšä¸¾ä¸­çš„ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œä¾‹å¦‚å°†å€¼æˆ–è¡Œä¸ºä¸Žä¸ªåˆ«æžšä¸¾å¸¸é‡å…³è”çš„èƒ½åŠ›ã€‚ æ½œåœ¨å†²çªï¼šå½“ä½¿ç”¨å¸¸é‡ä½œä¸ºæžšä¸¾æ—¶ï¼Œå¦‚æžœåœ¨åŒä¸€ä»£ç åº“çš„ä¸åŒä¸Šä¸‹æ–‡ä¸­ä½¿ç”¨äº†ç›¸åŒçš„å¸¸é‡åç§°ï¼Œå­˜åœ¨å†²çªçš„é£Žé™©ã€‚è¿™å¯èƒ½å¯¼è‡´æ„å¤–çš„è¡Œä¸ºæˆ–é”™è¯¯ã€‚ é¢å¤–å¼€é”€ï¼šä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹å®žçŽ°æžšä¸¾å¯èƒ½ä¼šå¼•å…¥é¢å¤–çš„å¼€é”€ï¼Œç‰¹åˆ«æ˜¯å¦‚æžœä¸ºæ¯ä¸ªæžšä¸¾å¸¸é‡å®šä¹‰äº†å…³è”çš„æ–¹æ³•æˆ–è¡Œä¸ºã€‚ å°½ç®¡å­˜åœ¨è¿™äº›é™åˆ¶ï¼ŒGo è¯­è¨€ä¸­çš„æžšä¸¾ç±»åž‹ä»ç„¶æ˜¯æé«˜ä»£ç æ¸…æ™°åº¦ã€å¯ç»´æŠ¤æ€§å’Œç±»åž‹å®‰å…¨æ€§çš„æœ‰ä»·å€¼å·¥å…·ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ç†è§£å®ƒä»¬çš„ä¼˜ç‚¹å’Œå±€é™æ€§æ¥æœ‰æ•ˆåœ°åˆ©ç”¨å®ƒä»¬ã€‚ ç¬¬ä¸‰æ–¹ç±»åº“å‡ ä¸ªç¬¬ä¸‰æ–¹åº“åœ¨ Go è¯­è¨€ä¸­æä¾›äº†ç±»ä¼¼æžšä¸¾çš„åŠŸèƒ½ï¼š go-enumï¼šå®ƒå¯ä»¥ä»Žç®€å•çš„å®šä¹‰æ ¼å¼ç”Ÿæˆ Go è¯­è¨€çš„æžšä¸¾ä»£ç ã€‚ï¼ˆç‚¹å‡» go-enum GitHub ä»¥èŽ·å–æ›´å¤šä¿¡æ¯ï¼‰ã€‚stringerï¼šå®ƒä¸ºåœ¨ Go æºä»£ç ä¸­å®šä¹‰çš„æžšä¸¾è‡ªåŠ¨ç”Ÿæˆå­—ç¬¦ä¸²æ–¹æ³•ã€‚ï¼ˆç‚¹å‡» stringer å·¥å…·ä»¥èŽ·å–æ›´å¤šè¯¦æƒ…ï¼‰ã€‚ ä¸Šè¿°ä¸‰ç§æ–¹å¼è¯¥å¦‚ä½•é€‰æ‹©ï¼Ÿ å¦‚æžœå¸Œæœ›å®žçŽ°ç®€å•ï¼Œå¹¶ä¸”æžšä¸¾é›†è¾ƒå°ä¸”ä¸éœ€è¦é¢å¤–ç‰¹æ€§ï¼Œä½¿ç”¨ Iota å¸¸é‡å³å¯ã€‚ å¦‚æžœéœ€è¦æ›´å¥½çš„ç±»åž‹å®‰å…¨æ€§ã€çµæ´»æ€§ï¼Œä»¥åŠéœ€è¦ä¸Žæžšä¸¾å…³è”çš„é¢å¤–æ–¹æ³•ï¼Œä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹ã€‚ å¦‚æžœéœ€è¦è‡ªåŠ¨åŒ–æžšä¸¾ç”Ÿæˆæˆ–éœ€è¦é¢å¤–ç‰¹æ€§ï¼ˆå¦‚å­—ç¬¦ä¸²è¡¨ç¤ºï¼‰ï¼Œè€ƒè™‘ä½¿ç”¨åº“ï¼Œä½†è¦è°¨æ…Žå¤„ç†ä¾èµ–æ€§å’Œå…¼å®¹æ€§é—®é¢˜ã€‚ ä¸€äº› Use Cases è¡¨ç¤ºæ˜ŸæœŸ 123456789101112131415161718192021222324252627package mainimport "fmt"// Enum for days of the week using custom typestype DayOfWeek intconst ( Sunday DayOfWeek = iota Monday Tuesday Wednesday Thursday Friday Saturday)func main() &#123; fmt.Println("Days of the week:") fmt.Println("Sunday:", Sunday) fmt.Println("Monday:", Monday) fmt.Println("Tuesday:", Tuesday) fmt.Println("Wednesday:", Wednesday) fmt.Println("Thursday:", Thursday) fmt.Println("Friday:", Friday) fmt.Println("Saturday:", Saturday)&#125; è¡¨ç¤ºè®¿é—®çº§åˆ« 12345678type AccessLevel intconst ( Guest AccessLevel = iota User Moderator Admin) åœ¨ Go è¯­è¨€ä¸­ï¼Œæžšä¸¾æä¾›äº†ä¸€ç§å¼ºå¤§çš„æœºåˆ¶ï¼Œç”¨äºŽæé«˜ä»£ç çš„æ¸…æ™°åº¦ã€å¯ç»´æŠ¤æ€§å’Œç±»åž‹å®‰å…¨æ€§ã€‚é€šè¿‡éµå¾ªæœ€ä½³å®žè·µå¹¶æœ‰æ•ˆåˆ©ç”¨æžšä¸¾ï¼Œå¼€å‘è€…å¯ä»¥åœ¨ä»–ä»¬çš„ Go é¡¹ç›®ä¸­ç¼–å†™æ›´åŠ å¥å£®å’Œå¯è¯»çš„ä»£ç ã€‚ ç»“è®ºåœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬æŽ¢è®¨äº†åœ¨ Go è¯­è¨€ä¸­å®žçŽ°æžšä¸¾çš„å„ç§æ–¹æ³•ï¼Œå¹¶è®¨è®ºäº†å®ƒä»¬å„è‡ªçš„ä¼˜åŠ¿ã€å±€é™æ€§å’Œæœ€ä½³å®žè·µã€‚ æœ¬è´¨ä¸Šï¼ŒGo è¯­è¨€ä¸­çš„æžšä¸¾é€šè¿‡æä¾›ä¸€ç§ç»“æž„åŒ–çš„æ–¹å¼æ¥è¡¨ç¤ºä¸€ç»„å›ºå®šå€¼ï¼Œèµ‹äºˆå¼€å‘è€…ç¼–å†™æ›´æ¸…æ´ã€æ›´æ˜“äºŽç»´æŠ¤çš„ä»£ç çš„èƒ½åŠ›ã€‚é€šè¿‡ç†è§£æœ¬æŒ‡å—ä¸­æ¦‚è¿°çš„ä¸åŒæŠ€æœ¯å’Œæœ€ä½³å®žè·µï¼Œå¼€å‘è€…å¯ä»¥æœ‰æ•ˆåœ°åˆ©ç”¨æžšä¸¾æ¥å¢žå¼ºä»–ä»¬çš„ Go é¡¹ç›®ã€‚]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>enum</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸€äº›åœ¨ Golang ä¸­é«˜æ•ˆå¤„ç† Collection ç±»åž‹çš„åº“]]></title>
    <url>%2F2024%2F05%2F05%2F%E4%B8%80%E4%BA%9B%E5%9C%A8-Golang-%E4%B8%AD%E9%AB%98%E6%95%88%E5%A4%84%E7%90%86-Collection-%E7%B1%BB%E5%9E%8B%E7%9A%84%E5%BA%93%2F</url>
    <content type="text"><![CDATA[å¤„ç†é›†åˆæ˜¯æž„å»ºä»»ä½•åº”ç”¨ç¨‹åºçš„é‡è¦éƒ¨åˆ†ã€‚é€šå¸¸ï¼Œæ‚¨éœ€è¦ä»¥ä¸‹å‡ ç±»æ“ä½œï¼š è½¬æ¢ï¼šå°†æŸä¸ªå‡½æ•°åº”ç”¨äºŽé›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ ï¼Œä»¥åˆ›å»ºä¸€ä¸ªæ–°ç±»åž‹çš„æ–°é›†åˆï¼› è¿‡æ»¤ï¼šé€‰æ‹©æ»¡è¶³ç‰¹å®šæ¡ä»¶çš„é›†åˆä¸­çš„å…ƒç´ ï¼› èšåˆï¼šä»Žé›†åˆä¸­è®¡ç®—å‡ºå•ä¸ªç»“æžœï¼Œé€šå¸¸ç”¨äºŽæ±‡æ€»ï¼› æŽ’åº/æŽ’åºï¼šæ ¹æ®æŸäº›æ ‡å‡†é‡æ–°æŽ’åˆ—é›†åˆçš„å…ƒç´ ï¼› è®¿é—®ï¼šæ ¹æ®å…¶å±žæ€§æˆ–ä½ç½®æ£€ç´¢å…ƒç´ çš„æ“ä½œï¼› å®žç”¨ç¨‹åºï¼šä¸Žé›†åˆä¸€èµ·å·¥ä½œçš„é€šç”¨æ“ä½œï¼Œä½†ä¸ä¸€å®šå®Œå…¨é€‚åˆä¸Šè¿°åˆ†ç±»ã€‚ å°½ç®¡Goå…·æœ‰è®¸å¤šä¼˜ç‚¹ï¼Œä½†å¯¹äºŽé«˜çº§é›†åˆæ“ä½œçš„å†…ç½®æ”¯æŒç›¸å¯¹æœ‰é™ï¼Œå› æ­¤å¦‚æžœéœ€è¦ï¼Œæ‚¨éœ€è¦ä½¿ç”¨ç¬¬ä¸‰æ–¹åŒ…ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†æŽ¢è®¨å‡ ä¸ªæµè¡Œçš„Goåº“ï¼Œè¿™äº›åº“å¯ä»¥å¢žå¼ºè¯­è¨€çš„èƒ½åŠ›ï¼Œä»¥æœ‰æ•ˆåœ°å¤„ç†é›†åˆï¼Œæ¶µç›–å®ƒä»¬çš„åŠŸèƒ½å’ŒåŠŸèƒ½ã€‚è¿™ç¯‡è¯„è®ºå°†å¸®åŠ©æ‚¨é€‰æ‹©åˆé€‚çš„å·¥å…·ï¼Œä»¥ç®€åŒ–Goé¡¹ç›®ä¸­çš„æ•°æ®å¤„ç†ä»»åŠ¡ã€‚ Introductionè®©æˆ‘ä»¬ä»Žä¸Šé¢çš„æ¯ä¸ªé›†åˆæ“ä½œç±»ä¸­å›žé¡¾ä¸€äº›æµè¡Œçš„æ–¹æ³•ã€‚ è½¬æ¢Map â€” å¯¹é›†åˆä¸­çš„æ¯ä¸ªå…ƒç´ åº”ç”¨ä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è¿”å›žç»“æžœé›†åˆï¼›FlatMap â€” å°†æ¯ä¸ªå…ƒç´ å¤„ç†ä¸ºä¸€ä¸ªå…ƒç´ åˆ—è¡¨ï¼Œç„¶åŽå°†è¿™äº›åˆ—è¡¨å±•å¹³ä¸ºä¸€ä¸ªåˆ—è¡¨ã€‚ è¿‡æ»¤Filter â€” åˆ é™¤ä¸åŒ¹é…è°“è¯å‡½æ•°çš„å…ƒç´ ï¼›Distinct â€” ä»Žé›†åˆä¸­åˆ é™¤é‡å¤çš„å…ƒç´ ï¼›TakeWhile â€” è¿”å›žæ»¡è¶³ç»™å®šæ¡ä»¶çš„å…ƒç´ ï¼Œç›´åˆ°é‡åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„å…ƒç´ ä¸ºæ­¢ï¼›DropWhile â€” åˆ é™¤æ»¡è¶³ç»™å®šæ¡ä»¶çš„å…ƒç´ ï¼Œç„¶åŽè¿”å›žå‰©ä½™çš„å…ƒç´ ã€‚ èšåˆReduce â€” ä½¿ç”¨ç»™å®šçš„å‡½æ•°ç»„åˆé›†åˆçš„æ‰€æœ‰å…ƒç´ ï¼Œå¹¶è¿”å›žç»„åˆç»“æžœï¼›Count â€” è¿”å›žæ»¡è¶³ç‰¹å®šæ¡ä»¶çš„å…ƒç´ æ•°é‡ï¼›Sum â€” è®¡ç®—é›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„æ•°å­—å±žæ€§ä¹‹å’Œï¼›Max/Min â€” ç¡®å®šå…ƒç´ å±žæ€§ä¸­çš„æœ€å¤§å€¼æˆ–æœ€å°å€¼ï¼›Average â€” è®¡ç®—é›†åˆä¸­å…ƒç´ çš„æ•°å­—å±žæ€§çš„å¹³å‡å€¼ã€‚ æŽ’åº/æŽ’åºSort â€” æ ¹æ®æ¯”è¾ƒå™¨è§„åˆ™å¯¹é›†åˆçš„å…ƒç´ è¿›è¡ŒæŽ’åºï¼›Reverse â€” é¢ å€’é›†åˆä¸­å…ƒç´ çš„é¡ºåºã€‚ è®¿é—®Find â€” è¿”å›žåŒ¹é…ç»™å®šè°“è¯çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼›AtIndex â€” æ£€ç´¢ç‰¹å®šç´¢å¼•å¤„çš„å…ƒç´ ã€‚ å®žç”¨ç¨‹åºGroupBy â€” æ ¹æ®é”®ç”Ÿæˆå™¨å‡½æ•°å°†å…ƒç´ åˆ†ç±»ä¸ºç»„ï¼›Partition â€” æ ¹æ®è°“è¯å°†é›†åˆåˆ†æˆä¸¤ä¸ªé›†åˆï¼šä¸€ä¸ªç”¨äºŽæ»¡è¶³è°“è¯çš„å…ƒç´ ï¼Œå¦ä¸€ä¸ªç”¨äºŽä¸æ»¡è¶³è°“è¯çš„å…ƒç´ ï¼›Slice Operations â€” ä¿®æ”¹é›†åˆè§†å›¾æˆ–åˆ’åˆ†çš„æ“ä½œï¼Œå¦‚åˆ‡ç‰‡æˆ–åˆ†å—ã€‚ Go å†…ç½®çš„èƒ½åŠ›åœ¨Goè¯­è¨€ä¸­ï¼Œæœ‰å‡ ç§ç±»åž‹å¯ç”¨äºŽå¤„ç†æ•°æ®é›†åˆï¼š æ•°ç»„ï¼ˆArraysï¼‰ â€” å›ºå®šå¤§å°çš„å…ƒç´ é›†åˆã€‚æ•°ç»„å¤§å°åœ¨å£°æ˜Žæ—¶å®šä¹‰ï¼Œä¾‹å¦‚ var myArray [5]intï¼›åˆ‡ç‰‡ï¼ˆSlicesï¼‰ â€” åŠ¨æ€å¤§å°çš„å…ƒç´ é›†åˆã€‚åˆ‡ç‰‡å»ºç«‹åœ¨æ•°ç»„ä¹‹ä¸Šï¼Œä½†ä¸Žæ•°ç»„ä¸åŒçš„æ˜¯ï¼Œå®ƒä»¬å¯ä»¥å¢žé•¿æˆ–ç¼©å°ã€‚å£°æ˜Žæ–¹å¼ï¼šmySlice := []int{1, 2, 3}ï¼›æ˜ å°„ï¼ˆMapsï¼‰ â€” é”®-å€¼å¯¹çš„é›†åˆã€‚æ˜ å°„å¯ä»¥åŠ¨æ€å¢žé•¿ï¼Œä¸”é”®çš„é¡ºåºä¸å—ä¿è¯ã€‚ä¾‹å¦‚ myMap := map[string]int{&quot;first&quot;: 1, &quot;second&quot;: 2} åˆ›å»ºäº†ä¸€ä¸ªå­—ç¬¦ä¸²é”®å’Œæ•´æ•°å€¼çš„æ˜ å°„ï¼›é€šé“ï¼ˆChannelsï¼‰ â€” ç±»åž‹åŒ–çš„é€šä¿¡åŽŸè¯­ï¼Œå…è®¸åœ¨goroutineä¹‹é—´å…±äº«æ•°æ®ã€‚ä¾‹å¦‚ myChan := make(chan int) åˆ›å»ºäº†ä¸€ä¸ªä¼ è¾“æ•´æ•°çš„é€šé“ã€‚ Goæ ‡å‡†åº“æä¾›äº†å…¶ä»–ç»“æž„å’Œå®žç”¨ç¨‹åºï¼Œå¯ä»¥ä½œä¸ºé›†åˆæˆ–å¢žå¼ºé›†åˆçš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š å †ï¼ˆHeapï¼‰ â€” container/heapåŒ…ä¸ºä»»ä½•sort.Interfaceæä¾›äº†å †æ“ä½œã€‚å †æ˜¯å…·æœ‰ä»¥ä¸‹ç‰¹æ€§çš„æ ‘ï¼šæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯å…¶å­æ ‘ä¸­å€¼æœ€å°çš„èŠ‚ç‚¹ï¼›é“¾è¡¨ï¼ˆListï¼‰ â€” container/liståŒ…å®žçŽ°äº†åŒå‘é“¾è¡¨ï¼›çŽ¯å½¢é“¾è¡¨ï¼ˆRingï¼‰ â€” container/ringåŒ…å®žçŽ°äº†çŽ¯å½¢é“¾è¡¨çš„æ“ä½œã€‚ æ­¤å¤–ï¼Œä½œä¸ºGoæ ‡å‡†åº“çš„ä¸€éƒ¨åˆ†ï¼Œè¿˜æœ‰ç”¨äºŽå¤„ç†åˆ‡ç‰‡å’Œæ˜ å°„çš„åŒ…ï¼š slices â€” è¯¥åŒ…å®šä¹‰äº†ä¸Žä»»ä½•ç±»åž‹çš„åˆ‡ç‰‡ä¸€èµ·ä½¿ç”¨çš„å„ç§æœ‰ç”¨çš„å‡½æ•°ï¼›maps â€” è¯¥åŒ…å®šä¹‰äº†ä¸Žä»»ä½•ç±»åž‹çš„æ˜ å°„ä¸€èµ·ä½¿ç”¨çš„å„ç§æœ‰ç”¨çš„å‡½æ•°ã€‚ é€šè¿‡å†…ç½®åŠŸèƒ½ï¼Œæ‚¨å¯ä»¥å¯¹é›†åˆæ‰§è¡Œä¸€äº›æ“ä½œï¼š èŽ·å–æ•°ç»„/åˆ‡ç‰‡/æ˜ å°„çš„é•¿åº¦ï¼›é€šè¿‡ç´¢å¼•/é”®è®¿é—®å…ƒç´ ï¼Œå¯¹åˆ‡ç‰‡è¿›è¡Œâ€œåˆ‡ç‰‡â€ï¼›éåŽ†é¡¹ç›®ã€‚ 1234567891011121314151617181920212223242526272829303132package mainimport "fmt"func main() &#123; s := []int&#123;1, 2, 3, 4, 5&#125; m := map[int]string&#123;1: "one", 2: "two", 3: "three"&#125; fmt.Printf("len(s)=%d\n", len(s)) fmt.Printf("len(m)=%d\n", len(m)) fmt.Printf("cap(s)=%d\n", cap(s)) // fmt.Printf("cap(m)=%d\n", cap(m)) // error: invalid argument m (type map[int]string) for cap // panic: runtime error: index out of range [5] with length 5 // fmt.Printf("s[5]=%d\n", s[5]) // panic: runtime error: index out of range [5] with length 5 // s[5] = 6 s = append(s, 6) fmt.Printf("s=%v\n", s) fmt.Printf("len(s)=%d\n", len(s)) fmt.Printf("cap(s)=%d\n", cap(s)) m[4] = "four" fmt.Printf("m=%v\n", m) fmt.Printf("s[2:4]=%v\n", s[2:4]) fmt.Printf("s[2:]=%v\n", s[2:]) fmt.Printf("s[:2]=%v\n", s[:2]) fmt.Printf("s[:]=%v\n", s[:])&#125; ä¸Šé¢çš„ä»£ç ä¼šæ‰“å°ï¼š 1234567891011len(s)=5len(m)=3cap(s)=5s=[1 2 3 4 5 6]len(s)=6cap(s)=10m=map[1:one 2:two 3:three 4:four]s[2:4]=[3 4]s[2:]=[3 4 5 6]s[:2]=[1 2]s[:]=[1 2 3 4 5 6] è®©æˆ‘ä»¬é€ä¸ªçœ‹ä¸‹ Go å†…ç½®çš„ Packageã€‚ Slicesåˆ‡ç‰‡ slicesåŒ…æœ€è¿‘æ‰å‡ºçŽ°åœ¨Goæ ‡å‡†åº“ä¸­ï¼Œä»ŽGo 1.21ç‰ˆæœ¬å¼€å§‹ã€‚è¿™æ˜¯è¯­è¨€ä¸­çš„ä¸€ä¸ªé‡å¤§è¿›æ­¥ï¼Œä½†æˆ‘ä»ç„¶æ›´å–œæ¬¢ä½¿ç”¨å¤–éƒ¨åº“æ¥å¤„ç†é›†åˆï¼ˆæ‚¨å¾ˆå¿«å°±ä¼šæ˜Žç™½åŽŸå› ï¼‰ã€‚è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªåº“å¦‚ä½•æ”¯æŒæ‰€æœ‰çš„é›†åˆæ“ä½œç±»åˆ«ã€‚ Aggregationslices èƒ½å¤Ÿå¿«é€Ÿåœ¨åˆ‡ç‰‡ä¸­æ‰¾åˆ°æœ€å°/æœ€å¤§å€¼ï¼š 123456789101112131415161718192021222324252627282930313233343536373839package mainimport ( "fmt" "slices")type Example struct &#123; Name string Number int&#125;func main() &#123; s := []int&#123;1, 2, 3, 4, 5&#125; fmt.Printf("Min: %d\n", slices.Min(s)) fmt.Printf("Max: %d\n", slices.Max(s)) e := []Example&#123; &#123;"A", 1&#125;, &#123;"B", 2&#125;, &#123;"C", 3&#125;, &#123;"D", 4&#125;, &#125; fmt.Printf("Min: %v\n", slices.MinFunc( e, func(i, j Example) int &#123; return i.Number - j.Number &#125;), ) fmt.Printf("Max: %v\n", slices.MaxFunc( e, func(i, j Example) int &#123; return i.Number - j.Number &#125;), )&#125; ä¸Šé¢çš„ä»£ç æ‰“å°ï¼š 1234Min: 1Max: 5Min: &#123;A 1&#125;Max: &#123;D 4&#125; Sorting/Orderingslices èƒ½å¤Ÿä½¿ç”¨æ¯”è¾ƒå‡½æ•°å¯¹åˆ‡ç‰‡è¿›è¡ŒæŽ’åºï¼š 12345678910111213141516171819202122232425262728293031323334353637package mainimport ( "fmt" "slices")type Example struct &#123; Name string Number int&#125;func main() &#123; s := []int&#123;4, 2, 5, 1, 3&#125; slices.Sort(s) fmt.Printf("Sorted: %v\n", s) slices.Reverse(s) fmt.Printf("Reversed: %v\n", s) e := []Example&#123; &#123;"C", 3&#125;, &#123;"A", 1&#125;, &#123;"D", 4&#125;, &#123;"B", 2&#125;, &#125; slices.SortFunc(e, func(a, b Example) int &#123; return a.Number - b.Number &#125;) fmt.Printf("Sorted: %v\n", e) slices.Reverse(e) fmt.Printf("Reversed: %v\n", e)&#125; 1234Sorted: [1 2 3 4 5]Reversed: [5 4 3 2 1]Sorted: [&#123;A 1&#125; &#123;B 2&#125; &#123;C 3&#125; &#123;D 4&#125;]Reversed: [&#123;D 4&#125; &#123;C 3&#125; &#123;B 2&#125; &#123;A 1&#125;] ä¸è¿‡è¿™ä¸ªæ–¹æ³•æœ‰ä¸ªç¼ºç‚¹ï¼Œå°±æ˜¯æŽ’åºæ˜¯åŽŸåœ°è¿›è¡Œçš„ï¼Œä¿®æ”¹äº†åŽŸå§‹åˆ‡ç‰‡ã€‚å¦‚æžœè¯¥æ–¹æ³•è¿”å›žä¸€ä¸ªæ–°çš„æŽ’åºåŽçš„åˆ‡ç‰‡ï¼Œä»Žè€Œä¿ç•™åŽŸå§‹æ•°ç»„ä¼šæ›´å¥½ä¸€ç‚¹ã€‚ è®¿é—®å…ƒç´ slicesæš´éœ²äº†ä¸€äº›æ–¹æ³•ï¼Œå…è®¸ç”¨æˆ·åœ¨åˆ‡ç‰‡ä¸­æŸ¥æ‰¾å…ƒç´ çš„ä½ç½®ï¼š 12345678910111213141516171819202122232425262728293031package mainimport ( "fmt" "slices")type Example struct &#123; Name string Number int&#125;func main() &#123; s := []int&#123;4, 2, 5, 1, 3&#125; i := slices.Index(s, 3) fmt.Printf("Index of 3: %d\n", i) e := []Example&#123; &#123;"C", 3&#125;, &#123;"A", 1&#125;, &#123;"D", 4&#125;, &#123;"B", 2&#125;, &#125; i = slices.IndexFunc(e, func(a Example) bool &#123; return a.Number == 3 &#125;) fmt.Printf("Index of 3: %d\n", i)&#125; 12Index of 3: 4Index of 3: 0 å¦‚æžœä½ æ­£åœ¨å¤„ç†å·²æŽ’åºçš„åˆ‡ç‰‡ï¼Œä½ å¯ä»¥ä½¿ç”¨ BinarySearch æˆ– BinarySearchFunc åœ¨æŽ’åºçš„åˆ‡ç‰‡ä¸­æœç´¢ç›®æ ‡ï¼Œå¹¶è¿”å›žç›®æ ‡è¢«æ‰¾åˆ°çš„ä½ç½®æˆ–ç›®æ ‡å°†å‡ºçŽ°åœ¨æŽ’åºé¡ºåºä¸­çš„ä½ç½®ï¼›å®ƒè¿˜è¿”å›žä¸€ä¸ªå¸ƒå°”å€¼ï¼ŒæŒ‡ç¤ºç›®æ ‡æ˜¯å¦åœ¨åˆ‡ç‰‡ä¸­è¢«æ‰¾åˆ°ã€‚åˆ‡ç‰‡å¿…é¡»æŒ‰é€’å¢žé¡ºåºæŽ’åºã€‚ 123456789101112131415161718package mainimport ( "fmt" "slices")func main() &#123; s := []int&#123;4, 2, 5, 1, 3&#125; slices.Sort(s) i, found := slices.BinarySearch(s, 3) fmt.Printf("Position of 3: %d. Found: %t\n", i, found) i, found = slices.BinarySearch(s, 6) fmt.Printf("Position of 6: %d. Found: %t\n", i, found)&#125; 12Position of 3: 2. Found: truePosition of 6: 5. Found: false å®žç”¨å‡½æ•°slicesæä¾›äº†è®¸å¤šå®žç”¨å‡½æ•°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142package mainimport ( "fmt" "slices")type Example struct &#123; Name string Number int&#125;func main() &#123; e1 := []Example&#123; &#123;"C", 3&#125;, &#123;"A", 1&#125;, &#123;"D", 4&#125;, &#123;"B", 2&#125;, &#125; e2 := []Example&#123; &#123;"A", 1&#125;, &#123;"B", 2&#125;, &#123;"C", 3&#125;, &#123;"D", 4&#125;, &#125; fmt.Printf("Compare: %v\n", slices.CompareFunc(e1, e2, func(a, b Example) int &#123; return a.Number - b.Number &#125;)) fmt.Printf("Contains: %v\n", slices.ContainsFunc(e1, func(a Example) bool &#123; return a.Number == 2 &#125;)) fmt.Printf("Delete: %v\n", slices.Delete(e1, 2, 3)) fmt.Printf("Equal: %v\n", slices.Equal(e1, e2)) fmt.Printf("Is Sorted: %v\n", slices.IsSortedFunc(e1, func(a, b Example) int &#123; return a.Number - b.Number &#125;))&#125; 12345Compare: 2Contains: trueDelete: [&#123;C 3&#125; &#123;A 1&#125; &#123;B 2&#125;]Equal: falseIs Sorted: false slices åŒ…çš„å®˜æ–¹æ–‡æ¡£åœ°å€ Mapç±»ä¼¼äºŽslicesï¼Œmapsä¹Ÿæ˜¯ä»ŽGo 1.21å¼€å§‹å‡ºçŽ°åœ¨Goæ ‡å‡†åº“ä¸­çš„ã€‚å®ƒå®šä¹‰äº†å„ç§æ–¹æ³•æ¥æ“ä½œ mapsã€‚ 12345678910111213141516171819202122package mainimport ( "fmt" "maps")func main() &#123; m := map[int]string&#123;1: "one", 2: "two", 3: "three"&#125; c := maps.Clone(m) c[4] = "four" fmt.Printf("Original: %v\n", m) fmt.Printf("Clone: %v\n", c) maps.DeleteFunc(c, func(k int, v string) bool &#123; return k%2 == 0 &#125;) fmt.Printf("DeleteFunc: %v\n", c) fmt.Printf("Equal: %v\n", maps.Equal(m, c)) fmt.Printf("EqualFunc: %v\n", maps.EqualFunc(m, c, func(v1, v2 string) bool &#123; return v1 == v2 &#125;))&#125; 12345Original: map[1:one 2:two 3:three]Clone: map[1:one 2:two 3:three 4:four]DeleteFunc: map[1:one 3:three]Equal: falseEqualFunc: false maps åŒ…çš„å®˜æ–¹æ–‡æ¡£åœ°å€ github.com/elliotchance/pieè¿™æ˜¯æˆ‘ä¸ªäººæœ€å–œæ¬¢çš„ç”¨æ¥æ“ä½œåˆ‡ç‰‡å’Œæ˜ å°„çš„åŒ…ã€‚å®ƒæä¾›äº†ä¸€ç§ç‹¬ç‰¹çš„è¯­æ³•ï¼Œä½¿æ‚¨èƒ½å¤Ÿæ— ç¼åœ°é“¾æŽ¥æ“ä½œï¼Œæé«˜äº†ä»£ç çš„å¯è¯»æ€§å’Œæ•ˆçŽ‡ã€‚ ä½¿ç”¨åº“æ–¹æ³•æœ‰å››ç§æ–¹å¼ï¼š çº¯è°ƒç”¨ â€” åªéœ€è°ƒç”¨åº“æ–¹æ³•å¹¶æä¾›æ‰€éœ€çš„å‚æ•°ï¼› pie.Of â€” é“¾æŽ¥å¤šä¸ªæ“ä½œï¼Œæ”¯æŒä»»ä½•å…ƒç´ ç±»åž‹ï¼› pie.OfOrdered â€” é“¾æŽ¥å¤šä¸ªæ“ä½œï¼Œæ”¯æŒæ•°å­—å’Œå­—ç¬¦ä¸²ç±»åž‹ï¼› pie.OfNumeric â€” é“¾æŽ¥å¤šä¸ªæ“ä½œï¼Œä»…æ”¯æŒæ•°å­—ç±»åž‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package mainimport ( "fmt" "strings" "github.com/elliotchance/pie/v2")type Example struct &#123; Name string Number int&#125;func main() &#123; e := []Example&#123; &#123;"C", 3&#125;, &#123;"A", 1&#125;, &#123;"D", 4&#125;, &#123;"B", 2&#125;, &#125; fmt.Printf( "Map 1: %v\n", pie.Sort( pie.Map( e, func(e Example) string &#123; return e.Name &#125;, ), ), ) fmt.Printf( "Map 2: %v\n", pie.Of(e). Map(func(e Example) Example &#123; return Example&#123; Name: e.Name, Number: e.Number * 2, &#125; &#125;). SortUsing(func(a, b Example) bool &#123; return a.Number &lt; b.Number &#125;), ) fmt.Printf( "Map 3: %v\n", pie.OfOrdered([]string&#123;"A", "C", "B", "A"&#125;). Map(func(e string) string &#123; return strings.ToLower(e) &#125;). Sort(), ) fmt.Printf( "Map 4: %v\n", pie.OfNumeric([]int&#123;4, 1, 3, 2&#125;). Map(func(e int) int &#123; return e * 2 &#125;). Sort(), )&#125; 1234Map 1: [A B C D]Map 2: &#123;[&#123;A 2&#125; &#123;B 4&#125; &#123;C 6&#125; &#123;D 8&#125;]&#125;Map 3: &#123;[a a b c]&#125;Map 4: &#123;[2 4 6 8]&#125; ç”±äºŽè¯¸å¦‚ Map ç­‰å‡½æ•°åº”è¯¥è¿”å›žç›¸åŒç±»åž‹çš„é›†åˆï¼Œå› æ­¤è¿™ä¸ªåº“çš„é“¾å¼æ“ä½œç›¸å½“å—é™ã€‚å› æ­¤ï¼Œæˆ‘è®¤ä¸ºçº¯æ–¹æ³•è°ƒç”¨æ˜¯ä½¿ç”¨è¿™ä¸ªåº“çš„æœ€ä½³æ–¹å¼ã€‚ è¯¥åº“æä¾›äº† Map æ–¹æ³•ï¼Œå…è®¸å°†æ¯ä¸ªå…ƒç´ ä»Žä¸€ç§ç±»åž‹è½¬æ¢ä¸ºå¦ä¸€ç§ç±»åž‹ã€‚ 12345678910111213141516171819202122232425262728293031package mainimport ( "fmt" "github.com/elliotchance/pie/v2")type Example struct &#123; Name string Number int&#125;func main() &#123; e := []Example&#123; &#123;"C", 3&#125;, &#123;"A", 1&#125;, &#123;"D", 4&#125;, &#123;"B", 2&#125;, &#125; fmt.Printf( "Map: %v\n", pie.Map( e, func(e Example) string &#123; return e.Name &#125;, ), )&#125; è¿˜æä¾›äº† Flat æ–¹æ³•ï¼Œå®ƒå°†äºŒç»´åˆ‡ç‰‡è½¬æ¢ä¸ºä¸€ç»´åˆ‡ç‰‡ã€‚ 12345678910111213141516171819202122232425262728293031323334package mainimport ( "fmt" "github.com/elliotchance/pie/v2")type Person struct &#123; Name string Tags []string&#125;func main() &#123; p := []Person&#123; &#123;"Alice", []string&#123;"a", "b", "c"&#125;&#125;, &#123;"Bob", []string&#123;"b", "c", "d"&#125;&#125;, &#123;"Charlie", []string&#123;"c", "d", "e"&#125;&#125;, &#125; fmt.Printf( "Unique Tags: %v\n", pie.Unique( pie.Flat( pie.Map( p, func(e Person) []string &#123; return e.Tags &#125;, ), ), ), )&#125; 1Unique Tags: [b c d e a] ä½¿ç”¨ Keys æˆ– Values æ–¹æ³•å¯ä»¥ä»…èŽ·å– Map çš„é”®æˆ–å€¼ã€‚ 123456789101112131415161718package mainimport ( "fmt" "github.com/elliotchance/pie/v2")func main() &#123; m := map[int]string&#123; 1: "one", 2: "two", 3: "three", &#125; fmt.Printf("Keys: %v\n", pie.Keys(m)) fmt.Printf("Values: %v\n", pie.Values(m))&#125; Output: 12Keys: [3 1 2]Values: [one two three] Filterè¯¥åº“æä¾›äº†å‡ ç§è¿‡æ»¤åŽŸå§‹é›†åˆçš„æ–¹æ³•ï¼šBottomã€DropTopã€DropWhileã€Filterã€FilterNotã€Unique ç­‰ã€‚ 123456Bottom 3: [4 4 4]Drop top 3: [3 3 3 4 4 4 4]Drop while 3: [3 3 3 4 4 4 4]Filter even: [2 2 4 4 4 4]Filter not even: [1 3 3 3]Unique values: [1 2 3 4] Aggregationæœ‰ä¸€ä¸ªé€šç”¨çš„èšåˆæ–¹æ³• Reduceã€‚è®©æˆ‘ä»¬æ¥è®¡ç®—æ ‡å‡†å·®ï¼š 1234567891011121314151617181920212223242526package mainimport ( "fmt" "math" "github.com/elliotchance/pie/v2")func main() &#123; v := []float64&#123;1.1, 2.2, 3.3, 4.4, 5.5&#125; avg := pie.Average(v) count := len(v) sum2 := pie.Reduce( v, func(acc, value float64) float64 &#123; return acc + (value-avg)*(value-avg) &#125;, ) - v[0] + (v[0]-avg)*(v[0]-avg) d := math.Sqrt(sum2 / float64(count)) fmt.Printf("Standard deviation: %f\n", d)&#125; Output: 1Standard deviation: 1.555635 Reduce æ–¹æ³•é¦–å…ˆå°†ç¬¬ä¸€ä¸ªåˆ‡ç‰‡å…ƒç´ ä½œä¸ºç´¯ç§¯å€¼ï¼Œå°†ç¬¬äºŒä¸ªå…ƒç´ ä½œä¸ºå€¼å‚æ•°è°ƒç”¨ reducerã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå…¬å¼çœ‹èµ·æ¥å¾ˆå¥‡æ€ªã€‚ ä»Žä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥æ‰¾åˆ°å¦ä¸€ä¸ªå†…ç½®çš„èšåˆæ–¹æ³• Averageã€‚æ­¤å¤–ï¼Œæ‚¨è¿˜å¯ä»¥æ‰¾åˆ° Minã€Maxã€Product ç­‰æ–¹æ³•ã€‚ 12345678910111213141516171819202122232425262728package mainimport ( "fmt" "github.com/elliotchance/pie/v2")func main() &#123; v := []float64&#123;1.1, 2.2, 3.3, 4.4, 5.5&#125; fmt.Printf("Average: %f\n", pie.Average(v)) fmt.Printf("Stddev: %f\n", pie.Stddev(v)) fmt.Printf("Max: %f\n", pie.Max(v)) fmt.Printf("Min: %f\n", pie.Min(v)) fmt.Printf("Sum: %f\n", pie.Sum(v)) fmt.Printf("Product: %f\n", pie.Product(v)) fmt.Printf("All &gt;0: %t\n", pie.Of(v).All(func(value float64) bool &#123; return value &gt; 0 &#125;)) fmt.Printf("Any &gt;5: %t\n", pie.Of(v).Any(func(value float64) bool &#123; return value &gt; 5 &#125;)) fmt.Printf("First: %f\n", pie.First(v)) fmt.Printf("Last: %f\n", pie.Last(v)) fmt.Printf("Are Unique: %t\n", pie.AreUnique(v)) fmt.Printf("Are Sorted: %t\n", pie.AreSorted(v)) fmt.Printf("Contains 3.3: %t\n", pie.Contains(v, 3.3))&#125; 12345678910111213Average: 3.300000Stddev: 1.555635Max: 5.500000Min: 1.100000Sum: 16.500000Product: 193.261200All &gt;0: trueAny &gt;5: trueFirst: 1.100000Last: 5.500000Are Unique: trueAre Sorted: trueContains 3.3: true Sorting/Orderingæœ‰ä¸‰ç§ä¸åŒçš„æ–¹æ³•å¯ä»¥ä½¿ç”¨ pie å¯¹åˆ‡ç‰‡è¿›è¡ŒæŽ’åºï¼š Sort â€” ç±»ä¼¼äºŽ sort.Sliceã€‚ä½†ä¸Ž sort.Slice ä¸åŒçš„æ˜¯ï¼Œè¿”å›žçš„åˆ‡ç‰‡å°†è¢«é‡æ–°åˆ†é…ï¼Œä»¥ä¸ä¿®æ”¹è¾“å…¥åˆ‡ç‰‡ï¼›SortStableUsing â€” ç±»ä¼¼äºŽ sort.SliceStableã€‚ä½†ä¸Ž sort.SliceStable ä¸åŒçš„æ˜¯ï¼Œè¿”å›žçš„åˆ‡ç‰‡å°†è¢«é‡æ–°åˆ†é…ï¼Œä»¥ä¸ä¿®æ”¹è¾“å…¥åˆ‡ç‰‡ï¼›SortUsing â€” ç±»ä¼¼äºŽ sort.Sliceã€‚ä½†ä¸Ž sort.Slice ä¸åŒçš„æ˜¯ï¼Œè¿”å›žçš„åˆ‡ç‰‡å°†è¢«é‡æ–°åˆ†é…ï¼Œä»¥ä¸ä¿®æ”¹è¾“å…¥åˆ‡ç‰‡ã€‚ 1234567891011121314151617181920package mainimport ( "fmt" "github.com/elliotchance/pie/v2")func main() &#123; v := []int&#123;3, 5, 1, 4, 2&#125; less := func(a, b int) bool &#123; return a &lt; b &#125; fmt.Printf("Sort: %v\n", pie.Sort(v)) fmt.Printf("SortStableUsing: %v\n", pie.SortStableUsing(v, less)) fmt.Printf("SortUsing: %v\n", pie.SortUsing(v, less)) fmt.Printf("Original: %v\n", v)&#125; Output: 1234Sort: [1 2 3 4 5]SortStableUsing: [1 2 3 4 5]SortUsing: [1 2 3 4 5]Original: [3 5 1 4 2] Accesspie æä¾›äº† FindFirstUsing æ–¹æ³•ï¼Œç”¨äºŽèŽ·å–åˆ‡ç‰‡ä¸­ç¬¬ä¸€ä¸ªä¸Žè°“è¯åŒ¹é…çš„å…ƒç´ çš„ç´¢å¼•ã€‚ 12345678910111213141516171819202122232425262728293031package mainimport ( "fmt" "github.com/elliotchance/pie/v2")type Person struct &#123; Name string Age int&#125;func main() &#123; p := []Person&#123; &#123;"Alice", 25&#125;, &#123;"Bob", 30&#125;, &#123;"Charlie", 35&#125;, &#125; fmt.Printf( "FindFirstUsing: %v\n", pie.FindFirstUsing( p, func(p Person) bool &#123; return p.Age &gt;= 30 &#125;, ), )&#125; 1FindFirstUsing: 2 pie åŒ…å«è®¸å¤šç”¨äºŽå¤„ç†åˆ‡ç‰‡çš„å®žç”¨æ–¹æ³•ã€‚ä¸¾å‡ ä¸ªä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829package mainimport ( "fmt" "math/rand" "time" "github.com/elliotchance/pie/v2")type Person struct &#123; Name string Age int&#125;func main() &#123; p := []Person&#123; &#123;"Alice", 25&#125;, &#123;"Bob", 30&#125;, &#123;"Charlie", 35&#125;, &#123;"David", 25&#125;, &#123;"Eve", 40&#125;, &#123;"Frank", 35&#125;, &#125; fmt.Printf("Chunk: %v\n", pie.Chunk(p, 2)) fmt.Printf("GroupBy: %v\n", pie.GroupBy(p, func(p Person) int &#123; return p.Age &#125;)) fmt.Printf("Shuffle: %v\n", pie.Shuffle(p, rand.New(rand.NewSource(time.Now().UnixNano()))))&#125; Output: 123Chunk: [[&#123;Alice 25&#125; &#123;Bob 30&#125;] [&#123;Charlie 35&#125; &#123;David 25&#125;] [&#123;Eve 40&#125; &#123;Frank 35&#125;]]GroupBy: map[25:[&#123;Alice 25&#125; &#123;David 25&#125;] 30:[&#123;Bob 30&#125;] 35:[&#123;Charlie 35&#125; &#123;Frank 35&#125;] 40:[&#123;Eve 40&#125;]]Shuffle: [&#123;Frank 35&#125; &#123;Bob 30&#125; &#123;David 25&#125; &#123;Eve 40&#125; &#123;Alice 25&#125; &#123;Charlie 35&#125;] ä¸‹é¢æ˜¯ pie åŒ…çš„åœ°å€ elliotchance/pie/v2 åº“æä¾›äº†ä¸€å¥—éžå¸¸å®Œæ•´çš„çš„å¤„ç†é›†åˆçš„èƒ½åŠ›ï¼Œæžå¤§åœ°ç®€åŒ–äº†åœ¨ Go ä¸­å¤„ç†åˆ‡ç‰‡çš„å·¥ä½œã€‚å…¶å¼ºå¤§çš„æ–¹æ³•ç”¨äºŽæ“ä½œå’ŒæŸ¥è¯¢åˆ‡ç‰‡æ•°æ®ï¼Œä¸ºå¼€å‘äººå‘˜æä¾›äº†ä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå¢žå¼ºäº†ä»£ç çš„å¯è¯»æ€§å’Œæ•ˆçŽ‡ã€‚æˆ‘å¼ºçƒˆå»ºè®®ä»»ä½• Go å¼€å‘äººå‘˜åœ¨ä¸‹ä¸€ä¸ªé¡¹ç›®ä¸­å°è¯•ä½¿ç”¨è¿™ä¸ªåº“ã€‚ github.com/samber/loå¦ä¸€ä¸ªåœ¨ Go ä¸­æ“ä½œé›†åˆçš„æµè¡Œåº“ã€‚åœ¨æŸäº›æ–¹é¢ï¼Œå®ƒå¯èƒ½ç±»ä¼¼äºŽæµè¡Œçš„ JavaScript åº“ Lodashã€‚å®ƒåœ¨å†…éƒ¨ä½¿ç”¨æ³›åž‹ï¼Œè€Œä¸æ˜¯åå°„ã€‚ Transformè¯¥åº“æ”¯æŒé»˜è®¤çš„ Map å’Œ FlatMap æ–¹æ³•ç”¨äºŽåˆ‡ç‰‡ï¼š 12345678910111213141516171819202122232425262728293031package mainimport ( "fmt" "github.com/samber/lo")type Example struct &#123; Name string Number int&#125;func main() &#123; e := []Example&#123; &#123;"C", 3&#125;, &#123;"A", 1&#125;, &#123;"D", 4&#125;, &#123;"B", 2&#125;, &#125; fmt.Printf( "Map: %v\n", lo.Map( e, func(e Example, index int) string &#123; return e.Name &#125;, ), )&#125; 1Map: [C A D B] ä¸‹é¢çš„ä»£ç æ¼”ç¤ºå¦‚ä½•æ“ä½œ FlatMap: 1234567891011121314151617181920212223242526272829303132package mainimport ( "fmt" "github.com/samber/lo")type Person struct &#123; Name string Tags []string&#125;func main() &#123; p := []Person&#123; &#123;"Alice", []string&#123;"a", "b", "c"&#125;&#125;, &#123;"Bob", []string&#123;"b", "c", "d"&#125;&#125;, &#123;"Charlie", []string&#123;"c", "d", "e"&#125;&#125;, &#125; fmt.Printf( "Unique Tags: %v\n", lo.Uniq( lo.FlatMap( p, func(e Person, index int) []string &#123; return e.Tags &#125;, ), ), )&#125; æ­¤å¤–ï¼Œè¿˜å¯ä»¥èŽ·å–æ˜ å°„é”®ã€å€¼æˆ–å°†æ˜ å°„å¯¹è½¬æ¢ä¸ºæŸäº›åˆ‡ç‰‡ç­‰æ“ä½œï¼š 12345678910111213141516171819202122package mainimport ( "fmt" "strings" "github.com/samber/lo")func main() &#123; m := map[int]string&#123; 1: "one", 2: "two", 3: "three", &#125; fmt.Printf("Keys: %v\n", lo.Keys(m)) fmt.Printf("Values: %v\n", lo.Values(m)) fmt.Printf("MapKeys: %v\n", lo.MapKeys(m, func(value string, num int) int &#123; return num * 2 &#125;)) fmt.Printf("MapValues: %v\n", lo.MapValues(m, func(value string, num int) string &#123; return strings.ToUpper(value) &#125;)) fmt.Printf("MapToSlice: %v\n", lo.MapToSlice(m, func(num int, value string) string &#123; return value + ":" + fmt.Sprint(num) &#125;))&#125; Outputs: 12345Keys: [2 3 1]Values: [one two three]MapKeys: map[2:one 4:two 6:three]MapValues: map[1:ONE 2:TWO 3:THREE]MapToSlice: [three:3 one:1 two:2] Filteråœ¨ lo åº“ä¸­æœ‰è®¸å¤š Drop æ–¹æ³•ï¼š 12345678910111213141516package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; v := []int&#123;1, 2, 3, 4, 5&#125; fmt.Printf("Drop: %v\n", lo.Drop(v, 2)) fmt.Printf("DropRight: %v\n", lo.DropRight(v, 2)) fmt.Printf("DropWhile: %v\n", lo.DropWhile(v, func(i int) bool &#123; return i &lt; 3 &#125;)) fmt.Printf("DropRightWhile: %v\n", lo.DropRightWhile(v, func(i int) bool &#123; return i &gt; 3 &#125;))&#125; Outputs: 1234Drop: [3 4 5]DropRight: [1 2 3]DropWhile: [3 4 5]DropRightWhile: [1 2 3] æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ predicate è¿‡æ»¤åˆ‡ç‰‡å’Œæ˜ å°„ï¼š 123456789101112131415package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; v := []int&#123;1, 2, 3, 4, 5&#125; m := map[string]int&#123;"a": 1, "b": 2, "c": 3&#125; fmt.Printf("Filter: %v\n", lo.Filter(v, func(i int, index int) bool &#123; return i &gt; 2 &#125;)) fmt.Printf("PickBy: %v\n", lo.PickBy(m, func(key string, value int) bool &#123; return value &gt; 2 &#125;))&#125; Outputs: 12Filter: [3 4 5]PickBy: map[c:3] Aggregationlo package æä¾›äº† reduce çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526package mainimport ( "fmt" "math" "github.com/samber/lo")func main() &#123; v := []float64&#123;1.1, 2.2, 3.3, 4.4, 5.5&#125; count := len(v) avg := lo.Reduce(v, func(acc, val float64, index int) float64 &#123; return acc + val &#125;, 0.0) / float64(count) sum2 := lo.Reduce(v, func(acc, val float64, index int) float64 &#123; return acc + (val-avg)*(val-avg) &#125;, 0.0) d := math.Sqrt(sum2 / float64(count)) fmt.Printf("Standard deviation: %f\n", d)&#125; Outputs: 1Standard deviation: 1.555635 æ­¤å¤–ï¼Œå®ƒæ”¯æŒä¸€äº›é€šç”¨çš„èšåˆæ–¹æ³•ï¼Œå¦‚ Sumã€Minã€Maxï¼š 123456789101112131415package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; v := []float64&#123;1.1, 2.2, 3.3, 4.4, 5.5&#125; fmt.Printf("Sum: %v\n", lo.Sum(v)) fmt.Printf("Min: %v\n", lo.Min(v)) fmt.Printf("Max: %v\n", lo.Max(v))&#125; æœ‰ä¸€äº›æœ‰ç”¨çš„æ–¹æ³•ç”¨äºŽå¤„ç† channelï¼šFanIn å’Œ FanOut 123456789101112131415161718192021222324252627282930313233package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; ch1 := make(chan int) ch2 := make(chan int) ch3 := make(chan int) ch := lo.FanIn(10, ch1, ch2, ch3) for i := 0; i &lt; 10; i++ &#123; if i%3 == 0 &#123; ch1 &lt;- i &#125; else if i%3 == 1 &#123; ch2 &lt;- i &#125; else &#123; ch3 &lt;- i &#125; &#125; close(ch1) close(ch2) close(ch3) for v := range ch &#123; fmt.Println(v) &#125;&#125; è¿˜å¯ä»¥è¿™æ ·å¤„ç† channel: 123456789101112131415161718192021222324package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; ch := make(chan int) chs := lo.FanOut(3, 10, ch) for i := 0; i &lt; 3; i++ &#123; ch &lt;- i &#125; close(ch) for _, ch := range chs &#123; for v := range ch &#123; fmt.Println(v) &#125; &#125;&#125; Sorting/Orderinglo è¿˜æä¾› Reverse æ–¹æ³•ï¼š 12345678910111213package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; v := []int&#123;1, 2, 3, 4, 5&#125; fmt.Printf("Reverse: %v\n", lo.Reverse(v))&#125; Accesslo åº“æä¾›äº† find æ–¹æ³•æ¥è®¿é—®å…ƒç´ ï¼š 1234567891011121314151617181920212223242526272829303132333435363738package mainimport ( "fmt" "github.com/samber/lo")type Person struct &#123; Name string Age int&#125;func main() &#123; p := []Person&#123; &#123;"Alice", 25&#125;, &#123;"Bob", 30&#125;, &#123;"Charlie", 35&#125;, &#123;"David", 25&#125;, &#123;"Edward", 40&#125;, &#125; item, found := lo.Find(p, func(p Person) bool &#123; return p.Name == "Charlie" &#125;) fmt.Printf("Item: %+v, Found: %v\n", item, found) fmt.Printf("FindDuplicatesBy: %v\n", lo.FindDuplicatesBy(p, func(p Person) int &#123; return p.Age &#125;)) item, index, found := lo.FindIndexOf(p, func(p Person) bool &#123; return p.Name == "Charlie" &#125;) fmt.Printf("Item: %+v, Index: %v, Found: %v\n", item, index, found)&#125; Outputs: 123Item: &#123;Name:Charlie Age:35&#125;, Found: trueFindDuplicatesBy: [&#123;Alice 25&#125;]Item: &#123;Name:Charlie Age:35&#125;, Index: 2, Found: true Find æ–¹æ³•åŒæ ·æ”¯æŒ map: 1234567891011121314151617181920package mainimport ( "fmt" "github.com/samber/lo")func main() &#123; p := map[string]int&#123; "Alice": 34, "Bob": 24, "Charlie": 34, "David": 29, "Eve": 34, &#125; key, found := lo.FindKey(p, 34) fmt.Printf("Key: %v, Found: %v\n", key, found)&#125; lo çš„æ–‡æ¡£åœ°å€ æ€»ç»“è¿™é‡Œåªå±•ç¤ºäº† github.com/samber/lo åº“çº¦ 10% çš„æ–¹æ³•ã€‚è¿™ä¸ªåº“æä¾›äº†è®¸å¤šç®€åŒ–å‡½æ•°å¤„ç†çš„å®žç”¨å·¥å…·ã€‚å¯¹äºŽ Go å¼€å‘äººå‘˜æ¥è¯´ï¼Œè¿™ä¸ªåº“æ˜¯ä¸€ä¸ªéžå¸¸å…¨é¢çš„å·¥å…·åŒ…ã€‚ æœ¬æ–‡å±•ç¤ºäº†ä¸€äº›åœ¨ Go ä¸­å¤„ç†é›†åˆæ—¶æŽ¨èçš„åº“ï¼Œå¸Œæœ›å¯¹å¤§å®¶çš„å¼€å‘å·¥ä½œæœ‰å¸®åŠ©ã€‚]]></content>
      <categories>
        <category>Golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Golang å¦‚ä½•å®žçŽ°è‡ªå®šä¹‰ CDC å·¥å…·ï¼Ÿ]]></title>
    <url>%2F2024%2F05%2F04%2FGolang-%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89-CDC-%E5%B7%A5%E5%85%B7%EF%BC%9F%2F</url>
    <content type="text"><![CDATA[CDCå˜æ›´æ•°æ®æ•èŽ·ï¼ˆCDCï¼‰æ˜¯ä¸€ç§è·Ÿè¸ªæ•°æ®åº“æ›´æ”¹çš„æŠ€æœ¯ï¼Œå…è®¸å¼€å‘äººå‘˜æ•èŽ·åº”ç”¨äºŽè¡Œçš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ã€‚å®ƒæ˜¯æ•°æ®é›†æˆå’Œå®žæ—¶å¤„ç†ä»»åŠ¡çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†è®¨è®ºå¦‚ä½•åœ¨ Golang ä¸­ä¸º PostgreSQLã€Oracleã€MySQLã€MongoDB å’Œ SQL Server ç­‰å¤šä¸ªæ•°æ®åº“å¼€å‘è‡ªå®šä¹‰ CDC å·¥å…·ã€‚ é€šå¸¸åœ¨ CDC é¢†åŸŸæˆ–è€…è¯´å¤§æ•°æ®é¢†åŸŸéƒ½æ˜¯ java çš„ç”Ÿæ€æ¯”è¾ƒç¹è£ï¼Œæ¯”å¦‚ Flink, Spark, æœ€è¿‘å¤§ç«çš„ paimon éƒ½æ˜¯ java å†™çš„ã€‚Java åœ¨æ•°æ®ç”Ÿæ€çš„ç¹è£ä¸ºå¯¹åº”æ•°æ®å·¥å…·çš„å¼€å‘æä¾›äº†åœŸå£¤ã€‚é‚£ä¹ˆæˆ‘ä»¬ Gopher å¦‚æžœä¹Ÿæƒ³å¼€å‘ CDC å·¥å…·æ€Žä¹ˆåŠžï¼Ÿä»Šå¤©ä»‹ç»çš„æ˜¯ä¸€äº› golang çš„ Libï¼ŒåŸºäºŽè¿™äº› lib æˆ‘ä»¬ä¹Ÿå¯ä»¥å®žçŽ°è‡ªå®šä¹‰çš„ CDC å·¥å…·ã€‚ PostgreSQLå¯¹äºŽ PostgreSQLï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ pglogrepl åº“ï¼ˆgithub.com/jackc/pglogreplï¼‰ã€‚è¯¥åº“æä¾›äº† PostgreSQL ä¸­çš„é€»è¾‘è§£ç å’Œæµå¤åˆ¶åè®®çš„ä½Žçº§ APIã€‚å®ƒå…è®¸æ‚¨è¯»å– PostgreSQL çš„é¢„å†™å¼æ—¥å¿—ï¼ˆWALï¼‰ï¼Œè¿™äº›æ—¥å¿—æ˜¯å­˜å‚¨æ‰€æœ‰å¯¹æ•°æ®åº“çš„æ›´æ”¹çš„åœ°æ–¹ã€‚é€šè¿‡è¯»å–å’Œè§£ç è¿™äº›æ—¥å¿—ï¼Œæˆ‘ä»¬å¯ä»¥è·Ÿè¸ªæ•°æ®åº“ä¸­çš„æ›´æ”¹ã€‚è§£ç å¯ä»¥åœ¨æ’ä»¶çº§åˆ«æˆ–æ¶ˆè´¹è€…çº§åˆ«è¿›è¡Œï¼Œè¿™å–å†³äºŽ PostgreSQL ä¸­ä½¿ç”¨çš„è§£ç æ’ä»¶ã€‚ Oracleä¸º Oracle åˆ›å»º CDC å·¥å…·è¦å¤æ‚ä¸€äº›ã€‚Oracle æœ‰ä¸€ä¸ªåä¸º â€œLogMinerâ€ çš„å†…ç½®å·¥å…·ï¼Œå®ƒå…è®¸æ‚¨é€šè¿‡ SQL æŽ¥å£æŸ¥è¯¢åœ¨çº¿å’Œå½’æ¡£çš„é‡åšæ—¥å¿—æ–‡ä»¶ã€‚æ•°æ®çš„ä¸»è¦æ¥æºå°†æ˜¯ V$LOGMNR_CONTENTS è§†å›¾ï¼Œè¿™æ˜¯ LogMiner åœ¨å¯¹å…¶è¿›è¡ŒæŒ–æŽ˜åŽçš„é‡åšæ—¥å¿—æ•°æ®çš„è§†å›¾ã€‚ æˆ‘ä»¬çš„ CDC å·¥å…·éœ€è¦å®šæœŸæŸ¥è¯¢æ­¤è§†å›¾ï¼Œå¹¶è§£æž SQL_REDO å’Œ SQL_UNDO å­—æ®µï¼Œä»¥äº†è§£å¯¹æ•°æ®åº“æ‰€åšçš„æ›´æ”¹ã€‚è¿™éœ€è¦ç†è§£ Oracle çš„ SQL è¯­æ³•ï¼Œå¹¶å¯èƒ½å¤„ç†ä¸åŒç‰ˆæœ¬çš„ Oracleï¼Œå› ä¸ºè¯­æ³•å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚ MySQLå¯ä»¥ä½¿ç”¨ go-mysql åº“ï¼ˆgithub.com/go-mysql-org/go-mysql/canalï¼‰å¤„ç† MySQLã€‚è¯¥è½¯ä»¶åŒ…æä¾›äº†ä¸€ä¸ªæ¡†æž¶ï¼Œç”¨äºŽå°† MySQL çš„ binlog åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿã€‚å®ƒæ”¯æŒå°† MySQL çš„ binlog åŒæ­¥åˆ°ç”¨æˆ·å®šä¹‰çš„å¤„ç†ç¨‹åºï¼Œä¾‹å¦‚ stdout å’Œ Kafka æ¶ˆæ¯é˜Ÿåˆ—ã€‚é€šè¿‡ä½¿ç”¨è¯¥åº“ï¼Œæˆ‘ä»¬å¯ä»¥ç›¸å¯¹ç®€å•åœ°è·Ÿè¸ªæ•°æ®åº“ä¸­çš„æ›´æ”¹ã€‚ MongoDBå¯¹äºŽ MongoDBï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ mongo-driver/mongo åŒ…ï¼ˆgo.mongodb.org/mongo-driver/mongoï¼‰ã€‚è¯¥è½¯ä»¶åŒ…ä¸º Go æä¾›äº† MongoDB é©±åŠ¨ç¨‹åº APIã€‚MongoDB é©±åŠ¨ç¨‹åºæ”¯æŒ â€œChange Streamsâ€ï¼Œå®ƒå…è®¸åº”ç”¨ç¨‹åºè®¿é—®å®žæ—¶æ•°æ®æ›´æ”¹ï¼Œè€Œæ— éœ€å°¾éš oplog çš„å¤æ‚æ€§å’Œé£Žé™©ã€‚åº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨æ›´æ”¹æµè®¢é˜…å•ä¸ªé›†åˆã€æ•°æ®åº“æˆ–æ•´ä¸ªéƒ¨ç½²ä¸Šçš„æ‰€æœ‰æ•°æ®æ›´æ”¹ï¼Œå¹¶ç«‹å³å¯¹å…¶è¿›è¡Œå“åº”ã€‚ SQL Serverå¯¹äºŽ SQL Serverï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ go-mssqldb åŒ…ï¼ˆgithub.com/denisenkom/go-mssqldbï¼‰ã€‚SQL Server æ”¯æŒå˜æ›´è·Ÿè¸ªï¼Œå®ƒè·Ÿè¸ªè¡¨ä¸Šçš„ DML æ›´æ”¹ï¼ˆæ’å…¥ã€æ›´æ–°ã€åˆ é™¤ï¼‰ã€‚é€šè¿‡æŸ¥è¯¢è¿™äº›å˜æ›´è¡¨ï¼Œæˆ‘ä»¬å¯ä»¥èŽ·å–æœ‰å…³æ›´æ”¹çš„ä¿¡æ¯ã€‚è¯·æ³¨æ„ï¼Œè¿™åªä¼šå‘Šè¯‰æˆ‘ä»¬æ›´æ”¹è¡Œçš„é”®ï¼Œè€Œä¸æ˜¯æ•°æ®æœ¬èº«ã€‚è¦èŽ·å–æ›´æ”¹çš„æ•°æ®ï¼Œæˆ‘ä»¬éœ€è¦å¯¹å®žé™…æ•°æ®è¡¨è¿›è¡Œå¦ä¸€ä¸ªæŸ¥è¯¢ã€‚ ç»“è®ºåœ¨ Golang ä¸­åˆ›å»ºè‡ªå®šä¹‰ CDC å·¥å…·æ¶‰åŠç†è§£æ¯ä¸ªæ•°æ®åº“ç”¨äºŽè®°å½•æ›´æ”¹çš„åŸºç¡€æœºåˆ¶ã€‚é€šè¿‡åˆ©ç”¨çŽ°æœ‰è½¯ä»¶åŒ…çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥æž„å»ºä¸€ä¸ªå¼ºå¤§çš„å·¥å…·ï¼Œå¯ä»¥è·Ÿè¸ªå¤šç§ç±»åž‹æ•°æ®åº“çš„æ›´æ”¹ã€‚ç„¶è€Œï¼Œè¦å®žçŽ°é«˜æ•ˆå’Œæœ‰æ•ˆçš„ CDC å·¥å…·ï¼Œéœ€è¦å¯¹æ¯ä¸ªæ•°æ®åº“çš„æ—¥å¿—æœºåˆ¶æœ‰é€å½»çš„äº†è§£ï¼Œä»¥åŠå¯¹ Golang æœ‰æ‰Žå®žçš„æŽŒæ¡ã€‚]]></content>
      <categories>
        <category>CDC</category>
      </categories>
      <tags>
        <tag>Golang</tag>
        <tag>CDC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[åŸºäºŽ langchaingo å¯¹æŽ¥å¤§æ¨¡åž‹ ollama å®žçŽ°æœ¬åœ°çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿ]]></title>
    <url>%2F2024%2F05%2F03%2F%E5%9F%BA%E4%BA%8E-langchaingo-%E5%AF%B9%E6%8E%A5%E5%A4%A7%E6%A8%A1%E5%9E%8B-ollama-%E5%AE%9E%E7%8E%B0%E6%9C%AC%E5%9C%B0%E7%9F%A5%E8%AF%86%E5%BA%93%E9%97%AE%E7%AD%94%E7%B3%BB%E7%BB%9F%2F</url>
    <content type="text"><![CDATA[Ollama æ˜¯ä¸€ä¸ªåŸºäºŽ Go è¯­è¨€å¼€å‘çš„ç®€å•æ˜“ç”¨çš„æœ¬åœ°å¤§è¯­è¨€æ¨¡åž‹è¿è¡Œæ¡†æž¶ã€‚åœ¨ç®¡ç†æ¨¡åž‹çš„åŒæ—¶ï¼Œå®ƒè¿˜åŸºäºŽ Go è¯­è¨€ä¸­çš„ Web æ¡†æž¶ ginæä¾›äº†ä¸€äº› Api æŽ¥å£ï¼Œè®©ä½ èƒ½å¤Ÿåƒè·Ÿ OpenAI æä¾›çš„æŽ¥å£é‚£æ ·è¿›è¡Œäº¤äº’ã€‚ Ollama å®˜æ–¹è¿˜æä¾›äº†è·Ÿ docker hub ä¸€æ ·çš„æ¨¡åž‹ hubï¼Œç”¨äºŽå­˜æ”¾å„ç§å¤§è¯­è¨€æ¨¡åž‹ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥ä¸Šä¼ è‡ªå·±è®­ç»ƒå¥½çš„æ¨¡åž‹ä¾›å…¶ä»–äººä½¿ç”¨ã€‚ å®‰è£… ollamaå¯ä»¥åœ¨ ollama çš„ github release é¡µé¢ç›´æŽ¥ä¸‹è½½å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶åŒ…è¿›è¡Œå®‰è£…ï¼Œä¹Ÿå¯ä»¥ docker ä¸€é”®éƒ¨ç½²ã€‚è¿™é‡Œæ¼”ç¤ºçš„æœºå™¨æ˜¯ macOS M1 PRO ç‰ˆæœ¬ï¼Œç›´æŽ¥ä¸‹è½½å®‰è£…åŒ…ï¼Œå®‰è£…å³å¯ï¼Œå®‰è£…ä¹‹åŽï¼Œè¿è¡Œè½¯ä»¶ã€‚ è¿è¡Œä¹‹åŽï¼Œé¡¹ç›®é»˜è®¤ç›‘å¬ 11434 ç«¯å£ï¼Œåœ¨ç»ˆç«¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å¯éªŒè¯æ˜¯å¦æ­£å¸¸è¿è¡Œï¼š 12$ curl localhost:11434Ollama is running å¤§æ¨¡åž‹ç®¡ç†ollama å®‰è£…åŽï¼Œå°±å¯ä»¥å¯¹å¤§æ¨¡åž‹è¿›é¡¹å®‰è£…ä½¿ç”¨äº†ã€‚Ollama è¿˜ä¼šæºå¸¦ä¸€ä¸ªå‘½ä»¤è¡Œå·¥å…·ï¼Œé€šè¿‡å®ƒå¯ä»¥ä¸Žæ¨¡åž‹è¿›è¡Œäº¤äº’ã€‚ ollama listï¼šæ˜¾ç¤ºæ¨¡åž‹åˆ—è¡¨ã€‚ ollama showï¼šæ˜¾ç¤ºæ¨¡åž‹çš„ä¿¡æ¯ ollama pullï¼šæ‹‰å–æ¨¡åž‹ ollama pushï¼šæŽ¨é€æ¨¡åž‹ ollama cpï¼šæ‹·è´ä¸€ä¸ªæ¨¡åž‹ ollama rmï¼šåˆ é™¤ä¸€ä¸ªæ¨¡åž‹ ollama runï¼šè¿è¡Œä¸€ä¸ªæ¨¡åž‹ åœ¨å®˜æ–¹æä¾›çš„æ¨¡åž‹ä»“åº“ä¸­å¯ä»¥æ‰¾åˆ°ä½ æƒ³è¦çš„æ¨¡åž‹ï¼šhttps://ollama.com/library æ³¨æ„ï¼šåº”è¯¥è‡³å°‘æœ‰ 8 GB å¯ç”¨ RAM æ¥è¿è¡Œ 7 B åž‹å·ï¼Œ16 GB æ¥è¿è¡Œ 13 B åž‹å·ï¼Œ32 GB æ¥è¿è¡Œ 33 B åž‹å·ã€‚ æ¯”å¦‚æˆ‘ä»¬å¯ä»¥é€‰æ‹© Qwen åšä¸ªæ¼”ç¤ºï¼Œè¿™é‡Œç”¨ 1.8B çš„æ¨¡åž‹(æœ¬åœ°ç”µè„‘æ¯”è¾ƒå¯æ€œï¼Œåªæœ‰ 16GðŸ˜­)ï¼š 1$ ollama run qwen:1.8b æ˜¯ä¸æ˜¯è§‰å¾—è¿™ä¸ªå‘½ä»¤ä¼¼æ›¾ç›¸è¯†ï¼Œæ˜¯çš„ï¼Œè·Ÿ docker run image ä¸€æ ·ï¼Œå¦‚æžœæœ¬åœ°æ²¡æœ‰è¯¥æ¨¡åž‹ï¼Œåˆ™ä¼šå…ˆä¸‹è½½æ¨¡åž‹å†è¿è¡Œã€‚ æ—¢ç„¶è·Ÿ docker å¦‚æ­¤ä¸€è‡´ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä¹Ÿä¼šæœ‰è·Ÿ Dockerfile ä¸€æ ·çš„ä¸œè¥¿ï¼Œæ˜¯çš„ï¼Œå«åš Modelfile : 123456789FROM qwen:14b# set the temperature to 1 [higher is more creative, lower is more coherent]PARAMETER temperature 1# set the system messageSYSTEM """You are Mario from super mario bros, acting as an assistant.""" ä¿å­˜ä¸Šé¢çš„ä»£ç ä¸º Modelfileï¼Œè¿è¡Œ llama create choose-a-model-name -f Modelfile å°±å¯ä»¥å®šåˆ¶ä½ çš„æ¨¡åž‹ï¼Œollama run choose-a-model-name å°±å¯ä»¥ä½¿ç”¨åˆšåˆšå®šåˆ¶çš„æ¨¡åž‹ã€‚ å¯¹æŽ¥ ollama å®žçŽ°æœ¬åœ°çŸ¥è¯†åº“é—®ç­”ç³»ç»Ÿå‰ç½®å‡†å¤‡æ¨¡åž‹éƒ½åœ¨æœ¬åœ°å®‰è£…å¥½äº†ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹æŽ¥è¿™ä¸ªæ¨¡åž‹ï¼Œå¼€å‘ä¸€äº›å¥½çŽ©çš„ä¸Šå±‚ AI åº”ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬åŸºäºŽ langchaningo å¼€å‘ä¸€ä¸ªé—®ç­”ç³»ç»Ÿã€‚ ä¸‹é¢çš„ç³»ç»Ÿä¼šç”¨åˆ°çš„æ¨¡åž‹æœ‰ ollama qwen1.8Bï¼Œnomic-embed-textï¼Œå…ˆæ¥å®‰è£…è¿™ä¸¤ä¸ªæ¨¡åž‹ï¼š 12ollama run qwen:1.8bollama run nomic-embed-text:latest æˆ‘ä»¬è¿˜éœ€è¦ä¸€ä¸ªå‘é‡æ•°æ®åº“æ¥å­˜å‚¨æ‹†åˆ†åŽçš„çŸ¥è¯†åº“å†…å®¹ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ qdrant : 12docker pull qdrant/qdrant$ docker run -itd --name qdrant -p 6333:6333 qdrant/qdrant å¯åŠ¨ qdrant åŽæˆ‘ä»¬å…ˆåˆ›å»ºä¸€ä¸ª Collection ç”¨äºŽå­˜å‚¨æ–‡æ¡£æ‹†åˆ†å—: 12345678curl -X PUT http://localhost:6333/collections/langchaingo-ollama-rag \ -H 'Content-Type: application/json' \ --data-raw '&#123; "vectors": &#123; "size": 768, "distance": "Dot" &#125; &#125;' çŸ¥è¯†åº“å†…å®¹åˆ‡åˆ†è¿™é‡Œæä¾›ä¸€ç¯‡æ–‡ç« ä¾›å¤§æ¨¡åž‹å­¦ä¹ ï¼Œä¸‹é¢çš„ä»£ç å°†æ–‡ç« æ‹†åˆ†æˆå°çš„æ–‡æ¡£å—ï¼š 1234567891011121314151617181920func TextToChunks(dirFile string, chunkSize, chunkOverlap int) ([]schema.Document, error) &#123; file, err := os.Open(dirFile) if err != nil &#123; return nil, err &#125; // create a doc loader docLoaded := documentloaders.NewText(file) // create a doc spliter split := textsplitter.NewRecursiveCharacter() // set doc chunk size split.ChunkSize = chunkSize // set chunk overlap size split.ChunkOverlap = chunkOverlap // load and split doc docs, err := docLoaded.LoadAndSplit(context.Background(), split) if err != nil &#123; return nil, err &#125; return docs, nil&#125; æ–‡æ¡£å­˜å‚¨åˆ°å‘é‡æ•°æ®åº“123456789func storeDocs(docs []schema.Document, store *qdrant.Store) error &#123; if len(docs) &gt; 0 &#123; _, err := store.AddDocuments(context.Background(), docs) if err != nil &#123; return err &#125; &#125; return nil&#125; è¯»å–ç”¨æˆ·è¾“å…¥å¹¶æŸ¥è¯¢æ•°æ®åº“123456789101112131415161718func useRetriaver(store *qdrant.Store, prompt string, topk int) ([]schema.Document, error) &#123; // è®¾ç½®é€‰é¡¹å‘é‡ optionsVector := []vectorstores.Option&#123; vectorstores.WithScoreThreshold(0.80), // è®¾ç½®åˆ†æ•°é˜ˆå€¼ &#125; // åˆ›å»ºæ£€ç´¢å™¨ retriever := vectorstores.ToRetriever(store, topk, optionsVector...) // æœç´¢ docRetrieved, err := retriever.GetRelevantDocuments(context.Background(), prompt) if err != nil &#123; return nil, fmt.Errorf("æ£€ç´¢æ–‡æ¡£å¤±è´¥: %v", err) &#125; // è¿”å›žæ£€ç´¢åˆ°çš„æ–‡æ¡£ return docRetrieved, nil&#125; åˆ›å»ºå¹¶åŠ è½½å¤§æ¨¡åž‹12345678910func getOllamaQwen() *ollama.LLM &#123; // åˆ›å»ºä¸€ä¸ªæ–°çš„ollamaæ¨¡åž‹ï¼Œæ¨¡åž‹åä¸º"qwena:1.8b" llm, err := ollama.New( ollama.WithModel("qwen:1.8b"), ollama.WithServerURL(ollamaServer)) if err != nil &#123; logger.Fatal("åˆ›å»ºollamaæ¨¡åž‹å¤±è´¥: %v", err) &#125; return llm&#125; å¤§æ¨¡åž‹å¤„ç†å°†æ£€ç´¢åˆ°çš„å†…å®¹ï¼Œäº¤ç»™å¤§è¯­è¨€æ¨¡åž‹å¤„ç† 123456789101112131415161718192021222324252627// GetAnswer èŽ·å–ç­”æ¡ˆfunc GetAnswer(ctx context.Context, llm llms.Model, docRetrieved []schema.Document, prompt string) (string, error) &#123; // åˆ›å»ºä¸€ä¸ªæ–°çš„èŠå¤©æ¶ˆæ¯åŽ†å²è®°å½• history := memory.NewChatMessageHistory() // å°†æ£€ç´¢åˆ°çš„æ–‡æ¡£æ·»åŠ åˆ°åŽ†å²è®°å½•ä¸­ for _, doc := range docRetrieved &#123; history.AddAIMessage(ctx, doc.PageContent) &#125; // ä½¿ç”¨åŽ†å²è®°å½•åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è¯ç¼“å†²åŒº conversation := memory.NewConversationBuffer(memory.WithChatHistory(history)) executor := agents.NewExecutor( agents.NewConversationalAgent(llm, nil), nil, agents.WithMemory(conversation), ) // è®¾ç½®é“¾è°ƒç”¨é€‰é¡¹ options := []chains.ChainCallOption&#123; chains.WithTemperature(0.8), &#125; res, err := chains.Run(ctx, executor, prompt, options...) if err != nil &#123; return "", err &#125; return res, nil&#125; è¿è¡Œåº”ç”¨1go run main.go getanswer è¾“å…¥ä½ æƒ³è¦å’¨è¯¢çš„é—®é¢˜ ç³»ç»Ÿè¾“å‡ºç»“æžœï¼š è¾“å‡ºçš„ç»“æžœå¯èƒ½ä¼šå› ä¸ºå­¦ä¹ èµ„æ–™çš„ä¸è¶³æˆ–è€…æ¨¡åž‹çš„å¤§å°å­˜åœ¨åŒºåˆ«ï¼Œæœ‰å¾ˆå¤šç»“æžœéƒ½ä¸æ˜¯å¾ˆå‡†ç¡®ï¼Œè¿™å°±éœ€è¦æä¾›æ›´å¤šçš„è¯­æ–™è¿›è¡Œè®­ç»ƒã€‚è€Œä¸”è¿˜è¦å¯¹ä»£ç é‡Œçš„å„ä¸ªå‚æ•°è¿›è¡Œè°ƒä¼˜ï¼Œå¹¶ç»“åˆæ–‡æ¡£çš„å†…å®¹ï¼Œå¤§å°ï¼Œæ ¼å¼ç­‰è¿›è¡Œå‚æ•°çš„è®¾å®šã€‚ é¡¹ç›®çš„æºç å¯ä»¥å‚è€ƒï¼šhttps://github.com/hantmac/langchaingo-ollama-rag.git]]></content>
      <categories>
        <category>ollama</category>
      </categories>
      <tags>
        <tag>langchaingo</tag>
        <tag>ollama</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ•°æ®åŒæ­¥å·¥å…·è€ƒå¤]]></title>
    <url>%2F2024%2F02%2F07%2F%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E8%80%83%E5%8F%A4%2F</url>
    <content type="text"><![CDATA[å‰è¨€åœ¨è¿‡åŽ»çš„ä¸€å¹´é‡Œï¼Œæˆ‘é™¤äº†æ—¥å¸¸çš„ Databend Cloud å¼€å‘å·¥ä½œä¹‹å¤–ï¼Œè¿˜å›´ç»•ç€ Databend åšäº†å¤§é‡çš„æ•°æ®ç”Ÿæ€å·¥ä½œã€‚è¿™åŒ…æ‹¬åœ¨ Databend Native åè®®çš„åŸºç¡€ä¸Šæä¾›äº†å¤šè¯­è¨€çš„ SDKï¼Œå¹¶åœ¨ SDK åŸºç¡€ä¸Šå¢žåŠ äº†å¯¹è¯¸å¦‚ Tableauã€Metabaseã€SuperSetã€Redashç­‰BIå·¥å…·çš„æ”¯æŒã€‚æ­¤å¤–ï¼Œæˆ‘è¿˜å®Œå–„äº†å…³äºŽæ•°æ®ä¼ è¾“å’Œå®žæ—¶åŒæ­¥é¢†åŸŸçš„ç”Ÿæ€ï¼Œæ¶‰åŠåˆ° Debezium Engineã€Flink CDCã€Kafka Connectã€Airbyteã€Datax Pluginã€TapData ç­‰å·¥å…·ã€‚ åœ¨è¿™ä¸€ç³»åˆ—çš„å·¥ä½œä¸­ï¼Œæ•°æ®åŒæ­¥æ˜¯ä¸€ä¸ªéžå¸¸å…³é”®çš„çŽ¯èŠ‚ï¼Œå®ƒæž„å»ºäº†ç”¨æˆ·ä»Žå¤–éƒ¨æ•°æ®ã€æ•°æ®åº“åˆ° Databend çš„æ¡¥æ¢ã€‚èµ·åˆæˆ‘å¯¹äºŽä¸€äº›æµè¡Œçš„æ•°æ®åŒæ­¥å·¥å…·åªæ˜¯ç•¥æœ‰è€³é—»ï¼Œæœ‰äº›ç”šè‡³ä»Žæœªå¬è¯´è¿‡ï¼Œæ›´ä¸äº†è§£å®ƒä»¬çš„å†…éƒ¨åŽŸç†ã€‚é€šè¿‡ä¸€æ®µæ—¶é—´çš„æ‘¸ç´¢å’Œå¼€å‘ï¼ŒæˆåŠŸå®žçŽ°äº†å‡ ä¸ªå·¥å…·çš„æ•´åˆä¹‹åŽï¼Œæˆ‘å¯¹è¿™äº›å·¥å…·å’Œå¹³å°æœ‰äº†æ›´æ·±å…¥çš„äº†è§£ã€‚ æ‰€ä»¥åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘å°†å¯¹å‡ ä¸ªç›®å‰å¹¿æ³›ä½¿ç”¨ã€æ¯”è¾ƒæµè¡Œçš„æ•°æ®åŒæ­¥å·¥å…·è¿›è¡Œè€ƒå¤ã€‚è¿™åŒ…æ‹¬å®ƒä»¬çš„å‘å±•åŽ†å²ã€æŠ€æœ¯ç‰¹ç‚¹ä»¥åŠåœ¨å®žé™…åº”ç”¨ä¸­çš„ä½¿ç”¨æƒ…å†µã€‚é€šè¿‡å¯¹è¿™äº›å·¥å…·çš„åˆ†æžä»‹ç»ï¼Œåœ¨ç»™è‡ªå·±åšç¬”è®°çš„åŒæ—¶å¸Œæœ›èƒ½å¤Ÿä¸ºå…¶ä»–è¯»è€…æä¾›å¯¹æ•°æ®åŒæ­¥é¢†åŸŸçš„å…¨é¢è®¤è¯†ã€‚ æ•°æ®åŒæ­¥å·¥å…·Debezium1Debezium is an open source distributed platform for change data capture. Start it up, point it at your databases, and your apps can start responding to all of the inserts, updates, and deletes that other apps commit to your databases. Debezium is durable and fast, so your apps can respond quickly and never miss an event, even when things go wrong. Debezium æ˜¯ä¸€ç§ CDCï¼ˆChange Data Captureï¼‰å·¥å…·ï¼Œå·¥ä½œåŽŸç†ç±»ä¼¼å¤§å®¶æ‰€ç†ŸçŸ¥çš„ Canal, DataBus, Maxwell ç­‰ï¼Œæ˜¯é€šè¿‡æŠ½å–æ•°æ®åº“æ—¥å¿—æ¥èŽ·å–å˜æ›´äº‹ä»¶ã€‚Debezium æœ€åˆè®¾è®¡æˆä¸€ä¸ª Kafka Connect çš„ Source Pluginï¼Œç›®å‰å¼€å‘è€…è™½è‡´åŠ›äºŽå°†å…¶ä¸Ž Kafka Connect è§£è€¦ã€‚ä¸‹å›¾å¼•è‡ª Debeizum å®˜æ–¹æ–‡æ¡£ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ª Debezium åœ¨ä¸€ä¸ªå®Œæ•´ CDC ç³»ç»Ÿä¸­çš„ä½ç½®ã€‚ Kafka Connect ä¸º Source Plugin æä¾›äº†ä¸€ç³»åˆ—çš„ç¼–ç¨‹æŽ¥å£ï¼Œæœ€ä¸»è¦çš„å°±æ˜¯è¦å®žçŽ° SourceTask çš„ poll æ–¹æ³•ï¼Œå…¶è¿”å›ž List å°†ä¼šè¢«ä»¥æœ€å°‘ä¸€æ¬¡è¯­ä¹‰(At Least Once)çš„æ–¹å¼æŠ•é€’è‡³ Kafkaã€‚ Debezium æŠ½å–åŽŸç†ä¸‹å›¾æ˜¯ Debezium ä»Ž PG ä¸­æŠ½å–æ•°æ®åˆ° kafka topic çš„æµç¨‹ï¼Œå¯¹äºŽ PG è¿žæŽ¥å™¨æ¥è¯´æ˜¯ä»Žé€»è¾‘å¤åˆ¶æµè¯»å–åˆ°å˜æ›´æ—¥å¿—ï¼Œç»ç”± kafka å‘é€åˆ°ä¸‹æ¸¸çš„æ•°æ®å¤„ç†æœåŠ¡ä»¥åŠç›¸åº”çš„ writer pluginã€‚ å†æ¥çœ‹ä¸‹ Debezium MySQL Reader çš„ä»£ç ï¼ŒReaderä½“ç³»æž„æˆäº† MySQL æ¨¡å—ä¸­ä»£ç çš„ä¸»çº¿ã€‚ Reader çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š SnapshotReader å’Œ BinlogReader åˆ†åˆ«å®žçŽ°äº†å¯¹ MySQL æ•°æ®çš„å…¨é‡è¯»å–å’Œå¢žé‡è¯»å–ï¼Œä»–ä»¬ç»§æ‰¿äºŽ AbstractReaderï¼Œé‡Œé¢å°è£…äº†ä¸€äº›å…±ç”¨çš„é€»è¾‘ä»£ç ã€‚AbstractReader çš„æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä»Žå›¾ä¸­å¯ä»¥çœ‹åˆ° AbstractReader åœ¨å®žçŽ°æ—¶ï¼Œå¹¶æ²¡æœ‰ç›´æŽ¥å°† enqueue è¿›æ¥çš„ event record ç›´æŽ¥å†™åˆ° Kafkaï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ªå†…å­˜é˜»å¡žé˜Ÿåˆ—BlockingQueueè¿›è¡Œäº†è§£è€¦ï¼Œè¿™æ ·å†™çš„å¥½å¤„æ˜¯ï¼š èŒè´£è§£è€¦ Event Record åœ¨è¿›å…¥ BlockingQueueä¹‹å‰ï¼Œè¦æ ¹æ®æ¡ä»¶åˆ¤æ–­æ˜¯å¦æŽ¥å—è¯¥ recordï¼›åœ¨å‘ Kafka æŠ•é€’ record ä¹‹å‰ï¼Œåˆ¤æ–­ task çš„ running çŠ¶æ€ã€‚ çº¿ç¨‹éš”ç¦» BlockingQueue æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜»å¡žé˜Ÿåˆ—ï¼Œé€šè¿‡ BlockingQueue å®žçŽ°çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡åž‹ï¼Œæ˜¯å¯ä»¥è·‘åœ¨ä¸åŒçš„çº¿ç¨‹é‡Œçš„ï¼Œè¿™æ ·é¿å…å±€éƒ¨çš„é˜»å¡žå¸¦æ¥çš„æ•´ä½“çš„å¹²æ‰°ã€‚å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç³»ç»Ÿä¼šå®šæœŸåˆ¤æ–­ running æ ‡å¿—ä½ï¼Œè‹¥ running è¢«stopä¿¡å·ç½®ä¸ºäº†falseï¼Œå¯ä»¥ç«‹åˆ»åœæ­¢æ•´ä¸ªtask,è€Œä¸ä¼šå›  MySQL IO é˜»å¡žå»¶è¿Ÿå“åº”ã€‚ å•æ¡ä¸ŽBatchçš„äº’ç›¸è½¬åŒ– Enqueue record æ˜¯å•æ¡çš„æŠ•é€’ recordï¼Œdrain_to æ˜¯æ‰¹é‡çš„æ¶ˆè´¹ recordsã€‚è¿™ä¸ªç”¨æ³•ä¹Ÿå¯ä»¥åè¿‡æ¥ï¼Œå®žçŽ° batch åˆ° single çš„è½¬åŒ–ã€‚ è€Œ MySQL Connector æ¯æ—¥æ¬¡èŽ·å– snapshot çš„æ—¶å€™åŸºæœ¬ä¸Šæ˜¯æ²¿ç”¨äº† MySQL å®˜æ–¹ä»Žåº“æ­å»ºçš„æ–¹æ¡ˆï¼Œè¯¦ç»†æ­¥éª¤æ˜¯ï¼š èŽ·å–ä¸€ä¸ªå…¨å±€è¯»é”ï¼Œä»Žè€Œé˜»å¡žä½å…¶ä»–æ•°æ®åº“å®¢æˆ·ç«¯çš„å†™æ“ä½œã€‚ å¼€å¯ä¸€ä¸ªå¯é‡å¤è¯»è¯­ä¹‰çš„äº‹åŠ¡ï¼Œæ¥ä¿è¯åŽç»­çš„åœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…è¯»æ“ä½œéƒ½æ˜¯åœ¨ä¸€ä¸ªä¸€è‡´æ€§å¿«ç…§ä¸­å®Œæˆçš„ã€‚ è¯»å–binlogçš„å½“å‰ä½ç½®ã€‚ è¯»å–è¿žæŽ¥å™¨ä¸­é…ç½®çš„æ•°æ®åº“å’Œè¡¨çš„æ¨¡å¼ï¼ˆschemaï¼‰ä¿¡æ¯ã€‚ é‡Šæ”¾å…¨å±€è¯»é”ï¼Œå…è®¸å…¶ä»–çš„æ•°æ®åº“å®¢æˆ·ç«¯å¯¹æ•°æ®åº“è¿›è¡Œå†™æ“ä½œã€‚ ï¼ˆå¯é€‰ï¼‰æŠŠDDLæ”¹å˜äº‹ä»¶å†™å…¥æ¨¡å¼æ”¹å˜ topicï¼ˆschema change topicï¼‰ï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„å¿…è¦çš„DROPå’ŒCREATEDDLè¯­å¥ã€‚ æ‰«ææ‰€æœ‰æ•°æ®åº“çš„è¡¨ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸€ä¸ªè¡¨äº§ç”Ÿä¸€ä¸ªå’Œç‰¹å®šè¡¨ç›¸å…³çš„kafka topicåˆ›å»ºäº‹ä»¶ï¼ˆå³ä¸ºæ¯ä¸€ä¸ªè¡¨åˆ›å»ºä¸€ä¸ªkafka topicï¼‰ã€‚ æäº¤äº‹åŠ¡ã€‚ è®°å½•è¿žæŽ¥å™¨æˆåŠŸå®Œæˆå¿«ç…§ä»»åŠ¡æ—¶çš„è¿žæŽ¥å™¨åç§»é‡ã€‚ éƒ¨ç½²æ–¹å¼åŸºäºŽ Kafka Connectæœ€å¸¸è§çš„æž¶æž„æ˜¯é€šè¿‡ Apache Kafka Connect éƒ¨ç½² Debeziumã€‚Kafka Connect ä¸ºåœ¨ Kafka å’Œå¤–éƒ¨å­˜å‚¨ç³»ç»Ÿä¹‹é—´ç³»ç»Ÿæ•°æ®æä¾›äº†ä¸€ç§å¯é ä¸”å¯ä¼¸ç¼©æ€§çš„æ–¹å¼ã€‚å®ƒä¸º Connector æ’ä»¶æä¾›äº†ä¸€ç»„ API å’Œä¸€ä¸ªè¿è¡Œæ—¶ï¼šConnect è´Ÿè´£è¿è¡Œè¿™äº›æ’ä»¶ï¼Œå®ƒä»¬åˆ™è´Ÿè´£ç§»åŠ¨æ•°æ®ã€‚é€šè¿‡ Kafka Connect å¯ä»¥å¿«é€Ÿå®žçŽ° Source Connector å’Œ Sink Connector è¿›è¡Œäº¤äº’æž„é€ ä¸€ä¸ªä½Žå»¶è¿Ÿçš„æ•°æ® Pipelineï¼š Source Connectorï¼ˆä¾‹å¦‚ï¼ŒDebeziumï¼‰ï¼šå°†è®°å½•å‘é€åˆ° Kafka Sink Connectorï¼šå°† Kafka Topic ä¸­çš„è®°å½•å‘é€åˆ°å…¶ä»–ç³»ç»Ÿ å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œéƒ¨ç½²äº† MySQL å’Œ PostgresSQL çš„ Debezium Connector ä»¥æ•èŽ·è¿™ä¸¤ç§ç±»åž‹æ•°æ®åº“çš„å˜æ›´ã€‚æ¯ä¸ª Debezium Connector éƒ½ä¼šä¸Žå…¶æºæ•°æ®åº“å»ºç«‹è¿žæŽ¥ï¼š MySQL Connector ä½¿ç”¨å®¢æˆ·ç«¯åº“æ¥è®¿é—® binlogã€‚ PostgreSQL Connector ä»Žé€»è¾‘å‰¯æœ¬æµä¸­è¯»å–æ•°æ®ã€‚ é™¤äº† Kafka Broker ä¹‹å¤–ï¼ŒKafka Connect ä¹Ÿä½œä¸ºä¸€ä¸ªå•ç‹¬çš„æœåŠ¡è¿è¡Œã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ•°æ®åº“è¡¨çš„å˜æ›´ä¼šå†™å…¥åç§°ä¸Žè¡¨åç§°å¯¹åº”çš„ Kafka Topic ä¸­ã€‚å¦‚æžœéœ€è¦ï¼Œæ‚¨å¯ä»¥é€šè¿‡é…ç½® Debezium çš„ Topic è·¯ç”±è½¬æ¢æ¥è°ƒæ•´ç›®æ ‡ Topic åç§°ã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥ï¼š å°†è®°å½•è·¯ç”±åˆ°åç§°ä¸Žè¡¨åä¸åŒçš„ Topic ä¸­ å°†å¤šä¸ªè¡¨çš„å˜æ›´äº‹ä»¶è®°å½•æµå¼ä¼ è¾“åˆ°ä¸€ä¸ª Topic ä¸­ å˜æ›´äº‹ä»¶è®°å½•åœ¨ Apache Kafka ä¸­åŽï¼ŒKafka Connect ç”Ÿæ€ç³»ç»Ÿä¸­çš„ä¸åŒ Sink Connector å¯ä»¥å°†è®°å½•æµå¼ä¼ è¾“åˆ°å…¶ä»–ç³»ç»Ÿã€æ•°æ®åº“ï¼Œä¾‹å¦‚ Elasticsearchã€Databendã€åˆ†æžç³»ç»Ÿæˆ–è€…ç¼“å­˜ã€‚ åŸºäºŽDebezium Serverç¬¬äºŒç§éƒ¨ç½² Debezium çš„æ–¹æ³•æ˜¯ä½¿ç”¨ Debezium Serverã€‚Debezium Server æ˜¯ä¸€ä¸ªå¯é…ç½®çš„ã€éšæ—¶å¯ç”¨çš„åº”ç”¨ç¨‹åºï¼Œå¯ä»¥å°†å˜æ›´äº‹ä»¶ä»Žæºæ•°æ®åº“æµå¼ä¼ è¾“åˆ°å„ç§æ¶ˆæ¯ä¸­é—´ä»¶ä¸Šã€‚ ä¸‹å›¾å±•ç¤ºäº†åŸºäºŽ Debezium Server çš„å˜æ›´æ•°æ®æ•èŽ· Pipeline æž¶æž„ï¼š Debezium Server é…ç½®ä½¿ç”¨ Debezium Source Connector æ¥æ•èŽ·æºæ•°æ®åº“ä¸­çš„å˜æ›´ã€‚å˜æ›´äº‹ä»¶å¯ä»¥åºåˆ—åŒ–ä¸ºä¸åŒçš„æ ¼å¼ï¼Œä¾‹å¦‚ JSON æˆ– Apache Avroï¼Œç„¶åŽå‘é€åˆ°å„ç§æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œä¾‹å¦‚ Amazon Kinesisã€Apache Pulsarã€‚ åŸºäºŽ Debezium Engineä½¿ç”¨ Debezium Connector çš„å¦ä¸€ç§æ–¹æ³•æ˜¯åŸºäºŽ Debezium Engineã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDebezium ä¸ä¼šé€šè¿‡ Kafka Connect è¿è¡Œï¼Œè€Œæ˜¯ä½œä¸ºåµŒå…¥åˆ°ç”¨æˆ·è‡ªå®šä¹‰ Java åº”ç”¨ç¨‹åºä¸­çš„åº“è¿è¡Œã€‚è¿™å¯¹äºŽåœ¨åº”ç”¨ç¨‹åºæœ¬èº«èŽ·å–å˜æ›´äº‹ä»¶éžå¸¸æœ‰å¸®åŠ©ï¼Œæ— éœ€éƒ¨ç½²å®Œæ•´çš„ Kafka å’Œ Kafka Connect é›†ç¾¤ï¼Œä¹Ÿä¸ç”¨å°†å˜æ›´æµå¼ä¼ è¾“åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ä¸Šã€‚è¿™ç¯‡æ–‡ç« å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ Debezium Databend Server å®žçŽ°ä»Ž MySQL çš„æ•°æ®å…¨å¢žé‡åŒæ­¥ã€‚ ç‰¹æ€§æ€»ç»“Debezium æ˜¯ä¸€ç»„ç”¨äºŽ Apache Kafka Connect çš„ Source Connectorã€‚æ¯ä¸ª Connector éƒ½é€šè¿‡ä½¿ç”¨è¯¥æ•°æ®åº“çš„å˜æ›´æ•°æ®æ•èŽ· (CDC) åŠŸèƒ½ä»Žä¸åŒçš„æ•°æ®åº“ä¸­èŽ·å–å˜æ›´ã€‚ä¸Žå…¶ä»–æ–¹æ³•ï¼ˆä¾‹å¦‚è½®è¯¢æˆ–åŒé‡å†™å…¥ï¼‰ä¸åŒï¼ŒDebezium çš„å®žçŽ°åŸºäºŽæ—¥å¿—çš„ CDCï¼š ç¡®ä¿æ•èŽ·æ‰€æœ‰çš„æ•°æ®å˜æ›´ã€‚ ä»¥æžä½Žçš„å»¶è¿Ÿç”Ÿæˆå˜æ›´äº‹ä»¶ï¼ŒåŒæ—¶é¿å…å› ä¸ºé¢‘ç¹è½®è¯¢å¯¼è‡´ CPU ä½¿ç”¨çŽ‡å¢žåŠ ã€‚ä¾‹å¦‚ï¼Œå¯¹äºŽ MySQL æˆ– PostgreSQLï¼Œå»¶è¿Ÿåœ¨æ¯«ç§’èŒƒå›´å†…ã€‚ ä¸éœ€è¦æ›´æ”¹æ•°æ®æ¨¡åž‹ï¼Œä¾‹å¦‚å¢žåŠ  â€˜Last Updatedâ€™ åˆ—ã€‚ å¯ä»¥æ•èŽ·åˆ é™¤æ“ä½œã€‚ å¯ä»¥æ•èŽ·æ—§è®°å½•çŠ¶æ€ä»¥åŠå…¶ä»–å…ƒæ•°æ®ï¼Œä¾‹å¦‚ï¼Œäº‹åŠ¡ IDï¼Œå…·ä½“å–å†³äºŽæ•°æ®åº“çš„åŠŸèƒ½å’Œé…ç½®ã€‚ Flink CDCFlink CDC æ˜¯åŸºäºŽæ•°æ®åº“æ—¥å¿— CDCï¼ˆChange Data Captureï¼‰æŠ€æœ¯çš„å®žæ—¶æ•°æ®é›†æˆæ¡†æž¶ï¼Œæ”¯æŒäº†å…¨å¢žé‡ä¸€ä½“åŒ–ã€æ— é”è¯»å–ã€å¹¶è¡Œè¯»å–ã€è¡¨ç»“æž„å˜æ›´è‡ªåŠ¨åŒæ­¥ã€åˆ†å¸ƒå¼æž¶æž„ç­‰é«˜çº§ç‰¹æ€§ã€‚Flink CDC å‘å±•äº†ä¸‰å¹´å¤šçš„æ—¶é—´ã€‚2020 å¹´ï¼Œä»Žä½œä¸ºä¸ªäººçš„ Side project å‡ºå‘ï¼ŒåŽæ¥è¢«è¶Šæ¥è¶Šå¤šäººè®¤è¯†åˆ°ã€‚ Flink CDC è¿­ä»£åŽ†ç¨‹1.0Flink CDC 1.0 æ¯”ç®€å•ï¼Œç›´æŽ¥å°±æ˜¯åº•å±‚å°è£…äº† Debeziumï¼Œ è€Œ Debezium åŒæ­¥ä¸€å¼ è¡¨åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š å…¨é‡é˜¶æ®µï¼šæŸ¥è¯¢å½“å‰è¡¨ä¸­æ‰€æœ‰è®°å½•ï¼› å¢žé‡é˜¶æ®µï¼šä»Ž binlog æ¶ˆè´¹å˜æ›´æ•°æ®ã€‚ å¤§éƒ¨åˆ†ç”¨æˆ·ä½¿ç”¨çš„åœºæ™¯éƒ½æ˜¯å…¨é‡ + å¢žé‡åŒæ­¥ï¼ŒåŠ é”æ˜¯å‘ç”Ÿåœ¨å…¨é‡é˜¶æ®µï¼Œç›®çš„æ˜¯ä¸ºäº†ç¡®å®šå…¨é‡é˜¶æ®µçš„åˆå§‹ä½ç‚¹ï¼Œä¿è¯å¢žé‡ + å…¨é‡å®žçŽ°ä¸€æ¡ä¸å¤šï¼Œä¸€æ¡ä¸å°‘ï¼Œä»Žè€Œä¿è¯æ•°æ®ä¸€è‡´æ€§ã€‚ä»Žä¸‹å›¾ä¸­æˆ‘ä»¬å¯ä»¥åˆ†æžå…¨å±€é”å’Œè¡¨é”çš„ä¸€äº›åŠ é”æµç¨‹ï¼Œå·¦è¾¹çº¢è‰²çº¿æ¡æ˜¯é”çš„ç”Ÿå‘½å‘¨æœŸï¼Œå³è¾¹æ˜¯ MySQL å¼€å¯å¯é‡å¤è¯»äº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸã€‚ ä»¥å…¨å±€é”ä¸ºä¾‹ï¼Œé¦–å…ˆæ˜¯èŽ·å–ä¸€ä¸ªé”ï¼Œç„¶åŽå†åŽ»å¼€å¯å¯é‡å¤è¯»çš„äº‹åŠ¡ã€‚è¿™é‡Œé”ä½æ“ä½œæ˜¯è¯»å– binlog çš„èµ·å§‹ä½ç½®å’Œå½“å‰è¡¨çš„ schemaã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ä¿è¯ binlog çš„èµ·å§‹ä½ç½®å’Œè¯»å–åˆ°çš„å½“å‰ schema æ˜¯å¯ä»¥å¯¹åº”ä¸Šçš„ï¼Œå› ä¸ºè¡¨çš„ schema æ˜¯ä¼šæ”¹å˜çš„ï¼Œæ¯”å¦‚å¦‚åˆ é™¤åˆ—æˆ–è€…å¢žåŠ åˆ—ã€‚åœ¨è¯»å–è¿™ä¸¤ä¸ªä¿¡æ¯åŽï¼ŒSnapshotReader ä¼šåœ¨å¯é‡å¤è¯»äº‹åŠ¡é‡Œè¯»å–å…¨é‡æ•°æ®ï¼Œåœ¨å…¨é‡æ•°æ®è¯»å–å®ŒæˆåŽï¼Œä¼šå¯åŠ¨ BinlogReader ä»Žè¯»å–çš„ binlog èµ·å§‹ä½ç½®å¼€å§‹å¢žé‡è¯»å–ï¼Œä»Žè€Œä¿è¯å…¨é‡æ•°æ® + å¢žé‡æ•°æ®çš„æ— ç¼è¡”æŽ¥ã€‚ è¡¨é”æ˜¯å…¨å±€é”çš„é€€åŒ–ç‰ˆï¼Œå› ä¸ºå…¨å±€é”çš„æƒé™ä¼šæ¯”è¾ƒé«˜ï¼Œå› æ­¤åœ¨æŸäº›åœºæ™¯ï¼Œç”¨æˆ·åªæœ‰è¡¨é”ã€‚è¡¨é”é”çš„æ—¶é—´ä¼šæ›´é•¿ï¼Œå› ä¸ºè¡¨é”æœ‰ä¸ªç‰¹å¾ï¼šé”æå‰é‡Šæ”¾äº†å¯é‡å¤è¯»çš„äº‹åŠ¡é»˜è®¤ä¼šæäº¤ï¼Œæ‰€ä»¥é”éœ€è¦ç­‰åˆ°å…¨é‡æ•°æ®è¯»å®ŒåŽæ‰èƒ½é‡Šæ”¾ã€‚è€Œ FLUSH TABLE WITH READ LOCK çš„æ“ä½œä¼šå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š è¯¥å‘½ä»¤ç­‰å¾…æ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„ update å®Œæˆï¼ŒåŒæ—¶é˜»æ­¢æ‰€æœ‰æ–°æ¥çš„ update; æ‰§è¡ŒæˆåŠŸä¹‹å‰å¿…é¡»ç­‰å¾…æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ select å®Œæˆï¼Œç­‰å¾…æ‰§è¡Œçš„ update å°±ä¼šç­‰å¾…çš„æ›´ä¹…ã€‚ ä¼šé˜»æ­¢å…¶ä»–çš„äº‹åŠ¡ commitã€‚ æ‰€ä»¥å¯¹äºŽåŠ é”æ¥è¯´åœ¨æ—¶é—´ä¸Šæ˜¯ä¸ç¡®å®šçš„ï¼Œä¸¥é‡çš„å¯èƒ½ä¼š hang ä½æ•°æ®åº“ã€‚ å½“ç„¶ï¼ŒFlink CDC 1.x ç‰ˆæœ¬ä¹Ÿå¯ä»¥ä¸åŠ é”ï¼Œä½†æ˜¯ä¼šä¸¢å¤±ä¸€å®šçš„æ•°æ®å‡†ç¡®æ€§ã€‚æ€»çš„æ¥è¯´ 1.x å­˜åœ¨çš„é—®é¢˜æ˜¯ï¼š å…¨é‡ + å¢žé‡è¯»å–çš„è¿‡ç¨‹éœ€è¦ä¿è¯æ‰€æœ‰æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå› æ­¤éœ€è¦é€šè¿‡åŠ é”ä¿è¯ï¼Œä½†æ˜¯åŠ é”åœ¨æ•°æ®åº“å±‚é¢ä¸Šæ˜¯ä¸€ä¸ªååˆ†é«˜å±çš„æ“ä½œã€‚åº•å±‚ Debezium åœ¨ä¿è¯æ•°æ®ä¸€è‡´æ€§æ—¶ï¼Œéœ€è¦å¯¹è¯»å–çš„åº“æˆ–è¡¨åŠ é”ï¼Œå…¨å±€é”å¯èƒ½å¯¼è‡´æ•°æ®åº“é”ä½ï¼Œè¡¨çº§é”ä¼šé”ä½è¡¨çš„è¯»ï¼ŒDBA ä¸€èˆ¬ä¸ç»™é”æƒé™ã€‚ ä¸æ”¯æŒæ°´å¹³æ‰©å±•ï¼Œå› ä¸º Flink CDC åº•å±‚æ˜¯åŸºäºŽ Debeziumï¼Œèµ·æž¶æž„æ˜¯å•èŠ‚ç‚¹ï¼Œæ‰€ä»¥Flink CDC åªæ”¯æŒå•å¹¶å‘ã€‚åœ¨å…¨é‡é˜¶æ®µè¯»å–é˜¶æ®µï¼Œå¦‚æžœè¡¨éžå¸¸å¤§ (äº¿çº§åˆ«)ï¼Œè¯»å–æ—¶é—´åœ¨å°æ—¶ç”šè‡³å¤©çº§åˆ«ï¼Œç”¨æˆ·ä¸èƒ½é€šè¿‡å¢žåŠ èµ„æºåŽ»æå‡ä½œä¸šé€Ÿåº¦ã€‚ å…¨é‡è¯»å–é˜¶æ®µä¸æ”¯æŒ checkpointï¼šCDC è¯»å–åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå…¨é‡è¯»å–å’Œå¢žé‡è¯»å–ï¼Œç›®å‰å…¨é‡è¯»å–é˜¶æ®µæ˜¯ä¸æ”¯æŒ checkpoint çš„ï¼Œå› æ­¤ä¼šå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼šå½“æˆ‘ä»¬åŒæ­¥å…¨é‡æ•°æ®æ—¶ï¼Œå‡è®¾éœ€è¦ 5 ä¸ªå°æ—¶ï¼Œå½“æˆ‘ä»¬åŒæ­¥äº† 4 å°æ—¶çš„æ—¶å€™ä½œä¸šå¤±è´¥ï¼Œè¿™æ—¶å€™å°±éœ€è¦é‡æ–°å¼€å§‹ï¼Œå†è¯»å– 5 ä¸ªå°æ—¶ã€‚ 2.0äº†è§£äº† 1.0 çš„ç—›ç‚¹ä¹‹åŽï¼Œ2.0 ä¸»è¦è§£å†³çš„é—®é¢˜æœ‰ä¸‰ä¸ªï¼šæ”¯æŒæ— é”ã€æ°´å¹³æ‰©å±•ã€checkpointã€‚ Flink CDC 2.0 åœ¨å€Ÿé‰´äº† Netflix è¿™ç¯‡è®ºæ–‡ ä¹‹åŽå¯ä»¥åšåˆ°å…¨ç¨‹æ— é”å’Œå¹¶å‘è¯»å–ã€‚ 3.0 Flink CDC 3.0 æ‹¥æœ‰äº†æ›´å¤šæ•°æ®åŒæ­¥è¿‡ç¨‹ä¸­çš„å®žç”¨ç‰¹æ€§ï¼Œæˆä¸ºäº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„æ•°æ®é›†æˆæ¡†æž¶ï¼š ä¸Šæ¸¸ schema å˜æ›´è‡ªåŠ¨åŒæ­¥åˆ°ä¸‹æ¸¸ï¼Œå·²æœ‰ä½œä¸šæ”¯æŒåŠ¨æ€åŠ è¡¨ ç©ºé—²èµ„æºè‡ªåŠ¨å›žæ”¶ï¼Œä¸€ä¸ª sink å®žä¾‹æ”¯æŒå†™å…¥å¤šè¡¨ API è®¾è®¡ç›´æŽ¥é¢å‘æ•°æ®é›†æˆåœºæ™¯ï¼Œå¸®åŠ©ç”¨æˆ·è½»æ¾æž„å»ºåŒæ­¥ä½œä¸š Databend ä¹Ÿæä¾›äº† Flink-Databend-Connectorï¼Œè¿™ç¯‡æ–‡ç« å±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ databend connector å®žçŽ°ä»Ž MySQL çš„æ•°æ®åŒæ­¥ã€‚ Canalcanal [kÉ™â€™nÃ¦l]ï¼Œè¯‘æ„ä¸ºæ°´é“/ç®¡é“/æ²Ÿæ¸ ï¼Œä¸»è¦ç”¨é€”æ˜¯åŸºäºŽ MySQL æ•°æ®åº“å¢žé‡æ—¥å¿—è§£æžï¼Œæä¾›å¢žé‡æ•°æ®è®¢é˜…å’Œæ¶ˆè´¹ã€‚ æ—©æœŸé˜¿é‡Œå·´å·´å› ä¸ºæ­å·žå’Œç¾Žå›½åŒæœºæˆ¿éƒ¨ç½²ï¼Œå­˜åœ¨è·¨æœºæˆ¿åŒæ­¥çš„ä¸šåŠ¡éœ€æ±‚ï¼Œå®žçŽ°æ–¹å¼ä¸»è¦æ˜¯åŸºäºŽä¸šåŠ¡ trigger èŽ·å–å¢žé‡å˜æ›´ã€‚ä»Ž 2010 å¹´å¼€å§‹ï¼Œä¸šåŠ¡é€æ­¥å°è¯•æ•°æ®åº“æ—¥å¿—è§£æžèŽ·å–å¢žé‡å˜æ›´è¿›è¡ŒåŒæ­¥ï¼Œç”±æ­¤è¡ç”Ÿå‡ºäº†å¤§é‡çš„æ•°æ®åº“å¢žé‡è®¢é˜…å’Œæ¶ˆè´¹ä¸šåŠ¡ã€‚ åŸºäºŽæ—¥å¿—å¢žé‡è®¢é˜…å’Œæ¶ˆè´¹çš„ä¸šåŠ¡åŒ…æ‹¬ï¼š æ•°æ®åº“é•œåƒ æ•°æ®åº“å®žæ—¶å¤‡ä»½ ç´¢å¼•æž„å»ºå’Œå®žæ—¶ç»´æŠ¤(æ‹†åˆ†å¼‚æž„ç´¢å¼•ã€å€’æŽ’ç´¢å¼•ç­‰) ä¸šåŠ¡ cache åˆ·æ–° å¸¦ä¸šåŠ¡é€»è¾‘çš„å¢žé‡æ•°æ®å¤„ç† å½“å‰çš„canalæ”¯æŒæºç«¯MySQLç‰ˆæœ¬åŒ…æ‹¬ 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.xã€‚ canal å·¥ä½œåŽŸç† canal æ¨¡æ‹Ÿ MySQL slave çš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸ºMySQL slave,å‘MySQL masterå‘é€dumpåè®® MySQL masteræ”¶åˆ° dump è¯·æ±‚ï¼Œå¼€å§‹æŽ¨é€ binary log ç»™ slave (å³ canal ) canal è§£æž binary log å¯¹è±¡(åŽŸå§‹ä¸º byte æµ) BinlogèŽ·å–è¯¦è§£Binlogå‘é€æŽ¥æ”¶æµç¨‹ï¼Œæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤º: é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¼ªé€ ä¸€ä¸ªslaveï¼Œå‘masteræ³¨å†Œï¼Œè¿™æ ·masteræ‰ä¼šå‘é€binlog eventã€‚æ³¨å†Œå¾ˆç®€å•ï¼Œå°±æ˜¯å‘masterå‘é€COM_REGISTER_SLAVEå‘½ä»¤ï¼Œå¸¦ä¸Šslaveç›¸å…³ä¿¡æ¯ã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå› ä¸ºåœ¨MySQLçš„replication topologyä¸­ï¼Œéƒ½éœ€è¦ä½¿ç”¨ä¸€ä¸ªå”¯ä¸€çš„server idæ¥åŒºåˆ«æ ‡ç¤ºä¸åŒçš„serverå®žä¾‹ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬ä¼ªé€ çš„slaveä¹Ÿéœ€è¦ä¸€ä¸ªå”¯ä¸€çš„server idã€‚ æŽ¥ç€å®žçŽ°binlogçš„dumpã€‚MySQLåªæ”¯æŒä¸€ç§ binlog dumpæ–¹å¼ï¼Œä¹Ÿå°±æ˜¯æŒ‡å®šbinlog filename + positionï¼Œå‘masterå‘é€COM_BINLOG_DUMPå‘½ä»¤ã€‚åœ¨å‘é€dumpå‘½ä»¤çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šflagä¸ºBINLOG_DUMP_NON_BLOCKï¼Œè¿™æ ·masteråœ¨æ²¡æœ‰å¯å‘é€çš„binlog eventä¹‹åŽï¼Œå°±ä¼šè¿”å›žä¸€ä¸ªEOF packageã€‚ä¸è¿‡é€šå¸¸å¯¹äºŽslaveæ¥è¯´ï¼Œä¸€ç›´æŠŠè¿žæŽ¥æŒ‚ç€å¯èƒ½æ›´å¥½ï¼Œè¿™æ ·èƒ½æ›´åŠæ—¶æ”¶åˆ°æ–°äº§ç”Ÿçš„binlog eventã€‚ Canal æž¶æž„ serverä»£è¡¨ä¸€ä¸ªcanalè¿è¡Œå®žä¾‹ï¼Œå¯¹åº”äºŽä¸€ä¸ªjvmï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè¿›ç¨‹ instanceå¯¹åº”äºŽä¸€ä¸ªæ•°æ®é˜Ÿåˆ— ï¼ˆ1ä¸ªserverå¯¹åº”1..nä¸ªinstance)ï¼Œæ¯ä¸€ä¸ªæ•°æ®é˜Ÿåˆ—å¯ä»¥ç†è§£ä¸ºä¸€ä¸ªæ•°æ®åº“å®žä¾‹ã€‚ instanceä»£è¡¨äº†ä¸€ä¸ªå®žé™…è¿è¡Œçš„æ•°æ®é˜Ÿåˆ—ï¼ŒåŒ…æ‹¬äº†EventPaser,EventSink,EventStoreç­‰ç»„ä»¶ã€‚ æŠ½è±¡äº†CanalInstanceGeneratorï¼Œä¸»è¦æ˜¯è€ƒè™‘é…ç½®çš„ç®¡ç†æ–¹å¼ï¼š manageræ–¹å¼ï¼šå’Œä½ è‡ªå·±çš„å†…éƒ¨web console/managerç³»ç»Ÿè¿›è¡Œå¯¹æŽ¥ã€‚(ç›®å‰ä¸»è¦æ˜¯å…¬å¸å†…éƒ¨ä½¿ç”¨ï¼ŒOtteré‡‡ç”¨è¿™ç§æ–¹å¼) springæ–¹å¼ï¼šåŸºäºŽspring xml + propertiesè¿›è¡Œå®šä¹‰ï¼Œæž„å»ºspringé…ç½®. ä¸‹é¢æ˜¯ canalServer å’Œ instance ä»£ç ï¼š 12345678910111213141516171819202122232425262728293031323334canalServer.setCanalInstanceGenerator(new CanalInstanceGenerator() &#123; public CanalInstance generate(String destination) &#123; Canal canal = canalConfigClient.findCanal(destination); // æ­¤å¤„çœç•¥éƒ¨åˆ†ä»£ç  å¤§è‡´é€»è¾‘æ˜¯è®¾ç½®canalä¸€äº›å±žæ€§ CanalInstanceWithManager instance = new CanalInstanceWithManager(canal, filter) &#123; protected CanalHAController initHaController() &#123; HAMode haMode = parameters.getHaMode(); if (haMode.isMedia()) &#123; return new MediaHAController(parameters.getMediaGroup(), parameters.getDbUsername(), parameters.getDbPassword(), parameters.getDefaultDatabaseName()); &#125; else &#123; return super.initHaController(); &#125; &#125; protected void startEventParserInternal(CanalEventParser parser, boolean isGroup) &#123; //å¤§è‡´é€»è¾‘æ˜¯ è®¾ç½®æ”¯æŒçš„ç±»åž‹ //åˆå§‹åŒ–è®¾ç½®MysqlEventParserçš„ä¸»åº“ä¿¡æ¯ï¼Œè¿™å¤„æŠ½è±¡ä¸å¥½ï¼Œç›®å‰åªæ”¯æŒmysql &#125; &#125;; return instance; &#125; &#125;); canalServer.start(); //å¯åŠ¨canalServer canalServer.start(destination);//å¯åŠ¨å¯¹åº”instance this.clientIdentity = new ClientIdentity(destination, pipeline.getParameters().getMainstemClientId(), filter); canalServer.subscribe(clientIdentity);// å‘èµ·ä¸€æ¬¡è®¢é˜…ï¼Œå½“ç›‘å¬åˆ°instanceé…ç½®æ—¶ï¼Œè°ƒç”¨generateæ–¹æ³•æ³¨å…¥æ–°çš„instance instanceæ¨¡å—ï¼š eventParser (æ•°æ®æºæŽ¥å…¥ï¼Œæ¨¡æ‹Ÿslaveåè®®å’Œmasterè¿›è¡Œäº¤äº’ï¼Œåè®®è§£æž) eventSink (Parserå’ŒStoreé“¾æŽ¥å™¨ï¼Œè¿›è¡Œæ•°æ®è¿‡æ»¤ï¼ŒåŠ å·¥ï¼Œåˆ†å‘çš„å·¥ä½œ) eventStore (æ•°æ®å­˜å‚¨) metaManager (å¢žé‡è®¢é˜…&amp;æ¶ˆè´¹ä¿¡æ¯ç®¡ç†å™¨) åŸºäºŽ Canal çš„å®žçŽ°åŽŸç†æ¥çœ‹ï¼ŒCanal å¹¶ä¸æ”¯æŒå…¨é‡+å¢žé‡çš„åŒæ­¥æ¨¡å¼ã€‚ AirbyteAirbyte æ˜¯ä¸€ä¸ªæ¯”è¾ƒæ–°çš„æ•°æ®é›†æˆå¹³å°ï¼Œæä¾›äº†éžå¸¸å¤šçš„ connectorï¼Œå·ç§°æ”¯æŒä¸Šåƒç§æ•°æ®æºã€‚Databend ä¹Ÿæä¾›äº†Airbyte Destination Connectoï¼Œç”¨æˆ·å¯ä»¥ä»Ž Airbyte æ”¯æŒçš„ä¸Šç™¾ä¸ª source connector æ¯”å¦‚ mysql, es, pg ç­‰åŒæ­¥æ•°æ®åˆ° Databendã€‚ Airbyte çš„ä¼˜åŠ¿æ˜¯æ”¯æŒçš„æ•°æ®æºéžå¸¸å¤šï¼Œç”šè‡³åƒ Google Docs, Facebook éƒ½æ”¯æŒã€‚ Airbyte æ˜¯ ELT æ¨¡å¼ï¼Œå…ˆæŠ½å–æ•°æ®åˆ°ç›®æ ‡è¡¨åŽï¼Œå†è¿›è¡Œæ¸…æ´—ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿéžå¸¸æ˜Žæ˜¾ï¼ŒAirbyte æ˜¯ä¸€ä¸ªæ‰“åŒ…çš„å¹³å°ï¼Œæ‰€æœ‰çš„æ•°æ®æºéƒ½è¦è¢«é›†æˆåˆ°é‡Œé¢ï¼Œæ‰€ä»¥ä½¿ç”¨èµ·æ¥éžå¸¸åœ°é‡ã€‚å¹¶ä¸”Airbyte åŒæ­¥è¿‡æ¥çš„æ•°æ®æ˜¯ä¸€å¼ å¤§å®½è¡¨ï¼Œä¾èµ– dbt Normalization æˆ–è€…ä¸€äº› ELT å·¥ä½œæ‰èƒ½å¤Ÿè¡¨å±•å¼€ã€‚æ‰€ä»¥é€‚åˆçš„æ˜¯æ•°æ®æºå¤šï¼Œå¹¶ä¸”éœ€è¦ç»Ÿä¸€ç®¡ç†çš„åœºæ™¯ã€‚ DataXDataX æ˜¯é˜¿é‡Œå¼€æºçš„ä¸€ä¸ªå¼‚æž„æ•°æ®æºç¦»çº¿åŒæ­¥å·¥å…·ï¼Œèƒ½å¤Ÿå®žçŽ°åŒ…æ‹¬å…³ç³»åž‹æ•°æ®åº“(MySQLã€Oracleç­‰)ã€HDFSã€Hiveç­‰å„ç§å¼‚æž„æ•°æ®æºä¹‹é—´ç¨³å®šé«˜æ•ˆçš„æ•°æ®åŒæ­¥åŠŸèƒ½ã€‚DataX æœ¬èº«ä½œä¸ºæ•°æ®åŒæ­¥æ¡†æž¶ï¼Œå°†ä¸åŒæ•°æ®æºçš„åŒæ­¥, æŠ½è±¡ä¸ºä»Ž source ç«¯è¯»å–æ•°æ®çš„ Reader æ’ä»¶ï¼Œä»¥åŠå‘ç›®æ ‡ç«¯å†™å…¥æ•°æ®çš„Writeræ’ä»¶ï¼Œç†è®ºä¸ŠDataXæ¡†æž¶å¯ä»¥æ”¯æŒä»»æ„æ•°æ®æºçš„æ•°æ®åŒæ­¥å·¥ä½œã€‚ Databend æä¾›äº† Databend Writer çš„ Datax Plugin , å¯ä»¥æ”¯æŒä»Žä»»æ„å…·æœ‰ Datax Reader æ’ä»¶çš„æ•°æ®åº“åŒæ­¥æ•°æ®åˆ° Databendï¼Œå¹¶ä¸”æ”¯æŒå…¨é‡insert å’Œ upsert ä¸¤ç§åŒæ­¥æ¨¡å¼ã€‚Datax æœ€é€‚åˆçš„åœºæ™¯æ˜¯ T+1 çš„ç¦»çº¿æ•°æ®åŒæ­¥ã€‚ æ€»ç»“CDC çš„æŠ€æœ¯æ–¹æ¡ˆéžå¸¸å¤šï¼Œç›®å‰ä¸šç•Œä¸»æµçš„å®žçŽ°æœºåˆ¶å¯ä»¥åˆ†ä¸ºä¸¤ç§ï¼š åŸºäºŽæŸ¥è¯¢çš„ CDCï¼š ç¦»çº¿è°ƒåº¦æŸ¥è¯¢ä½œä¸šï¼Œæ‰¹å¤„ç†ã€‚æŠŠä¸€å¼ è¡¨åŒæ­¥åˆ°å…¶ä»–ç³»ç»Ÿï¼Œæ¯æ¬¡é€šè¿‡æŸ¥è¯¢åŽ»èŽ·å–è¡¨ä¸­æœ€æ–°çš„æ•°æ®ï¼› æ— æ³•ä¿éšœæ•°æ®ä¸€è‡´æ€§ï¼ŒæŸ¥çš„è¿‡ç¨‹ä¸­æœ‰å¯èƒ½æ•°æ®å·²ç»å‘ç”Ÿäº†å¤šæ¬¡å˜æ›´ï¼› ä¸ä¿éšœå®žæ—¶æ€§ï¼ŒåŸºäºŽç¦»çº¿è°ƒåº¦å­˜åœ¨å¤©ç„¶çš„å»¶è¿Ÿã€‚ åŸºäºŽæ—¥å¿—çš„ CDCï¼š å®žæ—¶æ¶ˆè´¹æ—¥å¿—ï¼Œæµå¤„ç†ï¼Œä¾‹å¦‚ MySQL çš„ binlog æ—¥å¿—å®Œæ•´è®°å½•äº†æ•°æ®åº“ä¸­çš„å˜æ›´ï¼Œå¯ä»¥æŠŠ binlog æ–‡ä»¶å½“ä½œæµçš„æ•°æ®æºï¼› ä¿éšœæ•°æ®ä¸€è‡´æ€§ï¼Œå› ä¸º binlog æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰åŽ†å²å˜æ›´æ˜Žç»†ï¼› ä¿éšœå®žæ—¶æ€§ï¼Œå› ä¸ºç±»ä¼¼ binlog çš„æ—¥å¿—æ–‡ä»¶æ˜¯å¯ä»¥æµå¼æ¶ˆè´¹çš„ï¼Œæä¾›çš„æ˜¯å®žæ—¶æ•°æ®ã€‚ å¯¹æ¯”å¸¸è§çš„å¼€æº CDC æ–¹æ¡ˆï¼Œæˆ‘ä»¬å¯ä»¥å‘çŽ°ï¼Œå¯¹æ¯”å¢žé‡åŒæ­¥èƒ½åŠ›: åŸºäºŽæ—¥å¿—çš„æ–¹å¼ï¼Œå¯ä»¥å¾ˆå¥½çš„åšåˆ°å¢žé‡åŒæ­¥ï¼› è€ŒåŸºäºŽæŸ¥è¯¢çš„æ–¹å¼æ˜¯å¾ˆéš¾åšåˆ°å¢žé‡åŒæ­¥çš„ã€‚ å¯¹æ¯”å…¨é‡åŒæ­¥èƒ½åŠ›ï¼ŒåŸºäºŽæŸ¥è¯¢æˆ–è€…æ—¥å¿—çš„ CDC æ–¹æ¡ˆåŸºæœ¬éƒ½æ”¯æŒï¼Œé™¤äº† Canalã€‚ è€Œå¯¹æ¯”å…¨é‡ + å¢žé‡åŒæ­¥çš„èƒ½åŠ›ï¼Œåªæœ‰ Flink CDCã€Debezium æ”¯æŒè¾ƒå¥½ã€‚ ä»Žæž¶æž„è§’åº¦åŽ»çœ‹ï¼Œè¯¥è¡¨å°†æž¶æž„åˆ†ä¸ºå•æœºå’Œåˆ†å¸ƒå¼ï¼Œè¿™é‡Œçš„åˆ†å¸ƒå¼æž¶æž„ä¸å•çº¯ä½“çŽ°åœ¨æ•°æ®è¯»å–èƒ½åŠ›çš„æ°´å¹³æ‰©å±•ä¸Šï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å¤§æ•°æ®åœºæ™¯ä¸‹åˆ†å¸ƒå¼ç³»ç»ŸæŽ¥å…¥èƒ½åŠ›ã€‚ä¾‹å¦‚ Flink CDC çš„æ•°æ®å…¥æ¹–æˆ–è€…å…¥ä»“çš„æ—¶å€™ï¼Œä¸‹æ¸¸é€šå¸¸æ˜¯åˆ†å¸ƒå¼çš„ç³»ç»Ÿï¼Œå¦‚ Hiveã€HDFSã€Icebergã€Hudi ç­‰ï¼Œé‚£ä¹ˆä»Žå¯¹æŽ¥å…¥åˆ†å¸ƒå¼ç³»ç»Ÿèƒ½åŠ›ä¸Šçœ‹ï¼ŒFlink CDC çš„æž¶æž„èƒ½å¤Ÿå¾ˆå¥½åœ°æŽ¥å…¥æ­¤ç±»ç³»ç»Ÿã€‚ åœ¨æ•°æ®è½¬æ¢ / æ•°æ®æ¸…æ´—èƒ½åŠ›ä¸Šï¼Œå½“æ•°æ®è¿›å…¥åˆ° CDC å·¥å…·çš„æ—¶å€™æ˜¯å¦èƒ½è¾ƒæ–¹ä¾¿çš„å¯¹æ•°æ®åšä¸€äº›è¿‡æ»¤æˆ–è€…æ¸…æ´— åœ¨ Flink CDC ä¸Šæ“ä½œå¾ˆç®€å•ï¼Œå¯ä»¥é€šè¿‡ Flink SQL åŽ»æ“ä½œï¼› ä½†æ˜¯åƒ DataXã€Debezium ç­‰åˆ™éœ€è¦é€šè¿‡è„šæœ¬æˆ–è€…æ¨¡æ¿åŽ»åšï¼Œæ‰€ä»¥ç”¨æˆ·çš„ä½¿ç”¨é—¨æ§›ä¼šæ¯”è¾ƒé«˜ã€‚ å¦å¤–ï¼Œåœ¨ç”Ÿæ€æ–¹é¢ï¼Œè¿™é‡ŒæŒ‡çš„æ˜¯ä¸‹æ¸¸çš„ä¸€äº›æ•°æ®åº“æˆ–è€…æ•°æ®æºçš„æ”¯æŒã€‚Flink CDC ä¸‹æ¸¸æœ‰ä¸°å¯Œçš„ Connectorï¼Œä¾‹å¦‚å†™å…¥åˆ° Databendã€MySQLã€Pgã€ClickHouse ç­‰å¸¸è§çš„ä¸€äº›ç³»ç»Ÿï¼Œä¹Ÿæ”¯æŒå„ç§è‡ªå®šä¹‰ connectorã€‚]]></content>
      <categories>
        <category>Databend</category>
      </categories>
      <tags>
        <tag>CDC</tag>
        <tag>Databend</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[databend debezium server support auto schema evolution]]></title>
    <url>%2F2024%2F01%2F25%2Fdatabend-debezium-server-support-auto-schema-evolution%2F</url>
    <content type="text"><![CDATA[èƒŒæ™¯Debezium Server Databend æ˜¯ä¸€ä¸ªåŸºäºŽ Debezium Engine è‡ªç ”çš„è½»é‡çº§ CDC é¡¹ç›®ï¼Œç”¨äºŽå®žæ—¶æ•èŽ·æ•°æ®åº“æ›´æ”¹å¹¶å°†å…¶ä½œä¸ºäº‹ä»¶æµä¼ é€’æœ€ç»ˆå°†æ•°æ®å†™å…¥ç›®æ ‡æ•°æ®åº“ Databendã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ç›‘è§†å’Œæ•èŽ·å…³ç³»åž‹æ•°æ®åº“çš„å˜åŒ–ï¼Œå¹¶æ”¯æŒå°†è¿™äº›å˜åŒ–è½¬æ¢ä¸ºå¯æ¶ˆè´¹äº‹ä»¶ã€‚ä½¿ç”¨ Debezium server databend å®žçŽ° CDC æ— é¡»ä¾èµ–å¤§åž‹çš„ Data Infra æ¯”å¦‚ Flink, Kafka, Spark ç­‰ï¼Œåªéœ€ä¸€ä¸ªå¯åŠ¨è„šæœ¬å³å¯å¼€å¯å®žæ—¶æ•°æ®åŒæ­¥ã€‚ CDC è¿‡ç¨‹ä¸­çš„ Schema å˜æ›´å¤„ç†æ˜¯ä¸Šæ¸¸æ•°æ®åº“ä¸­ååˆ†å¸¸è§çš„ç”¨æˆ·åœºæ™¯ï¼Œä¹Ÿæ˜¯æ•°æ®åŒæ­¥æ¡†æž¶å®žçŽ°çš„éš¾ç‚¹ã€‚é’ˆå¯¹è¯¥åœºæ™¯ï¼ŒDatabend-debezium-server 0.3.0 å¼•å…¥äº† Auto Schema Evolution çš„èƒ½åŠ›ï¼Œåœ¨æ¯ä¸€æ‰¹æ¬¡çš„æ•°æ®ä¸­åè°ƒå¹¶æŽ§åˆ¶ä½œä¸šæ‹“æ‰‘ä¸­çš„ schema å˜æ›´äº‹ä»¶å¤„ç†ã€‚ å®žçŽ°è¿‡ç¨‹Debezium Server Databend å®žçŽ° Schema Auto Evolution åŠŸèƒ½çš„åŽŸç†å¤§è‡´æ˜¯ï¼š åœ¨é…ç½®æ–‡ä»¶ä¸­æ–°å¢ž debezium.sink.databend.schema.evolution çš„é…ç½®ï¼Œé»˜è®¤ä¸º false ä¸å¼€å¯è¯¥åŠŸèƒ½ã€‚ å½“ä¸Šæ¸¸æ•°æ®æºå‘ç”Ÿ schema å˜æ›´æ—¶ï¼Œå…ˆå°†æµæ°´çº¿ä¸­å·²ç»è¯»å‡ºçš„çš„æ•°æ®å…¨éƒ¨åˆ·å‡ºä»¥ä¿è¯è¿›å…¥æ•°æ®æµçš„è¿™ä¸€æ‰¹ schema çš„ä¸€è‡´æ€§ï¼š ç„¶åŽå…ˆå°†è¯¥ç±» schemachangekey äº‹ä»¶æš‚å­˜åˆ° schemaEvolutionEvents çš„ ArrayList ä¸­ã€‚ 123456List&lt;DatabendChangeEvent&gt; schemaEvolutionEvents = new ArrayList&lt;&gt;(); for (DatabendChangeEvent event : events) &#123; if (DatabendUtil.isSchemaChanged(event.schema()) &amp;&amp; isSchemaEvolutionEnabled) &#123; schemaEvolutionEvents.add(event); &#125; &#125; å…ˆå°†ä¸Šé¢åˆ·å‡ºçš„æ•°æ®æ‰§è¡Œå†™å…¥æ“ä½œï¼Œå†™å…¥è¿™æ‰¹æ•°æ®ä¹‹åŽä¸”è§£æž schema å˜æ›´çš„äº‹ä»¶ä¹‹å‰çš„æ—¶é—´é‡Œä¸ä¼šæœ‰æ–°çš„æ•°æ®è¿›æ¥ã€‚æ•°æ®å¤„ç†å®ŒåŽå†åŽ»è§£æž schema change eventsï¼Œå¦‚æžœäº‹ä»¶ç±»åž‹å±žäºŽ DDL å¹¶ä¸”ä¸º alter table è¯­å¥ï¼Œå°±å¯¹ç›®æ ‡ database.table æ‰§è¡Œè¯¥ DDLã€‚ 123456// handle schema evolution try &#123; schemaEvolution(table, schemaEvolutionEvents); &#125; catch (Exception e) &#123; throw new RuntimeException(e.getMessage()); &#125; 1234567891011121314151617public void schemaEvolution(RelationalTable table, List&lt;DatabendChangeEvent&gt; events) &#123; for (DatabendChangeEvent event : events) &#123; Map&lt;String, Object&gt; values = event.valueAsMap(); for (Map.Entry&lt;String, Object&gt; entry : values.entrySet()) &#123; if (entry.getKey().contains("ddl") &amp;&amp; entry.getValue().toString().toLowerCase().contains("alter table")) &#123; String tableName = getFirstWordAfterAlterTable(entry.getValue().toString()); String ddlSql = replaceFirstWordAfterTable(entry.getValue().toString(), table.databaseName + "." + tableName); try (PreparedStatement statement = connection.prepareStatement(ddlSql)) &#123; System.out.println(ddlSql); statement.execute(ddlSql); &#125; catch (SQLException e) &#123; throw new RuntimeException(e.getMessage()); &#125; &#125; &#125; &#125; &#125; å½“ schema å˜æ›´äº‹ä»¶å¤„ç†æˆåŠŸåŽï¼Œä¼šç»§ç»­æ–°çš„æ•°æ®åŒæ­¥æµç¨‹ã€‚ åŸºæœ¬çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å®žè·µ&amp;æ¼”ç¤ºDebezium Server Databend Clone é¡¹ç›®: git clone `https://github.com/databendcloud/debezium-server-databend.git` ä»Žé¡¹ç›®æ ¹ç›®å½•å¼€å§‹: æž„å»ºå’Œæ‰“åŒ… debezium server: mvn -Passembly -Dmaven.test.skip package æž„å»ºå®ŒæˆåŽï¼Œè§£åŽ‹æœåŠ¡å™¨åˆ†å‘åŒ…: unzip debezium-server-databend-dist/target/debezium-server-databend-dist*.zip -d databendDist è¿›å…¥è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹: cd databendDist åˆ›å»º application.properties æ–‡ä»¶å¹¶ä¿®æ”¹: nano conf/application.propertiesï¼Œå°†ä¸‹é¢çš„ application.properties æ‹·è´è¿›åŽ»ï¼Œæ ¹æ®ç”¨æˆ·å®žé™…æƒ…å†µä¿®æ”¹ç›¸åº”çš„é…ç½®ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445debezium.sink.type=databenddebezium.sink.databend.upsert=truedebezium.sink.databend.upsert-keep-deletes=falsedebezium.sink.databend.database.databaseName=debeziumdebezium.sink.databend.database.url=jdbc:databend://tnf34b0rm--xxxxxx.default.databend.cn:443debezium.sink.databend.database.username=cloudappdebezium.sink.databend.database.password=passworddebezium.sink.databend.database.primaryKey=iddebezium.sink.databend.database.tableName=productsdebezium.sink.databend.database.param.ssl=truedebezium.sink.databend.schema.evolution=true // Enable Auto Schema Evolution# enable event schemasdebezium.format.value.schemas.enable=truedebezium.format.key.schemas.enable=truedebezium.format.value=jsondebezium.format.key=json# mysql sourcedebezium.source.connector.class=io.debezium.connector.mysql.MySqlConnectordebezium.source.offset.storage.file.filename=data/offsets.datdebezium.source.offset.flush.interval.ms=60000debezium.source.database.hostname=127.0.0.1debezium.source.database.port=3306debezium.source.database.user=rootdebezium.source.database.password=123456debezium.source.database.dbname=mydbdebezium.source.database.server.name=from_mysqldebezium.source.include.schema.changes=falsedebezium.source.table.include.list=mydb.products# debezium.source.database.ssl.mode=required# Run without Kafka, use local file to store checkpointsdebezium.source.database.history=io.debezium.relational.history.FileDatabaseHistorydebezium.source.database.history.file.filename=data/status.dat# do event flattening. unwrap message!debezium.transforms=unwrapdebezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordStatedebezium.transforms.unwrap.delete.handling.mode=rewritedebezium.transforms.unwrap.drop.tombstones=true# ############ SET LOG LEVELS ############quarkus.log.level=INFO# Ignore messages below warning level from Jetty, because it's a bit verbosequarkus.log.category."org.eclipse.jetty".level=WARN ä½¿ç”¨æä¾›çš„è„šæœ¬è¿è¡ŒæœåŠ¡: bash run.sh Debezium Server with Databend å°†ä¼šå¯åŠ¨ Mysql ä¸­å‡†å¤‡è¡¨å’Œæ•°æ®åˆ›å»ºæ•°æ®åº“ mydb å’Œè¡¨ productsï¼Œå¹¶æ’å…¥æ•°æ®: 12345678910111213141516CREATE DATABASE mydb;USE mydb;CREATE TABLE products (id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,name VARCHAR(255) NOT NULL,description VARCHAR(512));ALTER TABLE products AUTO_INCREMENT = 10;INSERT INTO products VALUES (default,"scooter","Small 2-wheel scooter"),(default,"car battery","12V car battery"),(default,"12-pack drill bits","12-pack of drill bits with sizes ranging from #40 to #3"),(default,"hammer","12oz carpenter's hammer"),(default,"hammer","14oz carpenter's hammer"),(default,"hammer","16oz carpenter's hammer"),(default,"rocks","box of assorted rocks"),(default,"jacket","water resistent black wind breaker"),(default,"cloud","test for databend"),(default,"spare tire","24 inch spare tire"); Databend Cloud ä¸­åˆ›å»º Database1create database debezium NOTE: ç”¨æˆ·å¯ä»¥ä¸å¿…å…ˆåœ¨ Databend ä¸­åˆ›å»ºè¡¨ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°åŽä¼šè‡ªåŠ¨ä¸ºç”¨æˆ·å»ºè¡¨ã€‚ å¯åŠ¨ Debezium Server Databend1bash run.sh é¦–æ¬¡å¯åŠ¨ä¼šè¿›å…¥ init snapshot æ¨¡å¼ï¼Œé€šè¿‡é…ç½®çš„ Batch Size å…¨é‡å°† MySQL ä¸­çš„æ•°æ®åŒæ­¥åˆ° Databendï¼Œæ‰€ä»¥åœ¨ Databend ä¸­å¯ä»¥çœ‹åˆ° MySQL ä¸­çš„æ•°æ®å·²ç»åŒæ­¥è¿‡æ¥äº†ï¼š æ”¹å˜ Mysql è¡¨ç»“æž„1alter table products add columm a int; åœ¨ products è¡¨ä¸­æ–°å¢žä¸€åˆ— a int åŒæ—¶åœ¨ Databend Cloud ä¸­ä¹Ÿå¯ä»¥çœ‹åˆ°ç›®æ ‡åŒæ­¥è¡¨çš„ç»“æž„ä¹Ÿéšä¹‹å˜æ›´äº†ï¼š æ­¤æ—¶åœ¨ mysql ä¸­æ’å…¥æ•°æ®ï¼Œæ–°çš„æ•°æ®å°±ä¼šä»¥æ–°çš„ Schema å½¢å¼å†™å…¥ç›®æ ‡è¡¨ï¼š ç»“è®ºDebezium Server Databend åœ¨æ”¯æŒ Auto Schema Evolution ä¹‹åŽï¼Œç”¨æˆ·æ— éœ€åœ¨æ•°æ®æºå‘ç”Ÿ schema å˜æ›´æ—¶æ‰‹åŠ¨ä»‹å…¥ï¼Œå¤§å¤§é™ä½Žç”¨æˆ·çš„è¿ç»´æˆæœ¬ï¼›åªéœ€å¯¹åŒæ­¥ä»»åŠ¡è¿›è¡Œç®€å•é…ç½®å³å¯å°†å¤šè¡¨ã€å¤šä¸ªæ•°æ®åº“åŒæ­¥è‡³ä¸‹æ¸¸ï¼Œæé«˜äº†æ•°æ®åŒæ­¥çš„æ•ˆçŽ‡å¹¶ä¸”é™ä½Žäº†ç”¨æˆ·çš„å¼€å‘éš¾åº¦ã€‚]]></content>
      <categories>
        <category>Databend</category>
      </categories>
      <tags>
        <tag>CDC</tag>
        <tag>databend</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[(æŒç»­æ›´æ–°)Databend SDK æŽ¥å…¥æœ€ä½³å®žè·µ&å¸¸è§é—®é¢˜]]></title>
    <url>%2F2024%2F01%2F06%2FDatabend-SDK-%E6%8E%A5%E5%85%A5%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5-%E5%B8%B8%E8%A7%81%E9%97%AE%E9%A2%98%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡æ¡£åŒ…å« Databend æ”¯æŒçš„æ‰€æœ‰ SDK æŽ¥å…¥çš„æœ€ä½³å®žè·µä»¥åŠåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºçŽ°çš„é—®é¢˜ä»¥åŠå¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚å¸Œæœ›å¯ä»¥æˆä¸ºç”¨æˆ·æŽ¥å…¥ Databend çš„ä¸€æŠŠé‡‘é’¥åŒ™ï¼Œæ‰“å¼€é€šå‘ Databend çš„å¤§é—¨ã€‚ Databend JDBC Github: https://github.com/datafuselabs/databend-jdbc å…¥é—¨ç¤ºä¾‹ï¼šhttps://github.com/datafuselabs/databend-jdbc/blob/main/databend-jdbc/src/main/java/com/databend/jdbc/examples/Examples.java åˆ›å»º JDBC Connection12345private Connection createConnection() throws SQLException &#123; String url = "jdbc:databend://localhost:8000"; return DriverManager.getConnection(url, "databend", "databend"); // user, password&#125; å»ºè¡¨12Connection c = createConnection();c.createStatement().execute("create table test_basic_driver.table1(i int)"); å•æ¡æ’å…¥æ•°æ®123Connection c = createConnection();c.createStatement().execute("create table test_basic_driver.table1(i int, j varchar)");c.createStatement().execute("insert into test_basic_driver.table1 values(1,'j')"); å•æ¡æ’å…¥æ— æ³•å‘æŒ¥ databend çš„æ€§èƒ½ï¼Œå†™å…¥æ€§èƒ½è¾ƒå·®ï¼Œåªèƒ½ä½œä¸ºæµ‹è¯•ä½¿ç”¨ã€‚æŽ¨èä½¿ç”¨æ‰¹é‡æ’å…¥ï¼ˆBatch Insertï¼‰ æ‰¹é‡æ’å…¥12345678910111213141516171819202122232425262728public void BatchInsert() throws SQLException &#123; Connection c = createConnection(); c.setAutoCommit(false); c.createStatement().execute("create table test_basic_driver.test_prepare_statement(i int, j varchar)"); PreparedStatement ps = c.prepareStatement("insert into test_prepare_statement values"); ps.setInt(1, 1); ps.setString(2, "a"); ps.addBatch(); ps.setInt(1, 2); ps.setString(2, "b"); ps.addBatch(); System.out.println("execute batch insert"); int[] ans = ps.executeBatch(); ps.close(); Statement statement = c.createStatement(); System.out.println("execute select"); statement.execute("SELECT * from test_prepare_statement"); ResultSet r = statement.getResultSet(); while (r.next()) &#123; System.out.println(r.getInt(1)); System.out.println(r.getString(2)); &#125; statement.close(); c.close();&#125; åœ¨å®žé™…ä½¿ç”¨ä¸­ï¼ŒæŽ¨èå¢žå¤§ Batch size åˆ° 10w~100w ä¹‹é—´ è¿žæŽ¥å‚æ•°https://github.com/datafuselabs/databend-jdbc/blob/main/docs/Connection.md å¸¸è§é—®é¢˜Q: Upload to stream failed æŠ¥é”™ A: æ£€æŸ¥ Client åˆ° OSS çš„ç½‘ç»œæƒ…å†µ Q: Spring boot ç­‰é¡¹ç›® Slf4j provider not found A: è¿™å¯èƒ½æ˜¯å¼•å…¥çš„ slf4j åŒ…äº§ç”Ÿäº†å†²çªï¼Œæ£€æŸ¥ pom ä¸­ slf4j ç‰ˆæœ¬æ˜¯å¦ä¸€è‡´ Q: å¦‚ä½•å°† NULL å†™å…¥è¡¨ A: ps.setNull(index, Types.NULL) Q: Spring boot JDBCTemplate getParameterType not implement A: getParameterType åœ¨ databend JDBC ä¸­ç›®å‰è¿˜æ²¡æœ‰å®žçŽ°ï¼Œå·²åœ¨å¼€å‘è®¡åˆ’ä¸­ Golang SDK Github: https://github.com/datafuselabs/databend-go åˆ›å»º sql.db client123456789101112import ("database/sql"_ "github.com/datafuselabs/databend-go")func main() &#123; db, err := sql.Open("databend", dsn) if err != nil &#123; return err &#125; db.Ping() db.Close()&#125; æ‰§è¡Œ SQL12345678910conn, err := sql.Open("databend", dsn)if err != nil &#123; fmt.Println(err) &#125;conn.Exec(`DROP TABLE IF EXISTS data`)_, err = conn.Exec(` CREATE TABLE IF NOT EXISTS data( Col1 TINYINT, Col2 VARCHAR )`)if err != nil &#123; fmt.Println(err) &#125;_, err = conn.Exec("INSERT INTO data VALUES (1, 'test-1')") æ‰¹é‡æ’å…¥12345678910111213141516171819202122func main() &#123; conn, err := sql.Open("databend", "http://databend:databend@localhost:8000/default?sslmode=disable") tx, err := conn.Begin() if err != nil &#123; fmt.Println(err) &#125; batch, err := tx.Prepare(fmt.Sprintf("INSERT INTO %s VALUES", "test")) for i := 0; i &lt; 10; i++ &#123; _, err = batch.Exec( "1234", "2345", "3.1415", "test", "test2", "[4, 5, 6]", "[1, 2, 3]", "2021-01-01", "2021-01-01 00:00:00", ) &#125; err = tx.Commit()&#125; è¯·æ±‚å•è¡Œ/å¤šè¡Œ (Querying Row/s)123456789101112131415func main() &#123; // create table data (col1 uint8, col2 string);// insert into data values(1,'col2');conn, err := sql.Open("databend", "http://databend:databend@localhost:8000/default?sslmode=disable") if err != nil &#123; fmt.Println(err) &#125; row := conn.QueryRow("SELECT * FROM data") var ( col1 uint8col2 string ) if err := row.Scan(&amp;col1, &amp;col2); err != nil &#123; fmt.Println(err) &#125; fmt.Println(col2)&#125; Python SDKdatabend-py Github: https://github.com/datafuselabs/databend-py åˆ›å»º client1c = Client.from_url("http://user:password@host:port/db?secure=false") Databend py DSN ä¸­æ”¯æŒçš„å‚æ•°å¯ä»¥å‚è€ƒï¼š https://github.com/datafuselabs/databend-py/blob/main/docs/connection.md å»ºè¡¨&amp;æŸ¥è¯¢12345c = Client.from_url(databend_url)c.execute('CREATE TABLE if not exists test (x Int32,y VARCHAR)')t, r = c.execute('INSERT INTO test VALUES', [(3, 'aa'),(4,'bb')],with_column_types=True)# execute è¿”å›žå€¼æœ‰ä¸¤ä¸ªï¼Œç¬¬ä¸€ä¸ªæ˜¯(column_name, column_type)ï¼š[('a', 'Int32'), ('b', 'String')], åªæœ‰å½“ with_column_types=True çš„æ—¶å€™æ‰è¿”å›žï¼Œé»˜è®¤ä¸º False;# ç¬¬äºŒä¸ªè¿”å›žå€¼æ˜¯æ•°æ®é›†ï¼š [(1, 'a'), (2, 'b')] æ‰¹é‡æ’å…¥12345678c = Client.from_url(databend_url)c.execute('DROP TABLE IF EXISTS test')c.execute('CREATE TABLE if not exists test (x Int32,y VARCHAR)')c.execute('DESC test')_, r1 = c.execute('INSERT INTO test VALUES', [(3, 'aa'), (4, 'bb')])assertEqual(r1, 2)_, ss = c.execute('select * from test')assertEqual(ss, [(3, 'aa'), (4, 'bb')]) Upload data to stagedatabend py å¯ä»¥ç›´æŽ¥å°† python slice æ•°æ®ä»¥ csv æ ¼å¼å¯¼å…¥åˆ° databend stage 1234from databend_py import Clientclient = Client.from_url(databend_url)stage_path = client.upload_to_stage('@~', "upload.csv", [(1, 'a'), (1, 'b')])# stage_path is @~/upload.csv Upload file to stageDatabend py ä¹Ÿå¯ä»¥ç›´æŽ¥å°†æ–‡ä»¶ä¸Šä¼ åˆ° stage 12345from databend_py import Clientclient = Client.from_url(self.databend_url)with open("upload.csv", "rb") as f: stage_path = client.upload_to_stage('@~', "upload.csv", f) print(stage_path) Databend sqlalchemy Githubï¼š https://github.com/datafuselabs/databend-sqlalchemy åˆ›å»º sqlalchemy connect å¹¶æŸ¥è¯¢123456789from sqlalchemy import create_engine, textfrom sqlalchemy.engine.base import Connection, Engineengine = create_engine( f"databend://&#123;username&#125;:&#123;password&#125;@&#123;host_port_name&#125;/&#123;database_name&#125;?sslmode=disable" )connection = engine.connect()result = connection.execute(text("SELECT 1"))print(result.fetchall()) databend-sqlalchemy åœ¨ç‰ˆæœ¬&lt;v0.4.0 ä½¿ç”¨[databend-py]ï¼ˆhttps://github.com/datafuselabs/databend-pyï¼‰æ—¶ä½œä¸ºå†…éƒ¨ Driverï¼Œ&gt;= v0.4.0 æ—¶ä½¿ç”¨ databend driver python bindingä½œä¸ºå†…éƒ¨é©±åŠ¨ç¨‹åºã€‚ä¸¤è€…ä¹‹é—´çš„å”¯ä¸€åŒºåˆ«æ˜¯ï¼ŒDSNä¸­æä¾›çš„è¿žæŽ¥å‚æ•°ä¸åŒã€‚ä½¿ç”¨ç›¸åº”çš„ç‰ˆæœ¬æ—¶åº”è¯¥å‚è€ƒç›¸åº”é©±åŠ¨ç¨‹åºæä¾›çš„è¿žæŽ¥å‚æ•°ã€‚ Bendsql GitHubï¼šhttps://github.com/datafuselabs/bendsql Exec1234567891011121314use databend_driver::Client;let dsn = "databend://root:@localhost:8000/default?sslmode=disable".to_string();let client = Client::new(dsn);let conn = client.get_conn().await.unwrap();let sql_create = "CREATE TABLE books ( title VARCHAR, author VARCHAR, date Date);";conn.exec(sql_create).await.unwrap();let sql_insert = "INSERT INTO books VALUES ('The Little Prince', 'Antoine de Saint-ExupÃ©ry', '1943-04-06');";conn.exec(sql_insert).await.unwrap(); è¯·æ±‚å•è¡Œæ•°æ®123let row = conn.query_row("SELECT * FROM books;").await.unwrap();let (title,author,date): (String,String,i32) = row.unwrap().try_into().unwrap();println!("&#123;&#125; &#123;&#125; &#123;&#125;", title, author, date); è¯·æ±‚å¤šè¡Œ12345let mut rows = conn.query_iter("SELECT * FROM books;").await.unwrap();while let Some(row) = rows.next().await &#123; let (title,author,date): (String,String,chrono::NaiveDate) = row.unwrap().try_into().unwrap(); println!("&#123;&#125; &#123;&#125; &#123;&#125;", title, author, date);&#125; DSN å‚æ•°å‚è€ƒï¼šhttps://github.com/datafuselabs/bendsql/blob/main/README.md#dsn]]></content>
      <categories>
        <category>Databend</category>
      </categories>
      <tags>
        <tag>Databend</tag>
        <tag>driver SDK</tag>
        <tag>ç”Ÿæ€</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»Ž AutoMQ Kafka å¯¼å‡ºæ•°æ®åˆ° Databend]]></title>
    <url>%2F2024%2F01%2F02%2F%E4%BB%8E-AutoMQ-Kafka-%E5%AF%BC%E5%87%BA%E6%95%B0%E6%8D%AE%E5%88%B0-Databend%2F</url>
    <content type="text"><![CDATA[Databendæ˜¯ä½¿ç”¨ Rust ç ”å‘ã€å¼€æºçš„ã€å®Œå…¨é¢å‘äº‘æž¶æž„ã€åŸºäºŽå¯¹è±¡å­˜å‚¨æž„å»ºçš„æ–°ä¸€ä»£äº‘åŽŸç”Ÿæ•°æ®ä»“åº“ï¼Œä¸ºä¼ä¸šæä¾›æ¹–ä»“ä¸€ä½“åŒ–ã€è®¡ç®—å’Œå­˜å‚¨åˆ†ç¦»çš„å¤§æ•°æ®åˆ†æžå¹³å°ã€‚ æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•é€šè¿‡ bend-ingest-kafka å°†æ•°æ®ä»Ž AutoMQ for Kafka å¯¼å…¥ Databendã€‚ æœ¬æ–‡ä¸­æåŠçš„ AutoMQ Kafka æœ¯è¯­ï¼Œå‡ç‰¹æŒ‡å®‰æ‰˜ç›Ÿä¸˜ï¼ˆæ­å·žï¼‰ç§‘æŠ€æœ‰é™å…¬å¸é€šè¿‡ GitHub AutoMQ ç»„ç»‡ä¸‹å¼€æºçš„ automq-for-kafka é¡¹ç›®ã€‚ çŽ¯å¢ƒå‡†å¤‡å‡†å¤‡ Databend Cloud ä»¥åŠæµ‹è¯•æ•°æ®é¦–å…ˆåˆ° Databend Cloud å¼€å¯ä½ çš„ Warehouse ï¼Œå¹¶åœ¨ worksheet ä¸­åˆ›å»ºæ•°æ®åº“åº“å’Œæµ‹è¯•è¡¨: 1234567create database automq_db;create table users ( id bigint NOT NULL, name string NOT NULL, ts timestamp, status string) å‡†å¤‡ AutoMQ Kafka çŽ¯å¢ƒå’Œæµ‹è¯•æ•°æ®å‚è€ƒ éƒ¨ç½² AutoMQ åˆ° AWSâ–¸ éƒ¨ç½²å¥½ AutoMQ Kafka é›†ç¾¤ï¼Œç¡®ä¿ AutoMQ Kafka ä¸Ž StarRocks ä¹‹é—´ä¿æŒç½‘ç»œè¿žé€šã€‚ åœ¨AutoMQ Kafkaä¸­å¿«é€Ÿåˆ›å»ºä¸€ä¸ªåä¸º example_topic çš„ä¸»é¢˜å¹¶å‘å…¶ä¸­å†™å…¥ä¸€æ¡æµ‹è¯• JSON æ•°æ®ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®žçŽ°ï¼š åˆ›å»ºTopic:ä½¿ç”¨ Apache Kafka å‘½ä»¤è¡Œå·¥å…·æ¥åˆ›å»ºä¸»é¢˜ã€‚ä½ éœ€è¦æœ‰ Kafka çŽ¯å¢ƒçš„è®¿é—®æƒé™ï¼Œå¹¶ä¸”ç¡®ä¿ Kafka æœåŠ¡æ­£åœ¨è¿è¡Œã€‚ä»¥ä¸‹æ˜¯åˆ›å»ºä¸»é¢˜çš„å‘½ä»¤ï¼š 1./kafka-topics.sh --create --topic exampleto_topic --bootstrap-server 10.0.96.4:9092 --partitions 1 --replication-factor 1 æ³¨æ„ï¼šæ‰§è¡Œå‘½ä»¤æ—¶ï¼Œéœ€è¦å°† topic å’Œ bootstarp-server æ›¿æ¢ä¸ºå®žé™…ä½¿ç”¨çš„ Kafka æœåŠ¡å™¨åœ°å€ã€‚ åˆ›å»º topic ä¹‹åŽå¯ä»¥ç”¨ä»¥ä¸‹å‘½ä»¤æ£€æŸ¥ topic åˆ›å»ºçš„ç»“æžœã€‚ 1./kafka-topics.sh --describe example_topic --bootstrap-server 10.0.96.4:9092 ç”Ÿæˆæµ‹è¯•æ•°æ®:ç”Ÿæˆä¸€æ¡ç®€å•çš„ JSON æ ¼å¼çš„æµ‹è¯•æ•°æ®ï¼Œå’Œå‰æ–‡çš„è¡¨éœ€è¦å¯¹åº”ã€‚ 123456&#123; "id":1, "name":"Test User", "ts":"2023-11-10T12:00:00", "status":"active"&#125; å†™å…¥æµ‹è¯•æ•°æ®ä½¿ç”¨ Kafka çš„å‘½ä»¤è¡Œå·¥å…·æˆ–è€…ç¼–ç¨‹æ–¹å¼å°†æµ‹è¯•æ•°æ®å†™å…¥åˆ° example_topicã€‚ä»¥ä¸‹æ˜¯ä½¿ç”¨å‘½ä»¤è¡Œå·¥å…·çš„ä¸€ä¸ªç¤ºä¾‹ï¼š 1echo '&#123;"id": 1, "name": "æµ‹è¯•ç”¨æˆ·", "ts": "2023-11-10T12:00:00", "status": "active"&#125;' | sh kafka-console-producer.sh --broker-list 10.0.96.4:9092 --topic example_topic ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥çœ‹åˆšå†™å…¥çš„ topic æ•°æ®ï¼š 1sh kafka-console-consumer.sh --bootstrap-server 10.0.96.4:9092 --topic example_topic --from-beginning åˆ›å»º bend-ingest-databend jobbend-ingest-kafka èƒ½å¤Ÿç›‘æŽ§ kafka å¹¶å°†æ•°æ®æ‰¹é‡å†™å…¥ Databend Tableã€‚ éƒ¨ç½² bend-ingest-kafka ä¹‹åŽï¼Œå³å¯å¼€å¯æ•°æ®å¯¼å…¥ jobã€‚ 1bend-ingest-kafka --kafka-bootstrap-servers="localhost:9094" --kafka-topic="example_topic" --kafka-consumer-group="Consumer Group" --databend-dsn="https://cloudapp:password@host:443" --databend-table="automq_db.users" --data-format="json" --batch-size=5 --batch-max-interval=30s æ³¨æ„ï¼šå°† kafka_broker_list æ›¿æ¢ä¸ºå®žé™…ä½¿ç”¨çš„ Kafka æœåŠ¡å™¨åœ°å€ã€‚ å‚æ•°è¯´æ˜Ždatabend-dsnDatabend Cloud æä¾›çš„è¿žæŽ¥åˆ° warehouse çš„ DSNï¼Œå¯ä»¥å‚è€ƒè¯¥æ–‡æ¡£ èŽ·å–ã€‚ batch-sizebend-ingest-kafka ä¼šç§¯æ”’åˆ° batch-size æ¡æ•°æ®å†è§¦å‘ä¸€æ¬¡æ•°æ®åŒæ­¥ã€‚ éªŒè¯æ•°æ®å¯¼å…¥åˆ° Databend Cloud worksheet ä¸­æŸ¥è¯¢ automq_db.users è¡¨ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®å·²ç»ä»Ž AutoMq åŒæ­¥åˆ° Databend Tableã€‚]]></content>
      <categories>
        <category>Databend</category>
      </categories>
      <tags>
        <tag>Databend</tag>
        <tag>kafka</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨ LF Edge eKuiper å°†ç‰©è”ç½‘æµå¤„ç†æ•°æ®å†™å…¥ Databend]]></title>
    <url>%2F2023%2F09%2F15%2F%E4%BD%BF%E7%94%A8-LF-Edge-eKuiper-%E5%B0%86%E7%89%A9%E8%81%94%E7%BD%91%E6%B5%81%E5%A4%84%E7%90%86%E6%95%B0%E6%8D%AE%E5%86%99%E5%85%A5-Databend%2F</url>
    <content type="text"><![CDATA[LF Edge eKuiper[LF Edge eKuiper(https://github.com/lf-edge/ekuiper) æ˜¯ Golang å®žçŽ°çš„è½»é‡çº§ç‰©è”ç½‘è¾¹ç¼˜åˆ†æžã€æµå¼å¤„ç†å¼€æºè½¯ä»¶ï¼Œå¯ä»¥è¿è¡Œåœ¨å„ç±»èµ„æºå—é™çš„è¾¹ç¼˜è®¾å¤‡ä¸Šã€‚eKuiper çš„ä¸»è¦ç›®æ ‡æ˜¯åœ¨è¾¹ç¼˜ç«¯æä¾›ä¸€ä¸ªæµåª’ä½“è½¯ä»¶æ¡†æž¶ï¼ˆç±»ä¼¼äºŽ Apache Flink (opens new window)ï¼‰ã€‚eKuiper çš„è§„åˆ™å¼•æ“Žå…è®¸ç”¨æˆ·æä¾›åŸºäºŽ SQL æˆ–åŸºäºŽå›¾å½¢ï¼ˆç±»ä¼¼äºŽ Node-REDï¼‰çš„è§„åˆ™ï¼Œåœ¨å‡ åˆ†é’Ÿå†…åˆ›å»ºç‰©è”ç½‘è¾¹ç¼˜åˆ†æžåº”ç”¨ã€‚å…·ä½“ä»‹ç»å¯ä»¥å‚è€ƒ LF Edge eKuiper - è¶…è½»é‡ç‰©è”ç½‘è¾¹ç¼˜æµå¤„ç†è½¯ä»¶ã€‚ Databend Sql SinkeKuiper æ”¯æŒé€šè¿‡ Golang æˆ–è€… Python åœ¨æº (Source)ï¼ŒSQL å‡½æ•°, ç›®æ ‡ (Sink) ä¸‰ä¸ªæ–¹é¢çš„æ‰©å±•ï¼Œé€šè¿‡æ”¯æŒä¸åŒçš„ Sinkï¼Œå…è®¸ç”¨æˆ·å°†åˆ†æžç»“æžœå‘é€åˆ°ä¸åŒçš„æ‰©å±•ç³»ç»Ÿä¸­ã€‚Databend ä½œä¸º Sink ä¹Ÿè¢«é›†æˆåˆ°äº† eKuiper plugin å½“ä¸­ï¼Œä¸‹é¢é€šè¿‡ä¸€ä¸ªæ¡ˆä¾‹æ¥å±•ç¤ºå¦‚ä½•ä½¿ç”¨ eKuiper å°†ç‰©è”ç½‘æµå¤„ç†æ•°æ®å†™å…¥ Databendã€‚ ç¼–è¯‘ ekuiper å’Œ Databend Sql PluginEkuiper12git clone https://github.com/lf-edge/ekuiper &amp; cd ekuipermake Databend Sql Plugin1go build -trimpath --buildmode=plugin -tags databend -o plugins/sinks/Sql.so extensions/sinks/sql/sql.go ç¼–è¯‘åŽçš„ sink plugin æ‹·è´åˆ° build ç›®å½•ï¼š 1cp plugins/sinks/Sql.so _build/kuiper-1.11.1-18-g42d9147f-darwin-arm64/plugins/sinks Databend å»ºè¡¨åœ¨ Databend ä¸­å…ˆåˆ›å»ºç›®æ ‡è¡¨ ekuiper_testï¼š 1create table ekuiper_test (name string,size bigint,id bigint); å¯åŠ¨ ekuiperd12cd _build/kuiper-1.11.1-18-g42d9147f-darwin-arm64 ./bin/kuiperd æœåŠ¡æ­£å¸¸å¯åŠ¨ï¼š åˆ›å»ºæµï¼ˆstreamï¼‰ å’Œ è§„åˆ™ (rule)Ekuiper æä¾›äº†ä¸¤ç§ç®¡ç†å„ç§æµã€è§„åˆ™ï¼Œç›®æ ‡ç«¯çš„æ–¹å¼ï¼Œä¸€ç§æ˜¯é€šè¿‡ ekuiper-manager çš„ docker imageï¼ˆhttps://hub.docker.com/r/lfedge/ekuiperï¼‰å¯åŠ¨å¯è§†åŒ–ç®¡ç†ç•Œé¢ï¼Œä¸€ç§æ˜¯é€šè¿‡ CLI å·¥å…·æ¥ç®¡ç†ã€‚è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ CLIã€‚ åˆ›å»º streamæµæ˜¯ eKuiper ä¸­æ•°æ®æºè¿žæŽ¥å™¨çš„è¿è¡Œå½¢å¼ã€‚å®ƒå¿…é¡»æŒ‡å®šä¸€ä¸ªæºç±»åž‹æ¥å®šä¹‰å¦‚ä½•è¿žæŽ¥åˆ°å¤–éƒ¨èµ„æºã€‚è¿™é‡Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµï¼Œä»Ž json æ–‡ä»¶æ•°æ®æºä¸­èŽ·å–æ•°æ®ï¼Œå¹¶å‘é€åˆ° ekuiper ä¸­ã€‚ é¦–å…ˆé…ç½®æ–‡ä»¶æ•°æ®æºï¼Œè¿žæŽ¥å™¨çš„é…ç½®æ–‡ä»¶ä½äºŽ /etc/sources/file.yamlã€‚ 1234567891011121314151617181920212223242526272829default: # æ–‡ä»¶çš„ç±»åž‹ï¼Œæ”¯æŒ jsonï¼Œ csv å’Œ lines fileType: json # æ–‡ä»¶ä»¥ eKuiper ä¸ºæ ¹ç›®å½•çš„ç›®å½•æˆ–æ–‡ä»¶çš„ç»å¯¹è·¯å¾„ã€‚ # è¯·å‹¿åœ¨æ­¤å¤„åŒ…å«æ–‡ä»¶åã€‚æ–‡ä»¶ååº”åœ¨æµæ•°æ®æºä¸­å®šä¹‰ path: data # è¯»å–æ–‡ä»¶çš„æ—¶é—´é—´éš”ï¼Œå•ä½ä¸ºmsã€‚å¦‚æžœåªè¯»å–ä¸€æ¬¡ï¼Œåˆ™å°†å…¶è®¾ç½®ä¸º 0 interval: 0 # è¯»å–åŽï¼Œä¸¤æ¡æ•°æ®å‘é€çš„é—´éš”æ—¶é—´ sendInterval: 0 # æ˜¯å¦å¹¶è¡Œè¯»å–ç›®å½•ä¸­çš„æ–‡ä»¶ parallel: false # æ–‡ä»¶è¯»å–åŽçš„æ“ä½œ # 0: æ–‡ä»¶ä¿æŒä¸å˜ # 1: åˆ é™¤æ–‡ä»¶ # 2: ç§»åŠ¨æ–‡ä»¶åˆ° moveTo å®šä¹‰çš„ä½ç½® actionAfterRead: 0 # ç§»åŠ¨æ–‡ä»¶çš„ä½ç½®, ä»…ç”¨äºŽ actionAfterRead ä¸º 2 çš„æƒ…å†µ moveTo: /tmp/kuiper/moved # æ˜¯å¦åŒ…å«æ–‡ä»¶å¤´ï¼Œå¤šç”¨äºŽ csvã€‚è‹¥ä¸º trueï¼Œåˆ™ç¬¬ä¸€è¡Œè§£æžä¸ºæ–‡ä»¶å¤´ã€‚ hasHeader: false # å®šä¹‰æ–‡ä»¶çš„åˆ—ã€‚å¦‚æžœå®šä¹‰äº†æ–‡ä»¶å¤´ï¼Œè¯¥é€‰é¡¹å°†è¢«è¦†ç›–ã€‚ # columns: [id, name] # å¿½ç•¥å¼€å¤´å¤šå°‘è¡Œçš„å†…å®¹ã€‚ ignoreStartLines: 0 # å¿½ç•¥ç»“å°¾å¤šå°‘è¡Œçš„å†…å®¹ã€‚æœ€åŽçš„ç©ºè¡Œä¸è®¡ç®—åœ¨å†…ã€‚ ignoreEndLines: 0 # ä½¿ç”¨æŒ‡å®šçš„åŽ‹ç¼©æ–¹æ³•è§£åŽ‹ç¼©æ–‡ä»¶ã€‚çŽ°åœ¨æ”¯æŒ`gzip`ã€`zstd` æ–¹æ³•ã€‚ decompression: "" ä½¿ç”¨ CLI åˆ›å»º steam åä¸º stream1: 1./bin/kuiper create stream stream1 '(id BIGINT, name STRING,size BIGINT) WITH (DATASOURCE="test.json", FORMAT="json", TYPE="file");' Json æ–‡ä»¶çš„å†…å®¹ä¸ºï¼š 123456[ &#123;"id": 1,"size":100, "name": "John Doe"&#125;, &#123;"id": 2,"size":200, "name": "Jane Smith"&#125;, &#123;"id": 3,"size":300, "name": "Kobe Brant"&#125;, &#123;"id": 4,"size":400, "name": "Alen Iverson"&#125;] åˆ›å»º Databend Sink Ruleä¸€ä¸ªè§„åˆ™ä»£è¡¨äº†ä¸€ä¸ªæµå¤„ç†æµç¨‹ï¼Œå®šä¹‰äº†ä»Žå°†æ•°æ®è¾“å…¥æµçš„æ•°æ®æºåˆ°å„ç§å¤„ç†é€»è¾‘ï¼Œå†åˆ°å°†æ•°æ®è¾“å…¥åˆ°å¤–éƒ¨ç³»ç»Ÿçš„åŠ¨ä½œã€‚ekuiper æœ‰ä¸¤ç§æ–¹æ³•æ¥å®šä¹‰è§„åˆ™çš„ä¸šåŠ¡é€»è¾‘ã€‚è¦ä¹ˆä½¿ç”¨SQL/åŠ¨ä½œç»„åˆï¼Œè¦ä¹ˆä½¿ç”¨æ–°å¢žåŠ çš„å›¾APIã€‚ è¿™é‡Œæˆ‘ä»¬é€šè¿‡æŒ‡å®š sql å’Œ actions å±žæ€§ï¼Œä»¥å£°æ˜Žçš„æ–¹å¼å®šä¹‰è§„åˆ™çš„ä¸šåŠ¡é€»è¾‘ã€‚å…¶ä¸­ï¼Œsql å®šä¹‰äº†é’ˆå¯¹é¢„å®šä¹‰æµè¿è¡Œçš„ SQL æŸ¥è¯¢ï¼Œè¿™å°†è½¬æ¢æ•°æ®ã€‚ç„¶åŽï¼Œè¾“å‡ºçš„æ•°æ®å¯ä»¥é€šè¿‡ action è·¯ç”±åˆ°å¤šä¸ªä½ç½®ã€‚ è§„åˆ™ç”± JSON å®šä¹‰ï¼Œä¸‹é¢æ˜¯å‡†å¤‡åˆ›å»ºçš„è§„åˆ™ myRule.jsonï¼š 123456789101112131415&#123; "id": "myRule", "sql": "SELECT id, name from stream1", "actions": [ &#123; "log": &#123; &#125;, "sql": &#123; "url": "databend://databend:databend@localhost:8000/default?sslmode=disable", "table": "ekuiper_test", "fields": ["id","name"] &#125; &#125; ]&#125; æ‰§è¡Œ CLI åˆ›å»ºè§„åˆ™ï¼š 1./bin/kuiper create rule myRule -f myRule.json å¯ä»¥æŸ¥çœ‹æ‰€åˆ›å»ºè§„åˆ™çš„è¿è¡ŒçŠ¶æ€ï¼š 1./bin/kuiper getstatus rule myRule è§„åˆ™åˆ›å»ºåŽï¼Œä¼šç«‹å³å°†ç¬¦åˆè§„åˆ™æ¡ä»¶çš„æ•°æ®å‘é€åˆ°ç›®æ ‡ç«¯ï¼Œæ­¤æ—¶æˆ‘ä»¬æŸ¥çœ‹ databend çš„ ekuiper_test è¡¨ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶æ•°æ®æºä¸­çš„æ•°æ®å·²ç»è¢«å†™å…¥åˆ° databendï¼š å¯ä»¥çœ‹åˆ°ç”±äºŽæˆ‘ä»¬çš„è§„åˆ™ SQL ä¸­åªæŒ‡å®šäº† id, name å­—æ®µï¼Œæ‰€ä»¥è¿™é‡Œåªæœ‰è¿™ä¸¤ä¸ªå­—æ®µè¢«å†™å…¥ã€‚ ç»“è®ºEkuiper æ˜¯ EMQ æ——ä¸‹çš„ä¸€æ¬¾æµå¤„ç†è½¯ä»¶ï¼Œå…¶ä½“ç§¯å°ã€åŠŸèƒ½å¼ºå¤§ï¼Œåœ¨å·¥ä¸šç‰©è”ç½‘ã€è½¦è¾†ç½‘ã€å…¬å…±æ•°æ®åˆ†æžç­‰å¾ˆå¤šåœºæ™¯ä¸­å¾—åˆ°å¹¿æ³›ä½¿ç”¨ã€‚æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ eKuiper å°†ç‰©è”ç½‘æµå¤„ç†æ•°æ®å†™å…¥ Databendã€‚]]></content>
      <categories>
        <category>Databend</category>
      </categories>
      <tags>
        <tag>Databend</tag>
        <tag>EMQ</tag>
        <tag>stream data</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[databend kafka connect æž„å»ºå®žæ—¶æ•°æ®åŒæ­¥]]></title>
    <url>%2F2023%2F09%2F08%2Fdatabend-kafka-connect-%E6%9E%84%E5%BB%BA%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5%2F</url>
    <content type="text"><![CDATA[kafka connect ä»‹ç»Kafka Connect æ˜¯ä¸€ä¸ªç”¨äºŽåœ¨Apache KafkaÂ®å’Œå…¶ä»–æ•°æ®ç³»ç»Ÿä¹‹é—´å¯æ‰©å±•ä¸”å¯é åœ°æµå¼ä¼ è¾“æ•°æ®çš„å·¥å…·ã€‚é€šè¿‡å°†æ•°æ®ç§»å…¥å’Œç§»å‡º Kafka è¿›è¡Œæ ‡å‡†åŒ–ï¼Œä½¿å¾—å¿«é€Ÿå®šä¹‰è¿žæŽ¥å™¨ä»¥åœ¨ Kafka ä¸­ä¼ è¾“å¤§åž‹æ•°æ®é›†å˜å¾—ç®€å•ï¼Œå¯ä»¥æ›´è½»æ¾åœ°æž„å»ºå¤§è§„æ¨¡çš„å®žæ—¶æ•°æ®ç®¡é“ã€‚æˆ‘ä»¬ä½¿ç”¨ Kafka Connector è¯»å–æˆ–å†™å…¥å¤–éƒ¨ç³»ç»Ÿã€ç®¡ç†æ•°æ®æµä»¥åŠæ‰©å±•ç³»ç»Ÿï¼Œæ‰€æœ‰è¿™äº›éƒ½æ— éœ€å¼€å‘æ–°ä»£ç ã€‚Kafka Connect ç®¡ç†ä¸Žå…¶ä»–ç³»ç»Ÿè¿žæŽ¥æ—¶çš„æ‰€æœ‰å¸¸è§é—®é¢˜ï¼ˆSchema ç®¡ç†ã€å®¹é”™ã€å¹¶è¡Œæ€§ã€å»¶è¿Ÿã€æŠ•é€’è¯­ä¹‰ç­‰ï¼‰ï¼Œæ¯ä¸ª Connector åªå…³æ³¨å¦‚ä½•åœ¨ç›®æ ‡ç³»ç»Ÿå’Œ Kafka ä¹‹é—´å¤åˆ¶æ•°æ®ã€‚ Kafka è¿žæŽ¥å™¨é€šå¸¸ç”¨æ¥æž„å»º data pipelineï¼Œä¸€èˆ¬æœ‰ä¸¤ç§ä½¿ç”¨åœºæ™¯ï¼š å¼€å§‹å’Œç»“æŸçš„ç«¯ç‚¹ï¼šä¾‹å¦‚ï¼Œå°† Kafka ä¸­çš„æ•°æ®å¯¼å‡ºåˆ° Databend æ•°æ®åº“ï¼Œæˆ–è€…æŠŠ Mysql æ•°æ®åº“ä¸­çš„æ•°æ®å¯¼å…¥ Kafka ä¸­ã€‚æ•°æ®ä¼ è¾“çš„ä¸­é—´ä»‹è´¨ï¼šä¾‹å¦‚ï¼Œä¸ºäº†æŠŠæµ·é‡çš„æ—¥å¿—æ•°æ®å­˜å‚¨åˆ° Elasticsearch ä¸­ï¼Œå¯ä»¥å…ˆæŠŠè¿™äº›æ—¥å¿—æ•°æ®ä¼ è¾“åˆ° Kafka ä¸­ï¼Œç„¶åŽå†ä»Ž Kafka ä¸­å°†è¿™äº›æ•°æ®å¯¼å…¥åˆ° Elasticsearch ä¸­è¿›è¡Œå­˜å‚¨ã€‚Kafka è¿žæŽ¥å™¨å¯ä»¥ä½œä¸ºæ•°æ®ç®¡é“å„ä¸ªé˜¶æ®µçš„ç¼“å†²åŒºï¼Œå°†æ¶ˆè´¹è€…ç¨‹åºå’Œç”Ÿäº§è€…ç¨‹åºæœ‰æ•ˆåœ°è¿›è¡Œè§£è€¦ã€‚ Kafka connect åˆ†ä¸ºä¸¤ç§ï¼š Source connectï¼šè´Ÿè´£å°†æ•°æ®å¯¼å…¥ Kafkaã€‚Sink connectï¼šè´Ÿè´£å°†æ•°æ®ä»Ž Kafka ç³»ç»Ÿä¸­å¯¼å‡ºåˆ°ç›®æ ‡è¡¨ã€‚ Databend Kafka ConnectKafka ç›®å‰åœ¨ Confluent Hub ä¸Šæä¾›äº†ä¸Šç™¾ç§ connectorï¼Œæ¯”å¦‚ Elasticsearch Service Sink Connector, Amazon Sink Connector, HDFS Sink ç­‰ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨è¿™äº› connector ä»¥ kafka ä¸ºä¸­å¿ƒæž„å»ºä»»æ„ç³»ç»Ÿä¹‹é—´çš„æ•°æ®ç®¡é“ã€‚çŽ°åœ¨æˆ‘ä»¬ä¹Ÿä¸º Databend æä¾›äº† kafka connect sink pluginï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬å°†ä¼šä»‹ç»å¦‚ä½•ä½¿ç”¨ MySQL JDBC Source Connector å’Œ [Databend Sink Connector] æž„å»ºå®žæ—¶çš„æ•°æ®åŒæ­¥ç®¡é“ã€‚ å¯åŠ¨ Kafka Connectæœ¬æ–‡å‡å®šæ“ä½œçš„æœºå™¨ä¸Šå·²ç»å®‰è£… Apache Kafkaï¼Œå¦‚æžœç”¨æˆ·è¿˜æ²¡æœ‰å®‰è£…ï¼Œå¯ä»¥å‚è€ƒ Kafka quickstart è¿›è¡Œå®‰è£…ã€‚ Kafka Connect ç›®å‰æ”¯æŒä¸¤ç§æ‰§è¡Œæ¨¡å¼ï¼šStandalone æ¨¡å¼å’Œåˆ†å¸ƒå¼æ¨¡å¼ã€‚ å¯åŠ¨æ¨¡å¼Standalone æ¨¡å¼åœ¨ Standalone æ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰çš„å·¥ä½œéƒ½åœ¨å•ä¸ªè¿›ç¨‹ä¸­å®Œæˆã€‚è¿™ç§æ¨¡å¼æ›´å®¹æ˜“é…ç½®ä»¥åŠå…¥é—¨ï¼Œä½†ä¸èƒ½å……åˆ†åˆ©ç”¨ Kafka Connect çš„æŸäº›é‡è¦åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼Œå®¹é”™ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ Standalone è¿›ç¨‹ï¼š 1bin/connect-standalone.sh config/connect-standalone.properties connector1.properties [connector2.properties ...] ç¬¬ä¸€ä¸ªå‚æ•° config/connect-standalone.properties æ˜¯ worker çš„é…ç½®ã€‚è¿™å…¶ä¸­åŒ…æ‹¬ Kafka è¿žæŽ¥å‚æ•°ã€åºåˆ—åŒ–æ ¼å¼ä»¥åŠæäº¤ Offset çš„é¢‘çŽ‡ç­‰é…ç½®ï¼š 12345bootstrap.servers=localhost:9092key.converter.schemas.enable=truevalue.converter.schemas.enable=trueoffset.storage.file.filename=/tmp/connect.offsetsoffset.flush.interval.ms=10000 åŽé¢çš„é…ç½®æ˜¯æŒ‡å®šè¦å¯åŠ¨çš„ connector çš„å‚æ•°ã€‚ ä¸Šè¿°æä¾›çš„é»˜è®¤é…ç½®é€‚ç”¨äºŽä½¿ç”¨ config/server.properties æä¾›çš„é»˜è®¤é…ç½®è¿è¡Œçš„æœ¬åœ°é›†ç¾¤ã€‚å¦‚æžœä½¿ç”¨ä¸åŒé…ç½®æˆ–è€…åœ¨ç”Ÿäº§éƒ¨ç½²ï¼Œé‚£å°±éœ€è¦å¯¹é»˜è®¤é…ç½®åšè°ƒæ•´ã€‚ä½†æ— è®ºæ€Žæ ·ï¼Œæ‰€æœ‰ Workerï¼ˆç‹¬ç«‹çš„å’Œåˆ†å¸ƒå¼çš„ï¼‰éƒ½éœ€è¦ä¸€äº›é…ç½®ï¼š bootstrap.serversï¼šè¯¥å‚æ•°åˆ—å‡ºäº†å°†è¦ä¸Ž Connect ååŒå·¥ä½œçš„ broker æœåŠ¡å™¨ï¼ŒConnector å°†ä¼šå‘è¿™äº› broker å†™å…¥æ•°æ®æˆ–è€…ä»Žå®ƒä»¬é‚£é‡Œè¯»å–æ•°æ®ã€‚ä½ ä¸éœ€è¦æŒ‡å®šé›†ç¾¤çš„æ‰€æœ‰ brokerï¼Œä½†æ˜¯å»ºè®®è‡³å°‘æŒ‡å®š3ä¸ªã€‚ key.converter å’Œ value.converterï¼šåˆ†åˆ«æŒ‡å®šäº†æ¶ˆæ¯é”®å’Œæ¶ˆæ¯å€¼æ‰€ä½¿ç”¨çš„çš„è½¬æ¢å™¨ï¼Œç”¨äºŽåœ¨ Kafka Connect æ ¼å¼å’Œå†™å…¥ Kafka çš„åºåˆ—åŒ–æ ¼å¼ä¹‹é—´è¿›è¡Œè½¬æ¢ã€‚è¿™æŽ§åˆ¶äº†å†™å…¥ Kafka æˆ–ä»Ž Kafka è¯»å–çš„æ¶ˆæ¯ä¸­é”®å’Œå€¼çš„æ ¼å¼ã€‚ç”±äºŽè¿™ä¸Ž Connector æ²¡æœ‰ä»»ä½•å…³ç³»ï¼Œå› æ­¤ä»»ä½• Connector å¯ä»¥ä¸Žä»»ä½•åºåˆ—åŒ–æ ¼å¼ä¸€èµ·ä½¿ç”¨ã€‚é»˜è®¤ä½¿ç”¨ Kafka æä¾›çš„ JSONConverterã€‚æœ‰äº›è½¬æ¢å™¨è¿˜åŒ…å«äº†ç‰¹å®šçš„é…ç½®å‚æ•°ã€‚ä¾‹å¦‚ï¼Œé€šè¿‡å°† key.converter.schemas.enable è®¾ç½®æˆ true æˆ–è€… false æ¥æŒ‡å®š JSON æ¶ˆæ¯æ˜¯å¦åŒ…å« schemaã€‚ offset.storage.file.filenameï¼šç”¨äºŽå­˜å‚¨ Offset æ•°æ®çš„æ–‡ä»¶ã€‚ è¿™äº›é…ç½®å‚æ•°å¯ä»¥è®© Kafka Connect çš„ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è®¿é—®é…ç½®ã€Offset å’ŒçŠ¶æ€ Topicã€‚é…ç½® Kafka Source ä»»åŠ¡ä½¿ç”¨çš„ç”Ÿäº§è€…å’Œ Kafka Sink ä»»åŠ¡ä½¿ç”¨çš„æ¶ˆè´¹è€…ï¼Œå¯ä»¥ä½¿ç”¨ç›¸åŒçš„å‚æ•°ï¼Œä½†éœ€è¦åˆ†åˆ«åŠ ä¸Š â€˜producer.â€™ å’Œ â€˜consumer.â€™ å‰ç¼€ã€‚bootstrap.servers æ˜¯å”¯ä¸€ä¸éœ€è¦æ·»åŠ å‰ç¼€çš„ Kafka å®¢æˆ·ç«¯å‚æ•°ã€‚ distributed æ¨¡å¼åˆ†å¸ƒå¼æ¨¡å¼å¯ä»¥è‡ªåŠ¨å¹³è¡¡å·¥ä½œè´Ÿè½½ï¼Œå¹¶å¯ä»¥åŠ¨æ€æ‰©å±•ï¼ˆæˆ–ç¼©å‡ï¼‰ä»¥åŠæä¾›å®¹é”™ã€‚åˆ†å¸ƒå¼æ¨¡å¼çš„æ‰§è¡Œä¸Ž Standalone æ¨¡å¼éžå¸¸ç›¸ä¼¼ï¼š 1bin/connect-distributed.sh config/connect-distributed.properties ä¸åŒä¹‹å¤„åœ¨äºŽå¯åŠ¨çš„è„šæœ¬ä»¥åŠé…ç½®å‚æ•°ã€‚åœ¨åˆ†å¸ƒå¼æ¨¡å¼ä¸‹ï¼Œä½¿ç”¨ connect-distributed.sh æ¥ä»£æ›¿ connect-standalone.shã€‚ç¬¬ä¸€ä¸ª worker é…ç½®å‚æ•°ä½¿ç”¨çš„æ˜¯ config/connect-distributed.properties é…ç½®æ–‡ä»¶ï¼š 12345678910111213bootstrap.servers=localhost:9092group.id=connect-clusterkey.converter.schemas.enable=truevalue.converter.schemas.enable=trueoffset.storage.topic=connect-offsetsoffset.storage.replication.factor=1#offset.storage.partitions=25config.storage.topic=connect-configsconfig.storage.replication.factor=1status.storage.topic=connect-statusstatus.storage.replication.factor=1#status.storage.partitions=5offset.flush.interval.ms=10000 Kafka Connect å°† Offsetã€é…ç½®ä»¥åŠä»»åŠ¡çŠ¶æ€å­˜å‚¨åœ¨ Kafka Topic ä¸­ã€‚å»ºè®®æ‰‹åŠ¨åˆ›å»º Offsetã€é…ç½®å’ŒçŠ¶æ€çš„ Topicï¼Œä»¥è¾¾åˆ°æ‰€éœ€çš„åˆ†åŒºæ•°å’Œå¤åˆ¶å› å­ã€‚å¦‚æžœåœ¨å¯åŠ¨ Kafka Connect æ—¶å°šæœªåˆ›å»º Topicï¼Œå°†ä½¿ç”¨é»˜è®¤åˆ†åŒºæ•°å’Œå¤åˆ¶å› å­æ¥è‡ªåŠ¨åˆ›å»º Topicï¼Œè¿™å¯èƒ½ä¸é€‚åˆæˆ‘ä»¬çš„åº”ç”¨ã€‚åœ¨å¯åŠ¨é›†ç¾¤ä¹‹å‰é…ç½®å¦‚ä¸‹å‚æ•°è‡³å…³é‡è¦ï¼š group.idï¼šConnect é›†ç¾¤çš„å”¯ä¸€åç§°ï¼Œé»˜è®¤ä¸º connect-clusterã€‚å…·æœ‰ç›¸åŒ group id çš„ worker å±žäºŽåŒä¸€ä¸ª Connect é›†ç¾¤ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ä¸èƒ½ä¸Žæ¶ˆè´¹è€…ç»„ ID å†²çªã€‚ config.storage.topicï¼šç”¨äºŽå­˜å‚¨ Connector å’Œä»»åŠ¡é…ç½®çš„ Topicï¼Œé»˜è®¤ä¸º connect-configsã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™æ˜¯ä¸€ä¸ªåªæœ‰ä¸€ä¸ªåˆ†åŒºã€é«˜åº¦å¤åˆ¶ã€åŽ‹ç¼©çš„ Topicã€‚æˆ‘ä»¬å¯èƒ½éœ€è¦æ‰‹åŠ¨åˆ›å»º Topic ä»¥ç¡®ä¿é…ç½®çš„æ­£ç¡®ï¼Œå› ä¸ºè‡ªåŠ¨åˆ›å»ºçš„ Topic å¯èƒ½æœ‰å¤šä¸ªåˆ†åŒºæˆ–è‡ªåŠ¨é…ç½®ä¸ºåˆ é™¤è€Œä¸æ˜¯åŽ‹ç¼©ã€‚ offset.storage.topicï¼šç”¨äºŽå­˜å‚¨ Offset çš„ Topicï¼Œé»˜è®¤ä¸º connect-offsetsã€‚è¿™ä¸ª Topic å¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºã€‚ status.storage.topicï¼šç”¨äºŽå­˜å‚¨çŠ¶æ€çš„ Topicï¼Œé»˜è®¤ä¸º connect-statusã€‚è¿™ä¸ª Topic å¯ä»¥æœ‰å¤šä¸ªåˆ†åŒºã€‚ éœ€è¦æ³¨æ„çš„æ˜¯åœ¨åˆ†å¸ƒå¼æ¨¡å¼ä¸‹é€šè¿‡rest apiæ¥ç®¡ç†connectorã€‚ æ¯”å¦‚ï¼š 12345GET /connectors â€“ è¿”å›žæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„connectoråã€‚POST /connectors â€“ æ–°å»ºä¸€ä¸ªconnector; è¯·æ±‚ä½“å¿…é¡»æ˜¯jsonæ ¼å¼å¹¶ä¸”éœ€è¦åŒ…å«nameå­—æ®µå’Œconfigå­—æ®µï¼Œnameæ˜¯connectorçš„åå­—ï¼Œconfigæ˜¯jsonæ ¼å¼ï¼Œå¿…é¡»åŒ…å«ä½ çš„connectorçš„é…ç½®ä¿¡æ¯ã€‚GET /connectors/&#123;name&#125; â€“ èŽ·å–æŒ‡å®šconnetorçš„ä¿¡æ¯ã€‚GET /connectors/&#123;name&#125;/config â€“ èŽ·å–æŒ‡å®šconnectorçš„é…ç½®ä¿¡æ¯ã€‚PUT /connectors/&#123;name&#125;/config â€“ æ›´æ–°æŒ‡å®šconnectorçš„é…ç½®ä¿¡æ¯ã€‚ é…ç½® ConnectorMySQL Source Connector å®‰è£… MySQL Source Connector plugin è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ Confluent æä¾›çš„ JDBC Source Connectorã€‚ ä»Ž Confluent hub ä¸‹è½½ Kafka Connect JDBC æ’ä»¶å¹¶å°† zip æ–‡ä»¶è§£åŽ‹åˆ° /path/kafka/libs ç›®å½•ä¸‹ã€‚ å®‰è£… MySQL JDBC Driver å› ä¸º Connector éœ€è¦ä¸Žæ•°æ®åº“è¿›è¡Œé€šä¿¡ï¼Œæ‰€ä»¥è¿˜éœ€è¦ JDBC é©±åŠ¨ç¨‹åºã€‚JDBC Connector æ’ä»¶ä¹Ÿæ²¡æœ‰å†…ç½® MySQL é©±åŠ¨ç¨‹åºï¼Œéœ€è¦æˆ‘ä»¬å•ç‹¬ä¸‹è½½é©±åŠ¨ç¨‹åºã€‚MySQL ä¸ºè®¸å¤šå¹³å°æä¾›äº† JDBC é©±åŠ¨ç¨‹åºã€‚é€‰æ‹© Platform Independent é€‰é¡¹ï¼Œç„¶åŽä¸‹è½½åŽ‹ç¼©çš„ TAR æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶åŒ…å« JAR æ–‡ä»¶å’Œæºä»£ç ã€‚å°†æ­¤ tar.gz æ–‡ä»¶çš„å†…å®¹è§£åŽ‹åˆ°ä¸€ä¸ªä¸´æ—¶ç›®å½•ã€‚å°† jar æ–‡ä»¶ï¼ˆä¾‹å¦‚ï¼Œmysql-connector-java-8.0.17.jarï¼‰ï¼Œå¹¶ä¸”ä»…å°†æ­¤ JAR æ–‡ä»¶å¤åˆ¶åˆ°ä¸Ž kafka-connect-jdbc jar æ–‡ä»¶ç›¸åŒçš„ libs ç›®å½•ä¸‹ï¼š 1cp mysql-connector-j-8.0.32.jar /opt/homebrew/Cellar/kafka/3.4.0/libexec/libs/ é…ç½® MySQL Connector åœ¨ /path/kafka/config ä¸‹åˆ›å»º mysql.properties é…ç½®æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸‹é¢çš„é…ç½®: 1234567891011121314name=test-source-mysql-autoincrementconnector.class=io.confluent.connect.jdbc.JdbcSourceConnectortasks.max=1connection.url=jdbc:mysql://localhost:3306/mydb?useSSL=falseconnection.user=rootconnection.password=123456#mode=timestamp+incrementingmode=incrementingtable.whitelist=mydb.test_kafkapoll.interval.ms=1000table.poll.interval.ms=3000incrementing.column.name=id#timestamp.column.name=tmstopics=test_kafka é’ˆå¯¹é…ç½®æˆ‘ä»¬è¿™é‡Œé‡ç‚¹ä»‹ç» mode ï¼Œ incrementing.column.name ï¼Œå’Œ timestamp.column.name å‡ ä¸ªå­—æ®µã€‚Kafka Connect MySQL JDBC Source æä¾›äº†ä¸‰ç§å¢žé‡åŒæ­¥æ¨¡å¼ï¼š incrementing timestamp timestamp+incrementing åœ¨ incrementing æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡éƒ½æ˜¯æ ¹æ® incrementing.column.name å‚æ•°æŒ‡å®šçš„åˆ—ï¼ŒæŸ¥è¯¢å¤§äºŽè‡ªä¸Šæ¬¡æ‹‰å–çš„æœ€å¤§idï¼š 123SELECT * FROM mydb.test_kafkaWHERE id &gt; ?ORDER BY id ASC è¿™ç§æ¨¡å¼çš„ç¼ºç‚¹æ˜¯æ— æ³•æ•èŽ·è¡Œä¸Šæ›´æ–°æ“ä½œï¼ˆä¾‹å¦‚ï¼ŒUPDATEã€DELETEï¼‰çš„å˜æ›´ï¼Œå› ä¸ºæ— æ³•å¢žå¤§è¯¥è¡Œçš„ idã€‚ timestamp æ¨¡å¼åŸºäºŽè¡¨ä¸Šæ—¶é—´æˆ³åˆ—æ¥æ£€æµ‹æ˜¯å¦æ˜¯æ–°è¡Œæˆ–è€…ä¿®æ”¹çš„è¡Œã€‚è¯¥åˆ—æœ€å¥½æ˜¯éšç€æ¯æ¬¡å†™å…¥è€Œæ›´æ–°ï¼Œå¹¶ä¸”å€¼æ˜¯å•è°ƒé€’å¢žçš„ã€‚éœ€è¦ä½¿ç”¨ timestamp.column.name å‚æ•°æŒ‡å®šæ—¶é—´æˆ³åˆ—ã€‚ éœ€è¦æ³¨æ„çš„æ˜¯æ—¶é—´æˆ³åˆ—åœ¨æ•°æ®è¡¨ä¸­ä¸èƒ½è®¾ç½®ä¸º Nullable. åœ¨ timestamp æ¨¡å¼ä¸‹ï¼Œæ¯æ¬¡éƒ½æ˜¯æ ¹æ® timestamp.column.name å‚æ•°æŒ‡å®šçš„åˆ—ï¼ŒæŸ¥è¯¢å¤§äºŽè‡ªä¸Šæ¬¡æ‹‰å–æˆåŠŸçš„ gmt_modifiedï¼š 123SELECT * FROM mydb.test_kafkaWHERE tms &gt; ? AND tms &lt; ?ORDER BY tms ASC è¿™ç§æ¨¡å¼å¯ä»¥æ•èŽ·è¡Œä¸Š UPDATE å˜æ›´ï¼Œç¼ºç‚¹æ˜¯å¯èƒ½é€ æˆæ•°æ®çš„ä¸¢å¤±ã€‚ç”±äºŽæ—¶é—´æˆ³åˆ—ä¸æ˜¯å”¯ä¸€åˆ—å­—æ®µï¼Œå¯èƒ½å­˜åœ¨ç›¸åŒæ—¶é—´æˆ³çš„ä¸¤åˆ—æˆ–è€…å¤šåˆ—ï¼Œå‡è®¾åœ¨å¯¼å…¥ç¬¬äºŒæ¡çš„è¿‡ç¨‹ä¸­å‘ç”Ÿäº†å´©æºƒï¼Œåœ¨æ¢å¤é‡æ–°å¯¼å…¥æ—¶ï¼Œæ‹¥æœ‰ç›¸åŒæ—¶é—´æˆ³çš„ç¬¬äºŒæ¡ä»¥åŠåŽé¢å‡ æ¡æ•°æ®éƒ½ä¼šä¸¢å¤±ã€‚è¿™æ˜¯å› ä¸ºç¬¬ä¸€æ¡å¯¼å…¥æˆåŠŸåŽï¼Œå¯¹åº”çš„æ—¶é—´æˆ³ä¼šè¢«è®°å½•å·²æˆåŠŸæ¶ˆè´¹ï¼Œæ¢å¤åŽä¼šä»Žå¤§äºŽè¯¥æ—¶é—´æˆ³çš„è®°å½•å¼€å§‹åŒæ­¥ã€‚æ­¤å¤–ï¼Œä¹Ÿéœ€è¦ç¡®ä¿æ—¶é—´æˆ³åˆ—æ˜¯éšç€æ—¶é—´é€’å¢žçš„ï¼Œå¦‚æžœäººä¸ºçš„ä¿®æ”¹æ—¶é—´æˆ³åˆ—å°äºŽå½“å‰åŒæ­¥æˆåŠŸçš„æœ€å¤§æ—¶é—´æˆ³ï¼Œä¹Ÿä¼šå¯¼è‡´è¯¥å˜æ›´ä¸èƒ½åŒæ­¥ã€‚ ä»…ä½¿ç”¨ incrementing æˆ– timestamp æ¨¡å¼éƒ½å­˜åœ¨ç¼ºé™·ã€‚å°† timestamp å’Œ incrementing ä¸€èµ·ä½¿ç”¨ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨ incrementing æ¨¡å¼ä¸ä¸¢å¤±æ•°æ®çš„ä¼˜ç‚¹ä»¥åŠ timestamp æ¨¡å¼æ•èŽ·æ›´æ–°æ“ä½œå˜æ›´çš„ä¼˜ç‚¹ã€‚éœ€è¦ä½¿ç”¨ incrementing.column.name å‚æ•°æŒ‡å®šä¸¥æ ¼é€’å¢žåˆ—ã€ä½¿ç”¨ timestamp.column.name å‚æ•°æŒ‡å®šæ—¶é—´æˆ³åˆ—ã€‚ 1234SELECT * FROM mydb.test_kafkaWHERE tms &lt; ? AND ((tms = ? AND id &gt; ?) OR tms &gt; ?)ORDER BY tms, id ASC ç”±äºŽ MySQL JDBC Source Connector æ˜¯åŸºäºŽ query-based çš„æ•°æ®èŽ·å–æ–¹å¼ï¼Œä½¿ç”¨ SELECT æŸ¥è¯¢æ¥æ£€ç´¢æ•°æ®ï¼Œå¹¶æ²¡æœ‰å¤æ‚çš„æœºåˆ¶æ¥æ£€æµ‹å·²åˆ é™¤çš„è¡Œï¼Œæ‰€ä»¥ä¸æ”¯æŒ DELETE æ“ä½œã€‚å¯ä»¥ä½¿ç”¨åŸºäºŽ log-based çš„ [Kafka Connect Debezium]ã€‚ åŽé¢çš„æ¼”ç¤ºä¸­ä¼šåˆ†åˆ«æ¼”ç¤ºä¸Šè¿°æ¨¡å¼çš„æ•ˆæžœã€‚æ›´å¤šçš„é…ç½®å‚æ•°å¯ä»¥å‚è€ƒ MySQL Source Configs ã€‚ Databend Kafka Connector å®‰è£… OR ç¼–è¯‘ Databend Kafka Connector å¯ä»¥ä»Žæºç ç¼–è¯‘å¾—åˆ° jar æˆ–è€…ä»Ž release ç›´æŽ¥ä¸‹è½½ã€‚ 12git clone https://github.com/databendcloud/databend-kafka-connect.git &amp; cd databend-kafka-connectmvn -Passembly -Dmaven.test.skip package å°† databend-kafka-connect.jar æ‹·è´è‡³ /path/kafka/libs ç›®å½•ä¸‹ã€‚ å®‰è£… Databend JDBC Driver ä»Ž Maven Central ä¸‹è½½æœ€æ–°çš„ databend jdbc å¹¶æ‹·è´è‡³ /path/kafka/libs ç›®å½•ä¸‹ã€‚ é…ç½® Databend Kafka Connector åœ¨ /path/kafka/config ä¸‹åˆ›å»º mysql.properties é…ç½®æ–‡ä»¶ï¼Œå¹¶ä½¿ç”¨ä¸‹é¢çš„é…ç½®: 1234567891011121314151617181920name=databendconnector.class=com.databend.kafka.connect.DatabendSinkConnectorconnection.url=jdbc:databend://localhost:8000connection.user=databendconnection.password=databendconnection.attempts=5connection.backoff.ms=10000connection.database=defaulttable.name.format=default.$&#123;topic&#125;max.retries=10batch.size=1auto.create=trueauto.evolve=trueinsert.mode=upsertpk.mode=record_valuepk.fields=idtopics=test_kafkaerrors.tolerance=all auto.create å’Œ auto.evolve è®¾ç½®æˆ true åŽä¼šè‡ªåŠ¨å»ºè¡¨å¹¶åœ¨æºè¡¨ç»“æž„å‘ç”Ÿå˜åŒ–æ—¶åŒæ­¥åˆ°ç›®æ ‡è¡¨ã€‚å…³äºŽæ›´å¤šé…ç½®å‚æ•°çš„ä»‹ç»å¯ä»¥å‚è€ƒ databend kafka connect propertiesã€‚ æµ‹è¯• Databend Kafka Connectå‡†å¤‡å„ä¸ªç»„ä»¶ å¯åŠ¨ MySQL 123456789101112131415161718version: '2.1'services: postgres: image: debezium/example-postgres:1.1 ports: - "5432:5432" environment: - POSTGRES_DB=postgres - POSTGRES_USER=postgres - POSTGRES_PASSWORD=postgres mysql: image: debezium/example-mysql:1.1 ports: - "3306:3306" environment: - MYSQL_ROOT_PASSWORD=123456 - MYSQL_USER=mysqluser - MYSQL_PASSWORD=mysqlpw å¯åŠ¨ Databend 123456789101112131415version: '3'services: databend: image: datafuselabs/databend volumes: - /Users/hanshanjie/databend/local-test/databend/databend-query.toml:/etc/databend/query.toml environment: QUERY_DEFAULT_USER: databend QUERY_DEFAULT_PASSWORD: databend MINIO_ENABLED: 'true' ports: - '8000:8000' - '9000:9000' - '3307:3307' - '8124:8124' ä»¥ standalone æ¨¡å¼å¯åŠ¨ kafka connectï¼Œå¹¶åŠ è½½ MySQL Source Connector å’Œ Databend Sink Connector: 1./bin/connect-standalone.sh config/connect-standalone.properties config/databend.properties config/mysql.properties 12345678[2023-09-06 17:39:23,128] WARN [databend|task-0] These configurations '[metrics.context.connect.kafka.cluster.id]' were supplied but are not used yet. (org.apache.kafka.clients.consumer.ConsumerConfig:385)[2023-09-06 17:39:23,128] INFO [databend|task-0] Kafka version: 3.4.0 (org.apache.kafka.common.utils.AppInfoParser:119)[2023-09-06 17:39:23,128] INFO [databend|task-0] Kafka commitId: 2e1947d240607d53 (org.apache.kafka.common.utils.AppInfoParser:120)[2023-09-06 17:39:23,128] INFO [databend|task-0] Kafka startTimeMs: 1693993163128 (org.apache.kafka.common.utils.AppInfoParser:121)[2023-09-06 17:39:23,148] INFO Created connector databend (org.apache.kafka.connect.cli.ConnectStandalone:113)[2023-09-06 17:39:23,148] INFO [databend|task-0] [Consumer clientId=connector-consumer-databend-0, groupId=connect-databend] Subscribed to topic(s): test_kafka (org.apache.kafka.clients.consumer.KafkaConsumer:969)[2023-09-06 17:39:23,150] INFO [databend|task-0] Starting Databend Sink task (com.databend.kafka.connect.sink.DatabendSinkConfig:33)[2023-09-06 17:39:23,150] INFO [databend|task-0] DatabendSinkConfig values:... InsertInsert æ¨¡å¼ä¸‹æˆ‘ä»¬éœ€è¦ä½¿ç”¨å¦‚ä¸‹çš„ MySQL Connector é…ç½®ï¼š 1234567891011121314name=test-source-mysql-jdbc-autoincrementconnector.class=io.confluent.connect.jdbc.JdbcSourceConnectortasks.max=1connection.url=jdbc:mysql://localhost:3306/mydb?useSSL=falseconnection.user=rootconnection.password=123456#mode=timestamp+incrementingmode=incrementingtable.whitelist=mydb.test_kafkapoll.interval.ms=1000table.poll.interval.ms=3000incrementing.column.name=id#timestamp.column.name=tmstopics=test_kafka åœ¨ MySQL ä¸­åˆ›å»ºæ•°æ®åº“ mydb å’Œè¡¨ test_kafka: 12345CREATE DATABASE mydb;USE mydb;CREATE TABLE test_kafka (id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,name VARCHAR(255) NOT NULL,description VARCHAR(512));ALTER TABLE test_kafka AUTO_INCREMENT = 10; åœ¨æ’å…¥æ•°æ®ä¹‹å‰ï¼Œdatabend-kafka-connect å¹¶ä¸ä¼šæ”¶åˆ° event è¿›è¡Œå»ºè¡¨å’Œæ•°æ®å†™å…¥ï¼š æ’å…¥æ•°æ®ï¼š 12345678910INSERT INTO test_kafka VALUES (default,"scooter","Small 2-wheel scooter"),(default,"car battery","12V car battery"),(default,"12-pack drill bits","12-pack of drill bits with sizes ranging from #40 to #3"),(default,"hammer","12oz carpenter's hammer"),(default,"hammer","14oz carpenter's hammer"),(default,"hammer","16oz carpenter's hammer"),(default,"rocks","box of assorted rocks"),(default,"jacket","water resistent black wind breaker"),(default,"cloud","test for databend"),(default,"spare tire","24 inch spare tire"); æºè¡¨ç«¯æ’å…¥æ•°æ®åŽï¼Œ Databend ç›®æ ‡ç«¯çš„è¡¨å°±æ–°å»ºå‡ºæ¥äº†ï¼š åŒæ—¶æ•°æ®ä¹Ÿä¼šæˆåŠŸæ’å…¥ï¼š Support DDLæˆ‘ä»¬åœ¨é…ç½®æ–‡ä»¶ä¸­ auto.evolve=trueï¼Œæ‰€ä»¥åœ¨æºè¡¨ç»“æž„å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œä¼šå°† DDL åŒæ­¥è‡³ç›®æ ‡è¡¨ã€‚è¿™é‡Œæˆ‘ä»¬æ­£å¥½éœ€è¦å°† MySQL Source Connector çš„æ¨¡å¼ä»Ž incrementing æ”¹æˆ timestamp+incrementingï¼Œéœ€è¦æ–°å¢žä¸€ä¸ª timestamp å­—æ®µå¹¶æ‰“å¼€ timestamp.column.name=tms é…ç½®ã€‚æˆ‘ä»¬åœ¨åŽŸè¡¨ä¸­æ‰§è¡Œï¼š 1alter table test_kafka add column tms timestamp; å¹¶æ’å…¥ä¸€æ¡æ•°æ®ï¼š 1insert into test_kafka values(20,"new data","from kafka",now()); åˆ°ç›®æ ‡è¡¨ä¸­æŸ¥çœ‹ï¼š å‘çŽ° tms å­—æ®µå·²ç»åŒæ­¥è‡³ Databend tableï¼Œå¹¶ä¸”è¯¥æ¡æ•°æ®ä¹Ÿå·²ç»æ’å…¥æˆåŠŸï¼š Upsertä¿®æ”¹ MySQL Connector çš„é…ç½®ä¸ºï¼š 1234567891011121314name=test-source-mysql-jdbc-autoincrementconnector.class=io.confluent.connect.jdbc.JdbcSourceConnectortasks.max=1connection.url=jdbc:mysql://localhost:3306/mydb?useSSL=falseconnection.user=rootconnection.password=123456mode=timestamp+incrementing#mode=incrementingtable.whitelist=mydb.test_kafkapoll.interval.ms=1000table.poll.interval.ms=3000incrementing.column.name=idtimestamp.column.name=tmstopics=test_kafka é‡å¯ kafka connectã€‚ åœ¨æºè¡¨ä¸­æ›´æ–°ä¸€æ¡æ•°æ®ï¼š 1update test_kafka set name="update from kafka test" where id=20; åˆ°ç›®æ ‡è¡¨ä¸­å¯ä»¥çœ‹åˆ°æ›´æ–°çš„æ•°æ®ï¼š æ€»ç»“é€šè¿‡ä¸Šé¢çš„å†…å®¹å¯ä»¥çœ‹åˆ° databend kafka connect å…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š Table å’Œ Column æ”¯æŒè‡ªåŠ¨åˆ›å»ºï¼šauto.create å’Œ `auto-evolve çš„é…ç½®æ”¯æŒä¸‹ï¼Œå¯ä»¥è‡ªåŠ¨åˆ›å»º Table å’Œ Columnï¼ŒTable nameæ˜¯åŸºäºŽ Kafka topic name åˆ›å»ºçš„ï¼› Kafka Shemas æ”¯æŒï¼šconnector æ”¯æŒ Avroã€JSON Schema å’Œ Protobuf è¾“å…¥æ•°æ®æ ¼å¼ã€‚å¿…é¡»å¯ç”¨ Schema Registry æ‰èƒ½ä½¿ç”¨åŸºäºŽ Schema Registry çš„æ ¼å¼ï¼› å¤šä¸ªå†™å…¥æ¨¡å¼ï¼šConnector æ”¯æŒ insert å’Œ upsert å†™å…¥æ¨¡å¼ï¼› å¤šä»»åŠ¡æ”¯æŒï¼šåœ¨ kafka connect çš„èƒ½åŠ›ä¸‹ï¼Œconnector æ”¯æŒè¿è¡Œä¸€ä¸ªæˆ–å¤šä¸ªä»»åŠ¡ã€‚å¢žåŠ ä»»åŠ¡çš„æ•°é‡å¯ä»¥æé«˜ç³»ç»Ÿæ€§èƒ½ï¼› é«˜å¯ç”¨ï¼šåˆ†å¸ƒå¼æ¨¡å¼ä¸‹å¯ä»¥è‡ªåŠ¨å¹³è¡¡å·¥ä½œè´Ÿè½½ï¼Œå¹¶å¯ä»¥åŠ¨æ€æ‰©å±•ï¼ˆæˆ–ç¼©å‡ï¼‰ä»¥åŠæä¾›å®¹é”™èƒ½åŠ›ã€‚ åŒæ—¶ï¼ŒDatabend Kafka Connect ä¹Ÿèƒ½å¤Ÿä½¿ç”¨åŽŸç”Ÿ connect æ”¯æŒçš„é…ç½®ï¼Œæ›´å¤šé…ç½®å‚è€ƒ Kafka Connect Sink Configuration Properties for Confluent Platformã€‚]]></content>
      <categories>
        <category>Databend</category>
      </categories>
      <tags>
        <tag>CDC</tag>
        <tag>Databend</tag>
        <tag>kafka connect</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»Ž 0 åˆ° 1 ä¸º Databend å¼€å‘è½»é‡çº§ CDC]]></title>
    <url>%2F2023%2F07%2F18%2F%E4%BB%8E-0-%E5%88%B0-1-%E4%B8%BA-Databend-%E8%AE%BE%E8%AE%A1%E8%BD%BB%E9%87%8F%E7%BA%A7-CDC%2F</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯ CDCCDCï¼ˆChange Data Captureï¼‰æ˜¯ä¸€ç§æ•°æ®åŒæ­¥æŠ€æœ¯ï¼Œç”¨äºŽå®žæ—¶æ•èŽ·å’Œä¼ é€’æ•°æ®åº“ä¸­çš„æ•°æ®æ›´æ”¹ã€‚é€šè¿‡ CDCï¼Œæˆ‘ä»¬å¯ä»¥å°†æ•°æ®åº“ä¸­çš„å˜æ›´äº‹ä»¶æ•èŽ·å¹¶è½¬æ¢æˆæ•°æ®æµï¼Œç„¶åŽå°†å…¶ä¼ é€’ç»™å…¶ä»–ç³»ç»Ÿæˆ–åº”ç”¨ç¨‹åºï¼Œä»¥å®žçŽ°æ•°æ®çš„å®žæ—¶åŒæ­¥å’Œåˆ†å‘ã€‚ å¸¸è§çš„ CDC æ ¼å¼ä¸ºï¼š 12345678910&#123; "op": "Update", // "Insert", "Delete", "event_time": "2022-11-01 12:00:00", "payload": &#123; "id": 123, "author": "Franz Kafka", "title": "Metamorphosis", "published_at": "1915-01-01" &#125;&#125; ä¸€ç§ç”Ÿäº§å¯ç”¨çš„ CDC ç³»ç»Ÿæž¶æž„å¯ä»¥æ˜¯ä¸‹å›¾ï¼š çŽ°é˜¶æ®µä¸»æµ CDC æ–¹æ¡ˆå’Œæž¶æž„åœ¨ç›®å‰çš„æŠ€æœ¯å‘å±•ä¸­ï¼Œæœ‰å‡ ç§ä¸»æµçš„CDCæ–¹æ¡ˆå’Œæž¶æž„ï¼š 1. Flink CDC Flink CDC æ˜¯åŸºäºŽ Apache Flink çš„ CDC æ–¹æ¡ˆã€‚å®ƒå¯ä»¥å®žæ—¶æ•èŽ·æ•°æ®åº“çš„å˜æ›´äº‹ä»¶ï¼Œå¹¶å°†å…¶è½¬æ¢æˆæµæ•°æ®ã€‚Flink CDC æä¾›äº†éžå¸¸å¤šçš„è¿žæŽ¥å™¨ç»„ä»¶ï¼Œå¯ä»¥åœ¨å¼‚æž„çš„æ•°æ®æºä¹‹é—´å®žçŽ°æ•°æ®æµåŠ¨ã€‚ Databend ä¹Ÿæä¾›äº† flink-databend-connectorï¼Œå¯ä»¥ä¸Ž MySQLï¼ŒPG ç­‰ RDBMS æž„å»ºå®žæ—¶æ•°æ®åŒæ­¥ã€‚ 2. Kafka Connector Kafka Connector æ˜¯åŸºäºŽ Apache Kafka çš„ CDC æ–¹æ¡ˆã€‚Kafka ä½œä¸ºåˆ†å¸ƒå¼æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥ç”¨äºŽæ•°æ®ä¼ é€’å’Œåˆ†å‘ã€‚Kafka Connector å…è®¸å°†æ•°æ®ä»Žæ•°æ®åº“ä¸­æ•èŽ·ï¼Œå¹¶å°†å…¶å‘å¸ƒåˆ° Kafka ä¸»é¢˜ä¸­ï¼Œä¾›å…¶ä»–ç³»ç»Ÿæ¶ˆè´¹ã€‚ 3. Canal Canal æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ CDC è§£å†³æ–¹æ¡ˆã€‚å®ƒå¯ä»¥æ•èŽ· MySQL æ•°æ®åº“çš„å˜æ›´ï¼Œå¹¶å°†å…¶è½¬æ¢æˆæ¶ˆæ¯æ ¼å¼è¾“å‡ºï¼Œå¸¸ç”¨äºŽæ•°æ®åŒæ­¥å’Œä¸šåŠ¡è§£è€¦ã€‚é™åˆ¶æ˜¯åªèƒ½åŸºäºŽ MySQL æ•°æ®åº“å¢žé‡æ—¥å¿—è§£æžã€‚ Debezium Server Debezium Server æ˜¯ä¸€ä¸ªåŸºäºŽ Debezium Engine çš„ CDC é¡¹ç›®ã€‚Debezium Engine æ˜¯ Debezium é¡¹ç›®çš„æ ¸å¿ƒï¼Œç”¨äºŽæ•èŽ·æ•°æ®åº“çš„å˜æ›´äº‹ä»¶ã€‚Debezium Server æž„å»ºåœ¨è¯¥å¼•æ“Žä¹‹ä¸Šï¼Œæä¾›äº†ä¸€ç§è½»é‡çº§çš„ CDC è§£å†³æ–¹æ¡ˆï¼Œç”¨äºŽå®žæ—¶æ•èŽ·æ•°æ®åº“æ›´æ”¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºäº‹ä»¶æµï¼Œæœ€ç»ˆå°†æ•°æ®å†™å…¥ç›®æ ‡æ•°æ®åº“ã€‚ Debezium Server DatabendDebezium Server Databend æ˜¯ä¸€ä¸ªåŸºäºŽ Debezium Engine è‡ªç ”çš„è½»é‡çº§ CDC é¡¹ç›®ï¼Œç”¨äºŽå®žæ—¶æ•èŽ·æ•°æ®åº“æ›´æ”¹å¹¶å°†å…¶ä½œä¸ºäº‹ä»¶æµä¼ é€’æœ€ç»ˆå°†æ•°æ®å†™å…¥ç›®æ ‡æ•°æ®åº“ Databendã€‚å®ƒæä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥ç›‘è§†å’Œæ•èŽ·å…³ç³»åž‹æ•°æ®åº“çš„å˜åŒ–ï¼Œå¹¶æ”¯æŒå°†è¿™äº›å˜åŒ–è½¬æ¢ä¸ºå¯æ¶ˆè´¹äº‹ä»¶ã€‚ä½¿ç”¨ Debezium server databend å®žçŽ° CDC æ— é¡»ä¾èµ–å¤§åž‹çš„ Data Infra æ¯”å¦‚ Flink, Kafka, Spark ç­‰ï¼Œåªéœ€ä¸€ä¸ªå¯åŠ¨è„šæœ¬å³å¯å¼€å¯å®žæ—¶æ•°æ®åŒæ­¥ã€‚ æºç åˆ†æž debezium-server-databend å®žçŽ°Debezium Server Databend å®žçŽ°äº†è½»é‡çº§CDCæ–¹æ¡ˆï¼Œé€šè¿‡ Debezium Engine æ•èŽ·æ•°æ®åº“å˜æ›´äº‹ä»¶ï¼Œå°†å…¶è½¬æ¢æˆäº‹ä»¶æµï¼Œç„¶åŽå°†äº‹ä»¶æµä¼ é€’ç»™ Databend æ•°æ®åº“ï¼Œå®žçŽ°æ•°æ®çš„å®žæ—¶åŒæ­¥ã€‚ä¸‹é¢å…ˆä»Žä»£ç å±‚é¢åˆ†æžä¸€ä¸‹è¯¥ç»„ä»¶çš„å®žçŽ°åŽŸç†ã€‚ ä¸»è¦ä»£ç çš„ç»“æž„æ˜¯ï¼š 1234567891011121314151617.â”œâ”€â”€ DatabendChangeConsumer.javaâ”œâ”€â”€ DatabendChangeEvent.javaâ”œâ”€â”€ DatabendTypes.javaâ”œâ”€â”€ DatabendUtil.javaâ”œâ”€â”€ DebeziumMetrics.javaâ”œâ”€â”€ batchsizewaitâ”‚ â”œâ”€â”€ InterfaceBatchSizeWait.javaâ”‚ â”œâ”€â”€ MaxBatchSizeWait.javaâ”‚ â””â”€â”€ NoBatchSizeWait.javaâ””â”€â”€ tablewriter â”œâ”€â”€ AppendTableWriter.java â”œâ”€â”€ BaseTableWriter.java â”œâ”€â”€ RelationalTable.java â”œâ”€â”€ TableNotFoundException.java â”œâ”€â”€ TableWriterFactory.java â””â”€â”€ UpsertTableWriter.java Debezium server çš„å…¥å£é€»è¾‘åœ¨ DatabendChangeConsumer ä¸­ï¼Œç»§æ‰¿ BaseChangeConsumer å¹¶å®žçŽ°ç›¸åº”æ–¹æ³•ï¼Œ ä½œç”¨æ˜¯åŠ è½½é…ç½®ï¼Œåˆå§‹åŒ– server, databaseä»¥åŠå¤„ç† batch eventï¼š 12345678910111213141516/** * Implementation of the consumer that delivers the messages to databend database tables. * * @author hantmac */@Named("databend")@Dependentpublic class DatabendChangeConsumer extends BaseChangeConsumer implements DebeziumEngine.ChangeConsumer&lt;ChangeEvent&lt;Object, Object&gt;&gt; &#123; ...// @ConfigProperty(name = "debezium.sink.databend.xxx", defaultValue = "") void connect() throws Exception &#123; ... &#125; public void handleBatch(List&lt;ChangeEvent&lt;Object, Object&gt;&gt; records, DebeziumEngine.RecordCommitter&lt;ChangeEvent&lt;Object, Object&gt;&gt; committer) throws InterruptedException &#123;...&#125; &#125; æ ¸å¿ƒä»£ç æ˜¯åœ¨ handleBatch ä¸­ï¼Œåœ¨è¿™é‡ŒæŽ¥æ”¶å˜æ›´äº‹ä»¶å¹¶å‘é€åˆ° tablewriter ä¸­è¿›ä¸€æ­¥å¤„ç†ã€‚ 12345678910111213141516171819202122232425262728293031323334353637@Override public void handleBatch(List&lt;ChangeEvent&lt;Object, Object&gt;&gt; records, DebeziumEngine.RecordCommitter&lt;ChangeEvent&lt;Object, Object&gt;&gt; committer) throws InterruptedException &#123; Instant start = Instant.now(); //group events by destination Map&lt;String, List&lt;DatabendChangeEvent&gt;&gt; result = records.stream() .map((ChangeEvent&lt;Object, Object&gt; e) -&gt; &#123; try &#123; return new DatabendChangeEvent(e.destination(), valDeserializer.deserialize(e.destination(), getBytes(e.value())), e.key() == null ? null : valDeserializer.deserialize(e.destination(), getBytes(e.key())), mapper.readTree(getBytes(e.value())).get("schema"), e.key() == null ? null : mapper.readTree(getBytes(e.key())).get("schema") ); &#125; catch (IOException ex) &#123; throw new DebeziumException(ex); &#125; &#125;) .collect(Collectors.groupingBy(DatabendChangeEvent::destination)); // consume list of events for each destination table for (Map.Entry&lt;String, List&lt;DatabendChangeEvent&gt;&gt; tableEvents : result.entrySet()) &#123; RelationalTable tbl = this.getDatabendTable(mapDestination(tableEvents.getKey()), tableEvents.getValue().get(0).schema()); // èŽ·å– tablewriter å®žä¾‹ tableWriter.addToTable(tbl, tableEvents.getValue()); // å°†äº‹ä»¶æŽ¨é€è‡³ tablewriter &#125; for (ChangeEvent&lt;Object, Object&gt; record : records) &#123; LOGGER.trace("Processed event '&#123;&#125;'", record); committer.markProcessed(record); &#125; committer.markBatchFinished(); this.logConsumerProgress(records.size()); batchSizeWait.waitMs(records.size(), (int) Duration.between(start, Instant.now()).toMillis()); TableWriterFactoryä¸­æä¾›äº† Append å’Œ Upsert ä¸¤ç§æ¨¡å¼ï¼š 1234567public BaseTableWriter get(final Connection connection) &#123; if (upsert) &#123; return new UpsertTableWriter(connection, identifierQuoteCharacter.orElse(""), upsertKeepDeletes); &#125; else &#123; return new AppendTableWriter(connection, identifierQuoteCharacter.orElse("")); &#125;&#125; æ¯ç§æ¨¡å¼éƒ½å®žçŽ°äº† addTable æ–¹æ³•ã€‚ Append modeåœ¨ CDC ä¸­ï¼ŒAppend Mode æ˜¯ä¸€ç§æ•°æ®å†™å…¥æ¨¡å¼ã€‚å½“æ•°æ®åº“çš„ä¸€æ¡è®°å½•å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒCDC ä¼šå°†è¯¥å˜åŒ–ä½œä¸ºä¸€æ¡æ–°çš„äº‹ä»¶è¿½åŠ åˆ°äº‹ä»¶æµä¸­ã€‚ Upsert modeUpsert Mode æ˜¯å¦ä¸€ç§æ•°æ®å†™å…¥æ¨¡å¼ã€‚å½“æ•°æ®åº“çš„ä¸€æ¡è®°å½•å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒCDC ä¼šå°†è¯¥å˜åŒ–ä½œä¸ºä¸€ä¸ªæ›´æ–°æ“ä½œï¼Œå¦‚æžœè®°å½•ä¸å­˜åœ¨ï¼Œåˆ™ä½œä¸ºæ’å…¥æ“ä½œï¼Œä»¥å®žçŽ°æ•°æ®çš„æ›´æ–°å’Œæ’å…¥ã€‚ Upsert mode ç”¨åˆ°äº† Databend çš„ Replace into è¯­æ³•ï¼Œæ‰€ä»¥éœ€è¦ç”¨æˆ·æŒ‡å®šä¸€ä¸ª conflict keyï¼Œè¿™é‡Œæˆ‘ä»¬æä¾›ä¸€ä¸ªé…ç½®ï¼š 1debezium.sink.databend.database.primaryKey=id å¦‚æžœæ²¡æœ‰æä¾›è¯¥é…ç½®ï¼Œä¼šé€€åŒ–æˆè¿½åŠ æ¨¡å¼ã€‚ DeleteDeleteæ“ä½œæ˜¯æŒ‡æ•°æ®åº“ä¸­çš„è®°å½•è¢«åˆ é™¤ï¼ŒCDC ä¼šå°†è¯¥æ“ä½œä½œä¸ºä¸€ä¸ªäº‹ä»¶å†™å…¥äº‹ä»¶æµï¼Œä»¥é€šçŸ¥å…¶ä»–ç³»ç»Ÿè¯¥è®°å½•å·²è¢«åˆ é™¤ã€‚ Debezim Server å¯¹ Delete çš„å¤„ç†æ¯”è¾ƒå¤æ‚ï¼Œåœ¨ DELETE æ“ä½œä¸‹ä¼šç”Ÿæˆä¸¤æ¡äº‹ä»¶è®°å½•ï¼š ä¸€ä¸ªåŒ…å« â€œopâ€: â€œdâ€ï¼Œå…¶ä»–çš„è¡Œæ•°æ®ä»¥åŠå­—æ®µï¼› ä¸€ä¸ªtombstonesè®°å½•ï¼Œå®ƒå…·æœ‰ä¸Žè¢«åˆ é™¤è¡Œç›¸åŒçš„é”®ï¼Œä½†å€¼ä¸ºnullã€‚ è¿™ä¸¤æ¡äº‹ä»¶ä¼šåŒæ—¶å‘å‡ºï¼Œåœ¨ Debezium Server Databend ä¸­æˆ‘ä»¬é€‰æ‹©å¯¹ Delete æ•°æ®å®žè¡Œè½¯åˆ é™¤ï¼Œè¿™å°±è¦æ±‚æˆ‘ä»¬åœ¨ target table ä¸­æ‹¥æœ‰ __deleted å­—æ®µï¼Œå½“ Delete äº‹ä»¶è¿‡æ¥çš„æ—¶å€™æˆ‘ä»¬å°†è¯¥å­—æ®µç½®ä¸º TRUE åŽæ’å…¥åˆ°ç›®æ ‡è¡¨ã€‚ è¿™æ ·è®¾è®¡çš„å¥½å¤„æ˜¯ï¼Œæœ‰äº›ç”¨æˆ·æœ€å¼€å§‹æƒ³è¦ä¿ç•™è¿™äº›æ•°æ®ï¼Œä½†å¯èƒ½æœªæ¥ä¼šæƒ³åˆ°å°†å…¶åˆ é™¤ï¼Œè¿™æ ·å°±ä¸ºç”¨æˆ·æä¾›äº†å¯é€‰çš„æ–¹æ¡ˆï¼Œæœªæ¥æƒ³è¦åˆ é™¤è¿™äº›æ•°æ®çš„æ—¶å€™ï¼Œåªéœ€è¦ delete from table where __deleted=true å³å¯ã€‚ å…³äºŽ Debezium å¯¹åˆ é™¤äº‹ä»¶çš„è¯´æ˜Žä»¥åŠå¤„ç†æ–¹å¼ï¼Œè¯¦æƒ…å¯å‚è€ƒæ–‡æ¡£ã€‚ ä½¿ç”¨è½»é‡çº§ CDC debezium-server-databend æž„å»º MySQL åˆ° Databend çš„ å®žæ—¶æ•°æ®åŒæ­¥ä¸‹é¢ç”¨ä¸€ä¸ªå®žé™…æ¡ˆä¾‹å±•ç¤ºå¦‚ä½•åŸºäºŽ Debezium server databend å¿«é€Ÿæž„å»º MySQL åˆ° Databend çš„å®žæ—¶æ•°æ®åŒæ­¥ã€‚ å‡†å¤‡é˜¶æ®µå‡†å¤‡ä¸€å°å·²ç»å®‰è£…äº† Docker ï¼Œdocker-compose ä»¥åŠ Java 11 çŽ¯å¢ƒ çš„ Linux æˆ–è€… MacOS ã€‚ å‡†å¤‡æ•™ç¨‹æ‰€éœ€è¦çš„ç»„ä»¶æŽ¥ä¸‹æ¥çš„æ•™ç¨‹å°†ä»¥ docker-compose çš„æ–¹å¼å‡†å¤‡æ‰€éœ€è¦çš„ç»„ä»¶ã€‚ debezium-MySQLdocker-compose.yaml 123456789101112131415161718version: '2.1'services: postgres: image: debezium/example-postgres:1.1 ports: - "5432:5432" environment: - POSTGRES_DB=postgres - POSTGRES_USER=postgres - POSTGRES_PASSWORD=postgres mysql: image: debezium/example-mysql:1.1 ports: - "3306:3306" environment: - MYSQL_ROOT_PASSWORD=123456 - MYSQL_USER=mysqluser - MYSQL_PASSWORD=mysqlpw Debezium Server Databend Clone é¡¹ç›®: git clone `https://github.com/databendcloud/debezium-server-databend.git` ä»Žé¡¹ç›®æ ¹ç›®å½•å¼€å§‹: æž„å»ºå’Œæ‰“åŒ… debezium server: mvn -Passembly -Dmaven.test.skip package æž„å»ºå®ŒæˆåŽï¼Œè§£åŽ‹æœåŠ¡å™¨åˆ†å‘åŒ…: unzip debezium-server-databend-dist/target/debezium-server-databend-dist*.zip -d databendDist è¿›å…¥è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹: cd databendDist åˆ›å»º application.properties æ–‡ä»¶å¹¶ä¿®æ”¹: nano conf/application.propertiesï¼Œå°†ä¸‹é¢çš„ application.properties æ‹·è´è¿›åŽ»ï¼Œæ ¹æ®ç”¨æˆ·å®žé™…æƒ…å†µä¿®æ”¹ç›¸åº”çš„é…ç½®ã€‚ ä½¿ç”¨æä¾›çš„è„šæœ¬è¿è¡ŒæœåŠ¡: bash run.sh Debezium Server with Databend å°†ä¼šå¯åŠ¨ åŒæ—¶æˆ‘ä»¬ä¹Ÿæä¾›äº†ç›¸åº”çš„ Docker imageï¼Œå¯ä»¥åœ¨å®¹å™¨ä¸­ä¸€é”®å¯åŠ¨ï¼š 12345678910version: '2.1'services: debezium: image: ghcr.io/databendcloud/debezium-server-databend:pr-2 ports: - "8080:8080" - "8083:8083" volumes: - $PWD/conf:/app/conf - $PWD/data:/app/data NOTE: åœ¨å®¹å™¨ä¸­å¯åŠ¨æ³¨æ„æ‰€è¿žæŽ¥æ•°æ®åº“çš„ç½‘ç»œã€‚ Debezium Server Databend Application Propertiesæœ¬æ–‡ç« ä½¿ç”¨ä¸‹é¢æä¾›çš„é…ç½®ï¼Œæ›´å¤šçš„å‚æ•°è¯´æ˜Žä»¥åŠé…ç½®å¯ä»¥å‚è€ƒæ–‡æ¡£ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344debezium.sink.type=databenddebezium.sink.databend.upsert=truedebezium.sink.databend.upsert-keep-deletes=falsedebezium.sink.databend.database.databaseName=debeziumdebezium.sink.databend.database.url=jdbc:databend://tnf34b0rm--xxxxxx.default.databend.cn:443debezium.sink.databend.database.username=cloudappdebezium.sink.databend.database.password=passworddebezium.sink.databend.database.primaryKey=iddebezium.sink.databend.database.tableName=productsdebezium.sink.databend.database.param.ssl=true# enable event schemasdebezium.format.value.schemas.enable=truedebezium.format.key.schemas.enable=truedebezium.format.value=jsondebezium.format.key=json# mysql sourcedebezium.source.connector.class=io.debezium.connector.mysql.MySqlConnectordebezium.source.offset.storage.file.filename=data/offsets.datdebezium.source.offset.flush.interval.ms=60000debezium.source.database.hostname=127.0.0.1debezium.source.database.port=3306debezium.source.database.user=rootdebezium.source.database.password=123456debezium.source.database.dbname=mydbdebezium.source.database.server.name=from_mysqldebezium.source.include.schema.changes=falsedebezium.source.table.include.list=mydb.products# debezium.source.database.ssl.mode=required# Run without Kafka, use local file to store checkpointsdebezium.source.database.history=io.debezium.relational.history.FileDatabaseHistorydebezium.source.database.history.file.filename=data/status.dat# do event flattening. unwrap message!debezium.transforms=unwrapdebezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordStatedebezium.transforms.unwrap.delete.handling.mode=rewritedebezium.transforms.unwrap.drop.tombstones=true# ############ SET LOG LEVELS ############quarkus.log.level=INFO# Ignore messages below warning level from Jetty, because it's a bit verbosequarkus.log.category."org.eclipse.jetty".level=WARN å‡†å¤‡æ•°æ®åœ¨ MySQL æ•°æ®åº“ä¸­å‡†å¤‡æ•°æ®è¿›å…¥ MySQL å®¹å™¨ 1docker-compose exec mysql mysql -uroot -p123456 åˆ›å»ºæ•°æ®åº“ mydb å’Œè¡¨ productsï¼Œå¹¶æ’å…¥æ•°æ®: 12345678910111213141516CREATE DATABASE mydb;USE mydb;CREATE TABLE products (id INTEGER NOT NULL AUTO_INCREMENT PRIMARY KEY,name VARCHAR(255) NOT NULL,description VARCHAR(512));ALTER TABLE products AUTO_INCREMENT = 10;INSERT INTO products VALUES (default,"scooter","Small 2-wheel scooter"),(default,"car battery","12V car battery"),(default,"12-pack drill bits","12-pack of drill bits with sizes ranging from #40 to #3"),(default,"hammer","12oz carpenter's hammer"),(default,"hammer","14oz carpenter's hammer"),(default,"hammer","16oz carpenter's hammer"),(default,"rocks","box of assorted rocks"),(default,"jacket","water resistent black wind breaker"),(default,"cloud","test for databend"),(default,"spare tire","24 inch spare tire"); åœ¨ Databend ä¸­åˆ›å»º Database NOTE: ç”¨æˆ·å¯ä»¥ä¸å¿…å…ˆåœ¨ Databend ä¸­åˆ›å»ºè¡¨ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°åŽä¼šè‡ªåŠ¨ä¸ºç”¨æˆ·å»ºè¡¨ã€‚ å¯åŠ¨ Debezium Server Databend1bash run.sh é¦–æ¬¡å¯åŠ¨ä¼šè¿›å…¥ init snapshot æ¨¡å¼ï¼Œé€šè¿‡é…ç½®çš„ Batch Size å…¨é‡å°† MySQL ä¸­çš„æ•°æ®åŒæ­¥åˆ° Databendï¼Œæ‰€ä»¥åœ¨ Databend ä¸­å¯ä»¥çœ‹åˆ° MySQL ä¸­çš„æ•°æ®å·²ç»åŒæ­¥è¿‡æ¥äº†ï¼š åŒæ­¥ Insert æ•°æ®æˆ‘ä»¬ç»§ç»­å¾€ MySQL ä¸­æ’å…¥ 5 æ¡æ•°æ®ï¼š 12345INSERT INTO products VALUES (default,"scooter","Small 2-wheel scooter"),(default,"car battery","12V car battery"),(default,"12-pack drill bits","12-pack of drill bits with sizes ranging from #40 to #3"),(default,"hammer","12oz carpenter's hammer"),(default,"hammer","14oz carpenter's hammer"); Debezium server databend æ—¥å¿—ï¼š åŒæ—¶åœ¨ Databend ä¸­å¯ä»¥æŸ¥åˆ° 5 æ¡æ•°æ®å·²ç»åŒæ­¥è¿‡æ¥äº†ï¼š åŒæ­¥ Update æ•°æ®é…ç½®æ–‡ä»¶ä¸­ debezium.sink.databend.upsert=true ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥å¤„ç† Update/Delete çš„äº‹ä»¶ã€‚ åœ¨ MySQL ä¸­æ›´æ–° id=10 çš„æ•°æ®ï¼š 1update products set name="from debezium" where id=10; åœ¨ Databend ä¸­å¯ä»¥æŸ¥åˆ° id ä¸º 10 çš„æ•°æ®å·²ç»è¢«æ›´æ–°ï¼š åŒæ­¥ Delete æ•°æ®åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œæœ‰ä»¥ä¸‹çš„é…ç½®ï¼Œæ—¢å¯å¼€å¯å¤„ç† Delete äº‹ä»¶çš„èƒ½åŠ›ï¼š 12345debezium.sink.databend.upsert-keep-deletes=falsedebezium.transforms=unwrapdebezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordStatedebezium.transforms.unwrap.delete.handling.mode=rewritedebezium.transforms.unwrap.drop.tombstones=true åœ¨ MySQL ä¸­åˆ é™¤ id=12 çš„æ•°æ®ï¼š 1delete from products where id=12; åœ¨ Databend ä¸­å¯ä»¥è§‚å¯Ÿåˆ° id=12 çš„å€¼çš„ __deleted å­—æ®µå·²ç»è¢«ç½®ä¸º trueã€‚ çŽ¯å¢ƒæ¸…ç†æ“ä½œç»“æŸåŽï¼Œåœ¨ docker-compose.yml æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•ä¸‹æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤åœæ­¢æ‰€æœ‰å®¹å™¨ï¼š 1docker-compose down ç»“è®ºæ–‡ç« ä»‹ç»äº† databend çš„è½»é‡çº§ CDC å®žçŽ°åŽŸç†ï¼Œæ¼”ç¤ºäº†åŸºäºŽè½»é‡çº§ CDC debezium server databend æž„å»º MySQL åˆ° Databend çš„ å®žæ—¶æ•°æ®åŒæ­¥çš„å…¨éƒ¨è¿‡ç¨‹ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦ä¾èµ– Flink, Kafka ç­‰å¤§åž‹ç»„ä»¶ï¼Œå¯åŠ¨å’Œç®¡ç†éžå¸¸æ–¹ä¾¿ã€‚]]></content>
      <categories>
        <category>CDC</category>
      </categories>
      <tags>
        <tag>CDC</tag>
        <tag>Database</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸º Databend Rust Driver å®žçŽ° Python Binding]]></title>
    <url>%2F2023%2F05%2F27%2F%E4%B8%BA-Databend-Rust-Driver-%E5%AE%9E%E7%8E%B0-Python-Binding%2F</url>
    <content type="text"><![CDATA[HOW? PyO3 + MaturinRust å’Œ Python éƒ½æ‹¥æœ‰ä¸°å¯Œçš„åŒ…å’Œåº“ã€‚åœ¨ Python ä¸­ï¼Œå¾ˆå¤šåŒ…çš„åº•å±‚æ˜¯ä½¿ç”¨ C/C++ ç¼–å†™çš„ï¼Œè€Œ Rust å¤©ç”Ÿä¸Ž C å…¼å®¹ã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ Rust ä¸º Python ç¼–å†™è½¯ä»¶åŒ…ï¼Œå®žçŽ° Python è°ƒç”¨ Rust çš„åŠŸèƒ½ï¼Œä»Žè€ŒèŽ·å¾—æ›´å¥½çš„æ€§èƒ½å’Œé€Ÿåº¦ã€‚ ä¸ºäº†å®žçŽ°è¿™ä¸€ç›®æ ‡ï¼ŒPyO3 åº”è¿è€Œç”Ÿã€‚PyO3 ä¸ä»…æä¾›äº† Rust ä¸Ž Python çš„ç»‘å®šåŠŸèƒ½ï¼Œè¿˜æä¾›äº†ä¸€ä¸ªåä¸º maturin çš„å¼€ç®±å³ç”¨çš„è„šæ‰‹æž¶å·¥å…·ã€‚é€šè¿‡ maturinï¼Œæˆ‘ä»¬å¯ä»¥æ–¹ä¾¿åœ°åˆ›å»ºåŸºäºŽ Rust å¼€å‘çš„ Python æ‰©å±•æ¨¡å—ã€‚è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å¯ä»¥é‡æ–°ç»„ç»‡ä»£ç ï¼Œä½¿ç”¨ Rust ç¼–å†™æ€§èƒ½æ›´å¥½çš„éƒ¨åˆ†ï¼Œè€Œå…¶ä½™éƒ¨åˆ†ä»ç„¶å¯ä»¥ä½¿ç”¨åŽŸå§‹çš„ Python ä»£ç ã€‚ Databend ç›®å‰æœ‰é’ˆå¯¹ Rustã€Goã€Pythonã€Java çš„å¤šå¥— Driver SDKï¼Œç»´æŠ¤æˆæœ¬é¢‡é«˜ï¼Œä¸Šæ¸¸ä¸€æ—¦å‡ºçŽ°æ›´æ–° SDK ä¾¿ä¼šæ‰‹å¿™è„šä¹±ã€‚ Rust èƒ½æä¾›å¯¹å…¶ä»–è¯­è¨€çš„ Binding å®žçŽ°ä¸€å¥—ä»£ç åˆ°å¤„ä½¿ç”¨ï¼Œè€Œä¸”åˆèƒ½èŽ·å¾—æ›´å¥½åœ°æ€§èƒ½å’Œé€Ÿåº¦ï¼Œä½•ä¹è€Œä¸ä¸ºå‘¢ï¼Ÿ æœ¬ç¯‡æ–‡ç« æˆ‘ä»¬å…³æ³¨å¦‚ä½•åœ¨ python ä¸­è°ƒç”¨ Rust å¼€å‘çš„æ¨¡å—ï¼Œä»¥æ­¤æ¥ä¸º Databend Rust Driver å®žçŽ° Python Bindingã€‚ ç®€å•çš„ Demoè¿™é‡Œæˆ‘ä»¬ä»¥å®˜ç½‘æä¾›çš„æœ€ç®€å•çš„æ–¹å¼æ¥åšä¸ªæ¼”ç¤ºã€‚ 1234567891011$ mkdir string_sum$ cd string_sum# åˆ›å»º venv çš„è¿™ä¸€æ­¥ä¸èƒ½çœç•¥ï¼Œå¦åˆ™åŽç»­è¿è¡Œçš„æ—¶å€™ä¼šæŠ¥é”™$ python -m venv .env$ source .env/bin/activate$ pip install maturin# ç›´æŽ¥ä½¿ç”¨ maturin åˆå§‹åŒ–é¡¹ç›®å³å¯ï¼Œé€‰æ‹© pyo3ï¼Œæˆ–è€…ç›´æŽ¥æ‰§è¡Œ maturin init --bindings pyo3â¯ maturin initâœ” ðŸ¤· Which kind of bindings to use? ðŸ“– Documentation: https://maturin.rs/bindings.html Â· pyo3 âœ¨ Done! Initialized project /Users/hanshanjie/rustProj/string_sum è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä¸€ä¸ªç®€å•çš„ Rust é¡¹ç›®ï¼Œå¹¶ä¸”åŒ…å«äº†è°ƒç”¨çš„ç¤ºä¾‹ï¼Œæ‰“å¼€ src/lib.rsï¼š 1234567891011121314use pyo3::prelude::*;/// Formats the sum of two numbers as string.#[pyfunction]fn sum_as_string(a: usize, b: usize) -&gt; PyResult&lt;String&gt; &#123; Ok((a + b).to_string())&#125;/// A Python module implemented in Rust.#[pymodule]fn string_sum(_py: Python, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; &#123; m.add_function(wrap_pyfunction!(sum_as_string, m)?)?; Ok(())&#125; å¯ä»¥çœ‹åˆ° pyfunction å’Œ pymodule ä¸¤ä¸ª Rust çš„å®ï¼Œ#[pymodule] è¿‡ç¨‹å®å±žæ€§è´Ÿè´£å°†æ¨¡å—çš„åˆå§‹åŒ–å‡½æ•°å¯¼å‡ºåˆ°Pythonã€‚å®ƒå¯ä»¥æŽ¥å—æ¨¡å—çš„åç§°ä½œä¸ºå‚æ•°ï¼Œè¯¥åç§°å¿…é¡»æ˜¯.soæˆ–.pydæ–‡ä»¶çš„åç§°ï¼›é»˜è®¤å€¼ä¸ºRustå‡½æ•°çš„åç§°ã€‚#[pyfunction] æ³¨é‡Šä¸€ä¸ªå‡½æ•°ï¼Œç„¶åŽä½¿ç”¨ wrap_pyfunction å®å°†å…¶æ·»åŠ åˆ°åˆšåˆšå®šä¹‰çš„æ¨¡å—ä¸­ã€‚ æˆ‘ä»¬æ— éœ€ä¿®æ”¹ä»»ä½•ä»£ç ï¼Œå¯ä»¥ç›´æŽ¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤æµ‹è¯•ï¼š 123456# maturin develop ä¼šè‡ªåŠ¨æ‰“åŒ…å‡ºä¸€ä¸ª wheel åŒ…ï¼Œå¹¶ä¸”å®‰è£…åˆ°å½“å‰çš„ venv ä¸­ $ maturin develop$ python&gt;&gt;&gt; import string_sum&gt;&gt;&gt; string_sum.sum_as_string(5, 20)'25' æž„å»º Databend Driver çš„ Python Bindingåˆå§‹åŒ–é¡¹ç›®åœ¨ bendsql æ ¹ç›®å½•ä¸‹åˆ›å»º bindings/pythonçš„ rust é¡¹ç›®ï¼š 12345678$ cd bendsql $ mkdir bindings &amp; cd bindings$ mkdir python &amp; cd python$ python -m venv .env$ source .env/bin/activate$ pip install maturin# ç›´æŽ¥ä½¿ç”¨ maturin åˆå§‹åŒ–é¡¹ç›®å³å¯ï¼Œé€‰æ‹© pyo3â¯ maturin init ä¸ºäº†ä½¿ç”¨PyO3ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶ä½œä¸ºä¾èµ–é¡¹æ·»åŠ åˆ°æˆ‘ä»¬çš„Cargo.tomlæ–‡ä»¶ä¸­ï¼Œä»¥åŠå…¶ä»–ä¾èµ–é¡¹ã€‚æˆ‘ä»¬çš„Cargo.tomlæ–‡ä»¶åº”è¯¥å¦‚ä¸‹æ‰€ç¤ºï¼š 12345678910111213141516171819[package]name = "databend-python"version = "0.0.1"edition = "2021"license = "Apache-2.0"publish = false[lib]crate-type = ["cdylib"]doc = false[dependencies]chrono = &#123; version = "0.4.24", default-features = false, features = ["std"] &#125;futures = "0.3.28"databend-driver = &#123; path = "../../driver", version = "0.2.20", features = ["rustls", "flight-sql"] &#125;databend-client = &#123; version = "0.1.15", path = "../../core" &#125;pyo3 = &#123; version = "0.18", features = ["abi3-py37"] &#125;pyo3-asyncio = &#123; version = "0.18", features = ["tokio-runtime"] &#125;tokio = "1" PyO3 æ·»åŠ ä¸ºä¾èµ–é¡¹ï¼Œå¹¶ä½¿ç”¨é€‚å½“çš„å±žæ€§æ³¨è§£ Rust å‡½æ•°ï¼ˆæˆ‘ä»¬å°†åœ¨åŽé¢ä»‹ç»ï¼‰ï¼Œå°±å¯ä»¥ä½¿ç”¨ PyO3 åº“åˆ›å»ºä¸€ä¸ªå¯ä»¥è¢«å¯¼å…¥åˆ° Python è„šæœ¬ä¸­çš„ Python æ‰©å±•æ¨¡å—ã€‚ å°† Rust Struct è½¬æ¢æˆ Python æ¨¡å—databend-client ä¸­æä¾›äº†ä¸¤ç§è¿žæŽ¥åˆ° databend çš„æ–¹å¼ï¼ŒflightSQL å’Œ httpï¼Œ databend-driver package å®žçŽ°äº†ä¸€ä¸ª Traitæ¥ç»Ÿä¸€å…¥å£å¹¶è‡ªåŠ¨è§£æžåè®®ï¼š bendsql/driver/src/conn.rs 12345678910111213141516171819202122232425262728293031#[async_trait]pub trait Connection: DynClone + Send + Sync &#123; fn info(&amp;self) -&gt; ConnectionInfo; async fn version(&amp;self) -&gt; Result&lt;String&gt; &#123; let row = self.query_row("SELECT version()").await?; let version = match row &#123; Some(row) =&gt; &#123; let (version,): (String,) = row.try_into()?; version &#125; None =&gt; "".to_string(), &#125;; Ok(version) &#125; async fn exec(&amp;self, sql: &amp;str) -&gt; Result&lt;i64&gt;; async fn query_row(&amp;self, sql: &amp;str) -&gt; Result&lt;Option&lt;Row&gt;&gt;; async fn query_iter(&amp;self, sql: &amp;str) -&gt; Result&lt;RowIterator&gt;; async fn query_iter_ext(&amp;self, sql: &amp;str) -&gt; Result&lt;(Schema, RowProgressIterator)&gt;; async fn stream_load( &amp;self, sql: &amp;str, data: Reader, size: u64, file_format_options: Option&lt;BTreeMap&lt;&amp;str, &amp;str&gt;&gt;, copy_options: Option&lt;BTreeMap&lt;&amp;str, &amp;str&gt;&gt;, ) -&gt; Result&lt;QueryProgress&gt;;&#125;dyn_clone::clone_trait_object!(Connection); æ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†è¯¥ Trait è½¬æ¢æˆ Python class ï¼Œå°±èƒ½åœ¨ python ä¸­è°ƒç”¨è¿™äº›æ–¹æ³•ã€‚Pyo3 å®˜ç½‘ä¸­æä¾›äº†è½¬æ¢ Trait çš„æ–¹å¼ï¼Œhttps://pyo3.rs/v0.12.3/trait_boundsï¼Œä½†æ˜¯è¿™ç§æ–¹å¼è¿‡äºŽå¤æ‚ï¼Œéœ€è¦å†™å¤ªå¤šçš„èƒ¶æ°´ä»£ç ï¼Œè€Œä¸”å¯¹ç”¨æˆ·ä¹Ÿä¸å‹å¥½ï¼Œä¸èƒ½åšåˆ°å¼€ç®±å³ç”¨ã€‚å·¦æ€å³æƒ³ï¼Œä¸ºä½•ä¸å°† Trait å°è£…ä¸€ä¸ª Struct ç„¶åŽå°† Struct ç›´æŽ¥å°†è½¬æ¢æˆ python module ï¼Ÿ 1234567891011121314151617#[derive(Clone)]pub struct Connector &#123; pub connector: FusedConnector,&#125;pub type FusedConnector = Arc&lt;dyn Connection&gt;;// For bindingsimpl Connector &#123; pub fn new_connector(dsn: &amp;str) -&gt; Result&lt;Box&lt;Self&gt;, Error&gt; &#123; let conn = new_connection(dsn).unwrap(); let r = Self &#123; connector: FusedConnector::from(conn), &#125;; Ok(Box::new(r)) &#125;&#125; è¿™é‡Œå†™äº†ä¸€ä¸ª Connector çš„ structï¼Œé‡Œé¢å°è£…äº† Connection Traitï¼Œä¸º Connector å®žçŽ°äº† new_connector æ–¹æ³•ï¼Œè¿”å›žçš„æ­£æ˜¯ä¸€ä¸ªæŒ‡å‘ Connector çš„æŒ‡é’ˆï¼Œæ›´å¤šä»£ç å¯ä»¥çœ‹è¿™é‡Œ ã€‚ åœ¨ asyncio.rs ä¸­æˆ‘ä»¬å°±å¯ä»¥å®šä¹‰ä¸€ä¸ª Struct AsyncDatabendDriver æš´éœ²ä¸º python classï¼Œå¹¶å®šä¹‰ python module ä¸º databend-driver: 123/// `AsyncDatabendDriver` is the entry for all public async API#[pyclass(module = "databend_driver")]pub struct AsyncDatabendDriver(Connector); æŽ¥ä¸‹æ¥å°±è¦ä¸º AsyncDatabendDriver å®žçŽ°ç›¸åº”çš„æ–¹æ³•ï¼Œè€Œåº•å±‚è°ƒç”¨çš„å°±æ˜¯ rust ä¸­å®žçŽ°çš„ Trait ä¸­çš„æ–¹æ³•ï¼ˆè¿™é‡Œä»¥ exec ä¸ºä¾‹ï¼‰ï¼š 123456789101112131415161718#[pymethods]impl AsyncDatabendDriver &#123; #[new] #[pyo3(signature = (dsn))] pub fn new(dsn: &amp;str) -&gt; PyResult&lt;Self&gt; &#123; Ok(AsyncDatabendDriver(build_connector(dsn)?)) &#125; /// exec pub fn exec&lt;'p&gt;(&amp;'p self, py: Python&lt;'p&gt;, sql: String) -&gt; PyResult&lt;&amp;'p PyAny&gt; &#123; let this = self.0.clone(); future_into_py(py, async move &#123; // è°ƒç”¨ connection ä¸­çš„ exec æ–¹æ³• let res = this.connector.exec(&amp;sql).await.unwrap(); Ok(res) &#125;) &#125; &#125; æœ€åŽåœ¨ lib.rs ä¸­å°† AsyncDatabendDriver æ·»åŠ ä¸º python class: 12345#[pymodule]fn _databend_driver(_py: Python, m: &amp;PyModule) -&gt; PyResult&lt;()&gt; &#123; m.add_class::&lt;AsyncDatabendDriver&gt;()?; Ok(())&#125; å®šä¹‰ python æ‰©å±•æ¨¡å—ä¿¡æ¯åˆ›å»º pyproject.toml å’Œ python/databend_driver å¹¶å®šä¹‰ python module ç›¸å…³ä¿¡æ¯ã€‚ æµ‹è¯•è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ behave è¿›è¡Œæµ‹è¯•ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°èƒ½å¤Ÿä»¥ import databend_driver çš„å½¢å¼åœ¨ python é¡¹ç›®ä¸­ä½¿ç”¨ï¼š 1234567Feature: Databend-Driver Binding Scenario: Databend-Driver Async Operations Given A new Databend-Driver Async Connector When Async exec "CREATE TABLE if not exists test_data (x Int32,y VARCHAR)" When Async exec "INSERT INTO test_data(x,y) VALUES(1,'xx')" Then The select "SELECT * FROM test_data" should run 123456789101112131415161718192021import osfrom behave import given, when, thenfrom behave.api.async_step import async_run_until_completeimport databend_driver@given("A new Databend-Driver Async Connector")@async_run_until_completeasync def step_impl(context): dsn = os.getenv("TEST_DATABEND_DSN", "databend+http://root:root@localhost:8000/?sslmode=disable") context.ad = databend_driver.AsyncDatabendDriver(dsn)@when('Async exec "&#123;sql&#125;"')@async_run_until_completeasync def step_impl(context, sql): await context.ad.exec(sql)@then('The select "&#123;select_sql&#125;" should run')@async_run_until_completeasync def step_impl(context, select_sql): await context.ad.exec(select_sql) è¿è¡Œ maturin develop ä¼šè‡ªåŠ¨æ‰“åŒ…å‡ºä¸€ä¸ª wheel åŒ…ï¼Œå¹¶ä¸”å®‰è£…åˆ°å½“å‰çš„ venv ä¸­ ï¼Œ 1234 .... Finished dev [unoptimized + debuginfo] target(s) in 8.71sðŸ“¦ Built wheel for abi3 Python â‰¥ 3.7 to /var/folders/x5/4hndsx0x7cb5_45qgpfqx4th0000gn/T/.tmpyzRsUc/databend_driver-0.0.1-cp37-abi3-macosx_11_0_arm64.whlðŸ›  Installed databend-driver-0.0.1 æ‰§è¡Œ behave tests è¿è¡Œæµ‹è¯•é›†: ç»“è®ºåŸºäºŽ Pyo3ï¼Œæˆ‘ä»¬å¯ä»¥æ¯”è¾ƒæ–¹ä¾¿åœ°ä¸“æ³¨äºŽ Rust å®žçŽ°é€»è¾‘æœ¬èº«ï¼Œæ— éœ€å…³æ³¨å¤ªå¤š FFI ï¼ˆForeign Function Interfaceï¼‰å’Œè½¬æ¢ç»†èŠ‚å°±å¯ä»¥å°† Rust ä½Žæˆæœ¬åœ°è½¬æ¢æˆ Python æ¨¡å—ï¼ŒåŽæœŸä¹Ÿåªéœ€è¦ç»´æŠ¤ä¸€å¥—ä»£ç ï¼Œæžå¤§åœ°é™ä½Žäº†ç»´æŠ¤æˆæœ¬ã€‚æœ¬æ–‡ç« æŠ›ç –å¼•çŽ‰ï¼Œåªæ˜¯å°†å¾ˆå°‘éƒ¨åˆ†ä»£ç åšäº†è½¬æ¢ï¼ŒåŽé¢ä¼šé™†ç»­å°† rust driver å…¨éƒ¨æä¾› Python binding æœ€ç»ˆæ›¿æ¢æŽ‰çŽ°åœ¨çš„ databend-pyã€‚ HTML â€‹â€‹â€‹â€‹â€‹â€‹ â€‹]]></content>
      <categories>
        <category>rust</category>
      </categories>
      <tags>
        <tag>databend</tag>
        <tag>rust</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2023 12 Open Source weekly report]]></title>
    <url>%2F2023%2F03%2F17%2F2023-12-Open-Source-weekly-report%2F</url>
    <content type="text"><![CDATA[ä¸å‡ºæ„å¤–è¿™æ˜¯ 2023 å¹´ç¬¬ä¸€ä»½å‘¨æŠ¥ï¼Œä¸€ç›´æ‹–ç€ä¸å†™å€’ä¸æ˜¯å› ä¸ºæ²¡ä»€ä¹ˆå¯å†™çš„ï¼Œåè€Œæ˜¯å› ä¸ºæœ€è¿‘è¿™å‡ ä¸ªæœˆæŽ¥æ”¶çš„ä¿¡æ¯é‡å¤ªå¤§ï¼Œä¸€æ—¶é—´æ²¡æœ‰åŠžæ³•åƒé€ã€ç†è§£ï¼Œè‡ªç„¶å°±æ— æ³•åšåˆ°æœ‰æ•ˆè¾“å‡ºã€‚é™¤äº†å¸¸è§„çš„å·¥ä½œä»¥å¤–ï¼Œè¿™æ®µæ—¶é—´å¼€å§‹æŽ¥è§¦ ELT ç›¸å…³çš„ä¸œè¥¿ï¼Œæ¯”å¦‚ Airbyteã€dbtï¼ŒCDC é¢†åŸŸä¸­çš„ TapDataã€Flink CDC ï¼Œå®Œå–„ databend åœ¨ BI ç±»å·¥å…·çš„ç”Ÿæ€â€¦.æ¯”å¦‚ superset, redash, metadata ç­‰ï¼Œä¿¡æ¯é‡å¯ä»¥è¯´æ˜¯çˆ†ç‚¸å¼å¢žé•¿ï¼Œå¾ˆå¤šä¸œè¥¿ä¹Ÿæ˜¯ä¸€çŸ¥åŠè§£çš„ã€‚ è¿™å‘¨ä¹‹æ‰€ä»¥æƒ³èµ·æ¥å†™æ˜¯å› ä¸ºå†™äº†ä¸€ç‚¹æ¯”è¾ƒæœ‰æ„æ€çš„æ–°ä¸œè¥¿ï¼Œæ‰€ä»¥æƒ³è®°å½•å¹¶åˆ†äº«ä¸€ä¸‹ã€‚ Clojure &amp; Metabaseæ˜¯çš„ä½ æ²¡çœ‹é”™ï¼Œè¿™å‘¨ä¸€ç›´åœ¨å†™ Clojureã€‚èµ·å› æ˜¯è¦åœ¨ Metabase ä¸­æ”¯æŒ databendï¼Œmetabase æ˜¯ä¸€æ¬¾æ˜“ç”¨ã€å¼€æºã€æŠ€æœ¯æˆç†Ÿã€ä¸æ–­å¹¶å¿«é€Ÿè¿­ä»£çš„ BI å·¥å…·ï¼Œæ‰“å¼€ metabase çš„ Github é¦–é¡µ å¯ä»¥çœ‹åˆ°å…¶ä¸»è¦æ˜¯ç¼–ç¨‹è¯­è¨€æ­£æ˜¯ Clojureã€‚ å¾ˆå¤šå¹´è½»çš„æœ‹å‹å¯èƒ½éƒ½æ²¡å¬è¯´è¿‡è¿™é—¨ç¼–ç¨‹è¯­è¨€ã€‚Clojure æ˜¯ä¸€ç§è¿è¡Œåœ¨Javaå¹³å°ä¸Šçš„ç±» Lisp è¯­è¨€ï¼Œçœ‹åˆ° Lisp æ˜¯ä¸æ˜¯ä¸€ç§ä¸Šå¤çš„æ°”æ¯æ‰‘é¢è€Œæ¥ã€‚Clojure æ¯”è¾ƒæˆåŠŸåœ°æŠŠå‡½æ•°å¼ç¼–ç¨‹å¼•å…¥äº† JVMï¼Œåœ¨JVMå¹³å°è¿è¡Œçš„æ—¶å€™ï¼Œä¼šè¢«ç¼–è¯‘ä¸ºJVMçš„å­—èŠ‚ç è¿›è¡Œè¿ç®—ã€‚å…¶æœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯åœ¨ä¿æŒäº†å‡½æ•°å¼è¯­è¨€çš„ä¸»è¦ç‰¹æ€§çš„å‰æä¸‹ï¼Œä¾‹å¦‚immutable stateï¼ŒFull Lisp-style macro supportï¼Œpersistent data structuresç­‰ç­‰ï¼Œè¿˜èƒ½å¤Ÿéžå¸¸æ–¹ä¾¿çš„è°ƒç”¨Javaç±»åº“çš„APIï¼Œå’ŒJavaç±»åº“è¿›è¡Œè‰¯å¥½çš„æ•´åˆã€‚ Metabase æä¾›äº†ä¸€ç§æ’ä»¶ç³»ç»Ÿï¼Œæ–¹ä¾¿å¼€å‘è€…ä»¥å¼€å‘æ’ä»¶çš„æ–¹å¼ï¼Œå°†æ•°æ®æºæ·»åŠ åˆ° metabase ä¸­ï¼Œå› ä¸ºè¦è°ƒç”¨ metabase driver çš„ APIï¼Œæ‰€ä»¥æ’ä»¶çš„ç¼–å†™ä¹Ÿéœ€è¦ä½¿ç”¨ Clojure æ¥å®Œæˆã€‚ ä¸Šæ‰‹ Clojure Clojure æ˜¯å®Œå…¨çš„å‡½æ•°å¼ç¼–ç¨‹ï¼ŒåŸºæœ¬è¯­æ³•æ¯”è¾ƒç®€å•ï¼Œå¤§æ¦‚çœ‹äº†åŠå¤©çš„æ•™ç¨‹é…ç½®å¥½å¼€å‘çŽ¯å¢ƒå°±èƒ½å†™ hello world äº†ã€‚A few days laterâ€¦.ï¼Œæ”¯æŒ databend çš„ metabase æ’ä»¶å°±å®Œæˆäº†ï¼Œé¡¹ç›®åŠç›¸å…³ä»£ç åœ¨ metabase databend driver ã€‚ æ’ä»¶ä½¿ç”¨Metabase çš„æ’ä»¶ä½¿ç”¨èµ·æ¥éžå¸¸æ–¹ä¾¿ï¼Œåªéœ€è¦ä¸¤ä¸ª jar å°±èƒ½ä»Ž databend è¯»å–å¹¶åˆ†æžæ•°æ®å‡ºæŠ¥è¡¨äº†ã€‚ Download metabase.jarMetabaseæ˜¯ä¸€ä¸ªJavaåº”ç”¨ç¨‹åºï¼Œå¯ä»¥é€šè¿‡ä¸‹è½½JARæ–‡ä»¶ å¹¶æ‰§è¡Œ java -jar metabase.jaræ¥è¿è¡Œã€‚Metabase ä½¿ç”¨ JDBC Driver è¿žæŽ¥åˆ° Databendã€‚ Download metabase Databend Driver åœ¨ä¸‹è½½ metabase.jar çš„ç›®å½•ä¸‹åˆ›å»ºç›®å½• plugins 123$ lsmetabase.jar$ mkdir plugins ä¸‹è½½æœ€æ–°çš„ databend metabase driver: https://github.com/databendcloud/metabase-databend-driver/releases/latest åˆ° plugins ç›®å½•ä¸‹ å¯åŠ¨ metabase 1java -jar metabase.jar å¯åŠ¨è¿‡ç¨‹ä¸­çœ‹åˆ°ä¸‹é¢çš„æ—¥å¿—å°±è¡¨ç¤º databend é©±åŠ¨è¢«æ­£å¸¸åŠ è½½: 122019-05-07 23:27:32 INFO plugins.lazy-loaded-driver :: Registering lazy loading driver :databend...2019-05-07 23:27:32 INFO metabase.driver :: Registered driver :databend (parents: #&#123;:sql-jdbc&#125;) ðŸšš è®¿é—® http://hostname:3000 å³å¯æ‰“å¼€ metabase é¦–é¡µ Connect Metabase to Databend å¡«å†™åŸºæœ¬ä¿¡æ¯ï¼Œé€‰æ‹© I&#39;ll add my data later ç‚¹å‡»Add your own data åˆ›å»º databend æ•°æ®åº“è¿žæŽ¥ é€‰æ‹© databend (databend version &gt;=DatabendQuery v1.0.17) å¡«å†™æ•°æ®åº“è¿žæŽ¥ä¿¡æ¯åŽç‚¹å‡»ä¿å­˜ é€€å‡ºåŽå°ç®¡ç† Run a SQL query é€€å‡ºåŽå°ç®¡ç†åŽï¼Œåœ¨å³ä¸Šè§’ï¼Œå•å‡» + New èœå•ï¼Œå¯ä»¥è¿è¡ŒSQLæŸ¥è¯¢å’Œæž„å»ºä»ªè¡¨ç›˜ã€‚ ä¸¾ä¸ª SQL æŸ¥è¯¢çš„ðŸŒ° ç‚¹å‡»å·¦ä¸‹è§’çš„å¯è§†åŒ–æŒ‰é’®å¯ä»¥æž„å»ºä»ªè¡¨ç›˜ Learn moreæœ‰å…³Metabaseä»¥åŠå¦‚ä½•æž„å»ºä»ªè¡¨æ¿çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—® Metabase æ–‡æ¡£ã€‚ ä¸€äº›æ„Ÿå—å†™ Clojure è¿‡ç¨‹ä¸­æ„Ÿå—æœ€æ·±çš„è¿˜æ˜¯åœ†æ‹¬å·æ±‚å€¼ ()ï¼Œå› ä¸º Clojure ä¸­ä»»ä½•è¯­å¥çš„ä¸€èˆ¬å½¢å¼éœ€è¦åœ¨å¤§æ‹¬å·ä¸­æ±‚å€¼ï¼Œå‘ä¸‹é¢è¿™æ ·ï¼š 12345678(+ 1 2) ;è¿ç®—ç¬¦åœ¨å‰------(ns clojure.examples.hello (:gen-class))(defn Example [] (println (str "Hello" "World")) (println (+ 1 2)))(Example) æ‰€ä»¥å½“ä¸€ä¸ªå‡½æ•°æ¯”è¾ƒå¤§è€Œä¸”æœ‰é«˜é˜¶å‡½æ•°çš„æ—¶å€™ï¼Œæ•°æ‹¬å·å°±ä¼šæˆä¸ºä¸€ç§ç¾éš¾ðŸ˜‚ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¸å¾—ä¸ä¾èµ– IDE çš„æç¤ºäº†ã€‚ æœºç¼˜å·§åˆç²—æµ…åœ°äº†è§£äº†è¿™é—¨ç¼–ç¨‹è¯­è¨€ï¼Œä¸è¿‡ç›®å‰æ¥çœ‹ä½¿ç”¨ Clojure ä½œä¸ºä¸»åŠ›å¼€å‘è¯­è¨€çš„å…¬å¸éžå¸¸å°‘ï¼ŒåŠé—´ç”šè‡³ä¸€åº¦ä¼ é—» Clojure is deadã€‚ä½†æ˜¯è¯­è¨€åªæ˜¯å·¥å…·ï¼Œå³ä½¿å·¥ä½œä¸­æ— æ³•ä½¿ç”¨ï¼Œäº†è§£è¿™é—¨ä¼˜é›…ã€å¯Œæœ‰è¡¨çŽ°åŠ›çš„è¯­è¨€æ¥æ‰©å±•è‡ªå·±çš„çœ¼ç•Œï¼Œä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚Clojure ç¤¾åŒºä¹Ÿæœ‰ä¸€äº›æœ‰æ„æ€çš„é¡¹ç›®ï¼Œè¿™é‡ŒæŠ›ç –å¼•çŽ‰ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥åŽ»äº†è§£ä¸€ä¸‹ã€‚ ç´¢æ€§åœ¨è¿™é‡Œè®°å½•è·Ÿè¸ªä¸€ä¸‹æœ€è¿‘çš„ä¸€äº›è·Ÿå¼€æºç›¸å…³çš„å·¥ä½œ tapdata/tapdata ðŸŽ‰ New connector: databend clickvisual/clickvisual Feat: support databend source getredash/redash feat: New support databend for redash apache/superset feat: support databend for superset airbytehq/airbyte ðŸŽ‰ New source connector: databend metabase-databend-driver flink-connector-databend]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 51 Open source weekly report]]></title>
    <url>%2F2022%2F12%2F17%2F2022-51-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[è·ç¦»ä¸Šä¸€æ¬¡ weekly report å·²ç»è¿‡åŽ»æ•´æ•´ä¸€ä¸ªæœˆï¼Œåœ¨ databend-pyã€databend-sqlalchemy åŸºæœ¬å¯ç”¨çš„å‰æä¸‹æˆ‘å¼€å§‹ç€æ‰‹åœ¨ dbt çš„ç”Ÿæ€ä¸­æ”¯æŒ databend cloudã€‚dbt æä¾›äº†ä¸€ç§æ’ä»¶ç”Ÿæ€ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å‘ä¸“æœ‰çš„ adapter plugin ä»Žè€Œå°† DBT æ‰©å±•åˆ°ä»»ä½•æ•°æ®å¹³å°ã€‚dbt ç®—æ˜¯åœ¨æ•°æ®é¢†åŸŸçš„æ–°ç‰©ç§ï¼Œåœ¨å›½å†…æ„Ÿè§‰ç”¨çš„è¿˜ä¸æ˜¯å¾ˆå¤šï¼Œä½†æ˜¯åœ¨å›½å¤–å·²ç»ä¿¨ç„¶æˆä¸ºçŽ°ä»£æ•°æ®é¢†åŸŸçš„åŽèµ·ä¹‹ç§€ã€‚æ‰€ä»¥ä¸‹é¢å…ˆæŠ›ç –å¼•çŽ‰ï¼Œç®€å•ä»‹ç»ä¸€ä¸‹ dbtã€‚ What is dbt?dbt æ˜¯ä¸€ä¸ªéžå¸¸å¼ºå¤§å’Œçµæ´»çš„æ•°æ®å·¥å…·ï¼Œå®ƒå¯ä»¥å¿«é€Ÿæž„å»ºæ•°æ® pipeã€åŸºäºŽ jinjia æ¨¡æ¿ä»¥è‡ªåŠ¨æµ‹è¯•ã€æž„å»ºå’Œå¡«å……åˆ†æžæ¨¡åž‹ï¼ŒåŒ…æ‹¬æ–‡æ¡£çš„è‡ªåŠ¨ç”Ÿæˆå’Œå¼€ç®±å³ç”¨çš„æ•°æ®è¡€ç¼˜ï¼Œéžå¸¸é€‚åˆè‡ªåŠ¨åŒ–æ•°ä»“çš„å·¥ä½œã€‚å…¶æ ¸å¿ƒä»£ç æ˜¯ä¸€ä¸ªå¼€æº Python åº“ - dbt-core ã€‚å¯ä»¥å‚è€ƒè¿™ä¸ªé¡¹ç›®å¿«é€Ÿä¸Šæ‰‹ä½“éªŒä¸€ä¸‹ã€‚ éœ€è¦å¼ºè°ƒçš„ä¸€ç‚¹æ˜¯ dbt å¹¶ä¸æ˜¯ä¼ ç»Ÿçš„ ETL å·¥å…·ï¼Œ å®ƒå¹¶ä¸åœ¨ç³»ç»Ÿä¹‹é—´ä¼ è¾“æˆ–è€…åŠ è½½æ•°æ®ï¼Œè€Œæ˜¯é€šè¿‡ä½¿ç”¨ SQL å’Œ YAML æ¥è½¬æ¢å·²ç»è¢«åŠ è½½åˆ°æ•°ä»“ä¸­çš„æ•°æ®ã€‚è¿™ç§å…ˆåŠ è½½åŽè½¬æ¢çš„æ¦‚å¿µï¼Œç§°ä¸º ELTã€‚ åœ¨ ELT çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®æ— é¡»ç­‰å¾…å³å¯è¿›å…¥æ•°ä»“ï¼Œè½¬æ¢å‡ºçŽ°é”™è¯¯ä¹Ÿä¸éœ€è¦é‡æ–°åŠ è½½ï¼Œèƒ½å¤Ÿæé«˜æ•ˆçŽ‡å¹¶é™ä½Žæˆæœ¬ã€‚ä¸‹é¢æˆ‘ä¹Ÿä¼šä»‹ç»ä¸€ä¸ª EL çš„å·¥å…· - airbyteï¼Œçœ‹ airbyte + dbt å¦‚ä½•å®žçŽ°å®Œç¾Žçš„ ELT æµç¨‹ã€‚å…³äºŽ dbt çš„ä»‹ç»å°±åˆ°è¿™é‡Œï¼Œæƒ³è¦æ·±å…¥äº†è§£çš„åŒå­¦å¯ä»¥å‚è€ƒ dbt å®˜ç½‘å’Œ dbt-core çš„ github ä¸»é¡µã€‚ How to use dbt with Databend Cloudç»è¿‡å‡ å‘¨ä¸Ž dbt çš„ææ–—ï¼Œæ”¯æŒ databend çš„ dbt adapter æ’ä»¶ dbt-databend-cloud ç»ˆäºŽèƒ½å¤Ÿè·‘é€šå®˜æ–¹çš„ case äº†âœ¿âœ¿ãƒ½(Â°â–½Â°)ãƒŽâœ¿ã€‚å¼€å‘çš„è¿‡ç¨‹ä¸­ä¹Ÿå¸® databend æœ¬èº«å‘çŽ°å¹¶è§£å†³äº†ä¸€äº›é—®é¢˜: IssueFeature: support a.* in SQL Feature: support || concat function in SQL Feature: support SQL-style double-quoted identifier in get_path PRfix: double-quote in get_path æœŸé—´ä¹Ÿæœ‰è·Ÿ dbt ç¤¾åŒºçš„è®¨è®ºï¼Œéžå¸¸æ„Ÿè°¢ dbt ç¤¾åŒºçš„çƒ­å¿ƒå¸®åŠ©: DisscussionField â€œpathâ€ of type Path in DatabendRelation has invalid value æˆ‘ä»¬å¯ä»¥è·Ÿç€è¿™ä¸ª wiki - How to use dbt with Databend Cloud ä½“éªŒä¸€ä¸‹ dbt çš„å¼ºå¤§èƒ½åŠ›ï¼Œå¸Œæœ›åŽé¢èƒ½é¡ºåˆ©å°† dbt-databend åŠ å…¥åˆ°å®˜æ–¹ dbt-adapters çš„ç»´æŠ¤é˜µè¥å½“ä¸­åŽ»ã€‚ What is airbyte?ä¸Šé¢æˆ‘ä»¬ä»‹ç» ELT çš„æ—¶å€™æåˆ°è¿‡ airbyteï¼Œè¿™é‡Œå†å±•å¼€ä»‹ç»ä¸€ä¸‹ã€‚Airbyte æ˜¯ä¸€ä¸ªå¼€æºçš„äº‘åŽŸç”Ÿæ•°æ®é›†æˆå¹³å°ï¼Œå¯ä»¥è®©ç”¨æˆ·ä»Žå„ç§æ¥æºæå–ã€è½¬æ¢å’ŒåŠ è½½æ•°æ®åˆ°å„ç§ç›®æ ‡ã€‚ airbyte çš„æž¶æž„è®¾è®¡æ˜“äºŽæ‰©å±•ï¼Œéžå¸¸çµæ´»ï¼Œå…è®¸ç”¨æˆ·å¼€å‘è‡ªå®šä¹‰çš„ source/destination connector ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿åœ°åŠ å…¥åˆ° airbyte çš„å¹³å°é‡Œã€‚è¿™é‡Œæˆ‘ä¸»è¦æ˜¯å¼€å‘äº†ä¸€ä¸ª destination connectorï¼Œå°† databend cloud ä½œä¸ºæ•°æ®çš„ç›®çš„å…¥å£ï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥å¾ˆå®¹æ˜“åœ°ä»Žå„ä¸ªæ•°æ®æºï¼Œæ¯”å¦‚ S3, Clickhouse, Filebot ï¼Œç”šè‡³æœ¬åœ°æ–‡ä»¶åŒæ­¥æ•°æ®åˆ° databend cloudï¼Œå¹¶ä¸” airbyte çš„ Normalization èƒ½åŠ›ç»“åˆ dbt åŽèƒ½å¤Ÿå°†åŽŸå§‹æ•°æ®è½¬æ¢æˆå®Œæ•´è¡¨ç»“æž„çš„æ•°æ®è¡¨ã€‚ ç­‰è¿™ä¸ª PR åˆå¹¶åŽå°±å¯ä»¥åœ¨ airbyte cloud ä¸Šä½¿ç”¨ databend cloud ä½œä¸º data source äº†ã€‚ ClickVisual æ”¯æŒ databend sourceClickVisual æ˜¯ä¸€ä¸ªè½»é‡çº§çš„ç”±çŸ³å¢¨æ–‡æ¡£å¼€æºçš„æ—¥å¿—æŸ¥è¯¢ã€åˆ†æžã€æŠ¥è­¦çš„å¯è§†åŒ–å¹³å°ï¼Œæä¾›ä¸€ç«™å¼åº”ç”¨å¯é æ€§çš„å¯è§†åŒ–çš„è§£å†³æ–¹æ¡ˆã€‚æ—¢å¯ä»¥ç‹¬ç«‹éƒ¨ç½²ä½¿ç”¨ï¼Œä¹Ÿå¯ä½œä¸ºæ’ä»¶é›†æˆåˆ°ç¬¬ä¸‰æ–¹ç³»ç»Ÿã€‚ç›®å‰æ˜¯å¸‚é¢ä¸Šå”¯ä¸€ä¸€æ¬¾æ”¯æŒ ClickHouse çš„ç±» Kibana çš„ä¸šåŠ¡æ—¥å¿—æŸ¥è¯¢å¹³å°ã€‚ä¹‹å‰ ClickVisual åªæ”¯æŒ Clickhouse ä½œä¸ºæ•°æ®æºæ¥å­˜å‚¨ã€æŸ¥è¯¢æ—¥å¿—ï¼Œæˆ‘æ·»åŠ äº†ä¸€äº›ä»£ç ç»è¿‡è°ƒè¯•åŽçŽ°åœ¨ä¹Ÿèƒ½æ”¯æŒ databend cloud ä½œä¸ºæ•°æ®æºã€‚ Feat: support databend source feat: support exist log table for databend ä½†æ˜¯ç”±äºŽç›®å‰ databend ä¸æ”¯æŒç±»ä¼¼ Clickhouse status=&#39;200&#39; ( status æ˜¯ int32 ç±»åž‹) è¿™æ ·çš„è¯­æ³•ï¼Œæ‰€ä»¥å­—æ®µè¿‡æ»¤æŸ¥è¯¢çš„åŠŸèƒ½éœ€è¦ç­‰è¿™ä¸ª issue-836 è§£å†³åŽæ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚ Openkruise é—ç•™ PRè¯´èµ·æ¥çœŸæ˜¯éžå¸¸æƒ­æ„§ï¼Œä¸ä»…å·²ç»å¾ˆä¹…æ²¡æœ‰å‚åŠ  OpenKruise çš„åŒå‘¨ä¼šäº†è€Œä¸”è¿˜é—ç•™äº†ä¸€ä¸ªé™ˆå¹´è€ PR æ²¡æœ‰å®Œæˆï¼Œå…¶å®žä¸¤å‘¨å‰ zmberg å°±è”ç³»æˆ‘å°½å¿«å¤„ç†ä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥è¿™å‘¨æ— è®ºå¦‚ä½•ä¹Ÿè¦æŠŠè¿™ä¸ª PR å…³æŽ‰ ðŸ˜­ã€‚ ç»¼ä¸Šï¼Œå¸Œæœ› 2022 çš„æœ€åŽä¸¤å‘¨å·¥ä½œé¡ºåˆ©ðŸŽ‰ã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 47 Open source weekly report]]></title>
    <url>%2F2022%2F11%2F13%2F2022-47-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[è‡ªä»Ž databend-go release åŽï¼Œæœ€è¿‘å¤§éƒ¨åˆ†æ—¶é—´éƒ½åœ¨ä¸Ž Python ææ–—ðŸ˜‚ï¼Œå¤ªé•¿æ—¶é—´æ²¡æœ‰æ­£å„¿å…«ç»å†™ Python äº†çœŸæ˜¯ç£¨åˆäº†å¥½å‡ å¤©æ‰æ‰¾åˆ°ç‚¹æ„Ÿè§‰ã€‚ç”¨äº†å·®ä¸å¤šä¸¤å‘¨ï¼Œdatabend çš„ Python Deiver databend-py ä»¥åŠæ”¯æŒ SQLAlchemy è¯­æ³•çš„ databend-sqlalchemy å·²ç»åŸºæœ¬å¯ç”¨ã€‚ä¸å¾—ä¸è¯´ Python åœ¨æ•°æ®çš„ç”Ÿæ€é‡Œè¿˜æ˜¯çŽ‹è€…ï¼Œå‰å‡ å¤©æœ‰ç”¨æˆ·åœ¨ä½¿ç”¨ go driver çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ª data type parser çš„é—®é¢˜ï¼Œä¹‹å‰åœ¨å®žçŽ°è¿‡ç¨‹ä¸­å°±é‡åˆ°è¿‡ç±»ä¼¼çš„ç±»åž‹é—®é¢˜ï¼Œè¿™ç§é—®é¢˜åœ¨å¼ºç±»åž‹è¯­è¨€é‡Œç®€ç›´å°±æ˜¯ç¾éš¾ï¼Œä½†æ˜¯å¯¹äºŽ Python æ¥è¯´å°±ä¸å­˜åœ¨ã€‚æ‰€ä»¥æœ€åŽç”¨æˆ·è¿˜æ˜¯ç”¨äº† Python çš„ driver è§£å†³äº†é—®é¢˜ï¼Œçœ‹æ¥åŽé¢è¦è®¤çœŸæ‰“ç£¨ databend-py äº†ã€‚ åœ¨ä½¿ç”¨æ–¹é¢ä¹Ÿæ˜¯ python å ä¼˜ï¼Œpip install ç„¶åŽ import ç›´æŽ¥å°±æ˜¯æ‰‹åˆ°æ“’æ¥ï¼š 1pip install databend-py 1234567from databend_py import Clientclient = Client( host='hostName', database="default", user="user", password="pass")print(client.execute("SELECT 1")) ä¸è¿‡ databend-py ä»…æ˜¯æä¾›äº† python è¿žæŽ¥åˆ° databend cloud çš„æ¡¥æ¢ï¼Œå¹¶ä¸èƒ½åƒä½¿ç”¨ ORM å·¥å…·ä¸€æ ·ä½¿ç”¨ cursor.nextã€fetchall ç­‰æ–¹æ³•ã€‚åœ¨å‡†å¤‡å®žçŽ° dbt adapter çš„æ—¶å€™å‘çŽ°éœ€è¦ä¾èµ–ä¸Šé¢æåˆ°çš„ ORM çš„æ–¹æ³•ï¼Œåœ¨ Python ç”Ÿæ€é‡Œ SQLAlchemy æ˜¯ Python ä¸­æœ€æœ‰åçš„ ORM å·¥å…·ï¼Œæ‰€ä»¥å°±æœ‰äº† databend-sqlalchemy è¿™ä¸ªé¡¹ç›®ã€‚ç”±äºŽæ—¶é—´ç´§è¿«ï¼Œå…ˆå®žçŽ°äº†å¯¹æŽ¥ dbt å¿…é¡»è¦ç”¨åˆ°çš„ cursor, description, next, fetch æ–¹æ³•ï¼Œåœ¨ databend-py çš„é“ºåž«ä¸‹ï¼Œå®žçŽ°èµ·æ¥ç¡®å®žæ–¹ä¾¿å¾ˆå¤šã€‚ 12345cursor = connector.connect('http://root:@localhost:8081').cursor() cursor.execute('select 1') # print(cursor.fetchone()) print(cursor.fetchall()) print(cursor.description) å‡ ä¸ªå­—æ€»ç»“ä¸€ä¸‹è¿‘æœŸçš„çŠ¶æ€å°±æ˜¯ï¼šä¸Ž Python ææ–—ï¼Œå½“ç„¶æŽ¥ä¸‹æ¥å¯ä»¥é¢„è§çš„ä¾ç„¶ä¼šè·Ÿ python ææ–—ä¸€æ®µæ—¥å­ï¼Œå› ä¸ºæœ€è¿‘è¦æžçš„ dbt adapter æ˜¯ä¸€ä¸ªå…¨æ–°çš„, é™Œç”Ÿé¢†åŸŸï¼Œå®Œå…¨å°±æ˜¯ä¸€å¤´é›¾æ°´ï¼Œæ‰€ä»¥æŽ¥ä¸‹æ¥å¯èƒ½ä¼šå…ˆå†™å‡ ç¯‡å…³äºŽ dbt çš„å­¦ä¹ æ–‡ç« å§ã€‚ å†å°±æ˜¯æœ€è¿‘å¼€çš„ repo æœ‰ç‚¹å¤šï¼ŒåŠ ä¸Šå®žçŽ°çš„æ—¶é—´æ¯”è¾ƒç´§ï¼Œæ„Ÿè§‰æœ‰äº›ç–²äºŽåº”å¯¹ï¼Œå¾ˆå¤šå®žçŽ°åªèƒ½è‰è‰äº†äº‹ï¼Œä¼°è®¡ bug ä¼šæ¯”è¾ƒå¤šï¼Œæ‰€ä»¥åŽé¢åº”è¯¥ä¼šå¤šæŠ½å‡ºä¸€äº›ä¸ªäººçš„æ—¶é—´æ¥å®Œå–„è¿™äº›é¡¹ç›®ã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 43 Open source weekly report]]></title>
    <url>%2F2022%2F10%2F21%2F2022-43-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[Go driver SDK for databend cloud released!ç”±äºŽåœ¨ databend cloud å„ä¸ªé¡¹ç›®çš„ä»£ç ä¸­å·²ç»å……æ–¥ç€å¤§é‡é‡å¤çš„è¯·æ±‚ databend-query çš„ä»£ç ï¼Œæ‰€ä»¥äºŸéœ€ä¸€ä¸ª driver SDK æ¥å®žçŽ°å¤§ä¸€ç»Ÿï¼ŒäºŽæ˜¯åœ¨å‡ å‘¨å‰å°±å¼€å§‹ç€æ‰‹å®žçŽ° databend cloud çš„ go driverï¼Œå½“æ—¶ç”¨æ¯”è¾ƒçŸ­çš„æ—¶é—´å¤§æ¦‚å®žçŽ°äº†ä¸€ä¸ªæž¶å­ï¼Œè¯¦æƒ…å¯ä»¥è§ è¿™ç¯‡æ–‡ç« ã€‚ç¢äºŽä¸­é—´æœ‰å‡ ä¸ªä¼˜å…ˆçº§æ¯”è¾ƒé«˜çš„å·¥ä½œå°±æš‚æ—¶æç½®äº†ï¼Œæœ¬å‘¨ all in è¿™ä¸ªé¡¹ç›®ä¸€å‘¨ï¼Œç»ˆäºŽ release äº† v0.0.1 ç‰ˆæœ¬ï¼Œè™½ç„¶ä»£ç çš„ç»“æž„ã€åŠŸèƒ½çš„ä¸°å¯Œç¨‹åº¦ã€ä»£ç çš„ä¼˜é›…ç¨‹åº¦éƒ½è·Ÿæ ‡æ† SDK - clickhouse-go çš„æ°´å¹³æœ‰è¾ƒå¤§å·®è·ï¼Œä½†åŸºæœ¬çš„æ–¹æ³•æ¯”å¦‚ sql.Open, Exec, Query, Next, Rows ç­‰éƒ½å·²ç»å¯ç”¨ã€‚å…ˆæ¥çœ‹å‡ ä¸ªðŸŒ°å§! Execution12345678910111213141516171819 dsn, cfg, err := getDSN() if err != nil &#123; log.Fatalf("failed to create DSN from Config: %v, err: %v", cfg, err) &#125;conn, err := sql.Open("databend", dsn) if err != nil &#123; return err &#125; conn.Exec(`DROP TABLE IF EXISTS data`) _, err = conn.Exec(` CREATE TABLE IF NOT EXISTS data( Col1 UInt8, Col2 String ) `) if err != nil &#123; return err &#125; _, err = conn.Exec("INSERT INTO data VALUES (1, 'test-1')") Query Rowå¯ä»¥ç”¨ Scan æ–¹æ³•æ¥è§£æžå‡ºå•æ¡æ•°æ®12345678910row := conn.QueryRow("SELECT * FROM data")var ( col1 uint8 col2, col3, col4 string col5 []string col6 time.Time)if err := row.Scan(&amp;col1, &amp;col2, &amp;col3, &amp;col4, &amp;col5, &amp;col6); err != nil &#123; return err&#125; Query Rowså½“ç„¶å¯ä»¥ç”¨ Next æ¥ä¸æ–­è¿­ä»£èŽ·å–æ‰€æœ‰æ•°æ® 12345678910111213row := conn.QueryRow("SELECT * FROM data")var ( col1 uint8 col2, col3, col4 string col5 []string col6 time.Time)for rows.Next() &#123; if err := row.Scan(&amp;col1, &amp;col2, &amp;col3, &amp;col4, &amp;col5, &amp;col6); err != nil &#123; return err &#125; fmt.Printf("row: col1=%d, col2=%s, col3=%s, col4=%s, col5=%v, col6=%v\n", col1, col2, col3, col4, col5, col6)&#125; è¿™æ ·åœ¨è¯·æ±‚ databend-query çš„æ—¶å€™ï¼Œå°±ä¸ç”¨å†æ¯æ¬¡éƒ½å†™ä¸€é http è¯·æ±‚/è§£æžçš„ä»£ç å•¦ã€‚ bendsql å°é²œ go driverGo driver release åŽé©¬ä¸Šå°±è¿Žæ¥äº†ç¬¬ä¸€ä¸ªç”¨æˆ·(å°ç™½é¼ ) - bendsqlã€‚bendsql ä¸­æœ‰ä¸ªå‘½ä»¤ç”¨æ¥æ‰§è¡Œ SQL è¯­å¥ï¼Œ bendsql query &quot;select * from table&quot;ï¼Œæ‰€ä»¥æˆ‘å…ˆå°†è¿™é‡Œé¢è¯·æ±‚ databend-query çš„ä»£ç éƒ½æ¢æˆäº† go driver - https://github.com/databendcloud/bendsql/pull/22ï¼Œå¯ä»¥çœ‹åˆ°åˆ æŽ‰äº†ä¸å°‘ä»£ç ï¼Œæ¸…æ™°äº†ä¸å°‘ã€‚æŽ¥ä¸‹æ¥è¦åœ¨å…¶ä»–é¡¹ç›®ä¸­åŽ»æ£€éªŒäº†ã€‚ æ¥çœ‹çœ‹æ•ˆæžœï¼š kruise-toolsæœ¬å‘¨ kubectl-kruise æ’ä»¶è¿Žæ¥äº†ä¸€æ¬¡æ›´æ–°ï¼ŒåŒ…å«äº†ä¸¤ä¸ª bug-fix å’Œæ–°çš„ feature: ðŸ› Bug fix: Fix rollout status of partitioned update https://github.com/openkruise/kruise-tools/pull/68 Fix ads patch for rollout undo https://github.com/openkruise/kruise-tools/pull/71 ðŸš€ Feat: Support kubectl-kruise create ContainerRecreateRequest https://github.com/openkruise/kruise-tools/pull/66 Add resourcedistribution generator https://github.com/openkruise/kruise-tools/pull/69. Thanks @dong4325 å…¶ä¸­ resourcedistribution generator æ˜¯å¼€æºä¹‹å¤çš„ä¸€ä¸ªé¡¹ç›®ï¼Œä¸»è¦æ˜¯ç”¨æ¥æ–¹ä¾¿ç”¨æˆ·ç”Ÿæˆ resourceDistrubution èµ„æºçš„ï¼Œå…³äºŽ resouceDistribution å’Œè¿™ä¸ª generator åŽé¢ç­‰åŠŸèƒ½ç¨³å®šåŽå†å¤šåšä»‹ç»ã€‚ å¥½äº†ï¼Œä»¥ä¸Šã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022-41 homebrew formula example for go]]></title>
    <url>%2F2022%2F10%2F06%2Fhomebrew-formula-example-for-go%2F</url>
    <content type="text"><![CDATA[æœ€è¿‘å‡†å¤‡å°† bendsql å‘å¸ƒåˆ° homebrew çš„ repoï¼Œè¿™æ ·å°±å¯ä»¥ä½¿ç”¨ brew install bendsql æ–¹ä¾¿åœ°å®‰è£… bendsql äº†ã€‚å‘å¸ƒçš„æ–¹å¼å°±æ˜¯ä¸º bendsql å†™ä¸€ä¸ª formula å¹¶æ pr åˆ° homebrew-coreï¼Œåœ¨æ­¤è®°å½•ä¸€ä¸‹å¦‚ä½•ç”Ÿæˆ homebrew formulaã€‚ è¯´å¹²å°±å¹²ï¼Œ fork äº† homebrew-core çš„ repo ç„¶åŽ checkout åˆ†æ”¯å‡†å¤‡æ PRã€‚ æ‰§è¡Œ brew create $download_URL æ‰§è¡ŒåŽä¼šç”Ÿæˆ install æ¨¡æ¿ï¼Œæ ¹æ®æ¨¡æ¿å¡«å†™éœ€è¦çš„ä¿¡æ¯ã€‚ 123456789101112131415161718class Bendsql &lt; Formula desc "Work seamlessly with Databend Cloud from the command line." homepage "https://github.com/databendcloud/bendsql" url "https://github.com/databendcloud/bendsql/releases/download/v0.0.2/bendsql-darwin-amd64.tar.gz" sha256 "25c1a2a4e1922261535325634a939fe42a0ffcc12ae6c262ed7021dab611f622" license "MIT" head "https://github.com/databendcloud/bendsql.git", branch: "main" depends_on "go" =&gt; :build def install system "go", "build", *std_go_args(ldflags: "-s -w") end test do system "make test" endend æ ¹æ® homebrew-core çš„æ–‡æ¡£ï¼Œåœ¨æ PR ä¹‹å‰è¦å®Œæˆå‡ ä¸ªå‰ç½®æ“ä½œï¼š å½“æ‰§è¡Œåˆ° brew test bendsql çš„æ—¶å€™ï¼Œå‘çŽ°å‘ homebrew å®˜æ–¹ä»“åº“æäº¤åº”ç”¨æ˜¯éœ€è¦æ»¡è¶³ä¸€å®šæ¡ä»¶çš„ï¼š bendsql åˆšå¼€æºä¸€å‘¨è¿˜æ²¡æ»¡è¶³ä»¥ä¸Šæ¡ä»¶ï¼Œæ‰€ä»¥æ²¡æ³•ç›´æŽ¥ä½¿ç”¨ brew install bendsqlï¼Œåªèƒ½å¦è¾Ÿè¹Šå¾„äº†ã€‚ æƒ³èµ·æ¥ä¹‹å‰å†™å…¶ä»–å·¥å…·çš„æ—¶å€™ï¼Œåªè¦åœ¨è‡ªå·±çš„è´¦æˆ·ä¸­åˆ›å»ºä¸€ä¸ª homebrew-tap çš„ repo, æ¯”å¦‚ https://github.com/hantmac/homebrew-tap, å°±èƒ½å®žçŽ°ç±»ä¼¼çš„ä¸‹è½½æ•ˆæžœã€‚ æ‰€ä»¥åªè¦åœ¨ databendcloud çš„è´¦æˆ·ä¸‹ï¼Œæ–°å»ºä¸€ä¸ªè¿™æ ·çš„ repoï¼Œå°†ä¸Šé¢é…å¥½çš„ formula æäº¤è¿›åŽ»å°±å¯ä»¥ brew tap databendcloud/homebrew-tap &amp;&amp; brew install bendsql å¾ˆæ–¹ä¾¿åœ°ä¸‹è½½äº†ã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
        <tag>homebrew</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 40 Open source weekly report]]></title>
    <url>%2F2022%2F09%2F25%2F2022-40-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[èƒŒæ™¯ä¸çŸ¥ä¸è§‰ Weekly report å·²æ‹–æ›´ä¸‰å‘¨ï¼Œé™¤äº†æ—¥å¸¸å¿™ç¢Œä¹‹å¤–ï¼Œä¹Ÿæ˜¯è§‰å¾—æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«å€¼å¾—å†™çš„ã€‚å…«æœˆä¸­æ—¬çš„æ—¶å€™å¼€å§‹ç€æ‰‹å†™ä¸€ä¸ªå·¥å…· - bendsqlï¼ˆè§33 weekly reportï¼‰ï¼Œç”¨æ¥å¸®åŠ©ç”¨æˆ·æ›´é«˜æ•ˆåœ°æ“ä½œ Databend Cloudï¼Œå½“æ—¶æ˜¯ç”¨äº†å¤§æ¦‚ä¸€å‘¨çš„æ—¶é—´å®Œæˆäº†è¿™ä¸ªé¡¹ç›®ï¼Œç»è¿‡å‡ å‘¨çš„å†…éƒ¨ä½¿ç”¨å’Œè¿­ä»£ï¼ŒçŽ°åœ¨å·²ç»è¢«ç”¨åœ¨ perf test å’Œ e2e test ä¸­ï¼Œè·‘å¾—è¿˜ç®—ç¨³å®šQUQï¼Œæ‰€ä»¥å†³å®šæœ¬å‘¨å°†å…¶å¼€æºï¼Œè®©æ›´å¤šçš„ç”¨æˆ·/å¼€å‘è€…ä½¿ç”¨å¹¶å‚ä¸Žåˆ°äº§å“çš„å¼€å‘ä¸­ã€‚ bensql åœ¨è¿™é‡Œå…ˆç®€å•ä»‹ç»ä¸€ä¸‹ Databend Cloud: Databend Cloud ç”± Databend å¼ºåŠ›é©±åŠ¨ï¼Œæ˜¯ä¸€æ¬¾åŸºäºŽ Databend å†…æ ¸æ‰“é€ çš„ SAAS äº‘æ•°ä»“å¹³å°ï¼Œå…·æœ‰ç®€å•ã€å¼¹æ€§ã€å®‰å…¨ã€é€Ÿåº¦å¿«ã€æˆæœ¬ä½Žç­‰ç‰¹æ€§ï¼Œä¸“æ³¨äºŽäº‘ç«¯å¤§æ•°æ®ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆï¼Œä»¥è§£å†³ä¼ ç»Ÿå¤§æ•°æ®é¡¹ç›®ä¸­è¿ç»´éš¾ï¼Œæˆæœ¬é«˜ï¼Œä½¿ç”¨å¤æ‚çš„é—®é¢˜ã€‚ bendsql æ˜¯ä¸€ä¸ªä¸º Databend Cloud æ‰“é€ çš„ Cli å·¥å…·ï¼Œèƒ½å¤Ÿå¸®åŠ©ç”¨æˆ·é«˜æ•ˆåœ°æ“ä½œæ•°ä»“å¹³å°ï¼Œæ¯”å¦‚ list/create/delete warehouse, list stage, upload æ–‡ä»¶ï¼Œæ‰§è¡Œ SQL ç­‰ï¼Œæä¾›è·Ÿ web é¡µé¢è¿‘ä¹Žä¸€è‡´çš„ä½“éªŒã€‚ How to useåœ¨ä½¿ç”¨ bendsql ä¹‹å‰ï¼Œéœ€è¦çŽ°åœ¨ Databend Cloud ä¸Šç”³è¯·æ³¨å†Œè´¦å·ï¼Œç„¶åŽåœ¨ ä¸‹è½½é¡µé¢ æ‰¾åˆ°å¯¹åº”å¹³å°çš„äºŒè¿›åˆ¶åŒ…ä¸‹è½½å®‰è£…ã€‚ auth loginé¦–å…ˆç”¨æ³¨å†Œçš„è´¦å·ç™»å½•, 1bendsql auth login ç™»å½•è¿‡ç¨‹ä¸­é€‰æ‹©éœ€è¦ä½¿ç”¨çš„ç»„ç»‡ï¼Œç›´æŽ¥å›žè½¦ä½¿ç”¨é»˜è®¤ç»„ç»‡ã€‚å½“ç„¶ï¼Œç™»å½•åŽä¹Ÿå¯ä»¥ä½¿ç”¨ bendsql configure --org YOURORG æ¥ä¿®æ”¹ã€‚ æ“ä½œ warehouseä½¿ç”¨ bendsql å°±å¯ä»¥å®Œæˆå¯¹ warehouse çš„æ‰€æœ‰æ“ä½œï¼Œ12345678910111213141516USAGE bendsql warehouse cmd [flags]CORE COMMANDS create: Create a warehouse delete: Delete a warehouse ls: show warehouse list resume: Resume a warehouse status: show warehouse status suspend: Suspend a warehouseINHERITED FLAGS --help Show help for commandLEARN MORE Use 'bendsql &lt;command&gt; &lt;subcommand&gt; --help' for more information about a command. å‚è€ƒä½¿ç”¨æ–‡æ¡£å³å¯ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚ æ“ä½œ stage1234567891011121314Operate stageUSAGE bendsql stage &lt;command&gt; [flags]CORE COMMANDS ls: List stage or files in stage upload: Upload file to stage using warehouseINHERITED FLAGS --help Show help for commandLEARN MORE Use 'bendsql &lt;command&gt; &lt;subcommand&gt; --help' for more information about a command. å¯ä»¥ä½¿ç”¨ bendsql å¾ˆæ–¹ä¾¿åœ°å°†æ–‡ä»¶ä¸Šä¼ åˆ° stage ä¸­ã€‚ä¹Ÿå¯ä»¥æŸ¥çœ‹ç›®æ ‡ stage ä¸­çš„æ–‡ä»¶æƒ…å†µã€‚ Exec SQL bendsql å¯ä»¥æ¥æ‰§è¡Œ SQL è¯­å¥ï¼Œ å‡å¦‚ä½ æ‰§è¡Œçš„ SQL è¯­å¥æ¯”è¾ƒè€—è´¹èµ„æºï¼Œå¯ä»¥åœ¨æ‰§è¡Œ SQL çš„åŒæ—¶æŒ‡å®šä½¿ç”¨æ›´å¤§è§„æ ¼çš„ warehouse,1bendsql query --sql YOURSQL --warehouse WAREHOUSE ä½†æ˜¯è¿™ç§æ‰§è¡Œ SQL çš„æ–¹å¼å¯¹ç”¨æˆ·æ¥è¯´ä¸å¤ªå‹å¥½ï¼ŒåŽé¢çš„ RoadMap ä¸­ä¼šè€ƒè™‘æ”¯æŒ bendsql query å°±è¿›å…¥åˆ°äº¤äº’å¼ SQL çš„çŽ¯å¢ƒä¸­ï¼Œå†æ”¯æŒå‘½ä»¤è¡¥å…¨åŽï¼Œä½“éªŒå°±å¤§å¹…æå‡äº†ã€‚ å…³äºŽä½¿ç”¨å°±å…ˆä»‹ç»è¿™äº›ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ä¸‹è½½å®‰è£… bendsql -h åŽç»§ç»­æŽ¢ç´¢ã€‚ å½©è›‹â€ æœ€å¼€å§‹çš„æ—¶å€™è¿™ä¸ªå·¥å…·å¹¶ä¸æ˜¯å« bendsql ï¼Œè€Œæ˜¯ bendctlï¼Œå¤§å®¶è§‰å¾— bendctl è¿™ä¸ªå‘½åå¤ªè¿‡äºŽå·¥ç¨‹å¸ˆåŒ–äº† =.=ï¼Œç»è¿‡è®¨è®ºæœ€åŽæ”¹ä¸º bendsqlã€‚ ä»¥ä¸Šã€‚å¾€æœŸæ–‡ç« å¯ä»¥è®¿é—® https://cloudsjhan.github.io/ ç»§ç»­é˜…è¯»ã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 36 Open source weekly report]]></title>
    <url>%2F2022%2F09%2F02%2F2022-36-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[å·¥ä½œæ–°çš„æŒ‘æˆ˜æœ¬å‘¨å¼€äº†ä¸€ä¸ªæ–°çš„é¡¹ç›® databend-go-driverï¼Œæ˜¯ä¸€å¥—ç±»ä¼¼äºŽ gosnowflake çš„æ•°æ®åº“ SDKï¼Œä¸»è¦æ˜¯åŸºäºŽ Go çš„ database/sql packageï¼Œå®žçŽ°ç›¸åº”çš„ interface å¹¶æ³¨å†Œ databend åˆ° database/sqlï¼Œå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„ä»£ç åƒæ“ä½œ mysql ä¸€æ ·æ“ä½œ databend ï¼š 12345678910111213141516171819func main() &#123; dsn, cfg, err := getDSN() if err != nil &#123; log.Fatalf("failed to create DSN from Config: %v, err: %v", cfg, err) &#125; db, err := sql.Open("databend", dsn) if err != nil &#123; log.Fatalf("failed to connect. %v, err: %v", dsn, err) &#125; defer db.Close() query := "SELECT 1" rows, err := db.Exec(query) // no cancel is allowed if err != nil &#123; log.Fatalf("failed to run a query. %v, err: %v", query, err) &#125; fmt.Println(rows.RowsAffected()) fmt.Printf("Congrats! You have successfully run %v with databend DB!\n", query)&#125; ç›®å‰é¡¹ç›®çš„æž¶å­æ­äº†ä¸€ä¸‹ï¼Œå·²ç»å®ŒæˆåŸºæœ¬çš„æ³¨å†Œå’Œç®€å•çš„ exec åŠŸèƒ½ï¼Œä½†è·ç¦»çœŸæ­£ç”Ÿäº§å¯ç”¨æ¯”è¾ƒé¥è¿œã€‚ã€‚ã€‚è¿˜è¦å®žçŽ° query, rows, async rows ç­‰åŠŸèƒ½ï¼Œå®Œæˆè¿™äº›å·¥ä½œå°±éœ€è¦å¯¹ databend çš„å·¥ä½œåŽŸç†ã€ç»“æž„æœ‰ä¸€å®šäº†è§£ï¼Œå¯èƒ½æ˜¯ä¸€ä¸ªå°æŒ‘æˆ˜QUQã€‚ å¼€æºæœ€è¿‘ç”±äºŽé¡¹ç›®éœ€è¦åˆç”¨äº†ä¸€ä¸‹ fuckdbï¼Œè¿™æ˜¯ä¸€ä¸ªèƒ½å¤Ÿä¸€é”®å°† mysql schema è½¬æˆå¸¦å„ç§ tag çš„ golang struct çš„å¤§å¤§æé«˜å¼€å‘æ•ˆçŽ‡çš„å·¥å…·ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç ”ç©¶ä¸€ä¸‹è¿™é‡Œä¸å¤šä½œä»‹ç»äº†ã€‚ä¸»è¦æ˜¯åœ¨æ‰“å¼€ github é¡¹ç›®é¡µé¢çš„æ—¶å€™å‘çŽ°ä¸€ä¸ªé™ˆå¹´è€ issueï¼Œç«Ÿç„¶æ˜¯åŽ»å¹´ 7 æœˆä»½ç”¨æˆ·æå‡ºæ¥çš„ï¼Œå›žæƒ³èµ·åŽ»å¹´ 7 æœˆï¼Œç¡®å®žæ˜¯å¿™å¾—ç„¦å¤´çƒ‚é¢ï¼ˆæ‡‚çš„éƒ½æ‡‚ï¼‰ï¼Œä½†æ²¡æƒ³åˆ°è¿™ä¸ªé—®é¢˜ä¸€æç½®å°±æ˜¯ä¸€å¹´ã€‚è¿™ä¸ªéœ€æ±‚æ˜¯å°† struct çš„ json tag ä»Ž snake case è½¬æˆ camel caseï¼Œæ”¹åŠ¨ä¹‹å‰ç”Ÿæˆçš„ä»£ç æ˜¯è¿™æ ·çš„ï¼š 1234567type structName struct &#123; Age string `gorm:"column:slug" json:"age"` Name string `gorm:"column:name" json:"name"` CreatorID int64 `gorm:"column:creator_id" json:"creator_id"` CreatedAt time.Time `gorm:"column:created_at" json:"created_at"` UpdatedAt time.Time `gorm:"column:updated_at" json:"updated_at"`&#125; snake case æœ¬èº«ä¹Ÿä¸ç¬¦åˆ golang çš„ä»£ç é£Žæ ¼ï¼Œæ‰€ä»¥å°±é²äº†ä¸€ä¸ª PR è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œè¾“å‡ºçš„ struct å°±æ˜¯ï¼š 1234567type structName struct &#123; Age string `gorm:"column:slug" json:"age"` Name string `gorm:"column:name" json:"name"` CreatorID int64 `gorm:"column:creator_id" json:"creatorId"` CreatedAt time.Time `gorm:"column:created_at" json:"createdAt"` UpdatedAt time.Time `gorm:"column:updated_at" json:"updatedAt"`&#125; å—¯ï¼Œä¼˜é›…äº† =.=ã€‚ å…¶ä»–è®°å½•ä¸€äº›éšæ‰‹æ‹ï¼š]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 34 Open source weekly report]]></title>
    <url>%2F2022%2F08%2F22%2F2022-34-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[å·¥ä½œbendctl ä¸€æœŸçš„å·¥ä½œå·²å®Œæˆ 70%ï¼Œè¿›åº¦ä¹‹å¿«å‡ºä¹Žæˆ‘çš„æ„æ–™ï¼Œç­‰ä¸‹å‘¨å†™å®Œå†æ¥æ€»ç»“å’Œä»‹ç»ä¸€ä¸‹ã€‚ ç”Ÿæ´»çç¢Žçš„äº‹æƒ…å¥½åƒä¸€ç›´ä¸æ–­ï¼Œå¹¶æ²¡æœ‰å¤§æ®µçš„æ—¶é—´æ¥é˜…è¯»ï¼Œæ— æ„é—´å€’æ˜¯å¶ç„¶é‡è¯»äº†å†¯éª¥æ‰çš„ã€Šè‹¦å¤ã€‹ï¼Œçªç„¶å‘çŽ°è‡ªå·±å·²ç»å¥½ä¹…æ²¡æœ‰é™ä¸‹å¿ƒæ¥è¯»å®Œè¿‡ä¸€ç¯‡æ•£æ–‡äº†ã€‚æ­¤æ—¶æ­£å€¼åŒ—æ–¹ä¸€å¤œå…¥ç§‹çš„å¤©æ°”ï¼Œè¯»ç½¢æ–‡ç« æ›´æ„Ÿè§‰ç§‹æ„æ¸æµ“ã€‚ å¥½çš„æ–‡ç« è®©äººæ„ŸåŠ¨ï¼Œå†æƒ³èµ·æœ€è¿‘èº«è¾¹å‘ç”Ÿçš„ä¸€äº›äº‹æƒ…ï¼Œè¶Šå‘åœ°è§‰å¾— ç”·äººä»¬çš„ç«¥å¹´å¾€äº‹å¤§å¤šæ˜¯åœ¨å¤å¤©é‡Œ æœ‰å¤šä¹ˆçš„è´´åˆ‡ï¼Œåº”è¯¥è¯´ï¼Œäººç”Ÿæœ‰ä¸€åŠçš„å¿«ä¹æ¥è‡ªç«¥å¹´ï¼Œç«¥å¹´æœ‰å¤§åŠçš„å¿«ä¹æ¥è‡ªå¤å¤©ï¼Œåœ¨å¿«ä¹çš„ç«¥å¹´é‡Œï¼Œä½ æ ¹æœ¬ä¸ä¼šæ„Ÿåˆ°è’¸ç¬¼èˆ¬å¤å¤©çš„éš¾è€ä¸Žç…Žç†¬ã€‚è™½ç„¶é•¿å¤§åŽè¿™ç§æ„Ÿè§‰æ¸è¡Œæ¸è¿œï¼Œç”šè‡³åœ¨æ­¤åŽè‰°éš¾çš„äººç”Ÿé‡Œï¼Œä½ èƒ½ä½“ä¼šåˆ°ä¸€ä¸è‹¦å¤èˆ¬çš„æ»‹å‘³ï¼Œä½†é‚£äº›ç«¥å¹´å¤å¤©é‡Œçš„ç¾Žå¥½çš„äº‹ç‰©æ€»æ˜¯åœ¨é»˜é»˜åœ°æ²»æ„ˆä½ ã€‚ å¿«ä¹æŠŠæ—¶å…‰ç¼©çŸ­ï¼Œè‹¦éš¾æŠŠå²æœˆæ‹‰é•¿ï¼Œä¸€å¦‚è¿™é•¿é•¿çš„æ²¡æœ‰å°½å¤´çš„è‹¦å¤ã€‚å†¯éª¥æ‰åœ¨æ€€å¿µäº†ç«¥å¹´çš„ç¾Žå¥½åŽï¼Œå¹¶æ²¡æœ‰æŠ¨å‡»ã€åŽŒæ¶è¿™æ ·çš„å¤å¤©ï¼Œç›¸åï¼Œä»–è§‰å¾— è‹¦ ï¼ŒåŽŸæ˜¯ç”Ÿæ´»ä¸­çš„èœœã€‚äººç”Ÿçš„ä¸€åˆ‡æ”¶èŽ·éƒ½åŽ‹åœ¨è¿™æ²‰ç”¸ç”¸çš„è‹¦å­—ä¸‹é¢ï¼Œç„¶è€Œä¸€åŠçš„è‹¦å­—ä¸‹è¾¹åˆæ˜¯ä¸€æ— æ‰€æœ‰ã€‚å½“ä½ ç”¨å°½å¹³ç”Ÿçš„åŠ›æ°”ï¼Œæœ€ç»ˆæ‰€èŽ·ä¸Žåˆå§‹æ—¶çš„æ„¿æœ›ç«Ÿç„¶åŽ»ä¹‹åƒé‡Œã€‚ä½ è¯¥æ€Žä¹ˆæƒ³ï¼Ÿ å†¯éª¥æ‰æ˜¯è¿™æ ·æƒ³çš„ï¼Œè‹¦å¤-å®ƒä¸æ˜¯æ— å°½å¤´çš„æš‘çƒ­çš„æŠ˜ç£¨ï¼Œè€Œæ˜¯æˆ‘ä»¬é¡¶ç€æ¯’æ—¥å¤´é»˜é»˜åˆåšå¿çš„è‹¦æ–—çš„æœ¬èº«ã€‚äººç”Ÿçš„åŠ›é‡å…¨æ˜¯å¯¹æ‰‹ç»™çš„ï¼Œé‚£å°±æ˜¯è¦æŠŠå¯¹æ‰‹çš„åŽ‹åŠ›å¸å…¥è‡ªå·±çš„éª¨å¤´é‡Œã€‚å¼ºè€…ä¹‹åŠ›æœ€ä¸»è¦çš„æ˜¯æ‰¿å—åŠ›ã€‚åªæœ‰åœ¨åŒªå¤·æ‰€æ€çš„æ‰¿å—ä¸­æ‰ä¼šæ„Ÿåˆ°è‡ªå·±å±žäºŽå¼ºè€…ã€‚æ‰€ä»¥å†¯éª¥æ‰çš„å†™ä½œä¸€å¤§åŠæ˜¯åœ¨å¤å­£å®Œæˆçš„ã€‚ å¯èƒ½æ˜¯é‚£äº›æ²‰é‡çš„äººç”Ÿçš„è‹¦å¤ï¼Œç……é€ å‡ºè¿™æ ·çš„æ€§æ ¼ä¹ æƒ¯ã€‚ å””ï¼Œæ—§ä¹¦ä¸åŽŒç™¾å›žè¯»ï¼Œå¹´å¹¼æ—¶è¯»è¿‡çš„ä¹¦åœ¨è°ˆä¸ä¸Šå¤šå°‘ç”Ÿæ´»é˜…åŽ†çš„å‘é…µä¸‹ä¹Ÿæ˜¯èƒ½å‚¬åŒ–å‡ºä¸€äº›ä¸ä¸€æ ·çš„æ„Ÿæ‚Ÿã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 33 Open source weekly report]]></title>
    <url>%2F2022%2F08%2F16%2F2022-33-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[æœ¬å‘¨æ— æ‚äº‹ï¼Œ all in bendctl â”“( Â´âˆ€` )â”. çªç„¶æ„Ÿè§‰å†™ä»£ç å’Œç›–æˆ¿å­æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚ç›–æˆ¿å­éœ€è¦èŠ±å¾ˆé•¿çš„æ—¶é—´æ¥åšå›ºåœ°åŸºï¼Œæµ‡çŒæ··å‡åœŸï¼Œåœ°åŸºç‰¢é åŽä¸€å±‚ä¸€å±‚åœ°ç›–å°±äº‹åŠåŠŸå€äº†ï¼Œå¦‚æžœä½ åœ°åŸºæ­å¾—ä¸å¥½ï¼Œç›–çš„è¿‡ç¨‹ä¸­è¿˜è¦å›žå¤´ä¿®è¡¥åœ°åŸºï¼Œä¸ä»…é¡¹ç›®è¿›åº¦å¾ˆæ…¢ï¼Œè´¨é‡ä¹Ÿå¾—ä¸åˆ°ä¿è¯ã€‚å†™ä»£ç ä¹Ÿæ˜¯ä¸€æ ·ï¼Œä¸è¦ç€æ€¥å†™åŠŸèƒ½ï¼ŒæŠŠå„ç§ä¾èµ–ã€æ¡†æž¶ã€ä»£ç ç»“æž„å…ˆå†™å¥½ï¼Œåœ¨æ­¤ä¹‹ä¸Šå†å†™åŠŸèƒ½é€»è¾‘ä»£ç ä¾¿æ‰‹åˆ°æ“’æ¥äº†ã€‚ ä¸Šå‘¨è¯´è¦æŠ½å‡ºç‚¹æ—¶é—´çœ‹ä¸€ä¸‹å¼€æºä¹‹å¤çš„ proposal ç»“æžœæ”¾äº†é¸½å­ï¼Œæœ¬å‘¨æ— è®ºå¦‚ä½•ä¹Ÿè¦å¤šèŠ±ç‚¹æ—¶é—´åœ¨ä¸Šé¢ï¼Œå¦åˆ™ä¾¿æœ‰ä¸è´Ÿè´£ä»»ä¹‹å«ŒQUQã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 32 Open source weekly report]]></title>
    <url>%2F2022%2F08%2F08%2F2022-32-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[å¼€æºæœ¬å‘¨å‚åŠ äº†å¼€æºä¹‹å¤çš„åŒå‘¨ä¼šï¼Œreview äº†å‚èµ›åŒå­¦å…³äºŽ rollout history çš„ Proposalï¼Œè¿˜æœ‰è®¸å¤šè¦ä¿®æ”¹çš„åœ°æ–¹ï¼Œéš¾åº¦æ„Ÿè§‰æ¯”æƒ³è±¡ä¸­é«˜ï¼Œä¸‹å‘¨è¦å¤šæŠ½å‡ºç‚¹æ—¶é—´æ¥çœ‹ä¸€ä¸‹äº†ã€‚ å·¥ä½œä¾æ—§å¿™ç¢Œï¼Œæ—¶é—´ç´§å¼ æš‚æ—¶ä¸å±•å¼€è¯´äº†ã€‚ å­¦ä¹ &amp;ç”Ÿæ´»è¿™å‘¨å€’æ˜¯è¶ç€åˆé¥­æ—¶é—´çœ‹äº†ä¸€äº› Rust çš„ä¸œè¥¿ï¼Œä¸»è¦æ˜¯ Trait ä»¥åŠç”Ÿå‘½å‘¨æœŸç›¸å…³çš„ã€‚Trait æœ‰ç‚¹åƒ Go é‡Œé¢çš„ interfaceï¼Œimpl åŽ»å®žçŽ°æ–¹æ³•ã€‚ç”Ÿå‘½å‘¨æœŸç€å®žæ˜¯æ¯”è¾ƒå¤æ‚ï¼Œæœ‰å‡½æ•°ä¸­çš„ç”Ÿå‘½å‘¨æœŸï¼Œæ–¹æ³•çš„ï¼Œå˜é‡çš„ã€‚ã€‚ã€‚,ä¸»è¦æ˜¯ Rust ç”Ÿå‘½å‘¨æœŸçš„è¯­æ³•ä¹Ÿè®©äººçœ¼èŠ±QUQã€‚&lt;`a&gt; å±…ç„¶æ˜¯ç”Ÿå‘½å‘¨æœŸçš„æ³¨è§£ï¼Œu1s1ï¼Œuglyã€‚1234567fn longest&lt;'a&gt;(x: &amp;'a str, y: &amp;'a str) -&gt; &amp;'a str &#123; if x.len() &gt; y.len() &#123; x &#125; else &#123; y &#125;&#125; Anywayï¼Œ æœŸå¾…èƒ½æ—©æ—¥ä¸Šæ‰‹ç”¨ Rust å¹²ç‚¹å¥½çŽ©çš„äº‹æƒ… (ï¼šã€‚ ä»¥ä¸Šã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 31 Open source weekly report]]></title>
    <url>%2F2022%2F07%2F30%2F2022-31-Open-source-weekly-report-1%2F</url>
    <content type="text"><![CDATA[2022 å¹´ç¬¬ 31 å‘¨ï¼Œä»¥ä¸‹æ˜¯æœ¬å‘¨çš„å¼€æºå‘¨æŠ¥ã€‚ æœ¬å‘¨ä¸»è¦ focus åœ¨ databend cloud æ–°ç‰ˆæœ¬çš„åŠŸèƒ½å®žçŽ°ä¸Šï¼Œå¹¶ä¸”ç”±äºŽå¯¹ç³»ç»Ÿå’Œä»£ç å®žçŽ°ç¼ºå°‘æ·±å…¥çš„äº†è§£ï¼Œåœ¨å¯¹ä¸€äº› corner case çš„å¤„ç†ä¸Šæ¬ è€ƒè™‘ï¼Œå¯¼è‡´äº†ä¸€äº›æœ¬ä¸è¯¥å‡ºçŽ°çš„ bugï¼Œæµªè´¹äº†ä¸€äº›æ—¶é—´ã€‚è­¦ç¤ºè‡ªå·±åœ¨è€ƒè™‘é—®é¢˜çš„æ—¶å€™è¦å…¨é¢ï¼ŒåŒæ—¶ä¹Ÿè¦å°½å¿«åœ°ç†Ÿæ‚‰ databend cloud çš„ä»£ç ç»†èŠ‚ã€‚ è¿™é‡Œåªè®°å½•ä¸€ä¸ªå°çš„é—®é¢˜ï¼Œä½¿ç”¨ lister ä»Ž k8s é›†ç¾¤ get èµ„æºçš„æ—¶å€™ï¼Œéœ€è¦å¯¹è¿”å›žçš„ err åš NotFoundErr å’Œå…¶ä»– Error çš„åˆ¤æ–­ï¼Œå°¤å…¶æ˜¯åœ¨èŽ·å–å…¶ä»–èµ„æºçš„æ—¶å€™ï¼Œä¸èƒ½å› ä¸º NotFoundErr çš„å­èµ„æºå°±è¿”å›žæŠ¥é”™ã€‚ 1r, err := lister.Resources(ns).Get(name) è¦åšè¿™æ ·çš„å¤„ç†ï¼š12345if err != nil &amp;&amp; errors.IsNotFound(err) &#123; // something&#125;else if err != nil &#123; // return err&#125; å¼€æºæ–¹é¢ï¼Œkubectl-kruise æ’ä»¶æ”¶åˆ°äº†å¼€å‘è€…ä¸€ä¸ª bug report ï¼Œä¸»è¦æ˜¯è¯´ kubectl-kruise rollout status clone/sample åœ¨åŽŸåœ°å‡çº§çš„åœºæ™¯ä¸‹ä¼šå¡ä¸»ï¼Œå³ä½¿æ‰€æœ‰ Pod éƒ½å·²ç»æ›´æ–°å®Œæˆç¨‹åºä¹Ÿä¸ä¼šé€€å‡ºã€‚è¿™ä¸ªé—®é¢˜æ˜¯ç”±äºŽ rollout status ä¸­ç¼ºå°‘å¯¹åŽŸåœ°å‡çº§å®Œæˆçš„åˆ¤æ–­æ¡ä»¶ï¼ŒäºŽæ˜¯å°±æäº†ä¸€ä¸ª PR è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ å¦å¤–ä¸€ä¸ªæ”¯æŒ Openkruise SidecarSet æ ¹æ® namespace selector æ³¨å…¥ Pod çš„ PR æ­£åœ¨ review ä¸­ï¼Œè¿˜éœ€è¦æ ¹æ® reviewer çš„ comment è¿›è¡Œä¿®æ”¹ã€‚ ç»¿æ ‘æµ“è«å¤æ—¥é•¿ï¼Œä¸çŸ¥ä¸è§‰ä¸ƒæœˆå·²è¿‘å°¾å£°ï¼Œä¸‹ä¸ªå‘¨æŠ¥å°±å…«æœˆä»½è§äº†ï¼Œå¤å¤©å¤§æ¦‚è¦è¿‡åŽ»äº†å§ã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[kubectl kruise - OpenKruise Cli åˆ©å™¨]]></title>
    <url>%2F2022%2F07%2F24%2Fkubectl-kruise-OpenKruise-Cli-%E5%88%A9%E5%99%A8%2F</url>
    <content type="text"><![CDATA[]]></content>
      <categories>
        <category>OpenKruise</category>
      </categories>
      <tags>
        <tag>OpenKruise</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[2022 NO.30 Open source weekly report]]></title>
    <url>%2F2022%2F07%2F24%2F2022-30-Open-source-weekly-report%2F</url>
    <content type="text"><![CDATA[2022 å¹´ç¬¬ 30 å‘¨ï¼Œä»¥ä¸‹æ˜¯æœ¬å‘¨çš„å¼€æºå‘¨æŠ¥ã€‚ äº‹å‡ºæœ‰å› å‘¨ä¸­çš„æ—¶å€™åœ¨ OpenKruise å¼€æºç¤¾åŒºç¾¤é‡Œçœ‹åˆ°æœ‰å¼€å‘è€…æåˆ°èƒ½ä¸èƒ½åœ¨ kubectl-kruise æ’ä»¶ä¸­æä¾›ä¸€ç§ä¾¿æ·çš„æ–¹å¼ï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿå¿«é€Ÿä½¿ç”¨ ContainerRecreateRequest å®žçŽ°åŽŸåœ°é‡å¯å®¹å™¨çš„èƒ½åŠ›ã€‚ å…¶å®žè¿™ä¸ªæƒ³æ³•æˆ‘åœ¨å¾ˆä¹…ä¹‹å‰å°±æœ‰äº†ï¼Œå½“æ—¶æç½®äº†ä¸€ä¸‹å°±æ·¹æ²¡åœ¨çç¢Žä¹‹ä¸­ï¼Œè¯¦è§è¿™ä¸ª issueã€‚è¶ç€è¿™å‘¨æœ«çš„ç©ºé—²ï¼Œæ‰“ç®—æŠŠè¿™ä¸ªåŠŸèƒ½å®žçŽ°ä¸€æŠŠã€‚ èƒŒæ™¯ContainerRecreateRequest æ˜¯ OpenKruise æä¾›çš„ä¸€ç§è¿ç»´å¢žå¼ºçš„ç»„ä»¶ï¼Œå¯ä»¥å¸®åŠ©ç”¨æˆ·é‡å¯/é‡å»ºå­˜é‡ Pod ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚å’Œ Kruise æä¾›çš„åŽŸåœ°å‡çº§ç±»ä¼¼ï¼Œå½“ä¸€ä¸ªå®¹å™¨é‡å»ºçš„æ—¶å€™ï¼ŒPod ä¸­çš„å…¶ä»–å®¹å™¨è¿˜ä¿æŒæ­£å¸¸è¿è¡Œã€‚é‡å»ºå®ŒæˆåŽï¼ŒPod ä¸­é™¤äº†è¯¥å®¹å™¨çš„ restartCount å¢žåŠ ä»¥å¤–ä¸ä¼šæœ‰ä»€ä¹ˆå…¶ä»–å˜åŒ–ã€‚ ç›®å‰ç”¨æˆ·åˆ›å»º CRR å®žçŽ°å®¹å™¨åŽŸåœ°é‡å¯çš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§æ–¹å¼ï¼š kubectl apply -f crr.yaml OpenKruise API è¿™ä¸¤ç§æ–¹å¼å¯¹é›†ç¾¤è¿ç»´äººå‘˜æ¥è¯´éƒ½ä¸å¤Ÿå‹å¥½ï¼Œè¿‡äºŽç¹çã€‚æœ€å¥½çš„æ–¹å¼å°±æ˜¯åœ¨ terminal ä¸­ä½¿ç”¨ä¸€è¡Œå‘½ä»¤å°±èƒ½åˆ›å»º CRR å®ŒæˆåŽŸåœ°é‡å¯ã€‚è€Œ Kruise-tools ä¸º Kruise çš„åŠŸèƒ½æä¾›äº†ä¸€ç³»åˆ—å‘½ä»¤è¡Œå·¥å…·ï¼ŒåŒ…æ‹¬ kubectl-kruiseï¼Œå®ƒçš„æ˜¯ kubectl çš„æ ‡å‡†æ’ä»¶ã€‚åœ¨è¿™ä¸ªæ’ä»¶ä¸­å¯ä»¥å¾ˆå®¹æ˜“é›†æˆè¯¥åŠŸèƒ½ã€‚ï¼ˆå…³äºŽ kubectl-kruise åŽé¢æ‰“ç®—ä¸“é—¨å¼€ä¸€ç¯‡æ–‡ç« æ¥è¯¦ç»†ä»‹ç»ã€‚) ç¡®å®šç›®æ ‡é¦–å…ˆæˆ‘ä»¬éœ€è¦ä¿è¯è¾“å…¥çš„å‚æ•°å°½é‡å°‘ï¼Œå…¶ä»–çš„å¿…é¡»å‚æ•°éƒ½ç»™åˆ°åˆç†çš„é»˜è®¤å€¼ï¼Œä»¥ä¾¿ç”¨æˆ·èƒ½å¤Ÿä»¥æœ€å¿«çš„é€Ÿåº¦åˆ›å»º CRR é‡å¯å®¹å™¨ï¼Œæ‰€ä»¥æˆ‘åœ¨æ’ä»¶ä¸­å®šä¹‰äº† CRR çš„ä¸€ä¸ªé»˜è®¤ç­–ç•¥ï¼š 123456strategy: failurePolicy: Fail orderedRecreate: false unreadyGracePeriodSeconds: 3 activeDeadlineSeconds: 300 ttlSecondsAfterFinished: 1800 ç¡®å®šæœ€ç»ˆçš„å‘½ä»¤ä¸ºï¼š 1kubectl kruise create ContainerRecreateRequest test-crr --pod=sample-k52bq --containers=nginx æ‰§è¡Œè¿™æ¡å‘½ä»¤å°±å¯ä»¥é‡å¯ pod sample-k52bq ä¸­åå­—ä¸º nginx çš„å®¹å™¨ï¼Œå…¶ä¸­ --containers ä¸ºä¸€ä¸ªåˆ—è¡¨ï¼Œå¦‚æžœä¸ºç©ºå°±é‡å¯ pod ä¸­æ‰€æœ‰çš„å®¹å™¨ï¼Œå¦åˆ™é‡å¯æŒ‡å®šå®¹å™¨ã€‚ é™¤äº† --podã€--containers è¿˜æ”¯æŒ unreadyGracePeriodSeconds å’Œ terminationGracePeriodSecondsï¼Œè¿™ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯é€‰å¡«ã€‚ unreadyGracePeriodSeconds: é‡å»ºåŽæ–°å®¹å™¨è‡³å°‘ä¿æŒè¿è¡Œè¿™æ®µæ—¶é—´ï¼Œæ‰è®¤ä¸ºè¯¥å®¹å™¨é‡å»ºæˆåŠŸ terminationGracePeriodSecondsï¼š ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡ºçš„æ—¶é—´ï¼Œä¸å¡«é»˜è®¤ç”¨ Pod ä¸­å®šä¹‰çš„ å®žçŽ°ç›¸å…³çš„ä»£ç å®žçŽ°å¯ä»¥æŸ¥çœ‹è¿™ä¸ª PRã€‚ è¿™éƒ¨åˆ†ä»£ç åˆå¹¶åŽä¸‹å‘¨ä¼š release æ–°ç‰ˆæœ¬ï¼Œæƒ³è¦å°é²œçš„åŒå­¦å¯ä»¥ clone é¡¹ç›®åŽè‡ªè¡Œç¼–è¯‘ã€‚ ç¢Žç¢Žå¿µè¿™ç¯‡æ–‡ç« æ˜¯ weekly-report ç³»åˆ—çš„ç¬¬ä¸€ç¯‡ï¼Œä¹‹æ‰€ä»¥å¼€å§‹è¿™ä¸ªç³»åˆ—ï¼ŒçœŸæ˜¯è¯´æ¥è¯é•¿ã€‚å·®ä¸å¤šå°±æ˜¯åˆšå¼€å§‹å†™ blog çš„æ—¶å€™æ˜¯æƒ³æ¯å‘¨éƒ½è¾“å‡ºä¸€ç¯‡æœ‰ç‚¹å­è´¨é‡çš„æŠ€æœ¯æ–‡ç« ï¼Œå‘çŽ°è¿™æ ·å¤ªéš¾äº†ï¼Œä¸€æ˜¯æ²¡æœ‰è¿™ä¹ˆå¤šå†…å®¹è¾“å‡ºï¼ŒäºŒæ˜¯å¾ˆå®¹æ˜“è¢«å…¶ä»–æ‚äº‹æ‰“ä¹±ï¼Œå¾ˆéš¾åšæŒã€‚è¿™æ¬¡å¼€å§‹ä»¥å¼€æºå‘¨æŠ¥çš„åä¹‰å†™æ¯å‘¨çš„ blogï¼Œå®žé™…ä¸Šæ˜¯æƒ³ä»¥ä¸€ç§éšæ„ã€è‡ªç”±çš„æ–¹å¼ï¼Œè¾“å‡ºä¸€ç‚¹ä¸œè¥¿ï¼Œä¸è®¡ç¯‡å¹…ä¹Ÿä¸è€ƒç©¶è´¨é‡ï¼Œåªä¸ºè®°å½•ï¼Œè¿™æ ·å¤§æ¦‚èƒ½åšæŒä¸‹åŽ»å§ã€‚ éƒ½è¯´æ—¥æ‹±ä¸€å’ï¼Œæˆ‘å…ˆå‘¨æ‹±ä¸€å’ã€‚]]></content>
      <categories>
        <category>weekly-report</category>
      </categories>
      <tags>
        <tag>weekly-report</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OpenKruise æºç åˆ†æžä¹‹ ResourceDistribution]]></title>
    <url>%2F2022%2F07%2F11%2FOpenKruise-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B-ResourceDistribution%2F</url>
    <content type="text"><![CDATA[OpenKruise æ˜¯åŸºäºŽ CRD çš„æ‹“å±•ï¼ŒåŒ…å«äº†å¾ˆå¤šåº”ç”¨å·¥ä½œè´Ÿè½½å’Œè¿ç»´å¢žå¼ºèƒ½åŠ›ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¼šä»Žæºç å’Œåº•å±‚åŽŸç†ä¸Šè§£è¯»å„ä¸ªç»„ä»¶ï¼Œä»¥å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ä½¿ç”¨å’Œç†è§£ OpenKruiseã€‚è®©æˆ‘ä»¬å¼€å§‹ OpenKruise çš„æºç ä¹‹æ—…å§ï¼ å‰è¨€]]></content>
      <categories>
        <category>OpenKruise</category>
      </categories>
      <tags>
        <tag>OpenKruise</tag>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OpenKruise æºç åˆ†æžä¹‹ ContainerRecreateRequest]]></title>
    <url>%2F2022%2F07%2F03%2FOpenKruise-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8B-ContainerRecreateRequest%2F</url>
    <content type="text"><![CDATA[OpenKruise æ˜¯åŸºäºŽ CRD çš„æ‹“å±•ï¼ŒåŒ…å«äº†å¾ˆå¤šåº”ç”¨å·¥ä½œè´Ÿè½½å’Œè¿ç»´å¢žå¼ºèƒ½åŠ›ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¼šä»Žæºç å’Œåº•å±‚åŽŸç†ä¸Šè§£è¯»å„ä¸ªç»„ä»¶ï¼Œä»¥å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ä½¿ç”¨å’Œç†è§£ OpenKruiseã€‚è®©æˆ‘ä»¬å¼€å§‹ OpenKruise çš„æºç ä¹‹æ—…å§ï¼ å‰è¨€åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è§£è¯»äº† OpenKruise åŽŸåœ°å‡çº§çš„åŽŸç†å’Œç›¸å…³ä»£ç ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šæˆ‘ä»¬æ¥ç ”ç©¶ä¸€ä¸ªåŸºäºŽåŽŸåœ°å‡çº§èƒ½åŠ›çš„ç»„ä»¶ - ContainerRecreateRequestã€‚ContainerRecreateRequest(ä¸‹æ–‡ç®€ç§° CRR) èƒ½å¤Ÿé‡å»º Pod ä¸­ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚è¯¥åŠŸèƒ½å’Œ Kruise æä¾›çš„åŽŸåœ°å‡çº§ç±»ä¼¼ï¼Œå½“ä¸€ä¸ªå®¹å™¨é‡å»ºçš„æ—¶å€™ï¼ŒPod ä¸­çš„å…¶ä»–å®¹å™¨è¿˜ä¿æŒæ­£å¸¸è¿è¡Œã€‚é‡å»ºå®ŒæˆåŽï¼ŒPod ä¸­é™¤äº†è¯¥å®¹å™¨çš„ restartCount å¢žåŠ ä»¥å¤–ä¸ä¼šæœ‰ä»€ä¹ˆå…¶ä»–å˜åŒ–ã€‚å¦‚æžœæŒ‚è½½äº† volume mount æŒ‚è½½å·ï¼Œå·ä¸­çš„æ•°æ®ä¸ä¼šä¸¢å¤±ä¹Ÿä¸éœ€è¦é‡æ–°æŒ‚è½½ã€‚è¿™ä¸ªåŠŸèƒ½å®žçŽ°äº†è¿ç»´å®¹å™¨ä¸Žä¸šåŠ¡å®¹å™¨çš„ç®¡ç†åˆ†ç¦»ï¼Œæ¯”å¦‚ä¸€ä¸ª Pod ä¸­ä¼šæœ‰ä¸»å®¹å™¨ä¸­è¿è¡Œæ ¸å¿ƒä¸šåŠ¡ï¼Œsidecar ä¸­è¿è¡Œè¿ç»´å®¹å™¨ï¼Œæ¯”å¦‚æ—¥å¿—æ”¶é›†ç­‰.å½“ä¸šåŠ¡å®¹å™¨éœ€è¦é‡å¯çš„æ—¶å€™ï¼Œä¼ ç»Ÿçš„æ›´æ–°æ–¹å¼ä¼šè®©æ•´ä¸ª Pod é‡å¯ä»Žè€Œå¯¼è‡´è¿ç»´å®¹å™¨æ— æ•…è¢«é‡å¯ä»Žè€Œä¸­æ–­æœåŠ¡ï¼Œè€Œä½¿ç”¨ ContainerRecreateRequest å¯ä»¥å®žçŽ°åªè®©ç‰¹å®šçš„å®¹å™¨é‡å¯ï¼Œé«˜æ•ˆçš„åŒæ—¶æ›´åŠ å®‰å…¨ã€‚ ä»Šå¤©å°±è®©æˆ‘ä»¬ä»Žæºç çš„è§’åº¦æ¥çœ‹ä¸€ä¸‹ ContainerRecreateRequest çš„å®žçŽ°åŽŸç†ã€‚ æºç è§£è¯»æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æ•´ä¸ª CRR çš„ä»£ç æµç¨‹æ¦‚è§ˆï¼Œå¯ä»¥çœ‹åˆ°æ•´ä¸ªè¿‡ç¨‹ä¸»è¦æœ‰ä¸‰ä¸ªç»„ä»¶å‚ä¸Žï¼ŒåŒ…æ‹¬ CRR çš„ admission webhookï¼Œ controller managerï¼Œä»¥åŠæˆ‘ä»¬ä¸Šä¸€ç¯‡å°±æåˆ°è¿‡çš„åŽŸåœ°å‡çº§ä¸­çš„é‡è¦ç»„ä»¶ - kruise-daemon ä¸­çš„ crr daemon controllerã€‚ ç„¶åŽæˆ‘ä»¬å†é€æ­¥æ‹†å¼€è®²è§£æ¯ä¸€æ­¥çš„å†…å®¹ã€‚ 1. create CRRå…ˆçœ‹ä¸€ä¸‹ CRR è¿™ä¸ªè‡ªå®šä¹‰èµ„æºçš„ schema å®šä¹‰: 123456789101112131415161718apiVersion: apps.kruise.io/v1alpha1kind: ContainerRecreateRequestmetadata: namespace: pod-namespace name: xxxspec: podName: pod-name containers: # è¦é‡å»ºçš„å®¹å™¨åå­—åˆ—è¡¨ï¼Œè‡³å°‘è¦æœ‰ 1 ä¸ª - name: app - name: sidecar strategy: failurePolicy: Fail # 'Fail' æˆ– 'Ignore'ï¼Œè¡¨ç¤ºä¸€æ—¦æœ‰æŸä¸ªå®¹å™¨åœæ­¢æˆ–é‡å»ºå¤±è´¥ï¼Œ CRR ç«‹å³ç»“æŸ orderedRecreate: false # 'true' è¡¨ç¤ºè¦ç­‰å‰ä¸€ä¸ªå®¹å™¨é‡å»ºå®Œæˆäº†ï¼Œå†å¼€å§‹é‡å»ºä¸‹ä¸€ä¸ª terminationGracePeriodSeconds: 30 # ç­‰å¾…å®¹å™¨ä¼˜é›…é€€å‡ºçš„æ—¶é—´ï¼Œä¸å¡«é»˜è®¤ç”¨ Pod ä¸­å®šä¹‰çš„ unreadyGracePeriodSeconds: 3 # åœ¨é‡å»ºä¹‹å‰å…ˆæŠŠ Pod è®¾ä¸º not readyï¼Œå¹¶ç­‰å¾…è¿™æ®µæ—¶é—´åŽå†å¼€å§‹æ‰§è¡Œé‡å»º minStartedSeconds: 10 # é‡å»ºåŽæ–°å®¹å™¨è‡³å°‘ä¿æŒè¿è¡Œè¿™æ®µæ—¶é—´ï¼Œæ‰è®¤ä¸ºè¯¥å®¹å™¨é‡å»ºæˆåŠŸ activeDeadlineSeconds: 300 # å¦‚æžœ CRR æ‰§è¡Œè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œåˆ™ç›´æŽ¥æ ‡è®°ä¸ºç»“æŸï¼ˆæœªç»“æŸçš„å®¹å™¨æ ‡è®°ä¸ºå¤±è´¥ï¼‰ ttlSecondsAfterFinished: 1800 # CRR ç»“æŸåŽï¼Œè¿‡äº†è¿™æ®µæ—¶é—´è‡ªåŠ¨è¢«åˆ é™¤æŽ‰ ç„¶åŽå¼€å§‹èµ°è¯»ä»£ç æµç¨‹ã€‚ 1.1 æ£€æŸ¥ feature-gateå½“æˆ‘ä»¬åˆ›å»ºä¸€ä¸ª CRR çš„æ—¶å€™ï¼Œä¼šæœ€å…ˆç»è¿‡ adminssion webhookï¼Œwebhook ä¸­ä¼šæœ€å…ˆæ£€æŸ¥å½“å‰ feature gates ä¸­æ˜¯å¦å¼€å¯äº† kruise-daemon ï¼Œå› ä¸ºè¿™ä¸ªåŠŸèƒ½ä¾èµ–äºŽ kruise-daemon ç»„ä»¶æ¥åœæ­¢ Pod å®¹å™¨ï¼Œå¦‚æžœ KruiseDaemon feature-gate è¢«å…³é—­äº†ï¼ŒContainerRecreateRequest ä¹Ÿå°†æ— æ³•ä½¿ç”¨ã€‚ 123456func (h *ContainerRecreateRequestHandler) Handle(ctx context.Context, req admission.Request) admission.Response &#123; if !utilfeature.DefaultFeatureGate.Enabled(features.KruiseDaemon) &#123; return admission.Errored(http.StatusForbidden, fmt.Errorf("feature-gate %s is not enabled", features.KruiseDaemon)) &#125; ...&#125; 1.2 æ³¨å…¥é»˜è®¤å€¼å¹¶æ£€æŸ¥ Podåˆ›å»º CRR çš„æ—¶å€™è¦ä¸ºå…¶æ³¨å…¥ä¸€äº›ç‰¹å®šçš„æ ‡ç­¾ï¼Œä¸ºåŽé¢æŽ§åˆ¶å¯åŠ¨å®¹å™¨çš„æµç¨‹åšå‡†å¤‡ï¼Œæ¯”å¦‚æ‰“ä¸Š ContainerRecreateRequestPodNameKeyï¼ŒContainerRecreateRequestActiveKeyçš„æ ‡ç­¾: 12obj.Labels[appsv1alpha1.ContainerRecreateRequestPodNameKey] = obj.Spec.PodNameobj.Labels[appsv1alpha1.ContainerRecreateRequestActiveKey] = "true" æ£€æŸ¥å½“å‰å¤„ç†çš„ Pod æ˜¯å¦ç¬¦åˆæ›´æ–°æ¡ä»¶ï¼Œæ¯”å¦‚ Pod æ˜¯å¦æ˜¯ active çš„ï¼š12345func IsPodActive(p *v1.Pod) bool &#123; return v1.PodSucceeded != p.Status.Phase &amp;&amp; v1.PodFailed != p.Status.Phase &amp;&amp; p.DeletionTimestamp == nil&#125; ä»¥åŠ Pod æ˜¯å¦å·²ç»å®Œæˆè°ƒåº¦ï¼Œå¦‚æžœæœªå®Œæˆè°ƒåº¦çš„è¯å°±æ— æ³•å®ŒæˆåŽŸåœ°é‡å¯(æ— æ³•ä½¿ç”¨éƒ¨ç½²åˆ°èŠ‚ç‚¹ä¸Šçš„ kruise-daemon)ï¼š 12345if !kubecontroller.IsPodActive(pod) &#123; return admission.Errored(http.StatusBadRequest, fmt.Errorf("not allowed to recreate containers in an inactive Pod")) &#125; else if pod.Spec.NodeName == "" &#123; return admission.Errored(http.StatusBadRequest, fmt.Errorf("not allowed to recreate containers in a pending Pod")) &#125; 1.3 å°† Pod ä¸­çš„ä¿¡æ¯æ³¨å…¥åˆ° CRRCRR çš„è¿è¡Œéœ€è¦èŽ·å– Pod çš„ä¿¡æ¯ï¼Œæ¯”å¦‚èŽ·å– Pod ä¸­çš„ Lifecycle.PreStop è®© kruise-daemon æ‰§è¡Œ preStop hook åŽæŠŠå®¹å™¨åœæŽ‰ï¼ŒèŽ·å–æŒ‡å®šå®¹å™¨çš„ containerID æ¥åˆ¤æ–­é‡å¯åŽ containerID çš„å˜åŒ–ç­‰ã€‚12345678910111213err = injectPodIntoContainerRecreateRequest(obj, pod) if err != nil &#123; return admission.Errored(http.StatusBadRequest, err) &#125;...if podContainer.Lifecycle != nil &amp;&amp; podContainer.Lifecycle.PreStop != nil &#123; c.PreStop = &amp;appsv1alpha1.ProbeHandler&#123; Exec: podContainer.Lifecycle.PreStop.Exec, HTTPGet: podContainer.Lifecycle.PreStop.HTTPGet, TCPSocket: podContainer.Lifecycle.PreStop.TCPSocket, &#125; &#125; ...... 2. CRR controlleråˆ›å»º CRR å¹¶ä¸ºå…¶æ³¨å…¥ç›¸å…³ä¿¡æ¯åŽï¼ŒCRR çš„ controller manager æŽ¥ç®¡ CRR çš„æ›´æ–°ã€‚ 2.1 åŒæ­¥ container statusCRR çš„ status ä¸­åŒ…å«æ‰€è¦é‡å¯çš„ container çš„ç›¸å…³çŠ¶æ€ä¿¡æ¯ï¼š1234567891011121314151617181920type ContainerRecreateRequestStatus struct &#123; // Phase of this ContainerRecreateRequest, e.g. Pending, Recreating, Completed Phase ContainerRecreateRequestPhase `json:"phase"` // Represents time when the ContainerRecreateRequest was completed. It is not guaranteed to // be set in happens-before order across separate operations. // It is represented in RFC3339 form and is in UTC. CompletionTime *metav1.Time `json:"completionTime,omitempty"` // A human readable message indicating details about this ContainerRecreateRequest. Message string `json:"message,omitempty"` // ContainerRecreateStates contains the recreation states of the containers. ContainerRecreateStates []ContainerRecreateRequestContainerRecreateState `json:"containerRecreateStates,omitempty"`&#125;type ContainerRecreateRequestContainerRecreateState struct &#123; // Name of the container. Name string `json:"name"` // Phase indicates the recreation phase of the container. Phase ContainerRecreateRequestPhase `json:"phase"` // A human readable message indicating details about this state. Message string `json:"message,omitempty"`&#125; CRR controller ä¸æ–­æ›´æ–° container çš„é‡å¯ä¿¡æ¯åˆ° status ä¸­ã€‚ 123func (r *ReconcileContainerRecreateRequest) syncContainerStatuses(crr *appsv1alpha1.ContainerRecreateRequest, pod *v1.Pod) error &#123; ...&#125; controller åŒæ­¥ container status çš„é€»è¾‘éžå¸¸é‡è¦ï¼Œåœ¨è¿™é‡Œç¬”è€…æ›¾ç»é‡åˆ°ä¸€ä¸ªè¯¡å¼‚çš„é—®é¢˜ï¼Œå°±æ˜¯åˆ›å»ºäº†å¥½å‡ ä¸ª CRR åŽï¼Œå…¶ä¸­å‡ ä¸ª CRR ä¸€ç›´å¡åœ¨ Recreating çš„çŠ¶æ€ï¼Œå³ä½¿ container å·²ç»é‡å¯å®Œæˆæˆ–è€… TTL åˆ°æœŸä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè¯¦æƒ…å¯ä»¥è§è¿™ä¸ª issueã€‚åŽŸå› å°±æ˜¯åŒæ­¥ container status çš„é€»è¾‘è·Ÿæ—¶é’ŸåŒæ­¥æœ‰å…³ï¼š 123456789containerStatus := util.GetContainerStatus(c.Name, pod) if containerStatus == nil &#123; klog.Warningf("Not found %s container in Pod Status for CRR %s/%s", c.Name, crr.Namespace, crr.Name) continue &#125; else if containerStatus.State.Running == nil || containerStatus.State.Running.StartedAt.Before(&amp;crr.CreationTimestamp) &#123; // åªæœ‰ container çš„åˆ›å»ºæ—¶é—´æ™šäºŽ crr çš„åˆ›å»ºæ—¶é—´ï¼Œæ‰è®¤ä¸º crr é‡å¯äº† containerï¼Œå‡å¦‚æ­¤æ—¶ CRR æ‰€å¤„èŠ‚ç‚¹æˆ–è€… Pod æ‰€åœ¨èŠ‚ç‚¹çš„æ—¶é’Ÿå‘ç”Ÿæ¼‚ç§»ï¼Œé‚£æœ‰å¯èƒ½å‡ºçŽ° container åˆ›å»ºçš„æ—¶é—´æ—©äºŽ crr åˆ›å»ºæ—¶é—´ï¼Œå³ä½¿è¯¥ container æ˜¯ç”± crr æŽ§åˆ¶é‡å¯ã€‚ continue &#125; ... ç»è¿‡æŽ’æŸ¥åŽå‘çŽ°ç¡®å®žæ˜¯å¥½å¤š k8s Node çš„ NTP server å‡ºçŽ°é—®é¢˜å¯¼è‡´æ—¶é’Ÿæ¼‚ç§»ï¼Œå†åŠ ä¸Šä¸Šè¿°çš„é€»è¾‘ï¼Œå°±ä¸éš¾è§£é‡Šä¸ºä½• CRR ä¼šå¡ä½ä¸åŠ¨äº†ã€‚ 2.2 make pod not readyCRR åœ¨é‡å¯ container ä¹‹å‰ä¼šç»™ Pod æ³¨å…¥ä¸€ä¸ª v1.PodConditionType - KruisePodReadyConditionType å¹¶ç½®ä¸º falseï¼Œ ä½¿ Pod è¿›å…¥ not ready çŠ¶æ€ï¼Œä»Ž service çš„ Endpoint ä¸Šæ‘˜æŽ‰æµé‡ã€‚ 1234567891011121314151617condition := GetReadinessCondition(newPod) // èŽ·å– KruisePodReadyConditionType condition if condition == nil &#123; // å¦‚æžœæ²¡æœ‰è®¾ç½®ï¼Œå°±æ–°å»ºä¸€ä¸ª _, messages := addMessage("", msg) newPod.Status.Conditions = append(newPod.Status.Conditions, v1.PodCondition&#123; Type: appspub.KruisePodReadyConditionType, Message: messages.dump(), LastTransitionTime: metav1.Now(), &#125;) &#125; else &#123;// å¦‚æžœå­˜åœ¨è¯¥ conditionï¼Œå°±ç½®ä¸º false changed, messages := addMessage(condition.Message, msg) if !changed &#123; return nil &#125; condition.Status = v1.ConditionFalse condition.Message = messages.dump() condition.LastTransitionTime = metav1.Now() &#125; 3. kruise daemon controllerCRR kruise daemon controller ä¼šç›‘å¬ CRR èµ„æºçš„ create, update, delete äº‹ä»¶ï¼Œç„¶åŽåœ¨ manage å‡½æ•°ä¸­æ›´æ–° CRRã€‚ 3.1 watch CRRCRR controller å°† update å’Œ create äº‹ä»¶éƒ½åŠ å…¥åˆ° process é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å¤„ç†ã€‚1234567891011121314151617181920informer.AddEventHandler(cache.ResourceEventHandlerFuncs&#123; AddFunc: func(obj interface&#123;&#125;) &#123; crr, ok := obj.(*appsv1alpha1.ContainerRecreateRequest) if ok &#123; enqueue(queue, crr) &#125; &#125;, UpdateFunc: func(oldObj, newObj interface&#123;&#125;) &#123; crr, ok := newObj.(*appsv1alpha1.ContainerRecreateRequest) if ok &#123; enqueue(queue, crr) &#125; &#125;, DeleteFunc: func(obj interface&#123;&#125;) &#123; crr, ok := obj.(*appsv1alpha1.ContainerRecreateRequest) if ok &#123; resourceVersionExpectation.Delete(crr) &#125; &#125;, &#125;) 3.2 CRR phase to recreatingdaemon controller çš„ä»£ç å…¥å£å¤„å…ˆæŠŠ CRR çš„ phase è®¾ç½®ä¸º ContainerRecreateRequestRecreating1234// once first update its phase to recreatingif crr.Status.Phase != appsv1alpha1.ContainerRecreateRequestRecreating &#123; return c.updateCRRPhase(crr, appsv1alpha1.ContainerRecreateRequestRecreating)&#125; 3.3 wait for unready grace periodCRR ä¸­çš„ unreadyGracePeriodSeconds è¡¨ç¤ºåœ¨ 2.2 æ­¥éª¤ä¸­å°† Pod è®¾ç½®ä¸º not ready åŽç­‰å¾…å¤šä¹…å†æ‰§è¡Œ restart containerã€‚ 12345678// crr_daemon_controller.goleftTime := time.Duration(*crr.Spec.Strategy.UnreadyGracePeriodSeconds)*time.Second - time.Since(unreadyTime) if leftTime &gt; 0 &#123; klog.Infof("CRR %s/%s is waiting for unready grace period %v left time.", crr.Namespace, crr.Name, leftTime) c.queue.AddAfter(crr.Namespace+"/"+crr.Spec.PodName, leftTime+100*time.Millisecond) return nil &#125; 3.4 KillContainerkruise-daemon ä¼šæ‰§è¡Œ preStop hook åŽæŠŠå®¹å™¨åœæŽ‰ï¼Œç„¶åŽ kubelet æ„ŸçŸ¥åˆ°å®¹å™¨é€€å‡ºï¼Œåˆ™ä¼šæ–°å»ºä¸€ä¸ªå®¹å™¨å¹¶å¯åŠ¨ã€‚ æœ€åŽ kruise-daemon çœ‹åˆ°æ–°å®¹å™¨å·²ç»å¯åŠ¨æˆåŠŸè¶…è¿‡ minStartedSeconds æ—¶é—´åŽï¼Œä¼šä¸ŠæŠ¥è¿™ä¸ªå®¹å™¨çš„ phase çŠ¶æ€ä¸º Succeededã€‚12// crr_daemon_controller.go err := runtimeManager.KillContainer(pod, kubeContainerStatus.ID, state.Name, msg, nil) 3.5 æ›´æ–° CRRContainerRecreateStatesä¸æ–­æ›´æ–° CRR status ä¸­å…³äºŽ container çš„çŠ¶æ€ä¿¡æ¯ - containerRecreateStatesã€‚1c.patchCRRContainerRecreateStates(crr, newCRRContainerRecreateStates) 4. å®Œæˆ CRR4.1 CRR ç½®ä¸º completedè¿™éƒ¨åˆ†é€»è¾‘åœ¨ controller manager å’Œ kruise daemon éƒ½æœ‰ï¼Œè€Œä¸”åˆ¤å®š CRR completed çš„æ–¹å¼æ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¸¾å‡ ä¸ªå…¸åž‹çš„ä¾‹å­ï¼š 4.1.1å½“å®Œæˆé‡å¯ container çš„æ•°é‡è·Ÿ CRR ä¸­ ContainerRecreateStates çš„æ•°ç»„é•¿åº¦ä¸€è‡´çš„æ—¶å€™è®¤ä¸ºå·²ç»å®Œæˆæ‰€æœ‰å®¹å™¨çš„é‡å¯å·¥ä½œï¼Œå¯ä»¥æ ‡è®° CRR ä¸ºå®Œæˆã€‚123if completedCount == len(newCRRContainerRecreateStates) &#123; return c.completeCRRStatus(crr, "") &#125; 4.1.2å½“å‘çŽ°æœ‰å®¹å™¨é‡å¯å¤±è´¥äº†ï¼Œå¹¶ä¸”ç­–ç•¥æ˜¯ ignore å°±ç›´æŽ¥æ ‡è®°æœ¬æ¬¡ CRR ä¸º completedã€‚123456case appsv1alpha1.ContainerRecreateRequestFailed: completedCount++ if crr.Spec.Strategy.FailurePolicy == appsv1alpha1.ContainerRecreateRequestFailurePolicyIgnore &#123; continue &#125; return c.completeCRRStatus(crr, "") 4.1.3ä¸Šé¢ä¸¤ä¸ªä¾‹å­éƒ½æ˜¯åœ¨ crr_daemon_controller.go ä¸­çš„ï¼Œè¿™é‡Œåˆ—ä¸€ä¸ª crr_controller åˆ¤å®šå®Œæˆçš„ä¾‹å­ï¼š 12345678if crr.Spec.ActiveDeadlineSeconds != nil &#123; leftTime := time.Duration(*crr.Spec.ActiveDeadlineSeconds)*time.Second - time.Since(crr.CreationTimestamp.Time) if leftTime &lt;= 0 &#123; klog.Warningf("Complete CRR %s/%s as failure for recreating has exceeded the activeDeadlineSeconds", crr.Namespace, crr.Name) return reconcile.Result&#123;&#125;, r.completeCRR(crr, "recreating has exceeded the activeDeadlineSeconds") &#125; duration.Update(leftTime) &#125; CRR åœ¨è§„å®šçš„ TTL æ—¶é—´é‡Œæ²¡æœ‰å®Œæˆä»»åŠ¡ï¼Œä¼šè¢«åœ¨è¿™é‡Œæ ‡è®°ä¸ºå®Œæˆï¼Œä½†æ˜¯ä¼šæ ‡è®°ä¸€ä¸ªå«æœ‰å¤±è´¥ä¿¡æ¯çš„ messageã€‚ 4.2 åˆ°æœŸåˆ é™¤ CRRå¦‚æžœ CRR è®¾ç½®äº† TTLSecondsAfterFinished å­—æ®µï¼Œè¾¾åˆ°è¯¥æ—¶é—´åŽï¼Œç³»ç»Ÿå°±ä¼šå°† CRR åˆ é™¤ï¼Œè¿™å¯¹å®šæœŸæ¸…ç†å·²ç»å®Œæˆçš„ CRR å¾ˆæœ‰å¸®åŠ©ã€‚ 12345678910if crr.Spec.TTLSecondsAfterFinished != nil &#123; leftTime = time.Duration(*crr.Spec.TTLSecondsAfterFinished)*time.Second - time.Since(crr.Status.CompletionTime.Time) if leftTime &lt;= 0 &#123; klog.Infof("Deleting CRR %s/%s for ttlSecondsAfterFinished", crr.Namespace, crr.Name) if err = r.Delete(context.TODO(), crr); err != nil &#123; return reconcile.Result&#123;&#125;, fmt.Errorf("delete CRR error: %v", err) &#125; return reconcile.Result&#123;&#125;, nil &#125; &#125; ç»“è¯­æ–‡ç« çš„ç»“å°¾å†æ¥å›žé¡¾ä¸€ä¸‹ CRR æ˜¯å¦‚ä½•åœ¨å‡ ä¸ªç»„ä»¶åä½œä¹‹ä¸‹å·¥ä½œçš„ï¼š ä¼ ç»Ÿçš„ Pod é‡å¯å°±æ˜¯å°†åŽŸæœ‰çš„ Pod åˆ é™¤ï¼Œç­‰å¾…é‡å»ºæ–°çš„ Podï¼Œè€Œ CRR çš„å‡ºçŽ°ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å…¨æ–°çš„é‡å¯æœåŠ¡çš„æ–¹å¼ã€‚]]></content>
      <categories>
        <category>OpenKruise</category>
      </categories>
      <tags>
        <tag>OpenKruise</tag>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[OpenKruise æºç å‰–æžä¹‹åŽŸåœ°å‡çº§]]></title>
    <url>%2F2022%2F06%2F19%2FOpenKruise-%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB%E4%B9%8B%E5%8E%9F%E5%9C%B0%E5%8D%87%E7%BA%A7%2F</url>
    <content type="text"><![CDATA[OpenKruise æ˜¯åŸºäºŽ CRD çš„æ‹“å±•ï¼ŒåŒ…å«äº†å¾ˆå¤šåº”ç”¨å·¥ä½œè´Ÿè½½å’Œè¿ç»´å¢žå¼ºèƒ½åŠ›ï¼Œæœ¬ç³»åˆ—æ–‡ç« ä¼šä»Žæºç å’Œåº•å±‚åŽŸç†ä¸Šè§£è¯»å„ä¸ªç»„ä»¶ï¼Œä»¥å¸®åŠ©å¤§å®¶æ›´å¥½åœ°ä½¿ç”¨å’Œç†è§£ OpenKruiseã€‚è®©æˆ‘ä»¬å¼€å§‹ OpenKruise çš„æºç ä¹‹æ—…å§ï¼ 1. èƒŒæ™¯OpenKruise æ˜¯é’ˆå¯¹ Kubernetes çš„å¢žå¼ºèƒ½åŠ›å¥—ä»¶ï¼Œèšç„¦äºŽäº‘åŽŸç”Ÿåº”ç”¨çš„éƒ¨ç½²ã€å‡çº§ã€è¿ç»´ã€ç¨³å®šæ€§é˜²æŠ¤ç­‰é¢†åŸŸã€‚OpenKruise æä¾›çš„ç»å¤§éƒ¨åˆ†èƒ½åŠ›éƒ½æ˜¯åŸºäºŽ CRD æ‰©å±•æ¥å®šä¹‰ï¼Œå®ƒä»¬ä¸å­˜åœ¨äºŽä»»ä½•å¤–éƒ¨ä¾èµ–ï¼Œå¯ä»¥è¿è¡Œåœ¨ä»»æ„çº¯å‡€çš„ Kubernetes é›†ç¾¤ä¸­ã€‚å®ƒåŒ…å«äº†ä¸€ç³»åˆ—å¢žå¼ºç‰ˆæœ¬çš„ Workloadsï¼ˆå·¥ä½œè´Ÿè½½ï¼‰ï¼Œæ¯”å¦‚ CloneSetã€Advanced StatefulSetã€Advanced DaemonSetã€BroadcastJob ç­‰, å®ƒä»¬ä¸ä»…æ”¯æŒç±»ä¼¼äºŽ Kubernetes åŽŸç”Ÿ Workloads çš„åŸºç¡€åŠŸèƒ½ï¼Œè¿˜æä¾›äº†å¦‚åŽŸåœ°å‡çº§ã€å¯é…ç½®çš„æ‰©ç¼©å®¹/å‘å¸ƒç­–ç•¥ã€å¹¶å‘æ“ä½œç­‰ã€‚å…¶ä¸­åŽŸåœ°å‡çº§æ˜¯ OpenKruise çš„æ ¸å¿ƒåŠŸèƒ½, å®ƒåªéœ€è¦ä½¿ç”¨æ–°çš„é•œåƒé‡å»º Pod ä¸­çš„ç‰¹å®šå®¹å™¨ï¼Œæ•´ä¸ª Pod ä»¥åŠå…¶ä¸­çš„å…¶ä»–å®¹å™¨éƒ½ä¸ä¼šè¢«å½±å“ã€‚å› æ­¤å®ƒå¸¦æ¥äº†æ›´å¿«çš„å‘å¸ƒé€Ÿåº¦ï¼Œä»¥åŠé¿å…äº†å¯¹å…¶ä»– Schedulerã€CNIã€CSI ç­‰ç»„ä»¶çš„è´Ÿé¢å½±å“ï¼Œ åƒ CloneSetã€AdvancedStatefulSetã€AdvancedDaemonSetã€SidecarSet çš„çƒ­æ›´æ–°æœºåˆ¶ï¼ŒContainerRestartRequest ç­‰åŠŸèƒ½éƒ½ä¾èµ–åŽŸåœ°å‡çº§ã€‚ç†è§£åŽŸåœ°å‡çº§ä¹‹åŽå†åŽ»ç ”ç©¶å…¶ä»–ç»„ä»¶å°±ä¼šäº‹åŠåŠŸå€ï¼Œæ‰€ä»¥æœ¬æ–‡é¦–å…ˆå¸¦å¤§å®¶åˆ†æžåŽŸåœ°å‡çº§çš„æºç ï¼Œæ¥ä¸€çª¥å…¶åº•å±‚åŽŸç†ã€‚ æœ‰å…³åŽŸåœ°å‡çº§çš„ä½¿ç”¨å’Œä»‹ç»å¯ä»¥å…ˆé˜…è¯»è¿™ç¯‡æ–‡æ¡£ï¼Œä¸‹é¢è®©æˆ‘ä»¬å¼€å§‹è§£è¯»æºç ã€‚ 2. æºç è§£è¯»2.1 Before Pod Update2.1.1 reconcile å…¥å£å‡½æ•°æˆ‘ä»¬ä»¥ CloneSet ä¸ºä¾‹ï¼Œå½“ CloneSet æ›´æ–°åŽï¼Œç›¸åº”çš„ controller æ„ŸçŸ¥åˆ°èµ„æºå˜åŒ–ï¼Œæ­¤æ—¶ä»£ç ä¼šèµ°åˆ° cloneset_controller.go çš„ doReconcile å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯å¤„ç† CloneSet æ›´æ–°çš„ä¸»å¹²å…¥å£ã€‚ 1func (r *ReconcileCloneSet) doReconcile(request reconcile.Request) (res reconcile.Result, retErr error) 2.1.2 syncCloneSetç»è¿‡ä¸€ç³»åˆ—æ£€æŸ¥åŽï¼Œæ‰§è¡Œåˆ° syncCloneSet, è¯¥å‡½æ•°ä¸»è¦æ˜¯å¤„ç† CloneSet çš„ scale å’Œ update pod çš„ç»†èŠ‚, æˆ‘ä»¬è¿™é‡Œåªå…³æ³¨ update æ“ä½œã€‚ 12345func (r *ReconcileCloneSet) syncCloneSet( instance *appsv1alpha1.CloneSet, newStatus *appsv1alpha1.CloneSetStatus, currentRevision, updateRevision *apps.ControllerRevision, revisions []*apps.ControllerRevision, filteredPods []*v1.Pod, filteredPVCs []*v1.PersistentVolumeClaim,) error Kruise ä¸“é—¨ä¸ºè¿™ä¸¤ä¸ªæ“ä½œå£°æ˜Žäº†ä¸¤ä¸ª interface, 12345678910111213// Interface for managing pods scaleing and updating.type Interface interface &#123; Scale( currentCS, updateCS *appsv1alpha1.CloneSet, currentRevision, updateRevision string, pods []*v1.Pod, pvcs []*v1.PersistentVolumeClaim, ) (bool, error) Update(cs *appsv1alpha1.CloneSet, currentRevision, updateRevision *apps.ControllerRevision, revisions []*apps.ControllerRevision, pods []*v1.Pod, pvcs []*v1.PersistentVolumeClaim, ) error&#125; cloneset_update.go ä¸­å®žçŽ°äº†ä¸Šè¿°æŽ¥å£ã€‚ 1234func (c *realControl) Update(cs *appsv1alpha1.CloneSet, currentRevision, updateRevision *apps.ControllerRevision, revisions []*apps.ControllerRevision, pods []*v1.Pod, pvcs []*v1.PersistentVolumeClaim,) error &#123;&#125; 2.1.3 Pod çŠ¶æ€æ£€æŸ¥åœ¨å¯¹ pod æ‰§è¡ŒçœŸæ­£çš„ Update ä¹‹å‰ï¼ŒKruise åšäº†å¾ˆå¤šçš„æ ¡éªŒï¼Œæ¯”å¦‚æ›´æ–° pod çš„ lifecycle çš„ stateï¼Œè®¾ç½®å¯ä»¥æ›´æ–°çš„æœ€å¤§æ•°é‡ï¼Œè¿‡æ»¤æŽ‰ä¸ç¬¦åˆ update æ¡ä»¶çš„ podç­‰ã€‚ä¸‹é¢ä»£ç çš„æ³¨é‡Šä¸­ç»™å‡ºäº†è¯¦ç»†çš„åˆ†æžã€‚ æœ‰å…³ lifecycle(ç”Ÿå‘½å‘¨æœŸé’©å­) çš„æ›´å¤šä»‹ç»ï¼Œå¯ä»¥ç»§ç»­é˜…è¯» è¿™ç¯‡æ–‡æ¡£ 12345678910111213141516171819202122232425262728293031323334353637383940for i, pod := range pods &#123; // åˆ¤æ–­è¯¥ pod æ˜¯å¦æš‚åœå‡çº§ if coreControl.IsPodUpdatePaused(pod) &#123; continue &#125; var waitUpdate, canUpdate bool if diffRes.updateNum &gt; 0 &#123; waitUpdate = !clonesetutils.EqualToRevisionHash("", pod, updateRevision.Name) &#125; else &#123; waitUpdate = clonesetutils.EqualToRevisionHash("", pod, updateRevision.Name) &#125; if waitUpdate &#123; switch lifecycle.GetPodLifecycleState(pod) &#123; // å‡†å¤‡åˆ é™¤çš„ Pod å°±ä¸å‡çº§äº† case appspub.LifecycleStatePreparingDelete: klog.V(3).Infof("CloneSet %s/%s find pod %s in state %s, so skip to update it", cs.Namespace, cs.Name, pod.Name, lifecycle.GetPodLifecycleState(pod)) // å·²ç»æ›´æ–°å®Œæˆçš„ Pod æ— é¡»å‡çº§ case appspub.LifecycleStateUpdated: klog.V(3).Infof("CloneSet %s/%s find pod %s in state %s but not in updated revision", cs.Namespace, cs.Name, pod.Name, appspub.LifecycleStateUpdated) canUpdate = true default: if gracePeriod, _ := appspub.GetInPlaceUpdateGrace(pod); gracePeriod != "" &#123; // åŽŸåœ°å‡çº§ä¸­æä¾›äº† graceful period é€‰é¡¹ï¼Œä½œä¸ºä¼˜é›…åŽŸåœ°å‡çº§çš„ç­–ç•¥ã€‚ç”¨æˆ·å¦‚æžœé…ç½®äº† gracePeriodSeconds è¿™ä¸ªå­—æ®µï¼ŒæŽ§åˆ¶å™¨åœ¨åŽŸåœ°å‡çº§çš„è¿‡ç¨‹ä¸­ä¼šå…ˆæŠŠ Pod status æ”¹ä¸º not-readyï¼Œç„¶åŽç­‰ä¸€æ®µæ—¶é—´ï¼ˆgracePeriodSecondsï¼‰ï¼Œæœ€åŽå†åŽ»ä¿®æ”¹ Pod spec ä¸­çš„é•œåƒç‰ˆæœ¬ã€‚ è¿™æ ·ï¼Œå°±ä¸º endpoints-controller è¿™äº›æŽ§åˆ¶å™¨ç•™å‡ºäº†å……è¶³çš„æ—¶é—´æ¥å°† Pod ä»Ž endpoints ç«¯ç‚¹åˆ—è¡¨ä¸­åŽ»é™¤ã€‚ klog.V(3).Infof("CloneSet %s/%s find pod %s still in grace period %s, so skip to update it", cs.Namespace, cs.Name, pod.Name, gracePeriod) &#125; else &#123; canUpdate = true &#125; &#125; &#125; if canUpdate &#123; waitUpdateIndexes = append(waitUpdateIndexes, i) &#125; &#125; ...... // PUB æ˜¯ OPenKruise çš„å¯ç”¨æ€§é˜²æŠ¤ç»„ä»¶ï¼Œæ˜¯åŽŸç”Ÿ PDB çš„å‡çº§ç‰ˆï¼Œåœ¨å‡çº§çš„åœºæ™¯é‡Œä¹Ÿéœ€è¦æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦ç¬¦åˆ PUB çš„è¦æ±‚ allowed, _, err := pubcontrol.PodUnavailableBudgetValidatePod(c.Client, pod, pubcontrol.NewPubControl(pub, c.controllerFinder, c.Client), pubcontrol.UpdateOperation, false) è¿™é‡Œæœ‰å…³äºŽ PUB çš„è¯¦ç»†ä»‹ç»ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥ç»§ç»­æ·±å…¥äº†è§£ã€‚ 2.2 Check About Pod Inplace Update2.2.1 é€‰æ‹© UpdateStrategy = Inplaceè¿›å…¥åˆ° updatePod å‡½æ•°ï¼Œå¼€å§‹å‡çº§ Podã€‚è¦æƒ³ä½¿ç”¨åŽŸåœ°å‡çº§æœºåˆ¶ï¼Œå¿…é¡»åœ¨ CloneSet çš„ Spec ä¸­æŒ‡å®š UpdateStrategy çš„ Type ä¸º InPlaceIfPossible æˆ–è€… InPlaceOnlyã€‚1234if cs.Spec.UpdateStrategy.Type == appsv1alpha1.InPlaceIfPossibleCloneSetUpdateStrategyType || cs.Spec.UpdateStrategy.Type == appsv1alpha1.InPlaceOnlyCloneSetUpdateStrategyType &#123; ... &#125; 2.2.2 CanUpdateInPlace æ£€æŸ¥æ˜¯å¦æ»¡è¶³åŽŸåœ°å‡çº§çš„æ¡ä»¶å½“ Kruise workload çš„å‡çº§ç±»åž‹åä¸º InplaceOnly çš„æ—¶å€™ï¼Œè¡¨ç¤ºå¼ºåˆ¶ä½¿ç”¨åŽŸåœ°å‡çº§ï¼Œå¦‚æžœä¸æ»¡è¶³åŽŸåœ°å‡çº§æ¡ä»¶ï¼Œå°±ä¼šæŠ¥é”™ï¼› å¦‚æžœæ˜¯ InPlaceIfPossibleï¼Œå®ƒæ„å‘³ç€ Kruise ä¼šå°½é‡å¯¹ Pod é‡‡å–åŽŸåœ°å‡çº§ï¼Œå¦‚æžœä¸èƒ½åˆ™é€€åŒ–åˆ°é‡å»ºå‡çº§ã€‚ åªæœ‰æ»¡è¶³ä»¥ä¸‹çš„æ”¹åŠ¨æ¡ä»¶ä¼šè¢«å…è®¸æ‰§è¡ŒåŽŸåœ°å‡çº§ï¼š æ›´æ–° workload ä¸­çš„ spec.template.metadata.*ï¼Œæ¯”å¦‚ labels/annotationsï¼ŒKruise åªä¼šå°† metadata ä¸­çš„æ”¹åŠ¨æ›´æ–°åˆ°å­˜é‡ Pod ä¸Šã€‚ æ›´æ–° workload ä¸­çš„ spec.template.spec.containers[x].imageï¼ŒKruise ä¼šåŽŸåœ°å‡çº§ Pod ä¸­è¿™äº›å®¹å™¨çš„é•œåƒï¼Œè€Œä¸ä¼šé‡å»ºæ•´ä¸ª Podã€‚ ä»Ž Kruise v1.0 ç‰ˆæœ¬å¼€å§‹ï¼ˆåŒ…æ‹¬ v1.0 alpha/betaï¼‰ï¼Œæ›´æ–° spec.template.metadata.labels/annotations å¹¶ä¸” container ä¸­æœ‰é…ç½® env from è¿™äº›æ”¹åŠ¨çš„ labels/anntationsï¼ŒKruise ä¼šåŽŸåœ°å‡çº§è¿™äº›å®¹å™¨æ¥ç”Ÿæ•ˆæ–°çš„ env å€¼ã€‚ å¦åˆ™ï¼Œå…¶ä»–å­—æ®µçš„æ”¹åŠ¨ï¼Œæ¯”å¦‚ spec.template.spec.containers[x].env æˆ– spec.template.spec.containers[x].resourcesï¼Œéƒ½æ˜¯ä¼šå›žé€€ä¸ºé‡å»ºå‡çº§ã€‚ å®Œæˆè¿™é¡¹æ£€æŸ¥çš„ä»£ç å¦‚ä¸‹:1234567891011121314151617func defaultCalculateInPlaceUpdateSpec(oldRevision, newRevision *apps.ControllerRevision, opts *UpdateOptions) *UpdateSpec &#123; ... patches, err := jsonpatch.CreatePatch(oldRevision.Data.Raw, newRevision.Data.Raw) if err != nil &#123; return nil &#125; oldTemp, err := GetTemplateFromRevision(oldRevision) if err != nil &#123; return nil &#125; newTemp, err := GetTemplateFromRevision(newRevision) if err != nil &#123; return nil &#125; ...&#125; defaultCalculateInPlaceUpdateSpec ä¼šè®¡ç®—å‡ºæ–°æ—§ä¸¤ä¸ªç‰ˆæœ¬çš„å·®å¼‚ï¼Œå¦‚æžœ diff ä¸­åªåŒ…å«ç¬¬2æ­¥éª¤ä¸­çš„æ”¹åŠ¨ï¼Œå°±æ‰§è¡ŒåŽŸåœ°å‡çº§ã€‚ 2.2.3 æ›´æ–° Pod Readiness-gateç¬¦åˆåŽŸåœ°å‡çº§æ¡ä»¶çš„ pod éƒ½ä¼šåœ¨ condition ä¸­å¢žåŠ  InPlaceUpdateReady çš„ ConditionTypeï¼Œå¼€å§‹åŽŸåœ°å‡çº§çš„æ—¶å€™ï¼Œå°†è¯¥å€¼ç½®ä¸º falseï¼Œå¦‚æžœ Pod ä¸Šå±‚æœ‰ Service çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨å°†å‡†å¤‡å‡çº§çš„ pod ä»Ž Endpoint ä¸Šæ‘˜ä¸‹ï¼Œé¿å…å‡çº§è¿‡ç¨‹ä¸­æœ‰æµé‡æŸå¤±ã€‚ 12345678if containsReadinessGate(pod) &#123; newCondition := v1.PodCondition&#123; Type: appspub.InPlaceUpdateReady, LastTransitionTime: metav1.NewTime(Clock.Now()), Status: v1.ConditionFalse, Reason: "StartInPlaceUpdate", &#125; &#125; 2.3 Begin Inplace update2.3.1 Pod annotation ä¸­è®°å½•å‡çº§ä¿¡æ¯1234567inPlaceUpdateState := appspub.InPlaceUpdateState&#123; Revision: spec.Revision, UpdateTimestamp: metav1.NewTime(Clock.Now()), UpdateEnvFromMetadata: spec.UpdateEnvFromMetadata, &#125; inPlaceUpdateStateJSON, _ := json.Marshal(inPlaceUpdateState) clone.Annotations[appspub.InPlaceUpdateStateKey] = string(inPlaceUpdateStateJSON) 2.3.2 æ ¹æ®é…ç½®è®¾ç½® GracefulPeriodåŽŸåœ°å‡çº§ä¸­æä¾›äº† graceful period é€‰é¡¹ï¼Œä½œä¸ºä¼˜é›…åŽŸåœ°å‡çº§çš„ç­–ç•¥ã€‚ç”¨æˆ·å¦‚æžœé…ç½®äº† gracePeriodSeconds è¿™ä¸ªå­—æ®µï¼ŒæŽ§åˆ¶å™¨åœ¨åŽŸåœ°å‡çº§çš„è¿‡ç¨‹ä¸­ä¼šå…ˆæŠŠ Pod status æ”¹ä¸º not-readyï¼Œç„¶åŽç­‰ä¸€æ®µæ—¶é—´ï¼ˆgracePeriodSecondsï¼‰ï¼Œæœ€åŽå†åŽ»ä¿®æ”¹ Pod spec ä¸­çš„é•œåƒç‰ˆæœ¬ã€‚ è¿™æ ·ï¼Œå°±ä¸º endpoints-controller è¿™äº›æŽ§åˆ¶å™¨ç•™å‡ºäº†å……è¶³çš„æ—¶é—´æ¥å°† Pod ä»Ž endpoints ç«¯ç‚¹åˆ—è¡¨ä¸­åŽ»é™¤ã€‚ 123456789if spec.GraceSeconds &lt;= 0 &#123; if clone, err = opts.PatchSpecToPod(clone, spec, &amp;inPlaceUpdateState); err != nil &#123; return err &#125; appspub.RemoveInPlaceUpdateGrace(clone) &#125; else &#123; // Put the info into annotation // æ­¤å¤„è®¾ç½®äº† GracePeriod åŽï¼Œæ•ˆæžœä¼šåœ¨ ä¸Šé¢çš„ reconcile controller ä¸­ä½“çŽ° &#125; 2.3.3 Update Podåœ¨è¿™é‡Œå°±è°ƒç”¨ UpdatePod æ–¹æ³•å¼€å§‹çœŸæ­£å¯¹ Pod åšå‡çº§äº†ã€‚1newPod, updateErr := c.podAdapter.UpdatePod(clone) ä»¥ä¸ŠåŽŸåœ°å‡çº§ç›¸å…³çš„é€»è¾‘éƒ½æ˜¯ç”± kruise_manager ç»„ä»¶è´Ÿè´£çš„ï¼Œä½†æ˜¯å½“æ‰§è¡Œ UpdatePod åŽï¼ŒKruise_manager å°±åªè´Ÿè´£æ­£å¸¸çš„ workload çŠ¶æ€æ›´æ–°ï¼ŒContainer çš„æ›´æ–°ç”±åŽŸåœ°å‡çº§çš„æ ¸å¿ƒç»„ä»¶ Kruise-demaon æŽ¥ç®¡ã€‚ 2.4 kruise_daemonå½“ Kubelet æ”¶åˆ°ä¸€ä¸ª Pod åˆ›å»ºä¹‹åŽï¼Œé€šè¿‡ CRIï¼ˆContainer Runtime Interfaceï¼‰ , CNI ä»¥åŠç±»ä¼¼çš„å…¬å…±æŽ¥å£ï¼ˆä¾‹å¦‚ CSIï¼‰æ¥è°ƒç”¨åº•å±‚çœŸæ­£çš„æŽ¥å£å®žçŽ°è€…åŽ»å®Œæˆæ“ä½œã€‚å¯¹äºŽå®¹å™¨è¿è¡Œæ—¶æ¥è¯´ï¼Œæ˜¯é€šè¿‡ CRI æŽ¥å£è°ƒç”¨åº•å±‚çœŸæ­£çš„ Runtime è¿è¡Œæ—¶æ¥å®Œæˆå¯¹å®¹å™¨çš„åˆ›å»ºå’Œå¯åŠ¨é•œåƒæ‹‰å–è¿™äº›æ“ä½œã€‚å…¶ä¸­ CRI æ˜¯ Kubernetes1.5 ä¹‹åŽåŠ å…¥çš„ä¸€ä¸ªæ–°åŠŸèƒ½ï¼Œç”±åè®®ç¼“å†²åŒºå’Œ gRPC API ç»„æˆï¼Œæä¾›äº†ä¸€ä¸ªæ˜Žç¡®å®šä¹‰çš„æŠ½è±¡å±‚ï¼Œå®ƒçš„ç›®çš„æ˜¯å¯¹äºŽ Kubelet èƒ½å±è”½åº•ä¸‹ Runtime å®žçŽ°çš„ç»†èŠ‚è€Œåªæ˜¾ç¤ºæ‰€éœ€çš„æŽ¥å£ã€‚ Kruise_daemon å°±æ˜¯ä¸€ä¸ªå…¨æ–°çš„ç»„ä»¶ï¼Œä½œä¸º DaemonSet éƒ¨ç½²åˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¯ä»¥è¿žæŽ¥åˆ°èŠ‚ç‚¹ä¸Šçš„ CRI APIï¼Œæ¥æ‹“å±• Kubernetes å®¹å™¨è¿›è¡Œæ—¶çš„æ“ä½œ, å®ƒä¹Ÿå¯ä»¥è°ƒç”¨ CRI è¿™ä¸€å±‚æ¥å®žçŽ° Container Runtime å±‚é¢çš„èƒ½åŠ›ï¼Œæ¯”å¦‚å®ƒå¯ä»¥æ‹‰é•œåƒï¼Œå¯ä»¥é‡å¯å®¹å™¨ã€‚ 2.4.1 Kruise_daemon å…¥å£kruise_daemon çš„å…¥å£å‡½æ•°åœ¨ kruise/cmd/daemon/main.go ä¸­ï¼Œ1234d, err := daemon.NewDaemon(cfg, *bindAddr) if err != nil &#123; klog.Fatalf("Failed to new daemon: %v", err) &#125; è¿›å…¥åˆ° NewDaemon å‡½æ•°ä¸­çœ‹ä¸€çœ¼ï¼Œå‘çŽ°è¿™ä¸ª daemon æœåŠ¡æœ¬è´¨ä¸Šä¹Ÿæ˜¯å‡ ä¸ª controllerï¼Œç”¨æ¥ç›‘å¬ç›¸åº”çš„ Pod å˜åŒ–å¹¶æ‰§è¡Œæ“ä½œã€‚ 1234567891011// kruise/pkg/daemon/daemon.go// åœ¨è¿™é‡Œä¹Ÿèƒ½çœ‹åˆ°å¾ˆå¤šç»„ä»¶éƒ½åœ¨è¿™ä¸ªå‡½æ•°ä¸­æ³¨å†Œäº† controllerï¼Œå› ä¸ºè¿™äº›ç»„ä»¶éƒ½ä¾èµ–åŽŸåœ°å‡çº§çš„èƒ½åŠ›ï¼Œæ¯”å¦‚ ImagePull, ContaienrRestartRequest ç­‰ã€‚if utilfeature.DefaultFeatureGate.Enabled(features.DaemonWatchingPod) &#123; // DaemonWatchingPod enables kruise-daemon to list watch pods that belong to the same node. containerMetaController, err := containermeta.NewController(opts) if err != nil &#123; return nil, fmt.Errorf("failed to new containermeta controller: %v", err) &#125; runnables = append(runnables, containerMetaController) &#125; 2.4.2 è®¡ç®— PlainHash æˆ–è€… ExtractedEnvFromMetadataHash2.4.2.1 å¦‚æžœåªæ˜¯ image update çš„è¯ï¼Œåªéœ€è¦æ›´æ–° image å­—æ®µï¼Œkubelet æ¥æ‰§è¡Œ preStop å’Œ container restartã€‚è¿™æ˜¯å› ä¸º Kubelet åœ¨åˆ›å»ºæ¯ä¸ªå®¹å™¨æ—¶ï¼Œä¼šä¸ºå®¹å™¨è®¡ç®—ä¸€ä¸ª hash å€¼ï¼Œå½“ä¸Šå±‚ä¿®æ”¹äº†å®¹å™¨çš„ image ä¹‹åŽï¼ŒKubelet å°±è®¤ä¸ºå®¹å™¨çš„ hash å€¼å‘ç”Ÿäº†å˜åŒ–ã€‚å½“ Kubelet å‘çŽ° Pod spec ä¸­å®¹å™¨çš„ hash å€¼å’Œå®žé™…çš„ï¼Œå¦‚ container å¯¹åº”çš„ hash å€¼ä¸ä¸€è‡´æ—¶ï¼Œå°±ä¼šæŠŠæ—§çš„å®¹å™¨åœæŽ‰ï¼Œç”¨æ–°çš„é•œåƒå†é‡å»ºæ–°çš„å®¹å™¨ï¼Œä»Žè€Œå®žçŽ°å®¹å™¨çš„åŽŸåœ°å‡çº§çš„èƒ½åŠ›ã€‚ 2.4.2.2 ä»Ž Kruise v1.0 ç‰ˆæœ¬å¼€å§‹ï¼ˆåŒ…æ‹¬ v1.0 alpha/betaï¼‰ï¼Œæ›´æ–° spec.template.metadata.labels/annotations å¹¶ä¸” container ä¸­æœ‰é…ç½® env from è¿™äº›æ”¹åŠ¨çš„ labels/anntationsï¼ŒKruise ä¼šåŽŸåœ°å‡çº§è¿™äº›å®¹å™¨æ¥ç”Ÿæ•ˆæ–°çš„ env å€¼ã€‚ä¹Ÿå°±æ˜¯ä¿®æ”¹çŽ¯å¢ƒå˜é‡ kruise ä¹Ÿæ”¯æŒåŽŸåœ°é‡å¯ï¼Œè¿™éƒ¨åˆ†å·¥ä½œå°±æ˜¯ç”± kruise daemon æ¥å®Œæˆçš„ï¼Œæ ¸å¿ƒçš„ä»£ç åœ¨ kruise/pkg/daemon/containermeta/container_meta_controller.go ä¸­ã€‚ å¼€å¯ InPlaceUpdateEnvFromMetadata feature gate 1if utilfeature.DefaultFeatureGate.Enabled(features.InPlaceUpdateEnvFromMetadata) è®¡ç®— ExtractedEnvFromMetadataHash 1containerMeta.Hashes.ExtractedEnvFromMetadataHash, err = envHasher.GetCurrentHash(containerSpec, envGetter) å°† container ID ä¼ åˆ° restarter çš„å¤„ç†é˜Ÿåˆ—ä¸­ 1c.restarter.queue.AddRateLimited(status.ID) restarter controller ä¸“é—¨ç”¨æ¥å¤„ç†éœ€è¦åŽŸåœ°é‡å¯çš„ container é˜Ÿåˆ—ï¼Œæ ¸å¿ƒé€»è¾‘åœ¨ sync å‡½æ•°ä¸­ï¼Œä¸Šä¸€æ­¥ä¸­åŠ åˆ°é˜Ÿåˆ—çš„ containerID å°±ä¼šåœ¨è¿™é‡Œè¢«å¤„ç†ã€‚ 1func (c *restartController) sync(containerID kubeletcontainer.ContainerID) error æ‰§è¡Œ killCOntainer 1func (m *genericRuntimeManager) KillContainer(pod *v1.Pod, containerID kubeletcontainer.ContainerID, containerName string, message string, gracePeriodOverride *int64) error KillContainer ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ“ä½œï¼Œé¦–å…ˆè°ƒç”¨å¯¹æ—§çš„ container æ‰§è¡Œ preStop ï¼ˆå¦‚æžœæœ‰çš„è¯ï¼‰ï¼Œç„¶åŽè°ƒç”¨å®¹å™¨è¿è¡Œæ—¶æŽ¥å£ StopContainerå°†å®¹å™¨åœæ­¢ã€‚ 1234567// Run the pre-stop lifecycle hooks if applicable and if there is enough time to run itif containerSpec.Lifecycle != nil &amp;&amp; containerSpec.Lifecycle.PreStop != nil &amp;&amp; gracePeriod &gt; 0 &#123; gracePeriod = gracePeriod - m.executePreStopHook(pod, containerID, containerSpec, gracePeriod)&#125; ... err := m.runtimeService.StopContainer(containerID.ID, gracePeriod) ... 2.4.3 kubelet image pull &amp; create containeråœ¨ä¸Šä¸€æ­¥ä¸­å®¹å™¨è¢«åœæ­¢åŽï¼Œkubelet ä¼šå¼€å§‹æ–°å»ºå®¹å™¨ï¼Œç„¶åŽæ›´æ–°å®¹å™¨çš„çŠ¶æ€ã€‚ 2.4.4 kruise manager åŒæ­¥ pod çŠ¶æ€ä¸Žæ­¤åŒæ—¶ï¼Œç›¸å…³çš„ controller ä¹Ÿåœ¨åŒæ­¥ Pod/workloads å‡çº§çš„çŠ¶æ€ã€‚ 123if err = r.statusUpdater.UpdateCloneSetStatus(instance, &amp;newStatus, filteredPods); err != nil &#123; return reconcile.Result&#123;&#125;, err &#125; 2.4.5 kubelet æ ‡è®° Pod Readyå®Œæˆæ›´æ–°åŽï¼Œç”± kubelet æ ‡è®° Pod Readyï¼Œkruise manager å°†ç›¸åº”çš„ worklod åŒæ­¥ä¸ºæ›´æ–°å®Œæˆã€‚ è‡³æ­¤ï¼Œæ•´ä¸ªåŽŸåœ°å‡çº§çš„æµç¨‹å°±å®Œæˆäº†ã€‚ä¸éš¾å‘çŽ°ï¼ŒåŽŸåœ°å‡çº§é™¤äº†ç”¨åˆ°åŽŸç”Ÿ kubernetes æä¾›çš„ informer controller æœºåˆ¶å¤–ï¼Œæœ€æ ¸å¿ƒçš„ä¹Ÿæ˜¯æœ€æœ‰äº®ç‚¹çš„åœ°æ–¹å°±æ˜¯å·§å¦™åœ°å®žçŽ°äº†ä¸€ä¸ªç±»ä¼¼ kubelet çš„ plugin - kruise daemonï¼Œ ä¸ºæˆ‘ä»¬æä¾›äº†ä¸€ç§å…¨æ–°çš„ Kubernetes å®¹å™¨è¿è¡Œæ—¶ operations çš„æ‹“å±•æ€è·¯ã€‚ 3. æºç æµç¨‹å›¾ä»¥ä¸Šçš„ä»£ç å¯ä»¥æ€»ç»“ç®€åŒ–ä¸ºä¸‹é¢è¿™å¼ å›¾ï¼š 4. æ€»ç»“åŽŸåœ°å‡çº§æ˜¯ OpenKruise çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œæ˜¯å…¶ä»–ç»„ä»¶å’ŒåŠŸèƒ½å®žçŽ°çš„åŸºçŸ³ã€‚äº†è§£å…¶åº•å±‚å®žçŽ°åŽŸç†å’Œæºç èƒ½å¤Ÿæ‰©å®½è‡ªå·±çš„æŠ€æœ¯è§†é‡Žï¼ŒåŠ æ·±å¯¹ kubernetes çš„ç†è§£ï¼Œç»™æˆ‘ä»¬æä¾›äº†ä¸€ç§æ–°çš„æ‹“å±• kubelet çš„æ–°æ€è·¯ã€‚åŒæ—¶ï¼Œå½“æˆ‘ä»¬åœ¨ä½¿ç”¨ Openkruise é‡åˆ°é—®é¢˜çš„æ—¶å€™ï¼Œäº†è§£æºç ä¹Ÿæœ‰åŠ©äºŽé—®é¢˜çš„æŽ’æŸ¥ã€‚]]></content>
      <categories>
        <category>OpenKruise</category>
      </categories>
      <tags>
        <tag>OpenKruise</tag>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[[æ‘˜è¦]å¦‚ä½•æž„å»ºåˆ†å¸ƒå¼æ•°æ®åº“ severless æœåŠ¡?]]></title>
    <url>%2F2022%2F06%2F12%2F%E6%91%98%E8%A6%81-%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E5%88%86%E5%B8%83%E5%BC%8F%E6%95%B0%E6%8D%AE%E5%BA%93-severless-%E6%9C%8D%E5%8A%A1%2F</url>
    <content type="text"><![CDATA[åˆ†å¸ƒå¼æ•°æ®åº“ severless æœåŠ¡è¦ç‚¹æœ€è¿‘åœ¨è¯»ä¸€äº›åˆ†å¸ƒå¼æ•°æ®åº“ serverless æœåŠ¡åŒ–çš„æ–‡ç« ï¼Œä»Žä¸­æ€»ç»“å‡ºä¸€äº›æž„å»ºæ­¤ç±»æœåŠ¡é¢ä¸´çš„ç—›ç‚¹ä»¥åŠå¦‚ä½•ç ´å±€çš„è¦ç‚¹ï¼Œç®—æ˜¯ä¸€ä¸ªè¯»ä¹¦ç¬”è®°ã€‚ä¸»è¦å‚è€ƒçš„æ–‡ç« æœ‰ cockroachdb severless è§£è¯», How we built a forever-free serverless SQL databaseã€‚ å¤§è‡´å†…å®¹æçº² ä¸ºä»€ä¹ˆè¦äº‘åŽŸç”Ÿæ•°æ®åº“æ•°æ®åº“çš„ scale èƒ½åŠ›å†³å®šäº†è¿™ä¸ªäº§å“çš„ä¸Šé™ï¼Œè€Œä¸€å®¶å…¬å¸èƒ½ç”¨å¤šå°‘äººæœåŠ¡å¤šå°‘å®¢æˆ·çš„ scale èƒ½åŠ›ï¼Œå†³å®šäº†å…¬å¸è¥æ”¶çš„ä¸Šé™ã€‚è€Œç ´å±€çš„æ–¹å¼å°±æ˜¯æ•°æ®åº“ä¸Šäº‘ï¼ŒæŠŠæ•°æ®åº“çš„æœåŠ¡åŒ–ï¼Œé™ä½Žé—¨æ§›ã€‚ ä¸ºä»€ä¹ˆè¦ serverless åŒ–serverless å–æœåŠ¡çš„å½¢å¼ï¼Œä¸€ä¸ªé›†ç¾¤å°±å¯ä»¥æœåŠ¡â€æ— ç©·â€ä¸ªç§Ÿæˆ·ï¼Œåªè¦æ²¡æœ‰å®žé™…çš„ä½¿ç”¨ï¼Œå¹¶ä¸ä¼šäº§ç”Ÿæˆæœ¬ã€‚å¤šå¢žåŠ ä¸€ä¸ªç§Ÿæˆ·ï¼Œå®ƒçš„è¾¹é™…æˆæœ¬æ˜¯é›¶ã€‚æ‰€ä»¥è¿™ä¸ªæ¨¡å¼æ˜¯ scalable çš„ã€‚ è€Œä¸ºäº†å®žçŽ° serverless çš„ç›®çš„ï¼Œäº‘åŽŸç”Ÿæ•°æ®åº“çš„æž¶æž„å¤§å¤šæ˜¯å­˜å‚¨å’Œè®¡ç®—åˆ†ç¦»çš„ã€‚ å¤šç§Ÿæˆ·çš„èµ„æºéš”ç¦»é—®é¢˜å¦‚æžœæ˜¯å¤šç§Ÿæˆ·å…±äº«è®¡ç®—å±‚å’Œå­˜å‚¨å±‚ï¼Œé‚£å¤æ‚ SQL å°±ä¼šå°†æ•´ä¸ªé›†ç¾¤çš„èµ„æºè€—å°½ï¼Œå½±å“å…¶ä»–ç§Ÿæˆ·ï¼› å¦‚æžœæ˜¯æ¯ä¸ªç§Ÿæˆ·ç‹¬äº«å„è‡ªçš„è®¡ç®—å±‚å’Œå­˜å‚¨å±‚ï¼Œä¹Ÿå°±æ˜¯å›žåˆ°äº†æ¯ä¸ªç§Ÿæˆ·ä¸€å¥—é›†ç¾¤çš„æ¨¡å¼ï¼Œæˆæœ¬éžå¸¸é«˜ã€‚ ç»¼ä¸Šå› ç´ ï¼Œæ¯”è¾ƒå¥½çš„æ–¹å¼æ˜¯ç‹¬äº«è®¡ç®—å±‚ï¼Œå…±äº«å­˜å‚¨å±‚ã€‚ä¸Šå±‚çš„ SQL æ˜¯ç§Ÿæˆ·ä¹‹é—´ç‰©ç†éš”ç¦»çš„ï¼Œä¸‹é¢çš„ kv å­˜å‚¨æ˜¯ç”±æ‰€æœ‰ç§Ÿæˆ·åŽ»å…±äº«çš„ã€‚ å…±äº«å­˜å‚¨ä¹‹åŽï¼Œå¦‚ä½•åŒºåˆ†ç§Ÿæˆ·æ•°æ®å…±äº«å­˜å‚¨å±‚åŽï¼Œå¯ä»¥åœ¨è¯·æ±‚çš„ key çš„ç¼–ç ä¸­æ·»åŠ  tenant-idï¼Œå¤šç§Ÿæˆ·æ¨¡å¼ä¸‹ï¼ŒSQL çš„è¡¨çš„æ•°æ®æ˜ å°„æˆ kv æ•°æ®ï¼Œæœ€ç»ˆçš„ç¼–ç æ˜¯ /tenant-id/table-id/index-id/keyã€‚ é›†ç¾¤æž¶æž„ åè¯è§£é‡ŠBlock storage: å¤šç§Ÿæˆ·å…±äº«çš„å­˜å‚¨ SQL Pod: ç§Ÿæˆ·ç‹¬äº«çš„ SQL è®¡ç®—èŠ‚ç‚¹ Proxy Pod : è´Ÿè´£å°†ç§Ÿæˆ·çš„è¯·æ±‚è·¯ç”±åˆ°æ­£ç¡®çš„ SQL èŠ‚ç‚¹ä¸Š è®¡ç®—èŠ‚ç‚¹æ— çŠ¶æ€ï¼Œè¿™æ„å‘³ç€ SQL pod å¯ä»¥éšç”¨éšèµ·ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æŸä¸ª tenant æ²¡æœ‰æµé‡æ—¶ï¼Œå®Œå…¨å¯ä»¥æŠŠå®ƒçš„ SQL èŠ‚ç‚¹åœä¸‹å…³æŽ‰ï¼Œéœ€è¦çš„æ—¶å€™å†åŠ¨æ€æ‹‰èµ·ã€‚ æ‹“å±•é˜…è¯» ä»¥ä¸Šã€‚]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
        <tag>serverless</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[äº‘åŽŸç”Ÿåº”ç”¨å‘å¸ƒç»„ä»¶ Triton å¼€æºä¹‹æ—…]]></title>
    <url>%2F2021%2F09%2F13%2F%E4%BA%91%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E5%8F%91%E5%B8%83%E7%BB%84%E4%BB%B6-Triton-%E5%BC%80%E6%BA%90%E4%B9%8B%E6%97%85%2F</url>
    <content type="text"><![CDATA[Triton æ¦‚è¿°ä¼´éšç€äº‘åŽŸç”ŸæŠ€æœ¯åœ¨è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šè½åœ°ï¼Œå¦‚ä»Šçš„ Kubernetes å’Œå®¹å™¨å·²ç»å®Œå…¨è¿›å…¥ä¸»æµå¸‚åœºï¼Œæˆä¸ºäº‘è®¡ç®—çš„æ–°ç•Œé¢ï¼Œå¸®åŠ©ä¼ä¸šå……åˆ†äº«å—äº‘åŽŸç”Ÿçš„ä¼˜åŠ¿ï¼ŒåŠ é€Ÿåº”ç”¨è¿­ä»£åˆ›æ–°æ•ˆçŽ‡ï¼Œé™ä½Žå¼€å‘è¿ç»´æˆæœ¬ã€‚ä½†åœ¨å‘ç€äº‘åŽŸç”Ÿæž¶æž„è½¬åž‹çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿæœ‰è®¸å¤šé—®é¢˜éœ€è¦è¢«è§£å†³ã€‚æ¯”å¦‚åŽŸç”Ÿ Kubernetes çš„å¤æ‚æ€§ã€å®¹å™¨åŒ–åº”ç”¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä»¥åŠå‘ä»¥å®¹å™¨ä¸ºåŸºç¡€è®¾æ–½è¿ç§»çš„è¿‡ç¨‹ä¸­å¯èƒ½å‡ºçŽ°çš„æœåŠ¡ç¨³å®šæ€§æŒ‘æˆ˜ç­‰ç­‰ã€‚ å¼€æºäº‘åŽŸç”Ÿåº”ç”¨å‘å¸ƒç»„ä»¶ Triton çš„å‡ºçŽ°ï¼Œå°±æ˜¯ä¸ºäº†è§£å†³ä¼ä¸šåº”ç”¨åœ¨å®¹å™¨åŒ–è¿‡ç¨‹ä¸­å®‰å…¨è½åœ°ç”Ÿäº§çš„é—®é¢˜ã€‚Triton ä»¥ OpenKruise ä½œä¸ºå®¹å™¨åº”ç”¨è‡ªåŠ¨åŒ–å¼•æ“Žï¼Œå®žçŽ°åº”ç”¨è´Ÿè½½çš„æ‰©å±•å¢žå¼ºèƒ½åŠ›ï¼Œä¸ºåŽŸæœ‰æŒç»­äº¤ä»˜ç³»ç»Ÿå¸¦æ¥å…¨é¢å‡çº§ï¼Œä¸ä»…è§£å†³äº†åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å¼€å‘ã€éƒ¨ç½²ã€è¿ç»´ç­‰ï¼ŒåŒæ—¶æ‰“é€šå¾®æœåŠ¡æ²»ç†ï¼Œå¯ä»¥å¸®åŠ©ç ”å‘æå‡æŒç»­äº¤ä»˜çš„æ•ˆçŽ‡ã€‚ æœ‰å…³ Trion è®¾è®¡æ–¹æ¡ˆã€å®žçŽ°åŽŸç†çš„è¯¦ç»†ä»‹ç»å¯ä»¥å‚è€ƒè¿™ç¯‡æ–‡ç« ã€‚æœ¬æ–‡å°†ä»Žæºç çº§å®‰è£…ã€debugã€demo åº”ç”¨å‘å¸ƒæ¼”ç¤ºä¸‰ä¸ªæ–¹é¢ä»‹ç» Triton çš„æ ¸å¿ƒç‰¹æ€§ä»¥åŠ Triton çš„å¿«é€Ÿä¸Šæ‰‹ä½¿ç”¨ã€å¼€å‘ï¼Œæœ€åŽä»‹ç» Triton çš„ Roadmapã€‚ç”±äºŽæ—¶é—´å…³ç³»ï¼Œä¸€é”®å®‰è£…ã€Helm å®‰è£…çš„æ–¹å¼æ­£åœ¨å¼€å‘ä¸­ï¼Œä¼šåœ¨æ­£å¼ç‰ˆæœ¬ release ä¸­æä¾›ã€‚ æ ¸å¿ƒèƒ½åŠ›æœ¬æ¬¡å¸¦æ¥çš„ v0.1.0 å¼€æºç‰ˆæœ¬åœ¨ä»£ç ä¸Šè¿›è¡Œäº†é‡æž„ï¼Œæš‚æ—¶åŽ»æŽ‰äº†å¯¹ç½‘ç»œæ–¹æ¡ˆã€å¾®æœåŠ¡æž¶æž„çš„ä¾èµ–ï¼ŒæŠ½è±¡å‡ºåº”ç”¨æ¨¡åž‹çš„æ¦‚å¿µï¼Œæ›´å…·å¤‡æ™®é€‚æ€§ï¼Œæ ¸å¿ƒç‰¹æ€§å¦‚ä¸‹ï¼š å…¨æ‰˜ç®¡äºŽ k8s é›†ç¾¤ï¼Œä¾¿äºŽç»„ä»¶å®‰è£…ã€ç»´æŠ¤å’Œå‡çº§ï¼› æ”¯æŒä½¿ç”¨ API å’Œ kubectl æ’ä»¶ï¼ˆè§„åˆ’ä¸­ï¼‰å®Œæˆåº”ç”¨åˆ›å»ºã€éƒ¨ç½²ã€å‡çº§ï¼Œå¹¶æ”¯æŒå•æ‰¹å‘å¸ƒã€åˆ†æ‰¹å‘å¸ƒå’Œé‡‘ä¸é›€å‘å¸ƒï¼› æä¾›ä»Žåˆ›å»ºåˆ°è¿è¡Œçš„åº”ç”¨å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†æœåŠ¡ï¼ŒåŒ…æ‹¬åº”ç”¨çš„å‘å¸ƒã€å¯åŠ¨ã€åœæ­¢ã€æ‰©å®¹ã€ç¼©å®¹å’Œåˆ é™¤ç­‰æœåŠ¡ï¼Œå¯ä»¥è½»æ¾ç®¡ç†ä¸Šåƒä¸ªåº”ç”¨å®žä¾‹çš„äº¤ä»˜é—®é¢˜ï¼› Triton æä¾›äº†å¤§é‡ API æ¥ç®€åŒ–éƒ¨ç½²ç­‰æ“ä½œï¼Œå¦‚Nextã€Cancelã€Pauseã€Resumeã€Scaleã€Getsã€Restart ç­‰ï¼Œè½»æ¾å¯¹æŽ¥å…¬å¸å†…éƒ¨çš„ PaaS ç³»ç»Ÿï¼› æ“ä½œæŒ‡å— åœ¨å¼€å§‹ä¹‹å‰ï¼Œæ£€æŸ¥ä¸€ä¸‹å½“å‰çŽ¯å¢ƒæ˜¯å¦æ»¡è¶³ä¸€ä¸‹å‰ææ¡ä»¶: ç¡®ä¿çŽ¯å¢ƒèƒ½å¤Ÿä¸Ž kube-apiserver è¿žé€šï¼› ç¡®ä¿ OpenKruise å·²ç»åœ¨å½“å‰æ“ä½œ k8s é›†ç¾¤å®‰è£…ï¼Œè‹¥æœªå®‰è£…å¯ä»¥å‚è€ƒæ–‡æ¡£ï¼› ç¡®ä¿æœ‰ Golang å¼€å‘çŽ¯å¢ƒï¼ŒFork &amp; git clone ä»£ç åŽï¼Œæ‰§è¡Œ make install å®‰è£… CRD DeployFlow ï¼› æ“ä½œ API çš„è¿‡ç¨‹ä¸­éœ€è¦ grpcurl è¿™ä¸ªå·¥å…·ï¼Œå‚è€ƒ grpcurl æ–‡æ¡£è¿›è¡Œå®‰è£…ï¼› åˆ›å»º DeployFlow æ¥å‘å¸ƒ Nginx Demo Applicationè¿è¡Œ DeployFlow controller è¿›å…¥åˆ°ä»£ç æ ¹ç›®å½•ä¸‹æ‰§è¡Œ make run åˆ›å»º DeployFlow å‡†å¤‡å‘å¸ƒåº”ç”¨ 1kubectl apply -f https://github.com/triton-io/triton/raw/main/docs/tutorial/v1/nginx-deployflow.yaml ä¼šåˆ›å»ºå‡ºä¸€ä¸ª DeployFlow èµ„æºå’Œæœ¬åº”ç”¨å¯¹åº”çš„ Serviceï¼Œå¯ä»¥æŸ¥çœ‹è¯¥ yaml æ–‡ä»¶äº†è§£è¯¦ç»†çš„ DeployFlow å®šä¹‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041apiVersion: apps.triton.io/v1alpha1kind: DeployFlowmetadata: labels: app: "12122" app.kubernetes.io/instance: 12122-sample-10010 app.kubernetes.io/name: deploy-demo-hello group: "10010" managed-by: triton-io name: 12122-sample-10010-df namespace: defaultspec: action: create application: appID: 12122 appName: deploy-demo-hello groupID: 10010 instanceName: 12122-sample-10010 replicas: 3 selector: matchLabels: app: "12122" app.kubernetes.io/instance: 12122-sample-10010 app.kubernetes.io/name: deploy-demo-hello group: "10010" managed-by: triton-io template: metadata: &#123;&#125; spec: containers: - image: nginx:latest name: 12122-sample-10010-container ports: - containerPort: 80 protocol: TCP resources: &#123;&#125; updateStrategy: batchSize: 1 batchIntervalSeconds: 10 canary: 1 # the number of canary batch mode: auto # the mode is auto after canary batch å¯ä»¥çœ‹åˆ°æˆ‘ä»¬æœ¬æ¬¡å‘å¸ƒçš„åº”ç”¨åå­—æ˜¯ 12122-sample-10010ï¼Œå‰¯æœ¬æ•°é‡æ˜¯ 3ï¼Œæ‰¹æ¬¡å¤§å°æ˜¯ 1ï¼Œæœ‰ä¸€ä¸ªé‡‘ä¸é›€æ‰¹æ¬¡ï¼Œæ‰¹æ¬¡å¤§å°æ˜¯ 1ï¼Œå‘å¸ƒçš„æ¨¡å¼æ˜¯ autoï¼Œæ„å‘³ç€æœ¬æ¬¡å‘å¸ƒåªä¼šåœ¨é‡‘ä¸é›€æ‰¹æ¬¡å’Œæ™®é€šæ‰¹æ¬¡ä¹‹é—´æš‚åœï¼ŒåŽç»­ä¸¤ä¸ªæ‰¹æ¬¡ä¼šä»¥ batchIntervalSeconds ä¸ºæ—¶é—´é—´éš”è‡ªåŠ¨è§¦å‘ã€‚ æ£€æŸ¥ DeployFlow çŠ¶æ€ å¯ä»¥çœ‹åˆ°æˆ‘ä»¬åˆ›å»ºå‡ºä¸€ä¸ªåä¸º 12122-sample-10010-df çš„ DeployFlow èµ„æºï¼Œé€šè¿‡å±•ç¤ºçš„å­—æ®µäº†è§£åˆ°æœ¬æ¬¡å‘å¸ƒåˆ†ä¸º 3 ä¸ªæ‰¹æ¬¡ï¼Œå½“å‰æ‰¹æ¬¡çš„å¤§å°æ˜¯ 1ï¼Œå·²å‡çº§å’Œå·²å®Œæˆçš„å‰¯æœ¬æ•°é‡éƒ½æ˜¯ 0ã€‚ å¯åŠ¨å‡ åç§’åŽï¼Œæ£€æŸ¥ DeployFlow çš„ status å­—æ®µï¼š 1kubectl get df 12122-sample-10010-df -o yaml 12345678910111213141516171819202122232425262728293031323334status: availableReplicas: 0 batches: 3 conditions: - batch: 1 batchSize: 1 canary: true failedReplicas: 0 finishedAt: null phase: Smoked pods: - ip: 172.31.230.23 name: 12122-sample-10010-2mwkt phase: ContainersReady port: 80 pullInStatus: "" pulledInAt: null startedAt: "2021-09-13T12:49:04Z" failedReplicas: 0 finished: false finishedAt: null finishedBatches: 0 finishedReplicas: 0 paused: false phase: BatchStarted pods: - 12122-sample-10010-2mwkt replicas: 1 replicasToProcess: 3 startedAt: "2021-09-13T12:49:04Z" updateRevision: 12122-sample-10010-6ddf9b7cf4 updatedAt: "2021-09-13T12:49:21Z" updatedReadyReplicas: 0 updatedReplicas: 1 å¯ä»¥çœ‹åˆ°ç›®å‰åœ¨å¯åŠ¨çš„æ˜¯ canary æ‰¹æ¬¡ï¼Œè¯¥æ‰¹æ¬¡å·²ç»å¤„äºŽ smoked é˜¶æ®µï¼Œè¯¥æ‰¹æ¬¡ä¸­çš„ pod æ˜¯ 12122-sample-10010-2mwkt ï¼ŒåŒæ—¶ä¹Ÿèƒ½çœ‹åˆ°å½“å‰æ‰¹æ¬¡ä¸­ pod çš„æ‹‰å…¥çŠ¶æ€ã€æ‹‰å…¥æ—¶é—´ç­‰ä¿¡æ¯ã€‚ å°†åº”ç”¨æ‹‰å…¥æµé‡åœ¨æ­¤ä¹‹å‰æˆ‘ä»¬å¯ä»¥å…ˆæ£€æŸ¥ä¸€ä¸‹ Service çš„çŠ¶æ€ï¼š 1kubectl describe svc sample-12122-svc -o yaml ä»Žæ˜¾ç¤ºçš„ç»“æžœæ¥çœ‹ï¼Œpod 12122-sample-10010-2mwkt å¹¶æ²¡æœ‰å‡ºçŽ°åœ¨ Service çš„ Endpoints ä¸­ï¼Œæ„å‘³ç€å½“å‰åº”ç”¨æ²¡æœ‰æ­£å¼æŽ¥å…¥æµé‡ï¼š 123456789101112131415161718Name: sample-12122-svcNamespace: defaultLabels: app=12122 app.kubernetes.io/instance=12122-sample-10010 app.kubernetes.io/name=deploy-demo-hello group=10010 managed-by=triton-ioAnnotations: &lt;none&gt;Selector: app.kubernetes.io/instance=12122-sample-10010,app.kubernetes.io/name=deploy-demo-hello,app=12122,group=10010,managed-by=triton-ioType: ClusterIPIP Families: &lt;none&gt;IP: 10.22.6.154IPs: &lt;none&gt;Port: web 80/TCPTargetPort: 80/TCPEndpoints:Session Affinity: NoneEvents: &lt;none&gt; æŽ¥ä¸‹æ¥æˆ‘ä»¬æ‰§è¡Œæ‹‰å…¥æ“ä½œ(Bake)ï¼Œå¯¹åº” pod çš„çŠ¶æ€ä¼šä»Ž ContainerReady å˜ä¸º Readyï¼Œä»Žè€Œè¢«æŒ‚è½½åˆ°å¯¹åº” Service çš„ Endpoints ä¸Šå¼€å§‹æ­£å¼æŽ¥å…¥æµé‡ï¼š 1grpcurl --plaintext -d '&#123;"deploy":&#123;"name":"12122-sample-10010-df","namespace":"default"&#125;&#125;' localhost:8099 deployflow.DeployFlow/Next å†æ¬¡æ£€æŸ¥ DeployFlowï¼ŒServiceï¼ŒCloneSet çš„çŠ¶æ€åŽï¼Œå‘çŽ° Pod å·²è¢«æŒ‚è½½åˆ° Endpointsï¼ŒDeployFlow çš„ UPDATED_READY_REPLICAS å­—æ®µå˜ä¸º 1ï¼Œé‡‘ä¸é›€æ‰¹æ¬¡è¿›å…¥ baking é˜¶æ®µï¼Œå¦‚æžœæ­¤æ—¶åº”ç”¨æ­£å¸¸å·¥ä½œï¼Œæˆ‘ä»¬å†æ¬¡æ‰§è¡Œä¸Šé¢çš„ Next æ“ä½œï¼Œå°† DeployFlow ç½®ä¸º baked é˜¶æ®µï¼Œè¡¨ç¤ºæœ¬æ‰¹æ¬¡ç‚¹ç«æˆåŠŸï¼Œåº”ç”¨æµé‡æ­£å¸¸ã€‚ Rollout æ“ä½œé‡‘ä¸é›€æ‰¹æ¬¡åˆ°è¾¾ baked é˜¶æ®µåŽï¼Œæ‰§è¡Œ Next æ“ä½œå°±ä¼šè¿›å…¥åŽé¢çš„æ™®é€šæ‰¹æ¬¡å‘å¸ƒï¼Œç”±äºŽæˆ‘ä»¬åº”ç”¨çš„å‰¯æœ¬æ•°é‡è®¾ç½®ä¸º 3ï¼ŒåŽ»æŽ‰é‡‘ä¸é›€æ‰¹æ¬¡ä¸­çš„ä¸€ä¸ªå‰¯æœ¬åŽï¼Œè¿˜å‰© 2 ä¸ªï¼Œè€Œ batchSize çš„å¤§å°ä¸º 1ï¼Œæ‰€æœ‰å‰©ä½™çš„æ™®é€šæ‰¹æ¬¡ä¼šåˆ†ä¸¤ä¸ªæ‰¹æ¬¡å‘å¸ƒï¼Œä¸¤ä¸ªæ‰¹æ¬¡ä¹‹é—´ä¼šé—´éš” 10s è§¦å‘ã€‚ 1grpcurl --plaintext -d '&#123;"deploy":&#123;"name":"12122-sample-10010-df","namespace":"default"&#125;&#125;' localhost:8099 deployflow.DeployFlow/Next æœ€åŽåº”ç”¨å‘å¸ƒå®Œæˆï¼Œæ£€æŸ¥ DeployFlow çš„çŠ¶æ€ä¸º Success: å†æ¬¡æŸ¥çœ‹ Service çš„ Endpoints å¯ä»¥çœ‹åˆ°æœ¬æ¬¡å‘å¸ƒçš„ 3 ä¸ªå‰¯æœ¬éƒ½å·²ç»æŒ‚è½½ä¸ŠåŽ»ã€‚ å†æ¬¡å›žé¡¾æ•´ä¸ªå‘å¸ƒæµç¨‹ï¼Œå¯ä»¥æ€»ç»“ä¸ºä¸‹é¢çš„çŠ¶æ€æµè½¬å›¾ï¼š æš‚åœ/ç»§ç»­ DeployFlowåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­ï¼Œå¦‚æžœè¦æš‚åœ DeployFlowï¼Œå¯ä»¥æ‰§è¡Œ Pause æ“ä½œï¼š 1grpcurl --plaintext -d '&#123;"deploy":&#123;"name":"12122-sample-10010-df","namespace":"default"&#125;&#125;' localhost:8099 deployflow.DeployFlow/Pause å¯ä»¥ç»§ç»­å‘å¸ƒäº†ï¼Œå°±æ‰§è¡Œ Resume æ“ä½œï¼š 1grpcurl --plaintext -d '&#123;"deploy":&#123;"name":"12122-sample-10010-df","namespace":"default"&#125;&#125;' localhost:8099 deployflow.DeployFlow/Resume å–æ¶ˆæœ¬æ¬¡å‘å¸ƒå¦‚æžœåœ¨å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œé‡åˆ°å¯åŠ¨å¤±è´¥ï¼Œæˆ–è€…æ‹‰å…¥å¤±è´¥çš„æƒ…å†µï¼Œè¦å–æ¶ˆæœ¬æ¬¡å‘å¸ƒï¼Œå¯æ‰§è¡Œ Cancel æ“ä½œï¼š 1grpcurl --plaintext -d '&#123;"deploy":&#123;"name":"12122-sample-10010-df","namespace":"default"&#125;&#125;' localhost:8099 deployflow.DeployFlow/Cancel å¯åŠ¨ä¸€ä¸ªæ‰©ç¼©å®¹ DeployFlowåŒæ ·å¯ä»¥ä½¿ç”¨ auto æˆ– mannual æ¨¡å¼åˆ’åˆ†å¤šä¸ªæ‰¹æ¬¡æ¥æ‰§è¡Œæ‰©ç¼©å®¹æ“ä½œã€‚ å½“ä¸€ä¸ª CloneSet ç¼©å®¹æ—¶ï¼Œæœ‰æ—¶ç”¨æˆ·å€¾å‘äºŽåˆ é™¤ç‰¹å®šçš„ Podï¼Œå¯ä»¥ä½¿ç”¨ podsToDelete å­—æ®µå®žçŽ°æŒ‡å®š Pod ç¼©å®¹ï¼š 1234kubectl get pod | grep 12122-sample12122-sample-10010-2mwkt 1/1 Running 0 29m12122-sample-10010-hgdp6 1/1 Running 0 9m55s12122-sample-10010-zh98f 1/1 Running 0 10m æˆ‘ä»¬åœ¨ç¼©å®¹çš„æ—¶å€™æŒ‡å®šè¢«ç¼©æŽ‰çš„ Pod ä¸º 12122-sample-10010-zh98f: 123456789grpcurl --plaintext -d '&#123;"instance":&#123;"name":"12122-sample-10010","namespace":"default"&#125;,"replicas":2,"strategy":&#123;"podsToDelete":["12122-sample-10010-zh98f"],"batchSize":"1","batches":"1","batchIntervalSeconds":10&#125;&#125;' \localhost:8099 application.Application/Scale&#123; "deployName": "12122-sample-10010-kvn6b"&#125;â¯ kubectl get pod | grep 12122-sample12122-sample-10010-2mwkt 1/1 Running 0 29m12122-sample-10010-zh98f 1/1 Running 0 11m CloneSet è¢«ç¼©å®¹ä¸º 2 ä¸ªå‰¯æœ¬ï¼Œè¢«ç¼©å®¹çš„ Pod æ­£æ˜¯æŒ‡å®šçš„é‚£ä¸ªã€‚è¯¥åŠŸèƒ½çš„å®žçŽ°å¾—ç›ŠäºŽ OpenKruise ä¸­å¢žå¼ºåž‹æ— çŠ¶æ€ workload CloneSet æä¾›çš„èƒ½åŠ›ï¼Œå…·ä½“çš„åŠŸèƒ½æè¿°å¯ä»¥å‚è€ƒ OpenKruise æ–‡æ¡£ã€‚ åœ¨æ“ä½œè¿‡ç¨‹ä¸­ï¼ŒTriton ä¹Ÿæä¾›äº† Get æ–¹æ³•å®žæ—¶èŽ·å–å½“å‰ DeployFlow çš„ Pod ä¿¡æ¯ï¼š 1grpcurl --plaintext -d '&#123;"deploy":&#123;"name":"12122-sample-10010-df","namespace":"default"&#125;&#125;' localhost:8099 deployflow.DeployFlow/Get 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879&#123; "deploy": &#123; "namespace": "default", "name": "12122-sample-10010-df", "appID": 12122, "groupID": 10010, "appName": "deploy-demo-hello", "instanceName": "12122-sample-10010", "replicas": 3, "action": "create", "availableReplicas": 3, "updatedReplicas": 3, "updatedReadyReplicas": 3, "updateRevision": "6ddf9b7cf4", "conditions": [ &#123; "batch": 1, "batchSize": 1, "canary": true, "phase": "Baked", "pods": [ &#123; "name": "12122-sample-10010-2mwkt", "ip": "172.31.230.23", "port": 80, "phase": "Ready", "pullInStatus": "PullInSucceeded" &#125; ], "startedAt": "2021-09-13T12:49:04Z", "finishedAt": "2021-09-13T13:07:43Z" &#125;, &#123; "batch": 2, "batchSize": 1, "phase": "Baked", "pods": [ &#123; "name": "12122-sample-10010-zh98f", "ip": "172.31.226.94", "port": 80, "phase": "Ready", "pullInStatus": "PullInSucceeded" &#125; ], "startedAt": "2021-09-13T13:07:46Z", "finishedAt": "2021-09-13T13:08:03Z" &#125;, &#123; "batch": 3, "batchSize": 1, "phase": "Baked", "pods": [ &#123; "name": "12122-sample-10010-hgdp6", "ip": "172.31.227.215", "port": 80, "phase": "Ready", "pullInStatus": "PullInSucceeded" &#125; ], "startedAt": "2021-09-13T13:08:15Z", "finishedAt": "2021-09-13T13:08:45Z" &#125; ], "phase": "Success", "finished": true, "batches": 3, "batchSize": 1, "finishedBatches": 3, "finishedReplicas": 3, "startedAt": "2021-09-13T12:49:04Z", "finishedAt": "2021-09-13T13:08:45Z", "mode": "auto", "batchIntervalSeconds": 10, "canary": 1, "updatedAt": "2021-09-13T13:08:45Z" &#125;&#125; TODOSä¸Šé¢æ¼”ç¤ºçš„å°±æ˜¯ Triton æä¾›çš„æ ¸å¿ƒèƒ½åŠ›ã€‚å¯¹äºŽåŸºç¡€å›¢é˜Ÿæ¥è¯´ï¼ŒTriton ä¸ä»…ä»…æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒä¹Ÿæ˜¯ä¸€ä¸ªçœŸå®žçš„æ¯”è¾ƒæŽ¥åœ°æ°”çš„äº‘åŽŸç”ŸæŒç»­äº¤ä»˜é¡¹ç›®ã€‚é€šè¿‡å¼€æºï¼Œæˆ‘ä»¬å¸Œæœ› Triton èƒ½ä¸°å¯Œäº‘åŽŸç”Ÿç¤¾åŒºçš„æŒç»­äº¤ä»˜å·¥å…·ä½“ç³»ï¼Œä¸ºæ›´å¤šå¼€å‘è€…å’Œä¼ä¸šæ­å»ºäº‘åŽŸç”ŸåŒ–çš„ PaaS å¹³å°åŠ©åŠ›ï¼Œæä¾›ä¸€ç§çŽ°ä»£çš„ã€é«˜æ•ˆçš„çš„æŠ€æœ¯æ–¹æ¡ˆã€‚ å¼€æºåªæ˜¯è¿ˆå‡ºçš„ä¸€å°æ­¥ï¼Œæœªæ¥æˆ‘ä»¬ä¼šè¿›ä¸€æ­¥æŽ¨åŠ¨ Triton ä¸æ–­èµ°å‘å®Œå–„ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºŽä»¥ä¸‹å‡ ç‚¹ï¼š æ”¯æŒè‡ªå®šä¹‰æ³¨å†Œä¸­å¿ƒï¼Œå¯ä»¥çœ‹åˆ°ç›®å‰ Triton é‡‡ç”¨çš„æ˜¯ k8s åŽŸç”Ÿçš„ Service ä½œä¸ºåº”ç”¨çš„æ³¨å†Œä¸­å¿ƒï¼Œä½†æ®æˆ‘ä»¬æ‰€äº†è§£ï¼Œå¾ˆå¤šä¼ä¸šéƒ½ä½¿ç”¨è‡ªå®šä¹‰çš„æ³¨å†Œä¸­å¿ƒï¼Œæ¯”å¦‚ spring cloud çš„ Nacos ç­‰ï¼› æä¾› helm å®‰è£…æ–¹å¼ï¼› å®Œå–„ REST &amp; GRPC API ä»¥åŠç›¸åº”æ–‡æ¡£ï¼› ç»“åˆå†…å¤–éƒ¨ç”¨æˆ·éœ€æ±‚ï¼ŒæŒç»­è¿­ä»£ã€‚é¡¹ç›®å¼€æºåŽï¼Œæˆ‘ä»¬ä¹Ÿä¼šæ ¹æ®å¼€å‘è€…éœ€æ±‚å¼€å±•è¿­ä»£ã€‚ æ¬¢è¿Žå¤§å®¶å‘ Triton æäº¤ issue å’Œ PR å…±å»º Triton ç¤¾åŒºã€‚æˆ‘ä»¬è¯šå¿ƒæœŸå¾…æ›´å¤šçš„å¼€å‘è€…åŠ å…¥ï¼Œä¹ŸæœŸå¾… Triton èƒ½å¤ŸåŠ©åŠ›è¶Šæ¥è¶Šå¤šçš„ä¼ä¸šå¿«é€Ÿæž„å»ºäº‘åŽŸç”ŸæŒç»­äº¤ä»˜å¹³å°ã€‚å¦‚æžœæœ‰ä¼ä¸šæˆ–è€…ç”¨æˆ·æ„Ÿå…´è¶£ï¼Œæˆ‘ä»¬å¯ä»¥æä¾›ä¸“é¡¹æŠ€æœ¯æ”¯æŒå’Œäº¤æµï¼Œæ¬¢è¿Žå…¥ç¾¤å’¨è¯¢ã€‚ ç›¸å…³é“¾æŽ¥é¡¹ç›®åœ°å€ï¼šhttps://github.com/triton-io/triton äº¤æµç¾¤]]></content>
      <categories>
        <category>æŒç»­äº¤ä»˜</category>
      </categories>
      <tags>
        <tag>äº‘åŽŸç”Ÿ</tag>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŽŒé—¨ä¸‹ä¸€ä»£å®¹å™¨å‘å¸ƒç³»ç»Ÿ Triton]]></title>
    <url>%2F2021%2F07%2F21%2F%E6%8E%8C%E9%97%A8%E4%B8%8B%E4%B8%80%E4%BB%A3%E5%AE%B9%E5%99%A8%E5%8F%91%E5%B8%83%E7%B3%BB%E7%BB%9F-Triton%2F</url>
    <content type="text"><![CDATA[æŽŒé—¨ä¸‹ä¸€ä»£å®¹å™¨å‘å¸ƒç³»ç»Ÿ Triton CD å¹³å°æ˜¯æŽŒé—¨çš„æŒç»­äº¤ä»˜ç³»ç»Ÿï¼ŒTriton ä½œä¸º CD å¹³å°çš„æ ¸å¿ƒå®¹å™¨å‘å¸ƒç»„ä»¶ï¼Œè‡ª 2020.4 æœˆåœ¨ CD å¹³å°ä¸Šæ­£å¼ä¸Šçº¿ï¼Œæ”¯æ’‘äº†æŽŒé—¨è¿‘ 1000 ä¸ªåº”ç”¨ä»Žè™šæœºè¿ç§»è‡³å®¹å™¨çš„è¿‡ç¨‹ï¼Œä¿éšœäº†è™šæœºè¿å®¹å™¨è¿‡ç¨‹çš„ç¨³å®šæ€§ã€‚ç›®å‰ï¼ŒTriton é™¤äº†æä¾›æ—¥å¸¸çš„åº”ç”¨å®¹å™¨å‘å¸ƒã€ç½‘ç»œç­–ç•¥é…ç½®ã€Ingress åŸŸåé…ç½®ç­‰èƒ½åŠ›ä¹‹å¤–ï¼Œä¹Ÿæˆä¸ºå…¶ä»–ç»„ä»¶ã€å¹³å°çš„èµ„æºäº¤ä»˜åŸºåº§ï¼Œæ¯”å¦‚ï¼Œå¤§è§„æ¨¡çš„æµæ°´çº¿äº¤ä»˜ï¼ŒåŽ‹æµ‹å¹³å°ç­‰ã€‚Triton è§£å†³äº†åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†çš„é—®é¢˜ï¼ŒåŒ…æ‹¬å¼€å‘ã€éƒ¨ç½²ã€è¿ç»´ç­‰ï¼ŒåŒæ—¶æ‰“é€šäº†å¾®æœåŠ¡æ²»ç†ï¼Œæžå¤§åœ°å¸®åŠ©ç ”å‘æå‡äº†æŒç»­äº¤ä»˜çš„æ•ˆçŽ‡ã€‚ 1. èƒŒæ™¯äº‘åŽŸç”Ÿæž¶æž„çš„å¿«é€Ÿæ™®åŠå¸¦æ¥äº†ä¼ä¸šåŸºç¡€è®¾æ–½å’Œåº”ç”¨æž¶æž„ç­‰æŠ€æœ¯å±‚é¢çš„é©æ–°ã€‚åœ¨ CNCF 2020 å¹´åº¦ä¸­å›½åŒºäº‘åŽŸç”Ÿè°ƒæŸ¥æŠ¥å‘Šé‡Œé¢æœ‰ä¸€ä¸ªäº®çœ¼çš„æ•°å­—ï¼Œ72% çš„å—è®¿è€…å·²ç»åœ¨ç”Ÿäº§çŽ¯å¢ƒå½“ä¸­ä½¿ç”¨ Kubernetesï¼ŒåŒæœŸå…¨çƒè°ƒæŸ¥æŠ¥å‘Šçš„æ•°å­—æ˜¯ 83%ã€‚å¯ä»¥çœ‹åˆ°ï¼Œåœ¨ Kubernetes çš„ä½¿ç”¨çŽ‡ä¸Šï¼Œä¸­å›½å’Œå…¨çƒæ˜¯æŒå¹³çš„ã€‚å¦‚æžœçœ‹çº¯å®¹å™¨ä½¿ç”¨çŽ‡ï¼Œåˆ™æ›´åŠ æƒŠäººï¼Œè¶…è¿‡ 92%ã€‚ä»Žè¿™äº›æ•°æ®æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºç»“è®ºï¼šKubernetes å’Œå®¹å™¨å·²ç»å®Œå…¨è¿›å…¥ä¸»æµå¸‚åœºï¼Œæˆä¸ºæ‰€æœ‰äººéƒ½åœ¨ä½¿ç”¨çš„æŠ€æœ¯ã€‚ åœ¨æ­¤ä¹‹å‰ï¼ŒæŽŒé—¨çš„åº”ç”¨ä¸€ç›´è·‘åœ¨è™šæœºé‡Œï¼Œä½†æ˜¯éšç€åº”ç”¨è§„æ¨¡çš„ä¸æ–­æ‰©å¤§ï¼Œè™šæœºæ•°é‡ä¹Ÿéšä¹‹å¿«é€Ÿå¢žåŠ ï¼Œæˆ‘ä»¬å¼€å§‹åœ¨è¿ç»´æˆæœ¬ã€äº¤ä»˜æ•ˆçŽ‡ã€åº”ç”¨ç®¡ç†ä¸Šé¢ä¸´ä¸€äº›ç—›ç‚¹ï¼š åº”ç”¨æ•°é‡ä¸æ–­å¢žåŠ ï¼ŒåŸºç¡€è®¾æ–½çš„æˆæœ¬éšä¹‹ä¸Šå‡ï¼Œé™æœ¬è¿«åœ¨çœ‰ç«ï¼› ä¸šåŠ¡é£žé€Ÿå‘å±•ï¼Œå†…éƒ¨å¯¹èµ„æºã€çŽ¯å¢ƒã€åº”ç”¨çš„äº¤ä»˜æ•ˆçŽ‡çš„è¦æ±‚ä¸æ–­æé«˜ï¼› åº”ç”¨æ•°é‡å¢žé•¿å¾ˆå¿«ï¼Œå¤§é‡åº”ç”¨çš„ç®¡ç†ç»™è¿ç»´å¸¦æ¥å¾ˆå¤§åŽ‹åŠ›ã€‚ æ‰€ä»¥ï¼Œä¸ºäº†èƒ½å¤Ÿå……åˆ†å‘æŒ¥äº‘åŽŸç”Ÿçš„ä¼˜åŠ¿ï¼Œçµæ´»åœ°åº”å¯¹å˜åŒ–å’Œå¼¹æ€§æ‰©å±•ä»¥æå‡å¼€å‘æ•ˆçŽ‡ï¼ŒåŠ é€Ÿè¿­ä»£å¹¶é™ä½Žæˆæœ¬ï¼ŒæŽŒé—¨äºŽ 2020 å¹´ 4 æœˆä»½æ­£å¼å¯åŠ¨å®¹å™¨åŒ–é¡¹ç›®ã€‚ ä¸ºäº†æœ€å¤§ç¨‹åº¦é™ä½Žè¿ç§»å®¹å™¨è¿‡ç¨‹ä¸­å¯¹å¼€å‘å’Œä¸šåŠ¡çš„å½±å“ï¼Œæˆ‘ä»¬å†³å®šåœ¨åº”ç”¨å‘å¸ƒä¸­å®Œæˆä»Žè™šæœºåˆ°å®¹å™¨çš„è¿ç§»ï¼Œä»¥ä¿éšœè¿ç§»è¿‡ç¨‹ä¸­æœåŠ¡çš„ç¨³å®šæ€§ï¼Œå®žçŽ°ä¸åœæœè¿ç§»ã€‚è¦å®žçŽ°è¿™ä¸ªç›®æ ‡ï¼Œä¸€ä¸ªå…¨æ–°çš„ã€æ”¯æŒå®¹å™¨å‘å¸ƒçš„å¹³å°å‘¼ä¹‹æ¬²å‡ºï¼ŒTriton å°±æ˜¯åœ¨è¿™ç§èƒŒæ™¯ä¸‹è¯žç”Ÿçš„ã€‚ä¸‹é¢å°†ä»‹ç»å®¹å™¨å‘å¸ƒå¹³å° Triton çš„è®¾è®¡åŽŸç†ã€å®žçŽ°æ–¹æ¡ˆã€‚ 2. Triton è®¾è®¡åŽŸç†åŠå®žçŽ°æ–¹æ¡ˆåœ¨ä»‹ç» Triton ä¹‹å‰æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹ CNCF å¯¹æŒç»­äº¤ä»˜çš„å®šä¹‰ï¼Œæ¶µç›–äº†ä¸€ä¸ªäº‘åŽŸç”Ÿåº”ç”¨çš„å…¨ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼Œå›¾ä¸­çš„ä¸€äº›æŠ€æœ¯æœ¯è¯­åœ¨æœ¬æ–‡ä¸­ä¹Ÿä¼šç”¨åˆ°ï¼Œæ¯”å¦‚ workloadï¼Œrolloutï¼Œcanaryç­‰ï¼Œ è¿™ç¯‡æ–‡æ¡£ ä¸­æœ‰è¯¦ç»†çš„ä»‹ç»ï¼Œéœ€è¦çš„è¯å¯ä»¥æŸ¥é˜…ã€‚ åŒæ—¶é€šè¿‡è¿™å¼ å›¾ï¼Œä¹Ÿå¯ä»¥æ¸…æ™°åœ°äº†è§£ Triton åœ¨æ•´ä¸ªæŒç»­å‘å¸ƒç³»ç»Ÿä¸­çš„å®šä½ã€‚Topic 1ï¼ŒTopic 1.5 çš„ä¸»è¦å†…å®¹æ˜¯åº”ç”¨æ¨¡åž‹æè¿°ï¼Œæ‰“åŒ…ã€å‚æ•°é…ç½®ï¼›Topic 4 æ˜¯èµ„æºç®¡ç†ï¼Œç½‘ç»œï¼Œæ—¥å¿— / ç›‘æŽ§ç­‰å¹³å°ä¾§çš„åŠŸèƒ½ï¼›è€Œ Triton èšç„¦çš„å·¥ä½œæ˜¯åœ¨ Topic 2 å’Œ Topic 3 ï¼Œä¸»è¦å†…å®¹æ˜¯åº”ç”¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œæµé‡ç®¡ç†ï¼Œworkload ç®¡ç†ï¼Œæä¾›å‘å¸ƒç­–ç•¥ï¼Œæ¯”å¦‚è“ç»¿éƒ¨ç½²ã€é‡‘ä¸é›€éƒ¨ç½²ç­‰ã€‚ äº†è§£äº† Triton çš„å®šä½åŽï¼Œä¸‹é¢å°†ä»Žæ–¹æ¡ˆé€‰åž‹ï¼Œæž¶æž„è®¾è®¡ï¼ŒUI äº¤äº’ 3 ä¸ªç»´åº¦æ¥è¯¦ç»†ä»‹ç» Triton çš„è®¾è®¡åŽŸç†å’Œå®žçŽ°æ–¹æ¡ˆã€‚ 2.1 æ–¹æ¡ˆé€‰åž‹2.1.1 workload é€‰åž‹ä¼—æ‰€å‘¨çŸ¥ï¼Œä¸ç®¡æ˜¯æ— çŠ¶æ€çš„ Deployment è¿˜æ˜¯æœ‰çŠ¶æ€çš„ StatefulSetï¼Œkubernetes éƒ½æ˜¯æ”¯æŒæœåŠ¡çš„æ»šåŠ¨æ›´æ–°çš„ã€‚æˆ‘ä»¬ä¹Ÿç»å¸¸åœ¨ä¸€äº›æ–‡ç« ä¸­çœ‹åˆ°æœ‰åŸºäºŽåŽŸç”Ÿ Deployment å®žçŽ°åº”ç”¨çš„æ»šåŠ¨å‘å¸ƒå’Œç°åº¦å‘å¸ƒï¼Œè¿™ç§æ–¹å¼å¼€å‘ç®€å•å®¹æ˜“ä¸Šæ‰‹ï¼Œä½†æ˜¯éšä¹‹å¸¦æ¥äº†å¾ˆå¤šç¼ºé™·ï¼Œä½¿å¾—æˆ‘ä»¬æ— æ³•ç»†ç²’åº¦æŽ§åˆ¶å‘å¸ƒçš„è¿‡ç¨‹ï¼Œæ¯”å¦‚ä¸æ”¯æŒå‘å¸ƒè¿‡ç¨‹ä¸­æš‚åœã€ç»§ç»­ï¼Œä»¥åŠæµé‡çš„ä¼˜é›…æ‹‰å…¥æ‹‰å‡ºç­‰èƒ½åŠ›ã€‚ ä¸ºäº†å®žçŽ°æ›´ä¸°å¯Œçš„å‘å¸ƒç­–ç•¥ä»¥åŠæ›´åŠ ç»†ç²’åº¦çš„å‘å¸ƒæŽ§åˆ¶ï¼Œä»¥ä¿éšœå®¹å™¨å‘å¸ƒè¿‡ç¨‹çš„å®‰å…¨ã€ç¨³å®šï¼ŒTriton é€‰æ‹© OpenKruise ä½œä¸ºåº”ç”¨çš„ workloadã€‚OpenKruise æ˜¯ Kubernetes çš„ä¸€ä¸ªæ ‡å‡†æ‰©å±•ï¼Œå®ƒå¯ä»¥é…åˆåŽŸç”Ÿ Kubernetes ä½¿ç”¨ï¼Œå¹¶ä¸ºç®¡ç†åº”ç”¨å®¹å™¨ã€sidecarã€é•œåƒåˆ†å‘ç­‰æ–¹é¢æä¾›æ›´åŠ å¼ºå¤§å’Œé«˜æ•ˆçš„èƒ½åŠ›ã€‚OpenKruise æä¾›äº†å¾ˆå¤šåŽŸç”Ÿ kubernetes çš„å¢žå¼ºåž‹èµ„æºï¼ŒCloneSetã€Advanced StatefulSetã€SidecarSet ç­‰ã€‚å…¶ä¸­ï¼ŒCloneSet æä¾›äº†æ›´åŠ é«˜æ•ˆã€ç¡®å®šå¯æŽ§çš„åº”ç”¨ç®¡ç†å’Œéƒ¨ç½²èƒ½åŠ›ï¼Œæ”¯æŒä¼˜é›…åŽŸåœ°å‡çº§ã€æŒ‡å®šåˆ é™¤ã€å‘å¸ƒé¡ºåºå¯é…ç½®ã€å¹¶è¡Œ / ç°åº¦å‘å¸ƒç­‰ä¸°å¯Œçš„ç­–ç•¥ï¼Œå¯ä»¥æ»¡è¶³æ›´å¤šæ ·åŒ–çš„åº”ç”¨åœºæ™¯ï¼Œæ‰€ä»¥ Triton é€‰æ‹©åŸºäºŽ CloneSet æ¥å®žçŽ°æ— çŠ¶æ€åº”ç”¨çš„å‘å¸ƒæµç¨‹ã€‚ 2.1.2 å‘å¸ƒæµç¨‹æŠ€æœ¯é€‰åž‹å¦‚ä½•å®šä¹‰ä¸€ç§å‘å¸ƒæµç¨‹ï¼Œå¹¶æŒ‰ç…§æµç¨‹çš„å®šä¹‰åŽ»å®žçŽ°æœ¬æ¬¡å‘å¸ƒï¼Ÿä¸ºäº†å¯»æ‰¾ä¸€äº›çµæ„Ÿï¼Œåœ¨è®¾è®¡ Triton ä¹‹å‰æˆ‘ä»¬è°ƒç ”äº†ç›®å‰åœ¨äº‘åŽŸç”Ÿé¢†åŸŸåšå¾—æ¯”è¾ƒå¥½çš„çš„ä¸€äº› CI/CD ç»„ä»¶ï¼Œåƒäº‘åŽŸç”Ÿ CI å·¥å…· Tektonï¼Œäº¤ä»˜å·¥å…· Argo éƒ½æ˜¯è®¾è®¡äº†ä¸€å¥— CRD ï¼ˆè‡ªå®šä¹‰èµ„æºï¼‰ï¼Œç„¶åŽåœ¨ Operator ä¸­å®žçŽ°ç›¸åº”çš„é€»è¾‘ä»¥è¾¾åˆ°æœ€ç»ˆçš„ç›®æ ‡çŠ¶æ€ï¼ˆOperator æ˜¯ç”± CoreOS å¼€å‘çš„ï¼Œç”¨æ¥æ‰©å±• Kubernetes APIï¼Œç‰¹å®šçš„åº”ç”¨ç¨‹åºæŽ§åˆ¶å™¨ï¼Œå…¶åŸºäºŽ Kubernetes çš„èµ„æºå’ŒæŽ§åˆ¶å™¨æ¦‚å¿µä¹‹ä¸Šæž„å»ºï¼Œä½†åŒæ—¶åˆåŒ…å«äº†åº”ç”¨ç¨‹åºç‰¹å®šçš„é¢†åŸŸçŸ¥è¯†ã€‚åˆ›å»º Operator çš„å…³é”®æ˜¯ CRD çš„è®¾è®¡ï¼‰ã€‚ äºŽæ˜¯æˆ‘ä»¬é‡‡ç”¨äº‘åŽŸç”Ÿçš„æ–¹å¼è®¾è®¡å®¹å™¨å‘å¸ƒï¼ŒåŽŸç”Ÿä¸ºäº‘è€Œè®¾è®¡ï¼Œåœ¨äº‘ä¸Šè¿è¡Œï¼Œå……åˆ†åˆ©ç”¨å’Œå‘æŒ¥äº‘å¹³å°çš„å¼¹æ€§ + åˆ†å¸ƒå¼ä¼˜åŠ¿ã€‚æˆ‘ä»¬è®¾è®¡äº†ä¸€ç§ CRD æ¥æè¿°ä¸€æ¬¡å®¹å™¨å‘å¸ƒçš„å®Œæ•´æµç¨‹ï¼Œè¿™æ ·æ¯æ¬¡å‘å¸ƒåªéœ€è¦åˆ›å»º CRD èµ„æºï¼Œå°±èƒ½å®šä¹‰å¥½æœ¬æ¬¡çš„å‘å¸ƒæµç¨‹ï¼ŒåŽç»­åªéœ€è¦åœ¨æ­¤èµ„æºåŸºç¡€ä¸Šä¿®æ”¹å³å¯ã€‚ç»è¿‡å†…éƒ¨è®¨è®ºï¼Œæœ€ç»ˆè¯¥ CRD è¢«å‘½åä¸º DeployFlowï¼Œå³å‘å¸ƒæµçš„æ„æ€ï¼Œå…³äºŽ DeployFlow çš„è¯¦ç»†ä»‹ç»è¯·ç»§ç»­é˜…è¯»ä¸‹é¢çš„æž¶æž„è®¾è®¡ã€‚ 2.2 æž¶æž„è®¾è®¡åœ¨è§£å†³äº† workload å’Œå‘å¸ƒæµç¨‹çš„æŠ€æœ¯é€‰åž‹åŽï¼ŒDeployFlow è¿™ä¸ª CRD çš„è®¾è®¡å°±æˆä¸ºäº†æˆ‘ä»¬è¦åŽ»èšç„¦çš„æ ¸å¿ƒå·¥ä½œã€‚ä¸‹å›¾å±•ç¤ºäº† Triton çš„ä¸»è¦è®¾è®¡æž¶æž„ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ Kubernetes å’Œ OpenKruise çš„åŸºç¡€ä¹‹ä¸Šï¼Œå®Œæˆä¸€æ¬¡å‘å¸ƒéœ€è¦çš„é…ç½®ç”± CRD å®šä¹‰ï¼Œå‘å¸ƒæµç¨‹ç›¸å…³çš„é€»è¾‘æŽ§åˆ¶é€šè¿‡ Operator å®žçŽ°ï¼ŒåŒæ—¶ Triton æä¾› RESTã€GRPC API å’Œå‰ç«¯ UI å®žçŽ°äº¤äº’ã€‚ 2.2.1 DeployFlow å’Œ Operator å®žçŽ°é¦–å…ˆä»‹ç»ä¸‹ DeployFlow è¿™ä¸ª CRDï¼Œé€šè¿‡ DeployFlow æˆ‘ä»¬å®šä¹‰äº†ä¸€æ¬¡å‘å¸ƒä¸­éœ€è¦çš„é…ç½®ä»¥åŠå‘å¸ƒè¿‡ç¨‹ä¸­éœ€è¦çš„çŠ¶æ€å±•ç¤ºã€‚ 12345678// DeployFlow is the Schema for the deploys APItype DeployFlow struct &#123; metav1.TypeMeta `json:",inline"` metav1.ObjectMeta `json:"metadata,omitempty"` Spec DeployFlowSpec `json:"spec,omitempty"` Status DeployFlowStatus `json:"status,omitempty"`&#125; Spec å­—æ®µçš„å†…å®¹åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ä¸Žåº”ç”¨ç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚ AppIDã€GroupIdã€å‰¯æœ¬æ•°é‡ã€AppNameç­‰ï¼Œå¦ä¸€éƒ¨åˆ†æ˜¯æŒ‡å®šå‘å¸ƒç­–ç•¥ï¼Œæ¯”å¦‚æ˜¯ createè¿˜æ˜¯ update æ“ä½œï¼Œæ˜¯ scale in è¿˜æ˜¯ scale outï¼Œä¸åŒçš„æ“ä½œå¯¹åº”ä¸åŒçš„å‘å¸ƒç­–ç•¥ï¼Œè¯¦ç»†çš„å­—æ®µè§£é‡Šå¯ä»¥é€šè¿‡ä¸‹é¢ä»£ç æ¥ç†è§£ã€‚ 123456789101112131415type DeployFlowSpec struct &#123; // Important: Run "make" to regenerate code after modifying this file AppID int `json:"appID"` GroupID int `json:"groupID"` AppName string `json:"appName"` ...... Action string `json:"action"` // +nullable UpdateStrategy *DeployUpdateStrategy `json:"updateStrategy,omitempty"` // +nullable NonUpdateStrategy *DeployNonUpdateStrategy `json:"nonUpdateStrategy,omitempty"`&#125; DeployUpdateStrategy ä»£è¡¨äº†æœ¬æ¬¡å‘å¸ƒæ˜¯ä¸€æ¬¡æ›´æ–°æ“ä½œï¼Œä¹Ÿå°±æ˜¯ä¼šä½¿ CloneSet ä¸­çš„ UpdateRevision å­—æ®µå‘ç”Ÿå˜åŒ–ï¼Œä¸€èˆ¬ createã€update rollback å°±æ˜¯é‡‡ç”¨ DeployUpdateStrategy çš„å­—æ®µå®šä¹‰ã€‚ DeployNonUpdateStrategy ä»£è¡¨æœ¬æ¬¡å‘å¸ƒä¸ä¼šè§¦å‘èµ„æºæ›´æ–°ï¼Œä¹Ÿå°±æ˜¯ UpdateRevision ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¸€èˆ¬ scale inã€scale outã€restart ç­‰æ“ä½œè¦é‡‡ç”¨ DeployNonUpdateStrategyã€‚ ä¸åŒçš„å‘å¸ƒç­–ç•¥è‚¯å®šæœ‰ä¸åŒçš„å­—æ®µï¼Œä½†å¤§éƒ¨åˆ†çš„ç­–ç•¥éƒ½æ˜¯å¯ä»¥å…±ç”¨çš„ï¼Œæ‰€ä»¥åœ¨æ­¤ä¹‹ä¸Šæˆ‘ä»¬æŠ½è±¡å‡ºä¸€ä¸ªåŸºç¡€å‘å¸ƒç­–ç•¥ BaseStrategyï¼Œç”±äºŽ BaseStrategy ä¸­çš„å­—æ®µå¤ªå¤šï¼Œæˆ‘ä»¬è¿™é‡Œæ”¾ä¸€å¼  CRD çš„ schema èµ„æºè§†å›¾ï¼Œç„¶åŽå†é€‰æ‹©å…¶ä¸­é‡è¦çš„å­—æ®µè¿›è¡Œè§£é‡Šã€‚ å…ˆä»‹ç» DeployPhase å­—æ®µï¼ŒDeployPhase è¡¨ç¤ºä¸€æ¬¡å‘å¸ƒè¿‡ç¨‹ä¸­ï¼ŒDeployFlow æ‰€ç»åŽ†çš„é˜¶æ®µã€‚ å­—æ®µçš„æ„æ€éƒ½æ¯”è¾ƒå¥½ç†è§£ï¼Œè¿™é‡Œå°±ä¸å±•å¼€è®² äº†ã€‚ åœ¨ BaseStrategy ä¸­æœ‰ä¸ªæ¯”è¾ƒé‡è¦çš„å­—æ®µ - BatchSize ï¼Œè¡¨ç¤ºæ‰¹æ¬¡å¤§å°ã€‚è¿™æ„å‘³ç€ DeployFlow æ”¯æŒåˆ†æ‰¹æ¬¡å‘å¸ƒï¼Œç”¨æˆ·å¯ä»¥è‡ªå®šä¹‰æ¯ä¸ªæ‰¹æ¬¡æœ€å¤§å‘å¸ƒçš„å‰¯æœ¬æ•°é‡ï¼ŒDeployFlow ä¼šè®¡ç®—å‡ºæœ¬æ¬¡å‘å¸ƒçš„æ€»æ‰¹æ¬¡æ˜¯å¤šå°‘ä»Žè€Œæå‰ç»™å‡ºå‘å¸ƒæ¦‚è§ˆã€‚ ä»Ž BaseStrategy çš„ pausedã€canceled å­—æ®µå°±å¯ä»¥çŸ¥é“ï¼Œåœ¨å‘å¸ƒè¿‡ç¨‹ä¸­å¯ä»¥éšæ—¶æš‚åœã€ç»§ç»­æˆ–è€…å–æ¶ˆæœ¬æ¬¡å‘å¸ƒã€‚Mode è¡¨ç¤º DeployFlow ä¸åŒæ‰¹æ¬¡ä¹‹é—´çš„è§¦å‘æ–¹å¼ï¼Œåˆ†ä¸º auto å’Œ manual ä¸¤ç§ï¼Œå½“é€‰æ‹© auto æ¨¡å¼çš„æ—¶å€™ï¼Œé€šè¿‡å­—æ®µ BatchIntervalSeconds å¯ä»¥è®¾ç½®ä¸åŒæ‰¹æ¬¡ä¹‹é—´çš„æ—¶é—´é—´éš”ï¼Œå¦‚æžœé€‰æ‹©æ‰‹åŠ¨æ¨¡å¼åˆ™æ¯ä¸ªæ‰¹æ¬¡ä¹‹é—´éœ€è¦æ‰‹å·¥è§¦å‘ã€‚ ç”±äºŽ DeployFlow æ˜¯åˆ†æ‰¹æ¬¡å‘å¸ƒï¼Œæ‰€ä»¥æ¯ä¸ªæ‰¹æ¬¡éœ€è¦æœ‰é˜¶æ®µæ˜¾ç¤º - BatchPhase ï¼Œä»¥è¡¨ç¤ºå½“å‰çš„æ‰¹æ¬¡æ‰€å¤„çš„é˜¶æ®µï¼Œæˆ‘ä»¬æ¥è¯¦ç»†è§£é‡Šæ¯ç§é˜¶æ®µçš„å«ä¹‰ã€‚ BatchPending: è¡¨ç¤ºå½“å‰æ‰¹æ¬¡çš„ pod æ­£åœ¨å‡†å¤‡èµ„æºï¼Œæ¯”å¦‚æ­¤æ—¶ pod æ­£åœ¨è¢«è°ƒåº¦ä¸­ï¼Œimage åœ¨ä¸‹è½½ä¸­ï¼Œå¯¹åº” Kubernetes ä¸­çš„ pod å¤„äºŽ Pendingï¼ŒContainerCreating çŠ¶æ€ã€‚ BatchSmoking: è¡¨ç¤ºå½“å‰æ‰¹æ¬¡çš„ pod æ­£åœ¨å¯åŠ¨è¿‡ç¨‹ä¸­ï¼Œpod å¤„äºŽ Running çŠ¶æ€ï¼Œä½†æ˜¯ ContainerReady å­—æ®µè¿˜æ²¡æœ‰ç½®ä¸º trueã€‚ BatchSmoked: è¡¨ç¤ºå½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰ pod éƒ½å·²ç»å¯åŠ¨æˆåŠŸï¼Œä¹Ÿå°±æ˜¯ pod ä¸­çš„ ContainerReady å­—æ®µå·²ç»è¢«ç½®ä¸º trueï¼Œä½†æ˜¯ Ready å­—æ®µè¿˜å¤„äºŽ falseã€‚æ­¤æ—¶å¦‚æžœé€šè¿‡ service æ¥å¤„ç†æœåŠ¡æµé‡çš„è¯ï¼Œå¯åŠ¨çš„ pod å¹¶ä¸ä¼šè¢«åŠ å…¥åˆ°å¯¹åº” service çš„ endpointï¼Œå¦‚æžœæ˜¯å¾®æœåŠ¡æž¶æž„ï¼Œåˆ™è¯¥ pod å¹¶ä¸ä¼šè¢«æ‹‰å…¥åˆ°å¾®æœåŠ¡çš„æ³¨å†Œä¸­å¿ƒï¼Œä»Žè€Œä¿è¯äº†ä¸šåŠ¡æµé‡çš„å®‰å…¨ã€‚æ­£æ˜¯æ‹¥æœ‰äº†è¿™ç§æœºåˆ¶ä»¥åŠæ‰¹æ¬¡é—´å¯æš‚åœçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾å®žçŽ°åº”ç”¨çš„é‡‘ä¸é›€å‘å¸ƒï¼Œè¿™ä¸ªåœ¨åŽé¢è¿˜ä¼šè¯¦ç»†è®²åˆ°ã€‚ BatchBaking: è¡¨ç¤ºå½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰ pod éƒ½å·²ç»å¯åŠ¨æˆåŠŸï¼Œæ­£åœ¨æ‰§è¡Œæµé‡æ‹‰å…¥æ“ä½œï¼Œä¹Ÿå°±æ˜¯å°† pod çš„ Ready å­—æ®µç½®ä¸º trueã€‚ BatchBaked: è¡¨ç¤ºå½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰ pod çš„ Ready å­—æ®µéƒ½å·²è¢«ç½®ä¸º trueï¼Œpod å¼€å§‹æŽ¥æ”¶ç”Ÿäº§æµé‡ï¼Œè‡³æ­¤ä¹Ÿæ„å‘³ç€æœ¬æ‰¹æ¬¡çš„ç»“æŸï¼Œå¯ä»¥å¼€å§‹ä¸‹ä¸€æ‰¹æ¬¡çš„æ“ä½œã€‚ åœ¨æ‰¹æ¬¡è¿›è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šæœ‰ smoke å¤±è´¥æˆ–è€… bake å¤±è´¥çš„æƒ…å†µï¼Œå¯¹åº”çš„çŠ¶æ€å°±æ˜¯ SmokeFailedå’Œ BakeFailedã€‚ åœ¨ UpdateStrategy ä¸­æœ‰ä¸€ä¸ª canary å­—æ®µï¼Œæ„å‘³ç€ DeployFlow æ”¯æŒé‡‘ä¸é›€å‘å¸ƒã€‚å…¶å®žåœ¨è®²è§£äº†ä¸Šè¿° DeployFlow åˆ†æ‰¹æ¬¡å¤„ç†çš„èƒ½åŠ›åŽï¼Œåœ¨æ­¤åŸºç¡€ä¹‹ä¸Šå®žçŽ°é‡‘ä¸é›€å‘å¸ƒæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚ä¹Ÿå°±æ˜¯åœ¨é‡‘ä¸é›€æ‰¹æ¬¡å¤„äºŽ BatchSmoked çŠ¶æ€çš„æ—¶å€™ï¼Œè®©å‘å¸ƒæš‚åœï¼Œåœ¨æµé‡æ‹‰å…¥ä¹‹å‰ä¹Ÿå¯ä»¥è¿›è¡Œä¸€äº› API éªŒè¯çš„æ“ä½œï¼Œå¼€å‘è€…åœ¨éªŒè¯æ²¡é—®é¢˜ä¹‹åŽæ‰‹å·¥å°†è¯¥æ‰¹æ¬¡æ‹‰å…¥ï¼Œæ‹‰å…¥é‡‘ä¸é›€æ‰¹æ¬¡åŽï¼Œ DeployFlow ä¹Ÿå¤„äºŽæš‚åœçš„çŠ¶æ€ï¼Œæ­¤æ—¶å¼€å‘è€…å¯ä»¥è§‚å¯Ÿçº¿ä¸Šæµé‡çš„ç›‘æŽ§ï¼Œç¡®è®¤æ²¡æœ‰é—®é¢˜åŽå†æ‰§è¡ŒåŽé¢æ‰¹æ¬¡çš„å‘å¸ƒã€‚åŽé¢çš„ UI äº¤äº’ä¼šæ›´åŠ ç›´è§‚åœ°å±•ç¤ºè¯¥åŠŸèƒ½ï¼Œè¿™é‡Œæˆ‘ä»¬å…ˆé€šè¿‡ä¸€å¼  DeployFlow çš„çŠ¶æ€æµè½¬ç¤ºæ„å›¾å®Œæ•´åœ°å±•ç¤ºä¸€æ¬¡å‘å¸ƒçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬ä»¥æœ¬æ¬¡å‘å¸ƒåˆ†ä¸ºä¸¤ä¸ªæ‰¹æ¬¡ä¸ºä¾‹ï¼Œé‡‘ä¸é›€æ‰¹æ¬¡å’Œæ™®é€šæ‰¹æ¬¡ã€‚ç»“åˆæœ¬å›¾ä¸Žä¸Šæ–‡çš„ CRD è§£é‡Šï¼Œç›¸ä¿¡è¯»è€…ä¼šå¯¹ DeployFlow æœ‰ä¸€ä¸ªæ›´åŠ æ¸…æ™°çš„è®¤çŸ¥ã€‚ è‡³æ­¤ï¼Œåœ¨ DeployUpdateStrategy ã€BaseStrategy ä¸­çš„æ ¸å¿ƒå­—æ®µéƒ½å·²ç»ä»‹ç»å®Œäº†ï¼Œåœ¨ DeployNonUpdateStrategy ä¸­è¿˜æœ‰ä¸€ä¸ª PodsToDelete å­—æ®µï¼Œè¿™ä¸ªå­—æ®µæ˜¯åœ¨åº”ç”¨ç¼©å®¹ã€é‡å¯æ“ä½œæ—¶èµ·ä½œç”¨çš„ï¼ŒåŽŸç”Ÿ Kubernetes å¯¹äºŽèµ„æºçš„ç¼©å®¹æ“ä½œæœ‰è‡ªå·±çš„è§„åˆ™ï¼Œä¸èƒ½éšæ„é€‰æ‹©æƒ³è¦ç¼©å®¹çš„ podã€‚ä½†æ˜¯åœ¨ DeployFlow ä¸­ï¼Œä½ å¯ä»¥æŒ‡å®š pod ç¼©å®¹ï¼ŒæŒ‡å®š pod é‡å¯ã€‚ é€šè¿‡ä¸Šé¢çš„ä»‹ç»ï¼Œè¯»è€…å¯¹ DeployFlow è¿™ä¸ª CRD çš„ spec å­—æ®µæœ‰äº†ä¸€å®šäº†è§£ï¼Œä¸‹é¢æ¥çœ‹ä¸‹å‘å¸ƒè¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦å±•ç¤ºçš„ status å­—æ®µã€‚ ç†Ÿæ‚‰ Kubernetes çš„åŒå­¦åº”è¯¥èƒ½å¤Ÿä»Žå­—æ®µçš„å­—é¢æ„æ€äº†è§£è¿™äº›å­—æ®µçš„å«ä¹‰ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†å±•å¼€äº†ã€‚ CRD è®¾è®¡å®ŒæˆåŽï¼ŒOperator çš„å®žçŽ°ä¹Ÿå°±æ˜¯æ°´åˆ°æ¸ æˆçš„äº‹æƒ…äº†ï¼Œé™¤äº† DeployFlow çš„ Operatorï¼ŒTriton ä¸­è¿˜é‡æ–°å®žçŽ°äº†ä¸€äº› controller æ¥æ»¡è¶³ä¸ªæ€§åŒ–çš„éœ€æ±‚ï¼Œæ¯”å¦‚ Event controller ç”¨æ¥å°†å‘å¸ƒè¿‡ç¨‹ä¸­ podã€Clonesetã€DeployFlow ç­‰ç»„ä»¶çš„æ—¥å¿—å‘é€åˆ° ES ä»¥æ–¹ä¾¿å¼€å‘è€…æŸ¥çœ‹å‘å¸ƒçš„æƒ…å†µï¼ŒReadinessGates controller ç”¨æ¥æŽ§åˆ¶è‡ªå®šä¹‰ ReadinessGate çš„æ‹‰å…¥æ‹‰å‡ºæ“ä½œç­‰ã€‚ åŒæ—¶ Triton æä¾› REST &amp; GRPC API æ¥æ“ä½œ DeployFlowï¼Œè°ƒç”¨æ–¹å³ä½¿ä¸äº†è§£å®¹å™¨å’Œ Kubernetes çš„çŸ¥è¯†ï¼Œä¹Ÿå¯ä»¥å¾ˆå®¹æ˜“å¯¹æŽ¥åˆ° Triton ä¸Šå®žçŽ°å‘å¸ƒçš„åŠŸèƒ½ã€‚ 2.3 UI äº¤äº’åº•å±‚æž¶æž„ä»¥åŠæ ¸å¿ƒç»„ä»¶ DeployFlow çš„è®¾è®¡é€»è¾‘è™½ç„¶ç¨æ˜¾å¤æ‚ï¼Œä½†å¾—ç›ŠäºŽ Triton æš´éœ²çš„ REST &amp; GRPC API ä»¥åŠä¸°å¯Œçš„ status å­—æ®µï¼Œä½¿å¾—å‰ç«¯åœ¨å‘å¸ƒçš„ UI äº¤äº’é€»è¾‘ä¸Šèƒ½å¤Ÿåšåˆ°ç®€æ´ç›´è§‚ã€‚ä¸‹é¢è®©æˆ‘ä»¬ä»Ž UI å…¥æ‰‹ï¼Œçœ‹ä¸‹ Triton å¦‚ä½•è¿›è¡Œåº”ç”¨çš„äº¤ä»˜ä»¥åŠå¯¹åº”ç”¨çš„å‰¯æœ¬å®žä¾‹çš„è§„åˆ’ã€‚ 2.3.1 å‘å¸ƒå…¥å£åŠå‘å¸ƒæ¸…å•è¿›å…¥ç”Ÿäº§å‘å¸ƒé¡µé¢ï¼Œåœ¨å®¹å™¨å‘å¸ƒé¡µç­¾ï¼Œé€‰æ‹©éœ€è¦å‘å¸ƒçš„ groupï¼Œç‚¹å‡»â€œå‘å¸ƒâ€ã€‚ ç‚¹å‡»åŽå¼¹å‡ºä¸€ä¸ªå‘å¸ƒæ¸…å•çš„é¡µé¢ï¼Œåœ¨è¿™é‡Œéœ€è¦é…ç½®æœ¬æ¬¡å‘å¸ƒéœ€è¦çš„ç­–ç•¥ä»¥åŠç›¸å…³å‚æ•°ã€‚ å…¶ä¸­æœ‰äº›å‚æ•°åœ¨ä¸Šé¢çš„ CRD è®¾è®¡ç¯‡ç« ä¸­å·²ç»æœ‰æ‰€æè¿°ï¼Œæ¯”å¦‚åº”ç”¨æè¿°ï¼Œæ‰¹æ¬¡å¤§å°ï¼Œæ‰¹æ¬¡é—´å¤„ç†æ–¹å¼ï¼Œæ‰¹æ¬¡é—´éš”ç­‰ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚å¯åŠ¨è¶…æ—¶æ—¶é—´ æ˜¯å¼€æ”¾ç»™å¼€å‘è€…è‡ªå®šä¹‰åº”ç”¨éœ€è¦ç”¨æ¥å¯åŠ¨çš„æ—¶é—´ï¼Œæ¯”å¦‚æœ‰äº›åº”ç”¨å°¤å…¶æ˜¯ java åº”ç”¨ï¼Œåœ¨çœŸæ­£å¯åŠ¨ä¹‹å‰éœ€è¦æ‰§è¡Œä¸€äº› warm up çš„æ“ä½œï¼Œå¼€å‘è€…å°±å¯ä»¥æ ¹æ®è‡ªå·±åº”ç”¨çš„å®žé™…æƒ…å†µå¡«å†™è¯¥å€¼ï¼Œé¿å…è¿™ç±»åº”ç”¨å¯åŠ¨å¤±è´¥ã€‚å¾®æœåŠ¡æ‹‰å‡ºç­‰å¾…æ—¶é—´ æ˜¯ç”¨æ¥æ”¯æŒå¾®æœåŠ¡ pod ä¼˜é›…é€€å‡ºçš„ã€‚ é‚£ä½•è°“ä¼˜é›…é€€å‡ºï¼Œä¸ºä»€ä¹ˆè¦ä¼˜é›…é€€å‡ºå‘¢ï¼Ÿåœ¨ Kubernetes ä¸­å½“åˆ æŽ‰ä¸€ä¸ª pod çš„æ—¶å€™ï¼Œç†æƒ³çŠ¶å†µå½“ç„¶æ˜¯ Kubernetes ä»Žå¯¹åº”çš„ Serviceï¼ˆå‡å¦‚æœ‰çš„è¯ï¼‰æŠŠè¿™ä¸ª pod æ‘˜æŽ‰ï¼ŒåŒæ—¶ç»™ pod å‘ SIGTERM ä¿¡å·è®© pod ä¸­çš„å„ä¸ªå®¹å™¨ä¼˜é›…é€€å‡ºå°±è¡Œäº†ã€‚ä½†å®žé™…ä¸Š pod æœ‰å¯èƒ½çŠ¯å„ç§å¹ºè›¾å­ï¼š å·²ç»å¡æ­»äº†ï¼Œå¤„ç†ä¸äº†ä¼˜é›…é€€å‡ºçš„ä»£ç é€»è¾‘æˆ–éœ€è¦å¾ˆä¹…æ‰èƒ½å¤„ç†å®Œæˆï¼› ä¼˜é›…é€€å‡ºçš„é€»è¾‘æœ‰ BUGï¼Œè‡ªå·±æ­»å¾ªçŽ¯äº†ï¼› ä»£ç å†™å¾—é‡Žï¼Œæ ¹æœ¬ä¸ç†ä¼š SIGTERM; å› æ­¤ï¼ŒKubernetes çš„ pod ç»ˆæ­¢æµç¨‹ä¸­è¿˜æœ‰ä¸€ä¸ªâ€æœ€å¤šå¯ä»¥å®¹å¿çš„æ—¶é—´â€ï¼Œå³ grace period ï¼ˆåœ¨ pod çš„ .spec.terminationGracePeriodSeconds å­—æ®µä¸­å®šä¹‰ï¼‰ï¼Œè¿™ä¸ªå€¼é»˜è®¤æ˜¯ 30 ç§’ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œ kubectl delete çš„æ—¶å€™ä¹Ÿå¯é€šè¿‡ --grace-period å‚æ•°æ˜¾å¼æŒ‡å®šä¸€ä¸ªä¼˜é›…é€€å‡ºæ—¶é—´æ¥è¦†ç›– pod ä¸­çš„é…ç½®ã€‚è€Œå½“ grace period è¶…å‡ºä¹‹åŽï¼ŒKubernetes å°±åªèƒ½é€‰æ‹© SIGKILL å¼ºåˆ¶å¹²æŽ‰ pod äº†ã€‚ ä½†æ˜¯åœ¨å¾®æœåŠ¡çš„åœºæ™¯ä¸‹ï¼Œé™¤äº†æŠŠ pod ä»Ž Kubernetes çš„ Service ä¸Šæ‘˜ä¸‹æ¥ä»¥åŠè¿›ç¨‹å†…éƒ¨çš„ä¼˜é›…é€€å‡ºä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»åšä¸€äº›é¢å¤–çš„äº‹æƒ…ï¼Œæ¯”å¦‚è¯´ä»Ž Kubernetes å¤–éƒ¨çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒä¸Šåæ³¨å†Œï¼Œä¸ç„¶å¯èƒ½ä¼šå‡ºçŽ° pod å·²ç»è¢«åˆ æŽ‰ï¼Œä½†æ˜¯æ³¨å†Œä¸­å¿ƒä¸Šè¿˜ç•™ç€å·²åˆ æŽ‰ pod çš„æœåŠ¡ä¿¡æ¯ï¼Œæ­¤æ—¶æœ‰æµé‡è¿›å…¥çš„è¯å°±ä¼šå‡ºçŽ°æœåŠ¡ä¸å¯ç”¨çš„æƒ…å†µã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨ prestop hook ä¸­å®šä¹‰äº†ä¸€ä¸ªåä¸º gracefully_shutdown çš„æ–‡ä»¶æ¥å¤„ç† pod åˆ é™¤åŽçš„å¾®æœåŠ¡ä¼˜é›…é€€å‡ºã€‚ 1234567spec: contaienrs: - name: demo-container lifecycle: preStop: exec: command: ["/bin/sh"ï¼Œ"-c"ï¼Œ"/gracefully_shutdown"] å³ä¾§çš„å‘å¸ƒç­–ç•¥ä»¥åŠæœ¬æ¬¡å‘å¸ƒæ¦‚è§ˆåœ¨ä¹‹å‰çš„æž¶æž„è®¾è®¡ä¸­å·²ç»è®²è¿‡ï¼Œè¿™é‡Œä¸åœ¨èµ˜è¿°ã€‚ 2.3.2 å¼€å§‹å‘å¸ƒå®Œæˆå‘å¸ƒé…ç½®åŽï¼Œå³å¯å¼€å§‹å‘å¸ƒã€‚ å‘å¸ƒè¿›åº¦ï¼šå±•ç¤ºå‘å¸ƒçš„æ‰¹æ¬¡ï¼ŒåŠå„ä¸ªæ‰¹æ¬¡æ‰€å¯åŠ¨çš„å®žä¾‹æ•°é‡å’ŒçŠ¶æ€ã€‚åœ¨å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œäººå·¥æ“ä½œçš„å…¥å£ä¹Ÿåœ¨æ­¤åŒºåŸŸï¼› å®žä¾‹åˆ—è¡¨ï¼šå±•ç¤ºå‘å¸ƒçš„å®žä¾‹ï¼Œå¯ä»¥åˆ‡æ¢å®žä¾‹ç‰ˆæœ¬æŸ¥çœ‹å„ç‰ˆæœ¬çš„å®žä¾‹ï¼› å‰¯æœ¬çŠ¶æ€ï¼šå½¢å¦‚ 0/1/0/0 å¯¹åº” Pending/Running/Ready/Failed å››ä¸ªçŠ¶æ€çš„æ•°é‡ (1 ä¸ª pod åœ¨å‘å¸ƒä¸­ï¼‰ï¼Œå…¶ä¸­ Running å¯¹åº”å‘å¸ƒä¸­å®žä¾‹æ•°ï¼ŒReady å‘å¸ƒæˆåŠŸå®žä¾‹æ•°ï¼ŒFailed å‘å¸ƒå¤±è´¥å®žä¾‹æ•°ã€‚ 2.3.3 å‘å¸ƒè¿‡ç¨‹ä¸€ä¸ªå…¸åž‹çš„å‘å¸ƒåŒ…æ‹¬â€œé‡‘ä¸é›€æ‰¹æ¬¡å¯åŠ¨ï¼ˆSmokingï¼‰â€-â€œé‡‘ä¸é›€æ‰¹æ¬¡ç‚¹ç«ï¼ˆBakingï¼‰â€-â€œæ»šåŠ¨å‘å¸ƒï¼ˆRolloutï¼‰â€ ä¸‰ä¸ªé˜¶æ®µã€‚ é‡‘ä¸é›€æ‰¹æ¬¡å¯åŠ¨ä¸­ï¼ˆSmokingï¼‰ é‡‘ä¸é›€æ‰¹æ¬¡å¯åŠ¨æˆåŠŸï¼Œå¯ä»¥éªŒè¯æŽ¥å£ï¼Œç¡®è®¤æ²¡é—®é¢˜ï¼Œå¯å°†å…¶æ‹‰å…¥ç‚¹ç«ï¼ˆBakingï¼‰ é‡‘ä¸é›€æ‰¹æ¬¡ç‚¹ç«ä¸­ï¼Œå®žä¾‹å·²æŽ¥æµé‡ï¼Œç”±äºŽæ­¤æ—¶ DeployFlow å¤„äºŽæš‚åœçŠ¶æ€ï¼Œå¼€å‘è€…å¯ä»¥æœ‰å……è¶³çš„æ—¶é—´å¯è§‚å¯Ÿæ—¥å¿—ã€ç›‘æŽ§ç­‰æ˜¯å¦æœ‰å¼‚å¸¸ï¼Œç¡®è®¤æ²¡é—®é¢˜åŽå†è§¦å‘æ»šåŠ¨å‘å¸ƒï¼ˆRolloutï¼‰ æ»šåŠ¨å‘å¸ƒä¸­ï¼Œå¦‚é€‰æ‹©â€œæ‰‹åŠ¨â€ æ¨¡å¼ï¼Œæ¯ä¸ªæ»šåŠ¨æ‰¹æ¬¡éƒ½éœ€è¦äººä¸ºè§¦å‘ æ»šåŠ¨å‘å¸ƒè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ–°æ—§å®žä¾‹çš„ç‰ˆæœ¬æ•°é‡åœ¨äº¤æ›¿å˜åŒ–ã€‚ å‘å¸ƒæˆåŠŸ è‡³æ­¤ï¼Œä¸€æ¬¡å®Œæ•´çš„ DeployFlow æµç¨‹å°±èµ°å®Œäº†ï¼Œå‘å¸ƒåˆ°è¾¾æˆåŠŸçš„çŠ¶æ€ã€‚å¯ä»¥çœ‹åˆ°æ¯ä¸ªæ‰¹æ¬¡æ‰€è´Ÿè´£çš„ pod æ•°é‡ä»¥åŠ pod çŠ¶æ€ã€æ—¥å¿—ç­‰ä¿¡æ¯ã€‚ 2.3.4 æŒ‡å®šå®žä¾‹çš„æ“ä½œåœ¨å®žä¾‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¦‚æžœå‘çŽ°å®žä¾‹è´Ÿè½½å¼‚å¸¸æˆ–éœ€è¦é‡æ–°åŠ è½½ apollo é…ç½®ï¼Œå°±ä¼šæœ‰é‡å¯å®žä¾‹çš„éœ€æ±‚ã€‚Kubernetes æœ¬èº«æ²¡æœ‰æä¾›é‡å¯çš„æ“ä½œé€»è¾‘ï¼Œä¸€èˆ¬é€šè¿‡æ€æŽ‰ä¸€ä¸ª pod æ¥è¾¾åˆ°é‡å¯çš„æ•ˆæžœï¼Œä½†è¿™ç§æ–¹å¼æ¯”è¾ƒç²—æš´è€Œä¸”å­˜åœ¨å®‰å…¨éšæ‚£ã€‚Triton æä¾›äº†å®‰å…¨çš„é‡å¯ç­–ç•¥ï¼Œä¼šå…ˆæ–°å¢žä¸€ä¸ª pod å¦‚æžœè¯¥ pod å¯åŠ¨æˆåŠŸæˆåŠŸï¼Œå†åˆ æŽ‰ä½ æ‰€æŒ‡å®šè¦é‡å¯çš„ podï¼Œä»¥æ­¤æ¥è¾¾åˆ°å®‰å…¨é‡å¯çš„æ•ˆæžœï¼Œè¿™å°±æ˜¯ Triton çš„æŒ‡å®šå®žä¾‹é‡å¯çš„åŠŸèƒ½ã€‚ åŒæ ·çš„åŽŸç†ï¼Œç¼©å®¹çš„æ“ä½œä¹Ÿå¯ä»¥æŒ‡å®šæƒ³è¦ç¼©æŽ‰çš„ pod ã€‚ è¯¥åŠŸèƒ½çš„å®žçŽ°å¾—ç›ŠäºŽ OpenKruise ä¸­å¢žå¼ºåž‹æ— çŠ¶æ€ workload CloneSet æä¾›çš„èƒ½åŠ›ï¼Œå…·ä½“çš„åŠŸèƒ½æè¿°å¯ä»¥å‚è€ƒ OpenKruise æ–‡æ¡£ã€‚ ä¸Šé¢çš„å†…å®¹å°±æ˜¯æœ‰å…³ Triton æ ¸å¿ƒèƒ½åŠ›çš„ UI äº¤äº’ï¼Œæ•´ä¸ªè¿‡ç¨‹åŠ›æ±‚ç®€æ´ã€æ¸…æ™°ï¼Œé¿å…ç»™å¼€å‘è€…é€ æˆé¢å¤–çš„ç†è§£è´Ÿæ‹…ï¼Œè¿™ä¸ºæˆ‘ä»¬å®¹å™¨çš„æŽ¥å…¥ã€æŽ¨è¿›æä¾›äº†å¾ˆå¤§çš„ä¾¿æ·ã€‚ 3. æ€»ç»“ä¸Žå±•æœ›æ¯ä¸ªå…¬å¸çš„å®¹å™¨å‘å¸ƒå¹³å°éƒ½ä¸å°½ç›¸åŒï¼Œå¯èƒ½ä¼šæœ‰è¯»è€…çœ‹å®Œè¯´ Triton å°è£…äº†å¤ªå¤šçš„ Kubernetes ç»†èŠ‚ï¼Œæ²¡æœ‰å‘å¼€å‘è€…çœŸæ­£å±•ç¤ºåŽŸç”Ÿ Kubenetes çš„çŠ¶æ€ã€å«ä¹‰æˆ–è€…ç†å¿µã€‚å…¶å®žä»Žä¸€å¼€å§‹ï¼Œæˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯è®¾è®¡é€‚ç”¨äºŽæŽŒé—¨è‡ªèº«ç ”å‘ä½“ç³»çš„å®¹å™¨å‘å¸ƒç³»ç»Ÿï¼Œå‡å°‘å¼€å‘å¯¹å‘å¸ƒæ“ä½œçš„å­¦ä¹ æˆæœ¬ï¼Œä»Žè€Œå¿«é€Ÿä¸Šæ‰‹ä»¥æ›´å¿«åœ°èµ‹èƒ½ç ”å‘æµç¨‹çš„è¿­ä»£ï¼ŒåŠ é€Ÿä¸šåŠ¡åº”ç”¨çš„ä¸Šçº¿ã€‚è€Œç®€æ´æ¸…æ™°çš„ API ä¹Ÿæœ‰åˆ©äºŽæˆ‘ä»¬è®¾è®¡å‡ºæ›´åŠ ç®€å•çš„ç”¨æˆ·ç•Œé¢ï¼Œç®€å•çš„ç”¨æˆ·ç•Œé¢åˆè®©æˆ‘ä»¬åœ¨æŽ¨å¹¿æ—¶å—ç›Šã€‚ ä¸Šå›¾æ˜¯ Triton çš„ä¸€äº›å…³é”®æŒ‡æ ‡ï¼Œå¯è§ Triton å·²ç»æˆä¸º CD å¹³å°çš„æ ¸å¿ƒèƒ½åŠ›ï¼Œåœ¨ç”¨æˆ·éœ€æ±‚çš„è¿­ä»£ä¸­ä¸æ–­è¿›åŒ–ï¼Œä¸è¿‡ï¼ŒçŽ°åœ¨çš„ Triton ä¾ç„¶æœ‰å¾ˆå¤§çš„ä¼˜åŒ–ç©ºé—´ï¼Œä¸»è¦æœ‰ï¼š æŽŒé—¨æœ‰å¤§é‡çš„ socket é•¿è¿žæŽ¥åº”ç”¨ï¼Œå¯¹äºŽè¿™ç±»åº”ç”¨çš„å®¹å™¨åŒ–ï¼Œä»¥åŠå®¹å™¨åŒ–åŽå¦‚ä½•å‘å¸ƒï¼Œè¿˜æ²¡æœ‰æ¸…æ™°çš„è®¾è®¡æ–¹æ¡ˆï¼› Triton æŒ‰åº”ç”¨ç²’åº¦è¿›è¡Œå‘å¸ƒï¼Œä¸æ”¯æŒè·¨åº”ç”¨çš„å‘å¸ƒæµç¨‹ç¼–æŽ’ï¼› å¯¹å¼€å‘è€…å¿«é€Ÿæ‹‰èµ·æœ¬åœ°æµ‹è¯•çŽ¯å¢ƒçš„æ”¯æŒè¾ƒå¼±ã€‚ æˆ‘ä»¬ç›®å‰ä¹Ÿåœ¨è¿›è¡Œé’ˆå¯¹è¿™äº›ä¼˜åŒ–é¡¹çš„å·¥ä½œã€‚]]></content>
      <categories>
        <category>kubernetes</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ·±å…¥ç†è§£ Kubernetes Deletion]]></title>
    <url>%2F2021%2F07%2F21%2F%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3-Kubernetes-Deletion%2F</url>
    <content type="text"><![CDATA[kubectl delete è¿™ä¸ªå‘½ä»¤æˆ‘ä»¬å‡ ä¹Žæ¯å¤©éƒ½åœ¨ä½¿ç”¨ï¼Œçœ‹èµ·æ¥å¾ˆå®¹æ˜“ç†è§£ï¼Œä¸å°±æ˜¯åˆ é™¤ Kubernetes çš„æŸç§èµ„æºå—ï¼Ÿä½†æ˜¯è¦å®Œå…¨ç†è§£ Delete æ“ä½œè¿˜æ˜¯å¾ˆæœ‰æŒ‘æˆ˜çš„ï¼Œç†è§£åˆ é™¤æ“ä½œèƒŒåŽçœŸæ­£çš„åŽŸç†ï¼Œèƒ½å¤Ÿå¸®åŠ©ä½ ä»Žå®¹åº”å¯¹ä¸€äº›å¥‡è‘©åœºæ™¯ã€‚è¿™ç¯‡æ–‡ç« å°†ä»Žä»¥ä¸‹å‡ ä¸ªæ–¹é¢è¯¦ç»†è§£é‡Šåˆ é™¤æ“ä½œèƒŒåŽçš„æ•…äº‹ï¼š åŸºæœ¬çš„åˆ é™¤æ“ä½œ Finalizers å’Œ Owner Reference ä¼šå¯¹åˆ é™¤æ“ä½œäº§ç”Ÿä»€ä¹ˆå½±å“ å¦‚ä½•åˆ©ç”¨ propagation policy æ”¹å˜åˆ é™¤çš„é¡ºåº é€šè¿‡ examples æ¼”ç¤ºä¸Šè¿°åˆ é™¤æ“ä½œ ç®€å•èµ·è§ï¼Œæ‰€æœ‰ç¤ºä¾‹éƒ½å°†ä½¿ç”¨ ConfigMaps å’Œ Basic Shell å‘½ä»¤æ¥æ¼”ç¤ºæ“ä½œè¿‡ç¨‹ã€‚ The basic deleteKubernetes æœ‰å‡ ç§ä¸åŒçš„å‘½ä»¤ï¼Œæ‚¨å¯ä»¥ä½¿ç”¨å®ƒå…è®¸æ‚¨åˆ›å»ºï¼Œè¯»å–ï¼Œæ›´æ–°å’Œåˆ é™¤å¯¹è±¡ã€‚ å‡ºäºŽæœ¬åšå®¢æ–‡ç« çš„ç›®çš„ï¼Œæˆ‘ä»¬å°†ä¸“æ³¨äºŽå››ä¸ª kubectl å‘½ä»¤ï¼šcreate,get,patch, å’Œdeleteã€‚ ä¸‹é¢æ˜¯å‡ ä¸ªæœ€ç®€å•çš„ kubectl delete ä½¿ç”¨åœºæ™¯ï¼š 12kubectl create configmap mymapconfigmap/mymap created 123kubectl get configmap/mymapNAME DATA AGEmymap 0 12s 12kubectl delete configmap/mymapconfigmap "mymap" deleted 12kubectl get configmap/mymapError from server (NotFound): configmaps "mymap" not found æ¼”ç¤ºäº†ä¸€ä¸ª configMap ä»Žåˆ›å»ºã€æŸ¥è¯¢ã€åˆ°åˆ é™¤ã€å†æŸ¥è¯¢çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªè¿‡ç¨‹å¯ä»¥ç”¨ä¸‹é¢çš„çŠ¶æ€å›¾è¡¨ç¤ºï¼š è¿™ç§ delete æ“ä½œæ˜¯éžå¸¸ç®€å•ç›´è§‚çš„ï¼Œä½†å½“ä½ é‡åˆ° Finalizerå’Œ Owner References çš„æ—¶å€™å°±ä¼šå‡ºçŽ°å„ç§éš¾ä»¥ç†è§£çš„çŽ°è±¡ã€‚ Understanding Finalizersåœ¨ç†è§£ Kubernetes çš„èµ„æºåˆ é™¤æ—¶ï¼Œäº†è§£ Finalizers çš„å·¥ä½œåŽŸç†èƒ½å¤Ÿåœ¨ä½ æ— æ³•åˆ é™¤èµ„æºæ—¶ç»™ä½ ä¸€äº›è§£å†³é—®é¢˜çš„çµæ„Ÿã€‚ Finalizers æ˜¯è§¦å‘ pre-delete æ“ä½œçš„å…³é”®ï¼Œèƒ½å¤ŸæŽ§åˆ¶èµ„æºçš„åžƒåœ¾å›žæ”¶ã€‚Finalizers è®¾è®¡çš„åˆè¡·æ˜¯å¸®åŠ© controller åœ¨å¤„ç†èµ„æºåˆ é™¤ä¹‹å‰ï¼Œä¼˜å…ˆå¤„ç†ä¸€äº› clean up çš„é€»è¾‘ã€‚ä½†æ˜¯ Finalizers å¹¶ä¸åŒ…å«ä»£ç é€»è¾‘ï¼Œä½¿ç”¨ä¸Šè·Ÿ Annotation æœ‰äº›ç›¸ä¼¼ï¼Œå¾ˆå®¹æ˜“è¢«æ·»åŠ æˆ–è€…åˆ é™¤ã€‚ ä½ å¯ä»¥å·²ç»è§è¿‡ä¸‹é¢çš„ Finalizers: 12kubernetes.io/pv-protectionkubernetes.io/pvc-protection è¿™ä¸¤ä¸ª Finalizer æ˜¯ç”¨æ¥é˜²æ­¢è¯¯åˆ é™¤ volume çš„ï¼Œç±»ä¼¼åŠŸèƒ½çš„ Finalizer è¿˜æœ‰å¾ˆå¤šã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªè‡ªå®šä¹‰çš„ configmapï¼ŒåªåŒ…å«ä¸€ä¸ª Finalizer: 12345678cat &lt;&lt;EOF | kubectl create -f -apiVersion: v1kind: ConfigMapmetadata: name: mymap finalizers: - kubernetesEOF è´Ÿè´£ç®¡ç† configmap çš„ controller å¹¶ä¸çŸ¥é“è¯¥å¦‚ä½•å¤„ç† kubernetes è¿™ä¸ª Finalizerã€‚çŽ°åœ¨æˆ‘å°è¯•åŽ»åˆ é™¤è¿™ä¸ª configmap: 1234kubectl delete configmap/mymap &amp;configmap "mymap" deletedjobs[1]+ Running kubectl delete configmap/mymap Kubernetes ä¼šè¿”å›žä¸€ä¸ªä¿¡æ¯å‘Šè¯‰ä½ è¿™ä¸ª configmap å·²ç»è¢«åˆ é™¤äº†ï¼Œç„¶è€Œå¹¶ä¸æ˜¯ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„åˆ é™¤ï¼Œè€Œæ˜¯å‡ºäºŽä¸€ä¸ª deleting çš„çŠ¶æ€ã€‚å½“æˆ‘ä»¬å†æ¬¡æ‰§è¡Œ get æ“ä½œåŽ»èŽ·å–è¯¥ configmapï¼Œä¼šå‘çŽ° configmap èµ„æºå·²ç»è¢«ä¿®æ”¹è¿‡äº†ï¼ŒdeletionTimeStamp è®¾ç½®äº†å€¼ã€‚ 1234567891011121314kubectl get configmap/mymap -o yamlapiVersion: v1kind: ConfigMapmetadata: creationTimestamp: "2020-10-22T21:30:18Z" deletionGracePeriodSeconds: 0 deletionTimestamp: "2020-10-22T21:30:34Z" finalizers: - kubernetes name: mymap namespace: default resourceVersion: "311456" selfLink: /api/v1/namespaces/default/configmaps/mymap uid: 93a37fed-23e3-45e8-b6ee-b2521db81638 æ¢å¥è¯è¯´ï¼Œè¿™ä¸ª configmap èµ„æºå¹¶æ²¡æœ‰è¢«åˆ é™¤è€Œæ˜¯è¢«æ›´æ–°äº†ï¼Œè¿™æ˜¯å› ä¸º Kubernetes çœ‹åˆ°èµ„æºä¸­æœ‰ä¸€ä¸ª Finalizer åŽæŠŠå®ƒç½®ä¸ºäº† read-only çŠ¶æ€ã€‚è¿™ä¸ª configmap åªæœ‰åœ¨ç§»é™¤äº† Finalizer åŽï¼Œæ‰ä¼šçœŸæ­£ä»Žé›†ç¾¤ä¸­åˆ é™¤ã€‚ æˆ‘ä»¬ä½¿ç”¨ patch å‘½ä»¤ç§»é™¤ Finalizer æ¥éªŒè¯ä¸€ä¸‹ä¸Šé¢çš„è¯´æ³•ã€‚ 12345kubectl patch configmap/mymap \ --type json \ --patch='[ &#123; "op": "remove", "path": "/metadata/finalizers" &#125; ]'configmap/mymap patched[1]+ Done kubectl delete configmap/mymap æ­¤æ—¶æˆ‘ä»¬å†åŽ» get configmapï¼Œå‘çŽ°å·²ç»èŽ·å–ä¸åˆ°äº†ã€‚ 12kubectl get configmap/mymap -o yamlError from server (NotFound): configmaps "mymap" not found ä¸Šé¢å±•ç¤ºäº†å½“ä¸€ä¸ªèµ„æºå¸¦æœ‰ Finalizer æ—¶ï¼Œæ‰§è¡Œåˆ é™¤æ“ä½œåŽçš„çŠ¶æ€æµè½¬å›¾ã€‚ Owner ReferencesOwner reference æè¿°äº†å¤šç§èµ„æºä¹‹é—´çš„å…³è”å…³ç³»ã€‚å®ƒä»¬æ˜¯å…³äºŽèµ„æºçš„å±žæ€§ï¼Œå¯ä»¥å½¼æ­¤æŒ‡å®šå…³è”å…³ç³»ï¼Œå› æ­¤å¯ä»¥åšåˆ°çº§è”åˆ é™¤ã€‚ Kubernetes ä¸­æœ€å¸¸è§çš„å…·å¤‡ owner reference å…³ç³»çš„åœºæ™¯å°±æ˜¯ pod å°† replica set ä½œä¸ºè‡ªå·±çš„ ownerï¼Œæ‰€ä»¥å½“ deployment æˆ–è€… statefulSet åˆ é™¤çš„æ—¶å€™ï¼Œä½œä¸ºå­èµ„æºçš„ replica set å’Œ pod éƒ½å°†è¢«åˆ é™¤ã€‚ ä¸‹é¢çš„ä¾‹å­è§£é‡Šäº† owner reference çš„å·¥ä½œåŽŸç†ã€‚æˆ‘ä»¬é¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªçˆ¶èµ„æºï¼Œç„¶åŽåˆ›å»ºå­èµ„æºçš„æ—¶å€™æŒ‡å®šå…¶ owner referenceï¼š 12345678910111213141516171819cat &lt;&lt;EOF | kubectl create -f -apiVersion: v1kind: ConfigMapmetadata: name: mymap-parentEOFCM_UID=$(kubectl get configmap mymap-parent -o jsonpath="&#123;.metadata.uid&#125;")cat &lt;&lt;EOF | kubectl create -f -apiVersion: v1kind: ConfigMapmetadata: name: mymap-child ownerReferences: - apiVersion: v1 kind: ConfigMap name: mymap-parent uid: $CM_UIDEOF å½“åˆ é™¤å­èµ„æºæ—¶ï¼Œçˆ¶èµ„æºå¹¶ä¸ä¼šè¢«åˆ é™¤ï¼š 1234567891011kubectl get configmapNAME DATA AGEmymap-child 0 12m4smymap-parent 0 12m4skubectl delete configmap/mymap-childconfigmap "mymap-child" deletedkubectl get configmapNAME DATA AGEmymap-parent 0 12m10s æˆ‘ä»¬å†æ ¹æ®ä¸Šé¢çš„ yaml å»ºç«‹èµ„æºï¼Œç„¶åŽæˆ‘ä»¬åˆ é™¤çˆ¶èµ„æºï¼Œè¿™æ—¶å‘çŽ°æ‰€æœ‰çš„èµ„æºéƒ½è¢«åˆ é™¤äº†ï¼š 12345678910kubectl get configmapNAME DATA AGEmymap-child 0 10m2smymap-parent 0 10m2skubectl delete configmap/mymap-parentconfigmap "mymap-parent" deletedkubectl get configmapNo resources found in default namespace. ç®€è€Œè¨€ä¹‹ï¼Œå½“çˆ¶ - å­èµ„æºä¹‹é—´å­˜åœ¨ owner reference å…³ç³»çš„æ—¶å€™ï¼Œæˆ‘ä»¬åˆ é™¤çˆ¶èµ„æºï¼Œå­èµ„æºä¹Ÿä¼šéšä¹‹åˆ é™¤ï¼Œè¿™å«åš cascade ï¼ˆçº§è”åˆ é™¤ï¼‰ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œcascade çš„å€¼æ˜¯ trueï¼Œä½ å¯ä»¥æ‰§è¡Œ kubectl delete çš„æ—¶å€™åŠ ä¸Šå‚æ•° --cascade=false ï¼Œè¿™æ ·å°±å¯ä»¥åªåˆ é™¤çˆ¶èµ„æºè€Œä¿ç•™å­èµ„æºã€‚ åœ¨ä»¥ä¸‹ç¤ºä¾‹ä¸­ï¼Œæœ‰ä¸€å¯¹çˆ¶å­èµ„æºï¼Œå¦‚æžœæˆ‘ä½¿ç”¨ --cascade = false åˆ é™¤çˆ¶èµ„æºï¼Œä½†å­èµ„æºä»ç„¶å­˜åœ¨ï¼š 1234567891011kubectl get configmapNAME DATA AGEmymap-child 0 13m8smymap-parent 0 13m8skubectl delete --cascade=false configmap/mymap-parentconfigmap "mymap-parent" deletedkubectl get configmapNAME DATA AGEmymap-child 0 13m21s â€”â€”cascade å‚æ•°èƒ½å¤ŸæŽ§åˆ¶ API ä¸­çš„åˆ é™¤ä¼ æ’­ç­–ç•¥ï¼ˆ propagation policyï¼‰ï¼Œå®ƒå…è®¸æŽ§åˆ¶åˆ é™¤å¯¹è±¡çš„é¡ºåºã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ API è®¿é—®åˆ›å»ºä¸€ä¸ªå¸¦æœ‰ background ä¼ æ’­ç­–ç•¥çš„è‡ªå®šä¹‰ delete API è°ƒç”¨ï¼š 1234567891011121314kubectl proxy --port=8080 &amp;Starting to serve on 127.0.0.1:8080curl -X DELETE \ localhost:8080/api/v1/namespaces/default/configmaps/mymap-parent \ -d &apos;&#123; &quot;kind&quot;:&quot;DeleteOptions&quot;, &quot;apiVersion&quot;:&quot;v1&quot;, &quot;propagationPolicy&quot;:&quot;Background&quot; &#125;&apos; \ -H &quot;Content-Type: application/json&quot;&#123; &quot;kind&quot;: &quot;Status&quot;, &quot;apiVersion&quot;: &quot;v1&quot;, &quot;metadata&quot;: &#123;&#125;, &quot;status&quot;: &quot;Success&quot;, &quot;details&quot;: &#123; ... &#125;&#125; è¦æ³¨æ„ï¼Œä¸èƒ½ä½¿ç”¨ kubectl åœ¨å‘½ä»¤è¡Œä¸ŠæŒ‡å®šä¼ æ’­ç­–ç•¥ã€‚å¿…é¡»ä½¿ç”¨è‡ªå®šä¹‰ API è°ƒç”¨æ¥æŒ‡å®šã€‚éœ€è¦åˆ›å»ºä¸€ä¸ªä»£ç†ï¼Œè¿™æ ·å°±å¯ä»¥ä»Žå®¢æˆ·ç«¯è®¿é—® API Serverï¼Œå¹¶æ‰§è¡Œ curl å‘½ä»¤æ¥æ‰§è¡Œè¯¥åˆ é™¤å‘½ä»¤ã€‚ ä¸€å…±æœ‰ä¸‰ç§ä¼ æ’­ç­–ç•¥ï¼š Foregroundï¼šå…ˆåˆ é™¤å­èµ„æºå†åˆ é™¤çˆ¶èµ„æºï¼ˆpost-orderï¼‰ Backgroundï¼šå…ˆåˆ é™¤çˆ¶èµ„æºå†åˆ é™¤å­èµ„æºï¼ˆpre-orderï¼‰ Orphanï¼šå¿½ç•¥ owner reference è¦æ³¨æ„ï¼Œå‡å¦‚ä¸€ä¸ªèµ„æºä¸­åŒæ—¶è®¾ç½®äº† owner reference å’Œ finalizerï¼Œfinalizer çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ã€‚ Forcing a Deletion of a Namespaceä½ å¯ä»¥å·²ç»é‡åˆ°è¿‡æ‰§è¡Œ kubectl delete ns NS åŽï¼Œns æ— æ³•åˆ é™¤çš„æƒ…å†µï¼Œè¿™æ—¶å€™ä½ å¯ä»¥é€šè¿‡ update æ‰€åˆ é™¤ ns çš„ Finalizer å­—æ®µæ¥å®žè¡Œå¼ºåˆ¶åˆ é™¤ã€‚è¿™ä¸ªæ“ä½œä¼šé€šçŸ¥åˆ° namespace controller ç§»é™¤ finalizer ï¼š 123456789101112131415cat &lt;&lt;EOF | curl -X PUT \ localhost:8080/api/v1/namespaces/test/finalize \ -H "Content-Type: application/json" \ --data-binary @-&#123; "kind": "Namespace", "apiVersion": "v1", "metadata": &#123; "name": "test" &#125;, "spec": &#123; "finalizers": null &#125;&#125;EOF è¿™ä¸ªæ“ä½œè¦è°¨æ…Žï¼Œå› ä¸ºå®ƒå¯èƒ½åªåˆ é™¤åç§°ç©ºé—´ï¼Œè€Œå°†å­¤ç«‹èµ„æºç•™åœ¨çŽ°åœ¨ä¸å­˜åœ¨çš„åç§°ç©ºé—´ä¸­ï¼Œä¼šè®©é›†ç¾¤å¤„äºŽè®©äººå¾ˆè¿·æƒ‘çš„çŠ¶æ€ã€‚å¦‚æžœå‘ç”Ÿè¿™ç§æƒ…å†µï¼Œå¯ä»¥æ‰‹åŠ¨é‡æ–°åˆ›å»ºè¯¥åç§°ç©ºé—´ï¼Œæœ‰å­¤ç«‹çš„èµ„æºå¯¹è±¡å°†é‡æ–°å‡ºçŽ°åœ¨åˆšåˆšåˆ›å»ºçš„åç§°ç©ºé—´ä¸‹ï¼Œå¯ä»¥æ‰‹åŠ¨æ¸…ç†å’Œæ¢å¤ã€‚ Key Takeawaysä¸Šé¢çš„ä¾‹å­è¯´æ˜Žï¼ŒFinalizer èƒ½å¤Ÿé˜»æ­¢ Kubernetes åˆ é™¤èµ„æºï¼Œä½†æ˜¯é€šå¸¸åœ¨ä»£ç ä¸­æ·»åŠ  Finalizer æ˜¯æœ‰åŽŸå› çš„ï¼Œå› æ­¤åº”è¯¥åœ¨æ‰‹åŠ¨åˆ é™¤å®ƒä¹‹å‰è¿›è¡Œæ£€æŸ¥ã€‚Owner reference æ”¯æŒçº§è”åˆ é™¤èµ„æºï¼Œä½† Finalizer çš„ä¼˜å…ˆçº§æ›´é«˜ã€‚æœ€åŽï¼Œå¯ä»¥ä½¿ç”¨ä¼ æ’­ç­–ç•¥é€šè¿‡è‡ªå®šä¹‰ API è°ƒç”¨æŒ‡å®šåˆ é™¤é¡ºåºï¼Œä»Žè€ŒæŽ§åˆ¶å¯¹è±¡çš„åˆ é™¤æ–¹å¼ã€‚é€šè¿‡ä¸Šé¢çš„ä¾‹å­ï¼Œç›¸ä¿¡å¤§å®¶å¯¹ Kubernetes ä¸­çš„åˆ é™¤å·¥ä½œåŽŸç†æœ‰äº†æ›´å¤šçš„äº†è§£ï¼ŒçŽ°åœ¨å¯ä»¥ä½¿ç”¨æµ‹è¯•é›†ç¾¤è‡ªå·±å°è¯•ä¸€ä¸‹ã€‚ åŽŸæ–‡åœ°å€ï¼šhttps://kubernetes.io/blog/2021/05/14/using-finalizers-to-control-deletion/]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Fuzzing is Beta Ready]]></title>
    <url>%2F2021%2F06%2F15%2FFuzzing-is-Beta-Ready%2F</url>
    <content type="text"><![CDATA[è¿‘æ—¥ Golang å›¢é˜Ÿå®£å¸ƒï¼Œgo åŽŸç”Ÿæ”¯æŒçš„æ¨¡ç³Šæµ‹è¯• (fuzzing) çš„ beta ç‰ˆæœ¬åœ¨ development åˆ†æ”¯ä¸Šå·²ç»å¯ä»¥ä½¿ç”¨äº†ã€‚å¼€å‘äººå‘˜å¯ä»¥ä½¿ç”¨è¯¥ç‰¹æ€§ä¸ºé¡¹ç›®æž„å»º fuzzing æµ‹è¯•ã€‚ é‚£ä¹ˆå…ˆæ¥çœ‹ä¸‹ä»€ä¹ˆæ˜¯ Fuzzing å‘¢ï¼Ÿ ä»€ä¹ˆæ˜¯ Fuzzingï¼ŸFuzz æœ¬æ„æ˜¯â€œç¾½æ¯›ã€ç»†å°çš„æ¯›å‘ã€ä½¿æ¨¡ç³Šã€å˜å¾—æ¨¡ç³Šâ€ï¼ŒåŽæ¥ç”¨åœ¨è½¯ä»¶æµ‹è¯•é¢†åŸŸï¼Œä¸­æ–‡ä¸€èˆ¬æŒ‡â€œæ¨¡ç³Šæµ‹è¯•â€ï¼Œè‹±æ–‡æœ‰çš„å«â€œFuzzingâ€ï¼Œæœ‰çš„å«â€œFuzz Testingâ€ã€‚æœ¬æ–‡ç”¨ fuzzing è¡¨ç¤ºæ¨¡ç³Šæµ‹è¯•ã€‚ Fuzzing æŠ€æœ¯å¯ä»¥è¿½æº¯åˆ° 1950 å¹´ï¼Œå½“æ—¶è®¡ç®—æœºçš„æ•°æ®ä¸»è¦ä¿å­˜åœ¨æ‰“å­”å¡ç‰‡ä¸Šï¼Œè®¡ç®—æœºç¨‹åºè¯»å–è¿™äº›å¡ç‰‡çš„æ•°æ®è¿›è¡Œè®¡ç®—å’Œè¾“å‡ºã€‚å¦‚æžœç¢°åˆ°ä¸€äº›åžƒåœ¾å¡ç‰‡æˆ–ä¸€äº›åºŸå¼ƒä¸é€‚é…çš„å¡ç‰‡ï¼Œå¯¹åº”çš„è®¡ç®—æœºç¨‹åºå°±å¯èƒ½äº§ç”Ÿé”™è¯¯å’Œå¼‚å¸¸ç”šè‡³å´©æºƒï¼Œè¿™æ ·ï¼ŒBug å°±äº§ç”Ÿäº†ã€‚æ‰€ä»¥ï¼ŒFuzzing æŠ€æœ¯å¹¶ä¸æ˜¯ä»€ä¹ˆæ–°é²œæŠ€æœ¯ï¼Œè€Œæ˜¯éšç€è®¡ç®—æœºçš„äº§ç”Ÿä¸€èµ·äº§ç”Ÿçš„å¤è€çš„æµ‹è¯•æŠ€æœ¯ã€‚ Fuzzing æŠ€æœ¯æ˜¯ä¸€ç§åŸºäºŽé»‘ç›’ï¼ˆæˆ–ç°ç›’ï¼‰çš„æµ‹è¯•æŠ€æœ¯ï¼Œé€šè¿‡è‡ªåŠ¨åŒ–ç”Ÿæˆå¹¶æ‰§è¡Œå¤§é‡çš„éšæœºæµ‹è¯•ç”¨ä¾‹æ¥å‘çŽ°äº§å“æˆ–åè®®çš„æœªçŸ¥æ¼æ´žã€‚éšç€è®¡ç®—æœºçš„å‘å±•ï¼ŒFuzzing æŠ€æœ¯ä¹Ÿåœ¨ä¸æ–­å‘å±•ã€‚ Fuzzingæœ‰ç”¨ä¹ˆï¼ŸFuzzing æ˜¯æ¨¡ç³Šæµ‹è¯•ï¼Œé¡¾åæ€ä¹‰ï¼Œæ„å‘³ç€æµ‹è¯•ç”¨ä¾‹æ˜¯ä¸ç¡®å®šçš„ã€æ¨¡ç³Šçš„ã€‚ è®¡ç®—æœºæ˜¯ç²¾ç¡®çš„ç§‘å­¦å’ŒæŠ€æœ¯ï¼Œæµ‹è¯•æŠ€æœ¯åº”è¯¥ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œæœ‰ä»€ä¹ˆçš„è¾“å…¥ï¼Œå¯¹åº”ä»€ä¹ˆæ ·çš„è¾“å‡ºï¼Œéƒ½åº”è¯¥æ˜¯æ˜Žç¡®çš„ï¼Œæ€Žä¹ˆä¼šæœ‰æ¨¡ç³Šä¸ç¡®å®šçš„ç”¨ä¾‹å‘¢ï¼Ÿè¿™äº›ä¸ç¡®å®šçš„æµ‹è¯•ç”¨ä¾‹å…·ä½“ä¼šæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿ ä¸ºä»€ä¹ˆä¼šæœ‰ä¸ç¡®å®šçš„æµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘æƒ³ä¸»è¦çš„åŽŸå› æ˜¯ä¸‹é¢å‡ ç‚¹ï¼š 1ã€æˆ‘ä»¬æ— æ³•ç©·ä¸¾æ‰€æœ‰çš„è¾“å…¥ä½œä¸ºæµ‹è¯•ç”¨ä¾‹ã€‚æˆ‘ä»¬ç¼–å†™æµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ï¼Œä¸€èˆ¬è€ƒè™‘æ­£å‘æµ‹è¯•ã€åå‘æµ‹è¯•ã€è¾¹ç•Œå€¼ã€è¶…é•¿ã€è¶…çŸ­ç­‰ä¸€äº›å¸¸è§çš„åœºæ™¯ï¼Œä½†æˆ‘ä»¬æ˜¯æ²¡æœ‰åŠžæ³•æŠŠæ‰€æœ‰çš„è¾“å…¥éƒ½éåŽ†è¿›è¡Œæµ‹è¯•çš„ã€‚ 2ã€æˆ‘ä»¬æ— æ³•æƒ³åˆ°æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸åœºæ™¯ã€‚ç”±äºŽäººç±»è„‘åŠ›çš„é™åˆ¶ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠžæ³•æƒ³åˆ°æ‰€æœ‰å¯èƒ½çš„å¼‚å¸¸ç»„åˆï¼Œå°¤å…¶æ˜¯çŽ°åœ¨çš„è½¯ä»¶è¶Šæ¥è¶Šå¤šçš„ä¾èµ–æ“ä½œç³»ç»Ÿã€ä¸­é—´ä»¶ã€ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œè¿™äº›ç³»ç»Ÿé‡Œçš„bugæˆ–è€…ç»„åˆåŽå½¢æˆçš„ bugï¼Œæ˜¯æˆ‘ä»¬æŸä¸ªé¡¹ç›®ç»„çš„å¼€å‘äººå‘˜ã€æµ‹è¯•äººå‘˜æ— æ³•é¢„çŸ¥çš„ã€‚ 3ã€Fuzzing è½¯ä»¶ä¹ŸåŒæ ·æ— æ³•éåŽ†æ‰€æœ‰çš„å¼‚å¸¸åœºæ™¯ã€‚éšç€çŽ°åœ¨è½¯ä»¶è¶Šæ¥è¶Šå¤æ‚ï¼Œå¯é€‰çš„è¾“å…¥å¯ä»¥è®¤ä¸ºæœ‰æ— é™ä¸ªç»„åˆï¼Œæ‰€ä»¥å³ä½¿æ˜¯ä½¿ç”¨è½¯ä»¶æ¥éåŽ†ä¹Ÿæ˜¯ä¸å¯èƒ½å®žçŽ°çš„ï¼Œå¦åˆ™ä½ çš„ç‰ˆæœ¬å¯èƒ½å°±æ°¸è¿œä¹Ÿå‘å¸ƒä¸äº†ã€‚Fuzzing æŠ€æœ¯æœ¬è´¨æ˜¯ä¾é éšæœºå‡½æ•°ç”Ÿæˆéšæœºæµ‹è¯•ç”¨ä¾‹æ¥è¿›è¡Œæµ‹è¯•éªŒè¯ï¼Œæ‰€ä»¥æ˜¯ä¸ç¡®å®šçš„ã€‚ è¿™äº›ä¸ç¡®å®šçš„æµ‹è¯•ç”¨ä¾‹ä¼šèµ·åˆ°æˆ‘ä»¬æƒ³è¦çš„æµ‹è¯•ç»“æžœä¹ˆï¼Ÿèƒ½å‘çŽ°çœŸæ­£çš„ Bug ä¹ˆï¼Ÿ1ã€Fuzzing æŠ€æœ¯é¦–å…ˆæ˜¯ä¸€ç§è‡ªåŠ¨åŒ–æŠ€æœ¯ï¼Œå³è½¯ä»¶è‡ªåŠ¨æ‰§è¡Œç›¸å¯¹éšæœºçš„æµ‹è¯•ç”¨ä¾‹ã€‚å› ä¸ºæ˜¯ä¾é è®¡ç®—æœºè½¯ä»¶è‡ªåŠ¨æ‰§è¡Œï¼Œæ‰€ä»¥æµ‹è¯•æ•ˆçŽ‡ç›¸å¯¹äººæ¥è®²è¿œè¿œé«˜å‡ºå‡ ä¸ªæ•°é‡çº§ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªä¼˜ç§€çš„æµ‹è¯•äººå‘˜ï¼Œä¸€å¤©èƒ½æ‰§è¡Œçš„æµ‹è¯•ç”¨ä¾‹æ•°é‡æœ€å¤šä¹Ÿå°±æ˜¯å‡ åä¸ªï¼Œå¾ˆéš¾è¾¾åˆ° 100 ä¸ªã€‚è€Œ Fuzzing å·¥å…·å¯èƒ½å‡ åˆ†é’Ÿå°±å¯ä»¥è½»æ¾æ‰§è¡Œä¸Šç™¾ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚ 2ã€Fuzzing æŠ€æœ¯æœ¬è´¨æ˜¯ä¾èµ–éšæœºå‡½æ•°ç”Ÿæˆéšæœºæµ‹è¯•ç”¨ä¾‹ï¼Œéšæœºæ€§æ„å‘³ç€ä¸é‡å¤ã€ä¸å¯é¢„æµ‹ï¼Œå¯èƒ½æœ‰æ„æƒ³ä¸åˆ°çš„è¾“å…¥å’Œç»“æžœã€‚ 3ã€æ ¹æ®æ¦‚çŽ‡è®ºé‡Œé¢çš„â€œå¤§æ•°å®šå¾‹â€ï¼Œåªè¦æˆ‘ä»¬é‡å¤çš„æ¬¡æ•°å¤Ÿå¤šã€éšæœºæ€§å¤Ÿå¼ºï¼Œé‚£äº›æ¦‚çŽ‡æžä½Žçš„å¶ç„¶äº‹ä»¶å°±å¿…ç„¶ä¼šå‡ºçŽ°ã€‚Fuzzing æŠ€æœ¯å°±æ˜¯å¤§æ•°å®šå¾‹çš„å…¸èŒƒåº”ç”¨ï¼Œè¶³å¤Ÿå¤šçš„æµ‹è¯•ç”¨ä¾‹å’Œéšæœºæ€§ï¼Œå°±å¯ä»¥è®©é‚£äº›éšè—çš„å¾ˆæ·±å¾ˆéš¾å‡ºçŽ°çš„Bugæˆä¸ºå¿…ç„¶çŽ°è±¡ã€‚ ç›®å‰ï¼ŒFuzzing æŠ€æœ¯å·²ç»æ˜¯è½¯ä»¶æµ‹è¯•ã€æ¼æ´žæŒ–æŽ˜é¢†åŸŸçš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µä¹‹ä¸€ã€‚Fuzzing æŠ€æœ¯ç‰¹åˆ«é€‚åˆç”¨äºŽå‘çŽ° 0 Day æ¼æ´žï¼Œä¹Ÿæ˜¯ä¼—å¤šé»‘å®¢æˆ–é»‘å¸½å­å‘çŽ°è½¯ä»¶æ¼æ´žçš„é¦–é€‰æŠ€æœ¯ã€‚Fuzzing è™½ç„¶ä¸èƒ½ç›´æŽ¥è¾¾åˆ°å…¥ä¾µçš„æ•ˆæžœï¼Œä½†æ˜¯ Fuzzing éžå¸¸å®¹æ˜“æ‰¾åˆ°è½¯ä»¶æˆ–ç³»ç»Ÿçš„æ¼æ´žï¼Œä»¥æ­¤ä¸ºçªç ´å£æ·±å…¥åˆ†æžï¼Œå°±æ›´å®¹æ˜“æ‰¾åˆ°å…¥ä¾µè·¯å¾„ï¼Œè¿™å°±æ˜¯é»‘å®¢å–œæ¬¢ Fuzzing æŠ€æœ¯çš„åŽŸå› ã€‚ æƒ³è¦äº†è§£æ›´å¤šç‰¹æ€§å¯ä»¥å‚è€ƒ golang fuzzing çš„è®¾è®¡è‰æ¡ˆ draft-fuzzing) å¿«é€Ÿä¸Šæ‰‹12$ go get golang.org/dl/gotip$ gotip download dev.fuzz è¿™å°†ä»Ž Dev.Fuzz å¼€å‘åˆ†æ”¯ä¸­æž„å»º Go Toolchainï¼Œç­‰å°†æ¥ä»£ç åˆå¹¶åˆ° Master åˆ†æ”¯åŽå°±ä¸éœ€è¦è‡ªå·±æž„å»ºäº†ã€‚ 1gotip test -fuzz=FuzzFoo DEV.Fuzz åˆ†æ”¯ä¸­ä¼šæœ‰æ­£åœ¨è¿›è¡Œçš„å¼€å‘å’Œé”™è¯¯ä¿®å¤ï¼Œéœ€è¦æ¯æ¬¡è¿è¡Œ gotip download dev.fuzz ä»¥æ‹‰å–æœ€æ–°çš„ä»£ç ã€‚ ä¸ºäº†ä¿éšœä»£ç å…¼å®¹æ€§ï¼Œåœ¨æäº¤åŒ…å«æ¨¡ç³Šæµ‹è¯•çš„æºæ–‡ä»¶æ—¶ä½¿ç”¨ gofuzzbeta æž„å»º tagã€‚ é»˜è®¤æƒ…å†µä¸‹åœ¨Dev.Fuzzåˆ†æ”¯ä¸­çš„æž„å»ºæ—¶å·²ç»å¯ç”¨æ­¤ tagã€‚ 1// +build gofuzzbeta Fuzz æµ‹è¯•æ ·ä¾‹Fuzz æµ‹è¯•ä¸Žæ™®é€šçš„å•å…ƒæµ‹è¯•ç±»ä¼¼ï¼Œéœ€è¦åœ¨ *_test.go ä¸­å®šä¹‰ Fuzzxxx å‡½æ•°ã€‚ æ­¤å‡½æ•°å¿…é¡»ä¼ é€’*testing.f å‚æ•°ï¼Œå°±åƒ * testing.t å‚æ•°ä¼ é€’ç»™ testxxx å‡½æ•°ä¸€æ ·ã€‚ ä¸‹é¢æ˜¯æµ‹è¯• net/url çš„ fuzzing target çš„ç¤ºä¾‹ã€‚ 123456789101112131415161718192021222324252627// +build gofuzzbetapackage fuzzimport ( "net/url" "reflect" "testing")func FuzzParseQuery(f *testing.F) &#123; f.Add("x=1&amp;y=2") f.Fuzz(func(t *testing.T, queryStr string) &#123; query, err := url.ParseQuery(queryStr) if err != nil &#123; t.Skip() &#125; queryStr2 := query.Encode() query2, err := url.ParseQuery(queryStr2) if err != nil &#123; t.Fatalf("ParseQuery failed to decode a valid encoded query %s: %v", queryStr2, err) &#125; if !reflect.DeepEqual(query, query2) &#123; t.Errorf("ParseQuery gave different query after being encoded\nbefore: %v\nafter: %v", query, query2) &#125; &#125;)&#125; å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤ä½¿ç”¨ Go Doc é˜…è¯»æœ‰å…³ Fuzz API çš„æ›´å¤šä¿¡æ¯ã€‚ 1234gotip doc testinggotip doc testing.Fgotip doc testing.F.Addgotip doc testing.F.Fuzz é¡»çŸ¥ æ¨¡ç³Šæµ‹è¯•ä¼šæ¶ˆè€—å¤§é‡å†…å­˜ï¼Œå¹¶åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šå½±å“æœºå™¨çš„æ€§èƒ½ã€‚ go test -fuzz é»˜è®¤å€¼ä»¥å¹¶è¡Œè¿è¡Œ $ gomaxProcs è¿›ç¨‹ä¸­çš„æ¨¡ç³Šã€‚ å¯ä»¥åœ¨è¿è¡Œ Go Test æ—¶åŠ ä¸Š --parallel æ¥é™åˆ¶å¹¶å‘ä½¿ç”¨ cpu çš„æ•°é‡ã€‚ è¦æ³¨æ„ç›®å‰æ²¡æœ‰é™åˆ¶å†™å…¥ fuzzing ç¼“å­˜çš„æ–‡ä»¶æ•°æˆ–æ€»å­—èŠ‚æ•°ï¼Œå› æ­¤å®ƒå¯èƒ½å æ®å¤§é‡å­˜å‚¨ï¼ˆå³å‡ ä¸ªGBï¼‰ï¼Œå¯ä»¥é€šè¿‡è¿è¡Œ gotip clean -fuzzcache æ¥æ¸…é™¤æ¨¡ç³Šæµ‹è¯•åŽçš„ç¼“å­˜ã€‚ æœ€åŽè¿™ä¸ªç‰¹æ€§å¹¶ä¸ä¼šå‡ºçŽ°åœ¨å³å°†å‘å¸ƒçš„ Go1.17 ä¸­ï¼Œä½†æ˜¯è®¡åˆ’åœ¨æœªæ¥çš„æŸä¸ª Go ç‰ˆæœ¬ä¸­æ­£å¼ release è¿™ä¸ªç‰¹æ€§ã€‚å®˜æ–¹å¸Œæœ›è¿™ä¸ªç‰¹æ€§èƒ½å¤Ÿå¸®åŠ© Go å¼€å‘äººå‘˜å¼€å§‹ç¼–å†™ fuzzing æµ‹è¯•ï¼Œå¹¶æä¾›å…³äºŽ fuzzing çš„è®¾è®¡çš„åé¦ˆï¼Œä¸ºæœªæ¥è¯¥åŠŸèƒ½çš„ä»£ç æ­£å¼åˆå¹¶ master åšå‡†å¤‡ã€‚ Happy fuzzing!]]></content>
      <categories>
        <category>Go</category>
      </categories>
      <tags>
        <tag>Go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go 1.16 is released, Apple silicon M1 å¯ä»¥æ”¾å¿ƒä¹°å•¦]]></title>
    <url>%2F2021%2F02%2F20%2FGo-1-16-is-released-Apple-silicon-M1-%E5%8F%AF%E4%BB%A5%E6%94%BE%E5%BF%83%E4%B9%B0%E5%95%A6%2F</url>
    <content type="text"><![CDATA[2021 å¹´ 2 æœˆ 16 æ—¥ï¼Œæ˜¥èŠ‚å‡æœŸçš„æœ€åŽä¸€å¤©ï¼ŒGo å®˜æ–¹ç»ˆäºŽå°† 1.16 ç‰ˆæœ¬ releasedã€‚ ä¸‹é¢ç®€è¦ä»‹ç»ä¸€ä¸‹ 1.16 ç‰ˆæœ¬æœ€é‡è¦çš„ä¸€äº›ç‰¹æ€§ï¼š æ ¸å¿ƒåº“åŠ å…¥äº†æ–°çš„æˆå‘˜ - embedpackage embed å¯è®¿é—®æ­£åœ¨è¿è¡Œçš„ Go ç¨‹åºä¸­æ‰€åµŒå…¥çš„é™æ€æ–‡ä»¶ã€‚ ä½¿ç”¨ embed å¯ä»¥ä½¿ç”¨ // goï¼šembed æŒ‡ä»¤åœ¨ç¼–è¯‘æ—¶ä»ŽåŒ…ç›®å½•æˆ–å­ç›®å½•è¯»å–çš„æ–‡ä»¶çš„å†…å®¹å¹¶ä½¿ç”¨å®ƒä»¬ã€‚ ä¾‹å¦‚ï¼Œä»¥ä¸‹ä¸‰ç§æ–¹æ³•å¯ä»¥åµŒå…¥åä¸º hello.txt çš„æ–‡ä»¶ï¼Œç„¶åŽåœ¨è¿è¡Œæ—¶æ‰“å°å…¶å†…å®¹ã€‚ å°†ä¸€ä¸ªæ–‡ä»¶åµŒå…¥åˆ°å­—ç¬¦ä¸²ä¸­ 12345import _ "embed"//go:embed hello.txtvar s stringprint(s) å°†ä¸€ä¸ªæ–‡ä»¶åµŒå…¥ []byte 12345import _ "embed"//go:embed hello.txtvar b []byteprint(string(b)) å°†ä¸€ä¸ªæˆ–å¤šä¸ªæ–‡ä»¶åµŒå…¥åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ 123456import "embed"//go:embed hello.txtvar f embed.FSdata, _ := f.ReadFile("hello.txt")print(string(data)) è¿™ç§å°†é™æ€æ–‡ä»¶åœ¨ç¼–è¯‘æ—¶åµŒå…¥å¯æ‰§è¡Œæ–‡ä»¶çš„æ–¹å¼ï¼Œåœ¨æžå¤§åœ°æé«˜äº† go è®¿é—®é™æ€æ–‡ä»¶çš„çµæ´»æ€§çš„åŒæ—¶ï¼Œä¹Ÿèƒ½æé«˜äº†æ•æ„Ÿé…ç½®æ–‡ä»¶çš„å®‰å…¨æ€§ã€‚æ›´å¤§èƒ†ä¸€ç‚¹ï¼Œæ˜¯ä¸æ˜¯åœ¨å‰ç«¯é¢†åŸŸï¼Œgolang ä¹Ÿèƒ½æ’ä¸€è„šäº†ï¼Ÿ å¢žåŠ å¯¹ Apple silicon ARM 64 æž¶æž„çš„æ”¯æŒGo 1.16 è¿˜æ·»åŠ äº†macOS ARM64 æ”¯æŒï¼ˆä¹Ÿç§°ä¸ºApple siliconï¼‰ã€‚ è‡ª Apple å®£å¸ƒå…¶æ–°çš„ ARM64 æž¶æž„ä»¥æ¥ï¼Œgo team ä¸€ç›´åœ¨ä¸Žä»–ä»¬ç´§å¯†åˆä½œä»¥ç¡®ä¿ Go å¾—åˆ°å®Œå…¨çš„æ”¯æŒã€‚ä¸€ç›´åœ¨ è§‚æœ› M1 çš„å¼€å‘è€…è¿™ä¸‹å¯ä»¥æ”¾å¿ƒåŽ»ä¹°æ–°çš„ Mac å•¦ã€‚ é»˜è®¤å¼€å¯ Go modulesGo 1.16 é»˜è®¤ä½¿ç”¨ Go modulesã€‚å› ä¸ºæ ¹æ® go team çš„ 2020 Go å¼€å‘äººå‘˜è°ƒæŸ¥ï¼ŒçŽ°åœ¨æœ‰96ï¼…çš„ Go å¼€å‘äººå‘˜å·²ç»åœ¨ä½¿ç”¨ Go modulesäº†ã€‚ å…¶ä»–çš„æ€§èƒ½æ”¹å–„ä¸Žæé«˜æœ€åŽï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æ”¹è¿›å’Œ bug fixï¼Œæ¯”å¦‚æž„å»ºé€Ÿåº¦æé«˜äº†25ï¼…ï¼Œå†…å­˜ä½¿ç”¨é‡å‡å°‘äº†15ï¼…ã€‚ æœ‰å…³æ›´æ”¹çš„å®Œæ•´åˆ—è¡¨ä»¥åŠæœ‰å…³ä¸Šè¿°æ”¹è¿›çš„æ›´å¤šä¿¡æ¯ï¼Œå¯ä»¥å‚è€ƒ Go 1.16å‘è¡Œè¯´æ˜Ž)ã€‚ ä»¥ä¸Šå°±æ˜¯ Go 1.16 å¸¦æ¥çš„æ–°ç‰¹æ€§ï¼Œæœ‰å¼€å‘è€…è°ƒä¾ƒåˆ° â€œæœ€å¤§çš„ç‰¹æ€§å°±æ˜¯ç¦»æ³›åž‹çš„ç‰ˆæœ¬å·æ›´è¿‘äº†ï¼ˆç‹—å¤´ï¼‰â€å“ˆå“ˆå“ˆã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Redirecting godoc.org requests to pkg.go.dev]]></title>
    <url>%2F2020%2F12%2F16%2FRedirecting-godoc-org-requests-to-pkg-go-dev%2F</url>
    <content type="text"><![CDATA[çŽ°çŠ¶éšç€ Go Module çš„å¼•å…¥å’Œ Go ç”Ÿæ€ç³»ç»Ÿçš„å‘å±•ï¼Œpkg.go.dev äºŽ 2019 å¹´å¯åŠ¨ï¼Œä¸ºå¼€å‘äººå‘˜æä¾›äº†äº†ä¸€ä¸ªæŸ¥æ‰¾ Go package çš„åœ°æ–¹ï¼Œå®˜æ–¹ç§°ä¹‹ä¸º center placeã€‚ åƒ godoc.org ä¸€æ ·ï¼Œpkg.go.dev æä¾› Go æ–‡æ¡£ï¼Œä½†å®ƒä¹Ÿæ”¯æŒ Go Moduleã€æ›´å¥½çš„æœç´¢åŠŸèƒ½ä»¥åŠå¸®åŠ© Go ç”¨æˆ·æ‰¾åˆ°æ­£ç¡®è½¯ä»¶åŒ…çš„æŒ‡å¼•ã€‚ æ­£å¦‚å®˜æ–¹åœ¨ 2020å¹´1æœˆåˆ†äº« çš„é‚£æ ·ï¼Œå®˜æ–¹çš„ç›®æ ‡æ˜¯æœ€ç»ˆå°†æµé‡ä»Ž godoc.org é‡å®šå‘åˆ° pkg.go.dev ä¸Šçš„ç›¸åº”é¡µé¢ã€‚ ç”¨æˆ·å¯ä»¥è¿˜å¯ä»¥é€‰æ‹©å°†è‡ªå·±çš„è¯·æ±‚ä»Žgodoc.org é‡å®šå‘åˆ° pkg.go.devã€‚ ä»Šå¹´å®˜æ–¹æ”¶åˆ°äº†å¾ˆå¤šåé¦ˆï¼Œå¾ˆå¤šé—®é¢˜å·²ç»åœ¨ pkgsite/godoc.org-redirect å’Œ pkgsite/design-2020 è¿›è¡Œè·Ÿè¸ªå’Œè§£å†³ã€‚ ç”¨æˆ·çš„åé¦ˆæ„è§æ”¯æŒå¯¹ pkg.go.dev ä¸Šçš„é«˜é¢‘åŠŸèƒ½çš„æ”¹è¿›ï¼Œä»¥åŠæœ€è¿‘å¯¹pkg.go.dev çš„é‡æ–°è®¾è®¡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚ ä¸‹ä¸€æ­¥ä¸€æ—¦åœ¨ pkgsite/godoc.org-redirect é‡Œç¨‹ç¢‘ä¸­è·Ÿè¸ªçš„å·¥ä½œå®Œæˆ, å®˜æ–¹å°±ä¼šå°†æ‰€æœ‰è¯·æ±‚ä»Ž godoc.org é‡å®šå‘åˆ°pkg.go.devä¸Šçš„ç›¸åº”é¡µé¢,è¿™å¤§æ¦‚ä¼šåœ¨2021 å¹´åˆå¼€å§‹ã€‚ å®˜æ–¹é¼“åŠ±å¤§å®¶çŽ°çŠ¶å°±å¼€å§‹ä½¿ç”¨ pkg.go.dev, å¯ä»¥é€šè¿‡è®¿é—® godoc.org?redirect=on æˆ–å•å‡»ä»»ä½•godoc.org é¡µé¢å³ä¸Šè§’çš„ â€œAlways use pkg.go.devâ€ æ¥å®žçŽ°ã€‚ FAQs A: godoc.org è¿˜å¯ä»¥ç»§ç»­ä½¿ç”¨å—ï¼ŸQ: YES! æˆ‘ä»¬ä¼šå°†æ‰€æœ‰è®¿é—® godoc.org çš„è¯·æ±‚é‡å®šå‘åˆ° pkg.go.dev ä¸Šçš„ç›¸åº”é¡µé¢ï¼Œå› æ­¤ä½ æ‰€æœ‰çš„ä¹¦ç­¾å’Œé“¾æŽ¥ä¾ç„¶æœ‰æ•ˆã€‚ A: golang/gddo repo å°†ä¼šå¦‚ä½•å¤„ç†ï¼ŸQ: repo å¯ä»¥ç»§ç»­ fork å’Œä½¿ç”¨ï¼Œä½†æ˜¯å®˜æ–¹å°†å¯¹å…¶æ ‡è®°ä¸º archivedã€‚ A: api.godoc.org è¿˜èƒ½ç»§ç»­ä½¿ç”¨å—ï¼ŸQ: æ­¤è¿‡æ¸¡ä¸ä¼šå¯¹ api.godoc.org äº§ç”Ÿå½±å“ã€‚ åœ¨ pkg.go.dev æä¾› API ä¹‹å‰ï¼Œapi.godoc.org å°†ç»§ç»­ä¸ºæµé‡æä¾›æœåŠ¡ã€‚ æœ‰å…³ pkg.go.dev çš„ API çš„æ›´æ–°ï¼Œè¯·å‚è§ issue 36785ã€‚ Contributing Pkg.go.dev æ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ã€‚ å¦‚æžœä½ æœ‰å…´è¶£ä¸º pkg site åšå‡ºè´¡çŒ®ï¼Œå¯ä»¥åŠ å…¥ Gophers Slack ä¸Šçš„ #pkgsite é¢‘é“ä»¥äº†è§£æ›´å¤šä¿¡æ¯ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Can I convert a []T to an []interface{}?]]></title>
    <url>%2F2020%2F12%2F09%2FCan-I-convert-a-T-to-an-interface%2F</url>
    <content type="text"><![CDATA[Can I convert a []T to an []interface{}?ä¼—æ‰€å‘¨çŸ¥ï¼Œåœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç§æŠ½è±¡ç±»åž‹ï¼Œç›¸å¯¹äºŽæŠ½è±¡ç±»åž‹çš„æ˜¯å…·ä½“ç±»åž‹ï¼ˆconcrete typeï¼‰ï¼šintï¼Œstringã€‚interface{} æ˜¯ä¸€ä¸ªç©ºçš„ interface ç±»åž‹ï¼Œä¸€ä¸ªç±»åž‹å¦‚æžœå®žçŽ°äº†ä¸€ä¸ª interface çš„æ‰€æœ‰æ–¹æ³•å°±è¯´è¯¥ç±»åž‹å®žçŽ°äº†è¿™ä¸ª interfaceï¼Œç©ºçš„ interface æ²¡æœ‰æ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥è®¤ä¸ºæ‰€æœ‰çš„ç±»åž‹éƒ½å®žçŽ°äº† interface{}ã€‚å¦‚æžœå®šä¹‰ä¸€ä¸ªå‡½æ•°å‚æ•°æ˜¯ interface{} ç±»åž‹ï¼Œè¿™ä¸ªå‡½æ•°åº”è¯¥å¯ä»¥æŽ¥å—ä»»ä½•ç±»åž‹ä½œä¸ºå®ƒçš„å‚æ•°ã€‚ 12func changeType(v interface&#123;&#125;)&#123; &#125; æ—¢ç„¶ç©ºçš„ interface å¯ä»¥æŽ¥å—ä»»ä½•ç±»åž‹çš„å‚æ•°ï¼Œé‚£ä¹ˆä¸€ä¸ª interface{}ç±»åž‹çš„ slice æ˜¯ä¸æ˜¯å°±å¯ä»¥æŽ¥å—ä»»ä½•ç±»åž‹çš„ slice ?çœ‹ä¸‹é¢çš„ä»£ç ï¼š 12345678910func traverseSlice(vals []interface&#123;&#125;) &#123; for _, val := range vals &#123; fmt.Println(val) &#125;&#125;func main()&#123; nums := []string&#123;"1", "2", "3"&#125; traverseSlice(nums)&#125; ä¸æ˜¯è¯´ç©ºçš„ interface å¯ä»¥æ˜¯ä»»ä½•ç±»åž‹å—ï¼Ÿä¸ºä½•æŠ¥äº†ä¸‹é¢çš„é”™è¯¯ï¼Ÿ è¿™ä¸ªé”™è¯¯è¯´æ˜Ž go æ²¡æœ‰è‡ªåŠ¨æŠŠ []string è½¬æ¢æˆ []interface{} ï¼Œæ‰€ä»¥å‡ºé”™äº†ã€‚go ä¸ä¼šå¯¹ ç±»åž‹æ˜¯interface{} çš„ slice è¿›è¡Œè½¬æ¢ ã€‚ä¸ºä»€ä¹ˆ go ä¸å¸®æˆ‘ä»¬è‡ªåŠ¨è½¬æ¢? åœ¨ golang å®˜æ–¹ blog çš„ FAQ ä¸­æ‰¾åˆ°äº†å¯¹è¿™ä¸ªé—®é¢˜çš„è§£é‡Šï¼Œç”±äºŽinterface{} ä¼šå ç”¨ä¸¤éƒ¨åˆ†å­˜å‚¨ç©ºé—´ï¼Œä¸€ä¸ªæ˜¯è‡ªèº«çš„ methods æ•°æ®ï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘å…¶å­˜å‚¨å€¼çš„æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯ interface å˜é‡å­˜å‚¨çš„å€¼ï¼Œå› è€Œ slice []interface{} å…¶é•¿åº¦æ˜¯å›ºå®šçš„N*2ï¼Œä½†æ˜¯ []T çš„é•¿åº¦æ˜¯N*sizeof(T)ï¼Œç”¨å®˜æ–¹çš„è§£é‡Šå°±æ˜¯ä¸¤ç§ç±»åž‹åœ¨å†…å­˜ä¸­çš„è¡¨çŽ°æ˜¯ä¸ä¸€æ ·çš„ã€‚é‚£è¯¥å¦‚ä½•åŽ»è½¬æ¢å‘¢ï¼Ÿå¯ä»¥æŒ‰ç…§å•ä¸ªå…ƒç´ æ¥è½¬æ¢ï¼š 123456789101112import "fmt"func main() &#123; t := []int&#123;1, 2, 3, 4&#125; s := make([]interface&#123;&#125;, len(t)) for i, v := range t &#123; s[i] = v &#125; fmt.Println(s)&#125; é™„ https://golang.org/doc/faq#convert_slice_of_interface å¯¹è¿™ä¸ªé—®é¢˜çš„è§£é‡Šï¼š]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[kubectl delete pod ç­‰å¾… 30s çš„é—®é¢˜æŽ’æŸ¥ä¸Žè§£å†³]]></title>
    <url>%2F2020%2F11%2F23%2Fkubectl-delete-pod-%E7%AD%89%E5%BE%85-30s-%E7%9A%84%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5%E4%B8%8E%E8%A7%A3%E5%86%B3%2F</url>
    <content type="text"><![CDATA[æˆ‘ä»¬å¹³æ—¶åœ¨ä½¿ç”¨ Kubernetes çš„æ—¶å€™ï¼Œä¸€èˆ¬ä¼šä½¿ç”¨ kubectl delete pod podName çš„æ–¹å¼åˆ é™¤ä¸€ä¸ªå®¹å™¨ã€‚ ä½†æˆ‘ä»¬å‘çŽ°ï¼Œæ¯æ¬¡æ‰§è¡Œ kubectl delete pod ä¹‹åŽéƒ½è¦ç­‰å¾… 30s kubectl æ‰ä¼šè¿”å›žã€‚ä¹Ÿè®¸ä½ ä¼šè§‰å¾— 30s æ˜¯ä¸€ä¸ªå¯ä»¥å¿å—çš„æ—¶é—´ï¼Œ åªè¦æœ€ç»ˆèƒ½åˆ æŽ‰ pod å°±è¡Œï¼Œä½†è¿™æ ·çš„é—®é¢˜çœŸçš„åªæœ‰ 30s è¿™ä¹ˆç®€å•å—ï¼Ÿ ä¸ºä»€ä¹ˆä¸èƒ½å¾ˆå¿«å…³é—­å®¹å™¨å‘¢ï¼Ÿ æˆ–è€…ä¸ºä»€ä¹ˆæ°å¥½å°±æ˜¯ 30s å‘¢ï¼Ÿä¸‹é¢å°±è®©æˆ‘ä»¬ä»Žæ ¹æºå¼„æ¸…æ¥šè¿™ä»¶äº‹æƒ…å¹¶è§£å†³å®ƒã€‚ kubectl delete å¦‚ä½•å…³é—­å¹¶åˆ é™¤å®¹å™¨ï¼Ÿkubectl delete å‘½ä»¤æ˜¯åœ¨å¯¹å®¹å™¨å‘å‡ºåœæ­¢å‘½ä»¤æ—¶ä½¿ç”¨çš„ï¼Œä»Žå‘é€ä¿¡å·ä¸Šæ¥è®²ï¼Œå®ƒå°†å‘é€ SIGTERM ä¿¡å·ç»™å®¹å™¨ï¼Œé€šçŸ¥å…¶ç»“æŸè¿è¡Œã€‚ SIGINT ä¸€èˆ¬ç”¨äºŽå…³é—­å‰å°è¿›ç¨‹ï¼ŒSIGTERM ä¼šè¦æ±‚è¿›ç¨‹è‡ªå·±æ­£å¸¸é€€å‡ºã€‚ å½“æˆ‘ä»¬åœ¨ shell ä¸­ç»™è¿›ç¨‹å‘é€ SIGTERM å’Œ SIGINT ä¿¡å·çš„æ—¶å€™ï¼Œè¿™äº›è¿›ç¨‹å¾€å¾€éƒ½èƒ½æ­£ç¡®çš„å¤„ç†ã€‚ ä½†æ˜¯åœ¨å®¹å™¨ä¸­å´ä¸ç”Ÿæ•ˆ, è¿™æ˜¯å› ä¸ºåœ¨ docker ä¸­ï¼Œåªä¼šå°† SIGTERM ç­‰æ‰€æœ‰çš„ signal ä¿¡å·å‘é€ç»™ PID ä¸º 1 çš„è¿›ç¨‹ï¼Œå½“æˆ‘ä»¬ docker ä¸­è¿è¡Œçš„è¿›ç¨‹çš„ PID ä¸æ˜¯ 1 æ—¶ï¼Œå°±ä¸ä¼šæ”¶åˆ°è¿™æ ·çš„ä¿¡å·ã€‚ é‚£ä¹ˆä¸ºä»€ä¹ˆæ˜¯ç­‰å¾… 30s ? ä¸Šå›¾æ˜¯å®˜æ–¹æ–‡æ¡£çš„ä¸€æ®µæˆªå›¾ï¼ŒKubernetes çš„ pod ä¸­æœ‰ä¸€ä¸ªå‚æ•° terminationGracePeriodSecondsï¼Œæ­¤æ—¶ï¼Œk8s ç­‰å¾…æŒ‡å®šçš„æ—¶é—´ç§°ä¸ºä¼˜é›…ç»ˆæ­¢å®½é™æœŸã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™ä¸ªå€¼æ˜¯ 30sã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ preStop Hook å’Œ SIGTERM ä¿¡å·å¹¶è¡Œå‘ç”Ÿã€‚Kubernetes ä¸ä¼šç­‰å¾… preStop Hook å®Œæˆã€‚è¿™æ„å‘³ç€å¦‚æžœä½ çš„åº”ç”¨ç¨‹åºå®Œæˆå…³é—­å¹¶åœ¨ terminationGracePeriod å®Œæˆä¹‹å‰é€€å‡ºï¼ŒKubernetes ä¼šç«‹å³è¿›å…¥ä¸‹ä¸€æ­¥ã€‚å¦‚æžœä½ çš„ Pod é€šå¸¸éœ€è¦è¶…è¿‡ 30s æ‰èƒ½å…³é—­ï¼Œé‚£ä¹ˆå¿…é¡»å¢žåŠ è¿™ä¸ªå‚æ•°çš„å¤§å°ï¼Œå¯ä»¥é€šè¿‡åœ¨ pod æ¨¡æ¿ä¸­è®¾ç½® terminationGracePeriodSeconds æ¥å®žçŽ°ã€‚ å¦‚æžœè¾¾åˆ°ä¸Šé¢çš„æ—¶é—´é™åˆ¶ï¼Œk8s å°†ä¼šé€šè¿‡ç»™å†…æ ¸å‘é€ SIGKILL ä»Žè€Œå¼ºåˆ¶ç»“æŸå®¹å™¨ã€‚è¿™å°±è§£é‡Šäº†ä¸ºä»€ä¹ˆæ¯æ¬¡ delete pod éƒ½è¦ç­‰å¾… 30sï¼Œæ ¹æœ¬åŽŸå› è¿˜æ˜¯å®¹å™¨ä¸­çš„ java è¿›ç¨‹çš„ PID ä¸æ˜¯ 1ï¼Œæ‰€ä»¥è¯¥è¿›ç¨‹ä¸ä¼šç†è§£æ”¶åˆ° SIGTERMï¼Œåœ¨ç­‰å¾… default terminationGracePeriodSeconds çš„æ—¶é•¿åŽè¢«å¼ºåˆ¶ç»“æŸã€‚ å¼ºåˆ¶å…³é—­å®¹å™¨çš„åŽæžœæ˜¯ä»€ä¹ˆï¼ŸçŽ°åœ¨æˆ‘ä»¬å·²ç»äº†è§£äº† kubectl delete pod ç­‰å¾… 30s çš„åŽŸå› äº†ã€‚ æˆ‘ä»¬å†æ¥çœ‹çœ‹å¦ä¸€ä¸ªé—®é¢˜ï¼š å¼ºåˆ¶å…³é—­å®¹å™¨ï¼ŒçœŸçš„å°±æ²¡é—®é¢˜å—ï¼Ÿ æˆ–è®¸ä½ èƒ½æƒ³åˆ°ï¼Œå¾ˆå¤šè¿›ç¨‹åœ¨ç»“æŸé˜¶æ®µä¼šåšä¸€äº›æ¸…ç†å·¥ä½œï¼šæ¯”å¦‚åˆ é™¤ä¸´æ—¶ç›®å½•ã€æ‰§è¡Œ shutdown hook ç­‰ã€‚ ä½†æ˜¯å½“è¿›ç¨‹è¢«å¼ºåˆ¶å…³é—­æ—¶ï¼Œè¿™äº›ä»»åŠ¡å°±ä¸ä¼šè¢«æ‰§è¡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯èƒ½å¾—åˆ°ä¸€äº›å¹¶ä¸æœŸæœ›çš„ç»“æžœã€‚ ä»¥ Eureka ä¸ºä¾‹ï¼ŒEureka client åœ¨ç»“æŸè¿›ç¨‹æ—¶ï¼Œéœ€è¦å‘ Eureka server å‘é€ shutdown ä¿¡å·ï¼Œä»¥æ³¨é”€ clientã€‚ è¿™æœ¬æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼Œå› ä¸º Eureka server å³ä½¿æ²¡æœ‰æ”¶åˆ°è¿™æ ·çš„ä¿¡æ¯ï¼Œä¹Ÿä¼šå®šæœŸæ¸…ç† client ä¿¡æ¯ã€‚ ä½†æ˜¯ Eureka server è¿˜æœ‰ä¸€ä¸ª self preservation æ¨¡å¼ï¼Œä»¥é˜²æ­¢æ„å¤–çš„ç½‘ç»œäº‹ä»¶å¯¼è‡´å¤§é‡çš„ client ä¸‹çº¿ã€‚ è¿™å°±æœ‰å¯èƒ½å¯¼è‡´ Eureka é›†ç¾¤çš„æ³¨å†Œè¡¨ä¸­å‡ºçŽ°å¤§é‡çš„ client ä¿¡æ¯ï¼Œä½†å®ƒä»¬å…¶å®žå·²ç»å…³é—­äº†ã€‚ é‚£ä¹ˆå¦‚ä½•ä¼˜é›…åœ°å…³é—­å®¹å™¨?é€šè¿‡ä¸Šé¢çš„åˆ†æžæˆ‘ä»¬ä¸éš¾æ‰¾å‡ºè§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•ï¼Œå°±æ˜¯è®©å®¹å™¨ä¸­çš„å¯åŠ¨çš„è¿›ç¨‹ PID ä¸º 1ã€‚å…ˆçœ‹ä¸‹ä¹‹å‰çš„å®¹å™¨ä¸­ java è¿›ç¨‹çš„ PIDï¼Œç¡®å®žä¸æ˜¯ 1ï¼Œ æ˜¯ 8ï¼š å¯ä»¥çœ‹åˆ° PID ä¸º 1 çš„æ˜¯å¯åŠ¨ java è¿›ç¨‹çš„ shell è„šæœ¬ã€‚ è¿™å°±è¦è¿½æº¯åˆ° Dockerfile çš„ ENTRYPOINT çš„ä¸¤ç§å†™æ³•ï¼Œå³ exec å’Œ shellï¼Œä¸¤è€…çš„åŒºåˆ«åœ¨äºŽï¼š exec å½¢å¼çš„å‘½ä»¤ä¼šä½¿ç”¨ PID 1 çš„è¿›ç¨‹ï¼› shell å½¢å¼çš„å‘½ä»¤ä¼šè¢«æ‰§è¡Œä¸º /bin/sh -c ï¼Œä¸ä¼šæ‰§è¡Œåœ¨ PID 1 ä¸Šï¼Œä¹Ÿå°±ä¸ä¼šæ”¶åˆ° signalã€‚ æˆ‘ä»¬æ£€æŸ¥äº†ä¸‹å¯åŠ¨ java è¿›ç¨‹çš„è„šæœ¬ï¼Œå‘çŽ°ç¡®å®žæ˜¯ç”¨ exec çš„æ–¹å¼å¯åŠ¨çš„ï¼Œé‚£ä¸ºä»€ä¹ˆ java è¿›ç¨‹çš„ PID è¿˜ä¸æ˜¯ 1 å‘¢ï¼Ÿ åŽŸå› æ˜¯ exec å½¢å¼çš„ ENTRYPOINT åªèƒ½è§£å†³ æ— éœ€ä»»ä½•å‡†å¤‡å·¥ä½œå°±å¯åŠ¨è¿›ç¨‹ çš„åœºæ™¯ï¼Œè€Œä¸èƒ½è§£å†³ä¸€äº›éœ€è¦å‡†å¤‡å·¥ä½œçš„å¤æ‚åœºæ™¯ã€‚ä¸¾ä¸ªæ —å­ï¼Œæˆ‘ä»¬çš„ ENTRYPOINT å¾€å¾€éœ€è¦æ‰§è¡Œä¸€ä¸ª shell è„šæœ¬ï¼Œç„¶åŽåœ¨è„šæœ¬çš„æœ€åŽæ‰ä¼šåŽ»æ‰§è¡Œ java -jar xxxï¼Œè¿™æ—¶å€™ï¼Œæˆ‘ä»¬çš„ java è¿›ç¨‹å°±æ— æ³•æˆä¸º PID 1 è¿›ç¨‹ã€‚ æˆ‘ä»¬å¯ä»¥åœ¨ shell ä¸­ä½¿ç”¨ exec å‘½ä»¤æ¥è§£å†³ã€‚è¿™ä¸ªå‘½ä»¤çš„ä½œç”¨å°±æ˜¯ä½¿ç”¨æ–°çš„è¿›ç¨‹æ›¿ä»£åŽŸæœ‰çš„è¿›ç¨‹ï¼Œå¹¶ä¿æŒ PID ä¸å˜ã€‚ è¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨æ‰§è¡Œ java å‘½ä»¤çš„æ—¶å€™ä½¿ç”¨å®ƒï¼Œä»Žè€Œæ›¿æ¢æŽ‰ PID 1 çš„ shell è„šæœ¬ã€‚ entrypoint.sh demo123#!/bin/shecho "prepare..."exec java -jar app.jar ä¿®æ”¹åŽæˆ‘ä»¬å†æ¥çœ‹ä¸‹å®¹å™¨ä¸­çš„ java è¿›ç¨‹çš„ PIDï¼š ä½¿ç”¨ exec ä¹‹åŽï¼Œå®¹å™¨ä¸­ java è¿›ç¨‹çš„ PID æˆä¸º 1ï¼Œæˆ‘ä»¬å‘å‡º delete pod è¯·æ±‚èƒ½è®©è¿›ç¨‹æŽ¥æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œæ‰§è¡Œç›¸åº”çš„æ“ä½œåŽç«‹å³é€€å‡ºã€‚ ç¯‡å¤–ï¼šdocker æ˜¯å¦‚ä½•åˆ›å»ºå®¹å™¨çš„ PID ä¸º 1 çš„è¿›ç¨‹?å½“æˆ‘ä»¬æ‰§è¡Œ docker run -it busybox /bin/sh çš„æ—¶å€™ï¼Œå¯¹äºŽæ“ä½œç³»ç»Ÿæ¥è®²æ˜¯ä¸ªè¿›ç¨‹, æ“ä½œç³»ç»Ÿä¼šåˆ†é…ä¸€ä¸ª PID ç»™è¿™ä¸ªè¿›ç¨‹, æ¯”å¦‚è¿™ä¸ªè¿›ç¨‹å·æ˜¯ PID=8, å¯¹äºŽæ“ä½œç³»ç»Ÿå…¨å±€æ¥è®²å®ƒæ˜¯ PID=8 çš„ä¸€ä¸ªè¿›ç¨‹, ä½†æ˜¯æˆ‘ä»¬è¿›å…¥å®¹å™¨æ‰§è¡Œå‘½ä»¤ps, ä¼šå‘çŽ° /bin/sh çš„ PID=1ã€‚è¿™ç§å°±æ˜¯ docker çš„ namespace æœºåˆ¶, å¯¹äºŽå…¨å±€æ¥è®², è¿™æ¡ docker å‘½ä»¤çš„çš„ PID å¯èƒ½æ˜¯ 8, ä½†æ˜¯å¯¹äºŽå®¹å™¨å†…éƒ¨æ¥è®² , å®ƒæž„å»ºäº†ä¸€ä¸ªå‡çš„å‘½åç©ºé—´, ä½¿ /bin/sh çš„ PID è¿›ç¨‹ç­‰äºŽ 1ã€‚ å…¶ä¸­ç”¨åˆ°çš„æŠ€æœ¯å°±æ˜¯Linuxçš„åˆ›å»ºçº¿ç¨‹çš„ system call, å¯¹åº”çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°å°±æ˜¯ clone()ã€‚ 1int pid = clone(main_function, stack_size, SIGCHLD, NULL); è¿™ä¸ªç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°çš„è¿›ç¨‹ï¼Œå¹¶ä¸”è¿”å›žå®ƒçš„ PIDï¼Œè€Œå½“æˆ‘ä»¬ç”¨ clone() ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªæ–°è¿›ç¨‹æ—¶ï¼Œå°±å¯ä»¥åœ¨å‚æ•°ä¸­æŒ‡å®š CLONE_NEWPID å‚æ•°ï¼š 1int pid = clone(main_function, stack_size, CLONE_NEWPID | SIGCHLD, NULL); è¿™æ—¶ï¼Œæ–°åˆ›å»ºçš„è¿™ä¸ªè¿›ç¨‹å°†ä¼šçœ‹åˆ°ä¸€ä¸ªå…¨æ–°çš„è¿›ç¨‹ç©ºé—´ï¼Œåœ¨è¿™ä¸ªè¿›ç¨‹ç©ºé—´é‡Œï¼Œå®ƒçš„ PID æ˜¯ 1ã€‚ä½†æ˜¯åœ¨å®¿ä¸»æœºçœŸå®žçš„è¿›ç¨‹ç©ºé—´é‡Œï¼Œè¿™ä¸ªè¿›ç¨‹çš„ PID è¿˜æ˜¯ç³»ç»Ÿçš„æ•°å€¼ 8ã€‚ ä»¥ä¸Šã€‚]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>kubernetes</tag>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Why is there no Goroutine ID?]]></title>
    <url>%2F2020%2F11%2F09%2FWhy-is-there-no-goroutine-ID%2F</url>
    <content type="text"><![CDATA[åœ¨C/C++/Javaç­‰è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æŽ¥èŽ·å–Thread Idï¼Œç„¶åŽé€šè¿‡æ˜ å°„Thread Idå’ŒäºŒçº§è°ƒåº¦Task Idçš„å…³ç³»ï¼Œå¯ä»¥åœ¨æ—¥å¿—ä¸­æ‰“å°å½“å‰çš„TaskIdï¼Œå³ç”¨æˆ·ä¸æ„ŸçŸ¥Task Idçš„æ‰“å°ï¼Œé€‚é…å±‚ç»Ÿä¸€å°è£…ï¼Œè¿™ä½¿å¾—å¤šçº¿ç¨‹å¹¶å‘çš„æ—¥å¿—çš„æŸ¥çœ‹æˆ–è¿‡æ»¤å˜å¾—éžå¸¸å®¹æ˜“ã€‚ Goroutine æ˜¯ Golang ä¸­è½»é‡çº§çº¿ç¨‹çš„å®žçŽ°ï¼Œç”± Go Runtime ç®¡ç†ã€‚Golang åœ¨è¯­è¨€çº§åˆ«æ”¯æŒè½»é‡çº§çº¿ç¨‹ï¼Œå«åç¨‹ã€‚Golang æ ‡å‡†åº“æä¾›çš„æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨æ“ä½œï¼ˆå½“ç„¶ä¹ŸåŒ…æ‹¬æ‰€æœ‰åŒæ­¥ IO æ“ä½œï¼‰ï¼Œéƒ½ä¼šå‡ºè®© CPU ç»™å…¶ä»– Goroutineã€‚è¿™è®©äº‹æƒ…å˜å¾—éžå¸¸ç®€å•ï¼Œè®©è½»é‡çº§çº¿ç¨‹çš„åˆ‡æ¢ç®¡ç†ä¸ä¾èµ–äºŽç³»ç»Ÿçš„çº¿ç¨‹å’Œè¿›ç¨‹ï¼Œä¹Ÿä¸ä¾èµ–äºŽ CPU çš„æ ¸å¿ƒæ•°é‡ã€‚ å®˜æ–¹æ›¾ç»ä½¿ç”¨ IIRC æ¥æš´éœ² GoId ï¼Œä½†æ˜¯è‡ªä»Ž go1.4 ç‰ˆæœ¬ä»¥åŽï¼ŒGoroutine Id æ— æ³•ç›´æŽ¥ä»Ž Go Runtime èŽ·å–äº†ã€‚ ç¦ç”¨çš„åŽŸå› æœ‰ä»¥ä¸‹ä¸¤ç‚¹ï¼š å½“ Goroutine å…³é—­æ—¶ï¼ŒGoroutine çš„ local storage å¹¶ä¸ä¼šç«‹å³è¢«åžƒåœ¾å›žæ”¶ï¼Œè¿™æ„å‘³ä½ åªèƒ½æ‹¿åˆ°å½“å‰çš„ Goroutine çš„ IDï¼Œä½†æ˜¯ä¸èƒ½æ­£ç¡®æ‹¿åˆ°ç³»ç»Ÿä¸­æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ GoId åˆ—è¡¨ã€‚ ä½ åªèƒ½èŽ·å–ä½ å†™çš„ä»£ç ç”Ÿæˆçš„ Goroutine IDï¼Œä½†æ˜¯é€šå¸¸ä½ ä¸èƒ½ç¡®ä¿æ‰€æœ‰çš„æ ‡å‡†åº“ä»¥åŠç¬¬ä¸‰æ–¹ä»£ç åº“éƒ½åšäº†è¿™äº›å·¥ä½œã€‚ è¿™æ ·å°±å¾ˆéš¾å¯¹é«˜å¹¶å‘æ—¥å¿—è¿›è¡ŒæŸ¥çœ‹å’Œè¿‡æ»¤ã€‚å°½ç®¡åœ¨æ—¥å¿—ä¸­å¯ä»¥ä½¿ç”¨ä¸šåŠ¡æœ¬èº«çš„ ID ï¼Œä½†æ˜¯åœ¨å¾ˆå¤šå‡½æ•°ä¸­ä»…ä»…ä¸ºäº†æ‰“å°è€Œå¢žåŠ ä¸€äº›å‚æ•° ID ä¼šè®©ä»£ç çœ‹èµ·æ¥æ²¡æœ‰é‚£ä¹ˆä¼˜é›…ã€‚ å¯ä»¥åˆ° https://golang.org/doc/faq#no_Goroutine_id ä¸­çœ‹åˆ°å®˜æ–¹å¯¹è¿™ä¸ªé—®é¢˜çš„è¯¦ç»†è§£é‡Šï¼ŒåŽŸæ–‡ä¸é•¿æ‰€ä»¥æ”¾åœ¨æ–‡ç« é‡Œã€‚ Why is there no Goroutine ID?Goroutines do not have names; they are just anonymous workers. They expose no unique identifier, name, or data structure to the programmer. Some people are surprised by this, expecting the go statement to return some item that can be used to access and control the Goroutine later. The fundamental reason Goroutines are anonymous is so that the full Go language is available when programming concurrent code. By contrast, the usage patterns that develop when threads and Goroutines are named can restrict what a library using them can do. Here is an illustration of the difficulties. Once one names a Goroutine and constructs a model around it, it becomes special, and one is tempted to associate all computation with that Goroutine, ignoring the possibility of using multiple, possibly shared Goroutines for the processing. If the net/http package associated per-request state with a Goroutine, clients would be unable to use more Goroutines when serving a request. Moreover, experience with libraries such as those for graphics systems that require all processing to occur on the â€œmain threadâ€ has shown how awkward and limiting the approach can be when deployed in a concurrent language. The very existence of a special thread or Goroutine forces the programmer to distort the program to avoid crashes and other problems caused by inadvertently operating on the wrong thread. For those cases where a particular Goroutine is truly special, the language provides features such as channels that can be used in flexible ways to interact with it.]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go team å…³äºŽå¦‚ä½•ä¿æŒ Go Modules å…¼å®¹æ€§çš„ä¸€äº›å®žè·µ]]></title>
    <url>%2F2020%2F08%2F13%2FGo-team-%E5%85%B3%E4%BA%8E%E5%A6%82%E4%BD%95%E4%BF%9D%E6%8C%81-Go-Modules-%E5%85%BC%E5%AE%B9%E6%80%A7%E7%9A%84%E4%B8%80%E4%BA%9B%E5%AE%9E%E8%B7%B5%2F</url>
    <content type="text"><![CDATA[è¿‘æ—¥ï¼ŒGo team åœ¨å…¶å®˜æ–¹ blog ä¸Šè®¨è®ºäº†å¦‚ä½•è®©ä½ çš„ Go Modules ä¿æŒå…¼å®¹æ€§çš„è¯é¢˜ï¼Œå¹¶ç»™å‡ºäº†ä¸€äº›å»ºè®®ï¼Œè¿™äº›å»ºè®®éƒ½æ˜¯è¯¥å›¢é˜Ÿåœ¨å®žé™…å¼€å‘ä¸­ä¸æ–­è¸©å‘æ€»ç»“å‡ºæ¥çš„ç²¾åŽï¼Œå¯ä»¥è¯´æ˜¯æœ€ä½³å®žè·µã€‚æˆ‘ä»¬ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šï¼Œå¯ä»¥å†™å‡ºæ›´ä¼˜é›…ï¼Œæ›´å…·æœ‰å…¼å®¹æ€§çš„ä»£ç ï¼Œä¸‹é¢è®©æˆ‘ä»¬æ·±å…¥é€æ¡è§£è¯»è¿™äº›å»ºè®®ã€‚ éšç€æ–°åŠŸèƒ½çš„æ·»åŠ ï¼Œæˆ–è€…é‡æž„ Go Module çš„æŸäº›å…¬å…±éƒ¨åˆ†ï¼ŒGo Module å°†éšç€æ—¶é—´çš„æŽ¨ç§»è€Œä¸æ–­å‘ç”Ÿå˜åŒ–ã€‚ ä½†æ˜¯ï¼Œå‘å¸ƒæ–°çš„ Go Module ç‰ˆæœ¬å¯¹ä½¿ç”¨è€…æ¥æ˜¯ä¸€ä¸ªå™©è€—ã€‚ ä»–ä»¬å¿…é¡»æ‰¾åˆ°æ–°ç‰ˆæœ¬ï¼Œå­¦ä¹ æ–°çš„APIï¼Œå¹¶æ›´æ”¹å…¶ä»£ç ã€‚ è€Œä¸”æŸäº›ç”¨æˆ·å¯èƒ½æ°¸è¿œä¸ä¼šæ›´æ–°ï¼Œè¿™æ„å‘³ç€æ‚¨å¿…é¡»æ°¸è¿œä¸ºä»£ç ç»´æŠ¤ä¸¤ä¸ªç‰ˆæœ¬ã€‚ å› æ­¤ï¼Œé€šå¸¸æœ€å¥½ä»¥å…¼å®¹çš„æ–¹å¼æ›´æ”¹çŽ°æœ‰çš„ Go Moduleã€‚ åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å°†æŽ¢è®¨ä¸€äº›ä»£ç æŠ€å·§ï¼Œèƒ½å¤Ÿè®©ä½ ä¿æŒ Go Module çš„å…¼å®¹æ€§ã€‚ æ ¸å¿ƒçš„æ€æƒ³å°±æ˜¯æ˜¯ï¼šæ·»åŠ ï¼Œä½†æ˜¯ä¸è¦æ›´æ”¹æˆ–åˆ é™¤ä½ çš„ Go Module ä»£ç ã€‚ æˆ‘ä»¬è¿˜å°†ä»Žå®è§‚è§’åº¦è®¨è®ºå¦‚ä½•è®¾è®¡å…·å¤‡é«˜åº¦å…¼å®¹æ€§çš„ API ã€‚ æ–°å¢žå‡½æ•°é€šå¸¸æ¥è¯´ï¼Œæ”¹å˜å‡½æ•°çš„å½¢å‚æ˜¯ç ´åä»£ç å…¼å®¹æ€§æœ€å¸¸è§çš„æƒ…å†µã€‚æˆ‘ä»¬è®²è¿‡è®¨è®ºå‡ ä¸ªè§£å†³è¿™ç§é—®é¢˜çš„æ–¹å¼ï¼Œä½†è®©æˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸ªä¸å¥½çš„å®žè·µã€‚ æœ‰è¿™ä¹ˆä¸€ä¸ªå‡½æ•°ï¼š 1func Run(name string) å½“æˆ‘ä»¬å‡ºäºŽæŸä¸ªæƒ…å†µè¦æ‰©å±•è¿™ä¸ªå‡½æ•°ï¼Œä¸ºè¿™ä¸ªå‡½æ•°æ·»åŠ ä¸€ä¸ªå½¢å‚ size ï¼š 1func Run(name string, size ...int) å‡å¦‚ä½ åœ¨å…¶ä»–ä»£ç ä¸­ï¼Œæˆ–è€… Go Module çš„ä½¿ç”¨è€…æ›´æ–°äº†ï¼Œé‚£ä¹ˆåƒä¸‹é¢çš„ä»£ç å°±ä¼šå‡ºçŽ°é—®é¢˜ï¼š 12package mypkgvar runner func(string) = yourpkg.Run åŽŸæ¥çš„ Run å‡½æ•°çš„ç±»åž‹æ˜¯ func(string)ï¼Œä½†æ˜¯æ–°çš„ Run å‡½æ•°çš„ç±»åž‹å˜æˆäº† func(string, ...int)ï¼Œæ‰€ä»¥åœ¨ç¼–è¯‘é˜¶æ®µå°±ä¼šæŠ¥é”™ã€‚å¿…é¡»è¦æ ¹æ®æ–°çš„å‡½æ•°ç±»åž‹ä¿®æ”¹è°ƒç”¨æ–¹å¼ï¼Œè¿™ç»™ä½¿ç”¨ Go Module çš„å¼€å‘è€…é€ æˆå¾ˆå¤šä¸ä¾¿ï¼Œç”šè‡³å‡ºçŽ° bugã€‚ é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æ–°å¢žä¸€ä¸ªå‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸æ˜¯ä¿®æ”¹å‡½æ•°ç­¾åã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œcontext åŒ…æ˜¯ Golang 1.17 ç‰ˆæœ¬ä¹‹åŽæ‰å¼•å…¥çš„ï¼Œé€šå¸¸ ctx ä¼šåšä¸ºå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¼ å…¥ã€‚ä½†æ˜¯çŽ°æœ‰çš„å·²ç»å¾ˆç¨³å®šçš„ API çš„å¯å¯¼å‡ºå‡½æ•°ä¸å¯èƒ½åŽ»ä¿®æ”¹å‡½æ•°ç­¾åï¼Œåœ¨å…¶å‡½æ•°ç¬¬ä¸€ä¸ªå…¥å‚æ·»åŠ  context.Contextï¼Œè¿™æ ·ä¼šå½±å“æ‰€æœ‰å‡½æ•°è°ƒç”¨æ–¹ï¼Œå°¤å…¶åœ¨ä¸€äº›åº•å±‚ä»£ç åº“ä¸­ï¼Œè¿™æ˜¯éžå¸¸å±é™©çš„æ“ä½œã€‚ Go team ä½¿ç”¨æ–°å¢žå‡½æ•° çš„æ–¹æ³•è§£å†³äº†è¿™ä¸ªé—®é¢˜ã€‚ä¸¾ä¸ªæ —å­ï¼Œdatabase/sql è¿™ä¸ª package çš„ Query æ–¹æ³•çš„ç­¾åä¸€ç›´æ˜¯: 1func (db *DB) Query(query string, args ...interface&#123;&#125;) (*Rows, error) å½“ context package å¼•å…¥çš„æ—¶å€™ï¼ŒGo team æ–°å¢žäº†è¿™æ ·ä¸€ä¸ªå‡½æ•°ï¼š 1func (db *DB) QueryContext(ctx context.Context, query string, args ...interface&#123;&#125;) (*Rows, error) å¹¶ä¸”åªä¿®æ”¹äº†ä¸€å¤„ä»£ç ï¼š 123func (db *DB) Query(query string, args ...interface&#123;&#125;) (*Rows, error) &#123; return db.QueryContext(context.Background(), query, args...)&#125; é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒGo team èƒ½å¤Ÿåœ¨å¹³æ»‘åœ°å‡çº§ä¸€ä¸ª package çš„åŒæ—¶ä¸å¯¹ä»£ç çš„å¯è¯»æ€§ã€å…¼å®¹æ€§é€ æˆå½±å“ã€‚ç±»ä¼¼çš„ä»£ç åœ¨ golang æºç ä¸­éšå¤„å¯è§ã€‚ å¯é€‰å‚æ•°ï¼ˆoptional argumentsï¼‰å¦‚æžœä½ åœ¨å®žçŽ° package ä¹‹å‰å°±ç¡®å®šè¿™ä¸ªå‡½æ•°åŽé¢å¯èƒ½ä¼šéœ€è¦æ·»åŠ å‚æ•°æ¥æ‰©å±•æŸäº›åŠŸèƒ½ï¼Œé‚£ä¹ˆä½ å¯ä»¥æå‰åœ¨å‡½æ•°ç­¾åæ˜¯ä½¿ç”¨å¯é€‰å‚æ•°ï¼ˆoptional argumentsï¼‰ã€‚æœ€ç®€å•çš„æ–¹æ³•æ˜¯åœ¨å‡½æ•°ç­¾åä¸­ä½¿ç”¨ç»“æž„ä½“å‚æ•°ï¼Œä¸‹é¢æ˜¯ golang æºç ä¸­ crypto/tls.Dial çš„ä¸€æ®µä»£ç ï¼š 1func Dial(network, addr string, config *Config) (*Conn, error) Dial å‡½æ•°å®žçŽ° TLS çš„æ¡æ‰‹æ“ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­éœ€è¦å…¶ä»–å¾ˆå¤šå‚æ•°ï¼ŒåŒæ—¶è¿˜æ”¯æŒé»˜è®¤å€¼ã€‚å½“ç»™ config ä¼ é€’ nil çš„æ—¶å€™å°±æ˜¯ä½¿ç”¨é»˜è®¤å€¼ï¼›å½“ä¼ é€’ Config struct çš„æ—¶å€™å°†ä¼šè¦†ç›–é»˜è®¤å€¼ã€‚å‡å¦‚ä»¥åŽå‡ºçŽ°äº†æ–°çš„ TLS é…ç½®å‚æ•°ï¼Œå¯ä»¥å¾ˆè½»æ¾åœ°é€šè¿‡åœ¨ Config struct ä¸­æ·»åŠ æ–°å­—æ®µæ¥å®žçŽ°ï¼Œè¿™ç§æ–¹å¼æ˜¯å‘åŽå…¼å®¹çš„ã€‚ æœ‰äº›æƒ…å†µä¸‹ï¼Œæ–°å¢žå‡½æ•°å’Œä½¿ç”¨å¯é€‰å‚æ•°çš„æ–¹å¼å¯ä»¥ç»“åˆèµ·æ¥ï¼Œé€šè¿‡æŠŠå¯é€‰å‚æ•°çš„ç»“æž„ä½“å˜æˆä¸€ä¸ªæ–¹æ³•çš„æŽ¥æ”¶è€…(receiver)ã€‚æ¯”å¦‚ï¼Œåœ¨ Go 1.11 ä¹‹å‰ï¼Œnet package ä¸­çš„Listen æ–¹æ³•çš„ç­¾åæ˜¯ï¼š 1func Listen(network, address string) (Listener, error) ä½†æ˜¯åœ¨ Go 1.11 ä¸­ï¼ŒGo team æ–°å¢žåŠ äº†ä¸¤ä¸ª feature : ä¼ é€’äº† context å‚æ•°ï¼› å¢žåŠ äº† control functionï¼Œå…è®¸è°ƒç”¨è€…åœ¨ç½‘ç»œè¿žæŽ¥è¿˜æ²¡æœ‰ bind çš„æ—¶å€™è°ƒæ•´åŽŸå§‹è¿žæŽ¥çš„å‚æ•°ã€‚ è¿™çœ‹èµ·æ¥æ˜¯ç›¸å½“å¤§çš„è°ƒæ•´äº†ï¼Œå¦‚æžœæ˜¯ä¸€èˆ¬å¼€å‘è€…ï¼Œæœ€å¤šä¹Ÿå°±ä¼šæ–°å¢žä¸€ä¸ªå‡½æ•°ï¼Œå‚æ•°ä¸­æ·»åŠ  context, control functionã€‚ä½†æ˜¯ Go team çš„å¼€å‘è€…éžç­‰é—²ä¹‹è¾ˆï¼Œnet package çš„ä½œè€…æƒ³åˆ°æœªæ¥çš„æŸä¸€å¤©è¿™ä¸ªå‡½æ•°æ˜¯ä¸æ˜¯ä¼šæœ‰è°ƒæ•´ï¼Œæˆ–è€…éœ€è¦æ›´å¤šçš„å‚æ•°ï¼ŸäºŽæ˜¯å°±é¢„ç•™äº†ä¸€ä¸ª ListenConfig çš„ç»“æž„ä½“ï¼Œä¸ºè¿™ä¸ª strcut å®žçŽ°äº† Listen æ–¹æ³•ï¼Œä»Žè€Œä¹Ÿä¸ç”¨å†æ–°å¢žä¸€ä¸ªå‡½æ•°æ‰èƒ½è§£å†³é—®é¢˜ã€‚ 12345type ListenConfig struct &#123; Control func(network, address string, c syscall.RawConn) error&#125;func (*ListenConfig) Listen(ctx context.Context, network, address string) (Listener, error) è¿˜æœ‰ä¸€ç§å«åšå¯é€‰ç±»åž‹çš„è®¾è®¡æ¨¡å¼ï¼Œæ˜¯æŠŠå¯é€‰çš„å‡½æ•°ä½œä¸ºå‡½æ•°å½¢å‚ï¼Œæ¯ä¸€ä¸ªå¯é€‰å‡½æ•°éƒ½å¯ä»¥é€šè¿‡å‚æ•°æ¥è°ƒæ•´å…¶çŠ¶æ€ã€‚åœ¨ Rob Pike çš„ blog (https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html) é‡Œå¯¹è¿™ç§æ¨¡å¼è¿›è¡Œäº†è¯¦ç»†çš„è§£è¯»ã€‚è¿™ç§è®¾è®¡æ¨¡å¼åœ¨ grpc çš„æºç ä¸­å¤§é‡ä½¿ç”¨ã€‚ option types ä¸Žå‡½æ•°å‚æ•°ä¸­çš„ option structå…·æœ‰ç›¸åŒçš„ä½œç”¨ï¼šå®ƒä»¬æ˜¯ä¼ é€’è¡Œä¸ºï¼Œä¿®æ”¹é…ç½®çš„å¯æ‰©å±•æ–¹å¼ã€‚ å†³å®šé€‰æ‹©å“ªä¸ªå¾ˆå¤§ç¨‹åº¦ä¸Šå–å†³äºŽå…·ä½“åœºæ™¯ã€‚ æ¥çœ‹ä¸€ä¸‹ gRPC çš„ DialOption é€‰é¡¹ç±»åž‹çš„ç”¨æ³•ï¼š 1234grpc.Dial("some-target", grpc.WithAuthority("some-authority"), grpc.WithMaxDelay(time.Second), grpc.WithBlock()) å½“ç„¶ä½ ä¹Ÿå¯ä»¥ä½œä¸º struct é€‰é¡¹å®žçŽ°ï¼š 12345notgrpc.Dial("some-target", &amp;notgrpc.Options&#123; Authority: "some-authority", MaxDelay: time.Minute, Block: true,&#125;) ä»¥ä¸Šï¼Œä»»ä¸€ç§æ–¹å¼éƒ½æ˜¯èƒ½å¤Ÿç»´æŒ Go Module å…¼å®¹æ€§çš„æ–¹æ³•ï¼Œå¯ä»¥æ ¹æ®ä¸åŒçš„åœºæ™¯é€‰æ‹©åˆç†çš„å®žçŽ°ã€‚ ä¿è¯ interfaces çš„å…¼å®¹æ€§æœ‰æ—¶å€™ï¼Œæ–°ç‰¹æ€§çš„æ”¯æŒéœ€è¦æ›´æ”¹å¯¹å¤–æš´éœ²çš„ï¼ˆpublicï¼‰çš„æŽ¥å£: éœ€è¦ä½¿ç”¨æ–°çš„æ–¹æ³•æ¥æ‰©å±•æŽ¥å£ã€‚ç›´æŽ¥å‘æŽ¥å£æ·»åŠ æ–¹æ³•æ˜¯ä¸åˆé€‚çš„ï¼Œè¿™ä¼šå¯¼è‡´æŽ¥å£çš„å®žçŽ°æ–¹éƒ½éœ€è¦ä¿®æ”¹ä»£ç ã€‚é‚£ä¹ˆï¼Œæˆ‘ä»¬å¦‚ä½•æ‰èƒ½åœ¨å…¬å¼€çš„æŽ¥å£ä¸Šæ”¯æŒæ–°æ–¹æ³•å‘¢ï¼Ÿ Go team ç»™å‡ºçš„å»ºè®®æ˜¯ï¼šä½¿ç”¨æ–°æ–¹æ³•å®šä¹‰ä¸€ä¸ªæ–°æŽ¥å£ï¼Œç„¶åŽåœ¨ä½¿ç”¨æ—§æŽ¥å£çš„ä»»ä½•åœ°æ–¹åŠ¨æ€æ£€æŸ¥æä¾›çš„ç±»åž‹æ˜¯æ—§ç±»åž‹è¿˜æ˜¯æ–°ç±»åž‹ã€‚ è®©æˆ‘ä»¬ä»¥ golang æºç ä¸­ archive/tar package æ¥è¯¦ç»†è¯´æ˜Žä¸€ä¸‹ã€‚ tar.NewReader ä»¥ io.Reader ä½œä¸ºå‚æ•°ï¼Œä½†æ˜¯åŽæ¥ Go team è§‰å¾—åº”è¯¥æä¾›ä¸€ç§æ›´åŠ é«˜æ•ˆçš„æ–¹å¼ï¼Œå°±æ˜¯å½“è°ƒç”¨ Seek æ–¹æ³•çš„æ—¶å€™å¯ä»¥è·³è¿‡ä¸€ä¸ªæ–‡ä»¶çš„ headerã€‚ä½†æ˜¯åˆä¸èƒ½ç›´æŽ¥åœ¨ io.Reader ä¸­æ–°å¢ž Seek æ–¹æ³•ï¼Œè¿™ä¼šå½±å“æ‰€æœ‰å®žçŽ°äº† io.Reader çš„æ–¹æ³•ï¼ˆå¦‚æžœä½ æœ‰çœ‹è¿‡ golang æºç ï¼Œå°±ä¼šçŸ¥é“ io.Reader æŽ¥å£çš„åº”ç”¨æœ‰å¤šå¹¿æ³›äº†ï¼‰ã€‚ å¦å¤–ä¸€ç§æ–¹æ³•æ˜¯å°† tar.NeaReader çš„å…¥å‚æ”¹æˆ io.ReaderSeeker interfaceï¼Œå› ä¸ºè¯¥ interface åŒæ—¶æ”¯æŒ io.Reader å’Œ Seek ã€‚ä½†æ˜¯æ­£å¦‚å‰é¢æ‰€è®²ï¼Œæ”¹å˜ä¸€ä¸ªå‡½æ•°çš„ç­¾åï¼Œä¸æ˜¯ä¸€ç§å¥½çš„æ–¹å¼ã€‚ æ‰€ä»¥ Go team å†³å®šç»´æŒ tar.NewReader çš„ç­¾åä¸å˜ï¼Œåœ¨ Read æ–¹æ³•ä¸­è¿›è¡Œç±»åž‹æ£€æŸ¥ï¼š 12345678910111213141516package tartype Reader struct &#123; r io.Reader&#125;func NewReader(r io.Reader) *Reader &#123; return &amp;Reader&#123;r: r&#125;&#125;func (r *Reader) Read(b []byte) (int, error) &#123; if rs, ok := r.r.(io.Seeker); ok &#123; // Use more efficient rs.Seek. &#125; // Use less efficient r.r.Read.&#125; å¦‚æžœé‡åˆ°è¦å‘çŽ°æœ‰æŽ¥å£æ·»åŠ æ–¹æ³•çš„æƒ…å†µï¼Œåˆ™å¯ä»¥éµå¾ªæ­¤ç­–ç•¥ã€‚ é¦–å…ˆä½¿ç”¨æ–°æ–¹æ³•åˆ›å»ºæ–°æŽ¥å£ï¼Œæˆ–è€…ä½¿ç”¨æ–°æ–¹æ³•æ ‡è¯†çŽ°æœ‰æŽ¥å£ã€‚ æŽ¥ä¸‹æ¥ï¼Œç¡®å®šéœ€è¦æ·»åŠ çš„ç›¸å…³ä»£ç å•Šï¼Œå¯¹ç¬¬äºŒä¸ªæŽ¥å£è¿›è¡Œç±»åž‹æ£€æŸ¥ï¼Œå¹¶æ·»åŠ ä½¿ç”¨å®ƒçš„ä»£ç ã€‚ åœ¨å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œæœ€å¥½é¿å…è¿™ç§é—®é¢˜ã€‚ ä¾‹å¦‚ï¼Œåœ¨è®¾è®¡æž„é€ å‡½æ•°æ—¶ï¼Œæœ€å¥½è¿”å›žå…·ä½“ç±»åž‹ã€‚ ä¸ŽæŽ¥å£ä¸åŒï¼Œä½¿ç”¨å…·ä½“ç±»åž‹å¯ä»¥è®©ä½ å°†æ¥åœ¨ä¸ä¸­æ–­ç”¨æˆ·ä½¿ç”¨çš„æƒ…å†µä¸‹æ·»åŠ æ–°æ–¹æ³•ï¼ŒåŒæ—¶å°†æ¥å¯ä»¥æ›´è½»æ¾åœ°æ‰©å±•ä½ çš„ Go Moduleã€‚ Tip: å¦‚æžœä½ ç”¨åˆ°äº†ä¸€ä¸ª interfaceï¼Œä½†æ˜¯ä½ ä¸æƒ³ç”¨æˆ·åŽ»å®žçŽ°å®ƒï¼Œä½ å¯ä»¥ä¸º interface æ·»åŠ  unexported çš„æ–¹æ³•ã€‚ 1234567891011type TB interface &#123; Error(args ...interface&#123;&#125;) Errorf(format string, args ...interface&#123;&#125;) // ... // A private method to prevent users implementing the // interface and so future additions to it will not // violate Go 1 compatibility.// private é¿å…ç”¨æˆ·åŽ»å®žçŽ°å®ƒ private()&#125; æ–°å¢žé…ç½®æ–¹æ³•åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬è®¨è®ºäº†ä¿®æ”¹å‡½æ•°ç­¾åæˆ–è€…ä¸º interface æ·»åŠ æ–¹æ³•ï¼Œä¼šå½±å“åˆ°ç”¨æˆ·çš„ä»£ç å¯¼è‡´ç¼–è¯‘å¤±è´¥ã€‚å®žé™…ä¸Šï¼Œå‡½æ•°è¡Œä¸ºçš„æ”¹å˜ä¼šé€ æˆåŒæ ·çš„é—®é¢˜ã€‚ä¾‹å¦‚ï¼Œå¾ˆå¤šå¼€å‘è€…å¸Œæœ› json.Decoder å¯ä»¥å¿½ç•¥ struct ä¸­æ²¡æœ‰çš„ json å­—æ®µã€‚ä½†æ˜¯å½“ Go team æƒ³è¦åœ¨è¿™ç§æƒ…å†µä¸‹è¿”å›žä¸€äº›é”™è¯¯çš„æ—¶å€™ï¼Œå°±å¿…é¡»è¦å°å¿ƒï¼Œå› ä¸ºè¿™æ ·åšä¼šå¯¼è‡´å¾ˆå¤šä½¿ç”¨è¯¥æ–¹æ³•çš„ç”¨æˆ·çªç„¶æ”¶åˆ°ä»¥å‰ä»Žæœªé‡åˆ°çš„é”™è¯¯ã€‚ å› æ­¤ï¼Œä»–ä»¬æ²¡æœ‰æ›´æ”¹æ‰€æœ‰ç”¨æˆ·çš„è¡Œä¸ºï¼Œè€Œæ˜¯å‘Decoderç»“æž„æ·»åŠ äº†ä¸€ç§é…ç½®æ–¹æ³•ï¼šDecoder.DisallowUnknownFields ã€‚ è°ƒç”¨æ­¤æ–¹æ³•ä¼šä½¿ç”¨æˆ·é€‰æ‹©æ–°è¡Œä¸ºï¼ŒåŒæ—¶ä¼šä¸ºçŽ°æœ‰ç”¨æˆ·ä¿ç•™æ—§çš„æ–¹æ³•ã€‚ ä¿æŒ struct çš„å…¼å®¹æ€§é€šè¿‡ä¸Šé¢çš„å†…å®¹æˆ‘ä»¬äº†è§£åˆ°ï¼Œå¯¹å‡½æ•°ç­¾åçš„ä»»ä½•æ›´æ”¹éƒ½æ˜¯ä¸€ç§ç ´åæ€§çš„æ”¹åŠ¨ã€‚ ä½†æ˜¯å¦‚æžœä½¿ç”¨ struct å°±ä¼šè®©ä½ çš„ä»£ç çµæ´»å¾ˆå¤šï¼Œ å¦‚æžœå…·æœ‰å¯å¯¼å‡ºçš„ç»“æž„ä½“ç±»åž‹ï¼Œåˆ™å‡ ä¹Žå¯ä»¥éšæ—¶æ·»åŠ ä¸€ä¸ªå­—æ®µæˆ–åˆ é™¤ä¸€ä¸ªæœªå¯¼å‡ºçš„å­—æ®µè€Œä¸ä¼šç ´åå…¼å®¹æ€§ã€‚ æ·»åŠ å­—æ®µæ—¶ï¼Œè¯·ç¡®ä¿å…¶é›¶å€¼æœ‰æ„ä¹‰å¹¶ä¿ç•™æ—§çš„è¡Œä¸ºï¼Œä»¥ä¾¿æœªè®¾ç½®è¯¥å­—æ®µçš„çŽ°æœ‰ä»£ç ç»§ç»­èµ·ä½œç”¨ã€‚ è¿˜è®°å¾—ä¸Šé¢è®²åˆ°çš„ net package çš„ä½œè€…åœ¨ Go 1.11 çš„æ—¶å€™æ·»åŠ çš„ ListenConfig struct å—ï¼Ÿäº‹å®žè¯æ˜Žä»–çš„è®¾è®¡æ˜¯å¯¹çš„ã€‚åœ¨ Go 1.13 ä¸­ï¼Œæ–°å¢žäº† KeepAlive å­—æ®µï¼Œå…è®¸å–æ¶ˆæˆ–ä½¿ç”¨ keep-alive çš„åŠŸèƒ½ã€‚æœ‰äº†ä¹‹å‰çš„è®¾è®¡ï¼Œè¿™ä¸ªå­—æ®µçš„åŠ å…¥å°±å®¹æ˜“å¤šäº†ã€‚ å…³äºŽ struct çš„ä½¿ç”¨ï¼Œæœ‰ä¸€ä¸ªç»†èŠ‚å¦‚æžœä½ æ²¡æœ‰æ³¨æ„åˆ°çš„è¯ï¼Œä¹Ÿä¼šå¯¹ç”¨æˆ·é€ æˆå¾ˆå¤§çš„å½±å“ã€‚å¦‚æžœ struct ä¸­æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯å¯åˆ¤ç­‰çš„ï¼ˆæ„æ€æ˜¯å¯ç”¨é€šè¿‡ == or !=æ¥æ¯”è¾ƒï¼Œæˆ–è€…å¯ä»¥ä½œä¸º map çš„ keyï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ª struct å°±æ˜¯å¯åˆ¤ç­‰çš„ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æžœä½ ä¸º struct æ·»åŠ äº†ä¸€ä¸ªä¸å¯åˆ¤ç­‰çš„ç±»åž‹ï¼Œå°†ä¼šå¯¼è‡´è¿™ä¸ª struct ä¹Ÿå˜æˆä¸å¯åˆ¤ç­‰çš„ã€‚å¦‚æžœç”¨æˆ·åœ¨ä»£ç ä¸­ä½¿ç”¨äº†ä½ çš„ struct è¿›è¡Œåˆ¤ç­‰æ“ä½œï¼Œé‚£ä¹ˆå°±ä¼šé‡åˆ°ä»£ç é”™è¯¯ã€‚ å¦‚æžœä½ è¦ä¿æŒç»“æž„ä½“å¯åˆ¤ç­‰ï¼Œå°±ä¸è¦å‘å…¶æ·»åŠ ä¸å¯æ¯”è¾ƒçš„å­—æ®µã€‚å¯ä»¥ä¸ºæ­¤ç¼–å†™æµ‹è¯•ç”¨ä¾‹æ¥é¿å…é—å¿˜ã€‚ Conclusionä»Žå¤´å¼€å§‹è§„åˆ’ API çš„æ—¶å€™ï¼Œè¯·ä»”ç»†è€ƒè™‘ API åœ¨å°†æ¥çš„å¯æ‰©å±•æ€§ã€‚ è€Œä¸”å½“ä½ ç¡®å®žéœ€è¦æ·»åŠ æ–°åŠŸèƒ½æ—¶ï¼Œè¯·è®°ä½ä»¥ä¸‹è§„åˆ™ï¼šæ·»åŠ ï¼Œä¸è¦æ›´æ”¹æˆ–åˆ é™¤ã€‚è¯·ç‰¢è®°ï¼Œæ·»åŠ æŽ¥å£æ–¹æ³•ï¼Œå‡½æ•°å‚æ•°å’Œè¿”å›žå€¼éƒ½ä¼šå¯¼è‡´ Go Module ä¸èƒ½å‘åŽå…¼å®¹ã€‚ å¦‚æžœä½ ç¡®å®žéœ€è¦å¤§è§„æ¨¡æ›´æ”¹ APIï¼Œæˆ–è€…è¦æ·»åŠ æ›´å¤šæ–°ç‰¹æ€§ï¼Œé‚£ä¹ˆä½¿ç”¨æ–°çš„ API ç‰ˆæœ¬ä¼šæ˜¯æ›´å¥½çš„æ–¹å¼ã€‚ ä½†æ˜¯å¤§å¤šæ•°æ—¶å€™ï¼Œè¿›è¡Œå‘åŽå…¼å®¹çš„æ›´æ”¹åº”è¯¥æ˜¯ä½ çš„é¦–é€‰ï¼Œèƒ½å¤Ÿé¿å…ç»™ç”¨æˆ·å¸¦æ¥éº»çƒ¦ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[lxcfs å®žçŽ°å®¹å™¨èµ„æºè§†å›¾éš”ç¦»çš„æœ€ä½³å®žè·µ]]></title>
    <url>%2F2020%2F07%2F04%2Flxcfs-%E5%AE%9E%E7%8E%B0%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E8%A7%86%E5%9B%BE%E9%9A%94%E7%A6%BB%E7%9A%84%E6%9C%80%E4%BD%B3%E6%97%B6%E9%97%B4%2F</url>
    <content type="text"><![CDATA[LXCFS is a small FUSE filesystem written with the intention of making Linux containers feel more like a virtual machine. It started as a side-project of LXC but is useable by any runtime. ç”¨äººè¯è§£é‡Šä¸€ä¸‹å°±æ˜¯ï¼š xcfs æ˜¯ä¸€ä¸ªå¼€æºçš„ FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰å®žçŽ°æ¥æ”¯æŒ LXC å®¹å™¨ï¼Œå®ƒä¹Ÿå¯ä»¥æ”¯æŒ Docker å®¹å™¨ã€‚è®©å®¹å™¨å†…çš„åº”ç”¨åœ¨è¯»å–å†…å­˜å’Œ CPU ä¿¡æ¯çš„æ—¶å€™é€šè¿‡ lxcfs çš„æ˜ å°„ï¼Œè½¬åˆ°è‡ªå·±çš„é€šè¿‡å¯¹ cgroup ä¸­å®¹å™¨ç›¸å…³å®šä¹‰ä¿¡æ¯è¯»å–çš„è™šæ‹Ÿæ•°æ®ä¸Šã€‚ ä»€ä¹ˆæ˜¯èµ„æºè§†å›¾éš”ç¦»ï¼Ÿå®¹å™¨æŠ€æœ¯æä¾›äº†ä¸åŒäºŽä¼ ç»Ÿè™šæ‹ŸæœºæŠ€æœ¯çš„çŽ¯å¢ƒéš”ç¦»æ–¹å¼ã€‚é€šå¸¸çš„Linuxå®¹å™¨å¯¹å®¹å™¨æ‰“åŒ…å’Œå¯åŠ¨è¿›è¡Œäº†åŠ é€Ÿï¼Œä½†ä¹Ÿé™ä½Žäº†å®¹å™¨çš„éš”ç¦»å¼ºåº¦ã€‚å…¶ä¸­Linuxå®¹å™¨æœ€ä¸ºçŸ¥åçš„é—®é¢˜å°±æ˜¯èµ„æºè§†å›¾éš”ç¦»é—®é¢˜ã€‚ å®¹å™¨å¯ä»¥é€šè¿‡ cgroup çš„æ–¹å¼å¯¹èµ„æºçš„ä½¿ç”¨æƒ…å†µè¿›è¡Œé™åˆ¶ï¼ŒåŒ…æ‹¬: å†…å­˜ï¼ŒCPU ç­‰ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æžœå®¹å™¨å†…çš„ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ä¸€äº›å¸¸ç”¨çš„ç›‘æŽ§å‘½ä»¤ï¼Œå¦‚: free, top ç­‰å‘½ä»¤å…¶å®žçœ‹åˆ°è¿˜æ˜¯ç‰©ç†æœºçš„æ•°æ®ï¼Œè€Œéžå®¹å™¨çš„æ•°æ®ã€‚è¿™æ˜¯ç”±äºŽå®¹å™¨å¹¶æ²¡æœ‰åšåˆ°å¯¹ /proc, /sys ç­‰æ–‡ä»¶ç³»ç»Ÿçš„èµ„æºè§†å›¾éš”ç¦»ã€‚ ä¸ºä»€ä¹ˆè¦åšå®¹å™¨çš„èµ„æºè§†å›¾éš”ç¦»ï¼Ÿ ä»Žå®¹å™¨çš„è§†è§’æ¥çœ‹ï¼Œé€šå¸¸æœ‰ä¸€äº›ä¸šåŠ¡å¼€å‘è€…å·²ç»ä¹ æƒ¯äº†åœ¨ä¼ ç»Ÿçš„ç‰©ç†æœºï¼Œè™šæ‹Ÿæœºä¸Šä½¿ç”¨ top, free` ç­‰å‘½ä»¤æ¥æŸ¥çœ‹ç³»ç»Ÿçš„èµ„æºä½¿ç”¨æƒ…å†µï¼Œä½†æ˜¯å®¹å™¨æ²¡æœ‰åšåˆ°èµ„æºè§†å›¾éš”ç¦»ï¼Œé‚£ä¹ˆåœ¨å®¹å™¨é‡Œé¢çœ‹åˆ°çš„æ•°æ®è¿˜æ˜¯ç‰©ç†æœºçš„æ•°æ®ã€‚ ä»Žåº”ç”¨ç¨‹åºçš„è§†è§’æ¥çœ‹ï¼Œåœ¨å®¹å™¨é‡Œé¢è¿è¡Œè¿›ç¨‹å’Œåœ¨ç‰©ç†æœºè™šæ‹Ÿæœºä¸Šè¿è¡Œè¿›ç¨‹çš„è¿è¡ŒçŽ¯å¢ƒæ˜¯ä¸åŒçš„ã€‚å¹¶ä¸”æœ‰äº›åº”ç”¨åœ¨å®¹å™¨é‡Œé¢è¿è¡Œè¿›ç¨‹ä¼šå­˜åœ¨ä¸€äº›å®‰å…¨éšæ‚£: å¯¹äºŽå¾ˆå¤šåŸºäºŽ JVM çš„ java ç¨‹åºï¼Œåº”ç”¨å¯åŠ¨æ—¶ä¼šæ ¹æ®ç³»ç»Ÿçš„èµ„æºä¸Šé™æ¥åˆ†é… JVM çš„å †å’Œæ ˆçš„å¤§å°ã€‚è€Œåœ¨å®¹å™¨é‡Œé¢è¿è¡Œè¿è¡Œ JAVA åº”ç”¨ç”±äºŽ JVM èŽ·å–çš„å†…å­˜æ•°æ®è¿˜æ˜¯ç‰©ç†æœºçš„æ•°æ®ï¼Œè€Œå®¹å™¨åˆ†é…çš„èµ„æºé…é¢åˆå°äºŽ JVM å¯åŠ¨æ—¶éœ€è¦çš„èµ„æºå¤§å°ï¼Œå°±ä¼šå¯¼è‡´ç¨‹åºå¯åŠ¨ä¸æˆåŠŸã€‚ å¯¹äºŽéœ€è¦èŽ·å– host cpu info çš„ç¨‹åºï¼Œæ¯”å¦‚åœ¨å¼€å‘ golang æœåŠ¡ç«¯éœ€è¦èŽ·å– golangä¸­ runtime.GOMAXPROCS(runtime.NumCPU()) æˆ–è€…è¿ç»´åœ¨è®¾ç½®æœåŠ¡å¯åŠ¨è¿›ç¨‹æ•°é‡çš„æ—¶å€™( æ¯”å¦‚ nginx é…ç½®ä¸­çš„ worker_processes auto )ï¼Œéƒ½å–œæ¬¢é€šè¿‡ç¨‹åºè‡ªåŠ¨åˆ¤æ–­æ‰€åœ¨è¿è¡ŒçŽ¯å¢ƒCPUçš„æ•°é‡ã€‚ä½†æ˜¯åœ¨å®¹å™¨å†…çš„è¿›ç¨‹æ€»ä¼šä»Ž/proc/cpuinfoä¸­èŽ·å–åˆ° CPU çš„æ ¸æ•°ï¼Œè€Œå®¹å™¨é‡Œé¢çš„/procæ–‡ä»¶ç³»ç»Ÿè¿˜æ˜¯ç‰©ç†æœºçš„ï¼Œä»Žè€Œä¼šå½±å“åˆ°è¿è¡Œåœ¨å®¹å™¨é‡Œé¢æœåŠ¡çš„è¿è¡ŒçŠ¶æ€ã€‚ å¦‚ä½•åšå®¹å™¨çš„èµ„æºè§†å›¾éš”ç¦»ï¼Ÿ lxcfs æ¨ªç©ºå‡ºä¸–å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ã€‚lxcfs æ˜¯é€šè¿‡æ–‡ä»¶æŒ‚è½½çš„æ–¹å¼ï¼ŒæŠŠ cgroup ä¸­å…³äºŽç³»ç»Ÿçš„ç›¸å…³ä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œé€šè¿‡ docker çš„ volume æŒ‚è½½ç»™å®¹å™¨å†…éƒ¨çš„ proc ç³»ç»Ÿã€‚ ç„¶åŽè®© docker å†…çš„åº”ç”¨è¯»å– proc ä¸­ä¿¡æ¯çš„æ—¶å€™ä»¥ä¸ºå°±æ˜¯è¯»å–çš„å®¿ä¸»æœºçš„çœŸå®žçš„ procã€‚ ä¸‹é¢æ˜¯ lxcfs çš„å·¥ä½œåŽŸç†æž¶æž„å›¾ï¼š è§£é‡Šä¸€ä¸‹è¿™å¼ å›¾ï¼Œå½“æˆ‘ä»¬æŠŠå®¿ä¸»æœºçš„ /var/lib/lxcfs/proc/memoinfo æ–‡ä»¶æŒ‚è½½åˆ° Docker å®¹å™¨çš„ /proc/meminfo ä½ç½®åŽï¼Œå®¹å™¨ä¸­è¿›ç¨‹è¯»å–ç›¸åº”æ–‡ä»¶å†…å®¹æ—¶ï¼Œlxcfs çš„ /dev/fuse å®žçŽ°ä¼šä»Žå®¹å™¨å¯¹åº”çš„ Cgroup ä¸­è¯»å–æ­£ç¡®çš„å†…å­˜é™åˆ¶ã€‚ä»Žè€Œä½¿å¾—åº”ç”¨èŽ·å¾—æ­£ç¡®çš„èµ„æºçº¦æŸã€‚ cpu çš„é™åˆ¶åŽŸç†ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚ é€šè¿‡ lxcfs å®žçŽ°èµ„æºè§†å›¾éš”ç¦»å®‰è£… lxcfs12wget &lt;https://copr-be.cloud.fedoraproject.org/results/ganto/lxc3/epel-7-x86_64/01041891-lxcfs/lxcfs-3.1.2-0.2.el7.x86_64.rpm&gt;rpm -ivh lxcfs-3.1.2-0.2.el7.x86_64.rpm æ£€æŸ¥ä¸€ä¸‹å®‰è£…æ˜¯å¦æˆåŠŸ 1234567[root@ifdasdfe2344 system]# lxcfs -hUsage:lxcfs [-f|-d] [-p pidfile] mountpoint -f running foreground by default; -d enable debug output Default pidfile is /run/lxcfs.pidlxcfs -h å¯åŠ¨ lxcfs ç›´æŽ¥åŽå°å¯åŠ¨ 1lxcfs /var/lib/lxcfs &amp; é€šè¿‡ systemd å¯åŠ¨ï¼ˆæŽ¨èï¼‰ 1234567891011121314151617touch /usr/lib/systemd/system/lxcfs.servicecat &gt; /usr/lib/systemd/system/lxcfs.service &lt;&lt;EOF[Unit]Description=lxcfs[Service]ExecStart=/usr/bin/lxcfs -f /var/lib/lxcfsRestart=on-failure#ExecReload=/bin/kill -s SIGHUP $MAINPID[Install]WantedBy=multi-user.targetEOFsystemctl daemon-reloadsystemctl start lxcfs.service æ£€æŸ¥å¯åŠ¨æ˜¯å¦æˆåŠŸ 123[root@ifdasdfe2344 system]# ps aux | grep lxcfsroot 3276 0.0 0.0 112708 980 pts/2 S+ 15:45 0:00 grep --color=auto lxcfsroot 18625 0.0 0.0 234628 1296 ? Ssl 14:16 0:00 /usr/bin/lxcfs -f /var/lib/lxcfs å¯åŠ¨æˆåŠŸã€‚ éªŒè¯ lxcfs æ•ˆæžœæœªå¼€å¯ lxcfsæˆ‘ä»¬é¦–å…ˆåœ¨æœªå¼€å¯ lxcfs çš„æœºå™¨ä¸Šè¿è¡Œä¸€ä¸ªå®¹å™¨ï¼Œè¿›å…¥åˆ°å®¹å™¨ä¸­è§‚å¯Ÿ cpu, memory çš„ä¿¡æ¯ã€‚ä¸ºäº†çœ‹å‡ºæ˜Žæ˜¾çš„å·®åˆ«ï¼Œæˆ‘ä»¬ç”¨äº†ä¸€å°é«˜é…ç½®æœåŠ¡å™¨ï¼ˆ32c128gï¼‰ã€‚ 123456# æ‰§è¡Œä»¥ä¸‹æ“ä½œsystemctl stop lxcfsdocker run -it ubuntu /bin/bash # è¿›å…¥åˆ° nginx å®¹å™¨ä¸­free -h é€šè¿‡ä¸Šé¢çš„ç»“æžœæˆ‘ä»¬å¯ä»¥çœ‹åˆ°è™½ç„¶æ˜¯åœ¨å®¹å™¨ä¸­æŸ¥çœ‹å†…å­˜ä¿¡æ¯ï¼Œä½†æ˜¯æ˜¾ç¤ºçš„è¿˜æ˜¯å®¿ä¸»æœºçš„ meminfoã€‚ 12# çœ‹ä¸€ä¸‹ CPU çš„æ ¸æ•°cat /proc/cpuinfo| grep "processor"| wc -l ç»“æžœç¬¦åˆæˆ‘ä»¬çš„çŒœæƒ³ï¼Œæ²¡æœ‰å¼€å¯ lxcfs ï¼Œå®¹å™¨æ‰€çœ‹åˆ°çš„ cpuinfo å°±æ˜¯å®¿ä¸»æœºçš„ã€‚ å¼€å¯ lxcfs12345678910111213systemctl start lxcfs# å¯åŠ¨ä¸€ä¸ªå®¹å™¨ï¼Œç”¨ lxcfs çš„ /proc æ–‡ä»¶æ˜ å°„åˆ°å®¹å™¨ä¸­çš„ /proc æ–‡ä»¶ï¼Œå®¹å™¨å†…å­˜è®¾ç½®ä¸º 256Mï¼šdocker run -it -m 256m \\ -v /var/lib/lxcfs/proc/cpuinfo:/proc/cpuinfo:rw \\ -v /var/lib/lxcfs/proc/diskstats:/proc/diskstats:rw \\ -v /var/lib/lxcfs/proc/meminfo:/proc/meminfo:rw \\ -v /var/lib/lxcfs/proc/stat:/proc/stat:rw \\ -v /var/lib/lxcfs/proc/swaps:/proc/swaps:rw \\ -v /var/lib/lxcfs/proc/uptime:/proc/uptime:rw \\ ubuntu:latest /bin/bashfree -h å¯ä»¥çœ‹åˆ°å®¹å™¨æœ¬èº«çš„å†…å­˜è¢«æ­£ç¡®èŽ·å–åˆ°äº†ï¼Œå¯¹äºŽå†…å­˜çš„èµ„æºè§†å›¾éš”ç¦»æ˜¯æˆåŠŸçš„ã€‚ 12345678910# --cpus 2ï¼Œé™å®šå®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ä¸¤ä¸ªé€»è¾‘CPUdocker run -it --rm -m 256m --cpus 2 \\ -v /var/lib/lxcfs/proc/cpuinfo:/proc/cpuinfo:rw \\ -v /var/lib/lxcfs/proc/diskstats:/proc/diskstats:rw \\ -v /var/lib/lxcfs/proc/meminfo:/proc/meminfo:rw \\ -v /var/lib/lxcfs/proc/stat:/proc/stat:rw \\ -v /var/lib/lxcfs/proc/swaps:/proc/swaps:rw \\ -v /var/lib/lxcfs/proc/uptime:/proc/uptime:rw \\ ubuntu:latest /bin/sh cpuinfo ä¹Ÿæ˜¯æˆ‘ä»¬æ‰€é™åˆ¶å®¹å™¨æ‰€èƒ½ä½¿ç”¨çš„é€»è¾‘ cpu çš„æ•°é‡äº†ã€‚æŒ‡å®šå®¹å™¨åªèƒ½åœ¨æŒ‡å®šçš„ CPU æ•°é‡ä¸Šè¿è¡Œåº”å½“æ˜¯åˆ©å¤§äºŽå¼Šçš„ï¼Œå°±æ˜¯åœ¨åˆ›å»ºå®¹å™¨çš„æ—¶å€™éœ€è¦é¢å¤–åšç‚¹å·¥ä½œï¼Œåˆç†åˆ†é… cpusetã€‚ lxcfs çš„ Kuberneteså®žè·µåœ¨kubernetesä¸­ä½¿ç”¨lxcfséœ€è¦è§£å†³ä¸¤ä¸ªé—®é¢˜ï¼š ç¬¬ä¸€ä¸ªé—®é¢˜æ˜¯æ¯ä¸ªnodeä¸Šéƒ½è¦å¯åŠ¨ lxcfsï¼› ç¬¬äºŒä¸ªé—®é¢˜æ˜¯å°† lxcfs ç»´æŠ¤çš„ /proc æ–‡ä»¶æŒ‚è½½åˆ°æ¯ä¸ªå®¹å™¨ä¸­ï¼› DaemonSetæ–¹å¼æ¥è¿è¡Œ lxcfs FUSEæ–‡ä»¶ç³»ç»Ÿé’ˆå¯¹ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä½¿ç”¨ daemonset åœ¨æ¯ä¸ª k8s node ä¸Šéƒ½å®‰è£… lxcfsã€‚ ç›´æŽ¥ä½¿ç”¨ä¸‹é¢çš„ yaml æ–‡ä»¶ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344apiVersion: apps/v1kind: DaemonSetmetadata: name: lxcfs labels: app: lxcfsspec: selector: matchLabels: app: lxcfs template: metadata: labels: app: lxcfs spec: hostPID: true tolerations: - key: node-role.kubernetes.io/master effect: NoSchedule containers: - name: lxcfs image: registry.cn-hangzhou.aliyuncs.com/denverdino/lxcfs:3.0.4 imagePullPolicy: Always securityContext: privileged: true volumeMounts: - name: cgroup mountPath: /sys/fs/cgroup - name: lxcfs mountPath: /var/lib/lxcfs mountPropagation: Bidirectional - name: usr-local mountPath: /usr/local volumes: - name: cgroup hostPath: path: /sys/fs/cgroup - name: usr-local hostPath: path: /usr/local - name: lxcfs hostPath: path: /var/lib/lxcfs type: DirectoryOrCreate 1kubectl apply -f lxcfs-daemonset.yaml å¯ä»¥çœ‹åˆ° lxcfs çš„ daemonset å·²ç»éƒ¨ç½²åˆ°æ¯ä¸ª node ä¸Šã€‚ æ˜ å°„ lxcfs çš„ proc æ–‡ä»¶åˆ°å®¹å™¨é’ˆå¯¹ç¬¬äºŒä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸¤ç§æ–¹æ³•æ¥è§£å†³ã€‚ ç¬¬ä¸€ç§å°±æ˜¯ç®€å•åœ°åœ¨ k8s deployment çš„ yaml æ–‡ä»¶ä¸­å£°æ˜Žå¯¹å®¿ä¸»æœº /var/lib/lxcfs/proc ä¸€ç³»åˆ—æ–‡ä»¶çš„æŒ‚è½½ã€‚ ç¬¬äºŒç§æ–¹å¼åˆ©ç”¨Kubernetesçš„æ‰©å±•æœºåˆ¶ Initializerï¼Œå®žçŽ°å¯¹ lxcfs æ–‡ä»¶çš„è‡ªåŠ¨åŒ–æŒ‚è½½ã€‚ä½†æ˜¯ InitializerConfiguration çš„åŠŸèƒ½åœ¨ k8s 1.14 ä¹‹åŽå°±ä¸å†æ”¯æŒäº†ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥å®žçŽ° admission-webhook ï¼ˆå‡†å…¥æŽ§åˆ¶ï¼ˆAdmission Controlï¼‰åœ¨æŽˆæƒåŽå¯¹è¯·æ±‚åšè¿›ä¸€æ­¥çš„éªŒè¯æˆ–æ·»åŠ é»˜è®¤å‚æ•°, https://kubernetes.feisky.xyz/extension/auth/admissionï¼‰æ¥è¾¾åˆ°åŒæ ·çš„ç›®çš„ã€‚ 123# éªŒè¯ä½ çš„ k8s é›†ç¾¤æ˜¯å¦æ”¯æŒ admission$ kubectl api-versions | grep admissionregistration.k8s.io/v1beta1admissionregistration.k8s.io/v1beta1 å…³äºŽ admission-webhook çš„ç¼–å†™ä¸å±žäºŽæœ¬æ–‡çš„è®¨è®ºèŒƒå›´ï¼Œå¯ä»¥åˆ°å®˜æ–¹æ–‡æ¡£ä¸­æ·±å…¥äº†è§£ã€‚ è¿™é‡Œæœ‰ä¸€ä¸ªå®žçŽ° lxcfs admission webhook çš„èŒƒä¾‹ï¼Œå¯ä»¥å‚è€ƒï¼šhttps://github.com/hantmac/lxcfs-admission-webhook æ€»ç»“æœ¬æ–‡ä»‹ç»äº†é€šè¿‡ lxcfs æä¾›å®¹å™¨èµ„æºè§†å›¾éš”ç¦»çš„æ–¹æ³•ï¼Œå¯ä»¥å¸®åŠ©ä¸€äº›å®¹å™¨åŒ–åº”ç”¨æ›´å¥½çš„è¯†åˆ«å®¹å™¨è¿è¡Œæ—¶çš„èµ„æºé™åˆ¶ã€‚ åŒæ—¶ï¼Œåœ¨æœ¬æ–‡ä¸­æˆ‘ä»¬ä»‹ç»äº†åˆ©ç”¨å®¹å™¨å’Œ DaemonSet çš„æ–¹å¼éƒ¨ç½² lxcfs FUSEï¼Œè¿™ä¸ä½†æžå¤§ç®€åŒ–äº†éƒ¨ç½²ï¼Œä¹Ÿå¯ä»¥æ–¹ä¾¿åœ°åˆ©ç”¨ Kubernetes è‡ªèº«çš„å®¹å™¨ç®¡ç†èƒ½åŠ›ï¼Œæ”¯æŒ lxcfs è¿›ç¨‹å¤±æ•ˆæ—¶è‡ªåŠ¨æ¢å¤ï¼Œåœ¨é›†ç¾¤ä¼¸ç¼©æ—¶ä¹Ÿå¯ä»¥ä¿è¯èŠ‚ç‚¹éƒ¨ç½²çš„ä¸€è‡´æ€§ã€‚è¿™ä¸ªæŠ€å·§å¯¹äºŽå…¶ä»–ç±»ä¼¼çš„ç›‘æŽ§æˆ–è€…ç³»ç»Ÿæ‰©å±•éƒ½æ˜¯é€‚ç”¨çš„ã€‚ å¦å¤–æˆ‘ä»¬ä»‹ç»äº†åˆ©ç”¨Kubernetesçš„ admission webhookï¼Œå®žçŽ°å¯¹ lxcfs æ–‡ä»¶çš„è‡ªåŠ¨åŒ–æŒ‚è½½ã€‚æ•´ä¸ªè¿‡ç¨‹å¯¹äºŽåº”ç”¨éƒ¨ç½²äººå‘˜æ˜¯é€æ˜Žçš„ï¼Œå¯ä»¥æžå¤§ç®€åŒ–è¿ç»´å¤æ‚åº¦ã€‚]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[é‡ç£…ï¼å¾®è½¯ VS Code çš„ Go è¯­è¨€æ’ä»¶è¿ç§»è‡³ç”± Go å®˜æ–¹å›¢é˜Ÿç»´æŠ¤]]></title>
    <url>%2F2020%2F06%2F12%2F%E9%87%8D%E7%A3%85%EF%BC%81%E5%BE%AE%E8%BD%AF-VS-Code-%E7%9A%84-Go-%E8%AF%AD%E8%A8%80%E6%8F%92%E4%BB%B6%E8%BF%81%E7%A7%BB%E8%87%B3%E7%94%B1-Go-%E5%AE%98%E6%96%B9%E5%9B%A2%E9%98%9F%E7%BB%B4%E6%8A%A4%2F</url>
    <content type="text"><![CDATA[Go å®˜æ–¹ 6æœˆ 9æ—¥ç”µï¼šVS Code çš„ Go plugin å·²ç»è½¬ä¸º Go å®˜æ–¹å›¢é˜Ÿç»´æŠ¤çš„é¡¹ç›®ã€‚å…¶ä¸­æœ‰ä¸¤ä¸ªé‡è¦çš„æ ‡å¿—æ€§äº‹ä»¶ï¼š GitHub ä»“åº“å·²ç»ä»Ž https://github.com/microsoft/vscode-go è¿ç§»è‡³ https://github.com/golang/vscode-go ï¼› åœ¨ VS Code æ’ä»¶å¸‚åœºä¸­çš„å‘å¸ƒè€…ä¹Ÿç”± Microsoft å˜æ›´ä¸º Go Team at Google ã€‚ è‡ªåŽ»å¹´ Go modules å‘å¸ƒä»¥æ¥ï¼ŒVS Code å›¢é˜Ÿå°±å’Œ Go å›¢é˜Ÿå¼€å§‹äº†ç´§å¯†çš„åˆä½œï¼Œè®©æ’ä»¶å¾—ä»¥æ”¯æŒ Go çš„å®˜æ–¹è¯­è¨€æœåŠ¡å™¨ goplsï¼Œç›®å‰è¿˜æ­£åœ¨æ”¹è¿›å¯¹ Delve è°ƒè¯•å™¨çš„æ”¯æŒã€‚ ä»Žå¦ä¸€æ–¹é¢æ¥çœ‹ï¼Œè¿ç§»è‡³ç”± Go å›¢é˜Ÿç»´æŠ¤æ„å‘³ç€æ­¤æ’ä»¶æˆä¸ºäº† Go é¡¹ç›®çš„ä¸€éƒ¨åˆ†ï¼Œå¯ç¡®ä¿ Go ç¤¾åŒºæˆå‘˜èƒ½å‚ä¸Žåˆ°é¡¹ç›®çš„æ¯ä¸€æ­¥ã€‚æ’ä»¶ç›®å‰ä¾èµ–äºŽè®¸å¤šä¸åŒçš„å·¥å…·å’Œåº“ï¼Œè€Œè¿™äº›å·¥å…·å’Œåº“å‡ç”±ç¤¾åŒºç»´æŠ¤ï¼ŒVS Code å›¢é˜Ÿå¸Œæœ›ä¸Žè¿™äº›é¡¹ç›®çš„æ‰€æœ‰è€…åˆä½œï¼Œä»¥å¸®åŠ©å‡å°‘ Go ç¤¾åŒºçš„ç»´æŠ¤å·¥ä½œè´Ÿæ‹…ï¼Œå¹¶é¼“åŠ±æ›´å¤š Gophers å‚ä¸Žè¿›æ¥å…±åŒç»´æŠ¤ã€‚ åŽŸæ–‡åœ°å€: https://blog.golang.org/vscode-go]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Uber Go è¯­è¨€ç¼–ç è§„èŒƒ]]></title>
    <url>%2F2020%2F06%2F09%2FUber-Go-%E8%AF%AD%E8%A8%80%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83%2F</url>
    <content type="text"><![CDATA[uber-go/guide çš„ä¸­æ–‡ç¿»è¯‘EnglishUber Go è¯­è¨€ç¼–ç è§„èŒƒ Uber æ˜¯ä¸€å®¶ç¾Žå›½ç¡…è°·çš„ç§‘æŠ€å…¬å¸ï¼Œä¹Ÿæ˜¯ Go è¯­è¨€çš„æ—©æœŸ adopterã€‚å…¶å¼€æºäº†å¾ˆå¤š golang é¡¹ç›®ï¼Œè¯¸å¦‚è¢« Gopher åœˆç†ŸçŸ¥çš„ zapã€jaeger ç­‰ã€‚2018 å¹´å¹´æœ« Uber å°†å†…éƒ¨çš„ Go é£Žæ ¼è§„èŒƒ å¼€æºåˆ° GitHubï¼Œç»è¿‡ä¸€å¹´çš„ç§¯ç´¯å’Œæ›´æ–°ï¼Œè¯¥è§„èŒƒå·²ç»åˆå…·è§„æ¨¡ï¼Œå¹¶å—åˆ°å¹¿å¤§ Gopher çš„å…³æ³¨ã€‚æœ¬æ–‡æ˜¯è¯¥è§„èŒƒçš„ä¸­æ–‡ç‰ˆæœ¬ã€‚æœ¬ç‰ˆæœ¬ä¼šæ ¹æ®åŽŸç‰ˆå®žæ—¶æ›´æ–°ã€‚ ç‰ˆæœ¬ å½“å‰æ›´æ–°ç‰ˆæœ¬ï¼š2020-06-05 ç‰ˆæœ¬åœ°å€ï¼šcommit:#93 å¦‚æžœæ‚¨å‘çŽ°ä»»ä½•æ›´æ–°ã€é—®é¢˜æˆ–æ”¹è¿›ï¼Œè¯·éšæ—¶ fork å’Œ PR Please feel free to fork and PR if you find any updates, issues or improvement. ç›®å½• 2019-12-17 2019-11-26 2020-01-11 2020-02-03 2020-02-25 2020-06-05 uber-go/guide çš„ä¸­æ–‡ç¿»è¯‘ English Uber Go è¯­è¨€ç¼–ç è§„èŒƒ ç‰ˆæœ¬ ç›®å½• ä»‹ç» æŒ‡å¯¼åŽŸåˆ™ æŒ‡å‘ interface çš„æŒ‡é’ˆ Interface åˆç†æ€§éªŒè¯ æŽ¥æ”¶å™¨ (receiver) ä¸ŽæŽ¥å£ é›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„ åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Maps æŽ¥æ”¶ Slices å’Œ Maps è¿”å›ž slices æˆ– maps ä½¿ç”¨ defer é‡Šæ”¾èµ„æº Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„ æžšä¸¾ä»Ž 1 å¼€å§‹ ä½¿ç”¨ time å¤„ç†æ—¶é—´ ä½¿ç”¨ time.Time è¡¨è¾¾çž¬æ—¶æ—¶é—´ ä½¿ç”¨ time.Duration è¡¨è¾¾æ—¶é—´æ®µ å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ time.Time å’Œ time.Duration é”™è¯¯ç±»åž‹ é”™è¯¯åŒ…è£… (Error Wrapping) å¤„ç†ç±»åž‹æ–­è¨€å¤±è´¥ ä¸è¦ panic ä½¿ç”¨ go.uber.org/atomic é¿å…å¯å˜å…¨å±€å˜é‡ é¿å…åœ¨å…¬å…±ç»“æž„ä¸­åµŒå…¥ç±»åž‹ é¿å…ä½¿ç”¨å†…ç½®åç§° æ€§èƒ½ ä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmt é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢ å°½é‡åˆå§‹åŒ–æ—¶æŒ‡å®š Map å®¹é‡ è§„èŒƒ ä¸€è‡´æ€§ ç›¸ä¼¼çš„å£°æ˜Žæ”¾åœ¨ä¸€ç»„ import åˆ†ç»„ åŒ…å å‡½æ•°å å¯¼å…¥åˆ«å å‡½æ•°åˆ†ç»„ä¸Žé¡ºåº å‡å°‘åµŒå¥— ä¸å¿…è¦çš„ else é¡¶å±‚å˜é‡å£°æ˜Ž å¯¹äºŽæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€ ç»“æž„ä½“ä¸­çš„åµŒå…¥ ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æž„ä½“ æœ¬åœ°å˜é‡å£°æ˜Ž nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slice ç¼©å°å˜é‡ä½œç”¨åŸŸ é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜Žç¡®(Avoid Naked Parameters) ä½¿ç”¨åŽŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰ åˆå§‹åŒ– Struct å¼•ç”¨ åˆå§‹åŒ– Maps å­—ç¬¦ä¸² string format å‘½å Printf æ ·å¼çš„å‡½æ•° ç¼–ç¨‹æ¨¡å¼ è¡¨é©±åŠ¨æµ‹è¯• åŠŸèƒ½é€‰é¡¹ Stargazers over time ä»‹ç»æ ·å¼ (style) æ˜¯æ”¯é…æˆ‘ä»¬ä»£ç çš„æƒ¯ä¾‹ã€‚æœ¯è¯­æ ·å¼æœ‰ç‚¹ç”¨è¯ä¸å½“ï¼Œå› ä¸ºè¿™äº›çº¦å®šæ¶µç›–çš„èŒƒå›´ä¸é™äºŽç”± gofmt æ›¿æˆ‘ä»¬å¤„ç†çš„æºæ–‡ä»¶æ ¼å¼ã€‚ æœ¬æŒ‡å—çš„ç›®çš„æ˜¯é€šè¿‡è¯¦ç»†æè¿°åœ¨ Uber ç¼–å†™ Go ä»£ç çš„æ³¨æ„äº‹é¡¹æ¥ç®¡ç†è¿™ç§å¤æ‚æ€§ã€‚è¿™äº›è§„åˆ™çš„å­˜åœ¨æ˜¯ä¸ºäº†ä½¿ä»£ç åº“æ˜“äºŽç®¡ç†ï¼ŒåŒæ—¶ä»ç„¶å…è®¸å·¥ç¨‹å¸ˆæ›´æœ‰æ•ˆåœ°ä½¿ç”¨ Go è¯­è¨€åŠŸèƒ½ã€‚ è¯¥æŒ‡å—æœ€åˆç”± Prashant Varanasi å’Œ Simon Newton ç¼–å†™ï¼Œç›®çš„æ˜¯ä½¿ä¸€äº›åŒäº‹èƒ½å¿«é€Ÿä½¿ç”¨ Goã€‚å¤šå¹´æ¥ï¼Œè¯¥æŒ‡å—å·²æ ¹æ®å…¶ä»–äººçš„åé¦ˆè¿›è¡Œäº†ä¿®æ”¹ã€‚ æœ¬æ–‡æ¡£è®°å½•äº†æˆ‘ä»¬åœ¨ Uber éµå¾ªçš„ Go ä»£ç ä¸­çš„æƒ¯ç”¨çº¦å®šã€‚å…¶ä¸­è®¸å¤šæ˜¯ Go çš„é€šç”¨å‡†åˆ™ï¼Œè€Œå…¶ä»–æ‰©å±•å‡†åˆ™ä¾èµ–äºŽä¸‹é¢å¤–éƒ¨çš„æŒ‡å—ï¼š Effective Go The Go common mistakes guide æ‰€æœ‰ä»£ç éƒ½åº”è¯¥é€šè¿‡golintå’Œgo vetçš„æ£€æŸ¥å¹¶æ— é”™è¯¯ã€‚æˆ‘ä»¬å»ºè®®æ‚¨å°†ç¼–è¾‘å™¨è®¾ç½®ä¸ºï¼š ä¿å­˜æ—¶è¿è¡Œ goimports è¿è¡Œ golint å’Œ go vet æ£€æŸ¥é”™è¯¯ æ‚¨å¯ä»¥åœ¨ä»¥ä¸‹ Go ç¼–è¾‘å™¨å·¥å…·æ”¯æŒé¡µé¢ä¸­æ‰¾åˆ°æ›´ä¸ºè¯¦ç»†çš„ä¿¡æ¯ï¼šhttps://github.com/golang/go/wiki/IDEsAndTextEditorPlugins æŒ‡å¯¼åŽŸåˆ™æŒ‡å‘ interface çš„æŒ‡é’ˆæ‚¨å‡ ä¹Žä¸éœ€è¦æŒ‡å‘æŽ¥å£ç±»åž‹çš„æŒ‡é’ˆã€‚æ‚¨åº”è¯¥å°†æŽ¥å£ä½œä¸ºå€¼è¿›è¡Œä¼ é€’ï¼Œåœ¨è¿™æ ·çš„ä¼ é€’è¿‡ç¨‹ä¸­ï¼Œå®žè´¨ä¸Šä¼ é€’çš„åº•å±‚æ•°æ®ä»ç„¶å¯ä»¥æ˜¯æŒ‡é’ˆã€‚ æŽ¥å£å®žè´¨ä¸Šåœ¨åº•å±‚ç”¨ä¸¤ä¸ªå­—æ®µè¡¨ç¤ºï¼š ä¸€ä¸ªæŒ‡å‘æŸäº›ç‰¹å®šç±»åž‹ä¿¡æ¯çš„æŒ‡é’ˆã€‚æ‚¨å¯ä»¥å°†å…¶è§†ä¸ºâ€typeâ€ã€‚ æ•°æ®æŒ‡é’ˆã€‚å¦‚æžœå­˜å‚¨çš„æ•°æ®æ˜¯æŒ‡é’ˆï¼Œåˆ™ç›´æŽ¥å­˜å‚¨ã€‚å¦‚æžœå­˜å‚¨çš„æ•°æ®æ˜¯ä¸€ä¸ªå€¼ï¼Œåˆ™å­˜å‚¨æŒ‡å‘è¯¥å€¼çš„æŒ‡é’ˆã€‚ å¦‚æžœå¸Œæœ›æŽ¥å£æ–¹æ³•ä¿®æ”¹åŸºç¡€æ•°æ®ï¼Œåˆ™å¿…é¡»ä½¿ç”¨æŒ‡é’ˆä¼ é€’ã€‚ Interface åˆç†æ€§éªŒè¯åœ¨ç¼–è¯‘æ—¶éªŒè¯æŽ¥å£çš„ç¬¦åˆæ€§ã€‚è¿™åŒ…æ‹¬ï¼š å°†å®žçŽ°ç‰¹å®šæŽ¥å£æ‰€éœ€çš„å¯¼å‡ºç±»åž‹ä½œä¸ºå…¶ API çš„ä¸€éƒ¨åˆ† å¯¼å‡ºæˆ–æœªå¯¼å‡ºçš„ç±»åž‹æ˜¯å®žçŽ°åŒä¸€æŽ¥å£çš„ç±»åž‹é›†åˆçš„ä¸€éƒ¨åˆ† å…¶ä»–è¿åæŽ¥å£çš„æƒ…å†µä¼šç ´åç”¨æˆ·ã€‚ BadGood123456789type Handler struct &#123; // ...&#125;func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request,) &#123; ...&#125;12345678910type Handler struct &#123; // ...&#125;var _ http.Handler = (*Handler)(nil)func (h *Handler) ServeHTTP( w http.ResponseWriter, r *http.Request,) &#123; // ...&#125; å¦‚æžœ *Handler æ°¸è¿œä¸ä¼šä¸Ž http.Handler æŽ¥å£åŒ¹é…,é‚£ä¹ˆè¯­å¥ var _ http.Handler = (*Handler)(nil) å°†æ— æ³•ç¼–è¯‘ èµ‹å€¼çš„å³è¾¹åº”è¯¥æ˜¯æ–­è¨€ç±»åž‹çš„é›¶å€¼ã€‚å¯¹äºŽæŒ‡é’ˆç±»åž‹ï¼ˆå¦‚ *Handlerï¼‰ã€åˆ‡ç‰‡å’Œæ˜ å°„ï¼Œè¿™æ˜¯ nilï¼›å¯¹äºŽç»“æž„ç±»åž‹ï¼Œè¿™æ˜¯ç©ºç»“æž„ã€‚ 1234567891011type LogHandler struct &#123; h http.Handler log *zap.Logger&#125;var _ http.Handler = LogHandler&#123;&#125;func (h LogHandler) ServeHTTP( w http.ResponseWriter, r *http.Request,) &#123; // ...&#125; æŽ¥æ”¶å™¨ (receiver) ä¸ŽæŽ¥å£ä½¿ç”¨å€¼æŽ¥æ”¶å™¨çš„æ–¹æ³•æ—¢å¯ä»¥é€šè¿‡å€¼è°ƒç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆè°ƒç”¨ã€‚ ä¾‹å¦‚ï¼Œ 12345678910111213141516171819202122232425type S struct &#123; data string&#125;func (s S) Read() string &#123; return s.data&#125;func (s *S) Write(str string) &#123; s.data = str&#125;sVals := map[int]S&#123;1: &#123;"A"&#125;&#125;// ä½ åªèƒ½é€šè¿‡å€¼è°ƒç”¨ ReadsVals[1].Read()// è¿™ä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼š// sVals[1].Write("test")sPtrs := map[int]*S&#123;1: &#123;"A"&#125;&#125;// é€šè¿‡æŒ‡é’ˆæ—¢å¯ä»¥è°ƒç”¨ Readï¼Œä¹Ÿå¯ä»¥è°ƒç”¨ Write æ–¹æ³•sPtrs[1].Read()sPtrs[1].Write("test") åŒæ ·ï¼Œå³ä½¿è¯¥æ–¹æ³•å…·æœ‰å€¼æŽ¥æ”¶å™¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŒ‡é’ˆæ¥æ»¡è¶³æŽ¥å£ã€‚ 123456789101112131415161718192021222324type F interface &#123; f()&#125;type S1 struct&#123;&#125;func (s S1) f() &#123;&#125;type S2 struct&#123;&#125;func (s *S2) f() &#123;&#125;s1Val := S1&#123;&#125;s1Ptr := &amp;S1&#123;&#125;s2Val := S2&#123;&#125;s2Ptr := &amp;S2&#123;&#125;var i Fi = s1Vali = s1Ptri = s2Ptr// ä¸‹é¢ä»£ç æ— æ³•é€šè¿‡ç¼–è¯‘ã€‚å› ä¸º s2Val æ˜¯ä¸€ä¸ªå€¼ï¼Œè€Œ S2 çš„ f æ–¹æ³•ä¸­æ²¡æœ‰ä½¿ç”¨å€¼æŽ¥æ”¶å™¨// i = s2Val Effective Go ä¸­æœ‰ä¸€æ®µå…³äºŽ pointers vs. values çš„ç²¾å½©è®²è§£ã€‚ é›¶å€¼ Mutex æ˜¯æœ‰æ•ˆçš„é›¶å€¼ sync.Mutex å’Œ sync.RWMutex æ˜¯æœ‰æ•ˆçš„ã€‚æ‰€ä»¥æŒ‡å‘ mutex çš„æŒ‡é’ˆåŸºæœ¬æ˜¯ä¸å¿…è¦çš„ã€‚ BadGood12mu := new(sync.Mutex)mu.Lock()12var mu sync.Mutexmu.Lock() å¦‚æžœä½ ä½¿ç”¨ç»“æž„ä½“æŒ‡é’ˆï¼Œmutex å¯ä»¥éžæŒ‡é’ˆå½¢å¼ä½œä¸ºç»“æž„ä½“çš„ç»„æˆå­—æ®µï¼Œæˆ–è€…æ›´å¥½çš„æ–¹å¼æ˜¯ç›´æŽ¥åµŒå…¥åˆ°ç»“æž„ä½“ä¸­ã€‚å¦‚æžœæ˜¯ç§æœ‰ç»“æž„ä½“ç±»åž‹æˆ–æ˜¯è¦å®žçŽ° Mutex æŽ¥å£çš„ç±»åž‹ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨åµŒå…¥ mutex çš„æ–¹æ³•ï¼š 123456789101112131415161718type smap struct &#123; sync.Mutex // only for unexported typesï¼ˆä»…é€‚ç”¨äºŽéžå¯¼å‡ºç±»åž‹ï¼‰ data map[string]string&#125;func newSMap() *smap &#123; return &amp;smap&#123; data: make(map[string]string), &#125;&#125;func (m *smap) Get(k string) string &#123; m.Lock() defer m.Unlock() return m.data[k]&#125;123456789101112131415161718type SMap struct &#123; mu sync.Mutex // å¯¹äºŽå¯¼å‡ºç±»åž‹ï¼Œè¯·ä½¿ç”¨ç§æœ‰é” data map[string]string&#125;func NewSMap() *SMap &#123; return &amp;SMap&#123; data: make(map[string]string), &#125;&#125;func (m *SMap) Get(k string) string &#123; m.mu.Lock() defer m.mu.Unlock() return m.data[k]&#125;ä¸ºç§æœ‰ç±»åž‹æˆ–éœ€è¦å®žçŽ°äº’æ–¥æŽ¥å£çš„ç±»åž‹åµŒå…¥ã€‚å¯¹äºŽå¯¼å‡ºçš„ç±»åž‹ï¼Œè¯·ä½¿ç”¨ä¸“ç”¨å­—æ®µã€‚ åœ¨è¾¹ç•Œå¤„æ‹·è´ Slices å’Œ Mapsslices å’Œ maps åŒ…å«äº†æŒ‡å‘åº•å±‚æ•°æ®çš„æŒ‡é’ˆï¼Œå› æ­¤åœ¨éœ€è¦å¤åˆ¶å®ƒä»¬æ—¶è¦ç‰¹åˆ«æ³¨æ„ã€‚ æŽ¥æ”¶ Slices å’Œ Mapsè¯·è®°ä½ï¼Œå½“ map æˆ– slice ä½œä¸ºå‡½æ•°å‚æ•°ä¼ å…¥æ—¶ï¼Œå¦‚æžœæ‚¨å­˜å‚¨äº†å¯¹å®ƒä»¬çš„å¼•ç”¨ï¼Œåˆ™ç”¨æˆ·å¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ã€‚ Bad Good123456789func (d *Driver) SetTrips(trips []Trip) &#123; d.trips = trips&#125;trips := ...d1.SetTrips(trips)// ä½ æ˜¯è¦ä¿®æ”¹ d1.trips å—ï¼Ÿtrips[0] = ...12345678910func (d *Driver) SetTrips(trips []Trip) &#123; d.trips = make([]Trip, len(trips)) copy(d.trips, trips)&#125;trips := ...d1.SetTrips(trips)// è¿™é‡Œæˆ‘ä»¬ä¿®æ”¹ trips[0]ï¼Œä½†ä¸ä¼šå½±å“åˆ° d1.tripstrips[0] = ... è¿”å›ž slices æˆ– mapsåŒæ ·ï¼Œè¯·æ³¨æ„ç”¨æˆ·å¯¹æš´éœ²å†…éƒ¨çŠ¶æ€çš„ map æˆ– slice çš„ä¿®æ”¹ã€‚ BadGood123456789101112131415161718type Stats struct &#123; mu sync.Mutex counters map[string]int&#125;// Snapshot è¿”å›žå½“å‰çŠ¶æ€ã€‚func (s *Stats) Snapshot() map[string]int &#123; s.mu.Lock() defer s.mu.Unlock() return s.counters&#125;// snapshot ä¸å†å—äº’æ–¥é”ä¿æŠ¤// å› æ­¤å¯¹ snapshot çš„ä»»ä½•è®¿é—®éƒ½å°†å—åˆ°æ•°æ®ç«žäº‰çš„å½±å“// å½±å“ stats.counterssnapshot := stats.Snapshot()12345678910111213141516171819type Stats struct &#123; mu sync.Mutex counters map[string]int&#125;func (s *Stats) Snapshot() map[string]int &#123; s.mu.Lock() defer s.mu.Unlock() result := make(map[string]int, len(s.counters)) for k, v := range s.counters &#123; result[k] = v &#125; return result&#125;// snapshot çŽ°åœ¨æ˜¯ä¸€ä¸ªæ‹·è´snapshot := stats.Snapshot() ä½¿ç”¨ defer é‡Šæ”¾èµ„æºä½¿ç”¨ defer é‡Šæ”¾èµ„æºï¼Œè¯¸å¦‚æ–‡ä»¶å’Œé”ã€‚ BadGood12345678910111213p.Lock()if p.count &lt; 10 &#123; p.Unlock() return p.count&#125;p.count++newCount := p.countp.Unlock()return newCount// å½“æœ‰å¤šä¸ª return åˆ†æ”¯æ—¶ï¼Œå¾ˆå®¹æ˜“é—å¿˜ unlock1234567891011p.Lock()defer p.Unlock()if p.count &lt; 10 &#123; return p.count&#125;p.count++return p.count// æ›´å¯è¯» Defer çš„å¼€é”€éžå¸¸å°ï¼Œåªæœ‰åœ¨æ‚¨å¯ä»¥è¯æ˜Žå‡½æ•°æ‰§è¡Œæ—¶é—´å¤„äºŽçº³ç§’çº§çš„ç¨‹åº¦æ—¶ï¼Œæ‰åº”é¿å…è¿™æ ·åšã€‚ä½¿ç”¨ defer æå‡å¯è¯»æ€§æ˜¯å€¼å¾—çš„ï¼Œå› ä¸ºä½¿ç”¨å®ƒä»¬çš„æˆæœ¬å¾®ä¸è¶³é“ã€‚å°¤å…¶é€‚ç”¨äºŽé‚£äº›ä¸ä»…ä»…æ˜¯ç®€å•å†…å­˜è®¿é—®çš„è¾ƒå¤§çš„æ–¹æ³•ï¼Œåœ¨è¿™äº›æ–¹æ³•ä¸­å…¶ä»–è®¡ç®—çš„èµ„æºæ¶ˆè€—è¿œè¶…è¿‡ deferã€‚ Channel çš„ size è¦ä¹ˆæ˜¯ 1ï¼Œè¦ä¹ˆæ˜¯æ— ç¼“å†²çš„channel é€šå¸¸ size åº”ä¸º 1 æˆ–æ˜¯æ— ç¼“å†²çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œchannel æ˜¯æ— ç¼“å†²çš„ï¼Œå…¶ size ä¸ºé›¶ã€‚ä»»ä½•å…¶ä»–å°ºå¯¸éƒ½å¿…é¡»ç»è¿‡ä¸¥æ ¼çš„å®¡æŸ¥ã€‚æˆ‘ä»¬éœ€è¦è€ƒè™‘å¦‚ä½•ç¡®å®šå¤§å°ï¼Œè€ƒè™‘æ˜¯ä»€ä¹ˆé˜»æ­¢äº† channel åœ¨é«˜è´Ÿè½½ä¸‹å’Œé˜»å¡žå†™æ—¶çš„å†™å…¥ï¼Œä»¥åŠå½“è¿™ç§æƒ…å†µå‘ç”Ÿæ—¶ç³»ç»Ÿé€»è¾‘æœ‰å“ªäº›å˜åŒ–ã€‚(ç¿»è¯‘è§£é‡Šï¼šæŒ‰ç…§åŽŸæ–‡æ„æ€æ˜¯éœ€è¦ç•Œå®šé€šé“è¾¹ç•Œï¼Œç«žæ€æ¡ä»¶ï¼Œä»¥åŠé€»è¾‘ä¸Šä¸‹æ–‡æ¢³ç†) BadGood12// åº”è¯¥è¶³ä»¥æ»¡è¶³ä»»ä½•æƒ…å†µï¼c := make(chan int, 64)1234// å¤§å°ï¼š1c := make(chan int, 1) // æˆ–è€…// æ— ç¼“å†² channelï¼Œå¤§å°ä¸º 0c := make(chan int) æžšä¸¾ä»Ž 1 å¼€å§‹åœ¨ Go ä¸­å¼•å…¥æžšä¸¾çš„æ ‡å‡†æ–¹æ³•æ˜¯å£°æ˜Žä¸€ä¸ªè‡ªå®šä¹‰ç±»åž‹å’Œä¸€ä¸ªä½¿ç”¨äº† iota çš„ const ç»„ã€‚ç”±äºŽå˜é‡çš„é»˜è®¤å€¼ä¸º 0ï¼Œå› æ­¤é€šå¸¸åº”ä»¥éžé›¶å€¼å¼€å¤´æžšä¸¾ã€‚ BadGood123456789type Operation intconst ( Add Operation = iota Subtract Multiply)// Add=0, Subtract=1, Multiply=2123456789type Operation intconst ( Add Operation = iota + 1 Subtract Multiply)// Add=1, Subtract=2, Multiply=3 åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä½¿ç”¨é›¶å€¼æ˜¯æœ‰æ„ä¹‰çš„ï¼ˆæžšä¸¾ä»Žé›¶å¼€å§‹ï¼‰ï¼Œä¾‹å¦‚ï¼Œå½“é›¶å€¼æ˜¯ç†æƒ³çš„é»˜è®¤è¡Œä¸ºæ—¶ã€‚ 123456789type LogOutput intconst ( LogToStdout LogOutput = iota LogToFile LogToRemote)// LogToStdout=0, LogToFile=1, LogToRemote=2 ä½¿ç”¨ time å¤„ç†æ—¶é—´æ—¶é—´å¤„ç†å¾ˆå¤æ‚ã€‚å…³äºŽæ—¶é—´çš„é”™è¯¯å‡è®¾é€šå¸¸åŒ…æ‹¬ä»¥ä¸‹å‡ ç‚¹ã€‚ ä¸€å¤©æœ‰ 24 å°æ—¶ ä¸€å°æ—¶æœ‰ 60 åˆ†é’Ÿ ä¸€å‘¨æœ‰ä¸ƒå¤© ä¸€å¹´ 365 å¤© è¿˜æœ‰æ›´å¤š ä¾‹å¦‚ï¼Œ1 è¡¨ç¤ºåœ¨ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ŠåŠ ä¸Š 24 å°æ—¶å¹¶ä¸æ€»æ˜¯äº§ç”Ÿä¸€ä¸ªæ–°çš„æ—¥åŽ†æ—¥ã€‚ å› æ­¤ï¼Œåœ¨å¤„ç†æ—¶é—´æ—¶å§‹ç»ˆä½¿ç”¨ &quot;time&quot; åŒ…ï¼Œå› ä¸ºå®ƒæœ‰åŠ©äºŽä»¥æ›´å®‰å…¨ã€æ›´å‡†ç¡®çš„æ–¹å¼å¤„ç†è¿™äº›ä¸æ­£ç¡®çš„å‡è®¾ã€‚ ä½¿ç”¨ time.Time è¡¨è¾¾çž¬æ—¶æ—¶é—´åœ¨å¤„ç†æ—¶é—´çš„çž¬é—´æ—¶ä½¿ç”¨ time.timeï¼Œåœ¨æ¯”è¾ƒã€æ·»åŠ æˆ–å‡åŽ»æ—¶é—´æ—¶ä½¿ç”¨ time.Time ä¸­çš„æ–¹æ³•ã€‚ BadGood123func isActive(now, start, stop int) bool &#123; return start &lt;= now &amp;&amp; now &lt; stop&#125;123func isActive(now, start, stop time.Time) bool &#123; return (start.Before(now) || start.Equal(now)) &amp;&amp; now.Before(stop)&#125; ä½¿ç”¨ time.Duration è¡¨è¾¾æ—¶é—´æ®µåœ¨å¤„ç†æ—¶é—´æ®µæ—¶ä½¿ç”¨ time.Duration . BadGood1234567func poll(delay int) &#123; for &#123; // ... time.Sleep(time.Duration(delay) * time.Millisecond) &#125;&#125;poll(10) // æ˜¯å‡ ç§’é’Ÿè¿˜æ˜¯å‡ æ¯«ç§’?1234567func poll(delay time.Duration) &#123; for &#123; // ... time.Sleep(delay) &#125;&#125;poll(10*time.Second) å›žåˆ°ç¬¬ä¸€ä¸ªä¾‹å­ï¼Œåœ¨ä¸€ä¸ªæ—¶é—´çž¬é—´åŠ ä¸Š 24 å°æ—¶ï¼Œæˆ‘ä»¬ç”¨äºŽæ·»åŠ æ—¶é—´çš„æ–¹æ³•å–å†³äºŽæ„å›¾ã€‚å¦‚æžœæˆ‘ä»¬æƒ³è¦ä¸‹ä¸€ä¸ªæ—¥åŽ†æ—¥(å½“å‰å¤©çš„ä¸‹ä¸€å¤©)çš„åŒä¸€ä¸ªæ—¶é—´ç‚¹ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.AddDateã€‚ä½†æ˜¯ï¼Œå¦‚æžœæˆ‘ä»¬æƒ³ä¿è¯æŸä¸€æ—¶åˆ»æ¯”å‰ä¸€æ—¶åˆ»æ™š 24 å°æ—¶ï¼Œæˆ‘ä»¬åº”è¯¥ä½¿ç”¨ Time.Addã€‚ 12newDay := t.AddDate(0 /* years */, 0, /* months */, 1 /* days */)maybeNewDay := t.Add(24 * time.Hour) å¯¹å¤–éƒ¨ç³»ç»Ÿä½¿ç”¨ time.Time å’Œ time.Durationå°½å¯èƒ½åœ¨ä¸Žå¤–éƒ¨ç³»ç»Ÿçš„äº¤äº’ä¸­ä½¿ç”¨ time.Duration å’Œ time.Time ä¾‹å¦‚ : Command-line æ ‡å¿—: flag é€šè¿‡ time.ParseDuration æ”¯æŒ time.Duration JSON: encoding/json é€šè¿‡å…¶ UnmarshalJSON method æ–¹æ³•æ”¯æŒå°† time.Time ç¼–ç ä¸º RFC 3339 å­—ç¬¦ä¸² SQL: database/sql æ”¯æŒå°† DATETIME æˆ– TIMESTAMP åˆ—è½¬æ¢ä¸º time.Timeï¼Œå¦‚æžœåº•å±‚é©±åŠ¨ç¨‹åºæ”¯æŒåˆ™è¿”å›ž YAML: gopkg.in/yaml.v2 æ”¯æŒå°† time.Time ä½œä¸º RFC 3339 å­—ç¬¦ä¸²ï¼Œå¹¶é€šè¿‡ time.ParseDuration æ”¯æŒ time.Durationã€‚ å½“ä¸èƒ½åœ¨è¿™äº›äº¤äº’ä¸­ä½¿ç”¨ time.Duration æ—¶ï¼Œè¯·ä½¿ç”¨ int æˆ– float64ï¼Œå¹¶åœ¨å­—æ®µåç§°ä¸­åŒ…å«å•ä½ã€‚ ä¾‹å¦‚ï¼Œç”±äºŽ encoding/json ä¸æ”¯æŒ time.Durationï¼Œå› æ­¤è¯¥å•ä½åŒ…å«åœ¨å­—æ®µçš„åç§°ä¸­ã€‚ BadGood1234// &#123;"interval": 2&#125;type Config struct &#123; Interval int `json:"interval"`&#125;1234// &#123;"intervalMillis": 2000&#125;type Config struct &#123; IntervalMillis int `json:"intervalMillis"`&#125; å½“åœ¨è¿™äº›äº¤äº’ä¸­ä¸èƒ½ä½¿ç”¨ time.Time æ—¶ï¼Œé™¤éžè¾¾æˆä¸€è‡´ï¼Œå¦åˆ™ä½¿ç”¨ string å’Œ RFC 3339 ä¸­å®šä¹‰çš„æ ¼å¼æ—¶é—´æˆ³ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒTime.UnmarshalText ä½¿ç”¨æ­¤æ ¼å¼ï¼Œå¹¶å¯é€šè¿‡ time.RFC3339 åœ¨ Time.Format å’Œ time.Parse ä¸­ä½¿ç”¨ã€‚ å°½ç®¡è¿™åœ¨å®žè·µä¸­å¹¶ä¸æˆé—®é¢˜ï¼Œä½†è¯·è®°ä½ï¼Œ&quot;time&quot; åŒ…ä¸æ”¯æŒè§£æžé—°ç§’æ—¶é—´æˆ³ï¼ˆ8728ï¼‰ï¼Œä¹Ÿä¸åœ¨è®¡ç®—ä¸­è€ƒè™‘é—°ç§’ï¼ˆ15190ï¼‰ã€‚å¦‚æžœæ‚¨æ¯”è¾ƒä¸¤ä¸ªæ—¶é—´çž¬é—´ï¼Œåˆ™å·®å¼‚å°†ä¸åŒ…æ‹¬è¿™ä¸¤ä¸ªçž¬é—´ä¹‹é—´å¯èƒ½å‘ç”Ÿçš„é—°ç§’ã€‚ é”™è¯¯ç±»åž‹Go ä¸­æœ‰å¤šç§å£°æ˜Žé”™è¯¯ï¼ˆError) çš„é€‰é¡¹ï¼š errors.New å¯¹äºŽç®€å•é™æ€å­—ç¬¦ä¸²çš„é”™è¯¯ fmt.Errorf ç”¨äºŽæ ¼å¼åŒ–çš„é”™è¯¯å­—ç¬¦ä¸² å®žçŽ° Error() æ–¹æ³•çš„è‡ªå®šä¹‰ç±»åž‹ ç”¨ &quot;pkg/errors&quot;.Wrap çš„ Wrapped errors è¿”å›žé”™è¯¯æ—¶ï¼Œè¯·è€ƒè™‘ä»¥ä¸‹å› ç´ ä»¥ç¡®å®šæœ€ä½³é€‰æ‹©ï¼š è¿™æ˜¯ä¸€ä¸ªä¸éœ€è¦é¢å¤–ä¿¡æ¯çš„ç®€å•é”™è¯¯å—ï¼Ÿå¦‚æžœæ˜¯è¿™æ ·ï¼Œerrors.New è¶³å¤Ÿäº†ã€‚ å®¢æˆ·éœ€è¦æ£€æµ‹å¹¶å¤„ç†æ­¤é”™è¯¯å—ï¼Ÿå¦‚æžœæ˜¯è¿™æ ·ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹å¹¶å®žçŽ°è¯¥ Error() æ–¹æ³•ã€‚ æ‚¨æ˜¯å¦æ­£åœ¨ä¼ æ’­ä¸‹æ¸¸å‡½æ•°è¿”å›žçš„é”™è¯¯ï¼Ÿå¦‚æžœæ˜¯è¿™æ ·ï¼Œè¯·æŸ¥çœ‹æœ¬æ–‡åŽé¢æœ‰å…³é”™è¯¯åŒ…è£… section on error wrapping) éƒ¨åˆ†çš„å†…å®¹ã€‚ å¦åˆ™ fmt.Errorf å°±å¯ä»¥äº†ã€‚ å¦‚æžœå®¢æˆ·ç«¯éœ€è¦æ£€æµ‹é”™è¯¯ï¼Œå¹¶ä¸”æ‚¨å·²ä½¿ç”¨åˆ›å»ºäº†ä¸€ä¸ªç®€å•çš„é”™è¯¯ errors.Newï¼Œè¯·ä½¿ç”¨ä¸€ä¸ªé”™è¯¯å˜é‡ã€‚ BadGood1234567891011121314151617// package foofunc Open() error &#123; return errors.New("could not open")&#125;// package barfunc use() &#123; if err := foo.Open(); err != nil &#123; if err.Error() == "could not open" &#123; // handle &#125; else &#123; panic("unknown error") &#125; &#125;&#125;1234567891011121314151617// package foovar ErrCouldNotOpen = errors.New("could not open")func Open() error &#123; return ErrCouldNotOpen&#125;// package barif err := foo.Open(); err != nil &#123; if err == foo.ErrCouldNotOpen &#123; // handle &#125; else &#123; panic("unknown error") &#125;&#125; å¦‚æžœæ‚¨æœ‰å¯èƒ½éœ€è¦å®¢æˆ·ç«¯æ£€æµ‹çš„é”™è¯¯ï¼Œå¹¶ä¸”æƒ³å‘å…¶ä¸­æ·»åŠ æ›´å¤šä¿¡æ¯ï¼ˆä¾‹å¦‚ï¼Œå®ƒä¸æ˜¯é™æ€å­—ç¬¦ä¸²ï¼‰ï¼Œåˆ™åº”ä½¿ç”¨è‡ªå®šä¹‰ç±»åž‹ã€‚ BadGood12345678910111213func open(file string) error &#123; return fmt.Errorf("file %q not found", file)&#125;func use() &#123; if err := open("testfile.txt"); err != nil &#123; if strings.Contains(err.Error(), "not found") &#123; // handle &#125; else &#123; panic("unknown error") &#125; &#125;&#125;123456789101112131415161718192021type errNotFound struct &#123; file string&#125;func (e errNotFound) Error() string &#123; return fmt.Sprintf("file %q not found", e.file)&#125;func open(file string) error &#123; return errNotFound&#123;file: file&#125;&#125;func use() &#123; if err := open("testfile.txt"); err != nil &#123; if _, ok := err.(errNotFound); ok &#123; // handle &#125; else &#123; panic("unknown error") &#125; &#125;&#125; ç›´æŽ¥å¯¼å‡ºè‡ªå®šä¹‰é”™è¯¯ç±»åž‹æ—¶è¦å°å¿ƒï¼Œå› ä¸ºå®ƒä»¬å·²æˆä¸ºç¨‹åºåŒ…å…¬å…± API çš„ä¸€éƒ¨åˆ†ã€‚æœ€å¥½å…¬å¼€åŒ¹é…å™¨åŠŸèƒ½ä»¥æ£€æŸ¥é”™è¯¯ã€‚ 12345678910111213141516171819202122232425262728// package footype errNotFound struct &#123; file string&#125;func (e errNotFound) Error() string &#123; return fmt.Sprintf("file %q not found", e.file)&#125;func IsNotFoundError(err error) bool &#123; _, ok := err.(errNotFound) return ok&#125;func Open(file string) error &#123; return errNotFound&#123;file: file&#125;&#125;// package barif err := foo.Open("foo"); err != nil &#123; if foo.IsNotFoundError(err) &#123; // handle &#125; else &#123; panic("unknown error") &#125;&#125; é”™è¯¯åŒ…è£… (Error Wrapping)ä¸€ä¸ªï¼ˆå‡½æ•°/æ–¹æ³•ï¼‰è°ƒç”¨å¤±è´¥æ—¶ï¼Œæœ‰ä¸‰ç§ä¸»è¦çš„é”™è¯¯ä¼ æ’­æ–¹å¼ï¼š å¦‚æžœæ²¡æœ‰è¦æ·»åŠ çš„å…¶ä»–ä¸Šä¸‹æ–‡ï¼Œå¹¶ä¸”æ‚¨æƒ³è¦ç»´æŠ¤åŽŸå§‹é”™è¯¯ç±»åž‹ï¼Œåˆ™è¿”å›žåŽŸå§‹é”™è¯¯ã€‚ æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä½¿ç”¨ &quot;pkg/errors&quot;.Wrap ä»¥ä¾¿é”™è¯¯æ¶ˆæ¯æä¾›æ›´å¤šä¸Šä¸‹æ–‡ ,&quot;pkg/errors&quot;.Cause å¯ç”¨äºŽæå–åŽŸå§‹é”™è¯¯ã€‚ å¦‚æžœè°ƒç”¨è€…ä¸éœ€è¦æ£€æµ‹æˆ–å¤„ç†çš„ç‰¹å®šé”™è¯¯æƒ…å†µï¼Œä½¿ç”¨ fmt.Errorfã€‚ å»ºè®®åœ¨å¯èƒ½çš„åœ°æ–¹æ·»åŠ ä¸Šä¸‹æ–‡ï¼Œä»¥ä½¿æ‚¨èŽ·å¾—è¯¸å¦‚â€œè°ƒç”¨æœåŠ¡ fooï¼šè¿žæŽ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ›´æœ‰ç”¨çš„é”™è¯¯ï¼Œè€Œä¸æ˜¯è¯¸å¦‚â€œè¿žæŽ¥è¢«æ‹’ç»â€ä¹‹ç±»çš„æ¨¡ç³Šé”™è¯¯ã€‚ åœ¨å°†ä¸Šä¸‹æ–‡æ·»åŠ åˆ°è¿”å›žçš„é”™è¯¯æ—¶ï¼Œè¯·é¿å…ä½¿ç”¨â€œfailed toâ€ä¹‹ç±»çš„çŸ­è¯­ä»¥ä¿æŒä¸Šä¸‹æ–‡ç®€æ´ï¼Œè¿™äº›çŸ­è¯­ä¼šé™ˆè¿°æ˜Žæ˜¾çš„å†…å®¹ï¼Œå¹¶éšç€é”™è¯¯åœ¨å †æ ˆä¸­çš„æ¸—é€è€Œé€æ¸å †ç§¯ï¼š BadGood12345s, err := store.New()if err != nil &#123; return fmt.Errorf( "failed to create new store: %s", err)&#125;12345s, err := store.New()if err != nil &#123; return fmt.Errorf( "new store: %s", err)&#125;1failed to x: failed to y: failed to create new store: the error1x: y: new store: the error ä½†æ˜¯ï¼Œä¸€æ—¦å°†é”™è¯¯å‘é€åˆ°å¦ä¸€ä¸ªç³»ç»Ÿï¼Œå°±åº”è¯¥æ˜Žç¡®æ¶ˆæ¯æ˜¯é”™è¯¯æ¶ˆæ¯ï¼ˆä¾‹å¦‚ä½¿ç”¨erræ ‡è®°ï¼Œæˆ–åœ¨æ—¥å¿—ä¸­ä»¥â€Failedâ€ä¸ºå‰ç¼€ï¼‰ã€‚ å¦è¯·å‚è§ Donâ€™t just check errors, handle them gracefully. ä¸è¦åªæ˜¯æ£€æŸ¥é”™è¯¯ï¼Œè¦ä¼˜é›…åœ°å¤„ç†é”™è¯¯ å¤„ç†ç±»åž‹æ–­è¨€å¤±è´¥type assertion çš„å•ä¸ªè¿”å›žå€¼å½¢å¼é’ˆå¯¹ä¸æ­£ç¡®çš„ç±»åž‹å°†äº§ç”Ÿ panicã€‚å› æ­¤ï¼Œè¯·å§‹ç»ˆä½¿ç”¨â€œcomma okâ€çš„æƒ¯ç”¨æ³•ã€‚ BadGood1t := i.(string)1234t, ok := i.(string)if !ok &#123; // ä¼˜é›…åœ°å¤„ç†é”™è¯¯&#125; ä¸è¦ panicåœ¨ç”Ÿäº§çŽ¯å¢ƒä¸­è¿è¡Œçš„ä»£ç å¿…é¡»é¿å…å‡ºçŽ° panicã€‚panic æ˜¯ cascading failures çº§è”å¤±è´¥çš„ä¸»è¦æ ¹æº ã€‚å¦‚æžœå‘ç”Ÿé”™è¯¯ï¼Œè¯¥å‡½æ•°å¿…é¡»è¿”å›žé”™è¯¯ï¼Œå¹¶å…è®¸è°ƒç”¨æ–¹å†³å®šå¦‚ä½•å¤„ç†å®ƒã€‚ BadGood1234567891011121314func foo(bar string) &#123; if len(bar) == 0 &#123; panic("bar must not be empty") &#125; // ...&#125;func main() &#123; if len(os.Args) != 2 &#123; fmt.Println("USAGE: foo &lt;bar&gt;") os.Exit(1) &#125; foo(os.Args[1])&#125;1234567891011121314151617func foo(bar string) error &#123; if len(bar) == 0 &#123; return errors.New("bar must not be empty") &#125; // ... return nil&#125;func main() &#123; if len(os.Args) != 2 &#123; fmt.Println("USAGE: foo &lt;bar&gt;") os.Exit(1) &#125; if err := foo(os.Args[1]); err != nil &#123; panic(err) &#125;&#125; panic/recover ä¸æ˜¯é”™è¯¯å¤„ç†ç­–ç•¥ã€‚ä»…å½“å‘ç”Ÿä¸å¯æ¢å¤çš„äº‹æƒ…ï¼ˆä¾‹å¦‚ï¼šnil å¼•ç”¨ï¼‰æ—¶ï¼Œç¨‹åºæ‰å¿…é¡» panicã€‚ç¨‹åºåˆå§‹åŒ–æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼šç¨‹åºå¯åŠ¨æ—¶åº”ä½¿ç¨‹åºä¸­æ­¢çš„ä¸è‰¯æƒ…å†µå¯èƒ½ä¼šå¼•èµ· panicã€‚ 1var _statusTemplate = template.Must(template.New("name").Parse("_statusHTML")) å³ä½¿åœ¨æµ‹è¯•ä»£ç ä¸­ï¼Œä¹Ÿä¼˜å…ˆä½¿ç”¨t.Fatalæˆ–è€…t.FailNowè€Œä¸æ˜¯ panic æ¥ç¡®ä¿å¤±è´¥è¢«æ ‡è®°ã€‚ BadGood123456// func TestFoo(t *testing.T)f, err := ioutil.TempFile("", "test")if err != nil &#123; panic("failed to set up test")&#125;123456// func TestFoo(t *testing.T)f, err := ioutil.TempFile("", "test")if err != nil &#123; t.Fatal("failed to set up test")&#125; ä½¿ç”¨ go.uber.org/atomicä½¿ç”¨ sync/atomic åŒ…çš„åŽŸå­æ“ä½œå¯¹åŽŸå§‹ç±»åž‹ (int32, int64ç­‰ï¼‰è¿›è¡Œæ“ä½œï¼Œå› ä¸ºå¾ˆå®¹æ˜“å¿˜è®°ä½¿ç”¨åŽŸå­æ“ä½œæ¥è¯»å–æˆ–ä¿®æ”¹å˜é‡ã€‚ go.uber.org/atomic é€šè¿‡éšè—åŸºç¡€ç±»åž‹ä¸ºè¿™äº›æ“ä½œå¢žåŠ äº†ç±»åž‹å®‰å…¨æ€§ã€‚æ­¤å¤–ï¼Œå®ƒåŒ…æ‹¬ä¸€ä¸ªæ–¹ä¾¿çš„atomic.Boolç±»åž‹ã€‚ BadGood123456789101112131415type foo struct &#123; running int32 // atomic&#125;func (f* foo) start() &#123; if atomic.SwapInt32(&amp;f.running, 1) == 1 &#123; // already runningâ€¦ return &#125; // start the Foo&#125;func (f *foo) isRunning() bool &#123; return f.running == 1 // race!&#125;123456789101112131415type foo struct &#123; running atomic.Bool&#125;func (f *foo) start() &#123; if f.running.Swap(true) &#123; // already runningâ€¦ return &#125; // start the Foo&#125;func (f *foo) isRunning() bool &#123; return f.running.Load()&#125; é¿å…å¯å˜å…¨å±€å˜é‡ä½¿ç”¨é€‰æ‹©ä¾èµ–æ³¨å…¥æ–¹å¼é¿å…æ”¹å˜å…¨å±€å˜é‡ã€‚æ—¢é€‚ç”¨äºŽå‡½æ•°æŒ‡é’ˆåˆé€‚ç”¨äºŽå…¶ä»–å€¼ç±»åž‹ BadGood123456// sign.govar _timeNow = time.Nowfunc sign(msg string) string &#123; now := _timeNow() return signWithTime(msg, now)&#125;12345678910111213// sign.gotype signer struct &#123; now func() time.Time&#125;func newSigner() *signer &#123; return &amp;signer&#123; now: time.Now, &#125;&#125;func (s *signer) Sign(msg string) string &#123; now := s.now() return signWithTime(msg, now)&#125;123456789// sign_test.gofunc TestSign(t *testing.T) &#123; oldTimeNow := _timeNow _timeNow = func() time.Time &#123; return someFixedTime &#125; defer func() &#123; _timeNow = oldTimeNow &#125;() assert.Equal(t, want, sign(give))&#125;12345678// sign_test.gofunc TestSigner(t *testing.T) &#123; s := newSigner() s.now = func() time.Time &#123; return someFixedTime &#125; assert.Equal(t, want, s.Sign(give))&#125; é¿å…åœ¨å…¬å…±ç»“æž„ä¸­åµŒå…¥ç±»åž‹è¿™äº›åµŒå…¥çš„ç±»åž‹æ³„æ¼å®žçŽ°ç»†èŠ‚ã€ç¦æ­¢ç±»åž‹æ¼”åŒ–å’Œæ¨¡ç³Šçš„æ–‡æ¡£ã€‚ å‡è®¾æ‚¨ä½¿ç”¨å…±äº«çš„ AbstractList å®žçŽ°äº†å¤šç§åˆ—è¡¨ç±»åž‹ï¼Œè¯·é¿å…åœ¨å…·ä½“çš„åˆ—è¡¨å®žçŽ°ä¸­åµŒå…¥ AbstractListã€‚ç›¸åï¼Œåªéœ€æ‰‹åŠ¨å°†æ–¹æ³•å†™å…¥å…·ä½“çš„åˆ—è¡¨ï¼Œè¯¥åˆ—è¡¨å°†å§”æ‰˜ç»™æŠ½è±¡åˆ—è¡¨ã€‚ 123456789type AbstractList struct &#123;&#125;// æ·»åŠ å°†å®žä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚func (l *AbstractList) Add(e Entity) &#123; // ...&#125;// ç§»é™¤ä»Žåˆ—è¡¨ä¸­ç§»é™¤å®žä½“ã€‚func (l *AbstractList) Remove(e Entity) &#123; // ...&#125; BadGood1234// ConcreteList æ˜¯ä¸€ä¸ªå®žä½“åˆ—è¡¨ã€‚type ConcreteList struct &#123; *AbstractList&#125;123456789101112// ConcreteList æ˜¯ä¸€ä¸ªå®žä½“åˆ—è¡¨ã€‚type ConcreteList struct &#123; list *AbstractList&#125;// æ·»åŠ å°†å®žä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚func (l *ConcreteList) Add(e Entity) &#123; return l.list.Add(e)&#125;// ç§»é™¤ä»Žåˆ—è¡¨ä¸­ç§»é™¤å®žä½“ã€‚func (l *ConcreteList) Remove(e Entity) &#123; return l.list.Remove(e)&#125; Go å…è®¸ ç±»åž‹åµŒå…¥ ä½œä¸ºç»§æ‰¿å’Œç»„åˆä¹‹é—´çš„æŠ˜è¡·ã€‚å¤–éƒ¨ç±»åž‹èŽ·å–åµŒå…¥ç±»åž‹çš„æ–¹æ³•çš„éšå¼å‰¯æœ¬ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™äº›æ–¹æ³•å§”æ‰˜ç»™åµŒå…¥å®žä¾‹çš„åŒä¸€æ–¹æ³•ã€‚ ç»“æž„è¿˜èŽ·å¾—ä¸Žç±»åž‹åŒåçš„å­—æ®µã€‚æ‰€ä»¥ï¼Œå¦‚æžœåµŒå…¥çš„ç±»åž‹æ˜¯ publicï¼Œé‚£ä¹ˆå­—æ®µæ˜¯ publicã€‚ä¸ºäº†ä¿æŒå‘åŽå…¼å®¹æ€§ï¼Œå¤–éƒ¨ç±»åž‹çš„æ¯ä¸ªæœªæ¥ç‰ˆæœ¬éƒ½å¿…é¡»ä¿ç•™åµŒå…¥ç±»åž‹ã€‚ å¾ˆå°‘éœ€è¦åµŒå…¥ç±»åž‹ã€‚è¿™æ˜¯ä¸€ç§æ–¹ä¾¿ï¼Œå¯ä»¥å¸®åŠ©æ‚¨é¿å…ç¼–å†™å†—é•¿çš„å§”æ‰˜æ–¹æ³•ã€‚ å³ä½¿åµŒå…¥å…¼å®¹çš„æŠ½è±¡åˆ—è¡¨ interfaceï¼Œè€Œä¸æ˜¯ç»“æž„ä½“ï¼Œè¿™å°†ä¸ºå¼€å‘äººå‘˜æä¾›æ›´å¤§çš„çµæ´»æ€§æ¥æ”¹å˜æœªæ¥ï¼Œä½†ä»ç„¶æ³„éœ²äº†å…·ä½“åˆ—è¡¨ä½¿ç”¨æŠ½è±¡å®žçŽ°çš„ç»†èŠ‚ã€‚ BadGood123456789// AbstractList æ˜¯å„ç§å®žä½“åˆ—è¡¨çš„é€šç”¨å®žçŽ°ã€‚type AbstractList interface &#123; Add(Entity) Remove(Entity)&#125;// ConcreteList æ˜¯ä¸€ä¸ªå®žä½“åˆ—è¡¨ã€‚type ConcreteList struct &#123; AbstractList&#125;123456789101112// ConcreteList æ˜¯ä¸€ä¸ªå®žä½“åˆ—è¡¨ã€‚type ConcreteList struct &#123; list *AbstractList&#125;// æ·»åŠ å°†å®žä½“æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚func (l *ConcreteList) Add(e Entity) &#123; return l.list.Add(e)&#125;// ç§»é™¤ä»Žåˆ—è¡¨ä¸­ç§»é™¤å®žä½“ã€‚func (l *ConcreteList) Remove(e Entity) &#123; return l.list.Remove(e)&#125; æ— è®ºæ˜¯ä½¿ç”¨åµŒå…¥å¼ç»“æž„è¿˜æ˜¯ä½¿ç”¨åµŒå…¥å¼æŽ¥å£ï¼ŒåµŒå…¥å¼ç±»åž‹éƒ½ä¼šé™åˆ¶ç±»åž‹çš„æ¼”åŒ–. å‘åµŒå…¥å¼æŽ¥å£æ·»åŠ æ–¹æ³•æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ åˆ é™¤åµŒå…¥ç±»åž‹æ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å³ä½¿ä½¿ç”¨æ»¡è¶³ç›¸åŒæŽ¥å£çš„æ›¿ä»£æ–¹æ³•æ›¿æ¢åµŒå…¥ç±»åž‹ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªç ´åæ€§çš„æ”¹å˜ã€‚ å°½ç®¡ç¼–å†™è¿™äº›å§”æ‰˜æ–¹æ³•æ˜¯ä¹å‘³çš„ï¼Œä½†æ˜¯é¢å¤–çš„å·¥ä½œéšè—äº†å®žçŽ°ç»†èŠ‚ï¼Œç•™ä¸‹äº†æ›´å¤šçš„æ›´æ”¹æœºä¼šï¼Œè¿˜æ¶ˆé™¤äº†åœ¨æ–‡æ¡£ä¸­å‘çŽ°å®Œæ•´åˆ—è¡¨æŽ¥å£çš„é—´æŽ¥æ€§æ“ä½œã€‚ é¿å…ä½¿ç”¨å†…ç½®åç§°Goè¯­è¨€è§„èŒƒlanguage specification æ¦‚è¿°äº†å‡ ä¸ªå†…ç½®çš„ï¼Œä¸åº”åœ¨Goé¡¹ç›®ä¸­ä½¿ç”¨çš„åç§°æ ‡è¯†predeclared identifiersã€‚ æ ¹æ®ä¸Šä¸‹æ–‡çš„ä¸åŒï¼Œå°†è¿™äº›æ ‡è¯†ç¬¦ä½œä¸ºåç§°é‡å¤ä½¿ç”¨ï¼Œå°†åœ¨å½“å‰ä½œç”¨åŸŸï¼ˆæˆ–ä»»ä½•åµŒå¥—ä½œç”¨åŸŸï¼‰ä¸­éšè—åŽŸå§‹æ ‡è¯†ç¬¦ï¼Œæˆ–è€…æ··æ·†ä»£ç ã€‚åœ¨æœ€å¥½çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæŠ¥é”™ï¼›åœ¨æœ€åçš„æƒ…å†µä¸‹ï¼Œè¿™æ ·çš„ä»£ç å¯èƒ½ä¼šå¼•å…¥æ½œåœ¨çš„ã€éš¾ä»¥æ¢å¤çš„é”™è¯¯ã€‚ BadGood12345678var error string// `error` ä½œç”¨åŸŸéšå¼è¦†ç›–// orfunc handleErrorMessage(error string) &#123; // `error` ä½œç”¨åŸŸéšå¼è¦†ç›–&#125;12345678var errorMessage string// `error` æŒ‡å‘å†…ç½®çš„éžè¦†ç›–// orfunc handleErrorMessage(msg string) &#123; // `error` æŒ‡å‘å†…ç½®çš„éžè¦†ç›–&#125;123456789101112131415type Foo struct &#123; // è™½ç„¶è¿™äº›å­—æ®µåœ¨æŠ€æœ¯ä¸Šä¸æž„æˆé˜´å½±ï¼Œä½†`error`æˆ–`string`å­—ç¬¦ä¸²çš„é‡æ˜ å°„çŽ°åœ¨æ˜¯ä¸æ˜Žç¡®çš„ã€‚ error error string string&#125;func (f Foo) Error() error &#123; // `error` å’Œ `f.error` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.error&#125;func (f Foo) String() string &#123; // `string` and `f.string` åœ¨è§†è§‰ä¸Šæ˜¯ç›¸ä¼¼çš„ return f.string&#125;12345678910111213type Foo struct &#123; // `error` and `string` çŽ°åœ¨æ˜¯æ˜Žç¡®çš„ã€‚ err error str string&#125;func (f Foo) Error() error &#123; return f.err&#125;func (f Foo) String() string &#123; return f.str&#125; æ³¨æ„ï¼Œç¼–è¯‘å™¨åœ¨ä½¿ç”¨é¢„å…ˆåˆ†éš”çš„æ ‡è¯†ç¬¦æ—¶ä¸ä¼šç”Ÿæˆé”™è¯¯ï¼Œä½†æ˜¯è¯¸å¦‚go vetä¹‹ç±»çš„å·¥å…·ä¼šæ­£ç¡®åœ°æŒ‡å‡ºè¿™äº›å’Œå…¶ä»–æƒ…å†µä¸‹çš„éšå¼é—®é¢˜ã€‚ æ€§èƒ½æ€§èƒ½æ–¹é¢çš„ç‰¹å®šå‡†åˆ™åªé€‚ç”¨äºŽé«˜é¢‘åœºæ™¯ã€‚ ä¼˜å…ˆä½¿ç”¨ strconv è€Œä¸æ˜¯ fmtå°†åŽŸè¯­è½¬æ¢ä¸ºå­—ç¬¦ä¸²æˆ–ä»Žå­—ç¬¦ä¸²è½¬æ¢æ—¶ï¼Œstrconvé€Ÿåº¦æ¯”fmtå¿«ã€‚ BadGood123for i := 0; i &lt; b.N; i++ &#123; s := fmt.Sprint(rand.Int())&#125;123for i := 0; i &lt; b.N; i++ &#123; s := strconv.Itoa(rand.Int())&#125;1BenchmarkFmtSprint-4 143 ns/op 2 allocs/op1BenchmarkStrconv-4 64.2 ns/op 1 allocs/op é¿å…å­—ç¬¦ä¸²åˆ°å­—èŠ‚çš„è½¬æ¢ä¸è¦åå¤ä»Žå›ºå®šå­—ç¬¦ä¸²åˆ›å»ºå­—èŠ‚ sliceã€‚ç›¸åï¼Œè¯·æ‰§è¡Œä¸€æ¬¡è½¬æ¢å¹¶æ•èŽ·ç»“æžœã€‚ BadGood123for i := 0; i &lt; b.N; i++ &#123; w.Write([]byte("Hello world"))&#125;1234data := []byte("Hello world")for i := 0; i &lt; b.N; i++ &#123; w.Write(data)&#125;1BenchmarkBad-4 50000000 22.2 ns/op1BenchmarkGood-4 500000000 3.25 ns/op å°½é‡åˆå§‹åŒ–æ—¶æŒ‡å®š Map å®¹é‡åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œåœ¨ä½¿ç”¨ make() åˆå§‹åŒ–çš„æ—¶å€™æä¾›å®¹é‡ä¿¡æ¯ 1make(map[T1]T2, hint) ä¸º make() æä¾›å®¹é‡ä¿¡æ¯ï¼ˆhintï¼‰å°è¯•åœ¨åˆå§‹åŒ–æ—¶è°ƒæ•´ map å¤§å°ï¼Œè¿™å‡å°‘äº†åœ¨å°†å…ƒç´ æ·»åŠ åˆ° map æ—¶å¢žé•¿å’Œåˆ†é…çš„å¼€é”€ã€‚æ³¨æ„ï¼Œmap ä¸èƒ½ä¿è¯åˆ†é… hint ä¸ªå®¹é‡ã€‚å› æ­¤ï¼Œå³ä½¿æä¾›äº†å®¹é‡ï¼Œæ·»åŠ å…ƒç´ ä»ç„¶å¯ä»¥è¿›è¡Œåˆ†é…ã€‚ BadGood123456m := make(map[string]os.FileInfo)files, _ := ioutil.ReadDir("./files")for _, f := range files &#123; m[f.Name()] = f&#125;1234567files, _ := ioutil.ReadDir("./files")m := make(map[string]os.FileInfo, len(files))for _, f := range files &#123; m[f.Name()] = f&#125;m æ˜¯åœ¨æ²¡æœ‰å¤§å°æç¤ºçš„æƒ…å†µä¸‹åˆ›å»ºçš„ï¼› åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å¤šåˆ†é…ã€‚m æ˜¯æœ‰å¤§å°æç¤ºåˆ›å»ºçš„ï¼›åœ¨è¿è¡Œæ—¶å¯èƒ½ä¼šæœ‰æ›´å°‘çš„åˆ†é…ã€‚ è§„èŒƒä¸€è‡´æ€§æœ¬æ–‡ä¸­æ¦‚è¿°çš„ä¸€äº›æ ‡å‡†éƒ½æ˜¯å®¢è§‚æ€§çš„è¯„ä¼°ï¼Œæ˜¯æ ¹æ®åœºæ™¯ã€ä¸Šä¸‹æ–‡ã€æˆ–è€…ä¸»è§‚æ€§çš„åˆ¤æ–­ï¼› ä½†æ˜¯æœ€é‡è¦çš„æ˜¯ï¼Œä¿æŒä¸€è‡´. ä¸€è‡´æ€§çš„ä»£ç æ›´å®¹æ˜“ç»´æŠ¤ã€æ˜¯æ›´åˆç†çš„ã€éœ€è¦æ›´å°‘çš„å­¦ä¹ æˆæœ¬ã€å¹¶ä¸”éšç€æ–°çš„çº¦å®šå‡ºçŽ°æˆ–è€…å‡ºçŽ°é”™è¯¯åŽæ›´å®¹æ˜“è¿ç§»ã€æ›´æ–°ã€ä¿®å¤ bug ç›¸åï¼Œä¸€ä¸ªå•ä¸€çš„ä»£ç åº“ä¼šå¯¼è‡´ç»´æŠ¤æˆæœ¬å¼€é”€ã€ä¸ç¡®å®šæ€§å’Œè®¤çŸ¥åå·®ã€‚æ‰€æœ‰è¿™äº›éƒ½ä¼šç›´æŽ¥å¯¼è‡´é€Ÿåº¦é™ä½Žã€ä»£ç å®¡æŸ¥ç—›è‹¦ã€è€Œä¸”å¢žåŠ  bug æ•°é‡ å°†è¿™äº›æ ‡å‡†åº”ç”¨äºŽä»£ç åº“æ—¶ï¼Œå»ºè®®åœ¨ packageï¼ˆæˆ–æ›´å¤§ï¼‰çº§åˆ«è¿›è¡Œæ›´æ”¹ï¼Œå­åŒ…çº§åˆ«çš„åº”ç”¨ç¨‹åºé€šè¿‡å°†å¤šä¸ªæ ·å¼å¼•å…¥åˆ°åŒä¸€ä»£ç ä¸­ï¼Œè¿åäº†ä¸Šè¿°å…³æ³¨ç‚¹ã€‚ ç›¸ä¼¼çš„å£°æ˜Žæ”¾åœ¨ä¸€ç»„Go è¯­è¨€æ”¯æŒå°†ç›¸ä¼¼çš„å£°æ˜Žæ”¾åœ¨ä¸€ä¸ªç»„å†…ã€‚ BadGood12import "a"import "b"1234import ( "a" "b") è¿™åŒæ ·é€‚ç”¨äºŽå¸¸é‡ã€å˜é‡å’Œç±»åž‹å£°æ˜Žï¼š BadGood123456789const a = 1const b = 2var a = 1var b = 2type Area float64type Volume float641234567891011121314const ( a = 1 b = 2)var ( a = 1 b = 2)type ( Area float64 Volume float64) ä»…å°†ç›¸å…³çš„å£°æ˜Žæ”¾åœ¨ä¸€ç»„ã€‚ä¸è¦å°†ä¸ç›¸å…³çš„å£°æ˜Žæ”¾åœ¨ä¸€ç»„ã€‚ BadGood12345678type Operation intconst ( Add Operation = iota + 1 Subtract Multiply ENV_VAR = "MY_ENV")123456789type Operation intconst ( Add Operation = iota + 1 Subtract Multiply)const ENV_VAR = "MY_ENV" åˆ†ç»„ä½¿ç”¨çš„ä½ç½®æ²¡æœ‰é™åˆ¶ï¼Œä¾‹å¦‚ï¼šä½ å¯ä»¥åœ¨å‡½æ•°å†…éƒ¨ä½¿ç”¨å®ƒä»¬ï¼š BadGood1234567func f() string &#123; var red = color.New(0xff0000) var green = color.New(0x00ff00) var blue = color.New(0x0000ff) ...&#125;123456789func f() string &#123; var ( red = color.New(0xff0000) green = color.New(0x00ff00) blue = color.New(0x0000ff) ) ...&#125; import åˆ†ç»„å¯¼å…¥åº”è¯¥åˆ†ä¸ºä¸¤ç»„ï¼š æ ‡å‡†åº“ å…¶ä»–åº“ é»˜è®¤æƒ…å†µä¸‹ï¼Œè¿™æ˜¯ goimports åº”ç”¨çš„åˆ†ç»„ã€‚ BadGood123456import ( "fmt" "os" "go.uber.org/atomic" "golang.org/x/sync/errgroup")1234567import ( "fmt" "os" "go.uber.org/atomic" "golang.org/x/sync/errgroup") åŒ…åå½“å‘½ååŒ…æ—¶ï¼Œè¯·æŒ‰ä¸‹é¢è§„åˆ™é€‰æ‹©ä¸€ä¸ªåç§°ï¼š å…¨éƒ¨å°å†™ã€‚æ²¡æœ‰å¤§å†™æˆ–ä¸‹åˆ’çº¿ã€‚ å¤§å¤šæ•°ä½¿ç”¨å‘½åå¯¼å…¥çš„æƒ…å†µä¸‹ï¼Œä¸éœ€è¦é‡å‘½åã€‚ ç®€çŸ­è€Œç®€æ´ã€‚è¯·è®°ä½ï¼Œåœ¨æ¯ä¸ªä½¿ç”¨çš„åœ°æ–¹éƒ½å®Œæ•´æ ‡è¯†äº†è¯¥åç§°ã€‚ ä¸ç”¨å¤æ•°ã€‚ä¾‹å¦‚net/urlï¼Œè€Œä¸æ˜¯net/urlsã€‚ ä¸è¦ç”¨â€œcommonâ€ï¼Œâ€œutilâ€ï¼Œâ€œsharedâ€æˆ–â€œlibâ€ã€‚è¿™äº›æ˜¯ä¸å¥½çš„ï¼Œä¿¡æ¯é‡ä¸è¶³çš„åç§°ã€‚ å¦è¯·å‚é˜… Package Names å’Œ Go åŒ…æ ·å¼æŒ‡å—. å‡½æ•°åæˆ‘ä»¬éµå¾ª Go ç¤¾åŒºå…³äºŽä½¿ç”¨ MixedCaps ä½œä¸ºå‡½æ•°å çš„çº¦å®šã€‚æœ‰ä¸€ä¸ªä¾‹å¤–ï¼Œä¸ºäº†å¯¹ç›¸å…³çš„æµ‹è¯•ç”¨ä¾‹è¿›è¡Œåˆ†ç»„ï¼Œå‡½æ•°åå¯èƒ½åŒ…å«ä¸‹åˆ’çº¿ï¼Œå¦‚ï¼šTestMyFunction_WhatIsBeingTested. å¯¼å…¥åˆ«åå¦‚æžœç¨‹åºåŒ…åç§°ä¸Žå¯¼å…¥è·¯å¾„çš„æœ€åŽä¸€ä¸ªå…ƒç´ ä¸åŒ¹é…ï¼Œåˆ™å¿…é¡»ä½¿ç”¨å¯¼å…¥åˆ«åã€‚ 123456import ( "net/http" client "example.com/client-go" trace "example.com/trace/v2") åœ¨æ‰€æœ‰å…¶ä»–æƒ…å†µä¸‹ï¼Œé™¤éžå¯¼å…¥ä¹‹é—´æœ‰ç›´æŽ¥å†²çªï¼Œå¦åˆ™åº”é¿å…å¯¼å…¥åˆ«åã€‚ BadGood123456import ( "fmt" "os" nettrace "golang.net/x/trace")1234567import ( "fmt" "os" "runtime/trace" nettrace "golang.net/x/trace") å‡½æ•°åˆ†ç»„ä¸Žé¡ºåº å‡½æ•°åº”æŒ‰ç²—ç•¥çš„è°ƒç”¨é¡ºåºæŽ’åºã€‚ åŒä¸€æ–‡ä»¶ä¸­çš„å‡½æ•°åº”æŒ‰æŽ¥æ”¶è€…åˆ†ç»„ã€‚ å› æ­¤ï¼Œå¯¼å‡ºçš„å‡½æ•°åº”å…ˆå‡ºçŽ°åœ¨æ–‡ä»¶ä¸­ï¼Œæ”¾åœ¨struct, const, varå®šä¹‰çš„åŽé¢ã€‚ åœ¨å®šä¹‰ç±»åž‹ä¹‹åŽï¼Œä½†åœ¨æŽ¥æ”¶è€…çš„å…¶ä½™æ–¹æ³•ä¹‹å‰ï¼Œå¯èƒ½ä¼šå‡ºçŽ°ä¸€ä¸ª newXYZ()/NewXYZ() ç”±äºŽå‡½æ•°æ˜¯æŒ‰æŽ¥æ”¶è€…åˆ†ç»„çš„ï¼Œå› æ­¤æ™®é€šå·¥å…·å‡½æ•°åº”åœ¨æ–‡ä»¶æœ«å°¾å‡ºçŽ°ã€‚ BadGood12345678910111213func (s *something) Cost() &#123; return calcCost(s.weights)&#125;type something struct&#123; ... &#125;func calcCost(n []int) int &#123;...&#125;func (s *something) Stop() &#123;...&#125;func newSomething() *something &#123; return &amp;something&#123;&#125;&#125;12345678910111213type something struct&#123; ... &#125;func newSomething() *something &#123; return &amp;something&#123;&#125;&#125;func (s *something) Cost() &#123; return calcCost(s.weights)&#125;func (s *something) Stop() &#123;...&#125;func calcCost(n []int) int &#123;...&#125; å‡å°‘åµŒå¥—ä»£ç åº”é€šè¿‡å°½å¯èƒ½å…ˆå¤„ç†é”™è¯¯æƒ…å†µ/ç‰¹æ®Šæƒ…å†µå¹¶å°½æ—©è¿”å›žæˆ–ç»§ç»­å¾ªçŽ¯æ¥å‡å°‘åµŒå¥—ã€‚å‡å°‘åµŒå¥—å¤šä¸ªçº§åˆ«çš„ä»£ç çš„ä»£ç é‡ã€‚ BadGood123456789101112for _, v := range data &#123; if v.F1 == 1 &#123; v = process(v) if err := v.Call(); err == nil &#123; v.Send() &#125; else &#123; return err &#125; &#125; else &#123; log.Printf("Invalid v: %v", v) &#125;&#125;123456789101112for _, v := range data &#123; if v.F1 != 1 &#123; log.Printf("Invalid v: %v", v) continue &#125; v = process(v) if err := v.Call(); err != nil &#123; return err &#125; v.Send()&#125; ä¸å¿…è¦çš„ elseå¦‚æžœåœ¨ if çš„ä¸¤ä¸ªåˆ†æ”¯ä¸­éƒ½è®¾ç½®äº†å˜é‡ï¼Œåˆ™å¯ä»¥å°†å…¶æ›¿æ¢ä¸ºå•ä¸ª ifã€‚ BadGood123456var a intif b &#123; a = 100&#125; else &#123; a = 10&#125;1234a := 10if b &#123; a = 100&#125; é¡¶å±‚å˜é‡å£°æ˜Žåœ¨é¡¶å±‚ï¼Œä½¿ç”¨æ ‡å‡†varå…³é”®å­—ã€‚è¯·å‹¿æŒ‡å®šç±»åž‹ï¼Œé™¤éžå®ƒä¸Žè¡¨è¾¾å¼çš„ç±»åž‹ä¸åŒã€‚ BadGood123var _s string = F()func F() string &#123; return "A" &#125;12345var _s = F()// ç”±äºŽ F å·²ç»æ˜Žç¡®äº†è¿”å›žä¸€ä¸ªå­—ç¬¦ä¸²ç±»åž‹ï¼Œå› æ­¤æˆ‘ä»¬æ²¡æœ‰å¿…è¦æ˜¾å¼æŒ‡å®š_s çš„ç±»åž‹// è¿˜æ˜¯é‚£ç§ç±»åž‹func F() string &#123; return "A" &#125; å¦‚æžœè¡¨è¾¾å¼çš„ç±»åž‹ä¸Žæ‰€éœ€çš„ç±»åž‹ä¸å®Œå…¨åŒ¹é…ï¼Œè¯·æŒ‡å®šç±»åž‹ã€‚ 12345678type myError struct&#123;&#125;func (myError) Error() string &#123; return "error" &#125;func F() myError &#123; return myError&#123;&#125; &#125;var _e error = F()// F è¿”å›žä¸€ä¸ª myError ç±»åž‹çš„å®žä¾‹ï¼Œä½†æ˜¯æˆ‘ä»¬è¦ error ç±»åž‹ å¯¹äºŽæœªå¯¼å‡ºçš„é¡¶å±‚å¸¸é‡å’Œå˜é‡ï¼Œä½¿ç”¨_ä½œä¸ºå‰ç¼€åœ¨æœªå¯¼å‡ºçš„é¡¶çº§varså’Œconstsï¼Œ å‰é¢åŠ ä¸Šå‰ç¼€_ï¼Œä»¥ä½¿å®ƒä»¬åœ¨ä½¿ç”¨æ—¶æ˜Žç¡®è¡¨ç¤ºå®ƒä»¬æ˜¯å…¨å±€ç¬¦å·ã€‚ ä¾‹å¤–ï¼šæœªå¯¼å‡ºçš„é”™è¯¯å€¼ï¼Œåº”ä»¥errå¼€å¤´ã€‚ åŸºæœ¬ä¾æ®ï¼šé¡¶çº§å˜é‡å’Œå¸¸é‡å…·æœ‰åŒ…èŒƒå›´ä½œç”¨åŸŸã€‚ä½¿ç”¨é€šç”¨åç§°å¯èƒ½å¾ˆå®¹æ˜“åœ¨å…¶ä»–æ–‡ä»¶ä¸­æ„å¤–ä½¿ç”¨é”™è¯¯çš„å€¼ã€‚ BadGood1234567891011121314151617// foo.goconst ( defaultPort = 8080 defaultUser = "user")// bar.gofunc Bar() &#123; defaultPort := 9090 ... fmt.Println("Default port", defaultPort) // We will not see a compile error if the first line of // Bar() is deleted.&#125;123456// foo.goconst ( _defaultPort = 8080 _defaultUser = "user") ç»“æž„ä½“ä¸­çš„åµŒå…¥åµŒå…¥å¼ç±»åž‹ï¼ˆä¾‹å¦‚ mutexï¼‰åº”ä½äºŽç»“æž„ä½“å†…çš„å­—æ®µåˆ—è¡¨çš„é¡¶éƒ¨ï¼Œå¹¶ä¸”å¿…é¡»æœ‰ä¸€ä¸ªç©ºè¡Œå°†åµŒå…¥å¼å­—æ®µä¸Žå¸¸è§„å­—æ®µåˆ†éš”å¼€ã€‚ BadGood1234type Client struct &#123; version int http.Client&#125;12345type Client struct &#123; http.Client version int&#125; ä½¿ç”¨å­—æ®µååˆå§‹åŒ–ç»“æž„ä½“åˆå§‹åŒ–ç»“æž„ä½“æ—¶ï¼Œå‡ ä¹Žå§‹ç»ˆåº”è¯¥æŒ‡å®šå­—æ®µåç§°ã€‚çŽ°åœ¨ç”± go vet å¼ºåˆ¶æ‰§è¡Œã€‚ BadGood1k := User&#123;"John", "Doe", true&#125;12345k := User&#123; FirstName: "John", LastName: "Doe", Admin: true,&#125; ä¾‹å¤–ï¼šå¦‚æžœæœ‰ 3 ä¸ªæˆ–æ›´å°‘çš„å­—æ®µï¼Œåˆ™å¯ä»¥åœ¨æµ‹è¯•è¡¨ä¸­çœç•¥å­—æ®µåç§°ã€‚ 1234567tests := []struct&#123; op Operation want string&#125;&#123; &#123;Add, "add"&#125;, &#123;Subtract, "subtract"&#125;,&#125; æœ¬åœ°å˜é‡å£°æ˜Žå¦‚æžœå°†å˜é‡æ˜Žç¡®è®¾ç½®ä¸ºæŸä¸ªå€¼ï¼Œåˆ™åº”ä½¿ç”¨çŸ­å˜é‡å£°æ˜Žå½¢å¼ (:=)ã€‚ BadGood1var s = "foo"1s := "foo" ä½†æ˜¯ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œvar ä½¿ç”¨å…³é”®å­—æ—¶é»˜è®¤å€¼ä¼šæ›´æ¸…æ™°ã€‚ä¾‹å¦‚ï¼Œå£°æ˜Žç©ºåˆ‡ç‰‡ã€‚ BadGood12345678func f(list []int) &#123; filtered := []int&#123;&#125; for _, v := range list &#123; if v &gt; 10 &#123; filtered = append(filtered, v) &#125; &#125;&#125;12345678func f(list []int) &#123; var filtered []int for _, v := range list &#123; if v &gt; 10 &#123; filtered = append(filtered, v) &#125; &#125;&#125; nil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ slicenil æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„é•¿åº¦ä¸º 0 çš„ sliceï¼Œè¿™æ„å‘³ç€ï¼Œ æ‚¨ä¸åº”æ˜Žç¡®è¿”å›žé•¿åº¦ä¸ºé›¶çš„åˆ‡ç‰‡ã€‚åº”è¯¥è¿”å›žnil æ¥ä»£æ›¿ã€‚ BadGood123if x == "" &#123; return []int&#123;&#125;&#125;123if x == "" &#123; return nil&#125; è¦æ£€æŸ¥åˆ‡ç‰‡æ˜¯å¦ä¸ºç©ºï¼Œè¯·å§‹ç»ˆä½¿ç”¨len(s) == 0ã€‚è€Œéž nilã€‚ BadGood123func isEmpty(s []string) bool &#123; return s == nil&#125;123func isEmpty(s []string) bool &#123; return len(s) == 0&#125; é›¶å€¼åˆ‡ç‰‡ï¼ˆç”¨varå£°æ˜Žçš„åˆ‡ç‰‡ï¼‰å¯ç«‹å³ä½¿ç”¨ï¼Œæ— éœ€è°ƒç”¨make()åˆ›å»ºã€‚ BadGood12345678910nums := []int&#123;&#125;// or, nums := make([]int)if add1 &#123; nums = append(nums, 1)&#125;if add2 &#123; nums = append(nums, 2)&#125;123456789var nums []intif add1 &#123; nums = append(nums, 1)&#125;if add2 &#123; nums = append(nums, 2)&#125; è®°ä½ï¼Œè™½ç„¶nilåˆ‡ç‰‡æ˜¯æœ‰æ•ˆçš„åˆ‡ç‰‡ï¼Œä½†å®ƒä¸ç­‰äºŽé•¿åº¦ä¸º0çš„åˆ‡ç‰‡ï¼ˆä¸€ä¸ªä¸ºnilï¼Œå¦ä¸€ä¸ªä¸æ˜¯ï¼‰ï¼Œå¹¶ä¸”åœ¨ä¸åŒçš„æƒ…å†µä¸‹ï¼ˆä¾‹å¦‚åºåˆ—åŒ–ï¼‰ï¼Œè¿™ä¸¤ä¸ªåˆ‡ç‰‡çš„å¤„ç†æ–¹å¼å¯èƒ½ä¸åŒã€‚ ç¼©å°å˜é‡ä½œç”¨åŸŸå¦‚æžœæœ‰å¯èƒ½ï¼Œå°½é‡ç¼©å°å˜é‡ä½œç”¨èŒƒå›´ã€‚é™¤éžå®ƒä¸Ž å‡å°‘åµŒå¥—çš„è§„åˆ™å†²çªã€‚ BadGood1234err := ioutil.WriteFile(name, data, 0644)if err != nil &#123; return err&#125;123if err := ioutil.WriteFile(name, data, 0644); err != nil &#123; return err&#125; å¦‚æžœéœ€è¦åœ¨ if ä¹‹å¤–ä½¿ç”¨å‡½æ•°è°ƒç”¨çš„ç»“æžœï¼Œåˆ™ä¸åº”å°è¯•ç¼©å°èŒƒå›´ã€‚ BadGood1234567891011if data, err := ioutil.ReadFile(name); err == nil &#123; err = cfg.Decode(data) if err != nil &#123; return err &#125; fmt.Println(cfg) return nil&#125; else &#123; return err&#125;1234567891011data, err := ioutil.ReadFile(name)if err != nil &#123; return err&#125;if err := cfg.Decode(data); err != nil &#123; return err&#125;fmt.Println(cfg)return nil é¿å…å‚æ•°è¯­ä¹‰ä¸æ˜Žç¡®(Avoid Naked Parameters)å‡½æ•°è°ƒç”¨ä¸­çš„æ„ä¹‰ä¸æ˜Žç¡®çš„å‚æ•°å¯èƒ½ä¼šæŸå®³å¯è¯»æ€§ã€‚å½“å‚æ•°åç§°çš„å«ä¹‰ä¸æ˜Žæ˜¾æ—¶ï¼Œè¯·ä¸ºå‚æ•°æ·»åŠ  C æ ·å¼æ³¨é‡Š (/* ... */) BadGood123// func printInfo(name string, isLocal, done bool)printInfo("foo", true, true)123// func printInfo(name string, isLocal, done bool)printInfo("foo", true /* isLocal */, true /* done */) å¯¹äºŽä¸Šé¢çš„ç¤ºä¾‹ä»£ç ï¼Œè¿˜æœ‰ä¸€ç§æ›´å¥½çš„å¤„ç†æ–¹å¼æ˜¯å°†ä¸Šé¢çš„ bool ç±»åž‹æ¢æˆè‡ªå®šä¹‰ç±»åž‹ã€‚å°†æ¥ï¼Œè¯¥å‚æ•°å¯ä»¥æ”¯æŒä¸ä»…ä»…å±€é™äºŽä¸¤ä¸ªçŠ¶æ€ï¼ˆtrue/falseï¼‰ã€‚ 12345678910111213141516type Region intconst ( UnknownRegion Region = iota Local)type Status intconst ( StatusReady Status= iota + 1 StatusDone // Maybe we will have a StatusInProgress in the future.)func printInfo(name string, region Region, status Status) ä½¿ç”¨åŽŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œé¿å…è½¬ä¹‰Go æ”¯æŒä½¿ç”¨ åŽŸå§‹å­—ç¬¦ä¸²å­—é¢å€¼ï¼Œä¹Ÿå°±æ˜¯ â€œ ` â€œ æ¥è¡¨ç¤ºåŽŸç”Ÿå­—ç¬¦ä¸²ï¼Œåœ¨éœ€è¦è½¬ä¹‰çš„åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥å°½é‡ä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¥æ›¿æ¢ã€‚ å¯ä»¥è·¨è¶Šå¤šè¡Œå¹¶åŒ…å«å¼•å·ã€‚ä½¿ç”¨è¿™äº›å­—ç¬¦ä¸²å¯ä»¥é¿å…æ›´éš¾é˜…è¯»çš„æ‰‹å·¥è½¬ä¹‰çš„å­—ç¬¦ä¸²ã€‚ BadGood1wantError := "unknown name:\"test\""1wantError := `unknown error:"test"` åˆå§‹åŒ– Struct å¼•ç”¨åœ¨åˆå§‹åŒ–ç»“æž„å¼•ç”¨æ—¶ï¼Œè¯·ä½¿ç”¨&amp;T{}ä»£æ›¿new(T)ï¼Œä»¥ä½¿å…¶ä¸Žç»“æž„ä½“åˆå§‹åŒ–ä¸€è‡´ã€‚ BadGood12345sval := T&#123;Name: "foo"&#125;// inconsistentsptr := new(T)sptr.Name = "bar"123sval := T&#123;Name: "foo"&#125;sptr := &amp;T&#123;Name: "bar"&#125; åˆå§‹åŒ– Mapså¯¹äºŽç©º map è¯·ä½¿ç”¨ make(..) åˆå§‹åŒ–ï¼Œ å¹¶ä¸” map æ˜¯é€šè¿‡ç¼–ç¨‹æ–¹å¼å¡«å……çš„ã€‚è¿™ä½¿å¾— map åˆå§‹åŒ–åœ¨è¡¨çŽ°ä¸Šä¸åŒäºŽå£°æ˜Žï¼Œå¹¶ä¸”å®ƒè¿˜å¯ä»¥æ–¹ä¾¿åœ°åœ¨ make åŽæ·»åŠ å¤§å°æç¤ºã€‚ BadGood123456var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = map[T1]T2&#123;&#125; m2 map[T1]T2)123456var ( // m1 è¯»å†™å®‰å…¨; // m2 åœ¨å†™å…¥æ—¶ä¼š panic m1 = make(map[T1]T2) m2 map[T1]T2)å£°æ˜Žå’Œåˆå§‹åŒ–çœ‹èµ·æ¥éžå¸¸ç›¸ä¼¼çš„ã€‚å£°æ˜Žå’Œåˆå§‹åŒ–çœ‹èµ·æ¥å·®åˆ«éžå¸¸å¤§ã€‚ åœ¨å°½å¯èƒ½çš„æƒ…å†µä¸‹ï¼Œè¯·åœ¨åˆå§‹åŒ–æ—¶æä¾› map å®¹é‡å¤§å°ï¼Œè¯¦ç»†è¯·çœ‹ å°½é‡åˆå§‹åŒ–æ—¶æŒ‡å®š Map å®¹é‡ã€‚ å¦å¤–ï¼Œå¦‚æžœ map åŒ…å«å›ºå®šçš„å…ƒç´ åˆ—è¡¨ï¼Œåˆ™ä½¿ç”¨ map literals(map åˆå§‹åŒ–åˆ—è¡¨) åˆå§‹åŒ–æ˜ å°„ã€‚ BadGood1234m := make(map[T1]T2, 3)m[k1] = v1m[k2] = v2m[k3] = v312345m := map[T1]T2&#123; k1: v1, k2: v2, k3: v3,&#125; åŸºæœ¬å‡†åˆ™æ˜¯ï¼šåœ¨åˆå§‹åŒ–æ—¶ä½¿ç”¨ map åˆå§‹åŒ–åˆ—è¡¨ æ¥æ·»åŠ ä¸€ç»„å›ºå®šçš„å…ƒç´ ã€‚å¦åˆ™ä½¿ç”¨ make (å¦‚æžœå¯ä»¥ï¼Œè¯·å°½é‡æŒ‡å®š map å®¹é‡)ã€‚ å­—ç¬¦ä¸² string formatå¦‚æžœä½ åœ¨å‡½æ•°å¤–å£°æ˜ŽPrintf-style å‡½æ•°çš„æ ¼å¼å­—ç¬¦ä¸²ï¼Œè¯·å°†å…¶è®¾ç½®ä¸ºconstå¸¸é‡ã€‚ è¿™æœ‰åŠ©äºŽgo vetå¯¹æ ¼å¼å­—ç¬¦ä¸²æ‰§è¡Œé™æ€åˆ†æžã€‚ BadGood12msg := "unexpected values %v, %v\n"fmt.Printf(msg, 1, 2)12const msg = "unexpected values %v, %v\n"fmt.Printf(msg, 1, 2) å‘½å Printf æ ·å¼çš„å‡½æ•°å£°æ˜ŽPrintf-style å‡½æ•°æ—¶ï¼Œè¯·ç¡®ä¿go vetå¯ä»¥æ£€æµ‹åˆ°å®ƒå¹¶æ£€æŸ¥æ ¼å¼å­—ç¬¦ä¸²ã€‚ è¿™æ„å‘³ç€æ‚¨åº”å°½å¯èƒ½ä½¿ç”¨é¢„å®šä¹‰çš„Printf-style å‡½æ•°åç§°ã€‚go vetå°†é»˜è®¤æ£€æŸ¥è¿™äº›ã€‚æœ‰å…³æ›´å¤šä¿¡æ¯ï¼Œè¯·å‚è§ Printf ç³»åˆ—ã€‚ å¦‚æžœä¸èƒ½ä½¿ç”¨é¢„å®šä¹‰çš„åç§°ï¼Œè¯·ä»¥ f ç»“æŸé€‰æ‹©çš„åç§°ï¼šWrapfï¼Œè€Œä¸æ˜¯Wrapã€‚go vetå¯ä»¥è¦æ±‚æ£€æŸ¥ç‰¹å®šçš„ Printf æ ·å¼åç§°ï¼Œä½†åç§°å¿…é¡»ä»¥fç»“å°¾ã€‚ 1$ go vet -printfuncs=wrapf,statusf å¦è¯·å‚é˜… go vet: Printf family check. ç¼–ç¨‹æ¨¡å¼è¡¨é©±åŠ¨æµ‹è¯•å½“æµ‹è¯•é€»è¾‘æ˜¯é‡å¤çš„æ—¶å€™ï¼Œé€šè¿‡ subtests ä½¿ç”¨ table é©±åŠ¨çš„æ–¹å¼ç¼–å†™ case ä»£ç çœ‹ä¸ŠåŽ»ä¼šæ›´ç®€æ´ã€‚ BadGood123456789101112131415161718192021// func TestSplitHostPort(t *testing.T)host, port, err := net.SplitHostPort("192.0.2.0:8000")require.NoError(t, err)assert.Equal(t, "192.0.2.0", host)assert.Equal(t, "8000", port)host, port, err = net.SplitHostPort("192.0.2.0:http")require.NoError(t, err)assert.Equal(t, "192.0.2.0", host)assert.Equal(t, "http", port)host, port, err = net.SplitHostPort(":8000")require.NoError(t, err)assert.Equal(t, "", host)assert.Equal(t, "8000", port)host, port, err = net.SplitHostPort("1:8")require.NoError(t, err)assert.Equal(t, "1", host)assert.Equal(t, "8", port)12345678910111213141516171819202122232425262728293031323334353637// func TestSplitHostPort(t *testing.T)tests := []struct&#123; give string wantHost string wantPort string&#125;&#123; &#123; give: "192.0.2.0:8000", wantHost: "192.0.2.0", wantPort: "8000", &#125;, &#123; give: "192.0.2.0:http", wantHost: "192.0.2.0", wantPort: "http", &#125;, &#123; give: ":8000", wantHost: "", wantPort: "8000", &#125;, &#123; give: "1:8", wantHost: "1", wantPort: "8", &#125;,&#125;for _, tt := range tests &#123; t.Run(tt.give, func(t *testing.T) &#123; host, port, err := net.SplitHostPort(tt.give) require.NoError(t, err) assert.Equal(t, tt.wantHost, host) assert.Equal(t, tt.wantPort, port) &#125;)&#125; å¾ˆæ˜Žæ˜¾ï¼Œä½¿ç”¨ test table çš„æ–¹å¼åœ¨ä»£ç é€»è¾‘æ‰©å±•çš„æ—¶å€™ï¼Œæ¯”å¦‚æ–°å¢ž test caseï¼Œéƒ½ä¼šæ˜¾å¾—æ›´åŠ çš„æ¸…æ™°ã€‚ æˆ‘ä»¬éµå¾ªè¿™æ ·çš„çº¦å®šï¼šå°†ç»“æž„ä½“åˆ‡ç‰‡ç§°ä¸ºtestsã€‚ æ¯ä¸ªæµ‹è¯•ç”¨ä¾‹ç§°ä¸ºttã€‚æ­¤å¤–ï¼Œæˆ‘ä»¬é¼“åŠ±ä½¿ç”¨giveå’Œwantå‰ç¼€è¯´æ˜Žæ¯ä¸ªæµ‹è¯•ç”¨ä¾‹çš„è¾“å…¥å’Œè¾“å‡ºå€¼ã€‚ 1234567891011tests := []struct&#123; give string wantHost string wantPort string&#125;&#123; // ...&#125;for _, tt := range tests &#123; // ...&#125; åŠŸèƒ½é€‰é¡¹åŠŸèƒ½é€‰é¡¹æ˜¯ä¸€ç§æ¨¡å¼ï¼Œæ‚¨å¯ä»¥åœ¨å…¶ä¸­å£°æ˜Žä¸€ä¸ªä¸é€æ˜Ž Option ç±»åž‹ï¼Œè¯¥ç±»åž‹åœ¨æŸäº›å†…éƒ¨ç»“æž„ä¸­è®°å½•ä¿¡æ¯ã€‚æ‚¨æŽ¥å—è¿™äº›é€‰é¡¹çš„å¯å˜ç¼–å·ï¼Œå¹¶æ ¹æ®å†…éƒ¨ç»“æž„ä¸Šçš„é€‰é¡¹è®°å½•çš„å…¨éƒ¨ä¿¡æ¯é‡‡å–è¡ŒåŠ¨ã€‚ å°†æ­¤æ¨¡å¼ç”¨äºŽæ‚¨éœ€è¦æ‰©å±•çš„æž„é€ å‡½æ•°å’Œå…¶ä»–å…¬å…± API ä¸­çš„å¯é€‰å‚æ•°ï¼Œå°¤å…¶æ˜¯åœ¨è¿™äº›åŠŸèƒ½ä¸Šå·²ç»å…·æœ‰ä¸‰ä¸ªæˆ–æ›´å¤šå‚æ•°çš„æƒ…å†µä¸‹ã€‚ BadGood123456789// package dbfunc Open( addr string, cache bool, logger *zap.Logger) (*Connection, error) &#123; // ...&#125;123456789101112131415161718192021// package dbtype Option interface &#123; // ...&#125;func WithCache(c bool) Option &#123; // ...&#125;func WithLogger(log *zap.Logger) Option &#123; // ...&#125;// Open creates a connection.func Open( addr string, opts ...Option,) (*Connection, error) &#123; // ...&#125;å¿…é¡»å§‹ç»ˆæä¾›ç¼“å­˜å’Œè®°å½•å™¨å‚æ•°ï¼Œå³ä½¿ç”¨æˆ·å¸Œæœ›ä½¿ç”¨é»˜è®¤å€¼ã€‚1234db.Open(addr, db.DefaultCache, zap.NewNop())db.Open(addr, db.DefaultCache, log)db.Open(addr, false /* cache */, zap.NewNop())db.Open(addr, false /* cache */, log)åªæœ‰åœ¨éœ€è¦æ—¶æ‰æä¾›é€‰é¡¹ã€‚12345678db.Open(addr)db.Open(addr, db.WithLogger(log))db.Open(addr, db.WithCache(false))db.Open( addr, db.WithCache(false), db.WithLogger(log),) Our suggested way of implementing this pattern is with an Option interfacethat holds an unexported method, recording options on an unexported optionsstruct. æˆ‘ä»¬å»ºè®®å®žçŽ°æ­¤æ¨¡å¼çš„æ–¹æ³•æ˜¯ä½¿ç”¨ä¸€ä¸ª Option æŽ¥å£ï¼Œè¯¥æŽ¥å£ä¿å­˜ä¸€ä¸ªæœªå¯¼å‡ºçš„æ–¹æ³•ï¼Œåœ¨ä¸€ä¸ªæœªå¯¼å‡ºçš„ options ç»“æž„ä¸Šè®°å½•é€‰é¡¹ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647type options struct &#123; cache bool logger *zap.Logger&#125;type Option interface &#123; apply(*options)&#125;type cacheOption boolfunc (c cacheOption) apply(opts *options) &#123; opts.cache = bool(c)&#125;func WithCache(c bool) Option &#123; return cacheOption(c)&#125;type loggerOption struct &#123; Log *zap.Logger&#125;func (l loggerOption) apply(opts *options) &#123; opts.logger = l.Log&#125;func WithLogger(log *zap.Logger) Option &#123; return loggerOption&#123;Log: log&#125;&#125;// Open creates a connection.func Open( addr string, opts ...Option,) (*Connection, error) &#123; options := options&#123; cache: defaultCache, logger: zap.NewNop(), &#125; for _, o := range opts &#123; o.apply(&amp;options) &#125; // ...&#125; æ³¨æ„: è¿˜æœ‰ä¸€ç§ä½¿ç”¨é—­åŒ…å®žçŽ°è¿™ä¸ªæ¨¡å¼çš„æ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬ç›¸ä¿¡ä¸Šé¢çš„æ¨¡å¼ä¸ºä½œè€…æä¾›äº†æ›´å¤šçš„çµæ´»æ€§ï¼Œå¹¶ä¸”æ›´å®¹æ˜“å¯¹ç”¨æˆ·è¿›è¡Œè°ƒè¯•å’Œæµ‹è¯•ã€‚ç‰¹åˆ«æ˜¯ï¼Œåœ¨ä¸å¯èƒ½è¿›è¡Œæ¯”è¾ƒçš„æƒ…å†µä¸‹å®ƒå…è®¸åœ¨æµ‹è¯•å’Œæ¨¡æ‹Ÿä¸­å¯¹é€‰é¡¹è¿›è¡Œæ¯”è¾ƒã€‚æ­¤å¤–ï¼Œå®ƒè¿˜å…è®¸é€‰é¡¹å®žçŽ°å…¶ä»–æŽ¥å£ï¼ŒåŒ…æ‹¬ fmt.Stringerï¼Œå…è®¸ç”¨æˆ·è¯»å–é€‰é¡¹çš„å­—ç¬¦ä¸²è¡¨ç¤ºå½¢å¼ã€‚ è¿˜å¯ä»¥å‚è€ƒä¸‹é¢èµ„æ–™ï¼š Self-referential functions and the design of options Functional options for friendly APIs Stargazers over time]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å…³äºŽ golang é”™è¯¯å¤„ç†çš„ä¸€äº›æ€è€ƒ]]></title>
    <url>%2F2020%2F06%2F01%2F%E5%85%B3%E4%BA%8E-golang-%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86%E7%9A%84%E4%B8%80%E4%BA%9B%E6%80%9D%E8%80%83%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢ï¼šä½ æ˜¯è¿˜æ²¡åœ¨errorä¸Šæ ½è·Ÿå¤´ï¼Œå½“ä½ æ ½äº†è·Ÿå¤´æ—¶æ‰ä¼šå“­ç€æƒ³èµ·æ¥ï¼Œå½“å¹´ä¸ºä»€ä¹ˆæ²¡å¥½å¥½æ€è€ƒå’Œåçœé”™è¯¯å¤„ç†è¿™ä¹ˆä¸€ä¸ªå®å¤§çš„è¯é¢˜ å…³äºŽ Golang é”™è¯¯å¤„ç†çš„å®žè·µ Golangæœ‰å¾ˆå¤šä¼˜ç‚¹ï¼Œè¿™ä¹Ÿæ˜¯å®ƒå¦‚æ­¤æµè¡Œçš„ä¸»è¦åŽŸå› ã€‚ä½†æ˜¯ Go 1 å¯¹é”™è¯¯å¤„ç†çš„æ”¯æŒè¿‡äºŽç®€å•äº†ï¼Œä»¥è‡³äºŽæ—¥å¸¸å¼€å‘ä¸­ä¼šæœ‰è¯¸å¤šä¸ä¾¿åˆ©ï¼Œé­åˆ°å¾ˆå¤šå¼€å‘è€…çš„åæ§½ã€‚è¿™äº›ä¸è¶³å‚¬ç”Ÿäº†ä¸€äº›å¼€æºè§£å†³æ–¹æ¡ˆã€‚ä¸Žæ­¤åŒæ—¶ï¼Œ Go å®˜æ–¹ä¹Ÿåœ¨ä»Žè¯­è¨€å’Œæ ‡å‡†åº“å±‚é¢ä½œå‡ºæ”¹è¿›ã€‚è¿™ç¯‡æ–‡ç« å°†ç»™å‡ºå‡ ç§å¸¸è§åˆ›å»ºé”™è¯¯çš„æ–¹å¼å¹¶åˆ†æžä¸€äº›å¸¸è§é—®é¢˜ï¼Œå¯¹æ¯”å„ç§è§£å†³æ–¹æ¡ˆï¼Œå¹¶å±•ç¤ºäº†è¿„ä»Šä¸ºæ­¢(go 1.13)çš„æœ€ä½³å®žè·µã€‚ å‡ ç§åˆ›å»ºé”™è¯¯çš„æ–¹å¼ é¦–å…ˆä»‹ç»å‡ ç§å¸¸è§çš„åˆ›å»ºé”™è¯¯çš„æ–¹æ³• åŸºäºŽå­—ç¬¦ä¸²çš„é”™è¯¯ 1234err1 := errors.New("math: square root of negative number")err2 := fmt.Errorf("math: square root of negative number %g", x) å¸¦æœ‰æ•°æ®çš„è‡ªå®šä¹‰é”™è¯¯123456789101112131415161718192021222324252627282930package zErrorimport ( "fmt" "github.com/satori/go.uuid" "log" "runtime/debug" "time")type BaseError struct &#123; InnerError error Message string StackTrace string Misc map[string]interface&#123;&#125;&#125;func WrapError(err error, message string, messageArgs ...interface&#123;&#125;) BaseError &#123; return BaseError&#123; InnerError: err, Message: fmt.Sprintf(message, messageArgs), StackTrace: string(debug.Stack()), Misc: make(map[string]interface&#123;&#125;), &#125;&#125;func (err *BaseError) Error() string &#123;// å®žçŽ° Error æŽ¥å£ return err.Message&#125; æŠ›å‡ºé—®é¢˜ å¼€å‘ä¸­ç»å¸¸éœ€è¦æ£€æŸ¥è¿”å›žçš„é”™è¯¯å€¼å¹¶ä½œç›¸åº”å¤„ç†ã€‚ä¸‹é¢ç»™å‡ºä¸€ä¸ªæœ€ç®€å•çš„ç¤ºä¾‹ã€‚ 123456789101112131415161718192021import ( "database/sql" "fmt")func GetSql() error &#123; return sql.ErrNoRows&#125;func Call() error &#123; return GetSql()&#125;func main() &#123; err := Call() if err != nil &#123; fmt.Printf("got err, %+v\n", err) &#125;&#125;//Outputs:// got err, sql: no rows in result set æœ‰æ—¶éœ€è¦æ ¹æ®è¿”å›žçš„errorç±»åž‹ä½œä¸åŒå¤„ç†ï¼Œä¾‹å¦‚ï¼š 1234567891011121314151617181920212223242526import ( "database/sql" "fmt")func GetSql() error &#123; return sql.ErrNoRows&#125;func Call() error &#123; return GetSql()&#125;func main() &#123; err := Call() if err == sql.ErrNoRows &#123; fmt.Printf("data not found, %+v\n", err) return &#125; if err != nil &#123; // Unknown error &#125;&#125;//Outputs:// data not found, sql: no rows in result set å®žè·µä¸­ç»å¸¸éœ€è¦ä¸ºé”™è¯¯å¢žåŠ ä¸Šä¸‹æ–‡ä¿¡æ¯åŽå†è¿”å›žï¼Œä»¥æ–¹ä¾¿è°ƒç”¨è€…äº†è§£é”™è¯¯åœºæ™¯ã€‚ä¾‹å¦‚ Getcall æ–¹æ³•æ—¶å¸¸å†™æˆï¼š123func Getcall() error &#123; return fmt.Errorf("GetSql err, %v", sql.ErrNoRows)&#125; ä¸è¿‡è¿™ä¸ªæ—¶å€™ err == sql.ErrNoRows å°±ä¸æˆç«‹äº†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸Šè¿°å†™æ³•éƒ½åœ¨è¿”å›žé”™è¯¯æ—¶éƒ½ä¸¢æŽ‰äº†è°ƒç”¨æ ˆè¿™ä¸ªé‡è¦çš„ä¿¡æ¯ã€‚æˆ‘ä»¬éœ€è¦æ›´çµæ´»ã€æ›´é€šç”¨çš„æ–¹å¼æ¥åº”å¯¹æ­¤ç±»é—®é¢˜ã€‚ è§£å†³æ–¹æ¡ˆ é’ˆå¯¹å­˜åœ¨çš„ä¸è¶³ï¼Œç›®å‰æœ‰å‡ ç§è§£å†³æ–¹æ¡ˆã€‚è¿™äº›æ–¹å¼å¯ä»¥å¯¹é”™è¯¯è¿›è¡Œä¸Šä¸‹æ–‡åŒ…è£…ï¼Œå¹¶æºå¸¦åŽŸå§‹é”™è¯¯ä¿¡æ¯ï¼Œ è¿˜èƒ½å°½é‡ä¿ç•™å®Œæ•´çš„è°ƒç”¨æ ˆ æ–¹æ¡ˆ 1ï¼š github.com/pkg/errorså¦‚æžœåªæœ‰é”™è¯¯çš„æ–‡æœ¬ï¼Œæˆ‘ä»¬å¾ˆéš¾å®šä½åˆ°å…·ä½“çš„å‡ºé”™åœ°ç‚¹ã€‚è™½ç„¶é€šè¿‡åœ¨ä»£ç ä¸­æœç´¢é”™è¯¯æ–‡æœ¬ä¹Ÿæ˜¯æœ‰å¯èƒ½æ‰¾åˆ°å‡ºé”™åœ°ç‚¹çš„ï¼Œä½†æ˜¯ä¿¡æ¯æœ‰é™ã€‚æ‰€ä»¥ï¼Œåœ¨å®žè·µä¸­ï¼Œæˆ‘ä»¬å¾€å¾€ä¼šå°†å‡ºé”™æ—¶çš„è°ƒç”¨æ ˆä¿¡æ¯ä¹Ÿé™„åŠ ä¸ŠåŽ»ã€‚è°ƒç”¨æ ˆå¯¹æ¶ˆè´¹æ–¹æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä»Žéš”ç¦»å’Œè‡ªæ²»çš„è§’åº¦æ¥çœ‹ï¼Œæ¶ˆè´¹æ–¹å”¯ä¸€éœ€è¦å…³å¿ƒçš„å°±æ˜¯é”™è¯¯æ–‡æœ¬å’Œé”™è¯¯ç±»åž‹ã€‚è°ƒç”¨æ ˆå¯¹å®žçŽ°è€…è‡ªèº«æ‰æ˜¯æ˜¯æœ‰ä»·å€¼çš„ã€‚æ‰€ä»¥ï¼Œå¦‚æžœä¸€ä¸ªæ–¹æ³•éœ€è¦è¿”å›žé”™è¯¯ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨errors.WithStack(err)æˆ–è€…errors.Wrap(err, â€œcustom messageâ€)çš„æ–¹å¼ï¼ŒæŠŠæ­¤åˆ»çš„è°ƒç”¨æ ˆåŠ åˆ°erroré‡ŒåŽ»ï¼Œå¹¶ä¸”åœ¨æŸä¸ªç»Ÿä¸€åœ°æ–¹è®°å½•æ—¥å¿—ï¼Œæ–¹ä¾¿å¼€å‘è€…å¿«é€Ÿå®šä½é—®é¢˜ã€‚ Wrap æ–¹æ³•ç”¨æ¥åŒ…è£…åº•å±‚é”™è¯¯ï¼Œå¢žåŠ ä¸Šä¸‹æ–‡æ–‡æœ¬ä¿¡æ¯å¹¶é™„åŠ è°ƒç”¨æ ˆã€‚ ä¸€èˆ¬ç”¨äºŽåŒ…è£…å¯¹ç¬¬ä¸‰æ–¹ä»£ç ï¼ˆæ ‡å‡†åº“æˆ–ç¬¬ä¸‰æ–¹åº“ï¼‰çš„è°ƒç”¨ã€‚ WithMessage æ–¹æ³•ä»…å¢žåŠ ä¸Šä¸‹æ–‡æ–‡æœ¬ä¿¡æ¯ï¼Œä¸é™„åŠ è°ƒç”¨æ ˆã€‚ å¦‚æžœç¡®å®šé”™è¯¯å·²è¢« Wrap è¿‡æˆ–ä¸å…³å¿ƒè°ƒç”¨æ ˆï¼Œå¯ä»¥ä½¿ç”¨æ­¤æ–¹æ³•ã€‚ æ³¨æ„ï¼šä¸è¦åå¤ Wrap ï¼Œä¼šå¯¼è‡´è°ƒç”¨æ ˆé‡å¤ Causeæ–¹æ³•ç”¨æ¥åˆ¤æ–­åº•å±‚é”™è¯¯ ã€‚ çŽ°åœ¨æˆ‘ä»¬ç”¨è¿™ä¸‰ä¸ªæ–¹æ³•æ¥é‡å†™ä¸Šé¢çš„ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738import ( "database/sql" "fmt" "github.com/pkg/errors")func GetSql() error &#123; return errors.Wrap(sql.ErrNoRows, "GetSql failed")&#125;func Call() error &#123; return errors.WithMessage(GetSql(), "bar failed")&#125;func main() &#123; err := Call() if errors.Cause(err) == sql.ErrNoRows &#123; fmt.Printf("data not found, %v\n", err) fmt.Printf("%+v\n", err) return &#125; if err != nil &#123; // unknown error &#125;&#125;/*Output:data not found, Call failed: GetSql failed: sql: no rows in result setsql: no rows in result setmain.GetSql /usr/three/main.go:11main.Call /usr/three/main.go:15main.main /usr/three/main.go:19runtime.main ...*/ ä»Žè¾“å‡ºå†…å®¹å¯ä»¥çœ‹åˆ°ï¼Œ ä½¿ç”¨ %v ä½œä¸ºæ ¼å¼åŒ–å‚æ•°ï¼Œé‚£ä¹ˆé”™è¯¯ä¿¡æ¯ä¼šä¿æŒä¸€è¡Œï¼Œ å…¶ä¸­ä¾æ¬¡åŒ…å«è°ƒç”¨æ ˆçš„ä¸Šä¸‹æ–‡æ–‡æœ¬ã€‚ ä½¿ç”¨ %+v ï¼Œåˆ™ä¼šè¾“å‡ºå®Œæ•´çš„è°ƒç”¨æ ˆè¯¦æƒ…ã€‚å¦‚æžœä¸éœ€è¦å¢žåŠ é¢å¤–ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…é™„åŠ è°ƒç”¨æ ˆåŽè¿”å›žï¼Œå¯ä»¥ä½¿ç”¨ WithStack æ–¹æ³•ï¼š 123func GetSql() error &#123; return errors.WithStack(sql.ErrNoRows)&#125; æ³¨æ„ï¼šæ— è®ºæ˜¯ Wrap ï¼Œ WithMessage è¿˜æ˜¯ WithStack ï¼Œå½“ä¼ å…¥çš„ err å‚æ•°ä¸º nil æ—¶ï¼Œ éƒ½ä¼šè¿”å›žnilï¼Œ è¿™æ„å‘³ç€æˆ‘ä»¬åœ¨è°ƒç”¨æ­¤æ–¹æ³•ä¹‹å‰æ— éœ€ä½œ nil åˆ¤æ–­ï¼Œä¿æŒäº†ä»£ç ç®€æ´ æ–¹æ¡ˆ 2ï¼šgolang.org/x/xerrorsç»“åˆç¤¾åŒºåé¦ˆï¼ŒGo å›¢é˜Ÿå®Œæˆäº†åœ¨ Go 2 ä¸­ç®€åŒ–é”™è¯¯å¤„ç†çš„ææ¡ˆã€‚ Goæ ¸å¿ƒå›¢é˜Ÿæˆå‘˜ Russ Cox åœ¨xerrorsä¸­éƒ¨åˆ†å®žçŽ°äº†ææ¡ˆä¸­çš„å†…å®¹ã€‚å®ƒç”¨ä¸Ž github.com/pkg/errorsç›¸ä¼¼çš„æ€è·¯è§£å†³åŒä¸€é—®é¢˜ï¼Œ å¼•å…¥äº†ä¸€ä¸ªæ–°çš„ fmt æ ¼å¼åŒ–åŠ¨è¯: %wï¼Œä½¿ç”¨ Is è¿›è¡Œåˆ¤æ–­ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940import ( "database/sql" "fmt" "golang.org/x/xerrors")func Call() error &#123; if err := GetSql(); err != nil &#123; return xerrors.Errorf("bar failed: %w", GetSql()) &#125; return nil&#125;func GetSql() error &#123; return xerrors.Errorf("GetSql failed: %w", sql.ErrNoRows)&#125;func main() &#123; err := Call() if xerrors.Is(err, sql.ErrNoRows) &#123; fmt.Printf("data not found, %v\n", err) fmt.Printf("%+v\n", err) return &#125; if err != nil &#123; // unknown error &#125;&#125;/* Outputs:data not found, Call failed: GetSql failed: sql: no rows in result setbar failed: main.Call /usr/four/main.go:12 - GetSql failed: main.GetSql /usr/four/main.go:18 - sql: no rows in result set*/ ä¸Ž github.com/pkg/errors ç›¸æ¯”ï¼Œå®ƒæœ‰å‡ ç‚¹ä¸è¶³ï¼š ä½¿ç”¨ : %w ä»£æ›¿äº† Wrap ï¼Œ çœ‹ä¼¼ç®€åŒ–ï¼Œ ä½†å¤±åŽ»äº†ç¼–è¯‘æœŸæ£€æŸ¥ã€‚ å¦‚æžœæ²¡æœ‰å†’å·ï¼Œæˆ– : %w ä¸ä½äºŽäºŽæ ¼å¼åŒ–å­—ç¬¦ä¸²çš„ç»“å°¾ï¼Œæˆ–å†’å·ä¸Žç™¾åˆ†å·ä¹‹é—´æ²¡æœ‰ç©ºæ ¼ï¼ŒåŒ…è£…å°†å¤±æ•ˆä¸”ä¸æŠ¥é”™ï¼› è€Œä¸”ï¼Œè°ƒç”¨ xerrors.Errorf ä¹‹å‰éœ€è¦å¯¹å‚æ•°è¿›è¡Œnilåˆ¤æ–­ã€‚ è¿™å®Œå…¨æ²¡æœ‰ç®€åŒ–å¼€å‘è€…çš„å·¥ä½œ æ–¹æ¡ˆ 3ï¼šGo 1.13 å†…ç½®æ”¯æŒ Go 1.13 å°† xerrors çš„éƒ¨åˆ†åŠŸèƒ½ï¼ˆä¸æ˜¯å…¨éƒ¨ï¼‰æ•´åˆè¿›äº†æ ‡å‡†åº“ã€‚ å®ƒç»§æ‰¿äº†ä¸Šé¢æåˆ°çš„ xerrors çš„å…¨éƒ¨ç¼ºç‚¹ï¼Œ å¹¶é¢å¤–è´¡çŒ®äº†ä¸€é¡¹ã€‚å› æ­¤ç›®å‰æ²¡æœ‰ä½¿ç”¨å®ƒçš„å¿…è¦ã€‚ 12345678910111213141516171819202122232425262728293031import ( "database/sql" "errors" "fmt")func Call() error &#123; if err := GetSql(); err != nil &#123; return fmt.Errorf("Call failed: %w", GetSql()) &#125; return nil&#125;func GetSql() error &#123; return fmt.Errorf("GetSql failed: %w", sql.ErrNoRows)&#125;func main() &#123; err := Call() if errors.Is(err, sql.ErrNoRows) &#123; fmt.Printf("data not found, %+v\n", err) return &#125; if err != nil &#123; // unknown error &#125;&#125;/* Outputs:data not found, Call failed: GetSql failed: sql: no rows in result set*/ ä¸Šé¢çš„ä»£ç ä¸Ž xerrors ç‰ˆæœ¬éžå¸¸æŽ¥è¿‘ã€‚ä½†æ˜¯å®ƒä¸æ”¯æŒè°ƒç”¨æ ˆä¿¡æ¯è¾“å‡ºï¼Œ æ ¹æ®å®˜æ–¹çš„è¯´æ³•ï¼Œ æ­¤åŠŸèƒ½æ²¡æœ‰æ˜Žç¡®çš„æ”¯æŒæ—¶é—´ã€‚å› æ­¤å…¶å®žç”¨æ€§è¿œä½ŽäºŽ github.com/pkg/errorsã€‚ Golang ä¸­å°†æ¥å¯èƒ½çš„é”™è¯¯å¤„ç†æ–¹å¼ åœ¨Go 2çš„è‰æ¡ˆä¸­ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æœ‰å…³äºŽerrorç›¸å…³çš„ä¸€äº›ææ¡ˆï¼Œé‚£å°±æ˜¯check/handleå‡½æ•°ã€‚ æˆ‘ä»¬ä¹Ÿè®¸åœ¨ä¸‹ä¸€ä¸ªå¤§ç‰ˆæœ¬çš„Golangå¯ä»¥åƒä¸‹é¢è¿™æ ·å¤„ç†é”™è¯¯ï¼š 123456789101112131415161718import "fmt"func game() error &#123; handle err &#123; return fmt.Errorf("dependencies error: %v", err) &#125; resource := check findResource() // return resource, error defer func() &#123; resource.Release() &#125;() profile := check loadProfile() // return profile, error defer func() &#123; profile.Close() &#125; // ...&#125; æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å…³æ³¨ä¸‹è¿™ä¸ªææ¡ˆï¼šhttps://go.googlesource.com/proposal/+/master/design/go2draft-error-handling-overview.md å¾—å‡ºç»“è®º é‡è¦çš„æ˜¯è¦è®°ä½ï¼ŒåŒ…è£…é”™è¯¯ä¼šä½¿è¯¥é”™è¯¯æˆä¸ºæ‚¨APIçš„ä¸€éƒ¨åˆ†ã€‚å¦‚æžœæ‚¨ä¸æƒ³å°†æ¥å°†é”™è¯¯ä½œä¸ºAPIçš„ä¸€éƒ¨åˆ†æ¥æ”¯æŒï¼Œåˆ™ä¸åº”åŒ…è£…è¯¥é”™è¯¯ã€‚æ— è®ºæ˜¯å¦åŒ…è£…é”™è¯¯ï¼Œé”™è¯¯æ–‡æœ¬éƒ½å°†ç›¸åŒã€‚é‚£äº›è¯•å›¾ç†è§£é”™è¯¯çš„äººå°†å¾—åˆ°ç›¸åŒçš„ä¿¡æ¯ï¼Œæ— è®ºé‡‡ç”¨å“ªç§æ–¹å¼; æ˜¯å¦è¦åŒ…è£…é”™è¯¯çš„é€‰æ‹©å–å†³äºŽæ˜¯å¦è¦ç»™ç¨‹åºæä¾›æ›´å¤šä¿¡æ¯ï¼Œä»¥ä¾¿ä»–ä»¬å¯ä»¥åšå‡ºæ›´æ˜Žæ™ºçš„å†³ç­–ï¼Œè¿˜æ˜¯ä¿ç•™è¯¥ä¿¡æ¯ä»¥ä¿ç•™æŠ½è±¡å±‚ã€‚ é€šè¿‡ä»¥ä¸Šå¯¹æ¯”ï¼Œ ç›¸ä¿¡ä½ å·²ç»æœ‰äº†é€‰æ‹©ã€‚ å†æ˜Žç¡®ä¸€ä¸‹æˆ‘çš„çœ‹æ³•ï¼Œå¦‚æžœä½ æ­£åœ¨ä½¿ç”¨ github.com/pkg/errors ï¼Œé‚£å°±ä¿æŒçŽ°çŠ¶å§ã€‚ç›®å‰è¿˜æ²¡æœ‰æ¯”å®ƒæ›´å¥½çš„é€‰æ‹©ã€‚å¦‚æžœä½ å·²ç»å¤§é‡ä½¿ç”¨ golang.org/x/xerrors ï¼Œ åˆ«ç›²ç›®æ¢æˆ go 1.13 çš„å†…ç½®æ–¹æ¡ˆã€‚ æ€»çš„æ¥è¯´ï¼ŒGo åœ¨è¯žç”Ÿä¹‹åˆå°±åœ¨å„ä¸ªæ–¹é¢è¡¨çŽ°å¾—ç›¸å½“æˆç†Ÿã€ç¨³å¥ã€‚ åœ¨æ¼”è¿›è·¯çº¿ä¸Šå¾ˆå°‘å‡ºçŽ°çŠ¹ç–‘å’Œæ‘‡æ‘†ï¼Œ è€Œåœ¨é”™è¯¯å¤„ç†æ–¹é¢å´æ˜¯ä¸ªä¾‹å¤–ã€‚ é™¤äº†è¢«å¹¿æ³›åæ§½çš„ if err != nil ä¹‹å¤–ï¼Œ å°±è¿žå…¶æ”¹è¿›è·¯çº¿ä¹Ÿå¤‡å—äº‰è®®ã€åˆ†æ­§æ˜Žæ˜¾ï¼Œä»¥è‡´äºŽä¸€ä¸ªæ”¹è¿›ææ¡ˆéƒ½ä¼šå› ä¸ºåŽ‹å€’æ€§çš„åå¯¹æ„è§è€Œä¸å¾—ä¸ä½œå‡ºè°ƒæ•´ã€‚ å¥½åœ¨ Go å›¢é˜Ÿæ¯”ä»¥å‰æ›´åŠ ä¹äºŽå€¾å¬ç¤¾åŒºæ„è§ï¼Œå›¢é˜Ÿç”šè‡³ä¸“é—¨å°±æ­¤é—®é¢˜å»ºäº†ä¸ªåé¦ˆæ”¶é›†é¡µé¢ã€‚ç›¸ä¿¡æœ€ç»ˆå¤§å®¶ä¼šæ‰¾åˆ°æ›´å¥½çš„è§£å†³æ–¹æ¡ˆã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å®˜å®£ï¼š2019 å¹´ Go å¼€å‘è€…è°ƒæŸ¥æŠ¥å‘Š]]></title>
    <url>%2F2020%2F05%2F10%2F%E5%AE%98%E5%AE%A3%EF%BC%9A2019-%E5%B9%B4-Go-%E5%BC%80%E5%8F%91%E8%80%85%E8%B0%83%E6%9F%A5%E6%8A%A5%E5%91%8A%2F</url>
    <content type="text"><![CDATA[2019 å¹´ Go å¼€å‘è€…è°ƒæŸ¥ 4æœˆ20æ—¥ï¼ŒGo å®˜æ–¹é‡Šå‡º 2019 å¹´çš„ Go å¼€å‘è€…è°ƒç ”æŠ¥å‘Šã€‚å®˜æ–¹éžå¸¸æ„Ÿè°¢å‚ä¸Žæœ¬æ¬¡è°ƒæŸ¥çš„æ•°åƒåGoå¼€å‘äººå‘˜ã€‚ åœ¨2019å¹´ï¼Œå®˜æ–¹æ”¶åˆ°äº† 10,975 ä»½é—®å·ï¼Œå‡ ä¹Žæ˜¯åŽ»å¹´çš„ä¸¤å€ï¼ å›¢é˜Ÿæˆå‘˜éžå¸¸æ„Ÿè°¢å¼€å‘è€…èŠ±æ—¶é—´å’Œç²¾åŠ›å¡«å†™è¿™ä»½ Go å¼€å‘è€…è°ƒç ”ã€‚ æœ¬æ¬¡è°ƒç ”ï¼Œå®˜æ–¹æ”¹è¿›äº†å¯¹å¼€æ”¾å¼ã€è‡ªç”±æ–‡æœ¬å›žç­”çš„é—®é¢˜çš„åˆ†æžã€‚åŽ»å¹´ä½¿ç”¨çš„æ˜¯æœºå™¨å­¦ä¹ æ¥ç²—ç•¥ä½†å¿«é€Ÿåœ°å¯¹è¿™äº›é—®å·è¿›è¡Œåˆ†ç±»ã€‚ä»Šå¹´ï¼Œä¸¤åç ”ç©¶äººå‘˜æ‰‹åŠ¨åˆ†æžå’Œåˆ†ç±»äº†è¿™äº›é—®å·ï¼Œå…è®¸è¿›è¡Œæ›´ç»†è‡´çš„åˆ†æžï¼Œä¸ŽåŽ»å¹´çš„æ•°å­—è¿›è¡Œæœ‰æ•ˆçš„æ¯”è¾ƒã€‚è¿™ä¸ªå˜åŒ–çš„ç›®çš„æ˜¯æä¾›ä¸€ä¸ª 2019 å¹´ä»¥åŽçš„å¯é åŸºçº¿ã€‚ ä¸€åˆ†é’Ÿé€Ÿè¯»è¿™ç¯‡æ–‡ç« å¾ˆé•¿ã€‚ä»¥ä¸‹æ˜¯æœ¬æ¬¡è°ƒç ”çš„ä¸»è¦ç»“è®º: è¿™æ¬¡çš„å—è®¿è€…çš„å—ä¼—ç‰¹å¾ä¸Ž Stack Overflow çš„è°ƒæŸ¥å—è®¿è€…ç›¸ä¼¼ï¼Œä½¿å¾—è¿™äº›ç»“æžœå¯ä»¥ä»£è¡¨æ›´å¤šçš„ Go å¼€å‘äººå‘˜çš„å¿ƒå£°ã€‚ å¤§å¤šæ•°å—è®¿è€…æ¯å¤©éƒ½ä½¿ç”¨ Goï¼Œè€Œä¸”è¿™ä¸ªæ•°å­—æ¯å¹´éƒ½åœ¨ä¸Šå‡ã€‚ Go çš„ä½¿ç”¨ä»é›†ä¸­åœ¨æŠ€æœ¯å…¬å¸ï¼Œä½†æ˜¯ Go åœ¨è¶Šæ¥è¶Šå¤šçš„è¡Œä¸šä¸­è¢«ç”¨åˆ°ï¼Œä¾‹å¦‚é‡‘èžè¡Œä¸šå’Œåª’ä½“ç›¸å…³ã€‚ å¼€å‘è€…ä½¿ç”¨ Go è§£å†³çš„é—®é¢˜å¾ˆç›¸ä¼¼ï¼ŒåŸºæœ¬é›†ä¸­åœ¨æž„å»º API, RPC æœåŠ¡å’Œ CLI å·¥å…·ã€‚ å¤§å¤šæ•°å›¢é˜Ÿéƒ½è¯•å›¾å°½å¿«æ›´æ–°åˆ°æœ€æ–°çš„ Go ç‰ˆæœ¬ã€‚ ä½†æ˜¯ç¬¬ä¸‰æ–¹ package çš„ provider æ›´æ–°åœ°ä¼šç›¸å¯¹æ…¢ä¸€ç‚¹ã€‚ çŽ°åœ¨ï¼ŒGoç”Ÿæ€ç³»ç»Ÿä¸­çš„å‡ ä¹Žæ¯ä¸ªäººéƒ½åœ¨ä½¿ç”¨ Go Modulesï¼Œä½†æ˜¯ç”¨æˆ·å¯¹è½¯ä»¶åŒ…ç®¡ç†æ–¹é¢ä»ç„¶å­˜åœ¨å›°æƒ‘ã€‚ æœ‰å¾…æ”¹è¿›çš„é‡ç‚¹é¢†åŸŸåŒ…æ‹¬æ”¹å–„å¼€å‘äººå‘˜çš„ debug ä½“éªŒï¼ŒGo Modules å’Œ cloud service æ–¹é¢çš„ä½“éªŒã€‚ VS Code å’Œ GoLand ä»ç„¶æ˜¯æœ€å—æ¬¢è¿Žçš„ç¼–è¾‘å™¨ï¼Œå—è®¿çš„å››ä¸ªäººä¸­å°±æœ‰ä¸‰ä¸ªåœ¨ä½¿ç”¨ä»–ä»¬ã€‚ å—è®¿çš„å¼€å‘è€…ç¾¤ä½“å—è®¿è€…å…¬å¸è§„æ¨¡ å—è®¿è€…çš„ç¼–ç¨‹å·¥ä½œå¹´é™ å—è®¿è€…ä½¿ç”¨ Go ç¼–ç¨‹çš„æ—¶é—´ä»Žä½¿ç”¨ Go çš„ç»éªŒæ¥çœ‹ï¼Œæˆ‘ä»¬å‘çŽ°å¤§å¤šæ•°å—è®¿è€…ï¼ˆ56ï¼…ï¼‰ä½¿ç”¨ Go çš„æ—¶é—´ä¸åˆ°ä¸¤å¹´ï¼Œç›¸å¯¹è¾ƒæ–°ã€‚ å¤šæ•°äººè¿˜è¯´ï¼Œä»–ä»¬åœ¨å·¥ä½œä¸­ï¼ˆ72ï¼…ï¼‰å’Œå·¥ä½œå¤–ï¼ˆ62ï¼…ï¼‰ä½¿ç”¨Goã€‚ å¯ä»¥çœ‹åˆ°åœ¨å·¥ä½œä¸­ä½¿ç”¨ Go çš„å—è®¿è€…æ¯”ä¾‹æ¯å¹´éƒ½åœ¨ä¸Šå‡ã€‚ å—è®¿è€…çš„å¼€å‘èƒŒæ™¯ ä½¿ç”¨ Go æ—¶é—´è¾ƒé•¿çš„å—è®¿è€…ä¸Žæ–°çš„ Go å¼€å‘äººå‘˜çš„èƒŒæ™¯ä¸åŒã€‚ è¿™äº› Go è€å…µæ›´æœ‰å¯èƒ½æ‹¥æœ‰ C / C ++ çš„ä¸“ä¸šçŸ¥è¯†ï¼Œè€Œä¸å¤ªå¯èƒ½å…·å¤‡ JavaScriptï¼ŒTypeScript å’Œ PHP çš„ä¸“ä¸šçŸ¥è¯†ã€‚ ä½†æ˜¯ä¸ç®¡ä»–ä»¬ä½¿ç”¨ Go å·²æœ‰å¤šé•¿æ—¶é—´ï¼ŒPythonä¼¼ä¹Žéƒ½æ˜¯å¤§å¤šæ•°å—è®¿è€…ç†Ÿæ‚‰çš„è¯­è¨€ï¼ˆä¸æ˜¯GoðŸ¤”ï¼‰ã€‚ å—è®¿è€…æ‰€ä»Žäº‹çš„è¡Œä¸š åŽ»å¹´ï¼Œæˆ‘ä»¬è¯¢é—®äº†å—è®¿è€…ä»Žäº‹å“ªäº›è¡Œä¸šï¼Œå‘çŽ°å¤§å¤šæ•°äººåœ¨è½¯ä»¶ï¼Œäº’è”ç½‘æˆ–ç½‘ç»œæœåŠ¡å…¬å¸å·¥ä½œã€‚ ä»Šå¹´çœ‹æ¥ï¼Œå—è®¿è€…æ‰€ä»Žäº‹çš„è¡Œä¸šæ›´åŠ å¹¿æ³›äº†ã€‚ å—è®¿è€…å¯¹ Go å¼€æºé¡¹ç›®çš„è´¡çŒ® Go æ˜¯ä¸€ä¸ªæˆåŠŸçš„å¼€æºé¡¹ç›®ï¼Œä½†è¿™å¹¶ä¸æ„å‘³ç€ä½¿ç”¨å®ƒçš„å¼€å‘äººå‘˜ä¹Ÿæ­£åœ¨ç¼–å†™â€‹â€‹å…è´¹æˆ–å¼€æºè½¯ä»¶ã€‚ ä¸Žå¾€å¹´ä¸€æ ·ï¼Œæˆ‘ä»¬å‘çŽ°å¤§å¤šæ•°å—è®¿è€…å¹¶ä¸æ˜¯ Go å¼€æºé¡¹ç›®çš„é¢‘ç¹è´¡çŒ®è€…ï¼Œæœ‰ 75ï¼… çš„å—è®¿è€…è¡¨ç¤ºä»–ä»¬â€œå¾ˆå°‘â€æˆ–â€œä»Žä¸â€å‚ä¸Ž Go å¼€æºé¡¹ç›®ã€‚ éšç€Goç¤¾åŒºçš„æ‰©å±•ï¼Œæˆ‘ä»¬å‘çŽ°ä»Žæœªä¸º Go å¼€æºé¡¹ç›®åšå‡ºè¿‡è´¡çŒ®çš„å—è®¿è€…æ‰€å çš„æ¯”ä¾‹æ­£åœ¨ç¼“æ…¢ä¸Šå‡ã€‚ å¼€å‘å·¥å…·ç¯‡å—è®¿è€…å¼€å‘ä¸­ä½¿ç”¨çš„ OS ä¸Žå¾€å¹´ä¸€æ ·ï¼Œç»å¤§å¤šæ•°å¼€å‘è€…è¡¨ç¤ºåœ¨ Linux å’Œ macOS ç³»ç»Ÿä¸Šä½¿ç”¨ Goã€‚ è¿™æ˜¯æˆ‘ä»¬çš„å—è®¿è€…ä¸ŽStackOverflowçš„2019 å¹´è°ƒæŸ¥ç»“æžœä¹‹é—´å­˜åœ¨å¾ˆå¤§å·®å¼‚çš„ä¸€ä¸ªæ–¹é¢ï¼šåœ¨æˆ‘ä»¬çš„è°ƒæŸ¥ä¸­ï¼Œåªæœ‰20ï¼…çš„å—è®¿è€…ä½¿ç”¨ Windows ä½œä¸ºä¸»è¦å¼€å‘å¹³å°ï¼Œè€Œå¯¹äºŽ StackOverflow è€Œè¨€ï¼Œè¿™ä¸€æ¯”ä¾‹ä¸º 45ï¼…ã€‚ Linux çš„ä½¿ç”¨çŽ‡ä¸º 66ï¼…ï¼ŒmacOS çš„ä½¿ç”¨çŽ‡ä¸º 53ï¼…ï¼Œè¿™ä¸¤è€…éƒ½è¿œè¿œé«˜äºŽ StackOverflow çš„å—ä¼—ï¼ŒåŽè€…åˆ†åˆ«æŠ¥å‘Šäº† 25ï¼… å’Œ 30ï¼…ï¼ˆçœ‹æ¥ Gopher è¿˜æ˜¯å–œæ¬¢ UNIX å¤šä¸€äº›ï¼‰ã€‚ å—è®¿è€…ä½¿ç”¨çš„ IDE ä»Šå¹´ï¼ŒIDE æ•´åˆçš„è¶‹åŠ¿ä»åœ¨ç»§ç»­ã€‚ GoLand ä»Šå¹´çš„ä½¿ç”¨é‡å¢žé•¿æœ€å¿«ï¼Œä»Ž 24ï¼… â†’ 34ï¼… ä¸Šå‡ã€‚ VS Codeçš„å¢žé•¿é€Ÿåº¦æœ‰æ‰€æ”¾ç¼“ï¼Œä½†ä»ç„¶æ˜¯å—è®¿è€…ä¸­æœ€å—æ¬¢è¿Žçš„ç¼–è¾‘å™¨ï¼Œå 41ï¼…ã€‚ ç»“åˆèµ·æ¥ï¼Œè¿™ä¸¤ä¸ª IDE çŽ°åœ¨çš„å æœ‰çŽ‡æ˜¯ 75%ã€‚ å…³äºŽè‡ªå»º Go document server ä»Šå¹´ï¼Œæˆ‘ä»¬æ·»åŠ äº†ä¸€ä¸ªæœ‰å…³å†…éƒ¨ Go æ–‡æ¡£å·¥å…·ï¼ˆä¾‹å¦‚ gddo ï¼‰çš„é—®é¢˜ã€‚ å°‘æ•°å—è®¿è€…ï¼ˆ 6ï¼… ï¼‰è¡¨ç¤ºä»–ä»¬çš„ç»„ç»‡è¿è¡Œè‡ªå·±çš„Goæ–‡æ¡£æœåŠ¡å™¨ï¼Œå°½ç®¡å½“æˆ‘ä»¬æŸ¥çœ‹å¤§å…¬å¸å—è®¿è€…ï¼ˆæ‹¥æœ‰è‡³å°‘5,000åå‘˜å·¥ï¼‰æ—¶ï¼Œè¿™ä¸€æ¯”ä¾‹å‡ ä¹Žç¿»äº†ä¸€ç•ªï¼ˆè¾¾åˆ°11ï¼…ï¼‰ï¼Œä½†å½“æˆ‘ä»¬ä¸ŽåŽè€…äº¤æµæ—¶ï¼Œä»–ä»¬è¯´åŸºæœ¬å·²ç»åœæ­¢äº†è‡ªå»º document serverï¼ŒåŽŸå› æ˜¯æ”¶ç›Šå°ï¼Œæˆæœ¬é«˜ã€‚ å—è®¿è€…å¯¹ Go çš„ä½¿ç”¨æ„å‘ å¤§éƒ¨åˆ†å—è®¿è€…éƒ½è®¤ä¸º Go åœ¨ä»–ä»¬çš„å›¢é˜Ÿä¸­è¡¨çŽ°è‰¯å¥½ï¼ˆ86ï¼…ï¼‰ï¼Œå¹¶ä¸”ä»–ä»¬å¸Œæœ›å°†å…¶ç”¨äºŽä¸‹ä¸€ä¸ªé¡¹ç›®ï¼ˆ89ï¼…ï¼‰ã€‚ æˆ‘ä»¬è¿˜å‘çŽ°ï¼Œè¶…è¿‡ä¸€åŠçš„å—è®¿è€…ï¼ˆ59ï¼…ï¼‰è®¤ä¸º Go å¯¹å…¶å…¬å¸çš„æˆåŠŸè‡³å…³é‡è¦ã€‚ è‡ª2016å¹´ä»¥æ¥ï¼Œè¿™äº›æŒ‡æ ‡ä¸€ç›´ä¿æŒç¨³å®šã€‚ å—è®¿è€…å¯¹ Go ç”Ÿæ€çš„æ»¡æ„åº¦ åœ¨ Go ç”Ÿæ€çš„æ»¡æ„åº¦ä¸Šï¼Œæˆ‘ä»¬çœ‹åˆ°å¾ˆå¤§æ¯”ä¾‹çš„å—è®¿è€…åŒæ„æ¯ç§è¯´æ³•ï¼ˆ82ï¼…â€“88ï¼…ï¼‰ï¼Œå¹¶ä¸”åœ¨è¿‡åŽ»å››å¹´ä¸­ï¼Œè¿™äº›æ¯”çŽ‡åœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¿æŒç¨³å®šã€‚ å—è®¿è€…æ‰€åœ¨è¡Œä¸šå¯¹ Go ç”Ÿæ€çš„æ»¡æ„åº¦ ä»Šå¹´ï¼Œæˆ‘ä»¬å¯¹å„ä¸ªè¡Œä¸šçš„æ»¡æ„åº¦è¿›è¡Œäº†æ›´ç»†å¾®çš„è€ƒå¯Ÿï¼Œä»¥å»ºç«‹åŸºå‡†ã€‚ æ€»ä½“è€Œè¨€ï¼Œæ— è®ºè¡Œä¸šå¦‚ä½•ï¼Œå—è®¿è€…éƒ½å¯¹åœ¨å·¥ä½œä¸­ä½¿ç”¨Goè¡¨ç¤ºæ»¡æ„ã€‚ æˆ‘ä»¬ç¡®å®žåœ¨å‡ ä¸ªé¢†åŸŸï¼ˆå°¤å…¶æ˜¯åˆ¶é€ ä¸šï¼‰ä¸­çœ‹åˆ°äº†ä¸€äº›ä¸æ»¡ï¼Œæˆ‘ä»¬è®¡åˆ’é€šè¿‡åŽç»­ç ”ç©¶è¿›è¡Œè°ƒæŸ¥ã€‚ å—è®¿è€…å¯¹ Go ç‰¹æ€§çš„å…³æ³¨åº¦ åŒæ ·ï¼Œæˆ‘ä»¬è°ƒæŸ¥äº†å¯¹ Go å¼€å‘å„ä¸ªæ–¹é¢çš„æ»¡æ„åº¦ä»¥åŠé‡è¦æ€§ã€‚ å°†è¿™äº›ç»“æžœç»“åˆåœ¨ä¸€èµ·å¯ä»¥çªå‡ºæ˜¾ç¤ºä¸‰ä¸ªç‰¹åˆ«å…³æ³¨çš„ä¸»é¢˜ï¼šdebugï¼ˆåŒ…æ‹¬è°ƒè¯•å¹¶å‘æ€§ï¼‰ï¼Œgo modules å’Œ cloud serviceã€‚ å¤§å¤šæ•°äººéƒ½å°†è¿™äº›ä¸»é¢˜ä¸­çš„æ¯ä¸€ä¸ªè¯„ä¸ºâ€œéžå¸¸â€æˆ–â€œè‡³å…³é‡è¦â€ï¼Œä½†ä¸Žå…¶ä»–ä¸»é¢˜ç›¸æ¯”ï¼Œè¿™äº›æ–¹é¢çš„æ»¡æ„åº¦å¾—åˆ†æ˜Žæ˜¾è¾ƒä½Žã€‚ å—è®¿è€…å¯¹ Go ç¤¾åŒºçš„æ»¡æ„åº¦ ä¸Šé¢çš„è°ƒæŸ¥ç»“æžœå¯èƒ½ä¸è¶³ä¸ºå¥‡ï¼Œå› ä¸ºå‚ä¸Ž Go å¼€å‘è€…è°ƒæŸ¥çš„äººä»¬å–œæ¬¢ Go çš„æ¦‚çŽ‡æ›´å¤§ï¼ˆæ‰‹åŠ¨ç‹—å¤´ï¼‰ã€‚ ä½¿ç”¨ Go å®Œæˆçš„å·¥ä½œå†…å®¹æž„å»ºAPI / RPCæœåŠ¡ï¼ˆ71ï¼…ï¼‰å’ŒCLIï¼ˆ62ï¼…ï¼‰ä»ç„¶æ˜¯ Go çš„é‡å¤´æˆã€‚ æˆ‘ä»¬è°ƒæŸ¥äº†å—è®¿è€…ä½¿ç”¨ Go çš„æ›´å¤§é¢†åŸŸã€‚ åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæœ€å¸¸è§çš„é¢†åŸŸæ˜¯ Web å¼€å‘ï¼ˆ66ï¼…ï¼‰ï¼Œä½†å…¶ä»–å¸¸è§çš„é¢†åŸŸåŒ…æ‹¬æ•°æ®åº“ï¼ˆ45ï¼…ï¼‰ï¼Œç½‘ç»œç¼–ç¨‹ï¼ˆ42ï¼…ï¼‰ï¼Œç³»ç»Ÿç¼–ç¨‹ï¼ˆ38ï¼…ï¼‰å’Œ DevOps ï¼ˆ37ï¼…ï¼‰ã€‚ Go å¼€å‘è¿‡ç¨‹çš„å¸¸ç”¨æŠ€æœ¯é™¤äº†å—è®¿è€…æ­£åœ¨æž„å»ºçš„å†…å®¹ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜è¯¢é—®äº†ä»–ä»¬ä½¿ç”¨çš„ä¸€äº›å¼€å‘æŠ€æœ¯ã€‚ ç»å¤§å¤šæ•°å—è®¿è€…è¡¨ç¤ºï¼Œä»–ä»¬ä¾é  log è¿›è¡Œè°ƒè¯•ï¼ˆ88ï¼…ï¼‰ï¼Œè€Œä»–ä»¬çš„å›žç­”è¡¨æ˜Žï¼Œè¿™æ˜¯å› ä¸ºæä¾›çš„è°ƒè¯•å·¥å…·éš¾ä»¥æœ‰æ•ˆä½¿ç”¨ã€‚ ä½†æ˜¯ï¼Œæœ¬åœ°é€æ­¥è°ƒè¯•ï¼ˆä¾‹å¦‚ï¼Œä½¿ç”¨Delveï¼‰ï¼Œæ€§èƒ½åˆ†æžå’Œä½¿ç”¨ç«žäº‰æ£€æµ‹å™¨è¿›è¡Œæµ‹è¯•çš„æƒ…å†µå¹¶ä¸å°‘è§ï¼Œçº¦æœ‰50ï¼…çš„å—è®¿è€…å…¶ä½¿ç”¨ä¸­è‡³å°‘ä¸€ç§æŠ€æœ¯ã€‚ å…³äºŽ Go Modules åœ¨åŒ…ç®¡ç†æ–¹é¢ï¼Œæˆ‘ä»¬å‘çŽ°ç»å¤§å¤šæ•°å—è®¿è€…(89%)é‡‡ç”¨äº† Go Modulesã€‚å¯¹äºŽå¼€å‘è€…æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ä¸ªå·¨å¤§çš„è½¬å˜ï¼Œå‡ ä¹Žæ•´ä¸ªç¤¾åŒºéƒ½åœ¨åŒæ—¶ç»åŽ†è¿™ä¸€è½¬å˜ã€‚ äº‘åŽŸç”Ÿæ—¶ä»£çš„ GoGoåœ¨è®¾è®¡æ—¶è€ƒè™‘åˆ°äº†çŽ°ä»£åˆ†å¸ƒå¼è®¡ç®—ï¼Œæˆ‘ä»¬å¸Œæœ›ç»§ç»­æ”¹è¿›ä½¿ç”¨Goæž„å»ºäº‘æœåŠ¡çš„å¼€å‘äººå‘˜ä½“éªŒã€‚ä»Šå¹´ï¼Œæˆ‘ä»¬æ‰©å±•äº†å…³äºŽäº‘å¼€å‘çš„é—®é¢˜ï¼Œä»¥ä¾¿æ›´å¥½åœ°äº†è§£å—è®¿è€…å¦‚ä½•ä¸Žäº‘æä¾›å•†åˆä½œï¼Œä»–ä»¬å–œæ¬¢å½“å‰å¼€å‘è€…ä½“éªŒçš„å“ªäº›æ–¹é¢ï¼Œä»¥åŠå“ªäº›æ–¹é¢å¯ä»¥æ”¹è¿›ã€‚ æˆ‘ä»¬å¯ä»¥æ¸…æ™°åœ°æ„Ÿå—åˆ°ä»¥ä¸‹ä¸¤ä¸ªè¶‹åŠ¿ï¼š å…¨çƒä¸‰å¤§äº‘æä¾›å•†ï¼ˆAmazon Web Servicesï¼ŒGoogle Cloud Platformå’ŒMicrosoft Azureï¼‰åœ¨å—è®¿è€…ä¸­çš„ä½¿ç”¨çŽ‡å‡å‘ˆä¸Šå‡è¶‹åŠ¿ï¼Œè€Œå¤§å¤šæ•°å…¶ä»–æä¾›å•†æ¯å¹´ä½¿ç”¨çš„å—è®¿è€…æ¯”ä¾‹éƒ½è¾ƒå°ã€‚ åˆ°è‡ªæœ‰æˆ–å…¬å¸æ‹¥æœ‰çš„æœåŠ¡å™¨çš„æœ¬åœ°éƒ¨ç½²ç»§ç»­å‡å°‘ï¼Œå¹¶ä¸”åœ¨ç»Ÿè®¡ä¸Šå·²ä¸ŽAWSï¼ˆ44ï¼…æ¯”42ï¼…ï¼‰ç»‘å®šä¸ºæœ€å¸¸è§çš„éƒ¨ç½²å¹³å°ã€‚ Go project çš„éƒ¨ç½²äº‘å¹³å° æ€»ä½“è€Œè¨€ï¼Œå¤§å¤šæ•°å—è®¿è€…å¯¹åœ¨æ‰€æœ‰ä¸‰å¤§ä¸»è¦äº‘æä¾›å•†ä¸Šä½¿ç”¨ Go æ„Ÿåˆ°æ»¡æ„ã€‚ å—è®¿è€…å…·æœ‰å¯¹ Goï¼ˆAWSï¼‰ï¼ˆ80ï¼…æ»¡æ„ï¼‰å’ŒGCPï¼ˆ78ï¼…ï¼‰çš„ æ»¡æ„åº¦ã€‚ Go project çš„éƒ¨ç½²æœåŠ¡ç±»åž‹ å­˜åœ¨çš„ç—›ç‚¹å—è®¿è€…è¡¨ç¤ºæ— æ³•ä½¿ç”¨Goçš„ä¸»è¦åŽŸå› æœ‰ä¸‰ä¸ªï¼š ï¼ˆ56ï¼…ï¼‰å½“å‰çš„é¡¹ç›®æ­£åœ¨ä½¿ç”¨å…¶ä»–è¯­è¨€ï¼› å›¢é˜Ÿæ›´å€¾å‘äºŽä½¿ç”¨å…¶ä»–è¯­è¨€ï¼ˆ37ï¼…ï¼‰ï¼› Goæœ¬èº«ç¼ºä¹ä¸€äº›å…³é”®åŠŸèƒ½ ï¼ˆ25ï¼…ï¼‰ã€‚ å¯¹ä¸€äº› Go ç‰¹æ€§çš„æœŸå¾… åœ¨ 25% çš„å—è®¿è€…ä¸­ï¼Œè®¤ä¸º Go ç¼ºä¹ä»–ä»¬éœ€è¦çš„è¯­è¨€ç‰¹æ€§ã€‚å…¶ä¸­ 79% è®¤ä¸ºæ³›åž‹æ˜¯ä¸€ä¸ªä¸¥é‡ç¼ºå¤±çš„ç‰¹æ€§ã€‚22% çš„äººæåˆ°äº†å¯¹é”™è¯¯å¤„ç†çš„æŒç»­æ”¹è¿›(é™¤äº† Go 1.13 çš„æ›´æ”¹ä¹‹å¤–)ï¼Œ13 %çš„äººè¦æ±‚æ›´å¤šçš„å‡½æ•°å¼ç¼–ç¨‹ç‰¹æ€§ï¼Œå°¤å…¶æ˜¯å†…ç½®çš„map/filter/reduce åŠŸèƒ½ã€‚éœ€è¦è¯´æ˜Žçš„æ˜¯ï¼Œè¿™äº›æ•°å­—æ¥è‡ªå—è®¿è€…çš„å­é›†ï¼Œä»–ä»¬è¡¨ç¤ºï¼Œå¦‚æžœæä¾›äº†ä»–ä»¬éœ€è¦çš„ä¸€ä¸ªæˆ–å¤šä¸ªå…³é”®åŠŸèƒ½ï¼Œä»–ä»¬å°†èƒ½å¤Ÿæ›´å¤šåœ°ä½¿ç”¨ Goã€‚ æ²¡æœ‰ä½¿ç”¨ Go ä½œä¸ºé¡¹ç›®çš„è¯­è¨€çš„ä¸€äº›åŽŸå›  å¯¹äºŽä»–ä»¬æ‰€ä»Žäº‹çš„å·¥ä½œæ¥è¯´ï¼ŒGo â€œä¸æ˜¯ä¸€ç§åˆé€‚çš„è¯­è¨€â€çš„å—è®¿è€…æœ‰å„ç§å„æ ·çš„ç†ç”±å’Œç”¨ä¾‹ã€‚æœ€å¸¸è§çš„æ˜¯ä»–ä»¬ä»Žäº‹æŸç§å½¢å¼çš„å‰ç«¯å¼€å‘(22%)ï¼Œä¾‹å¦‚ç”¨äºŽ webã€æ¡Œé¢æˆ–ç§»åŠ¨è®¾å¤‡çš„g uiã€‚å¦ä¸€ä¸ªå¸¸è§çš„å›žç­”æ˜¯ï¼Œå—è®¿è€…è¯´ä»–ä»¬å·¥ä½œçš„é¢†åŸŸä¸­å·²ç»æœ‰å ä¸»å¯¼åœ°ä½çš„è¯­è¨€(9%)ï¼Œå› æ­¤å¾ˆéš¾ä½¿ç”¨ä¸åŒçš„è¯­è¨€ã€‚ä¸€äº›å—è®¿è€…è¿˜å‘Šè¯‰æˆ‘ä»¬ä»–ä»¬æŒ‡çš„æ˜¯å“ªä¸ªé¢†åŸŸ(æˆ–è€…åªæ˜¯æåˆ°äº†ä¸€ä¸ªé¢†åŸŸï¼Œè€Œæ²¡æœ‰æåˆ°å¦ä¸€ç§æ›´å¸¸è§çš„è¯­è¨€)ï¼Œæˆ‘ä»¬é€šè¿‡ä¸‹é¢çš„â€œI work on [domain]â€è¡Œæ¥è¯´æ˜Žè¿™ä¸€ç‚¹ã€‚å—è®¿è€…æåˆ°çš„å¦ä¸€ä¸ªä¸»è¦åŽŸå› æ˜¯éœ€è¦æ›´å¥½çš„æ€§èƒ½(9%)ï¼Œå°¤å…¶æ˜¯å®žæ—¶è®¡ç®—ã€‚ å—è®¿è€…è®¤ä¸ºç›®å‰å­˜åœ¨çš„æœ€å¤§çš„é˜»ç¢ å—è®¿è€…æŠ¥å‘Šçš„æœ€å¤§é˜»ç¢ä¸ŽåŽ»å¹´åŸºæœ¬ä¿æŒä¸€è‡´ã€‚ Go ç¼ºä¹æ³›åž‹å’Œæ¨¡å—ï¼ŒåŒ…ç®¡ç†å·¥å…·ä»ç„¶æ˜¯æœ€ä¸»è¦çš„é—®é¢˜ï¼ˆåˆ†åˆ«å åé¦ˆçš„15ï¼…å’Œ12ï¼…ï¼‰ï¼Œå¹¶ä¸”å¼ºè°ƒå·¥å…·é—®é¢˜çš„å—è®¿è€…æ¯”ä¾‹æœ‰æ‰€å¢žåŠ ã€‚ è¿™äº›æ•°å­—ä¸Žä¸Šé¢çš„å›¾è¡¨ä¸åŒï¼Œå› ä¸ºè¿™ä¸ªé—®é¢˜æ˜¯æ‰€æœ‰å—è®¿è€…éƒ½æå‡ºçš„ï¼Œæ— è®ºä»–ä»¬è¯´æœ€å¤§çš„é˜»ç¢ä»€ä¹ˆã€‚ è¿™ä¸‰ä¸ªé—®é¢˜éƒ½æ˜¯ä»Šå¹´ Go å›¢é˜Ÿå…³æ³¨çš„é¢†åŸŸï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨æœªæ¥å‡ ä¸ªæœˆå†…æžå¤§åœ°æ”¹å–„å¼€å‘äººå‘˜çš„ä½“éªŒï¼Œå°¤å…¶æ˜¯åœ¨æ¨¡å—ï¼Œå·¥å…·å’Œå…¥é—¨ç»éªŒæ–¹é¢ã€‚ Debug Go project çš„ç—›ç‚¹ ä»»ä½•ä¸€ç§è¯­è¨€çš„ debug å’Œ benchmark éƒ½å…·æœ‰æŒ‘æˆ˜æ€§ã€‚ å—è®¿è€…å‘Šè¯‰æˆ‘ä»¬ï¼Œè¿™ä¸¤ä¸ªæ–¹é¢çš„æœ€å¤§æŒ‘æˆ˜ä¸æ˜¯ Go çš„å·¥å…·æ‰€ç‰¹æœ‰çš„ï¼Œè€Œæ˜¯ä¸€ä¸ªæ›´æ ¹æœ¬çš„é—®é¢˜ï¼šç¼ºä¹çŸ¥è¯†ï¼Œç»éªŒæˆ–æœ€ä½³å®žè·µã€‚ æˆ‘ä»¬å¸Œæœ›åœ¨ä»Šå¹´æ™šäº›æ—¶å€™é€šè¿‡æ–‡æ¡£å’Œå…¶ä»–ææ–™æ¥å¸®åŠ©è§£å†³è¿™äº›é—®é¢˜ã€‚ å…¶ä»–ä¸»è¦é—®é¢˜æ¶‰åŠåˆ°å·¥å…·çš„ä½¿ç”¨ï¼Œå°¤å…¶æ˜¯åœ¨å­¦ä¹ /ä½¿ç”¨ Go çš„è°ƒè¯•å’Œ profile åˆ†æžå·¥å…·æ—¶ï¼Œåœ¨æˆæœ¬/æ”¶ç›Šæ–¹é¢å­˜åœ¨ä¸åˆ©çš„æƒè¡¡ï¼Œä»¥åŠä½¿å·¥å…·åœ¨å„ç§çŽ¯å¢ƒä¸­å·¥ä½œçš„æŒ‘æˆ˜ï¼ˆä¾‹å¦‚ï¼Œåœ¨å®¹å™¨ä¸­è¿›è¡Œè°ƒè¯•æˆ–ä»Žç”Ÿäº§çŽ¯å¢ƒä¸­èŽ·å–æ€§èƒ½åˆ†æžï¼‰ã€‚ Go communityå¤§çº¦ä¸‰åˆ†ä¹‹äºŒçš„å—è®¿è€…ä½¿ç”¨ Stack Overflow æ¥å›žç­”ä¸Ž go ç›¸å…³çš„é—®é¢˜(64%)ã€‚å…¶ä»–æŽ’åé å‰çš„ç­”æ¡ˆæ¥æºæ˜¯godoc.org(47%)ï¼Œç›´æŽ¥é˜…è¯»æºä»£ç (42%)å’Œ golang.org (33%)ã€‚ å…³äºŽ MeetUpä¸Šè¡¨çªå±•ç¤ºäº†ä¸åŒçš„å¯»æ±‚å¸®åŠ©çš„æ–¹å¼(å‡ ä¹Žéƒ½æ˜¯ç¤¾åŒºé©±åŠ¨çš„)ï¼Œå—è®¿è€…åœ¨ä½¿ç”¨Goå¼€å‘è¿‡ç¨‹ä¸­ä¾é å®ƒä»¬æ¥å…‹æœæŒ‘æˆ˜ã€‚äº‹å®žä¸Šï¼Œå¯¹äºŽè®¸å¤š gopher æ¥è¯´ï¼Œè¿™å¯èƒ½æ˜¯ä»–ä»¬ä¸Žæ›´å¤§çš„ç¤¾åŒºäº’åŠ¨çš„ä¸»è¦è¦ç‚¹ä¹‹ä¸€: éšç€æˆ‘ä»¬çš„ç¤¾åŒºä¸æ–­æ‰©å¤§ï¼Œæˆ‘ä»¬çœ‹åˆ°è¶Šæ¥è¶Šå¤šçš„å—è®¿è€…ä¸ç”¨å‚åŠ ä»»ä½•ä¸Ž go ç›¸å…³çš„æ´»åŠ¨ã€‚åœ¨2019å¹´ï¼Œè¿™ä¸€æ¯”ä¾‹æŽ¥è¿‘ä¸‰åˆ†ä¹‹äºŒçš„å—è®¿è€…(62%)ã€‚ å—è®¿è€…çš„è¯­è¨€ ç”±äºŽè°·æ­Œæ›´æ–°äº†å…¨è°·æ­ŒèŒƒå›´å†…çš„éšç§æŒ‡å—ï¼Œæˆ‘ä»¬æ— æ³•å†è¯¢é—®å—è®¿è€…ç”Ÿæ´»åœ¨å“ªä¸ªå›½å®¶ã€‚ç›¸åï¼Œæˆ‘ä»¬è¯¢é—®äº†é¦–é€‰çš„å£è¯­/ä¹¦é¢è¯­ä½œä¸º Go åœ¨å…¨çƒä½¿ç”¨çš„ç²—ç•¥è°ƒæŸ¥ï¼Œè¿™æœ‰åŠ©äºŽä¸ºæ½œåœ¨çš„æœ¬åœ°åŒ–å·¥ä½œæä¾›æ•°æ®ã€‚ ç”±äºŽæœ¬æ¬¡è°ƒæŸ¥æ˜¯ç”¨è‹±è¯­è¿›è¡Œçš„ï¼Œå› æ­¤å¯¹äºŽè®²è‹±è¯­çš„äººå’Œè‹±è¯­ä¸ºç¬¬äºŒæˆ–ç¬¬ä¸‰ç§å¸¸è§è¯­è¨€çš„äººç¾¤å¯èƒ½ä¼šæœ‰å¾ˆå¤§çš„è¯¯å·®ã€‚ å› æ­¤ï¼Œéžè‹±è¯­æ•°å­—åº”è§£é‡Šä¸ºå¯èƒ½çš„æœ€å°å€¼ï¼Œè€Œä¸æ˜¯Goçš„å…¨çƒå—ä¼—äººæ•°çš„è¿‘ä¼¼å€¼ã€‚ Conclusionæˆ‘ä»¬å¸Œæœ›ä½ äº†è§£è¿™æ¬¡ 2019 å¹´å¼€å‘è€…è°ƒæŸ¥çš„ç»“æžœã€‚äº†è§£å¼€å‘äººå‘˜çš„ç»éªŒå’ŒæŒ‘æˆ˜æœ‰åŠ©äºŽæˆ‘ä»¬ä¸º 2020 å¹´åˆ¶å®šè®¡åˆ’å¹¶ç¡®å®šå·¥ä½œçš„ä¼˜å…ˆçº§ã€‚å†ä¸€æ¬¡ï¼Œéžå¸¸æ„Ÿè°¢æ‰€æœ‰å‚ä¸Žè°ƒæŸ¥çš„äººï¼Œä½ ä»¬çš„åé¦ˆå°†æœ‰åŠ©äºŽåœ¨æœªæ¥ä¸€å¹´ç”šè‡³æ›´é•¿çš„æ—¶é—´å†…å¼•å¯¼ Go å‰è¿›çš„æ–¹å‘ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ‰‹æŠŠæ‰‹æ•™ä½ å®žçŽ°é«˜æ€§èƒ½ kubernetes web terminal]]></title>
    <url>%2F2020%2F04%2F24%2F%E6%89%8B%E6%8A%8A%E6%89%8B%E6%95%99%E4%BD%A0%E5%AE%9E%E7%8E%B0%E9%AB%98%E6%80%A7%E8%83%BD-kubernetes-web-terminal%2F</url>
    <content type="text"><![CDATA[## ## ##]]></content>
  </entry>
  <entry>
    <title><![CDATA[å¹¶å‘è®¿é—® slice å¦‚ä½•åšåˆ°ä¼˜é›…å’Œå®‰å…¨ï¼Ÿ]]></title>
    <url>%2F2020%2F04%2F22%2F%E5%B9%B6%E5%8F%91%E8%AE%BF%E9%97%AE-slice-%E5%A6%82%E4%BD%95%E5%81%9A%E5%88%B0%E4%BC%98%E9%9B%85%E5%92%8C%E5%AE%89%E5%85%A8%EF%BC%9F%2F</url>
    <content type="text"><![CDATA[æŠ›å‡ºé—®é¢˜ç”±äºŽ slice/map æ˜¯å¼•ç”¨ç±»åž‹ï¼Œgolangå‡½æ•°æ˜¯ä¼ å€¼è°ƒç”¨ï¼Œæ‰€ç”¨å‚æ•°å‰¯æœ¬ä¾ç„¶æ˜¯åŽŸæ¥çš„ sliceï¼Œ å¹¶å‘è®¿é—®åŒä¸€ä¸ªèµ„æºä¼šå¯¼è‡´ç«Ÿæ€æ¡ä»¶ã€‚ çœ‹ä¸‹é¢è¿™æ®µä»£ç ï¼š 123456789101112131415161718192021222324252627282930package mainimport ( "fmt" "sync")func main() &#123; var ( slc = []int&#123;&#125; n = 10000 wg sync.WaitGroup ) wg.Add(n) for i := 0; i &lt; n; i++ &#123; go func() &#123; slc = append(slc, i) wg.Done() &#125;() &#125; wg.Wait() fmt.Println("len:", len(slc)) fmt.Println("done")&#125;// Output:len: 8586done çœŸå®žçš„è¾“å‡ºå¹¶æ²¡æœ‰è¾¾åˆ°æˆ‘ä»¬çš„é¢„æœŸï¼Œlen(slice) &lt; nã€‚ é—®é¢˜å‡ºåœ¨å“ªï¼Ÿæˆ‘ä»¬éƒ½çŸ¥é“sliceæ˜¯å¯¹æ•°ç»„ä¸€ä¸ªè¿žç»­ç‰‡æ®µçš„å¼•ç”¨ï¼Œå½“sliceé•¿åº¦å¢žåŠ çš„æ—¶å€™ï¼Œå¯èƒ½åº•å±‚çš„æ•°ç»„ä¼šè¢«æ¢æŽ‰ã€‚å½“å‡ºåœ¨æ¢åº•å±‚æ•°ç»„ä¹‹å‰ï¼Œåˆ‡ç‰‡åŒæ—¶è¢«å¤šä¸ªgoroutineæ‹¿åˆ°ï¼Œå¹¶æ‰§è¡Œappendæ“ä½œã€‚é‚£ä¹ˆå¾ˆå¤šgoroutineçš„appendç»“æžœä¼šè¢«è¦†ç›–ï¼Œå¯¼è‡´nä¸ªgouroutine appendåŽï¼Œé•¿åº¦å°äºŽnã€‚ é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿmap åœ¨ go 1.9 ä»¥åŽå®˜æ–¹å°±ç»™å‡ºäº† sync.map çš„è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯å¦‚æžœè¦å¹¶å‘è®¿é—® slice å°±è¦è‡ªå·±å¥½å¥½è®¾è®¡ä¸€ä¸‹äº†ã€‚ä¸‹é¢æä¾›ä¸¤ç§æ–¹å¼ï¼Œå¸®åŠ©ä½ è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ–¹æ¡ˆ 1: åŠ é” ðŸ”1234567891011121314151617181920func main() &#123; slc := make([]int, 0, 1000) var wg sync.WaitGroup var lock sync.Mutex for i := 0; i &lt; 1000; i++ &#123; wg.Add(1) go func(a int) &#123; defer wg.Done() // åŠ ðŸ” lock.Lock() defer lock.Unlock() slc = append(slc, a) &#125;(i) wg.Wait() &#125; fmt.Println(len(slc))&#125; ä¼˜ç‚¹æ˜¯æ¯”è¾ƒç®€å•ï¼Œé€‚åˆå¯¹æ€§èƒ½è¦æ±‚ä¸é«˜çš„åœºæ™¯ã€‚ æ–¹æ¡ˆ 2ï¼š ä½¿ç”¨ channel ä¸²è¡ŒåŒ–æ“ä½œ12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061type ServiceData struct &#123; ch chan int // ç”¨æ¥ åŒæ­¥çš„channel data []int // å­˜å‚¨æ•°æ®çš„slice&#125;func (s *ServiceData) Schedule() &#123; // ä»Ž channel æŽ¥æ”¶æ•°æ® for i := range s.ch &#123; s.data = append(s.data, i) &#125;&#125;func (s *ServiceData) Close() &#123; // æœ€åŽå…³é—­ channel close(s.ch)&#125;func (s *ServiceData) AddData(v int) &#123; s.ch &lt;- v // å‘é€æ•°æ®åˆ° channel&#125;func NewScheduleJob(size int, done func()) *ServiceData &#123; s := &amp;ServiceData&#123; ch: make(chan int, size), data: make([]int, 0), &#125; go func() &#123; // å¹¶å‘åœ° append æ•°æ®åˆ° slice s.Schedule() done() &#125;() return s&#125;func main() &#123; var ( wg sync.WaitGroup n = 1000 ) c := make(chan struct&#123;&#125;) // new äº†è¿™ä¸ª job åŽï¼Œè¯¥ job å°±å¼€å§‹å‡†å¤‡ä»Ž channel æŽ¥æ”¶æ•°æ®äº† s := NewScheduleJob(n, func() &#123; c &lt;- struct&#123;&#125;&#123;&#125; &#125;) wg.Add(n) for i := 0; i &lt; n; i++ &#123; go func(v int) &#123; defer wg.Done() s.AddData(v) &#125;(i) &#125; wg.Wait() s.Close() &lt;-c fmt.Println(len(s.data))&#125; å®žçŽ°ç›¸å¯¹å¤æ‚ï¼Œä¼˜ç‚¹æ˜¯æ€§èƒ½å¾ˆå¥½ï¼Œåˆ©ç”¨äº†channelçš„ä¼˜åŠ¿ ä»¥ä¸Šä»£ç éƒ½æœ‰æ¯”è¾ƒè¯¦ç»†çš„æ³¨é‡Šï¼Œå°±ä¸å±•å¼€è®²äº†ã€‚]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[javaè½¬goé‡åˆ°Apollo?è®©agolloæ¥å¸®ä½ å¹³æ»‘è¿ç§»]]></title>
    <url>%2F2020%2F04%2F17%2Fjava%E8%BD%ACgo%E9%81%87%E5%88%B0Apollo-%E8%AE%A9agollo%E6%9D%A5%E5%B8%AE%E4%BD%A0%E5%B9%B3%E6%BB%91%E8%BF%81%E7%A7%BB%2F</url>
    <content type="text"><![CDATA[Introductionagollo æ˜¯Apolloçš„ Golang å®¢æˆ·ç«¯ Apolloï¼ˆé˜¿æ³¢ç½—ï¼‰æ˜¯æºç¨‹æ¡†æž¶éƒ¨é—¨ç ”å‘çš„åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒï¼Œèƒ½å¤Ÿé›†ä¸­åŒ–ç®¡ç†åº”ç”¨ä¸åŒçŽ¯å¢ƒã€ä¸åŒé›†ç¾¤çš„é…ç½®ï¼Œé…ç½®ä¿®æ”¹åŽèƒ½å¤Ÿå®žæ—¶æŽ¨é€åˆ°åº”ç”¨ç«¯ï¼Œå¹¶ä¸”å…·å¤‡è§„èŒƒçš„æƒé™ã€æµç¨‹æ²»ç†ç­‰ç‰¹æ€§ï¼Œé€‚ç”¨äºŽå¾®æœåŠ¡é…ç½®ç®¡ç†åœºæ™¯ã€‚ å¦‚æžœåœ¨ä½¿ç”¨ golang é‡æž„ java çš„è¿‡ç¨‹ä¸­ï¼Œä½¿ç”¨åˆ°äº†åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒ Apolloï¼Œé‚£ä¹ˆæœ€å¿«çš„æ–¹å¼å°±æ˜¯ä½¿ç”¨åŽŸæ¥çš„é…ç½®ï¼Œä¿æŒæœ€å¹³æ»‘çš„è¿ç§»ï¼Œè¿™ä¸ªæ—¶å€™ä½ å°±éœ€è¦ä¸€ä¸ª Apollo çš„ golang å®¢æˆ·ç«¯ï¼Œagollo å¯ä»¥æ˜¯ä½ çš„ä¸€ä¸ªé€‰æ‹©ã€‚ ä½¿ç”¨æŒ‡å—1.1.çŽ¯å¢ƒè¦æ±‚ Go 1.11+ (æœ€å¥½ä½¿ç”¨Go 1.12) 1.2.ä¾èµ–1.2.1.ä½¿ç”¨ go get æ–¹å¼1go get -u github.com/zouyx/agollo/v3@latest 1.2.2.ä½¿ç”¨ go mod æ–¹å¼go.mod1require github.com/zouyx/agollo/v3 latest æ‰§è¡Œ1go mod tidy import123import ( "github.com/zouyx/agollo/v3") FAQ ä¸ºä»€ä¹ˆè¦åŠ +incompatible go.modä¸èƒ½ä¸‹è½½agolloçš„è§£å†³æ–¹æ³• 1.3.å¿…è¦è®¾ç½®Apollo å®¢æˆ·ç«¯ä¾èµ–äºŽ AppIdï¼ŒEnvironment ç­‰çŽ¯å¢ƒä¿¡æ¯æ¥å·¥ä½œï¼Œæ‰€ä»¥è¯·ç¡®ä¿é˜…è¯»ä¸‹é¢çš„è¯´æ˜Žå¹¶ä¸”åšæ­£ç¡®çš„é…ç½®ï¼š main ï¼š your application app.properties (å¿…è¦) ï¼š è¿žæŽ¥æœåŠ¡ç«¯å¿…è¦é…ç½® seelog.xmlï¼ˆéžå¿…è¦ï¼‰ 1.3.1.é…ç½®åŠ è½½ä¼˜å…ˆçº§ï¼š ç±»é…ç½® çŽ¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶ é»˜è®¤ï¼ˆapp.propertiesï¼‰é…ç½®æ–‡ä»¶ 1.3.1.1.ç±»é…ç½®ä¼šè¦†ç›–app.propertiesä¸­é…ç½®ï¼Œåœ¨è°ƒç”¨Startæ–¹æ³•ä¹‹å‰è°ƒç”¨ 12345678910readyConfig:=&amp;AppConfig&#123; AppId:"test1", Cluster:"dev1", NamespaceName:"application1", Ip:"localhost:8889", &#125; InitCustomConfig(func() (*AppConfig, error) &#123; return readyConfig,nil &#125;) ç±»é…ç½® agollo çš„ demo: 12345678910111213141516171819202122232425262728293031323334353637383940package mainimport ( "fmt" "github.com/zouyx/agollo/v3" "github.com/zouyx/agollo/v3/env/config")func InitAgolloConfig() error &#123; readyConfig := &amp;config.AppConfig&#123; AppID: "test", Cluster: "default", NamespaceName: "application", IP: "localhost:8080", &#125; agollo.InitCustomConfig(func() (*config.AppConfig, error) &#123; return readyConfig, nil &#125;) err := agollo.Start() if err != nil &#123; fmt.Errorf("%v", err) return err &#125; return nil&#125;func main()&#123; //Init Apollo err := config.InitAgolloConfig() if err != nil &#123; fmt.Errorf("åˆå§‹åŒ–Apolloå¤±è´¥", err) panic(err) &#125; fmt.Println("åˆå§‹åŒ–Apolloé…ç½®æˆåŠŸ") //Use your apollo key to test value := agollo.GetStringValue("key", "") fmt.Println(value)&#125; 1.3.1.2.çŽ¯å¢ƒå˜é‡æŒ‡å®šé…ç½®æ–‡ä»¶Linux/Mac1export AGOLLO_CONF=/a/conf.properties Windows1set AGOLLO_CONF=c:/a/conf.properties é…ç½®æ–‡ä»¶å†…å®¹ä¸Žapp.propertieså†…å®¹ä¸€æ · 1.3.1.3.æ–‡ä»¶é…ç½® - app.properties1.å¼€å‘:è¯·ç¡®ä¿ app.properties æ–‡ä»¶å­˜åœ¨äºŽworkingdirç›®å½•ä¸‹ 2.æ‰“åŒ…åŽ:è¯·ç¡®ä¿ app.properties æ–‡ä»¶å­˜åœ¨äºŽä¸Žæ‰“åŒ…ç¨‹åºåŒçº§ç›®å½•ä¸‹ï¼Œå‚è€ƒ1.3.å¿…è¦é…ç½®ã€‚ ç›®å‰åªæ”¯æŒjsonå½¢å¼ï¼Œå…¶ä¸­å­—æ®µåŒ…æ‹¬ï¼š appId ï¼šåº”ç”¨çš„èº«ä»½ä¿¡æ¯ï¼Œæ˜¯ä»ŽæœåŠ¡ç«¯èŽ·å–é…ç½®çš„ä¸€ä¸ªé‡è¦ä¿¡æ¯ã€‚ cluster ï¼šéœ€è¦è¿žæŽ¥çš„é›†ç¾¤ï¼Œé»˜è®¤default namespaceName ï¼šå‘½åç©ºé—´ï¼Œé»˜è®¤ï¼šapplicationï¼ˆå…·ä½“å®šä¹‰å‚è€ƒï¼šnamespaceï¼‰,å¤šnamespaceä½¿ç”¨è‹±æ–‡é€—å·åˆ†å‰²ï¼Œéžkey/valueé…ç½®ï¼ˆjson,properties,ymlç­‰ï¼‰ï¼Œåˆ™é…ç½®ä¸ºï¼šnamespace.æ–‡ä»¶ç±»åž‹ã€‚å¦‚ï¼šnamespace.json ip ï¼šApolloçš„CONFIG_SERVICEçš„ipï¼ŒéžMETA_SERVICEåœ°å€ é…ç½®ä¾‹å­å¦‚ä¸‹ï¼š ä¸€èˆ¬é…ç½®123456&#123; "appId": "test", "cluster": "dev", "namespaceName": "application", "ip": "localhost:8888"&#125; å¤šnamespaceé…ç½®123456&#123; "appId": "test", "cluster": "dev", "namespaceName": "application, applications1", "ip": "localhost:8888"&#125; éžkey/value namespaceé…ç½®123456&#123; "appId": "test", "cluster": "dev", "namespaceName": "application.json,a.yml", "ip": "localhost:8888"&#125; 1.4æ—¥å¿—ç»„ä»¶å‚è€ƒ: è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶ ä½¿ç”¨seelogæ—¥å¿—ç»„ä»¶ å¯åŠ¨æ–¹å¼ å¼‚æ­¥å¯åŠ¨ agollo åœºæ™¯ï¼šå¯åŠ¨ç¨‹åºä¸ä¾èµ–åŠ è½½Apolloçš„é…ç½®ã€‚ 123func main() &#123; go agollo.Start()&#125; åŒæ­¥å¯åŠ¨ agolloï¼ˆv1.2.0+ï¼‰ åœºæ™¯ï¼šå¯åŠ¨ç¨‹åºä¾èµ–åŠ è½½ Apollo çš„é…ç½®ã€‚ä¾‹ï¼šåˆå§‹åŒ–ç¨‹åºåŸºç¡€é…ç½®ã€‚ 123func main() &#123; agollo.Start()&#125; å¯åŠ¨ agollo - è‡ªå®šä¹‰ logger æŽ§ä»¶ 123func main() &#123; agollo.StartWithLogger(loggerInterface)&#125; å¯åŠ¨ agollo - è‡ªå®šä¹‰ cache æŽ§ä»¶ (v1.7.0+) 123func main() &#123; agollo.StartWithCache(cacheInterface)&#125; å¯åŠ¨ agollo - è‡ªå®šä¹‰å„ç§æŽ§ä»¶ (v1.8.0+) 12345func main() &#123; agollo.SetLogger(loggerInterface) agollo.SetCache(cacheInterface) agollo.Start()&#125; ç›‘å¬å˜æ›´äº‹ä»¶ï¼ˆé˜»å¡žï¼‰ 123456func main() &#123; event := agollo.ListenChangeEvent() changeEvent := &lt;-event bytes, _ := json.Marshal(changeEvent) fmt.Println("event:", string(bytes))&#125; åŸºæœ¬æ–¹æ³• String 1agollo.GetStringValue(Key,DefaultValue) Int 1agollo.GetIntValue(Key,DefaultValue) Float 1agollo.GetFloatValue(Key,DefaultValue) Bool 1agollo.GetBoolValue(Key,DefaultValue) åˆ‡æ¢namespaceèŽ·å–é…ç½® æ ¹æ®namespaceèŽ·å–é…ç½® 1config := agollo.GetConfig(namespace) String 1config.GetStringValue(Key,DefaultValue) Int 1config.GetIntValue(Key,DefaultValue) Float 1config.GetFloatValue(Key,DefaultValue) Bool 1config.GetBoolValue(Key,DefaultValue) è‡ªå®šä¹‰æ—¥å¿—ç»„ä»¶å¤åˆ¶ä»¥ä¸‹ä»£ç è‡³é¡¹ç›®ä¸­ï¼Œå¹¶åœ¨å…¶ä¸­å¼•ç”¨æ—¥å¿—ç»„ä»¶çš„æ–¹æ³•è¿›è¡Œæ‰“å° log 1234567891011121314151617181920212223242526272829303132333435type DefaultLogger struct &#123;&#125;func (this *DefaultLogger)Debugf(format string, params ...interface&#123;&#125;) &#123;&#125;func (this *DefaultLogger)Infof(format string, params ...interface&#123;&#125;) &#123;&#125;func (this *DefaultLogger)Warnf(format string, params ...interface&#123;&#125;) error &#123; return nil&#125;func (this *DefaultLogger)Errorf(format string, params ...interface&#123;&#125;) error &#123; return nil&#125;func (this *DefaultLogger)Debug(v ...interface&#123;&#125;) &#123;&#125;func (this *DefaultLogger)Info(v ...interface&#123;&#125;)&#123;&#125;func (this *DefaultLogger)Warn(v ...interface&#123;&#125;) error&#123; return nil&#125;func (this *DefaultLogger)Error(v ...interface&#123;&#125;) error&#123; return nil&#125; å¯åŠ¨ 1234func main() &#123; agollo.SetLogger(&amp;DefaultLogger&#123;&#125;) agollo.Start()&#125; è‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶å£°æ˜Žè‡ªå®šä¹‰ç¼“å­˜ç»„ä»¶12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455//DefaultCache é»˜è®¤ç¼“å­˜type DefaultCache struct &#123; defaultCache sync.Map&#125;//Set èŽ·å–ç¼“å­˜func (d *DefaultCache)Set(key string, value []byte, expireSeconds int) (err error) &#123; d.defaultCache.Store(key,value) return nil&#125;//EntryCount èŽ·å–å®žä½“æ•°é‡func (d *DefaultCache)EntryCount() (entryCount int64)&#123; count:=int64(0) d.defaultCache.Range(func(key, value interface&#123;&#125;) bool &#123; count++ return true &#125;) return count&#125;//Get èŽ·å–ç¼“å­˜func (d *DefaultCache)Get(key string) (value []byte, err error)&#123; v, ok := d.defaultCache.Load(key) if !ok&#123; return nil,errors.New("load default cache fail") &#125; return v.([]byte),nil&#125;//Range éåŽ†ç¼“å­˜func (d *DefaultCache)Range(f func(key, value interface&#123;&#125;) bool)&#123; d.defaultCache.Range(f)&#125;//Del åˆ é™¤ç¼“å­˜func (d *DefaultCache)Del(key string) (affected bool) &#123; d.defaultCache.Delete(key) return true&#125;//Clear æ¸…é™¤æ‰€æœ‰ç¼“å­˜func (d *DefaultCache)Clear() &#123; d.defaultCache=sync.Map&#123;&#125;&#125;//DefaultCacheFactory æž„é€ é»˜è®¤ç¼“å­˜ç»„ä»¶å·¥åŽ‚ç±»type DefaultCacheFactory struct &#123;&#125;//Create åˆ›å»ºé»˜è®¤ç¼“å­˜ç»„ä»¶func (d *DefaultCacheFactory) Create()CacheInterface &#123; return &amp;DefaultCache&#123;&#125;&#125; ä½¿ç”¨è‡ªå®šä¹‰ç¼“å­˜12agollo.SetCache(&amp;DefaultCacheFactory&#123;&#125;)agollo.Start() é¡¹ç›®åœ°å€: https://github.com/zouyx/agollo â€‹ æ–¹èµ„è®¯\æœ€æ–°æŠ€æœ¯*ç‹¬å®¶è§£è¯»*]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[fuckdb Lite, å¸®åŠ©ä½ æ›´å¿«åœ°ç”Ÿæˆgo structä»£ç ]]></title>
    <url>%2F2020%2F04%2F06%2Ffuckdb-Lite-%E5%B8%AE%E5%8A%A9%E4%BD%A0%E6%9B%B4%E5%BF%AB%E5%9C%B0%E7%94%9F%E6%88%90go-struct%E4%BB%A3%E7%A0%81%2F</url>
    <content type="text"><![CDATA[å‰è¨€&amp;èƒŒæ™¯åœ¨golangçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ormçš„æ—¶å€™ï¼Œå¸¸å¸¸éœ€è¦å°†æ•°æ®åº“è¡¨å¯¹åº”åˆ°golangçš„ä¸€ä¸ªstructï¼Œè¿™äº›structä¼šæºå¸¦ormå¯¹åº”çš„tagï¼Œå°±åƒä¸‹é¢çš„structå®šä¹‰ä¸€æ ·ï¼š12345678910111213141516type InsInfo struct &#123; Connections string `gorm:&quot;column:connections&quot;` CPU int `gorm:&quot;column:cpu&quot;` CreateTime time.Time `gorm:&quot;column:create_time&quot;` Env int `gorm:&quot;column:env&quot;` ID int64 `gorm:&quot;column:id;primary_key&quot;` IP string `gorm:&quot;column:ip&quot;` Organization string `gorm:&quot;column:organization&quot;` Pass string `gorm:&quot;column:pass&quot;` Port string `gorm:&quot;column:port&quot;` RegionId string `gorm:&quot;column:regionid&quot;` ServerIP string `gorm:&quot;column:server_ip&quot;` Status int `gorm:&quot;column:status&quot;` Type string `gorm:&quot;column:type&quot;` UUID string `gorm:&quot;column:uuid&quot;`&#125; è¿™æ˜¯gormå¯¹åº”çš„æ•°æ®åº“è¡¨çš„structæ˜ å°„ï¼Œå³ä½¿æ•°æ®è¡¨çš„å­—æ®µä¸å¤šï¼Œå¦‚æžœæ˜¯æ‰‹åŠ¨å†™èµ·æ¥ä¹Ÿæ˜¯ä¸€äº›é‡å¤æ€§çš„å·¥ä½œã€‚åƒMySQLè¿™ç§å…³ç³»åž‹æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ormåŽ»æ“ä½œæ•°æ®åº“ï¼ŒäºŽæ˜¯å°±æƒ³mysqlçš„æ•°æ®è¡¨èƒ½ä¸èƒ½æ¥è‡ªåŠ¨ç”Ÿæˆgolang çš„structå®šä¹‰ ï¼Œå‡å°‘é‡å¤æ€§çš„å¼€å‘å·¥ä½œï¼ˆæ—©ç‚¹ä¸‹ç­ï¼‰ã€‚ çŽ°çŠ¶è°ƒç ”äº†ä¸€ä¸‹ç›®å‰æœ‰ä¸€äº›å·¥å…·ï¼Œæ¯”å¦‚chromeæ’ä»¶SQL2Struct(ä¸€æ¬¾æ ¹æ®sqlè¯­å¥è‡ªåŠ¨ç”Ÿæˆgolangç»“æž„ä½“çš„chromeæ’ä»¶)ï¼Œæ„Ÿè§‰ç”¨èµ·æ¥æ¯”è¾ƒç¹çï¼Œæ¯æ¬¡éœ€è¦è¿›å…¥æ•°æ®åº“ï¼Œæ‰§è¡ŒSQLè¯­å¥æ‹¿åˆ°å»ºè¡¨è¯­å¥copyåˆ°æµè§ˆå™¨ä¸­ï¼Œæ‰èƒ½ä½¿ç”¨ã€‚åœ¨æƒ³èƒ½ä¸èƒ½æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„çŽ¯å¢ƒï¼Œæä¾›webç•Œé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼Œå°±å¯ä»¥ä¸€é”®ç”Ÿæˆå¯¹åº”çš„ORMçš„structï¼ŒäºŽæ˜¯å°±è¯žç”Ÿäº†è¿™ä¸ªé¡¹ç›®ï¼šhttps://github.com/hantmac/fuckdb åŽŸç†mysqlæœ‰ä¸ªè‡ªå¸¦çš„æ•°æ®åº“information_schemaï¼Œæœ‰ä¸€å¼ è¡¨COLUMNSï¼Œå®ƒçš„å­—æ®µåŒ…å«æ•°æ®åº“åã€è¡¨åã€å­—æ®µåã€å­—æ®µç±»åž‹ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¡¨çš„æ•°æ®ï¼ŒæŠŠå¯¹åº”çš„è¡¨çš„å­—æ®µä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œç„¶åŽå†æ ¹æ®golangçš„è¯­æ³•è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„structã€‚å…·ä½“ä¸è¯¦ç»†å±•å¼€äº†ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥åŽ»çœ‹ä¸‹æºç ã€‚ Web ç‰ˆè¿žæŽ¥æœ¬åœ°æ•°æ®åº“å¦‚æžœä½ çš„æ•°æ®åº“åœ¨æœ¬åœ°ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œ docker-compose up -dï¼Œè®¿é—®localhost:8000ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç•Œé¢ï¼š æœåŠ¡å™¨ä¸Šçš„æ•°æ®åº“å¦‚æžœä½ çš„æ•°æ®åº“åœ¨å†…ç½‘æœåŠ¡å™¨ä¸Šï¼Œä½ éœ€è¦å…ˆä¿®æ”¹åŽç«¯æŽ¥å£çš„ip:port,ç„¶åŽé‡æ–°build Dockeré•œåƒï¼Œpushåˆ°è‡ªå·±çš„é•œåƒä»“åº“ï¼Œç„¶åŽä¿®æ”¹docker-compose.yamlï¼Œå†æ‰§è¡Œdocker-compose up -dã€‚ä¿®æ”¹çš„ä½ç½®æ˜¯ï¼šfuckdb/frontend/src/config/index.js.1234567891011let APIdb2structif(process.env.NODE_ENV === &quot;development&quot;)&#123; APIdb2struct = &quot;http://0.0.0.0:8000&quot; //ä¿®æ”¹ä¸ºéƒ¨ç½²æœåŠ¡å™¨çš„ip&#125;else&#123; APIdb2struct = &quot;http://0.0.0.0:8000&quot; //ä¿®æ”¹ä¸ºéƒ¨ç½²æœåŠ¡å™¨çš„ip&#125;export default &#123; APIdb2struct&#125; åªéœ€è¦å¡«å…¥æ•°æ®åº“ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠä½ æƒ³å¾—åˆ°çš„golangä»£ç çš„package nameã€struct name,ç„¶åŽç‚¹å‡»ç”Ÿæˆï¼Œå°±å¯ä»¥å¾—åˆ°gormå¯¹åº”çš„ç»“æž„ä½“æ˜ å°„ã€‚ åœ¨ä½ çš„é¡¹ç›®é¡¹ç›®ä¸­åªè¦ Ctrl+C&amp;Ctrl+V å³å¯ã€‚æˆ‘ä»¬çŸ¥é“golangçš„structçš„tagæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œè¿™é‡Œä¹Ÿæä¾›äº†å¾ˆå¤štagçš„å¯é€‰é¡¹ï¼Œæ¯”å¦‚json,xmlç­‰ï¼ŒåŽé¢ä¼šå¢žåŠ æ›´å¤šçš„tagå¯é€‰é¡¹æ”¯æŒã€‚ webç‰ˆçš„ç‰¹è‰²åŠŸèƒ½æ˜¯æ•°æ®åº“ä¿¡æ¯ç¼“å­˜åŠŸèƒ½ï¼Œèƒ½å¤Ÿè®°å¿†ä½ ä¹‹å‰å¡«å†™è¿‡çš„æ•°æ®åº“ä¿¡æ¯ï¼ŒçœåŽ»äº†å¤§é‡é‡å¤çš„æ“ä½œï¼Œä½ ä¸ç”¨å†å¡«å†™ç¹ççš„æ•°æ®åº“åï¼Œè¡¨åï¼Œåªéœ€ä¸€é”®ï¼Œå°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„ä»£ç ï¼Œé…åˆé™„å¸¦json-to-goæ’ä»¶(https://github.com/mholt/json-to-go)ï¼Œå¼€å‘æ•ˆçŽ‡å¾—åˆ°æžé€Ÿæå‡ã€‚ç›®å‰è¿™ä¸ªå·¥å…·åœ¨æˆ‘ä»¬ç»„å†…å·²ç»å¼€å§‹ä½¿ç”¨ï¼Œåé¦ˆæ¯”è¾ƒå¥½ï¼ŒèŠ‚çœäº†å¾ˆå¤šé‡å¤çš„å·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨å¼€å‘çš„æ—¶å€™ç”¨åˆ°åŒä¸€ä¸ªåº“çš„å¤šå¼ è¡¨ï¼Œå¾ˆå¿«å°±å¯ä»¥å®Œæˆæ•°æ®åº“è¡¨-&gt;strcutçš„æ˜ å°„ã€‚ æ¥çœ‹ä¸€æ®µæ¼”ç¤ºè§†é¢‘ã€‚ æ’æ›²å‰å‡ å¤©æœ‰åŒå­¦æ‰¾ä¸Šé—¨ï¼Œè¯´fuckdbçš„webç‰ˆéƒ¨ç½²åŽæ— æ³•ä½¿ç”¨ï¼Œè§£å†³äº†åŠå¤©ä¹Ÿæ²¡èƒ½è®©ç”¨æˆ·éƒ¨ç½²èµ·æ¥ï¼Œåé¦ˆè¿‡æ¥è¿˜æ˜¯æ„Ÿè§‰éƒ¨ç½²æœ‰äº›å¤æ‚ã€‚åæ€äº†ä¸€ä¸‹ï¼Œå¯¹äºŽä¸€ä¸ªå·¥å…·åŒ–çš„è½¯ä»¶ï¼Œæœ‰äº›ç”¨æˆ·å¹¶ä¸æƒ³åšä¸€äº›å¤æ‚çš„éƒ¨ç½²æµç¨‹æˆ–è€…ä¸ç†Ÿæ‚‰éƒ¨ç½²æ“ä½œï¼Œå¯èƒ½å°±æ˜¯æƒ³æš‚æ—¶ä½¿ç”¨ä¸€ä¸‹ï¼Œæ‰€ä»¥åº”è¯¥è®©å·¥å…·æ›´åŠ è½»é‡åŒ–ï¼Œæ›´åŠ å¼€ç®±å³ç”¨ï¼ŒäºŽæ˜¯è¿žå¤œå†™äº†ä¸€ä¸ªfuckdb lite, æ›´å®¹æ˜“ä¸Šæ‰‹ä½¿ç”¨ï¼Œæ›´æ–¹ä¾¿çš„å®‰è£…æµç¨‹ï¼Œ1åˆ†é’Ÿæ‹¿åˆ°ä½ æƒ³è¦çš„ä»£ç ã€‚ fuckdb LiteåŽŸç†åŸºäºŽ cobra(https://github.com/spf13/cobra)ï¼Œæ ¸å¿ƒä»£ç ç»§æ‰¿webç‰ˆã€‚ å®‰è£…å¬å–ç”¨æˆ·åé¦ˆï¼Œå®‰è£…æµç¨‹æžç®€åŒ–ï¼ŒMacç”¨æˆ·å¯ä»¥ç›´æŽ¥brew install å®‰è£… 1brew tap hantmac/tap &amp;&amp; brew install fuckdb Linuxç”¨æˆ·:curl https://github.com/hantmac/fuckdb/releases/download/v0.2/fuckdb_linux.tar.gz ä¸‹è½½ã€è§£åŽ‹ã€å®‰è£… windowsç”¨æˆ·emmm, å°±åŽ»GitHubçš„releaseæ‰‹åŠ¨ä¸‹è½½å§ ä½¿ç”¨123456789101112131415fuckdb --helpFrom mysql schema generate golang struct with gorm, json tagUsage: fuckdb [command]Available Commands: generate use `fuckdb generate` to generate fuckdb.json go fuckdb go to generate golang struct with gorm and json tag help Help about any commandFlags: -h, --help help for fuckdbUse &quot;fuckdb [command] --help&quot; for more information about a command. ç›®å‰æä¾›äº†ä¸¤ä¸ªä¸»è¦å‘½ä»¤ï¼Œfuckdb generate å’Œ fuckdb goï¼Œæˆ‘ä»¬ä¾æ¬¡æ¥çœ‹ã€‚ 1fuckdb generate ç”Ÿæˆä¸€ä¸ªå­˜å‚¨MySQLä¿¡æ¯çš„fuckdb.jsonæ–‡ä»¶,ç¼–è¾‘ fuckdb.json ï¼Œå¡«å†™ä½ çš„MySQLä¿¡æ¯ï¼Œè¯¥æ–‡ä»¶å¯å¤ç”¨ï¼Œç®€å•ä¿®æ”¹è¡¨åå³å¯ã€‚123456789101112131415&#123; &quot;db&quot;: &#123; &quot;host&quot;: &quot;localhost&quot;, &quot;port&quot;: 3306, &quot;password&quot;: &quot;password&quot;, &quot;user&quot;: &quot;root&quot;, &quot;table&quot;: &quot;tableName&quot;, &quot;database&quot;: &quot;example&quot;, &quot;packageName&quot;: &quot;packageName&quot;, &quot;structName&quot;: &quot;structName&quot;, &quot;jsonAnnotation&quot;: true, &quot;gormAnnotation&quot;: true &#125;&#125;â€‹ ä¿®æ”¹å®Œæ–‡ä»¶åŽï¼Œå°±å®Œæˆäº†å‡†å¤‡å·¥ä½œï¼Œgo go go! â€‹æ‰§è¡Œ1fuckdb go Enjoy Your Codeï¼ æ¥çœ‹ä¸€æ®µæ¼”ç¤ºæ“ä½œ(è¯´å¥½ä¸€åˆ†é’Ÿæ‹¿åˆ°ä»£ç ï¼Œç»ä¸è¶…1ç§’) æ¯”ä¹‹å‰çš„webç‰ˆçš„å®‰è£…ç®€ç›´æ–¹ä¾¿äº†å¤ªå¤šï¼Œå¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘åŠ ç­å•¦ã€‚ ps: fuckdb.jsonæ–‡ä»¶å¿…é¡»åœ¨æ“ä½œç›®å½•ä¸‹ã€‚ æ¬¢è¿Žè¯•ç”¨&amp;åé¦ˆ&amp;Contributeã€‚ä»£ç åœ°å€ï¼šhttps://github.com/hantmac/fuckdb å®˜æ–¹èµ„è®¯*æœ€æ–°æŠ€æœ¯*ç‹¬å®¶è§£è¯»]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Proposals for Go 1.15(è¯‘)]]></title>
    <url>%2F2020%2F02%2F01%2FProposals-for-Go-1-15-%E8%AF%91%2F</url>
    <content type="text"><![CDATA[Proposals for Go 1.15(è¯‘) æœ¬æ–‡æ˜¯Golangå®˜æ–¹å¯¹äºŽGoè¿‘æœŸç‰ˆæœ¬çš„çŽ°çŠ¶æ€»ç»“ä»¥åŠGo 1.15ç‰ˆæœ¬çš„ä¸€äº›ææ¡ˆï¼ŒåŽŸæ–‡å‘å¸ƒäºŽ The Go Blog Robert Griesemer, for the Go team 28 January 2020 çŽ°çŠ¶Go 1.14çš„RC1ç‰ˆæœ¬å·²ç»å‡†å¤‡å°±ç»ªï¼Œå¦‚æžœä¸€åˆ‡é¡ºåˆ©ï¼ŒGo 1.14è®¡åˆ’å°†äºŽä»Šå¹´2æœˆä»½å‘å¸ƒã€‚æŒ‰ç…§Go 2,here we come!çš„è§„åˆ’ï¼Œåœ¨æˆ‘ä»¬çš„å¼€å‘å‘¨æœŸä¸­åˆåˆ°äº†è¿™æ ·çš„ä¸€ä¸ªæ—¶åˆ»ï¼šè€ƒè™‘ä¸‹ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼ˆæš‚å®šäºŽå‡ å¹´8æœˆä»½å‘å¸ƒçš„Go 1.15ï¼‰ï¼Œåˆ°åº•è¦æä¾›å“ªäº›Golangæœ¬èº«æˆ–è€…Go libä¸­çš„æ–°ç‰¹æ€§ã€‚ å½“å‰ç‰ˆæœ¬çš„Goçš„ä¼˜åŒ–ç›®æ ‡ä»ç„¶å›´ç»•ç€è½¯ä»¶åŒ…å’Œç‰ˆæœ¬ç®¡ç†ï¼Œæ›´å¥½çš„é”™è¯¯å¤„ç†æ”¯æŒä»¥åŠæ³›åž‹ç‰¹æ€§ã€‚Go Module ç›®å‰ä½¿ç”¨çŠ¶æ€æ¯”è¾ƒå¥½ï¼Œå¹¶ä¸”æ¯å¤©éƒ½åœ¨ä¸æ–­å®Œå–„ï¼Œå¯¹æ³›åž‹çš„æ”¯æŒä¹Ÿæœ‰ä¸€äº›æŽ¨è¿›ï¼ˆä»Šå¹´æ™šäº›æ—¶å€™ä¼šæœ‰æ›´å¤šè¿›å±•ï¼‰ã€‚ä¸ºäº†æä¾›æ›´å¥½çš„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå¤§çº¦åœ¨7ä¸ªæœˆå‰æˆ‘ä»¬æå‡ºäº†try_proposalçš„ææ¡ˆï¼Œæœ‰å°‘éƒ¨åˆ†äººæ”¯æŒè¯¥ææ¡ˆï¼Œä½†æ˜¯å¤§éƒ¨åˆ†è¿˜æ˜¯æŒå¼ºçƒˆçš„åå¯¹æ€åº¦ï¼ŒäºŽæ˜¯æˆ‘ä»¬å†³å®šæ”¾å¼ƒè¿™ä¸ªæƒ³æ³•ã€‚åœ¨æ­¤ä¹‹åŽï¼Œä¹Ÿæœ‰è®¸å¤šå»ºè®®ï¼Œä½†å®ƒä»¬æœ‰äº›éƒ½æ²¡æœ‰è¶³å¤Ÿçš„è¯´æœåŠ›ï¼Œæœ‰äº›è¿˜ä¸å¦‚try_proposalã€‚å› æ­¤ï¼Œæˆ‘ä»¬æš‚æ—¶æ²¡æœ‰è¿›ä¸€æ­¥çš„è®¡åˆ’åŽ»æ”¹å–„é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œä¹Ÿè®¸æœªæ¥ä¼šå‡ºçŽ°ä¸€äº›æ¯”è¾ƒå¥½çš„ç‚¹å­å¸®åŠ©æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ ææ¡ˆé‰´äºŽGo Moduleå’Œæ³›åž‹æ­£åœ¨ç§¯æžçš„æŽ¨è¿›ä¸­ï¼Œä¸”é”™è¯¯å¤„ç†æœºåˆ¶æ²¡æœ‰è¿›ä¸€æ­¥çš„è®¡åˆ’ï¼Œé‚£ä¹ˆè¿˜æœ‰å“ªäº›ç‰¹æ€§å€¼å¾—æˆ‘ä»¬åŽ»å…³æ³¨å‘¢ï¼Ÿå¦‚æžœéžè¦è¯´æœ‰çš„è¯ï¼Œæœ‰ä¸€äº›ç¼–ç¨‹è¯­è¨€ä¸­ç»ä¹…ä¸è¡°çš„ç‰¹æ€§ï¼Œä¾‹å¦‚æžšä¸¾ç±»åž‹å’Œä¸å¯å˜ç±»åž‹çš„éœ€æ±‚ï¼Œä½†æ˜¯è¿™äº›ideaè¿˜æ²¡æœ‰è¢«Goå›¢é˜Ÿæ·±å…¥åœ°æ€è€ƒï¼Œæ‰€ä»¥Goå›¢é˜Ÿä¹Ÿæ²¡æœ‰æŠ•å…¥è¿‡å¤šç²¾åŠ›åœ¨å…¶ä¸­ï¼Œå°¤å…¶æ˜¯æ”¹è¿›è¿™äº›è¯­è¨€ç‰¹æ€§éœ€è¦å¾ˆå¤§çš„æˆæœ¬ã€‚ Go teamä¸å¸Œæœ›åœ¨æ²¡æœ‰é•¿æœŸè®¡åˆ’çš„æƒ…å†µä¸‹å¢žæ·»å¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œåœ¨å®¡æ ¸äº†å¤§é‡å¯è¡Œçš„ææ¡ˆä¹‹åŽï¼ŒGo å›¢é˜Ÿå¾—å‡ºç»“è®ºï¼šè¿™ä¸€æ¬¡ä¸è¿›è¡Œé‡å¤§æ›´æ”¹ã€‚ç›¸åï¼Œæˆ‘ä»¬ä¼šé›†ä¸­ç²¾åŠ›åšä¸€äº›æ–°çš„ go vetæ”¯æŒå’Œè¯­è¨€å±‚é¢çš„ä¸€ä¸‹å°è°ƒæ•´ã€‚æˆ‘ä»¬é€‰æ‹©äº†ä»¥ä¸‹ä¸‰ä¸ªææ¡ˆï¼š #32479 go vetä¸­æ”¯æŒstring(int) è½¬æ¢çš„æ£€æµ‹ æˆ‘ä»¬åŽŸè®¡åˆ’åœ¨å³å°†å‘å¸ƒçš„Go 1.14ç‰ˆæœ¬ä¸­å®žçŽ°è¯¥åŠŸèƒ½ï¼Œä½†æˆ‘ä»¬å¹¶æ²¡æœ‰è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æ”¾åœ¨Go 1.15ä¸­è§£å†³ã€‚string(int) è½¬æ¢åœ¨å¾ˆæ—©çš„Goç‰ˆæœ¬ä¸­å°±å·²ç»å¼•å…¥äº†ï¼Œä½†æ˜¯æœ‰äº›ç‰¹æ€§ï¼ˆstring(10)æ˜¯â€\nâ€ï¼Œå¹¶ä¸æ˜¯â€10â€ï¼‰ä¼šè®©Goæ–°æ‰‹è¿·æƒ‘ï¼Œå¹¶ä¸”unicode/utf8åŒ…ä¸­ä¹Ÿå·²ç»æä¾›äº†è¯¥åŠŸèƒ½ã€‚è‡ªä»Žremoving this coversionçš„ææ¡ˆä¸æ˜¯ä¸€ä¸ªå‘åŽå…¼å®¹çš„æ”¹å˜ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨go vetä¸­æä¾›string(int)çš„é”™è¯¯æ£€æµ‹èƒ½åŠ›ã€‚ #4483 go vetä¸­æ”¯æŒé”™è¯¯çš„x.(T)çš„ç±»åž‹æ–­è¨€ å½“å‰ï¼ŒGoå…è®¸ä»»ä½•ç±»åž‹æ–­è¨€x.(T)ï¼ˆä»¥åŠç›¸åº”çš„ç±»åž‹åˆ‡æ¢æƒ…å†µï¼‰ï¼Œå…¶ä¸­xå’ŒTä¸ºæŽ¥å£ç±»åž‹ã€‚ä½†æ˜¯ï¼Œå¦‚æžœxå’ŒTæœ‰ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œä½†æ˜¯ç­¾åä¸åŒï¼Œåˆ™åˆ†é…ç»™xçš„ä»»ä½•å€¼ä¹Ÿä¸èƒ½å®žçŽ°Tï¼ˆè¿™ç§ç±»åž‹çš„æ–­è¨€åœ¨è¿è¡Œæ—¶æ€»æ˜¯å¤±è´¥ï¼Œpanicæˆ–evaluate to falseï¼‰ã€‚å› ä¸ºæˆ‘ä»¬åœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ç¼–è¯‘å™¨ä¼šæŠ¥å‘Šé”™ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç¼–è¯‘æŠ¥é”™ä¸æ˜¯å‘åŽå…¼å®¹çš„ï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå°†åœ¨go vetä¸­æ·»åŠ å¯¹è¯¥æƒ…å†µçš„æ£€æŸ¥ã€‚ #28591 ä½¿ç”¨å¸¸é‡å­—ç¬¦ä¸²å’Œç´¢å¼•è¿›è¡Œå¸¸é‡æ±‚å€¼çš„ç´¢å¼•å’Œåˆ‡ç‰‡è¡¨è¾¾å¼ å½“å‰ï¼Œç”¨ä¸€ä¸ªæˆ–å¤šä¸ªå¸¸é‡ç´¢å¼•å¯¹å¸¸é‡å­—ç¬¦ä¸²è¿›è¡Œç´¢å¼•æˆ–åˆ‡ç‰‡ä¼šåˆ†åˆ«äº§ç”Ÿä¸€ä¸ªéžå¸¸é‡å­—èŠ‚æˆ–å­—ç¬¦ä¸²å€¼ã€‚ ä½†æ˜¯ï¼Œå¦‚æžœæ‰€æœ‰æ“ä½œæ•°éƒ½æ˜¯å¸¸é‡ï¼Œåˆ™ç¼–è¯‘å™¨å¯ä»¥å¯¹è¿™äº›è¡¨è¾¾å¼è¿›è¡Œå¸¸é‡æ±‚å€¼ï¼Œå¹¶ç”Ÿæˆå¸¸é‡ï¼ˆå¯èƒ½æ˜¯æ— ç±»åž‹çš„ï¼‰ç»“æžœã€‚ è¿™æ˜¯å®Œå…¨å‘åŽå…¼å®¹çš„æ›´æ”¹ï¼Œæˆ‘ä»¬å°†å¯¹å¼€å‘è§„èŒƒå’Œç¼–è¯‘å™¨è¿›è¡Œå¿…è¦çš„è°ƒæ•´ã€‚ æ—¶é—´çº¿Go teamè®¤ä¸ºè¿™ä¸‰ä¸ªææ¡ˆåº”è¯¥æ˜¯æ²¡æœ‰ä»€ä¹ˆäº‰è®®çš„ï¼Œä½†æ˜¯äººéžåœ£è´¤å­°èƒ½æ— è¿‡ï¼Œå› æ­¤æˆ‘ä»¬è®¡åˆ’åœ¨Go 1.15çš„å‘å¸ƒå‘¨æœŸå¼€å‘(Go 1.14å‘å¸ƒæ—¶æˆ–ä¹‹åŽ)å¼€å§‹é‡‡çº³å¼€å‘è€…å¯¹è¯¥ä¸‰ä¸ªææ¡ˆçš„å»ºè®®ï¼Œä»¥ä¾¿æœ‰è¶³å¤Ÿçš„æ—¶é—´æ”¶é›†åé¦ˆã€‚åœ¨proposal evalution processï¼Œæœ€ç»ˆçš„ææ¡ˆå°†åœ¨2020å¹´5æœˆåˆå†³å®šã€‚ One more thingâ€¦æˆ‘ä»¬æ”¶åˆ°äº†å¤§é‡çš„è¯­è¨€ç‰¹æ€§ä¿®æ­£çš„ææ¡ˆ(issue label LanguageChange)ï¼Œä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰æ—¶é—´åŽ»ä»”ç»†åœ°å½»åº•åœ°è¯„ä¼°ã€‚ä¸¾ä¸ªæ —å­ï¼Œå•æ˜¯å…³äºŽé”™è¯¯å¤„ç†æœºåˆ¶çš„ææ¡ˆï¼Œå°±æœ‰57ä¸ªissueï¼Œåˆ°ç›®å‰ä¸ºæ­¢è¿˜æœ‰5ä¸ªå¤„äºŽopençš„çŠ¶æ€ã€‚ç”±äºŽè¿›è¡Œè¯­è¨€æ›´æ”¹çš„æˆæœ¬ï¼Œæ— è®ºå¤§å°å¦‚ä½•ï¼Œå¯¹äºŽå¼€å‘è€…æ¥è¯´å…¶å®žéƒ½å¾ˆé«˜ï¼Œè€Œä¸”æ”¶ç›Šå¾€å¾€å¾ˆå°ï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»è°¨æ…Žè¡Œäº‹ã€‚ç”±äºŽå¤§å¤šæ•°ææ¡ˆåé¦ˆçš„äººæ•°å¾ˆå°‘ï¼Œè¿™äº›ææ¡ˆéƒ½ä¼šé­åˆ°æ‹’ç»ã€‚ä½†æ˜¯æœ‰äº›å¼€å‘è€…èŠ±è´¹äº†å¤§é‡æ—¶é—´åŽ»å†™ææ¡ˆçš„ç»†èŠ‚ï¼Œåˆ°å¤´æ¥è¿˜æ˜¯è¢«æ‹’ï¼›å¦ä¸€æ–¹é¢ï¼Œç”±äºŽæ€»ä½“ææ¡ˆæµç¨‹æ¯”è¾ƒç®€å•ï¼Œå› æ­¤æäº¤ä¸€äº›æ— å…³ç´§è¦çš„è¯­è¨€å˜æ›´ææ¡ˆéžå¸¸å®¹æ˜“ï¼Œä»Žè€Œç»™å®¡æ ¸å§”å‘˜ä¼šå¸¦æ¥å¤§é‡ä¸å¿…è¦çš„å·¥ä½œï¼Œä¹Ÿæœ‰å¯èƒ½åŸ‹æ²¡æ¯”è¾ƒå¥½çš„ææ¡ˆã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜æˆ‘ä»¬æ–°å¢žäº†ä¸€ä¸ªå…³äºŽGoææ¡ˆçš„é—®å·ï¼šå¡«å†™è¯¥æ¨¡æ¿å°†æœ‰åŠ©äºŽå®¡æ ¸è€…æ›´æœ‰æ•ˆåœ°è¯„ä¼°ææ¡ˆï¼Œå› ä¸ºä»–ä»¬æ— éœ€å°è¯•è‡ªå·±å›žç­”è¿™äº›é—®é¢˜ã€‚ å®ƒèƒ½ä»Žä¸€å¼€å§‹å°±è®¾å®šä¸€äº›é™åˆ¶ï¼Œä»Žè€Œä¸ºæè®®è€…æä¾›æ›´å¥½çš„æŒ‡å¯¼ã€‚ è¿™æ˜¯ä¸€ä¸ªå®žéªŒæ€§çš„å°è¯•ï¼Œæˆ‘ä»¬ä¼šæ ¹æ®éœ€è¦éšç€æ—¶é—´çš„æŽ¨ç§»è¿›è¡Œå®Œå–„ã€‚ æ„Ÿè°¢æ‚¨å¸®åŠ©æˆ‘ä»¬æ”¹å–„Goçš„ä½“éªŒï¼ åŽŸæ–‡åœ°å€ï¼šhttps://blog.golang.org/go1.15-proposals]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go GC 20é—®]]></title>
    <url>%2F2020%2F01%2F06%2FGo-GC-20%E9%97%AE%2F</url>
    <content type="text"><![CDATA[Go GC 20 é—®åŽŸåˆ›ï¼š æ¬§é•¿å¤ ç å†œæ¡ƒèŠ±æº https://mp.weixin.qq.com/s/o2oMMh0PF5ZSoYD0XOBY2Q æœ¬æ–‡ä½œè€…æ¬§é•¿å¤ï¼Œå¾·å›½æ…•å°¼é»‘å¤§å­¦åœ¨è¯»åšå£«ï¼ŒGo/etcd/Tensorflow contributorï¼Œå¼€æºä¹¦ç±ã€ŠGo è¯­è¨€åŽŸæœ¬ã€‹ä½œè€…ï¼Œã€ŠGo å¤œè¯»ã€‹SIG æˆå‘˜/è®²å¸ˆï¼Œå¯¹ Go æœ‰å¾ˆæ·±çš„ç ”ç©¶ã€‚Githubï¼š@changkunï¼Œhttps://changkun.deã€‚ æœ¬æ–‡é¦–å‘äºŽ Github å¼€æºé¡¹ç›® ã€ŠGo-Questionsã€‹ï¼Œç‚¹å‡»é˜…è¯»åŽŸæ–‡ç›´è¾¾ã€‚å…¨æ–‡ä¸è®¡ä»£ç ï¼Œå…± 1.7w+ å­—ï¼Œå»ºè®®æ”¶è—åŽç²¾è¯»ã€‚å¦å¤–ï¼Œæœ¬æ–‡ç»“å°¾æœ‰å½©è›‹ã€‚ æŒ‰æƒ¯ä¾‹ï¼Œè´´ä¸Šæœ¬æ–‡çš„ç›®å½•ï¼š æœ¬æ–‡å†™äºŽ Go 1.14 beta1ï¼Œå½“æ–‡ä¸­æåŠç›®å‰ã€ç›®å‰ç‰ˆæœ¬ç­‰å­—çœ¼æ—¶å‡æŒ‡ Go 1.14ï¼Œæ­¤å¤–ï¼Œæ–‡ä¸­æ‰€æœ‰ go å‘½ä»¤ç‰ˆæœ¬å‡ä¸º Go 1.14ã€‚ GC çš„è®¤è¯†1. ä»€ä¹ˆæ˜¯ GCï¼Œæœ‰ä»€ä¹ˆä½œç”¨ï¼ŸGCï¼Œå…¨ç§° Garbage Collectionï¼Œå³åžƒåœ¾å›žæ”¶ï¼Œæ˜¯ä¸€ç§è‡ªåŠ¨å†…å­˜ç®¡ç†çš„æœºåˆ¶ã€‚ å½“ç¨‹åºå‘æ“ä½œç³»ç»Ÿç”³è¯·çš„å†…å­˜ä¸å†éœ€è¦æ—¶ï¼Œåžƒåœ¾å›žæ”¶ä¸»åŠ¨å°†å…¶å›žæ”¶å¹¶ä¾›å…¶ä»–ä»£ç è¿›è¡Œå†…å­˜ç”³è¯·æ—¶å€™å¤ç”¨ï¼Œæˆ–è€…å°†å…¶å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œè¿™ç§é’ˆå¯¹å†…å­˜çº§åˆ«èµ„æºçš„è‡ªåŠ¨å›žæ”¶è¿‡ç¨‹ï¼Œå³ä¸ºåžƒåœ¾å›žæ”¶ã€‚è€Œè´Ÿè´£åžƒåœ¾å›žæ”¶çš„ç¨‹åºç»„ä»¶ï¼Œå³ä¸ºåžƒåœ¾å›žæ”¶å™¨ã€‚ åžƒåœ¾å›žæ”¶å…¶å®žä¸€ä¸ªå®Œç¾Žçš„ â€œSimplicity is Complicatedâ€ çš„ä¾‹å­ã€‚ä¸€æ–¹é¢ï¼Œç¨‹åºå‘˜å—ç›ŠäºŽ GCï¼Œæ— éœ€æ“å¿ƒã€ä¹Ÿä¸å†éœ€è¦å¯¹å†…å­˜è¿›è¡Œæ‰‹åŠ¨çš„ç”³è¯·å’Œé‡Šæ”¾æ“ä½œï¼ŒGC åœ¨ç¨‹åºè¿è¡Œæ—¶è‡ªåŠ¨é‡Šæ”¾æ®‹ç•™çš„å†…å­˜ã€‚å¦ä¸€æ–¹é¢ï¼ŒGC å¯¹ç¨‹åºå‘˜å‡ ä¹Žä¸å¯è§ï¼Œä»…åœ¨ç¨‹åºéœ€è¦è¿›è¡Œç‰¹æ®Šä¼˜åŒ–æ—¶ï¼Œé€šè¿‡æä¾›å¯è°ƒæŽ§çš„ APIï¼Œå¯¹ GC çš„è¿è¡Œæ—¶æœºã€è¿è¡Œå¼€é”€è¿›è¡ŒæŠŠæŽ§çš„æ—¶å€™æ‰å¾—ä»¥çŽ°èº«ã€‚ é€šå¸¸ï¼Œåžƒåœ¾å›žæ”¶å™¨çš„æ‰§è¡Œè¿‡ç¨‹è¢«åˆ’åˆ†ä¸ºä¸¤ä¸ªåŠç‹¬ç«‹çš„ç»„ä»¶ï¼š èµ‹å€¼å™¨ï¼ˆMutatorï¼‰ï¼šè¿™ä¸€åç§°æœ¬è´¨ä¸Šæ˜¯åœ¨æŒ‡ä»£ç”¨æˆ·æ€çš„ä»£ç ã€‚å› ä¸ºå¯¹åžƒåœ¾å›žæ”¶å™¨è€Œè¨€ï¼Œç”¨æˆ·æ€çš„ä»£ç ä»…ä»…åªæ˜¯åœ¨ä¿®æ”¹å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨å…³ç³»ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯¹è±¡å›¾ï¼ˆå¯¹è±¡ä¹‹é—´å¼•ç”¨å…³ç³»çš„ä¸€ä¸ªæœ‰å‘å›¾ï¼‰ä¸Šè¿›è¡Œæ“ä½œã€‚ å›žæ”¶å™¨ï¼ˆCollectorï¼‰ï¼šè´Ÿè´£æ‰§è¡Œåžƒåœ¾å›žæ”¶çš„ä»£ç ã€‚ 2. æ ¹å¯¹è±¡åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿæ ¹å¯¹è±¡åœ¨åžƒåœ¾å›žæ”¶çš„æœ¯è¯­ä¸­åˆå«åšæ ¹é›†åˆï¼Œå®ƒæ˜¯åžƒåœ¾å›žæ”¶å™¨åœ¨æ ‡è®°è¿‡ç¨‹æ—¶æœ€å…ˆæ£€æŸ¥çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬ï¼š å…¨å±€å˜é‡ï¼šç¨‹åºåœ¨ç¼–è¯‘æœŸå°±èƒ½ç¡®å®šçš„é‚£äº›å­˜åœ¨äºŽç¨‹åºæ•´ä¸ªç”Ÿå‘½å‘¨æœŸçš„å˜é‡ã€‚ æ‰§è¡Œæ ˆï¼šæ¯ä¸ª goroutine éƒ½åŒ…å«è‡ªå·±çš„æ‰§è¡Œæ ˆï¼Œè¿™äº›æ‰§è¡Œæ ˆä¸ŠåŒ…å«æ ˆä¸Šçš„å˜é‡åŠæŒ‡å‘åˆ†é…çš„å †å†…å­˜åŒºå—çš„æŒ‡é’ˆã€‚ å¯„å­˜å™¨ï¼šå¯„å­˜å™¨çš„å€¼å¯èƒ½è¡¨ç¤ºä¸€ä¸ªæŒ‡é’ˆï¼Œå‚ä¸Žè®¡ç®—çš„è¿™äº›æŒ‡é’ˆå¯èƒ½æŒ‡å‘æŸäº›èµ‹å€¼å™¨åˆ†é…çš„å †å†…å­˜åŒºå—ã€‚ 3. å¸¸è§çš„ GC å®žçŽ°æ–¹å¼æœ‰å“ªäº›ï¼ŸGo è¯­è¨€çš„ GC ä½¿ç”¨çš„æ˜¯ä»€ä¹ˆï¼Ÿæ‰€æœ‰çš„ GC ç®—æ³•å…¶å­˜åœ¨å½¢å¼å¯ä»¥å½’ç»“ä¸ºè¿½è¸ªï¼ˆTracingï¼‰å’Œå¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰è¿™ä¸¤ç§å½¢å¼çš„æ··åˆè¿ç”¨ã€‚ è¿½è¸ªå¼ GC ä»Žæ ¹å¯¹è±¡å‡ºå‘ï¼Œæ ¹æ®å¯¹è±¡ä¹‹é—´çš„å¼•ç”¨ä¿¡æ¯ï¼Œä¸€æ­¥æ­¥æŽ¨è¿›ç›´åˆ°æ‰«æå®Œæ¯•æ•´ä¸ªå †å¹¶ç¡®å®šéœ€è¦ä¿ç•™çš„å¯¹è±¡ï¼Œä»Žè€Œå›žæ”¶æ‰€æœ‰å¯å›žæ”¶çš„å¯¹è±¡ã€‚Goã€ Javaã€V8 å¯¹ JavaScript çš„å®žçŽ°ç­‰å‡ä¸ºè¿½è¸ªå¼ GCã€‚ å¼•ç”¨è®¡æ•°å¼ GC æ¯ä¸ªå¯¹è±¡è‡ªèº«åŒ…å«ä¸€ä¸ªè¢«å¼•ç”¨çš„è®¡æ•°å™¨ï¼Œå½“è®¡æ•°å™¨å½’é›¶æ—¶è‡ªåŠ¨å¾—åˆ°å›žæ”¶ã€‚å› ä¸ºæ­¤æ–¹æ³•ç¼ºé™·è¾ƒå¤šï¼Œåœ¨è¿½æ±‚é«˜æ€§èƒ½æ—¶é€šå¸¸ä¸è¢«åº”ç”¨ã€‚Pythonã€Objective-C ç­‰å‡ä¸ºå¼•ç”¨è®¡æ•°å¼ GCã€‚ ç›®å‰æ¯”è¾ƒå¸¸è§çš„ GC å®žçŽ°æ–¹å¼åŒ…æ‹¬ï¼š è¿½è¸ªå¼ï¼Œåˆ†ä¸ºå¤šç§ä¸åŒç±»åž‹ï¼Œä¾‹å¦‚ï¼š æ ‡è®°æ¸…æ‰«ï¼šä»Žæ ¹å¯¹è±¡å‡ºå‘ï¼Œå°†ç¡®å®šå­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ï¼Œå¹¶æ¸…æ‰«å¯ä»¥å›žæ”¶çš„å¯¹è±¡ã€‚ æ ‡è®°æ•´ç†ï¼šä¸ºäº†è§£å†³å†…å­˜ç¢Žç‰‡é—®é¢˜è€Œæå‡ºï¼Œåœ¨æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå°†å¯¹è±¡å°½å¯èƒ½æ•´ç†åˆ°ä¸€å—è¿žç»­çš„å†…å­˜ä¸Šã€‚ å¢žé‡å¼ï¼šå°†æ ‡è®°ä¸Žæ¸…æ‰«çš„è¿‡ç¨‹åˆ†æ‰¹æ‰§è¡Œï¼Œæ¯æ¬¡æ‰§è¡Œå¾ˆå°çš„éƒ¨åˆ†ï¼Œä»Žè€Œå¢žé‡çš„æŽ¨è¿›åžƒåœ¾å›žæ”¶ï¼Œè¾¾åˆ°è¿‘ä¼¼å®žæ—¶ã€å‡ ä¹Žæ— åœé¡¿çš„ç›®çš„ã€‚ å¢žé‡æ•´ç†ï¼šåœ¨å¢žé‡å¼çš„åŸºç¡€ä¸Šï¼Œå¢žåŠ å¯¹å¯¹è±¡çš„æ•´ç†è¿‡ç¨‹ã€‚ åˆ†ä»£å¼ï¼šå°†å¯¹è±¡æ ¹æ®å­˜æ´»æ—¶é—´çš„é•¿çŸ­è¿›è¡Œåˆ†ç±»ï¼Œå­˜æ´»æ—¶é—´å°äºŽæŸä¸ªå€¼çš„ä¸ºå¹´è½»ä»£ï¼Œå­˜æ´»æ—¶é—´å¤§äºŽæŸä¸ªå€¼çš„ä¸ºè€å¹´ä»£ï¼Œæ°¸è¿œä¸ä¼šå‚ä¸Žå›žæ”¶çš„å¯¹è±¡ä¸ºæ°¸ä¹…ä»£ã€‚å¹¶æ ¹æ®åˆ†ä»£å‡è®¾ï¼ˆå¦‚æžœä¸€ä¸ªå¯¹è±¡å­˜æ´»æ—¶é—´ä¸é•¿åˆ™å€¾å‘äºŽè¢«å›žæ”¶ï¼Œå¦‚æžœä¸€ä¸ªå¯¹è±¡å·²ç»å­˜æ´»å¾ˆé•¿æ—¶é—´åˆ™å€¾å‘äºŽå­˜æ´»æ›´é•¿æ—¶é—´ï¼‰å¯¹å¯¹è±¡è¿›è¡Œå›žæ”¶ã€‚ å¼•ç”¨è®¡æ•°ï¼šæ ¹æ®å¯¹è±¡è‡ªèº«çš„å¼•ç”¨è®¡æ•°æ¥å›žæ”¶ï¼Œå½“å¼•ç”¨è®¡æ•°å½’é›¶æ—¶ç«‹å³å›žæ”¶ã€‚ å…³äºŽå„ç±»æ–¹æ³•çš„è¯¦ç»†ä»‹ç»åŠå…¶å®žçŽ°ä¸åœ¨æœ¬æ–‡ä¸­è¯¦ç»†è®¨è®ºã€‚å¯¹äºŽ Go è€Œè¨€ï¼ŒGo çš„ GC ç›®å‰ä½¿ç”¨çš„æ˜¯æ— åˆ†ä»£ï¼ˆå¯¹è±¡æ²¡æœ‰ä»£é™…ä¹‹åˆ†ï¼‰ã€ä¸æ•´ç†ï¼ˆå›žæ”¶è¿‡ç¨‹ä¸­ä¸å¯¹å¯¹è±¡è¿›è¡Œç§»åŠ¨ä¸Žæ•´ç†ï¼‰ã€å¹¶å‘ï¼ˆä¸Žç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼‰çš„ä¸‰è‰²æ ‡è®°æ¸…æ‰«ç®—æ³•ã€‚åŽŸå› åœ¨äºŽï¼š å¯¹è±¡æ•´ç†çš„ä¼˜åŠ¿æ˜¯è§£å†³å†…å­˜ç¢Žç‰‡é—®é¢˜ä»¥åŠâ€œå…è®¸â€ä½¿ç”¨é¡ºåºå†…å­˜åˆ†é…å™¨ã€‚ä½† Go è¿è¡Œæ—¶çš„åˆ†é…ç®—æ³•åŸºäºŽ tcmallocï¼ŒåŸºæœ¬ä¸Šæ²¡æœ‰ç¢Žç‰‡é—®é¢˜ã€‚ å¹¶ä¸”é¡ºåºå†…å­˜åˆ†é…å™¨åœ¨å¤šçº¿ç¨‹çš„åœºæ™¯ä¸‹å¹¶ä¸é€‚ç”¨ã€‚Go ä½¿ç”¨çš„æ˜¯åŸºäºŽ tcmalloc çš„çŽ°ä»£å†…å­˜åˆ†é…ç®—æ³•ï¼Œå¯¹å¯¹è±¡è¿›è¡Œæ•´ç†ä¸ä¼šå¸¦æ¥å®žè´¨æ€§çš„æ€§èƒ½æå‡ã€‚ åˆ†ä»£ GC ä¾èµ–åˆ†ä»£å‡è®¾ï¼Œå³ GC å°†ä¸»è¦çš„å›žæ”¶ç›®æ ‡æ”¾åœ¨æ–°åˆ›å»ºçš„å¯¹è±¡ä¸Šï¼ˆå­˜æ´»æ—¶é—´çŸ­ï¼Œæ›´å€¾å‘äºŽè¢«å›žæ”¶ï¼‰ï¼Œè€Œéžé¢‘ç¹æ£€æŸ¥æ‰€æœ‰å¯¹è±¡ã€‚ä½† Go çš„ç¼–è¯‘å™¨ä¼šé€šè¿‡é€ƒé€¸åˆ†æžå°†å¤§éƒ¨åˆ†æ–°ç”Ÿå¯¹è±¡å­˜å‚¨åœ¨æ ˆä¸Šï¼ˆæ ˆç›´æŽ¥è¢«å›žæ”¶ï¼‰ï¼Œåªæœ‰é‚£äº›éœ€è¦é•¿æœŸå­˜åœ¨çš„å¯¹è±¡æ‰ä¼šè¢«åˆ†é…åˆ°éœ€è¦è¿›è¡Œåžƒåœ¾å›žæ”¶çš„å †ä¸­ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåˆ†ä»£ GC å›žæ”¶çš„é‚£äº›å­˜æ´»æ—¶é—´çŸ­çš„å¯¹è±¡åœ¨ Go ä¸­æ˜¯ç›´æŽ¥è¢«åˆ†é…åˆ°æ ˆä¸Šï¼Œå½“ goroutine æ­»äº¡åŽæ ˆä¹Ÿä¼šè¢«ç›´æŽ¥å›žæ”¶ï¼Œä¸éœ€è¦ GC çš„å‚ä¸Žï¼Œè¿›è€Œåˆ†ä»£å‡è®¾å¹¶æ²¡æœ‰å¸¦æ¥ç›´æŽ¥ä¼˜åŠ¿ã€‚å¹¶ä¸” Go çš„åžƒåœ¾å›žæ”¶å™¨ä¸Žç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼Œä½¿å¾— STW çš„æ—¶é—´ä¸Žå¯¹è±¡çš„ä»£é™…ã€å¯¹è±¡çš„ size æ²¡æœ‰å…³ç³»ã€‚Go å›¢é˜Ÿæ›´å…³æ³¨äºŽå¦‚ä½•æ›´å¥½åœ°è®© GC ä¸Žç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œï¼ˆä½¿ç”¨é€‚å½“çš„ CPU æ¥æ‰§è¡Œåžƒåœ¾å›žæ”¶ï¼‰ï¼Œè€Œéžå‡å°‘åœé¡¿æ—¶é—´è¿™ä¸€å•ä¸€ç›®æ ‡ä¸Šã€‚ 4. ä¸‰è‰²æ ‡è®°æ³•æ˜¯ä»€ä¹ˆï¼Ÿç†è§£ä¸‰è‰²æ ‡è®°æ³•çš„å…³é”®æ˜¯ç†è§£å¯¹è±¡çš„ä¸‰è‰²æŠ½è±¡ä»¥åŠæ³¢é¢ï¼ˆwavefrontï¼‰æŽ¨è¿›è¿™ä¸¤ä¸ªæ¦‚å¿µã€‚ä¸‰è‰²æŠ½è±¡åªæ˜¯ä¸€ç§æè¿°è¿½è¸ªå¼å›žæ”¶å™¨çš„æ–¹æ³•ï¼Œåœ¨å®žè·µä¸­å¹¶æ²¡æœ‰å®žé™…å«ä¹‰ï¼Œå®ƒçš„é‡è¦ä½œç”¨åœ¨äºŽä»Žé€»è¾‘ä¸Šä¸¥å¯†æŽ¨å¯¼æ ‡è®°æ¸…ç†è¿™ç§åžƒåœ¾å›žæ”¶æ–¹æ³•çš„æ­£ç¡®æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æˆ‘ä»¬è°ˆåŠä¸‰è‰²æ ‡è®°æ³•æ—¶ï¼Œé€šå¸¸æŒ‡æ ‡è®°æ¸…æ‰«çš„åžƒåœ¾å›žæ”¶ã€‚ ä»Žåžƒåœ¾å›žæ”¶å™¨çš„è§†è§’æ¥çœ‹ï¼Œä¸‰è‰²æŠ½è±¡è§„å®šäº†ä¸‰ç§ä¸åŒç±»åž‹çš„å¯¹è±¡ï¼Œå¹¶ç”¨ä¸åŒçš„é¢œè‰²ç›¸ç§°ï¼š ç™½è‰²å¯¹è±¡ï¼ˆå¯èƒ½æ­»äº¡ï¼‰ï¼šæœªè¢«å›žæ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ã€‚åœ¨å›žæ”¶å¼€å§‹é˜¶æ®µï¼Œæ‰€æœ‰å¯¹è±¡å‡ä¸ºç™½è‰²ï¼Œå½“å›žæ”¶ç»“æŸåŽï¼Œç™½è‰²å¯¹è±¡å‡ä¸å¯è¾¾ã€‚ ç°è‰²å¯¹è±¡ï¼ˆæ³¢é¢ï¼‰ï¼šå·²è¢«å›žæ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œä½†å›žæ”¶å™¨éœ€è¦å¯¹å…¶ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡é’ˆè¿›è¡Œæ‰«æï¼Œå› ä¸ºä»–ä»¬å¯èƒ½è¿˜æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚ é»‘è‰²å¯¹è±¡ï¼ˆç¡®å®šå­˜æ´»ï¼‰ï¼šå·²è¢«å›žæ”¶å™¨è®¿é—®åˆ°çš„å¯¹è±¡ï¼Œå…¶ä¸­æ‰€æœ‰å­—æ®µéƒ½å·²è¢«æ‰«æï¼Œé»‘è‰²å¯¹è±¡ä¸­ä»»ä½•ä¸€ä¸ªæŒ‡é’ˆéƒ½ä¸å¯èƒ½ç›´æŽ¥æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚ è¿™æ ·ä¸‰ç§ä¸å˜æ€§æ‰€å®šä¹‰çš„å›žæ”¶è¿‡ç¨‹å…¶å®žæ˜¯ä¸€ä¸ªæ³¢é¢ä¸æ–­å‰è¿›çš„è¿‡ç¨‹ï¼Œè¿™ä¸ªæ³¢é¢åŒæ—¶ä¹Ÿæ˜¯é»‘è‰²å¯¹è±¡å’Œç™½è‰²å¯¹è±¡çš„è¾¹ç•Œï¼Œç°è‰²å¯¹è±¡å°±æ˜¯è¿™ä¸ªæ³¢é¢ã€‚ å½“åžƒåœ¾å›žæ”¶å¼€å§‹æ—¶ï¼Œåªæœ‰ç™½è‰²å¯¹è±¡ã€‚éšç€æ ‡è®°è¿‡ç¨‹å¼€å§‹è¿›è¡Œæ—¶ï¼Œç°è‰²å¯¹è±¡å¼€å§‹å‡ºçŽ°ï¼ˆç€è‰²ï¼‰ï¼Œè¿™æ—¶å€™æ³¢é¢ä¾¿å¼€å§‹æ‰©å¤§ã€‚å½“ä¸€ä¸ªå¯¹è±¡çš„æ‰€æœ‰å­èŠ‚ç‚¹å‡å®Œæˆæ‰«ææ—¶ï¼Œä¼šè¢«ç€è‰²ä¸ºé»‘è‰²ã€‚å½“æ•´ä¸ªå †éåŽ†å®Œæˆæ—¶ï¼Œåªå‰©ä¸‹é»‘è‰²å’Œç™½è‰²å¯¹è±¡ï¼Œè¿™æ—¶çš„é»‘è‰²å¯¹è±¡ä¸ºå¯è¾¾å¯¹è±¡ï¼Œå³å­˜æ´»ï¼›è€Œç™½è‰²å¯¹è±¡ä¸ºä¸å¯è¾¾å¯¹è±¡ï¼Œå³æ­»äº¡ã€‚è¿™ä¸ªè¿‡ç¨‹å¯ä»¥è§†ä¸ºä»¥ç°è‰²å¯¹è±¡ä¸ºæ³¢é¢ï¼Œå°†é»‘è‰²å¯¹è±¡å’Œç™½è‰²å¯¹è±¡åˆ†ç¦»ï¼Œä½¿æ³¢é¢ä¸æ–­å‘å‰æŽ¨è¿›ï¼Œç›´åˆ°æ‰€æœ‰å¯è¾¾çš„ç°è‰²å¯¹è±¡éƒ½å˜ä¸ºé»‘è‰²å¯¹è±¡ä¸ºæ­¢çš„è¿‡ç¨‹ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å›¾ä¸­å±•ç¤ºäº†æ ¹å¯¹è±¡ã€å¯è¾¾å¯¹è±¡ã€ä¸å¯è¾¾å¯¹è±¡ï¼Œé»‘ã€ç°ã€ç™½å¯¹è±¡ä»¥åŠæ³¢é¢ä¹‹é—´çš„å…³ç³»ã€‚ 5. STW æ˜¯ä»€ä¹ˆæ„æ€ï¼ŸSTW æ˜¯ Stop the World çš„ç¼©å†™ï¼Œå³ä¸‡ç‰©é™æ­¢ï¼Œæ˜¯æŒ‡åœ¨åžƒåœ¾å›žæ”¶è¿‡ç¨‹ä¸­ä¸ºäº†ä¿è¯å®žçŽ°çš„æ­£ç¡®æ€§ã€é˜²æ­¢æ— æ­¢å¢ƒçš„å†…å­˜å¢žé•¿ç­‰é—®é¢˜è€Œä¸å¯é¿å…çš„éœ€è¦åœæ­¢èµ‹å€¼å™¨è¿›ä¸€æ­¥æ“ä½œå¯¹è±¡å›¾çš„ä¸€æ®µè¿‡ç¨‹ã€‚ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ•´ä¸ªç”¨æˆ·ä»£ç è¢«åœæ­¢æˆ–è€…æ”¾ç¼“æ‰§è¡Œï¼Œ STW è¶Šé•¿ï¼Œå¯¹ç”¨æˆ·ä»£ç é€ æˆçš„å½±å“ï¼ˆä¾‹å¦‚å»¶è¿Ÿï¼‰å°±è¶Šå¤§ï¼Œæ—©æœŸ Go å¯¹åžƒåœ¾å›žæ”¶å™¨çš„å®žçŽ°ä¸­ STW é•¿è¾¾å‡ ç™¾æ¯«ç§’ï¼Œå¯¹æ—¶é—´æ•æ„Ÿçš„å®žæ—¶é€šä¿¡ç­‰åº”ç”¨ç¨‹åºä¼šé€ æˆå·¨å¤§çš„å½±å“ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š 1234567891011121314151617package mainimport ( "runtime" "time")func main() &#123; go func() &#123; for &#123; &#125; &#125;() time.Sleep(time.Millisecond) runtime.GC() println("OK")&#125; ä¸Šé¢çš„è¿™ä¸ªç¨‹åºåœ¨ Go 1.14 ä»¥å‰æ°¸è¿œéƒ½ä¸ä¼šè¾“å‡º OKï¼Œå…¶ç½ªé­ç¥¸é¦–æ˜¯ STW æ— é™åˆ¶çš„è¢«å»¶é•¿ã€‚ å°½ç®¡ STW å¦‚ä»Šå·²ç»ä¼˜åŒ–åˆ°äº†åŠæ¯«ç§’çº§åˆ«ä»¥ä¸‹ï¼Œä½†è¿™ä¸ªç¨‹åºè¢«å¡æ­»åŽŸå› åœ¨äºŽä»ç„¶æ˜¯ STW å¯¼è‡´çš„ã€‚åŽŸå› åœ¨äºŽï¼ŒGC åœ¨è¿›å…¥ STW æ—¶ï¼Œéœ€è¦ç­‰å¾…è®©æ‰€æœ‰çš„ç”¨æˆ·æ€ä»£ç åœæ­¢ï¼Œä½†æ˜¯ for {} æ‰€åœ¨çš„ goroutine æ°¸è¿œéƒ½ä¸ä¼šè¢«ä¸­æ–­ï¼Œä»Žè€Œåœç•™åœ¨ STW é˜¶æ®µã€‚å®žé™…å®žè·µä¸­ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå½“ç¨‹åºçš„æŸä¸ª goroutine é•¿æ—¶é—´å¾—ä¸åˆ°åœæ­¢ï¼Œå¼ºè¡Œæ‹–æ…¢ STWï¼Œè¿™ç§æƒ…å†µä¸‹é€ æˆçš„å½±å“ï¼ˆå¡æ­»ï¼‰æ˜¯éžå¸¸å¯æ€•çš„ã€‚å¥½åœ¨è‡ª Go 1.14 ä¹‹åŽï¼Œè¿™ç±» goroutine èƒ½å¤Ÿè¢«å¼‚æ­¥åœ°æŠ¢å ï¼Œä»Žè€Œä½¿å¾— STW çš„æ—¶é—´å¦‚åŒæ™®é€šç¨‹åºé‚£æ ·ï¼Œä¸ä¼šè¶…è¿‡åŠä¸ªæ¯«ç§’ï¼Œç¨‹åºä¹Ÿä¸ä¼šå› ä¸ºä»…ä»…ç­‰å¾…ä¸€ä¸ª goroutine çš„åœæ­¢è€Œåœé¡¿åœ¨ STW é˜¶æ®µã€‚ 6. å¦‚ä½•è§‚å¯Ÿ Go GCï¼Ÿæˆ‘ä»¬ä»¥ä¸‹é¢çš„ç¨‹åºä¸ºä¾‹ï¼Œå…ˆä½¿ç”¨å››ç§ä¸åŒçš„æ–¹å¼æ¥ä»‹ç»å¦‚ä½•è§‚å¯Ÿ GCï¼Œå¹¶åœ¨åŽé¢çš„é—®é¢˜ä¸­é€šè¿‡å‡ ä¸ªè¯¦ç»†çš„ä¾‹å­å†æ¥è®¨è®ºå¦‚ä½•ä¼˜åŒ– GCã€‚ 1234567891011package mainfunc allocate() &#123; _ = make([]byte, 1&lt;&lt;20)&#125;func main() &#123; for n := 1; n &lt; 100000; n++ &#123; allocate() &#125;&#125; æ–¹å¼1ï¼šGODEBUG=gctrace=1æˆ‘ä»¬é¦–å…ˆå¯ä»¥é€šè¿‡ 123456789101112131415161718192021$ go build -o main$ GODEBUG=gctrace=1 ./maingc 1 @0.000s 2%: 0.009+0.23+0.004 ms clock, 0.11+0.083/0.019/0.14+0.049 ms cpu, 4-&gt;6-&gt;2 MB, 5 MB goal, 12 Pscvg: 8 KB releasedscvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB)gc 2 @0.001s 2%: 0.018+1.1+0.029 ms clock, 0.22+0.047/0.074/0.048+0.34 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 Pscvg: inuse: 3, idle: 60, sys: 63, released: 56, consumed: 7 (MB)gc 3 @0.003s 2%: 0.018+0.59+0.011 ms clock, 0.22+0.073/0.008/0.042+0.13 ms cpu, 5-&gt;6-&gt;1 MB, 6 MB goal, 12 Pscvg: 8 KB releasedscvg: inuse: 2, idle: 61, sys: 63, released: 56, consumed: 7 (MB)gc 4 @0.003s 4%: 0.019+0.70+0.054 ms clock, 0.23+0.051/0.047/0.085+0.65 ms cpu, 4-&gt;6-&gt;2 MB, 5 MB goal, 12 Pscvg: 8 KB releasedscvg: inuse: 3, idle: 60, sys: 63, released: 56, consumed: 7 (MB)scvg: 8 KB releasedscvg: inuse: 4, idle: 59, sys: 63, released: 56, consumed: 7 (MB)gc 5 @0.004s 12%: 0.021+0.26+0.49 ms clock, 0.26+0.046/0.037/0.11+5.8 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 Pscvg: inuse: 5, idle: 58, sys: 63, released: 56, consumed: 7 (MB)gc 6 @0.005s 12%: 0.020+0.17+0.004 ms clock, 0.25+0.080/0.070/0.053+0.051 ms cpu, 5-&gt;6-&gt;1 MB, 6 MB goal, 12 Pscvg: 8 KB releasedscvg: inuse: 1, idle: 62, sys: 63, released: 56, consumed: 7 (MB) åœ¨è¿™ä¸ªæ—¥å¿—ä¸­å¯ä»¥è§‚å¯Ÿåˆ°ä¸¤ç±»ä¸åŒçš„ä¿¡æ¯ï¼š 123gc 1 @0.000s 2%: 0.009+0.23+0.004 ms clock, 0.11+0.083/0.019/0.14+0.049 ms cpu, 4-&gt;6-&gt;2 MB, 5 MB goal, 12 Pgc 2 @0.001s 2%: 0.018+1.1+0.029 ms clock, 0.22+0.047/0.074/0.048+0.34 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P... ä»¥åŠï¼š 1234scvg: 8 KB releasedscvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB)scvg: inuse: 3, idle: 60, sys: 63, released: 56, consumed: 7 (MB)... å¯¹äºŽç”¨æˆ·ä»£ç å‘è¿è¡Œæ—¶ç”³è¯·å†…å­˜äº§ç”Ÿçš„åžƒåœ¾å›žæ”¶ï¼š 1gc 2 @0.001s 2%: 0.018+1.1+0.029 ms clock, 0.22+0.047/0.074/0.048+0.34 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P å«ä¹‰ç”±ä¸‹è¡¨æ‰€ç¤ºï¼š å­—æ®µ å«ä¹‰ gc 2 ç¬¬äºŒä¸ª GC å‘¨æœŸ 0.001 ç¨‹åºå¼€å§‹åŽçš„ 0.001 ç§’ 2% è¯¥ GC å‘¨æœŸä¸­ CPU çš„ä½¿ç”¨çŽ‡ 0.018 æ ‡è®°å¼€å§‹æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆwall clockï¼‰ 1.1 æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå¹¶å‘æ ‡è®°æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆwall clockï¼‰ 0.029 æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆwall clockï¼‰ 0.22 æ ‡è®°å¼€å§‹æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰ 0.047 æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œæ ‡è®°è¾…åŠ©æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰ 0.074 æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå¹¶å‘æ ‡è®°æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰ 0.048 æ ‡è®°è¿‡ç¨‹ä¸­ï¼ŒGC ç©ºé—²çš„æ—¶é—´ï¼ˆcpu timeï¼‰ 0.34 æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œ STW æ‰€èŠ±è´¹çš„æ—¶é—´ï¼ˆcpu timeï¼‰ 4 æ ‡è®°å¼€å§‹æ—¶ï¼Œå †çš„å¤§å°çš„å®žé™…å€¼ 7 æ ‡è®°ç»“æŸæ—¶ï¼Œå †çš„å¤§å°çš„å®žé™…å€¼ 3 æ ‡è®°ç»“æŸæ—¶ï¼Œæ ‡è®°ä¸ºå­˜æ´»çš„å¯¹è±¡å¤§å° 5 æ ‡è®°ç»“æŸæ—¶ï¼Œå †çš„å¤§å°çš„é¢„æµ‹å€¼ 12 P çš„æ•°é‡ wall clock æ˜¯æŒ‡å¼€å§‹æ‰§è¡Œåˆ°å®Œæˆæ‰€ç»åŽ†çš„å®žé™…æ—¶é—´ï¼ŒåŒ…æ‹¬å…¶ä»–ç¨‹åºå’Œæœ¬ç¨‹åºæ‰€æ¶ˆè€—çš„æ—¶é—´ï¼›cpu time æ˜¯æŒ‡ç‰¹å®šç¨‹åºä½¿ç”¨ CPU çš„æ—¶é—´ï¼›ä»–ä»¬å­˜åœ¨ä»¥ä¸‹å…³ç³»ï¼š wall clock &lt; cpu time: å……åˆ†åˆ©ç”¨å¤šæ ¸ wall clock â‰ˆ cpu time: æœªå¹¶è¡Œæ‰§è¡Œ wall clock &gt; cpu time: å¤šæ ¸ä¼˜åŠ¿ä¸æ˜Žæ˜¾ å¯¹äºŽè¿è¡Œæ—¶å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜äº§ç”Ÿçš„åžƒåœ¾å›žæ”¶ï¼ˆå‘æ“ä½œç³»ç»Ÿå½’è¿˜å¤šä½™çš„å†…å­˜ï¼‰ï¼š 12scvg: 8 KB releasedscvg: inuse: 3, idle: 60, sys: 63, released: 57, consumed: 6 (MB) å«ä¹‰ç”±ä¸‹è¡¨æ‰€ç¤ºï¼š å­—æ®µ å«ä¹‰ 8 KB released å‘æ“ä½œç³»ç»Ÿå½’è¿˜äº† 8 KB å†…å­˜ 3 å·²ç»åˆ†é…ç»™ç”¨æˆ·ä»£ç ã€æ­£åœ¨ä½¿ç”¨çš„æ€»å†…å­˜å¤§å° (MB)ã€‚MB used or partially used spans 60 ç©ºé—²ä»¥åŠç­‰å¾…å½’è¿˜ç»™æ“ä½œç³»ç»Ÿçš„æ€»å†…å­˜å¤§å°ï¼ˆMBï¼‰ã€‚MB spans pending scavenging 63 é€šçŸ¥æ“ä½œç³»ç»Ÿä¸­ä¿ç•™çš„å†…å­˜å¤§å°ï¼ˆMBï¼‰MB mapped from the system 57 å·²ç»å½’è¿˜ç»™æ“ä½œç³»ç»Ÿçš„ï¼ˆæˆ–è€…è¯´è¿˜æœªæ­£å¼ç”³è¯·ï¼‰çš„å†…å­˜å¤§å°ï¼ˆMBï¼‰ã€‚MB released to the system 6 å·²ç»ä»Žæ“ä½œç³»ç»Ÿä¸­ç”³è¯·çš„å†…å­˜å¤§å°ï¼ˆMBï¼‰ã€‚MB allocated from the system æ–¹å¼2ï¼šgo tool tracego tool trace çš„ä¸»è¦åŠŸèƒ½æ˜¯å°†ç»Ÿè®¡è€Œæ¥çš„ä¿¡æ¯ä»¥ä¸€ç§å¯è§†åŒ–çš„æ–¹å¼å±•ç¤ºç»™ç”¨æˆ·ã€‚è¦ä½¿ç”¨æ­¤å·¥å…·ï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨ trace APIï¼š 123456789package mainfunc main() &#123; f, _ := os.Create("trace.out") defer f.Close() trace.Start(f) defer trace.Stop() (...)&#125; å¹¶é€šè¿‡ 1234$ go tool trace trace.out2019/12/30 15:50:33 Parsing trace...2019/12/30 15:50:38 Splitting trace...2019/12/30 15:50:45 Opening browser. Trace viewer is listening on http://127.0.0.1:51839 å‘½ä»¤æ¥å¯åŠ¨å¯è§†åŒ–ç•Œé¢ï¼š é€‰æ‹©ç¬¬ä¸€ä¸ªé“¾æŽ¥å¯ä»¥èŽ·å¾—å¦‚ä¸‹å›¾ç¤ºï¼š å³ä¸Šè§’çš„é—®å·å¯ä»¥æ‰“å¼€å¸®åŠ©èœå•ï¼Œä¸»è¦ä½¿ç”¨æ–¹å¼åŒ…æ‹¬ï¼š w/s é”®å¯ä»¥ç”¨äºŽæ”¾å¤§æˆ–è€…ç¼©å°è§†å›¾ a/d é”®å¯ä»¥ç”¨äºŽå·¦å³ç§»åŠ¨ æ–¹å¼3ï¼šdebug.ReadGCStatsæ­¤æ–¹å¼å¯ä»¥é€šè¿‡ä»£ç çš„æ–¹å¼æ¥ç›´æŽ¥å®žçŽ°å¯¹æ„Ÿå…´è¶£æŒ‡æ ‡çš„ç›‘æŽ§ï¼Œä¾‹å¦‚æˆ‘ä»¬å¸Œæœ›æ¯éš”ä¸€ç§’é’Ÿç›‘æŽ§ä¸€æ¬¡ GC çš„çŠ¶æ€ï¼š 123456789101112131415func printGCStats() &#123; t := time.NewTicker(time.Second) s := debug.GCStats&#123;&#125; for &#123; select &#123; case &lt;-t.C: debug.ReadGCStats(&amp;s) fmt.Printf("gc %d last@%v, PauseTotal %v\n", s.NumGC, s.LastGC, s.PauseTotal) &#125; &#125;&#125;func main() &#123; go printGCStats() (...)&#125; æˆ‘ä»¬èƒ½å¤Ÿçœ‹åˆ°å¦‚ä¸‹è¾“å‡ºï¼š 1234567$ go run main.gogc 4954 last@2019-12-30 15:19:37.505575 +0100 CET, PauseTotal 29.901171msgc 9195 last@2019-12-30 15:19:38.50565 +0100 CET, PauseTotal 77.579622msgc 13502 last@2019-12-30 15:19:39.505714 +0100 CET, PauseTotal 128.022307msgc 17555 last@2019-12-30 15:19:40.505579 +0100 CET, PauseTotal 182.816528msgc 21838 last@2019-12-30 15:19:41.505595 +0100 CET, PauseTotal 246.618502ms æ–¹å¼4ï¼šruntime.ReadMemStatsé™¤äº†ä½¿ç”¨ debug åŒ…æä¾›çš„æ–¹æ³•å¤–ï¼Œè¿˜å¯ä»¥ç›´æŽ¥é€šè¿‡è¿è¡Œæ—¶çš„å†…å­˜ç›¸å…³çš„ API è¿›è¡Œç›‘æŽ§ï¼š 12345678910111213141516func printMemStats() &#123; t := time.NewTicker(time.Second) s := runtime.MemStats&#123;&#125; for &#123; select &#123; case &lt;-t.C: runtime.ReadMemStats(&amp;s) fmt.Printf("gc %d last@%v, next_heap_size@%vMB\n", s.NumGC, time.Unix(int64(time.Duration(s.LastGC).Seconds()), 0), s.NextGC/(1&lt;&lt;20)) &#125; &#125;&#125;func main() &#123; go printMemStats() (...)&#125; 123456$ go run main.gogc 4887 last@2019-12-30 15:44:56 +0100 CET, next_heap_size@4MBgc 10049 last@2019-12-30 15:44:57 +0100 CET, next_heap_size@4MBgc 15231 last@2019-12-30 15:44:58 +0100 CET, next_heap_size@4MBgc 20378 last@2019-12-30 15:44:59 +0100 CET, next_heap_size@6MB å½“ç„¶ï¼ŒåŽä¸¤ç§æ–¹å¼èƒ½å¤Ÿç›‘æŽ§çš„æŒ‡æ ‡å¾ˆå¤šï¼Œè¯»è€…å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ debug.GCStats å’Œruntime.MemStats çš„å­—æ®µï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ 7. æœ‰äº† GCï¼Œä¸ºä»€ä¹ˆè¿˜ä¼šå‘ç”Ÿå†…å­˜æ³„éœ²ï¼Ÿåœ¨ä¸€ä¸ªå…·æœ‰ GC çš„è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å¸¸è¯´çš„å†…å­˜æ³„æ¼ï¼Œç”¨ä¸¥è°¨çš„è¯æ¥è¯´åº”è¯¥æ˜¯ï¼šé¢„æœŸçš„èƒ½å¾ˆå¿«è¢«é‡Šæ”¾çš„å†…å­˜ç”±äºŽé™„ç€åœ¨äº†é•¿æœŸå­˜æ´»çš„å†…å­˜ä¸Šã€æˆ–ç”Ÿå‘½æœŸæ„å¤–åœ°è¢«å»¶é•¿ï¼Œå¯¼è‡´é¢„è®¡èƒ½å¤Ÿç«‹å³å›žæ”¶çš„å†…å­˜è€Œé•¿æ—¶é—´å¾—ä¸åˆ°å›žæ”¶ã€‚ åœ¨ Go ä¸­ï¼Œç”±äºŽ goroutine çš„å­˜åœ¨ï¼Œæ‰€è°“çš„å†…å­˜æ³„æ¼é™¤äº†é™„ç€åœ¨é•¿æœŸå¯¹è±¡ä¸Šä¹‹å¤–ï¼Œè¿˜å­˜åœ¨å¤šç§ä¸åŒçš„å½¢å¼ã€‚ å½¢å¼1ï¼šé¢„æœŸèƒ½è¢«å¿«é€Ÿé‡Šæ”¾çš„å†…å­˜å› è¢«æ ¹å¯¹è±¡å¼•ç”¨è€Œæ²¡æœ‰å¾—åˆ°è¿…é€Ÿé‡Šæ”¾å½“æœ‰ä¸€ä¸ªå…¨å±€å¯¹è±¡æ—¶ï¼Œå¯èƒ½ä¸ç»æ„é—´å°†æŸä¸ªå˜é‡é™„ç€åœ¨å…¶ä¸Šï¼Œä¸”å¿½ç•¥çš„å°†å…¶è¿›è¡Œé‡Šæ”¾ï¼Œåˆ™è¯¥å†…å­˜æ°¸è¿œä¸ä¼šå¾—åˆ°é‡Šæ”¾ã€‚ä¾‹å¦‚ï¼š 12345678var cache = map[interface&#123;&#125;]interface&#123;&#125;&#123;&#125;func keepalloc() &#123; for i := 0; i &lt; 10000; i++ &#123; m := make([]byte, 1&lt;&lt;10) cache[i] = m &#125;&#125; å½¢å¼2ï¼šgoroutine æ³„æ¼Goroutine ä½œä¸ºä¸€ç§é€»è¾‘ä¸Šç†è§£çš„è½»é‡çº§çº¿ç¨‹ï¼Œéœ€è¦ç»´æŠ¤æ‰§è¡Œç”¨æˆ·ä»£ç çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚åœ¨è¿è¡Œè¿‡ç¨‹ä¸­ä¹Ÿéœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…å­˜æ¥ä¿å­˜è¿™ç±»ä¿¡æ¯ï¼Œè€Œè¿™äº›å†…å­˜åœ¨ç›®å‰ç‰ˆæœ¬çš„ Go ä¸­æ˜¯ä¸ä¼šè¢«é‡Šæ”¾çš„ã€‚å› æ­¤ï¼Œå¦‚æžœä¸€ä¸ªç¨‹åºæŒç»­ä¸æ–­åœ°äº§ç”Ÿæ–°çš„ goroutineã€ä¸”ä¸ç»“æŸå·²ç»åˆ›å»ºçš„ goroutine å¹¶å¤ç”¨è¿™éƒ¨åˆ†å†…å­˜ï¼Œå°±ä¼šé€ æˆå†…å­˜æ³„æ¼çš„çŽ°è±¡ï¼Œä¾‹å¦‚ï¼š 1234567func keepalloc2() &#123; for i := 0; i &lt; 100000; i++ &#123; go func() &#123; select &#123;&#125; &#125;() &#125;&#125; éªŒè¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å¦‚ä¸‹å½¢å¼æ¥è°ƒç”¨ä¸Šè¿°ä¸¤ä¸ªå‡½æ•°ï¼š 123456789101112131415package mainimport ( "os" "runtime/trace")func main() &#123; f, _ := os.Create("trace.out") defer f.Close() trace.Start(f) defer trace.Stop() keepalloc() keepalloc2()&#125; è¿è¡Œç¨‹åºï¼š 1go run main.go ä¼šçœ‹åˆ°ç¨‹åºä¸­ç”Ÿæˆäº† trace.out æ–‡ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ go tool trace trace.out å‘½ä»¤å¾—åˆ°ä¸‹å›¾ï¼š å¯ä»¥çœ‹åˆ°ï¼Œé€”ä¸­çš„ Heap åœ¨æŒç»­å¢žé•¿ï¼Œæ²¡æœ‰å†…å­˜è¢«å›žæ”¶ï¼Œäº§ç”Ÿäº†å†…å­˜æ³„æ¼çš„çŽ°è±¡ã€‚ å€¼å¾—ä¸€æçš„æ˜¯ï¼Œè¿™ç§å½¢å¼çš„ goroutine æ³„æ¼è¿˜å¯èƒ½ç”± channel æ³„æ¼å¯¼è‡´ã€‚è€Œ channel çš„æ³„æ¼æœ¬è´¨ä¸Šä¸Ž goroutine æ³„æ¼å­˜åœ¨ç›´æŽ¥è”ç³»ã€‚Channel ä½œä¸ºä¸€ç§åŒæ­¥åŽŸè¯­ï¼Œä¼šè¿žæŽ¥ä¸¤ä¸ªä¸åŒçš„ goroutineï¼Œå¦‚æžœä¸€ä¸ª goroutine å°è¯•å‘ä¸€ä¸ªæ²¡æœ‰æŽ¥æ”¶æ–¹çš„æ— ç¼“å†² channel å‘é€æ¶ˆæ¯ï¼Œåˆ™è¯¥ goroutine ä¼šè¢«æ°¸ä¹…çš„ä¼‘çœ ï¼Œæ•´ä¸ª goroutine åŠå…¶æ‰§è¡Œæ ˆéƒ½å¾—ä¸åˆ°é‡Šæ”¾ï¼Œä¾‹å¦‚ï¼š 12345678var ch = make(chan struct&#123;&#125;)func keepalloc3() &#123; for i := 0; i &lt; 100000; i++ &#123; // æ²¡æœ‰æŽ¥æ”¶æ–¹ï¼Œgoroutine ä¼šä¸€ç›´é˜»å¡ž go func() &#123; ch &lt;- struct&#123;&#125;&#123;&#125; &#125;() &#125;&#125; 8. å¹¶å‘æ ‡è®°æ¸…é™¤æ³•çš„éš¾ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿåœ¨æ²¡æœ‰ç”¨æˆ·æ€ä»£ç å¹¶å‘ä¿®æ”¹ä¸‰è‰²æŠ½è±¡çš„æƒ…å†µä¸‹ï¼Œå›žæ”¶å¯ä»¥æ­£å¸¸ç»“æŸã€‚ä½†æ˜¯å¹¶å‘å›žæ”¶çš„æ ¹æœ¬é—®é¢˜åœ¨äºŽï¼Œç”¨æˆ·æ€ä»£ç åœ¨å›žæ”¶è¿‡ç¨‹ä¸­ä¼šå¹¶å‘åœ°æ›´æ–°å¯¹è±¡å›¾ï¼Œä»Žè€Œé€ æˆèµ‹å€¼å™¨å’Œå›žæ”¶å™¨å¯èƒ½å¯¹å¯¹è±¡å›¾çš„ç»“æž„äº§ç”Ÿä¸åŒçš„è®¤çŸ¥ã€‚è¿™æ—¶ä»¥ä¸€ä¸ªå›ºå®šçš„ä¸‰è‰²æ³¢é¢ä½œä¸ºå›žæ”¶è¿‡ç¨‹å‰è¿›çš„è¾¹ç•Œåˆ™ä¸å†åˆç†ã€‚ æˆ‘ä»¬ä¸å¦¨è€ƒè™‘èµ‹å€¼å™¨å†™æ“ä½œçš„ä¾‹å­ï¼š æ—¶åº å›žæ”¶å™¨ èµ‹å€¼å™¨ è¯´æ˜Ž 1 shade(A, gray) å›žæ”¶å™¨ï¼šæ ¹å¯¹è±¡çš„å­èŠ‚ç‚¹ç€è‰²ä¸ºç°è‰²å¯¹è±¡ 2 shade(C, black) å›žæ”¶å™¨ï¼šå½“æ‰€æœ‰å­èŠ‚ç‚¹ç€è‰²ä¸ºç°è‰²åŽï¼Œå°†èŠ‚ç‚¹ç€ä¸ºé»‘è‰² 3 C.ref3 = C.ref2.ref1 èµ‹å€¼å™¨ï¼šå¹¶å‘çš„ä¿®æ”¹äº† C çš„å­èŠ‚ç‚¹ 4 A.ref1 = nil èµ‹å€¼å™¨ï¼šå¹¶å‘çš„ä¿®æ”¹äº† A çš„å­èŠ‚ç‚¹ 5 shade(A.ref1, gray) å›žæ”¶å™¨ï¼šè¿›ä¸€æ­¥ç°è‰²å¯¹è±¡çš„å­èŠ‚ç‚¹å¹¶ç€è‰²ä¸ºç°è‰²å¯¹è±¡ï¼Œè¿™æ—¶ç”±äºŽ A.ref1 ä¸º nilï¼Œä»€ä¹ˆäº‹æƒ…ä¹Ÿæ²¡æœ‰å‘ç”Ÿ 6 shade(A, black) å›žæ”¶å™¨ï¼šç”±äºŽæ‰€æœ‰å­èŠ‚ç‚¹å‡å·²æ ‡è®°ï¼Œå›žæ”¶å™¨ä¹Ÿä¸ä¼šé‡æ–°æ‰«æå·²ç»è¢«æ ‡è®°ä¸ºé»‘è‰²çš„å¯¹è±¡ï¼Œæ­¤æ—¶ A è¢«ç€è‰²ä¸ºé»‘è‰²ï¼Œscan(A) ä»€ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿï¼Œè¿›è€Œ B åœ¨æ­¤æ¬¡å›žæ”¶è¿‡ç¨‹ä¸­æ°¸è¿œä¸ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²ï¼Œè¿›è€Œé”™è¯¯åœ°è¢«å›žæ”¶ã€‚ åˆå§‹çŠ¶æ€ï¼šå‡è®¾æŸä¸ªé»‘è‰²å¯¹è±¡ C æŒ‡å‘æŸä¸ªç°è‰²å¯¹è±¡ A ï¼Œè€Œ A æŒ‡å‘ç™½è‰²å¯¹è±¡ Bï¼› C.ref3 = C.ref2.ref1ï¼šèµ‹å€¼å™¨å¹¶å‘åœ°å°†é»‘è‰²å¯¹è±¡ C æŒ‡å‘ï¼ˆref3ï¼‰äº†ç™½è‰²å¯¹è±¡ Bï¼› A.ref1 = nilï¼šç§»é™¤ç°è‰²å¯¹è±¡ A å¯¹ç™½è‰²å¯¹è±¡ B çš„å¼•ç”¨ï¼ˆref2ï¼‰ï¼› æœ€ç»ˆçŠ¶æ€ï¼šåœ¨ç»§ç»­æ‰«æçš„è¿‡ç¨‹ä¸­ï¼Œç™½è‰²å¯¹è±¡ B æ°¸è¿œä¸ä¼šè¢«æ ‡è®°ä¸ºé»‘è‰²å¯¹è±¡äº†ï¼ˆå›žæ”¶å™¨ä¸ä¼šé‡æ–°æ‰«æé»‘è‰²å¯¹è±¡ï¼‰ï¼Œè¿›è€Œå¯¹è±¡ B è¢«é”™è¯¯åœ°å›žæ”¶ã€‚ æ€»è€Œè¨€ä¹‹ï¼Œå¹¶å‘æ ‡è®°æ¸…é™¤ä¸­é¢ä¸´çš„ä¸€ä¸ªæ ¹æœ¬é—®é¢˜å°±æ˜¯å¦‚ä½•ä¿è¯æ ‡è®°ä¸Žæ¸…é™¤è¿‡ç¨‹çš„æ­£ç¡®æ€§ã€‚ 9. ä»€ä¹ˆæ˜¯å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå¦‚ä½•å®žçŽ°ï¼Ÿè¦è®²æ¸…æ¥šå†™å±éšœï¼Œå°±éœ€è¦ç†è§£ä¸‰è‰²æ ‡è®°æ¸…é™¤ç®—æ³•ä¸­çš„å¼ºå¼±ä¸å˜æ€§ä»¥åŠèµ‹å€¼å™¨çš„é¢œè‰²ï¼Œç†è§£ä»–ä»¬éœ€è¦ä¸€å®šçš„æŠ½è±¡æ€ç»´ã€‚å†™å±éšœæ˜¯ä¸€ä¸ªåœ¨å¹¶å‘åžƒåœ¾å›žæ”¶å™¨ä¸­æ‰ä¼šå‡ºçŽ°çš„æ¦‚å¿µï¼Œåžƒåœ¾å›žæ”¶å™¨çš„æ­£ç¡®æ€§ä½“çŽ°åœ¨ï¼šä¸åº”å‡ºçŽ°å¯¹è±¡çš„ä¸¢å¤±ï¼Œä¹Ÿä¸åº”é”™è¯¯çš„å›žæ”¶è¿˜ä¸éœ€è¦å›žæ”¶çš„å¯¹è±¡ã€‚ å¯ä»¥è¯æ˜Žï¼Œå½“ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ä¼šç ´ååžƒåœ¾å›žæ”¶å™¨çš„æ­£ç¡®æ€§ï¼š æ¡ä»¶ 1: èµ‹å€¼å™¨ä¿®æ”¹å¯¹è±¡å›¾ï¼Œå¯¼è‡´æŸä¸€é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡ï¼› æ¡ä»¶ 2: ä»Žç°è‰²å¯¹è±¡å‡ºå‘ï¼Œåˆ°è¾¾ç™½è‰²å¯¹è±¡çš„ã€æœªç»è®¿é—®è¿‡çš„è·¯å¾„è¢«èµ‹å€¼å™¨ç ´åã€‚ åªè¦èƒ½å¤Ÿé¿å…å…¶ä¸­ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œåˆ™ä¸ä¼šå‡ºçŽ°å¯¹è±¡ä¸¢å¤±çš„æƒ…å†µï¼Œå› ä¸ºï¼š å¦‚æžœæ¡ä»¶ 1 è¢«é¿å…ï¼Œåˆ™æ‰€æœ‰ç™½è‰²å¯¹è±¡å‡è¢«ç°è‰²å¯¹è±¡å¼•ç”¨ï¼Œæ²¡æœ‰ç™½è‰²å¯¹è±¡ä¼šè¢«é—æ¼ï¼› å¦‚æžœæ¡ä»¶ 2 è¢«é¿å…ï¼Œå³ä¾¿ç™½è‰²å¯¹è±¡çš„æŒ‡é’ˆè¢«å†™å…¥åˆ°é»‘è‰²å¯¹è±¡ä¸­ï¼Œä½†ä»Žç°è‰²å¯¹è±¡å‡ºå‘ï¼Œæ€»å­˜åœ¨ä¸€æ¡æ²¡æœ‰è®¿é—®è¿‡çš„è·¯å¾„ï¼Œä»Žè€Œæ‰¾åˆ°åˆ°è¾¾ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œç™½è‰²å¯¹è±¡æœ€ç»ˆä¸ä¼šè¢«é—æ¼ã€‚ æˆ‘ä»¬ä¸å¦¨å°†ä¸‰è‰²ä¸å˜æ€§æ‰€å®šä¹‰çš„æ³¢é¢æ ¹æ®è¿™ä¸¤ä¸ªæ¡ä»¶è¿›è¡Œå‰Šå¼±ï¼š å½“æ»¡è¶³åŽŸæœ‰çš„ä¸‰è‰²ä¸å˜æ€§å®šä¹‰ï¼ˆæˆ–ä¸Šé¢çš„ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸æ»¡è¶³æ—¶ï¼‰çš„æƒ…å†µç§°ä¸ºå¼ºä¸‰è‰²ä¸å˜æ€§ï¼ˆstrong tricolor invariantï¼‰ å½“èµ‹å€¼å™¨ä»¤é»‘è‰²å¯¹è±¡å¼•ç”¨ç™½è‰²å¯¹è±¡æ—¶ï¼ˆæ»¡è¶³æ¡ä»¶ 1 æ—¶ï¼‰çš„æƒ…å†µç§°ä¸ºå¼±ä¸‰è‰²ä¸å˜æ€§ï¼ˆweak tricolor invariantï¼‰ å½“èµ‹å€¼å™¨è¿›ä¸€æ­¥ç ´åç°è‰²å¯¹è±¡åˆ°è¾¾ç™½è‰²å¯¹è±¡çš„è·¯å¾„æ—¶ï¼ˆè¿›ä¸€æ­¥æ»¡è¶³æ¡ä»¶ 2 æ—¶ï¼‰ï¼Œå³æ‰“ç ´å¼±ä¸‰è‰²ä¸å˜æ€§ï¼Œä¹Ÿå°±ç ´åäº†å›žæ”¶å™¨çš„æ­£ç¡®æ€§ï¼›æˆ–è€…è¯´ï¼Œåœ¨ç ´åå¼ºå¼±ä¸‰è‰²ä¸å˜æ€§æ—¶å¿…é¡»å¼•å…¥é¢å¤–çš„è¾…åŠ©æ“ä½œã€‚å¼±ä¸‰è‰²ä¸å˜å½¢çš„å¥½å¤„åœ¨äºŽï¼šåªè¦å­˜åœ¨æœªè®¿é—®çš„èƒ½å¤Ÿåˆ°è¾¾ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œå°±å¯ä»¥å°†é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ã€‚ å¦‚æžœæˆ‘ä»¬è€ƒè™‘å¹¶å‘çš„ç”¨æˆ·æ€ä»£ç ï¼Œå›žæ”¶å™¨ä¸å…è®¸åŒæ—¶åœæ­¢æ‰€æœ‰èµ‹å€¼å™¨ï¼Œå°±æ˜¯æ¶‰åŠäº†å­˜åœ¨çš„å¤šä¸ªä¸åŒçŠ¶æ€çš„èµ‹å€¼å™¨ã€‚ä¸ºäº†å¯¹æ¦‚å¿µåŠ ä»¥æ˜Žç¡®ï¼Œè¿˜éœ€è¦æ¢ä¸€ä¸ªè§’åº¦ï¼ŒæŠŠå›žæ”¶å™¨è§†ä¸ºå¯¹è±¡ï¼ŒæŠŠèµ‹å€¼å™¨è§†ä¸ºå½±å“å›žæ”¶å™¨è¿™ä¸€å¯¹è±¡çš„å®žé™…è¡Œä¸ºï¼ˆå³å½±å“ GC å‘¨æœŸçš„é•¿çŸ­ï¼‰ï¼Œä»Žè€Œå¼•å…¥èµ‹å€¼å™¨çš„é¢œè‰²ï¼š é»‘è‰²èµ‹å€¼å™¨ï¼šå·²ç»ç”±å›žæ”¶å™¨æ‰«æè¿‡ï¼Œä¸ä¼šå†æ¬¡å¯¹å…¶è¿›è¡Œæ‰«æã€‚ ç°è‰²èµ‹å€¼å™¨ï¼šå°šæœªè¢«å›žæ”¶å™¨æ‰«æè¿‡ï¼Œæˆ–å°½ç®¡å·²ç»æ‰«æè¿‡ä½†ä»éœ€è¦é‡æ–°æ‰«æã€‚ èµ‹å€¼å™¨çš„é¢œè‰²å¯¹å›žæ”¶å‘¨æœŸçš„ç»“æŸäº§ç”Ÿå½±å“ï¼š å¦‚æžœæŸç§å¹¶å‘å›žæ”¶å™¨å…è®¸ç°è‰²èµ‹å€¼å™¨çš„å­˜åœ¨ï¼Œåˆ™å¿…é¡»åœ¨å›žæ”¶ç»“æŸä¹‹å‰é‡æ–°æ‰«æå¯¹è±¡å›¾ã€‚ å¦‚æžœé‡æ–°æ‰«æè¿‡ç¨‹ä¸­å‘çŽ°äº†æ–°çš„ç°è‰²æˆ–ç™½è‰²å¯¹è±¡ï¼Œå›žæ”¶å™¨è¿˜éœ€è¦å¯¹æ–°å‘çŽ°çš„å¯¹è±¡è¿›è¡Œè¿½è¸ªï¼Œä½†æ˜¯åœ¨æ–°è¿½è¸ªçš„è¿‡ç¨‹ä¸­ï¼Œèµ‹å€¼å™¨ä»ç„¶å¯èƒ½åœ¨å…¶æ ¹ä¸­æ’å…¥æ–°çš„éžé»‘è‰²çš„å¼•ç”¨ï¼Œå¦‚æ­¤å¾€å¤ï¼Œç›´åˆ°é‡æ–°æ‰«æè¿‡ç¨‹ä¸­æ²¡æœ‰å‘çŽ°æ–°çš„ç™½è‰²æˆ–ç°è‰²å¯¹è±¡ã€‚ äºŽæ˜¯ï¼Œåœ¨å…è®¸ç°è‰²èµ‹å€¼å™¨å­˜åœ¨çš„ç®—æ³•ï¼Œæœ€åçš„æƒ…å†µä¸‹ï¼Œå›žæ”¶å™¨åªèƒ½å°†æ‰€æœ‰èµ‹å€¼å™¨çº¿ç¨‹åœæ­¢æ‰èƒ½å®Œæˆå…¶è·Ÿå¯¹è±¡çš„å®Œæ•´æ‰«æï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ STWã€‚ ä¸ºäº†ç¡®ä¿å¼ºå¼±ä¸‰è‰²ä¸å˜æ€§çš„å¹¶å‘æŒ‡é’ˆæ›´æ–°æ“ä½œï¼Œéœ€è¦é€šè¿‡èµ‹å€¼å™¨å±éšœæŠ€æœ¯æ¥ä¿è¯æŒ‡é’ˆçš„è¯»å†™æ“ä½œä¸€è‡´ã€‚å› æ­¤æˆ‘ä»¬æ‰€è¯´çš„ Go ä¸­çš„å†™å±éšœã€æ··åˆå†™å±éšœï¼Œå…¶å®žæ˜¯æŒ‡èµ‹å€¼å™¨çš„å†™å±éšœï¼Œèµ‹å€¼å™¨çš„å†™å±éšœç”¨æ¥ä¿è¯èµ‹å€¼å™¨åœ¨è¿›è¡ŒæŒ‡é’ˆå†™æ“ä½œæ—¶ï¼Œä¸ä¼šç ´åå¼±ä¸‰è‰²ä¸å˜æ€§ã€‚ æœ‰ä¸¤ç§éžå¸¸ç»å…¸çš„å†™å±éšœï¼šDijkstra æ’å…¥å±éšœå’Œ Yuasa åˆ é™¤å±éšœã€‚ ç°è‰²èµ‹å€¼å™¨çš„ Dijkstra æ’å…¥å±éšœçš„åŸºæœ¬æ€æƒ³æ˜¯é¿å…æ»¡è¶³æ¡ä»¶ 1ï¼š 12345// ç°è‰²èµ‹å€¼å™¨ Dijkstra æ’å…¥å±éšœfunc DijkstraWritePointer(slot *unsafe.Pointer, ptr unsafe.Pointer) &#123; shade(ptr) *slot = ptr&#125; ä¸ºäº†é˜²æ­¢é»‘è‰²å¯¹è±¡æŒ‡å‘ç™½è‰²å¯¹è±¡ï¼Œåº”è¯¥å‡è®¾ *slot å¯èƒ½ä¼šå˜ä¸ºé»‘è‰²ï¼Œä¸ºäº†ç¡®ä¿ ptr ä¸ä¼šåœ¨è¢«èµ‹å€¼åˆ° *slot å‰å˜ä¸ºç™½è‰²ï¼Œshade(ptr) ä¼šå…ˆå°†æŒ‡é’ˆ ptr æ ‡è®°ä¸ºç°è‰²ï¼Œè¿›è€Œé¿å…äº†æ¡ä»¶ 1ã€‚ä½†æ˜¯ï¼Œç”±äºŽå¹¶ä¸æ¸…æ¥šèµ‹å€¼å™¨ä»¥åŽä¼šä¸ä¼šå°†è¿™ä¸ªå¼•ç”¨åˆ é™¤ï¼Œå› æ­¤è¿˜éœ€è¦é‡æ–°æ‰«ææ¥é‡æ–°ç¡®å®šå…³ç³»å›¾ï¼Œè¿™æ—¶éœ€è¦ STWï¼Œå¦‚å›¾æ‰€ç¤ºï¼š Dijkstra æ’å…¥å±éšœçš„å¥½å¤„åœ¨äºŽå¯ä»¥ç«‹åˆ»å¼€å§‹å¹¶å‘æ ‡è®°ï¼Œä½†ç”±äºŽäº§ç”Ÿäº†ç°è‰²èµ‹å€¼å™¨ï¼Œç¼ºé™·æ˜¯éœ€è¦æ ‡è®°ç»ˆæ­¢é˜¶æ®µ STW æ—¶è¿›è¡Œé‡æ–°æ‰«æã€‚ é»‘è‰²èµ‹å€¼å™¨çš„ Yuasa åˆ é™¤å±éšœçš„åŸºæœ¬æ€æƒ³æ˜¯é¿å…æ»¡è¶³æ¡ä»¶ 2ï¼š 12345// é»‘è‰²èµ‹å€¼å™¨ Yuasa å±éšœfunc YuasaWritePointer(slot *unsafe.Pointer, ptr unsafe.Pointer) &#123; shade(*slot) *slot = ptr&#125; ä¸ºäº†é˜²æ­¢ä¸¢å¤±ä»Žç°è‰²å¯¹è±¡åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œåº”è¯¥å‡è®¾ *slot å¯èƒ½ä¼šå˜ä¸ºé»‘è‰²ï¼Œä¸ºäº†ç¡®ä¿ ptr ä¸ä¼šåœ¨è¢«èµ‹å€¼åˆ° *slot å‰å˜ä¸ºç™½è‰²ï¼Œshade(*slot) ä¼šå…ˆå°† *slot æ ‡è®°ä¸ºç°è‰²ï¼Œè¿›è€Œè¯¥å†™æ“ä½œæ€»æ˜¯åˆ›é€ äº†ä¸€æ¡ç°è‰²åˆ°ç°è‰²æˆ–è€…ç°è‰²åˆ°ç™½è‰²å¯¹è±¡çš„è·¯å¾„ï¼Œè¿›è€Œé¿å…äº†æ¡ä»¶ 2ã€‚ Yuasa åˆ é™¤å±éšœçš„ä¼˜åŠ¿åˆ™åœ¨äºŽä¸éœ€è¦æ ‡è®°ç»“æŸé˜¶æ®µçš„é‡æ–°æ‰«æï¼Œç¼ºé™·æ˜¯ä¾ç„¶ä¼šäº§ç”Ÿä¸¢å¤±çš„å¯¹è±¡ï¼Œéœ€è¦åœ¨æ ‡è®°å¼€å§‹å‰å¯¹æ•´ä¸ªå¯¹è±¡å›¾è¿›è¡Œå¿«ç…§ã€‚ Go åœ¨ 1.8 çš„æ—¶å€™ä¸ºäº†ç®€åŒ– GC çš„æµç¨‹ï¼ŒåŒæ—¶å‡å°‘æ ‡è®°ç»ˆæ­¢é˜¶æ®µçš„é‡æ‰«æˆæœ¬ï¼Œå°† Dijkstra æ’å…¥å±éšœå’Œ Yuasa åˆ é™¤å±éšœè¿›è¡Œæ··åˆï¼Œå½¢æˆæ··åˆå†™å±éšœã€‚è¯¥å±éšœæå‡ºæ—¶çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šå¯¹æ­£åœ¨è¢«è¦†ç›–çš„å¯¹è±¡è¿›è¡Œç€è‰²ï¼Œä¸”å¦‚æžœå½“å‰æ ˆæœªæ‰«æå®Œæˆï¼Œåˆ™åŒæ ·å¯¹æŒ‡é’ˆè¿›è¡Œç€è‰²ã€‚ ä½†åœ¨æœ€ç»ˆå®žçŽ°æ—¶åŽŸææ¡ˆä¸­å¯¹ ptr çš„ç€è‰²è¿˜é¢å¤–åŒ…å«å¯¹æ‰§è¡Œæ ˆçš„ç€è‰²æ£€æŸ¥ï¼Œä½†ç”±äºŽæ—¶é—´æœ‰é™ï¼Œå¹¶æœªå®Œæ•´å®žçŽ°è¿‡ï¼Œæ‰€ä»¥æ··åˆå†™å±éšœåœ¨ç›®å‰çš„å®žçŽ°ä¼ªä»£ç æ˜¯ï¼š 123456// æ··åˆå†™å±éšœfunc HybridWritePointerSimple(slot *unsafe.Pointer, ptr unsafe.Pointer) &#123; shade(*slot) shade(ptr) *slot = ptr&#125; åœ¨è¿™ä¸ªå®žçŽ°ä¸­ï¼Œå¦‚æžœæ— æ¡ä»¶å¯¹å¼•ç”¨åŒæ–¹è¿›è¡Œç€è‰²ï¼Œè‡ªç„¶ç»“åˆäº† Dijkstra å’Œ Yuasa å†™å±éšœçš„ä¼˜åŠ¿ï¼Œä½†ç¼ºç‚¹ä¹Ÿéžå¸¸æ˜Žæ˜¾ï¼Œå› ä¸ºç€è‰²æˆæœ¬æ˜¯åŒå€çš„ï¼Œè€Œä¸”ç¼–è¯‘å™¨éœ€è¦æ’å…¥çš„ä»£ç ä¹Ÿæˆå€å¢žåŠ ï¼Œéšä¹‹å¸¦æ¥çš„ç»“æžœå°±æ˜¯ç¼–è¯‘åŽçš„äºŒè¿›åˆ¶æ–‡ä»¶å¤§å°ä¹Ÿè¿›ä¸€æ­¥å¢žåŠ ã€‚ä¸ºäº†é’ˆå¯¹å†™å±éšœçš„æ€§èƒ½è¿›è¡Œä¼˜åŒ–ï¼ŒGo 1.10 å‰åŽï¼ŒGo å›¢é˜ŸéšåŽå®žçŽ°äº†æ‰¹é‡å†™å±éšœæœºåˆ¶ã€‚å…¶åŸºæœ¬æƒ³æ³•æ˜¯å°†éœ€è¦ç€è‰²çš„æŒ‡é’ˆåŒä¸€å†™å…¥ä¸€ä¸ªç¼“å­˜ï¼Œæ¯å½“ç¼“å­˜æ»¡æ—¶ç»Ÿä¸€å¯¹ç¼“å­˜ä¸­çš„æ‰€æœ‰ ptr æŒ‡é’ˆè¿›è¡Œç€è‰²ã€‚ GC çš„å®žçŽ°ç»†èŠ‚10. Go è¯­è¨€ä¸­ GC çš„æµç¨‹æ˜¯ä»€ä¹ˆï¼Ÿå½“å‰ç‰ˆæœ¬çš„ Go ä»¥ STW ä¸ºç•Œé™ï¼Œå¯ä»¥å°† GC åˆ’åˆ†ä¸ºäº”ä¸ªé˜¶æ®µï¼š é˜¶æ®µ è¯´æ˜Ž èµ‹å€¼å™¨çŠ¶æ€ GCMark æ ‡è®°å‡†å¤‡é˜¶æ®µï¼Œä¸ºå¹¶å‘æ ‡è®°åšå‡†å¤‡å·¥ä½œï¼Œå¯åŠ¨å†™å±éšœ STW GCMark æ‰«ææ ‡è®°é˜¶æ®µï¼Œä¸Žèµ‹å€¼å™¨å¹¶å‘æ‰§è¡Œï¼Œå†™å±éšœå¼€å¯ å¹¶å‘ GCMarkTermination æ ‡è®°ç»ˆæ­¢é˜¶æ®µï¼Œä¿è¯ä¸€ä¸ªå‘¨æœŸå†…æ ‡è®°ä»»åŠ¡å®Œæˆï¼Œåœæ­¢å†™å±éšœ STW GCoff å†…å­˜æ¸…æ‰«é˜¶æ®µï¼Œå°†éœ€è¦å›žæ”¶çš„å†…å­˜å½’è¿˜åˆ°å †ä¸­ï¼Œå†™å±éšœå…³é—­ å¹¶å‘ GCoff å†…å­˜å½’è¿˜é˜¶æ®µï¼Œå°†è¿‡å¤šçš„å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿï¼Œå†™å±éšœå…³é—­ å¹¶å‘ å…·ä½“è€Œè¨€ï¼Œå„ä¸ªé˜¶æ®µçš„è§¦å‘å‡½æ•°åˆ†åˆ«ä¸ºï¼š 11. è§¦å‘ GC çš„æ—¶æœºæ˜¯ä»€ä¹ˆï¼ŸGo è¯­è¨€ä¸­å¯¹ GC çš„è§¦å‘æ—¶æœºå­˜åœ¨ä¸¤ç§å½¢å¼ï¼š ä¸»åŠ¨è§¦å‘ï¼Œé€šè¿‡è°ƒç”¨ runtime.GC æ¥è§¦å‘ GCï¼Œæ­¤è°ƒç”¨é˜»å¡žå¼åœ°ç­‰å¾…å½“å‰ GC è¿è¡Œå®Œæ¯•ã€‚ è¢«åŠ¨è§¦å‘ï¼Œåˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼š ä½¿ç”¨ç³»ç»Ÿç›‘æŽ§ï¼Œå½“è¶…è¿‡ä¸¤åˆ†é’Ÿæ²¡æœ‰äº§ç”Ÿä»»ä½• GC æ—¶ï¼Œå¼ºåˆ¶è§¦å‘ GCã€‚ ä½¿ç”¨æ­¥è°ƒï¼ˆPacingï¼‰ç®—æ³•ï¼Œå…¶æ ¸å¿ƒæ€æƒ³æ˜¯æŽ§åˆ¶å†…å­˜å¢žé•¿çš„æ¯”ä¾‹ã€‚ é€šè¿‡ GOGC æˆ–è€… debug.SetGCPercent è¿›è¡ŒæŽ§åˆ¶ï¼ˆä»–ä»¬æŽ§åˆ¶çš„æ˜¯åŒä¸€ä¸ªå˜é‡ï¼Œå³å †çš„å¢žé•¿çŽ‡ $\rho$ï¼‰ã€‚æ•´ä¸ªç®—æ³•çš„è®¾è®¡è€ƒè™‘çš„æ˜¯ä¼˜åŒ–é—®é¢˜ï¼šå¦‚æžœè®¾ä¸Šä¸€æ¬¡ GC å®Œæˆæ—¶ï¼Œå†…å­˜çš„æ•°é‡ä¸º $H_m$ï¼ˆheap markedï¼‰ï¼Œä¼°è®¡éœ€è¦è§¦å‘ GC æ—¶çš„å †å¤§å° $H_T$ï¼ˆheap triggerï¼‰ï¼Œä½¿å¾—å®Œæˆ GC æ—¶å€™çš„ç›®æ ‡å †å¤§å° $H_g$ï¼ˆheap goalï¼‰ ä¸Žå®žé™…å®Œæˆæ—¶å€™çš„å †å¤§å° $H_a$ï¼ˆheap actualï¼‰æœ€ä¸ºæŽ¥è¿‘ï¼Œå³ï¼š $\min |H_g - H_a| = \min|(1+\rho)H_m - H_a|$ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæ­¥è°ƒç®—æ³•è¿˜éœ€è¦è€ƒè™‘ CPU åˆ©ç”¨çŽ‡çš„é—®é¢˜ï¼Œæ˜¾ç„¶æˆ‘ä»¬ä¸åº”è¯¥è®©åžƒåœ¾å›žæ”¶å™¨å ç”¨è¿‡å¤šçš„ CPUï¼Œå³ä¸åº”è¯¥è®©æ¯ä¸ªè´Ÿè´£æ‰§è¡Œç”¨æˆ· goroutine çš„çº¿ç¨‹éƒ½åœ¨æ‰§è¡Œæ ‡è®°è¿‡ç¨‹ã€‚ç†æƒ³æƒ…å†µä¸‹ï¼Œåœ¨ç”¨æˆ·ä»£ç æ»¡è½½çš„æ—¶å€™ï¼ŒGC çš„ CPU ä½¿ç”¨çŽ‡ä¸åº”è¯¥è¶…è¿‡ 25%ï¼Œå³å¦ä¸€ä¸ªä¼˜åŒ–é—®é¢˜ï¼šå¦‚æžœè®¾ $u_g$ä¸ºç›®æ ‡ CPU ä½¿ç”¨çŽ‡ï¼ˆgoal utilizationï¼‰ï¼Œè€Œ $u_a$ä¸ºå®žé™… CPU ä½¿ç”¨çŽ‡ï¼ˆactual utilizationï¼‰ï¼Œåˆ™ $\min|u_g - u_a|$ã€‚ æ±‚è§£è¿™ä¸¤ä¸ªä¼˜åŒ–é—®é¢˜çš„å…·ä½“æ•°å­¦å»ºæ¨¡è¿‡ç¨‹æˆ‘ä»¬ä¸åœ¨æ­¤åšæ·±å…¥è®¨è®ºï¼Œæœ‰å…´è¶£çš„è¯»è€…å¯ä»¥å‚è€ƒä¸¤ä¸ªè®¾è®¡æ–‡æ¡£ï¼šGo 1.5 concurrent garbage collector pacing å’Œ Separate soft and hard heap size goalã€‚ è®¡ç®— $H_T$ çš„æœ€ç»ˆç»“è®ºï¼ˆä»Ž Go 1.10 æ—¶å¼€å§‹ $h_t$ å¢žåŠ äº†ä¸Šç•Œ $0.95 \rho$ï¼Œä»Ž Go 1.14 å¼€å§‹æ—¶ $h_t$ å¢žåŠ äº†ä¸‹ç•Œ 0.6ï¼‰æ˜¯ï¼š è®¾ç¬¬ n æ¬¡è§¦å‘ GC æ—¶ (n &gt; 1)ï¼Œä¼°è®¡å¾—åˆ°çš„å †å¢žé•¿çŽ‡ä¸º $h_t^{(n)}$ã€è¿è¡Œè¿‡ç¨‹ä¸­çš„å®žé™…å †å¢žé•¿çŽ‡ä¸º $h_a^{(n)}$ï¼Œç”¨æˆ·è®¾ç½®çš„å¢žé•¿çŽ‡ä¸º $\rho = \text{GOGC}/100$ï¼ˆ $\rho &gt; 0$ï¼‰åˆ™ç¬¬ $n+1$ æ¬¡å‡ºè§¦å‘ GC æ—¶å€™ï¼Œä¼°è®¡çš„å †å¢žé•¿çŽ‡ä¸ºï¼š $$h_t^{(n+1)} = h_t^{(n)} + 0.5 \left[ \frac{H_g^{(n)} - H_a^{(n)}}{H_a^{(n)}} - h_t^{(n)} - \frac{u_a^{(n)}}{u_g^{(n)}} \left( h_a^{(n)} - h_t^{(n)} \right) \right]$$ ç‰¹åˆ«çš„ï¼Œ$h_t^{(1)} = 7 / 8$ï¼Œ$u_a^{(1)} = 0.25$ï¼Œ$u_g^{(1)} = 0.3$ã€‚ç¬¬ä¸€æ¬¡è§¦å‘ GC æ—¶ï¼Œå¦‚æžœå½“å‰çš„å †å°äºŽ $4\rho$ MBï¼Œåˆ™å¼ºåˆ¶è°ƒæ•´åˆ° $4\rho$ MB æ—¶è§¦å‘ GC ç‰¹åˆ«çš„ï¼Œå½“ $h_t^{(n)}&lt;0.6$æ—¶ï¼Œå°†å…¶è°ƒæ•´ä¸º $0.6$ï¼Œå½“ $h_t^{(n)} &gt; 0.95 \rho$ æ—¶ï¼Œå°†å…¶è®¾ç½®ä¸º $0.95 \rho$ é»˜è®¤æƒ…å†µä¸‹ï¼Œ$\rho = 1$ï¼ˆå³ GOGC = 100ï¼‰ï¼Œç¬¬ä¸€æ¬¡è§¦å‘ GC æ—¶å¼ºåˆ¶è®¾ç½®è§¦å‘ç¬¬ä¸€æ¬¡ GC ä¸º 4MBï¼Œå¯ä»¥å†™å¦‚ä¸‹ç¨‹åºè¿›è¡ŒéªŒè¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041package mainimport ( "os" "runtime" "runtime/trace" "sync/atomic")var stop uint64// é€šè¿‡å¯¹è±¡ P çš„é‡Šæ”¾çŠ¶æ€ï¼Œæ¥ç¡®å®š GC æ˜¯å¦å·²ç»å®Œæˆfunc gcfinished() *int &#123; p := 1 runtime.SetFinalizer(&amp;p, func(_ *int) &#123; println("gc finished") atomic.StoreUint64(&amp;stop, 1) // é€šçŸ¥åœæ­¢åˆ†é… &#125;) return &amp;p&#125;func allocate() &#123; // æ¯æ¬¡è°ƒç”¨åˆ†é… 0.25MB _ = make([]byte, int((1&lt;&lt;20)*0.25))&#125;func main() &#123; f, _ := os.Create("trace.out") defer f.Close() trace.Start(f) defer trace.Stop() gcfinished() // å½“å®Œæˆ GC æ—¶åœæ­¢åˆ†é… for n := 1; atomic.LoadUint64(&amp;stop) != 1; n++ &#123; println("#allocate: ", n) allocate() &#125; println("terminate")&#125; æˆ‘ä»¬å…ˆæ¥éªŒè¯æœ€ç®€å•çš„ä¸€ç§æƒ…å†µï¼Œå³ç¬¬ä¸€æ¬¡è§¦å‘ GC æ—¶çš„å †å¤§å°ï¼š 12345678910$ go build -o main$ GODEBUG=gctrace=1 ./main#allocate: 1(...)#allocate: 20gc finishedgc 1 @0.001s 3%: 0.016+0.23+0.019 ms clock, 0.20+0.11/0.060/0.13+0.22 ms cpu, 4-&gt;5-&gt;1 MB, 5 MB goal, 12 Pscvg: 8 KB releasedscvg: inuse: 1, idle: 62, sys: 63, released: 58, consumed: 5 (MB)terminate é€šè¿‡è¿™ä¸€è¡Œæ•°æ®æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼š 1gc 1 @0.001s 3%: 0.016+0.23+0.019 ms clock, 0.20+0.11/0.060/0.13+0.22 ms cpu, 4-&gt;5-&gt;1 MB, 5 MB goal, 12 P ç¨‹åºåœ¨å®Œæˆç¬¬ä¸€æ¬¡ GC åŽä¾¿ç»ˆæ­¢äº†ç¨‹åºï¼Œç¬¦åˆæˆ‘ä»¬çš„è®¾æƒ³ ç¬¬ä¸€æ¬¡ GC å¼€å§‹æ—¶çš„å †å¤§å°ä¸º 4MBï¼Œç¬¦åˆæˆ‘ä»¬çš„è®¾æƒ³ å½“æ ‡è®°ç»ˆæ­¢æ—¶ï¼Œå †å¤§å°ä¸º 5MBï¼Œæ­¤åŽå¼€å§‹æ‰§è¡Œæ¸…æ‰«ï¼Œè¿™æ—¶åˆ†é…æ‰§è¡Œåˆ°ç¬¬ 20 æ¬¡ï¼Œå³ 20*0.25 = 5MBï¼Œç¬¦åˆæˆ‘ä»¬çš„è®¾æƒ³ æˆ‘ä»¬å°†åˆ†é…æ¬¡æ•°è°ƒæ•´åˆ° 50 æ¬¡ 1234for n := 1; n &lt; 50; n++ &#123; println("#allocate: ", n) allocate()&#125; æ¥éªŒè¯ç¬¬äºŒæ¬¡ GC è§¦å‘æ—¶æ˜¯å¦æ»¡è¶³å…¬å¼æ‰€è®¡ç®—å¾—åˆ°çš„å€¼ï¼ˆä¸º GODEBUG è¿›ä¸€æ­¥è®¾ç½® gcpacertrace=1ï¼‰ï¼š 1234567891011121314$ go build -o main$ GODEBUG=gctrace=1,gcpacertrace=1 ./main#allocate: 1(...)pacer: H_m_prev=2236962 h_t=+8.750000e-001 H_T=4194304 h_a=+2.387451e+000 H_a=7577600 h_g=+1.442627e+000 H_g=5464064 u_a=+2.652227e-001 u_g=+3.000000e-001 W_a=152832 goalÎ”=+5.676271e-001 actualÎ”=+1.512451e+000 u_a/u_g=+8.840755e-001#allocate: 28gc 1 @0.001s 5%: 0.032+0.32+0.055 ms clock, 0.38+0.068/0.053/0.11+0.67 ms cpu, 4-&gt;7-&gt;3 MB, 5 MB goal, 12 P(...)#allocate: 37pacer: H_m_prev=3307736 h_t=+6.000000e-001 H_T=5292377 h_a=+7.949171e-001 H_a=5937112 h_g=+1.000000e+000 H_g=6615472 u_a=+2.658428e-001 u_g=+3.000000e-001 W_a=154240 goalÎ”=+4.000000e-001 actualÎ”=+1.949171e-001 u_a/u_g=+8.861428e-001#allocate: 38gc 2 @0.002s 9%: 0.017+0.26+0.16 ms clock, 0.20+0.079/0.058/0.12+1.9 ms cpu, 5-&gt;5-&gt;0 MB, 6 MB goal, 12 P æˆ‘ä»¬å¯ä»¥å¾—åˆ°æ•°æ®ï¼š ç¬¬ä¸€æ¬¡ä¼°è®¡å¾—åˆ°çš„å †å¢žé•¿çŽ‡ä¸º $h_t^{(1)} = 0.875$ ç¬¬ä¸€æ¬¡çš„è¿è¡Œè¿‡ç¨‹ä¸­çš„å®žé™…å †å¢žé•¿çŽ‡ä¸º $h_a^{(1)} = 0.2387451$ ç¬¬ä¸€æ¬¡å®žé™…çš„å †å¤§å°ä¸º $H_a^{(1)}=7577600$ ç¬¬ä¸€æ¬¡ç›®æ ‡çš„å †å¤§å°ä¸º $H_g^{(1)}=5464064$ ç¬¬ä¸€æ¬¡çš„ CPU å®žé™…ä½¿ç”¨çŽ‡ä¸º $u_a^{(1)} = 0.2652227$ ç¬¬ä¸€æ¬¡çš„ CPU ç›®æ ‡ä½¿ç”¨çŽ‡ä¸º $u_g^{(1)} = 0.3$ æˆ‘ä»¬æ®æ­¤è®¡ç®—ç¬¬äºŒæ¬¡ä¼°è®¡çš„å †å¢žé•¿çŽ‡ï¼š $$\begin{align}h_t^{(2)} &amp;= h_t^{(1)} + 0.5 \left[ \frac{H_g^{(1)} - H_a^{(1)}}{H_a^{(1)}} - h_t^{(1)} - \frac{u_a^{(1)}}{u_g^{(1)}} \left( h_a^{(1)} - h_t^{(1)} \right) \right] \&amp;= 0.875 + 0.5 \left[ \frac{5464064 - 7577600}{5464064} - 0.875 - \frac{0.2652227}{0.3} \left( 0.2387451 - 0.875 \right) \right] \&amp; \approx 0.52534543909 \\end{align}$$ å› ä¸º $0.52534543909 &lt; 0.6\rho = 0.6$ï¼Œå› æ­¤ä¸‹ä¸€æ¬¡çš„è§¦å‘çŽ‡ä¸º $h_t^{2} = 0.6$ï¼Œä¸Žæˆ‘ä»¬å®žé™…è§‚å¯Ÿåˆ°çš„ç¬¬äºŒæ¬¡ GC çš„è§¦å‘çŽ‡ 0.6 å»åˆã€‚ 12. å¦‚æžœå†…å­˜åˆ†é…é€Ÿåº¦è¶…è¿‡äº†æ ‡è®°æ¸…é™¤çš„é€Ÿåº¦æ€Žä¹ˆåŠžï¼Ÿç›®å‰çš„ Go å®žçŽ°ä¸­ï¼Œå½“ GC è§¦å‘åŽï¼Œä¼šé¦–å…ˆè¿›å…¥å¹¶å‘æ ‡è®°çš„é˜¶æ®µã€‚å¹¶å‘æ ‡è®°ä¼šè®¾ç½®ä¸€ä¸ªæ ‡å¿—ï¼Œå¹¶åœ¨ mallocgc è°ƒç”¨æ—¶è¿›è¡Œæ£€æŸ¥ã€‚å½“å­˜åœ¨æ–°çš„å†…å­˜åˆ†é…æ—¶ï¼Œä¼šæš‚åœåˆ†é…å†…å­˜è¿‡å¿«çš„é‚£äº› goroutineï¼Œå¹¶å°†å…¶è½¬åŽ»æ‰§è¡Œä¸€äº›è¾…åŠ©æ ‡è®°ï¼ˆMark Assistï¼‰çš„å·¥ä½œï¼Œä»Žè€Œè¾¾åˆ°æ”¾ç¼“ç»§ç»­åˆ†é…ã€è¾…åŠ© GC çš„æ ‡è®°å·¥ä½œçš„ç›®çš„ã€‚ ç¼–è¯‘å™¨ä¼šåˆ†æžç”¨æˆ·ä»£ç ï¼Œå¹¶åœ¨éœ€è¦åˆ†é…å†…å­˜çš„ä½ç½®ï¼Œå°†ç”³è¯·å†…å­˜çš„æ“ä½œç¿»è¯‘ä¸º mallocgc è°ƒç”¨ï¼Œè€Œ mallocgc çš„å®žçŽ°å†³å®šäº†æ ‡è®°è¾…åŠ©çš„å®žçŽ°ï¼Œå…¶ä¼ªä»£ç æ€è·¯å¦‚ä¸‹ï¼š 12345678func mallocgc(t typ.Type, size uint64) &#123; if enableMarkAssist &#123; // è¿›è¡Œæ ‡è®°è¾…åŠ©ï¼Œæ­¤æ—¶ç”¨æˆ·ä»£ç æ²¡æœ‰å¾—åˆ°æ‰§è¡Œ (...) &#125; // æ‰§è¡Œå†…å­˜åˆ†é… (...)&#125; GC çš„ä¼˜åŒ–é—®é¢˜13. GC å…³æ³¨çš„æŒ‡æ ‡æœ‰å“ªäº›ï¼ŸGo çš„ GC è¢«è®¾è®¡ä¸ºæˆæ¯”ä¾‹è§¦å‘ã€å¤§éƒ¨åˆ†å·¥ä½œä¸Žèµ‹å€¼å™¨å¹¶å‘ã€ä¸åˆ†ä»£ã€æ— å†…å­˜ç§»åŠ¨ä¸”ä¼šä¸»åŠ¨å‘æ“ä½œç³»ç»Ÿå½’è¿˜ç”³è¯·çš„å†…å­˜ã€‚å› æ­¤æœ€ä¸»è¦å…³æ³¨çš„ã€èƒ½å¤Ÿå½±å“èµ‹å€¼å™¨çš„æ€§èƒ½æŒ‡æ ‡æœ‰ï¼š CPU åˆ©ç”¨çŽ‡ï¼šå›žæ”¶ç®—æ³•ä¼šåœ¨å¤šå¤§ç¨‹åº¦ä¸Šæ‹–æ…¢ç¨‹åºï¼Ÿæœ‰æ—¶å€™ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡å›žæ”¶å ç”¨çš„ CPU æ—¶é—´ä¸Žå…¶å®ƒ CPU æ—¶é—´çš„ç™¾åˆ†æ¯”æ¥æè¿°çš„ã€‚ GC åœé¡¿æ—¶é—´ï¼šå›žæ”¶å™¨ä¼šé€ æˆå¤šé•¿æ—¶é—´çš„åœé¡¿ï¼Ÿç›®å‰çš„ GC ä¸­éœ€è¦è€ƒè™‘ STW å’Œ Mark Assist ä¸¤ä¸ªéƒ¨åˆ†å¯èƒ½é€ æˆçš„åœé¡¿ã€‚ GC åœé¡¿é¢‘çŽ‡ï¼šå›žæ”¶å™¨é€ æˆçš„åœé¡¿é¢‘çŽ‡æ˜¯æ€Žæ ·çš„ï¼Ÿç›®å‰çš„ GC ä¸­éœ€è¦è€ƒè™‘ STW å’Œ Mark Assist ä¸¤ä¸ªéƒ¨åˆ†å¯èƒ½é€ æˆçš„åœé¡¿ã€‚ GC å¯æ‰©å±•æ€§ï¼šå½“å †å†…å­˜å˜å¤§æ—¶ï¼Œåžƒåœ¾å›žæ”¶å™¨çš„æ€§èƒ½å¦‚ä½•ï¼Ÿä½†å¤§éƒ¨åˆ†çš„ç¨‹åºå¯èƒ½å¹¶ä¸ä¸€å®šå…³å¿ƒè¿™ä¸ªé—®é¢˜ã€‚ 14. Go çš„ GC å¦‚ä½•è°ƒä¼˜ï¼ŸGo çš„ GC è¢«è®¾è®¡ä¸ºæžè‡´ç®€æ´ï¼Œä¸Žè¾ƒä¸ºæˆç†Ÿçš„ Java GC çš„æ•°åä¸ªå¯æŽ§å‚æ•°ç›¸æ¯”ï¼Œä¸¥æ ¼æ„ä¹‰ä¸Šæ¥è®²ï¼ŒGo å¯ä¾›ç”¨æˆ·è°ƒæ•´çš„å‚æ•°åªæœ‰ GOGC çŽ¯å¢ƒå˜é‡ã€‚å½“æˆ‘ä»¬è°ˆè®º GC è°ƒä¼˜æ—¶ï¼Œé€šå¸¸æ˜¯æŒ‡å‡å°‘ç”¨æˆ·ä»£ç å¯¹ GC äº§ç”Ÿçš„åŽ‹åŠ›ï¼Œè¿™ä¸€æ–¹é¢åŒ…å«äº†å‡å°‘ç”¨æˆ·ä»£ç åˆ†é…å†…å­˜çš„æ•°é‡ï¼ˆå³å¯¹ç¨‹åºçš„ä»£ç è¡Œä¸ºè¿›è¡Œè°ƒä¼˜ï¼‰ï¼Œå¦ä¸€æ–¹é¢åŒ…å«äº†æœ€å°åŒ– Go çš„ GC å¯¹ CPU çš„ä½¿ç”¨çŽ‡ï¼ˆå³è°ƒæ•´ GOGCï¼‰ã€‚ GC çš„è°ƒä¼˜æ˜¯åœ¨ç‰¹å®šåœºæ™¯ä¸‹äº§ç”Ÿçš„ï¼Œå¹¶éžæ‰€æœ‰ç¨‹åºéƒ½éœ€è¦é’ˆå¯¹ GC è¿›è¡Œè°ƒä¼˜ã€‚åªæœ‰é‚£äº›å¯¹æ‰§è¡Œå»¶è¿Ÿéžå¸¸æ•æ„Ÿã€å½“ GC çš„å¼€é”€æˆä¸ºç¨‹åºæ€§èƒ½ç“¶é¢ˆçš„ç¨‹åºï¼Œæ‰éœ€è¦é’ˆå¯¹ GC è¿›è¡Œæ€§èƒ½è°ƒä¼˜ï¼Œå‡ ä¹Žä¸å­˜åœ¨äºŽå®žé™…å¼€å‘ä¸­ 99% çš„æƒ…å†µã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒGo çš„ GC ä¹Ÿä»ç„¶æœ‰ä¸€å®šçš„å¯æ”¹è¿›çš„ç©ºé—´ï¼Œä¹Ÿæœ‰éƒ¨åˆ† GC é€ æˆçš„é—®é¢˜ï¼Œç›®å‰ä»å±žäºŽ Open Problemã€‚ æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨çŽ°åœ¨çš„å¼€å‘ä¸­å¤„ç†çš„æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼š å¯¹åœé¡¿æ•æ„Ÿï¼šGC è¿‡ç¨‹ä¸­äº§ç”Ÿçš„é•¿æ—¶é—´åœé¡¿ã€æˆ–ç”±äºŽéœ€è¦æ‰§è¡Œ GC è€Œæ²¡æœ‰æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå¯¼è‡´éœ€è¦ç«‹å³æ‰§è¡Œçš„ç”¨æˆ·ä»£ç æ‰§è¡Œæ»žåŽã€‚ å¯¹èµ„æºæ¶ˆè€—æ•æ„Ÿï¼šå¯¹äºŽé¢‘ç¹åˆ†é…å†…å­˜çš„åº”ç”¨è€Œè¨€ï¼Œé¢‘ç¹åˆ†é…å†…å­˜å¢žåŠ  GC çš„å·¥ä½œé‡ï¼ŒåŽŸæœ¬å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„åº”ç”¨ä¸å¾—ä¸é¢‘ç¹åœ°æ‰§è¡Œåžƒåœ¾å›žæ”¶ï¼Œå½±å“ç”¨æˆ·ä»£ç å¯¹ CPU çš„åˆ©ç”¨çŽ‡ï¼Œè¿›è€Œå½±å“ç”¨æˆ·ä»£ç çš„æ‰§è¡Œæ•ˆçŽ‡ã€‚ ä»Žè¿™ä¸¤ç‚¹æ¥çœ‹ï¼Œæ‰€è°“ GC è°ƒä¼˜çš„æ ¸å¿ƒæ€æƒ³ä¹Ÿå°±æ˜¯å……åˆ†çš„å›´ç»•ä¸Šé¢çš„ä¸¤ç‚¹æ¥å±•å¼€ï¼šä¼˜åŒ–å†…å­˜çš„ç”³è¯·é€Ÿåº¦ï¼Œå°½å¯èƒ½çš„å°‘ç”³è¯·å†…å­˜ï¼Œå¤ç”¨å·²ç”³è¯·çš„å†…å­˜ã€‚æˆ–è€…ç®€å•æ¥è¯´ï¼Œä¸å¤–ä¹Žè¿™ä¸‰ä¸ªå…³é”®å­—ï¼šæŽ§åˆ¶ã€å‡å°‘ã€å¤ç”¨ã€‚ æˆ‘ä»¬å°†é€šè¿‡ä¸‰ä¸ªå®žé™…ä¾‹å­ä»‹ç»å¦‚ä½•å®šä½ GC çš„å­˜åœ¨çš„é—®é¢˜ï¼Œå¹¶ä¸€æ­¥ä¸€æ­¥è¿›è¡Œæ€§èƒ½è°ƒä¼˜ã€‚å½“ç„¶ï¼Œåœ¨å®žé™…æƒ…å†µä¸­é—®é¢˜è¿œæ¯”è¿™äº›ä¾‹å­è¦å¤æ‚ï¼Œè¿™é‡Œä¹Ÿåªæ˜¯è®¨è®ºè°ƒä¼˜çš„æ ¸å¿ƒæ€æƒ³ï¼Œæ›´å¤šçš„æ—¶å€™ä¹Ÿåªèƒ½å…·ä½“é—®é¢˜å…·ä½“åˆ†æžã€‚ ä¾‹1ï¼šåˆç†åŒ–å†…å­˜åˆ†é…çš„é€Ÿåº¦ã€æé«˜èµ‹å€¼å™¨çš„ CPU åˆ©ç”¨çŽ‡æˆ‘ä»¬æ¥çœ‹è¿™æ ·ä¸€ä¸ªä¾‹å­ã€‚åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œconcat å‡½æ•°è´Ÿè´£æ‹¼æŽ¥ä¸€äº›é•¿åº¦ä¸ç¡®å®šçš„å­—ç¬¦ä¸²ã€‚å¹¶ä¸”ä¸ºäº†å¿«é€Ÿå®Œæˆä»»åŠ¡ï¼Œå‡ºäºŽæŸç§åŽŸå› ï¼Œåœ¨ä¸¤ä¸ªåµŒå¥—çš„ for å¾ªçŽ¯ä¸­ä¸€å£æ°”åˆ›å»ºäº† 800 ä¸ª goroutineã€‚åœ¨ main å‡½æ•°ä¸­ï¼Œå¯åŠ¨äº†ä¸€ä¸ª goroutine å¹¶åœ¨ç¨‹åºç»“æŸå‰ä¸æ–­çš„è§¦å‘ GCï¼Œå¹¶å°è¯•è¾“å‡º GC çš„å¹³å‡æ‰§è¡Œæ—¶é—´ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950package mainimport ( "fmt" "os" "runtime" "runtime/trace" "sync/atomic" "time")var ( stop int32 count int64 sum time.Duration)func concat() &#123; for n := 0; n &lt; 100; n++ &#123; for i := 0; i &lt; 8; i++ &#123; go func() &#123; s := "Go GC" s += " " + "Hello" s += " " + "World" _ = s &#125;() &#125; &#125;&#125;func main() &#123; f, _ := os.Create("trace.out") defer f.Close() trace.Start(f) defer trace.Stop() go func() &#123; var t time.Time for atomic.LoadInt32(&amp;stop) == 0 &#123; t = time.Now() runtime.GC() sum += time.Since(t) count++ &#125; fmt.Printf("GC spend avg: %v\n", time.Duration(int64(sum)/count)) &#125;() concat() atomic.StoreInt32(&amp;stop, 1)&#125; è¿™ä¸ªç¨‹åºçš„æ‰§è¡Œç»“æžœæ˜¯ï¼š 123$ go build -o main$ ./mainGC spend avg: 2.583421ms GC å¹³å‡æ‰§è¡Œä¸€æ¬¡éœ€è¦é•¿è¾¾ 2ms çš„æ—¶é—´ï¼Œæˆ‘ä»¬å†è¿›ä¸€æ­¥è§‚å¯Ÿ trace çš„ç»“æžœï¼š ç¨‹åºçš„æ•´ä¸ªæ‰§è¡Œè¿‡ç¨‹ä¸­ä»…æ‰§è¡Œäº†ä¸€æ¬¡ GCï¼Œè€Œä¸”ä»… Sweep STW å°±è€—è´¹äº†è¶…è¿‡ 1 msï¼Œéžå¸¸åå¸¸ã€‚ç”šè‡³æŸ¥çœ‹èµ‹å€¼å™¨ mutator çš„ CPU åˆ©ç”¨çŽ‡ï¼Œåœ¨æ•´ä¸ª trace å°ºåº¦ä¸‹è¿ž 40% éƒ½ä¸åˆ°ï¼š ä¸»è¦åŽŸå› æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬ä¸å¦¨æŸ¥çœ‹ goroutine çš„åˆ†æžï¼š åœ¨è¿™ä¸ªæ¦œå•ä¸­æˆ‘ä»¬ä¸éš¾å‘çŽ°ï¼Œgoroutine çš„æ‰§è¡Œæ—¶é—´å å…¶ç”Ÿå‘½å‘¨æœŸæ€»æ—¶é—´éžå¸¸çŸ­çš„ä¸€éƒ¨åˆ†ï¼Œä½†å¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±è´¹åœ¨è°ƒåº¦å™¨çš„ç­‰å¾…ä¸Šäº†ï¼ˆè“è‰²çš„éƒ¨åˆ†ï¼‰ï¼Œè¯´æ˜ŽåŒæ—¶åˆ›å»ºå¤§é‡ goroutine å¯¹è°ƒåº¦å™¨äº§ç”Ÿçš„åŽ‹åŠ›ç¡®å®žä¸å°ï¼Œæˆ‘ä»¬ä¸å¦¨å°†è¿™ä¸€äº§ç”Ÿé€ŸçŽ‡å‡æ…¢ï¼Œä¸€æ‰¹ä¸€æ‰¹åœ°åˆ›å»º goroutineï¼š 12345678910111213141516func concat() &#123; wg := sync.WaitGroup&#123;&#125; for n := 0; n &lt; 100; n++ &#123; wg.Add(8) for i := 0; i &lt; 8; i++ &#123; go func() &#123; s := "Go GC" s += " " + "Hello" s += " " + "World" _ = s wg.Done() &#125;() &#125; wg.Wait() &#125;&#125; è¿™æ—¶å€™æˆ‘ä»¬å†æ¥çœ‹ï¼š 123$ go build -o main$ ./mainGC spend avg: 328.54Âµs GC çš„å¹³å‡æ—¶é—´å°±é™åˆ° 300 å¾®ç§’äº†ã€‚è¿™æ—¶çš„èµ‹å€¼å™¨ CPU ä½¿ç”¨çŽ‡ä¹Ÿæé«˜åˆ°äº† 60%ï¼Œç›¸å¯¹æ¥è¯´å°±å¾ˆå¯è§‚äº†ï¼š å½“ç„¶ï¼Œè¿™ä¸ªç¨‹åºä»ç„¶æœ‰ä¼˜åŒ–ç©ºé—´ï¼Œä¾‹å¦‚æˆ‘ä»¬å…¶å®žæ²¡æœ‰å¿…è¦ç­‰å¾…å¾ˆå¤š goroutine åŒæ—¶æ‰§è¡Œå®Œæ¯•æ‰åŽ»æ‰§è¡Œä¸‹ä¸€ç»„ goroutineã€‚è€Œå¯ä»¥å½“ä¸€ä¸ª goroutine æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œç›´æŽ¥å¯åŠ¨ä¸€ä¸ªæ–°çš„ goroutineï¼Œä¹Ÿå°±æ˜¯ goroutine æ± çš„ä½¿ç”¨ã€‚æœ‰å…´è¶£çš„è¯»è€…å¯ä»¥æ²¿ç€è¿™ä¸ªæ€è·¯è¿›ä¸€æ­¥ä¼˜åŒ–è¿™ä¸ªç¨‹åºä¸­èµ‹å€¼å™¨å¯¹ CPU çš„ä½¿ç”¨çŽ‡ã€‚ ä¾‹2ï¼šé™ä½Žå¹¶å¤ç”¨å·²ç»ç”³è¯·çš„å†…å­˜æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªéžå¸¸ç®€å•çš„ Web ç¨‹åºæ¥è¯´æ˜Žå¤ç”¨å†…å­˜çš„é‡è¦æ€§ã€‚åœ¨è¿™ä¸ªç¨‹åºä¸­ï¼Œæ¯å½“äº§ç”Ÿä¸€ä¸ª /example2çš„è¯·æ±‚æ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€æ®µå†…å­˜ï¼Œå¹¶ç”¨äºŽè¿›è¡Œä¸€äº›åŽç»­çš„å·¥ä½œã€‚ 1234567891011121314151617181920212223242526272829package mainimport ( "fmt" "net/http" _ "net/http/pprof")func newBuf() []byte &#123; return make([]byte, 10&lt;&lt;20)&#125;func main() &#123; go func() &#123; http.ListenAndServe("localhost:6060", nil) &#125;() http.HandleFunc("/example2", func(w http.ResponseWriter, r *http.Request) &#123; b := newBuf() // æ¨¡æ‹Ÿæ‰§è¡Œä¸€äº›å·¥ä½œ for idx := range b &#123; b[idx] = 1 &#125; fmt.Fprintf(w, "done, %v", r.URL.Path[1:]) &#125;) http.ListenAndServe(":8080", nil)&#125; ä¸ºäº†è¿›è¡Œæ€§èƒ½åˆ†æžï¼Œæˆ‘ä»¬è¿˜é¢å¤–åˆ›å»ºäº†ä¸€ä¸ªç›‘å¬ 6060 ç«¯å£çš„ goroutineï¼Œç”¨äºŽä½¿ç”¨ pprof è¿›è¡Œåˆ†æžã€‚æˆ‘ä»¬å…ˆè®©æœåŠ¡å™¨è·‘èµ·æ¥ï¼š 12$ go build -o main$ ./main æˆ‘ä»¬è¿™æ¬¡ä½¿ç”¨ pprof çš„ trace æ¥æŸ¥çœ‹ GC åœ¨æ­¤æœåŠ¡å™¨ä¸­é¢å¯¹å¤§é‡è¯·æ±‚æ—¶å€™çš„çŠ¶æ€ï¼Œè¦ä½¿ç”¨ trace å¯ä»¥é€šè¿‡è®¿é—® /debug/pprof/trace è·¯ç”±æ¥è¿›è¡Œï¼Œå…¶ä¸­ seconds å‚æ•°è®¾ç½®ä¸º 20sï¼Œå¹¶å°† trace çš„ç»“æžœä¿å­˜ä¸º trace.out: 1234$ wget http://127.0.0.1:6060/debug/pprof/trace\?seconds\=20 -O trace.out--2020-01-01 22:13:34-- http://127.0.0.1:6060/debug/pprof/trace?seconds=20Connecting to 127.0.0.1:6060... connected.HTTP request sent, awaiting response... è¿™æ—¶å€™æˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåŽ‹æµ‹å·¥å…· abï¼Œæ¥åŒæ—¶äº§ç”Ÿ 500 ä¸ªè¯·æ±‚ï¼ˆ-n ä¸€å…± 500 ä¸ªè¯·æ±‚ï¼Œ-c ä¸€ä¸ªæ—¶åˆ»æ‰§è¡Œè¯·æ±‚çš„æ•°é‡ï¼Œæ¯æ¬¡ 100 ä¸ªå¹¶å‘è¯·æ±‚ï¼‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849$ ab -n 500 -c 100 http://127.0.0.1:8080/example2This is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking 127.0.0.1 (be patient)Completed 100 requestsCompleted 200 requestsCompleted 300 requestsCompleted 400 requestsCompleted 500 requestsFinished 500 requestsServer Software: Server Hostname: 127.0.0.1Server Port: 8080Document Path: /example2Document Length: 14 bytesConcurrency Level: 100Time taken for tests: 0.987 secondsComplete requests: 500Failed requests: 0Total transferred: 65500 bytesHTML transferred: 7000 bytesRequests per second: 506.63 [#/sec] (mean)Time per request: 197.382 [ms] (mean)Time per request: 1.974 [ms] (mean, across all concurrent requests)Transfer rate: 64.81 [Kbytes/sec] receivedConnection Times (ms) min mean[+/-sd] median maxConnect: 0 1 1.1 0 7Processing: 13 179 77.5 170 456Waiting: 10 168 78.8 162 455Total: 14 180 77.3 171 458Percentage of the requests served within a certain time (ms) 50% 171 66% 203 75% 222 80% 239 90% 281 95% 335 98% 365 99% 400 100% 458 (longest request) GC åå¤è¢«è§¦å‘ï¼Œä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„åŽŸå› å°±æ˜¯å†…å­˜åˆ†é…è¿‡å¤šã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ go tool pprof æ¥æŸ¥çœ‹ç©¶ç«Ÿæ˜¯è°åˆ†é…äº†å¤§é‡å†…å­˜ï¼ˆä½¿ç”¨ web æŒ‡ä»¤æ¥ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ç»Ÿè®¡ä¿¡æ¯çš„å¯è§†åŒ–å›¾å½¢ï¼‰ï¼š 123456789$ go tool pprof http://127.0.0.1:6060/debug/pprof/heapFetching profile over HTTP from http://localhost:6060/debug/pprof/heapSaved profile in /Users/changkun/pprof/pprof.alloc_objects.alloc_space.inuse_objects.inuse_space.003.pb.gzType: inuse_spaceTime: Jan 1, 2020 at 11:15pm (CET)Entering interactive mode (type "help" for commands, "o" for options)(pprof) web(pprof) å¯è§ newBuf äº§ç”Ÿçš„ç”³è¯·çš„å†…å­˜è¿‡å¤šï¼ŒçŽ°åœ¨æˆ‘ä»¬ä½¿ç”¨ sync.Pool æ¥å¤ç”¨ newBuf æ‰€äº§ç”Ÿçš„å¯¹è±¡ï¼š 123456789101112131415161718192021222324252627282930package mainimport ( "fmt" "net/http" _ "net/http/pprof" "sync")// ä½¿ç”¨ sync.Pool å¤ç”¨éœ€è¦çš„ bufvar bufPool = sync.Pool&#123; New: func() interface&#123;&#125; &#123; return make([]byte, 10&lt;&lt;20) &#125;,&#125;func main() &#123; go func() &#123; http.ListenAndServe("localhost:6060", nil) &#125;() http.HandleFunc("/example2", func(w http.ResponseWriter, r *http.Request) &#123; b := bufPool.Get().([]byte) for idx := range b &#123; b[idx] = 0 &#125; fmt.Fprintf(w, "done, %v", r.URL.Path[1:]) bufPool.Put(b) &#125;) http.ListenAndServe(":8080", nil)&#125; å…¶ä¸­ ab è¾“å‡ºçš„ç»Ÿè®¡ç»“æžœä¸ºï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849$ ab -n 500 -c 100 http://127.0.0.1:8080/example2This is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking 127.0.0.1 (be patient)Completed 100 requestsCompleted 200 requestsCompleted 300 requestsCompleted 400 requestsCompleted 500 requestsFinished 500 requestsServer Software: Server Hostname: 127.0.0.1Server Port: 8080Document Path: /example2Document Length: 14 bytesConcurrency Level: 100Time taken for tests: 0.427 secondsComplete requests: 500Failed requests: 0Total transferred: 65500 bytesHTML transferred: 7000 bytesRequests per second: 1171.32 [#/sec] (mean)Time per request: 85.374 [ms] (mean)Time per request: 0.854 [ms] (mean, across all concurrent requests)Transfer rate: 149.85 [Kbytes/sec] receivedConnection Times (ms) min mean[+/-sd] median maxConnect: 0 1 1.4 1 9Processing: 5 75 48.2 66 211Waiting: 5 72 46.8 63 207Total: 5 77 48.2 67 211Percentage of the requests served within a certain time (ms) 50% 67 66% 89 75% 107 80% 122 90% 148 95% 167 98% 196 99% 204 100% 211 (longest request) ä½†ä»Ž Requests per second æ¯ç§’è¯·æ±‚æ•°æ¥çœ‹ï¼Œä»ŽåŽŸæ¥çš„ 506.63 å˜ä¸º 1171.32 å¾—åˆ°äº†è¿‘ä¹Žä¸€å€çš„æå‡ã€‚ä»Ž trace çš„ç»“æžœæ¥çœ‹ï¼ŒGC ä¹Ÿæ²¡æœ‰é¢‘ç¹çš„è¢«è§¦å‘ä»Žè€Œé•¿æœŸæ¶ˆè€— CPU ä½¿ç”¨çŽ‡ï¼š sync.Pool æ˜¯å†…å­˜å¤ç”¨çš„ä¸€ä¸ªæœ€ä¸ºæ˜¾è‘—çš„ä¾‹å­ï¼Œä»Žè¯­è¨€å±‚é¢ä¸Šè¿˜æœ‰å¾ˆå¤šç±»ä¼¼çš„ä¾‹å­ï¼Œä¾‹å¦‚åœ¨ä¾‹ 1 ä¸­ï¼Œconcat å‡½æ•°å¯ä»¥é¢„å…ˆåˆ†é…ä¸€å®šé•¿åº¦çš„ç¼“å­˜ï¼Œè€ŒåŽå†é€šè¿‡ append çš„æ–¹å¼å°†å­—ç¬¦ä¸²å­˜å‚¨åˆ°ç¼“å­˜ä¸­ï¼š 12345678910111213141516171819func concat() &#123; wg := sync.WaitGroup&#123;&#125; for n := 0; n &lt; 100; n++ &#123; wg.Add(8) for i := 0; i &lt; 8; i++ &#123; go func() &#123; s := make([]byte, 0, 20) s = append(s, "Go GC"...) s = append(s, ' ') s = append(s, "Hello"...) s = append(s, ' ') s = append(s, "World"...) _ = string(s) wg.Done() &#125;() &#125; wg.Wait() &#125;&#125; åŽŸå› åœ¨äºŽ + è¿ç®—ç¬¦ä¼šéšç€å­—ç¬¦ä¸²é•¿åº¦çš„å¢žåŠ è€Œç”³è¯·æ›´å¤šçš„å†…å­˜ï¼Œå¹¶å°†å†…å®¹ä»ŽåŽŸæ¥çš„å†…å­˜ä½ç½®æ‹·è´åˆ°æ–°çš„å†…å­˜ä½ç½®ï¼Œé€ æˆå¤§é‡ä¸å¿…è¦çš„å†…å­˜åˆ†é…ï¼Œå…ˆæå‰åˆ†é…å¥½è¶³å¤Ÿçš„å†…å­˜ï¼Œå†æ…¢æ…¢åœ°å¡«å……ï¼Œä¹Ÿæ˜¯ä¸€ç§å‡å°‘å†…å­˜åˆ†é…ã€å¤ç”¨å†…å­˜å½¢å¼çš„ä¸€ç§è¡¨çŽ°ã€‚ ä¾‹3ï¼šè°ƒæ•´ GOGCæˆ‘ä»¬å·²ç»çŸ¥é“äº† GC çš„è§¦å‘åŽŸåˆ™æ˜¯ç”±æ­¥è°ƒç®—æ³•æ¥æŽ§åˆ¶çš„ï¼Œå…¶å…³é”®åœ¨äºŽä¼°è®¡ä¸‹ä¸€æ¬¡éœ€è¦è§¦å‘ GC æ—¶ï¼Œå †çš„å¤§å°ã€‚å¯æƒ³è€ŒçŸ¥ï¼Œå¦‚æžœæˆ‘ä»¬åœ¨é‡åˆ°æµ·é‡è¯·æ±‚çš„æ—¶ï¼Œä¸ºäº†é¿å… GC é¢‘ç¹è§¦å‘ï¼Œæ˜¯å¦å¯ä»¥é€šè¿‡å°† GOGC çš„å€¼è®¾ç½®å¾—æ›´å¤§ï¼Œè®© GC è§¦å‘çš„æ—¶é—´å˜å¾—æ›´æ™šï¼Œä»Žè€Œå‡å°‘å…¶è§¦å‘é¢‘çŽ‡ï¼Œè¿›è€Œå¢žåŠ ç”¨æˆ·ä»£ç å¯¹æœºå™¨çš„ä½¿ç”¨çŽ‡å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ã€‚ æˆ‘ä»¬å¯ä»¥éžå¸¸ç®€å•ç²—æš´çš„å°† GOGC è°ƒæ•´ä¸º 1000ï¼Œæ¥æ‰§è¡Œä¸Šä¸€ä¸ªä¾‹å­ä¸­æœªå¤ç”¨å¯¹è±¡ä¹‹å‰çš„ç¨‹åºï¼š 1$ GOGC=1000 ./main è¿™æ—¶æˆ‘ä»¬å†é‡æ–°æ‰§è¡ŒåŽ‹æµ‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849$ ab -n 500 -c 100 http://127.0.0.1:8080/example2This is ApacheBench, Version 2.3 &lt;$Revision: 1843412 $&gt;Copyright 1996 Adam Twiss, Zeus Technology Ltd, http://www.zeustech.net/Licensed to The Apache Software Foundation, http://www.apache.org/Benchmarking 127.0.0.1 (be patient)Completed 100 requestsCompleted 200 requestsCompleted 300 requestsCompleted 400 requestsCompleted 500 requestsFinished 500 requestsServer Software: Server Hostname: 127.0.0.1Server Port: 8080Document Path: /example2Document Length: 14 bytesConcurrency Level: 100Time taken for tests: 0.923 secondsComplete requests: 500Failed requests: 0Total transferred: 65500 bytesHTML transferred: 7000 bytesRequests per second: 541.61 [#/sec] (mean)Time per request: 184.636 [ms] (mean)Time per request: 1.846 [ms] (mean, across all concurrent requests)Transfer rate: 69.29 [Kbytes/sec] receivedConnection Times (ms) min mean[+/-sd] median maxConnect: 0 1 1.8 0 20Processing: 9 171 210.4 66 859Waiting: 5 158 199.6 62 813Total: 9 173 210.6 68 860Percentage of the requests served within a certain time (ms) 50% 68 66% 133 75% 198 80% 292 90% 566 95% 696 98% 723 99% 743 100% 860 (longest request) å¯ä»¥çœ‹åˆ°ï¼ŒåŽ‹æµ‹çš„ç»“æžœå¾—åˆ°äº†ä¸€å®šå¹…åº¦çš„æ”¹å–„ï¼ˆRequests per second ä»ŽåŽŸæ¥çš„ 506.63 æé«˜ä¸ºäº† 541.61ï¼‰ï¼Œå¹¶ä¸” GC çš„æ‰§è¡Œé¢‘çŽ‡æ˜Žæ˜¾é™ä½Žï¼š åœ¨å®žé™…å®žè·µä¸­å¯è¡¨çŽ°ä¸ºéœ€è¦ç´§æ€¥å¤„ç†ä¸€äº›ç”± GC å¸¦æ¥çš„ç“¶é¢ˆæ—¶ï¼Œäººä¸ºå°† GOGC è°ƒå¤§ï¼ŒåŠ é’±åŠ å†…å­˜ï¼Œæ‰›è¿‡è¿™ä¸€æ®µå³°å€¼æµé‡æ—¶æœŸã€‚ å½“ç„¶ï¼Œè¿™ç§åšæ³•å…¶å®žæ˜¯æ²»æ ‡ä¸æ²»æœ¬ï¼Œå¹¶æ²¡æœ‰ä»Žæ ¹æœ¬ä¸Šè§£å†³å†…å­˜åˆ†é…è¿‡äºŽé¢‘ç¹çš„é—®é¢˜ï¼Œæžç«¯æƒ…å†µä¸‹ï¼Œåè€Œä¼šç”±äºŽ GOGC å¤ªå¤§è€Œå¯¼è‡´å›žæ”¶ä¸åŠæ—¶è€Œè€—è´¹æ›´å¤šçš„æ—¶é—´æ¥æ¸…ç†äº§ç”Ÿçš„åžƒåœ¾ï¼Œè¿™å¯¹æ—¶é—´ä¸ç®—æ•æ„Ÿçš„åº”ç”¨è¿˜å¥½ï¼Œä½†å¯¹å®žæ—¶æ€§è¦æ±‚è¾ƒé«˜çš„ç¨‹åºæ¥è¯´å°±æ˜¯è‡´å‘½çš„æ‰“å‡»äº†ã€‚ å› æ­¤è¿™æ—¶æ›´å¦¥å½“çš„åšæ³•ä»ç„¶æ˜¯ï¼Œå®šä½é—®é¢˜çš„æ‰€åœ¨ï¼Œå¹¶ä»Žä»£ç å±‚é¢ä¸Šè¿›è¡Œä¼˜åŒ–ã€‚ å°ç»“é€šè¿‡ä¸Šé¢çš„ä¸‰ä¸ªä¾‹å­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°åœ¨ GC è°ƒä¼˜è¿‡ç¨‹ä¸­ go tool pprof å’Œ go tool trace çš„å¼ºå¤§ä½œç”¨æ˜¯å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½ GC å¯¼è‡´ç“¶é¢ˆçš„å…·ä½“ä½ç½®ï¼Œä½†è¿™äº›ä¾‹å­ä¸­ä»…ä»…è¦†ç›–äº†å…¶åŠŸèƒ½çš„å¾ˆå°ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¹Ÿæ²¡æœ‰å¿…è¦å®Œæ•´è¦†ç›–æ‰€æœ‰çš„åŠŸèƒ½ï¼Œå› ä¸ºæ€»æ˜¯å¯ä»¥é€šè¿‡http pprof å®˜æ–¹æ–‡æ¡£ã€runtime pprofå®˜æ–¹æ–‡æ¡£ä»¥åŠtrace å®˜æ–¹æ–‡æ¡£æ¥ä¸¾ä¸€åä¸‰ã€‚ çŽ°åœ¨æˆ‘ä»¬æ¥æ€»ç»“ä¸€ä¸‹å‰é¢ä¸‰ä¸ªä¾‹å­ä¸­çš„ä¼˜åŒ–æƒ…å†µï¼š æŽ§åˆ¶å†…å­˜åˆ†é…çš„é€Ÿåº¦ï¼Œé™åˆ¶ goroutine çš„æ•°é‡ï¼Œä»Žè€Œæé«˜èµ‹å€¼å™¨å¯¹ CPU çš„åˆ©ç”¨çŽ‡ã€‚ å‡å°‘å¹¶å¤ç”¨å†…å­˜ï¼Œä¾‹å¦‚ä½¿ç”¨ sync.Pool æ¥å¤ç”¨éœ€è¦é¢‘ç¹åˆ›å»ºä¸´æ—¶å¯¹è±¡ï¼Œä¾‹å¦‚æå‰åˆ†é…è¶³å¤Ÿçš„å†…å­˜æ¥é™ä½Žå¤šä½™çš„æ‹·è´ã€‚ éœ€è¦æ—¶ï¼Œå¢žå¤§ GOGC çš„å€¼ï¼Œé™ä½Ž GC çš„è¿è¡Œé¢‘çŽ‡ã€‚ è¿™ä¸‰ç§æƒ…å†µå‡ ä¹Žæ¶µç›–äº† GC è°ƒä¼˜ä¸­çš„æ ¸å¿ƒæ€è·¯ï¼Œè™½ç„¶ä»Žè¯­è¨€ä¸Šè¿˜æœ‰å¾ˆå¤šå°æŠ€å·§å¯è¯´ï¼Œä½†æˆ‘ä»¬å¹¶ä¸ä¼šåœ¨è¿™é‡Œäº‹æ— å·¨ç»†çš„è¿›è¡Œæ€»ç»“ã€‚å®žé™…æƒ…å†µä¹Ÿæ˜¯åƒå˜ä¸‡åŒ–ï¼Œæˆ‘ä»¬æ›´åº”è¯¥ç€é‡äºŽåŸ¹å…»å…·ä½“é—®é¢˜å…·ä½“åˆ†æžçš„èƒ½åŠ›ã€‚ å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜åº”è¯¥è°¨è®° è¿‡æ—©ä¼˜åŒ–æ˜¯ä¸‡æ¶ä¹‹æºè¿™ä¸€è­¦è¯­ï¼Œåœ¨æ²¡æœ‰é‡åˆ°åº”ç”¨çš„çœŸæ­£ç“¶é¢ˆæ—¶ï¼Œå°†å®è´µçš„æ—¶é—´åˆ†é…åœ¨å¼€å‘ä¸­å…¶ä»–ä¼˜å…ˆçº§æ›´é«˜çš„ä»»åŠ¡ä¸Šã€‚ 15. Go çš„åžƒåœ¾å›žæ”¶å™¨æœ‰å“ªäº›ç›¸å…³çš„ APIï¼Ÿå…¶ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿåœ¨ Go ä¸­å­˜åœ¨æ•°é‡æžå°‘çš„ä¸Ž GC ç›¸å…³çš„ APIï¼Œå®ƒä»¬æ˜¯ runtime.GCï¼šæ‰‹åŠ¨è§¦å‘ GC runtime.ReadMemStatsï¼šè¯»å–å†…å­˜ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…å«éƒ¨åˆ† GC ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ debug.FreeOSMemoryï¼šæ‰‹åŠ¨å°†å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿ debug.ReadGCStatsï¼šè¯»å–å…³äºŽ GC çš„ç›¸å…³ç»Ÿè®¡ä¿¡æ¯ debug.SetGCPercentï¼šè®¾ç½® GOGC è°ƒæ­¥å˜é‡ debug.SetMaxHeapï¼ˆå°šæœªå‘å¸ƒï¼‰ï¼šè®¾ç½® Go ç¨‹åºå †çš„ä¸Šé™å€¼ GC çš„åŽ†å²åŠæ¼”è¿›16. Go åŽ†å²å„ä¸ªç‰ˆæœ¬åœ¨ GC æ–¹é¢çš„æ”¹è¿›ï¼Ÿ Go 1ï¼šä¸²è¡Œä¸‰è‰²æ ‡è®°æ¸…æ‰« Go 1.3ï¼šå¹¶è¡Œæ¸…æ‰«ï¼Œæ ‡è®°è¿‡ç¨‹éœ€è¦ STWï¼Œåœé¡¿æ—¶é—´åœ¨çº¦å‡ ç™¾æ¯«ç§’ Go 1.5ï¼šå¹¶å‘æ ‡è®°æ¸…æ‰«ï¼Œåœé¡¿æ—¶é—´åœ¨ä¸€ç™¾æ¯«ç§’ä»¥å†… Go 1.6ï¼šä½¿ç”¨ bitmap æ¥è®°å½•å›žæ”¶å†…å­˜çš„ä½ç½®ï¼Œå¤§å¹…ä¼˜åŒ–åžƒåœ¾å›žæ”¶å™¨è‡ªèº«æ¶ˆè€—çš„å†…å­˜ï¼Œåœé¡¿æ—¶é—´åœ¨åæ¯«ç§’ä»¥å†… Go 1.7ï¼šåœé¡¿æ—¶é—´æŽ§åˆ¶åœ¨ä¸¤æ¯«ç§’ä»¥å†… Go 1.8ï¼šæ··åˆå†™å±éšœï¼Œåœé¡¿æ—¶é—´åœ¨åŠä¸ªæ¯«ç§’å·¦å³ Go 1.9ï¼šå½»åº•ç§»é™¤äº†æ ˆçš„é‡æ‰«æè¿‡ç¨‹ Go 1.12ï¼šæ•´åˆäº†ä¸¤ä¸ªé˜¶æ®µçš„ Mark Terminationï¼Œä½†å¼•å…¥äº†ä¸€ä¸ªä¸¥é‡çš„ GC Bug è‡³ä»Šæœªä¿®ï¼ˆè§é—®é¢˜ 20ï¼‰ï¼Œå°šæ— è¯¥ Bug å¯¹ GC æ€§èƒ½å½±å“çš„æŠ¥å‘Š Go 1.13ï¼šç€æ‰‹è§£å†³å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜çš„ï¼Œæå‡ºäº†æ–°çš„ Scavenger Go 1.14ï¼šæ›¿ä»£äº†ä»…å­˜æ´»äº†ä¸€ä¸ªç‰ˆæœ¬çš„ scavengerï¼Œå…¨æ–°çš„é¡µåˆ†é…å™¨ï¼Œä¼˜åŒ–åˆ†é…å†…å­˜è¿‡ç¨‹çš„é€ŸçŽ‡ä¸ŽçŽ°æœ‰çš„æ‰©å±•æ€§é—®é¢˜ï¼Œå¹¶å¼•å…¥äº†å¼‚æ­¥æŠ¢å ï¼Œè§£å†³äº†ç”±äºŽå¯†é›†å¾ªçŽ¯å¯¼è‡´çš„ STW æ—¶é—´è¿‡é•¿çš„é—®é¢˜ å¯ä»¥ç”¨ä¸‹å›¾ç›´è§‚åœ°è¯´æ˜Ž GC çš„æ¼”è¿›åŽ†å²ï¼š åœ¨ Go 1 åˆšå‘å¸ƒæ—¶çš„ç‰ˆæœ¬ä¸­ï¼Œç”šè‡³æ²¡æœ‰å°† Mark-Sweep çš„è¿‡ç¨‹å¹¶è¡ŒåŒ–ï¼Œå½“éœ€è¦è¿›è¡Œåžƒåœ¾å›žæ”¶æ—¶ï¼Œæ‰€æœ‰çš„ä»£ç éƒ½å¿…é¡»è¿›å…¥ STW çš„çŠ¶æ€ã€‚è€Œåˆ°äº† Go 1.1 æ—¶ï¼Œå®˜æ–¹è¿…é€Ÿåœ°å°†æ¸…æ‰«è¿‡ç¨‹è¿›è¡Œäº†å¹¶è¡ŒåŒ–çš„å¤„ç†ï¼Œå³ä»…åœ¨æ ‡è®°é˜¶æ®µè¿›å…¥ STWã€‚ è¿™ä¸€æƒ³æ³•å¾ˆè‡ªç„¶ï¼Œå› ä¸ºå¹¶è¡ŒåŒ–å¯¼è‡´ç®—æ³•ç»“æžœä¸ä¸€è‡´çš„æƒ…å†µä»…ä»…å‘ç”Ÿåœ¨æ ‡è®°é˜¶æ®µï¼Œè€Œå½“æ—¶çš„åžƒåœ¾å›žæ”¶å™¨æ²¡æœ‰é’ˆå¯¹å¹¶è¡Œç»“æžœçš„ä¸€è‡´æ€§è¿›è¡Œä»»ä½•ä¼˜åŒ–ï¼Œå› æ­¤æ‰éœ€è¦åœ¨æ ‡è®°é˜¶æ®µè¿›å…¥ STWã€‚å¯¹äºŽ Scavenger è€Œè¨€ï¼Œæ—©æœŸçš„ç‰ˆæœ¬ä¸­ä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„çº¿ç¨‹æ¥å®šæœŸå°†å¤šä½™çš„å†…å­˜å½’è¿˜ç»™æ“ä½œç³»ç»Ÿã€‚ è€Œåˆ°äº† Go 1.5 åŽï¼ŒGo å›¢é˜ŸèŠ±è´¹äº†ç›¸å½“å¤§çš„åŠ›æ°”ï¼Œé€šè¿‡å¼•å…¥å†™å±éšœçš„æœºåˆ¶æ¥ä¿è¯ç®—æ³•çš„ä¸€è‡´æ€§ï¼Œæ‰å¾—ä»¥å°†æ•´ä¸ª GC æŽ§åˆ¶åœ¨å¾ˆå°çš„ STW å†…ï¼Œè€Œåˆ°äº† 1.8 æ—¶ï¼Œç”±äºŽæ–°çš„æ··åˆå±éšœçš„å‡ºçŽ°ï¼Œæ¶ˆé™¤äº†å¯¹æ ˆæœ¬èº«çš„é‡æ–°æ‰«æï¼ŒSTW çš„æ—¶é—´è¿›ä¸€æ­¥ç¼©å‡ã€‚ ä»Žè¿™ä¸ªæ—¶å€™å¼€å§‹ï¼ŒScavenger å·²ç»ä»Žç‹¬ç«‹çº¿ç¨‹ä¸­ç§»é™¤ï¼Œå¹¶åˆå¹¶è‡³ç³»ç»Ÿç›‘æŽ§è¿™ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ä¸­ï¼Œå¹¶å‘¨æœŸæ€§åœ°å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜ï¼Œä½†ä»ç„¶ä¼šæœ‰å†…å­˜æº¢å‡ºè¿™ç§æ¯”è¾ƒæžç«¯çš„æƒ…å†µå‡ºçŽ°ï¼Œå› ä¸ºç¨‹åºå¯èƒ½åœ¨çŸ­æ—¶é—´å†…åº”å¯¹çªå‘æ€§çš„å†…å­˜ç”³è¯·éœ€æ±‚æ—¶ï¼Œå†…å­˜è¿˜æ²¡æ¥å¾—åŠå½’è¿˜æ“ä½œç³»ç»Ÿï¼Œå¯¼è‡´å †ä¸æ–­å‘æ“ä½œç³»ç»Ÿç”³è¯·å†…å­˜ï¼Œä»Žè€Œå‡ºçŽ°å†…å­˜æº¢å‡ºã€‚ åˆ°äº† Go 1.13ï¼Œå®šæœŸå½’è¿˜æ“ä½œç³»ç»Ÿçš„é—®é¢˜å¾—ä»¥è§£å†³ï¼ŒGo å›¢é˜Ÿå¼€å§‹å°†å‘¨æœŸæ€§çš„ Scavenger è½¬åŒ–ä¸ºå¯è¢«è°ƒåº¦çš„ goroutineï¼Œå¹¶å°†å…¶ä¸Žç”¨æˆ·ä»£ç å¹¶å‘æ‰§è¡Œã€‚è€Œåˆ°äº† Go 1.14ï¼Œè¿™ä¸€å‘æ“ä½œç³»ç»Ÿå½’è¿˜å†…å­˜çš„æ“ä½œæ—¶é—´è¿›ä¸€æ­¥å¾—åˆ°ç¼©å‡ã€‚ 17. Go GC åœ¨æ¼”åŒ–è¿‡ç¨‹ä¸­è¿˜å­˜åœ¨å“ªäº›å…¶ä»–è®¾è®¡ï¼Ÿä¸ºä»€ä¹ˆæ²¡æœ‰è¢«é‡‡ç”¨ï¼Ÿå¹¶å‘æ ˆé‡æ‰«æ­£å¦‚æˆ‘ä»¬å‰é¢æ‰€è¯´ï¼Œå…è®¸ç°è‰²èµ‹å€¼å™¨å­˜åœ¨çš„åžƒåœ¾å›žæ”¶å™¨éœ€è¦å¼•å…¥é‡æ‰«è¿‡ç¨‹æ¥ä¿è¯ç®—æ³•çš„æ­£ç¡®æ€§ï¼Œé™¤äº†å¼•å…¥æ··åˆå±éšœæ¥æ¶ˆé™¤é‡æ‰«è¿™ä¸€è¿‡ç¨‹å¤–ï¼Œæœ‰å¦ä¸€ç§åšæ³•å¯ä»¥æé«˜é‡æ‰«è¿‡ç¨‹çš„æ€§èƒ½ï¼Œé‚£å°±æ˜¯å°†é‡æ‰«çš„è¿‡ç¨‹å¹¶å‘æ‰§è¡Œã€‚ç„¶è€Œè¿™ä¸€æ–¹æ¡ˆå¹¶æ²¡æœ‰å¾—ä»¥å®žçŽ°ï¼ŒåŽŸå› å¾ˆç®€å•ï¼šå®žçŽ°è¿‡ç¨‹ç›¸æ¯”å¼•å…¥æ··åˆå±éšœè€Œè¨€ååˆ†å¤æ‚ï¼Œè€Œä¸”å¼•å…¥æ··åˆå±éšœèƒ½å¤Ÿæ¶ˆé™¤é‡æ‰«è¿™ä¸€è¿‡ç¨‹ï¼Œå°†ç®€åŒ–åžƒåœ¾å›žæ”¶çš„æ­¥éª¤ã€‚ ROCROC çš„å…¨ç§°æ˜¯é¢å‘è¯·æ±‚çš„å›žæ”¶å™¨ï¼ˆRequest Oriented Collectorï¼‰ï¼Œå®ƒå…¶å®žä¹Ÿæ˜¯åˆ†ä»£ GC çš„ä¸€ç§é‡æ–°å™è¿°ã€‚å®ƒæå‡ºäº†ä¸€ä¸ªè¯·æ±‚å‡è®¾ï¼ˆRequest Hypothesisï¼‰ï¼šä¸Žä¸€ä¸ªå®Œæ•´è¯·æ±‚ã€ä¼‘çœ  goroutine æ‰€å…³è”çš„å¯¹è±¡æ¯”å…¶ä»–å¯¹è±¡æ›´å®¹æ˜“æ­»äº¡ã€‚è¿™ä¸ªå‡è®¾å¬èµ·æ¥éžå¸¸ç¬¦åˆç›´è§‰ï¼Œä½†åœ¨å®žçŽ°ä¸Šï¼Œç”±äºŽåžƒåœ¾å›žæ”¶å™¨å¿…é¡»ç¡®ä¿æ˜¯å¦æœ‰ goroutine ç§æœ‰æŒ‡é’ˆè¢«å†™å…¥å…¬å…±å¯¹è±¡ï¼Œå› æ­¤å†™å±éšœå¿…é¡»ä¸€ç›´æ‰“å¼€ï¼Œè¿™ä¹Ÿå°±äº§ç”Ÿäº†è¯¥æ–¹æ³•çš„è‡´å‘½ç¼ºç‚¹ï¼šæ˜‚è´µçš„å†™å±éšœåŠå…¶å¸¦æ¥çš„ç¼“å­˜æœªå‘½ä¸­ï¼Œè¿™ä¹Ÿæ˜¯è¿™ä¸€è®¾è®¡æœ€ç»ˆæ²¡æœ‰è¢«é‡‡ç”¨çš„ä¸»è¦åŽŸå› ã€‚ ä¼ ç»Ÿåˆ†ä»£ GCåœ¨å‘çŽ° ROC æ€§èƒ½ä¸è¡Œä¹‹åŽï¼Œä½œä¸ºå¤‡é€‰æ–¹æ¡ˆï¼ŒGo å›¢é˜Ÿè¿˜å°è¯•äº†å®žçŽ°ä¼ ç»Ÿçš„åˆ†ä»£å¼ GCã€‚ä½†æœ€ç»ˆåŒæ ·å‘çŽ°åˆ†ä»£å‡è®¾å¹¶ä¸é€‚ç”¨äºŽ Go çš„è¿è¡Œæ ˆæœºåˆ¶ï¼Œå¹´è½»ä»£å¯¹è±¡åœ¨æ ˆä¸Šå°±å·²ç»æ­»äº¡ï¼Œæ‰«ææœ¬å°±è¯¥å›žæ”¶çš„æ‰§è¡Œæ ˆå¹¶æ²¡æœ‰ä¸ºç”±äºŽåˆ†ä»£å‡è®¾å¸¦æ¥æ˜Žæ˜¾çš„æ€§èƒ½æå‡ã€‚è¿™ä¹Ÿæ˜¯è¿™ä¸€è®¾è®¡æœ€ç»ˆæ²¡æœ‰è¢«é‡‡ç”¨çš„ä¸»è¦åŽŸå› ã€‚ 18. ç›®å‰æä¾› GC çš„è¯­è¨€ä»¥åŠä¸æä¾› GC çš„è¯­è¨€æœ‰å“ªäº›ï¼ŸGC å’Œ No GC å„è‡ªçš„ä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿä»ŽåŽŸç†ä¸Šè€Œè¨€ï¼Œæ‰€æœ‰çš„è¯­è¨€éƒ½èƒ½å¤Ÿè‡ªè¡Œå®žçŽ° GCã€‚ä»Žè¯­è¨€è¯žç”Ÿä¹‹åˆå°±æä¾› GC çš„è¯­è¨€ï¼Œä¾‹å¦‚ï¼š Python JavaScript Java Objective-C Swift è€Œä¸ä»¥ GC ä¸ºç›®æ ‡ï¼Œè¢«ç›´æŽ¥è®¾è®¡ä¸ºæ‰‹åŠ¨ç®¡ç†å†…å­˜ã€ä½†å¯ä»¥è‡ªè¡Œå®žçŽ° GC çš„è¯­è¨€æœ‰ï¼š C C++ ä¹Ÿæœ‰ä¸€äº›è¯­è¨€å¯ä»¥åœ¨ç¼–è¯‘æœŸï¼Œä¾é ç¼–è¯‘å™¨æ’å…¥æ¸…ç†ä»£ç çš„æ–¹å¼ï¼Œå®žçŽ°ç²¾å‡†çš„æ¸…ç†ï¼Œä¾‹å¦‚ï¼š Rust åžƒåœ¾å›žæ”¶ä½¿ç¨‹åºå‘˜æ— éœ€æ‰‹åŠ¨å¤„ç†å†…å­˜é‡Šæ”¾ï¼Œä»Žè€Œèƒ½å¤Ÿæ¶ˆé™¤ä¸€äº›éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜æ‰ä¼šå‡ºçŽ°çš„è¿è¡Œæ—¶é”™è¯¯ï¼š åœ¨ä»ç„¶æœ‰æŒ‡å‘å†…å­˜åŒºå—çš„æŒ‡é’ˆçš„æƒ…å†µä¸‹é‡Šæ”¾è¿™å—å†…å­˜æ—¶ï¼Œä¼šäº§ç”Ÿæ‚¬æŒ‚æŒ‡é’ˆï¼Œä»Žè€ŒåŽç»­å¯èƒ½é”™è¯¯çš„è®¿é—®å·²ç»ç”¨äºŽä»–ç”¨çš„å†…å­˜åŒºåŸŸã€‚ å¤šé‡é‡Šæ”¾åŒä¸€å—ç”³è¯·çš„å†…å­˜åŒºåŸŸå¯èƒ½å¯¼è‡´ä¸å¯çŸ¥çš„å†…å­˜æŸåã€‚ å½“ç„¶ï¼Œåžƒåœ¾å›žæ”¶ä¹Ÿä¼šä¼´éšä¸€äº›ç¼ºé™·ï¼Œè¿™ä¹Ÿå°±é€ å°±äº†æ²¡æœ‰ GC çš„ä¸€äº›ä¼˜åŠ¿ï¼š æ²¡æœ‰é¢å¤–çš„æ€§èƒ½å¼€é”€ ç²¾å‡†çš„æ‰‹åŠ¨å†…å­˜ç®¡ç†ï¼Œæžè‡´çš„åˆ©ç”¨æœºå™¨çš„æ€§èƒ½ 19. Go å¯¹æ¯” Javaã€V8 ä¸­ JavaScript çš„ GC æ€§èƒ½å¦‚ä½•ï¼Ÿæ— è®ºæ˜¯ Java è¿˜æ˜¯ JavaScript ä¸­çš„ GC å‡ä¸ºåˆ†ä»£å¼ GCã€‚åˆ†ä»£å¼ GC çš„ä¸€ä¸ªæ ¸å¿ƒå‡è®¾å°±æ˜¯åˆ†ä»£å‡è¯´ï¼šå°†å¯¹è±¡ä¾æ®å­˜æ´»æ—¶é—´åˆ†é…åˆ°ä¸åŒçš„åŒºåŸŸï¼Œæ¯æ¬¡å›žæ”¶åªå›žæ”¶å…¶ä¸­çš„ä¸€ä¸ªåŒºåŸŸã€‚ V8 çš„ GCåœ¨ V8 ä¸­ä¸»è¦å°†å†…å­˜åˆ†ä¸ºæ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ã€‚æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒçŸ­çš„å¯¹è±¡ï¼Œè€ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸ºå­˜æ´»æ—¶é—´è¾ƒé•¿ã€å¸¸é©»å†…å­˜ã€å ç”¨å†…å­˜è¾ƒå¤§çš„å¯¹è±¡ï¼š æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡ä¸»è¦é€šè¿‡å‰¯åžƒåœ¾å›žæ”¶å™¨è¿›è¡Œå›žæ”¶ã€‚è¯¥å›žæ”¶è¿‡ç¨‹æ˜¯ä¸€ç§é‡‡ç”¨å¤åˆ¶çš„æ–¹å¼å®žçŽ°çš„åžƒåœ¾å›žæ”¶ç®—æ³•ï¼Œå®ƒå°†å †å†…å­˜ä¸€åˆ†ä¸ºäºŒï¼Œè¿™ä¸¤ä¸ªç©ºé—´ä¸­åªæœ‰ä¸€ä¸ªå¤„äºŽä½¿ç”¨ä¸­ï¼Œå¦ä¸€ä¸ªåˆ™å¤„äºŽé—²ç½®çŠ¶æ€ã€‚å¤„äºŽä½¿ç”¨çŠ¶æ€çš„ç©ºé—´ç§°ä¸º From ç©ºé—´ï¼Œå¤„äºŽé—²ç½®çš„ç©ºé—´ç§°ä¸º To ç©ºé—´ã€‚åˆ†é…å¯¹è±¡æ—¶ï¼Œå…ˆæ˜¯åœ¨ From ç©ºé—´ä¸­è¿›è¡Œåˆ†é…ï¼Œå½“å¼€å§‹åžƒåœ¾å›žæ”¶æ—¶ï¼Œä¼šæ£€æŸ¥ From ç©ºé—´ä¸­çš„å­˜æ´»å¯¹è±¡ï¼Œå¹¶å°†è¿™äº›å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ° To ç©ºé—´ä¸­ï¼Œè€Œéžå­˜æ´»å¯¹è±¡å ç”¨çš„ç©ºé—´è¢«é‡Šæ”¾ã€‚å®Œæˆå¤åˆ¶åŽï¼ŒFrom ç©ºé—´å’Œ To ç©ºé—´çš„è§’è‰²äº’æ¢ã€‚ä¹Ÿå°±æ˜¯é€šè¿‡å°†å­˜æ´»å¯¹è±¡åœ¨ä¸¤ä¸ªç©ºé—´ä¸­è¿›è¡Œå¤åˆ¶ã€‚ è€ç”Ÿä»£åˆ™ç”±ä¸»åžƒåœ¾å›žæ”¶å™¨è´Ÿè´£ã€‚å®ƒå®žçŽ°çš„æ˜¯æ ‡è®°æ¸…æ‰«è¿‡ç¨‹ï¼Œä½†ç•¥æœ‰ä¸åŒä¹‹å¤„åœ¨äºŽå®ƒè¿˜ä¼šåœ¨æ¸…æ‰«å®ŒæˆåŽå¯¹å†…å­˜ç¢Žç‰‡è¿›è¡Œæ•´ç†ï¼Œè¿›è€Œæ˜¯ä¸€ç§æ ‡è®°æ•´ç†çš„å›žæ”¶å™¨ã€‚ Java çš„ GCJava çš„ GC ç§°ä¹‹ä¸º G1ï¼Œå¹¶å°†æ•´ä¸ªå †åˆ†ä¸ºå¹´è½»ä»£ã€è€å¹´ä»£å’Œæ°¸ä¹…ä»£ã€‚åŒ…æ‹¬å››ç§ä¸åŒçš„æ”¶é›†æ“ä½œï¼Œä»Žä¸Šå¾€ä¸‹çš„è¿™å‡ ä¸ªé˜¶æ®µä¼šé€‰æ‹©æ€§åœ°æ‰§è¡Œï¼Œè§¦å‘æ¡ä»¶æ˜¯ç”¨æˆ·çš„é…ç½®å’Œå®žé™…ä»£ç è¡Œä¸ºçš„é¢„æµ‹ã€‚ å¹´è½»ä»£æ”¶é›†å‘¨æœŸï¼šåªå¯¹å¹´è½»ä»£å¯¹è±¡è¿›è¡Œæ”¶é›†ä¸Žæ¸…ç† è€å¹´ä»£æ”¶é›†å‘¨æœŸï¼šåªå¯¹è€å¹´ä»£å¯¹è±¡è¿›è¡Œæ”¶é›†ä¸Žæ¸…ç† æ··åˆå¼æ”¶é›†å‘¨æœŸï¼šåŒæ—¶å¯¹å¹´è½»ä»£å’Œè€å¹´ä»£è¿›è¡Œæ”¶é›†ä¸Žæ¸…ç† å®Œæ•´ GC å‘¨æœŸï¼šå®Œæ•´çš„å¯¹æ•´ä¸ªå †è¿›è¡Œæ”¶é›†ä¸Žæ¸…ç† åœ¨å›žæ”¶è¿‡ç¨‹ä¸­ï¼ŒG1 ä¼šå¯¹åœé¡¿æ—¶é—´è¿›è¡Œé¢„æµ‹ï¼Œç«­å°½æ‰€èƒ½åœ°è°ƒæ•´ GC çš„ç­–ç•¥ä»Žè€Œè¾¾åˆ°ç”¨æˆ·ä»£ç é€šè¿‡ç³»ç»Ÿå‚æ•°ï¼ˆ-XX:MaxGCPauseMillisï¼‰æ‰€é…ç½®çš„å¯¹åœé¡¿æ—¶é—´çš„è¦æ±‚ã€‚ è¿™å››ä¸ªå‘¨æœŸçš„æ‰§è¡Œæˆæœ¬é€æ¸ä¸Šå‡ï¼Œä¼˜åŒ–å¾—å½“çš„ç¨‹åºå¯ä»¥å®Œå…¨é¿å…å®Œæ•´ GC å‘¨æœŸã€‚ æ€§èƒ½æ¯”è¾ƒåœ¨ Goã€Java å’Œ V8 JavaScript ä¹‹é—´æ¯”è¾ƒ GC çš„æ€§èƒ½æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªä¸åˆ‡å®žé™…çš„é—®é¢˜ã€‚å¦‚å‰é¢æ‰€è¯´ï¼Œåžƒåœ¾å›žæ”¶å™¨çš„è®¾è®¡æƒè¡¡äº†å¾ˆå¤šæ–¹é¢çš„å› ç´ ï¼ŒåŒæ—¶è¿˜å—è¯­è¨€è‡ªèº«è®¾è®¡çš„å½±å“ï¼Œå› ä¸ºè¯­è¨€çš„è®¾è®¡ä¹Ÿç›´æŽ¥å½±å“äº†ç¨‹åºå‘˜ç¼–å†™ä»£ç çš„å½¢å¼ï¼Œä¹Ÿå°±è‡ªç„¶å½±å“äº†äº§ç”Ÿåžƒåœ¾çš„æ–¹å¼ã€‚ ä½†æ€»çš„æ¥è¯´ï¼Œä»–ä»¬ä¸‰è€…å¯¹åžƒåœ¾å›žæ”¶çš„å®žçŽ°éƒ½éœ€è¦ STWï¼Œå¹¶å‡å·²è¾¾åˆ°äº†ç”¨æˆ·ä»£ç å‡ ä¹Žæ— æ³•æ„ŸçŸ¥åˆ°çš„çŠ¶æ€ï¼ˆæ® Go GC ä½œè€… Austin å®£ç§° STW å°äºŽ 100 å¾®ç§’ï¼‰ã€‚å½“ç„¶ï¼Œéšç€ STW çš„å‡å°‘ï¼Œåžƒåœ¾å›žæ”¶å™¨ä¼šå¢žåŠ  CPU çš„ä½¿ç”¨çŽ‡ï¼Œè¿™ä¹Ÿæ˜¯ç¨‹åºå‘˜åœ¨ç¼–å†™ä»£ç æ—¶éœ€è¦æ‰‹åŠ¨è¿›è¡Œä¼˜åŒ–çš„éƒ¨åˆ†ï¼Œå³å……åˆ†è€ƒè™‘å†…å­˜åˆ†é…çš„å¿…è¦æ€§ï¼Œå‡å°‘è¿‡å¤šç”³è¯·å†…å­˜å¸¦ç»™åžƒåœ¾å›žæ”¶å™¨çš„åŽ‹åŠ›ã€‚ 20. ç›®å‰ Go è¯­è¨€çš„ GC è¿˜å­˜åœ¨å“ªäº›é—®é¢˜ï¼Ÿå°½ç®¡ Go å›¢é˜Ÿå®£ç§° STW åœé¡¿æ—¶é—´å¾—ä»¥ä¼˜åŒ–åˆ° 100 å¾®ç§’çº§åˆ«ï¼Œä½†è¿™æœ¬è´¨ä¸Šæ˜¯ä¸€ç§å–èˆã€‚åŽŸæœ¬çš„ STW æŸç§æ„ä¹‰ä¸Šæ¥è¯´å…¶å®žè½¬ç§»åˆ°äº†å¯èƒ½å¯¼è‡´ç”¨æˆ·ä»£ç åœé¡¿çš„å‡ ä¸ªä½ç½®ï¼›é™¤æ­¤ä¹‹å¤–ï¼Œç”±äºŽè¿è¡Œæ—¶è°ƒåº¦å™¨çš„å®žçŽ°æ–¹å¼ï¼ŒåŒæ ·å¯¹ GC å­˜åœ¨ä¸€å®šç¨‹åº¦çš„å½±å“ã€‚ ç›®å‰ Go ä¸­çš„ GC ä»ç„¶å­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š 1. Mark Assist åœé¡¿æ—¶é—´è¿‡é•¿12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273package mainimport ( "fmt" "os" "runtime" "runtime/trace" "time")const ( windowSize = 200000 msgCount = 1000000)var ( best time.Duration = time.Second bestAt time.Time worst time.Duration worstAt time.Time start = time.Now())func main() &#123; f, _ := os.Create("trace.out") defer f.Close() trace.Start(f) defer trace.Stop() for i := 0; i &lt; 5; i++ &#123; measure() worst = 0 best = time.Second runtime.GC() &#125;&#125;func measure() &#123; var c channel for i := 0; i &lt; msgCount; i++ &#123; c.sendMsg(i) &#125; fmt.Printf("Best send delay %v at %v, worst send delay: %v at %v. Wall clock: %v \n", best, bestAt.Sub(start), worst, worstAt.Sub(start), time.Since(start))&#125;type channel [windowSize][]bytefunc (c *channel) sendMsg(id int) &#123; start := time.Now() // æ¨¡æ‹Ÿå‘é€ (*c)[id%windowSize] = newMsg(id) end := time.Now() elapsed := end.Sub(start) if elapsed &gt; worst &#123; worst = elapsed worstAt = end &#125; if elapsed &lt; best &#123; best = elapsed bestAt = end &#125;&#125;func newMsg(n int) []byte &#123; m := make([]byte, 1024) for i := range m &#123; m[i] = byte(n) &#125; return m&#125; è¿è¡Œæ­¤ç¨‹åºæˆ‘ä»¬å¯ä»¥å¾—åˆ°ç±»ä¼¼ä¸‹é¢çš„ç»“æžœï¼š 1234567$ go run main.goBest send delay 330ns at 773.037956ms, worst send delay: 7.127915ms at 579.835487ms. Wall clock: 831.066632ms Best send delay 331ns at 873.672966ms, worst send delay: 6.731947ms at 1.023969626s. Wall clock: 1.515295559s Best send delay 330ns at 1.812141567s, worst send delay: 5.34028ms at 2.193858359s. Wall clock: 2.199921749s Best send delay 338ns at 2.722161771s, worst send delay: 7.479482ms at 2.665355216s. Wall clock: 2.920174197s Best send delay 337ns at 3.173649445s, worst send delay: 6.989577ms at 3.361716121s. Wall clock: 3.615079348s åœ¨è¿™ä¸ªç»“æžœä¸­ï¼Œç¬¬ä¸€æ¬¡çš„æœ€åå»¶è¿Ÿæ—¶é—´é«˜è¾¾ 7.12 æ¯«ç§’ï¼Œå‘ç”Ÿåœ¨ç¨‹åºè¿è¡Œ 578 æ¯«ç§’å·¦å³ã€‚é€šè¿‡ go tool trace å¯ä»¥å‘çŽ°ï¼Œè¿™ä¸ªæ—¶é—´æ®µä¸­ï¼ŒMark Assist æ‰§è¡Œäº† 7112312nsï¼Œçº¦ä¸º 7.127915msï¼›å¯è§ï¼Œæ­¤æ—¶æœ€åæƒ…å†µä¸‹ï¼Œæ ‡è®°è¾…åŠ©æ‹–æ…¢äº†ç”¨æˆ·ä»£ç çš„æ‰§è¡Œï¼Œæ˜¯é€ æˆ 7 æ¯«ç§’å»¶è¿Ÿçš„åŽŸå› ã€‚ 2. Sweep åœé¡¿æ—¶é—´è¿‡é•¿åŒæ ·è¿˜æ˜¯åˆšæ‰çš„ä¾‹å­ï¼Œå¦‚æžœæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿ Mark Assist åŽå‘ç”Ÿçš„ Sweep é˜¶æ®µï¼Œç«Ÿç„¶å¯¹ç”¨æˆ·ä»£ç çš„å½±å“é•¿è¾¾çº¦ 30msï¼Œæ ¹æ®è°ƒç”¨æ ˆä¿¡æ¯å¯ä»¥çœ‹åˆ°ï¼Œè¯¥ Sweep è¿‡ç¨‹å‘ç”Ÿåœ¨å†…å­˜åˆ†é…é˜¶æ®µï¼š 3. ç”±äºŽ GC ç®—æ³•çš„ä¸æ­£ç¡®æ€§å¯¼è‡´ GC å‘¨æœŸè¢«è¿«é‡æ–°æ‰§è¡Œæ­¤é—®é¢˜å¾ˆéš¾å¤çŽ°ï¼Œä½†æ˜¯ä¸€ä¸ªå·²çŸ¥çš„é—®é¢˜ï¼Œæ ¹æ® Go å›¢é˜Ÿçš„æè¿°ï¼Œèƒ½å¤Ÿåœ¨ 1334 æ¬¡æž„å»ºä¸­å‘ç”Ÿä¸€æ¬¡ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºå…¶è§¦å‘æ¦‚çŽ‡çº¦ä¸º 0.0007496251874ã€‚è™½ç„¶å‘ç”Ÿæ¦‚çŽ‡å¾ˆä½Žï¼Œä½†ä¸€æ—¦å‘ç”Ÿï¼ŒGC éœ€è¦è¢«é‡æ–°æ‰§è¡Œï¼Œéžå¸¸ä¸å¹¸ã€‚ 4. åˆ›å»ºå¤§é‡ Goroutine åŽå¯¼è‡´ GC æ¶ˆè€—æ›´å¤šçš„ CPUè¿™ä¸ªé—®é¢˜å¯ä»¥é€šè¿‡ä»¥ä¸‹ç¨‹åºè¿›è¡ŒéªŒè¯ï¼š 12345678910111213141516171819202122232425262728func BenchmarkGCLargeGs(b *testing.B) &#123; wg := sync.WaitGroup&#123;&#125; for ng := 100; ng &lt;= 1000000; ng *= 10 &#123; b.Run(fmt.Sprintf("#g-%d", ng), func(b *testing.B) &#123; // åˆ›å»ºå¤§é‡ goroutineï¼Œç”±äºŽæ¯æ¬¡åˆ›å»ºçš„ goroutine ä¼šä¼‘çœ  // ä»Žè€Œè¿è¡Œæ—¶ä¸ä¼šå¤ç”¨æ­£åœ¨ä¼‘çœ çš„ goroutineï¼Œè¿›è€Œä¸æ–­åˆ›å»ºæ–°çš„ g wg.Add(ng) for i := 0; i &lt; ng; i++ &#123; go func() &#123; time.Sleep(100 * time.Millisecond) wg.Done() &#125;() &#125; wg.Wait() // çŽ°è¿è¡Œä¸€æ¬¡ GC æ¥æä¾›ä¸€è‡´çš„å†…å­˜çŽ¯å¢ƒ runtime.GC() // è®°å½•è¿è¡Œ b.N æ¬¡ GC éœ€è¦çš„æ—¶é—´ b.ResetTimer() for i := 0; i &lt; b.N; i++ &#123; runtime.GC() &#125; &#125;) &#125;&#125; å…¶ç»“æžœå¯ä»¥é€šè¿‡å¦‚ä¸‹æŒ‡ä»¤æ¥èŽ·å¾—ï¼š 12345678$ go test -bench=BenchmarkGCLargeGs -run=^$ -count=5 -v . | tee 4.txt$ benchstat 4.txtname time/opGCLargeGs/#g-100-12 192Âµs Â± 5%GCLargeGs/#g-1000-12 331Âµs Â± 1%GCLargeGs/#g-10000-12 1.22ms Â± 1%GCLargeGs/#g-100000-12 10.9ms Â± 3%GCLargeGs/#g-1000000-12 32.5ms Â± 4% è¿™ç§æƒ…å†µé€šå¸¸å‘ç”ŸäºŽå³°å€¼æµé‡åŽï¼Œå¤§é‡ goroutine ç”±äºŽä»»åŠ¡ç­‰å¾…è¢«ä¼‘çœ ï¼Œä»Žè€Œè¿è¡Œæ—¶ä¸æ–­åˆ›å»ºæ–°çš„ goroutineï¼Œæ—§çš„ goroutine ç”±äºŽä¼‘çœ æœªè¢«é”€æ¯ä¸”å¾—ä¸åˆ°å¤ç”¨ï¼Œå¯¼è‡´ GC éœ€è¦æ‰«æçš„æ‰§è¡Œæ ˆè¶Šæ¥è¶Šå¤šï¼Œè¿›è€Œå®Œæˆ GC æ‰€éœ€çš„æ—¶é—´è¶Šæ¥è¶Šé•¿ã€‚ä¸€ä¸ªè§£å†³åŠžæ³•æ˜¯ä½¿ç”¨ goroutine æ± æ¥é™åˆ¶åˆ›å»ºçš„ goroutine æ•°é‡ã€‚ æ€»ç»“GC æ˜¯ä¸€ä¸ªå¤æ‚çš„ç³»ç»Ÿå·¥ç¨‹ï¼Œæœ¬æ–‡è®¨è®ºçš„äºŒåä¸ªé—®é¢˜å°½ç®¡å·²ç»å±•çŽ°äº†ä¸€ä¸ªç›¸å¯¹å…¨é¢çš„ Go GCã€‚ä½†å®ƒä»¬ä»ç„¶åªæ˜¯ GC è¿™ä¸€å®è§‚é—®é¢˜çš„ä¸€äº›è¾ƒä¸ºé‡è¦çš„éƒ¨åˆ†ï¼Œè¿˜æœ‰éžå¸¸å¤šçš„ç»†æžæœ«èŠ‚ã€ç ”ç©¶è¿›å±•æ— æ³•åœ¨æœ‰é™çš„ç¯‡å¹…å†…å®Œæ•´è®¨è®ºã€‚ ä»Ž Go è¯žç”Ÿä¹‹åˆï¼ŒGo å›¢é˜Ÿå°±ä¸€ç›´åœ¨å¯¹ GC çš„è¡¨çŽ°è¿›è¡Œå®žéªŒä¸Žä¼˜åŒ–ï¼Œä½†ä»ç„¶æœ‰è¯¸å¤šæœªè§£å†³çš„é—®é¢˜ï¼Œæˆ‘ä»¬ä¸å¦¨å¯¹ GC æœªæ¥çš„æ”¹è¿›æ‹­ç›®ä»¥å¾…ã€‚ æŽ¨èé˜…è¯»ã€Why golang garbage-collector not implement Generational and Compact gc?ã€‘https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ ã€å†™ä¸€ä¸ªå†…å­˜åˆ†é…å™¨ã€‘http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/#more-3590 ã€è§‚å¯Ÿ GCã€‘https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html ã€ç…Žé±¼ Go debugã€‘https://segmentfault.com/a/1190000020255157 ã€ç…Žé±¼ go tool traceã€‘https://eddycjy.gitbook.io/golang/di-9-ke-gong-ju/go-tool-trace ã€trace è®²è§£ã€‘https://www.itcodemonkey.com/article/5419.html ã€An Introduction to go tool traceã€‘https://about.sourcegraph.com/go/an-introduction-to-go-tool-trace-rhys-hiltner ã€http pprof å®˜æ–¹æ–‡æ¡£ã€‘https://golang.org/pkg/net/http/pprof/ ã€runtime pprof å®˜æ–¹æ–‡æ¡£ã€‘https://golang.org/pkg/runtime/pprof/ ã€trace å®˜æ–¹æ–‡æ¡£ã€‘https://golang.org/pkg/runtime/trace/ æŽ¨èé˜…è¯»ã€Why golang garbage-collector not implement Generational and Compact gc?ã€‘https://groups.google.com/forum/#!msg/golang-nuts/KJiyv2mV2pU/wdBUH1mHCAAJ ã€å†™ä¸€ä¸ªå†…å­˜åˆ†é…å™¨ã€‘http://dmitrysoshnikov.com/compilers/writing-a-memory-allocator/#more-3590 ã€è§‚å¯Ÿ GCã€‘https://www.ardanlabs.com/blog/2019/05/garbage-collection-in-go-part2-gctraces.html ã€ç…Žé±¼ Go debugã€‘https://segmentfault.com/a/1190000020255157 ã€ç…Žé±¼ go tool traceã€‘https://eddycjy.gitbook.io/golang/di-9-ke-gong-ju/go-tool-trace ã€trace è®²è§£ã€‘https://www.itcodemonkey.com/article/5419.html ã€An Introduction to go tool traceã€‘https://about.sourcegraph.com/go/an-introduction-to-go-tool-trace-rhys-hiltner ã€http pprof å®˜æ–¹æ–‡æ¡£ã€‘https://golang.org/pkg/net/http/pprof/ ã€runtime pprof å®˜æ–¹æ–‡æ¡£ã€‘https://golang.org/pkg/runtime/pprof/ ã€trace å®˜æ–¹æ–‡æ¡£ã€‘https://golang.org/pkg/runtime/trace/]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangè‡ªåŠ¨ç”Ÿæˆå¯¹åº”MySQLæ•°æ®åº“è¡¨çš„structå®šä¹‰]]></title>
    <url>%2F2020%2F01%2F01%2Fgolang%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E5%AF%B9%E5%BA%94MySQL%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84struct%E5%AE%9A%E4%B9%89%2F</url>
    <content type="text"><![CDATA[åœ¨golangçš„å¼€å‘è¿‡ç¨‹ä¸­ï¼Œå½“æˆ‘ä»¬ä½¿ç”¨ormçš„æ—¶å€™ï¼Œå¸¸å¸¸éœ€è¦å°†æ•°æ®åº“è¡¨å¯¹åº”åˆ°golangçš„ä¸€ä¸ªstructï¼Œè¿™äº›structä¼šæºå¸¦ormå¯¹åº”çš„tag,å°±åƒä¸‹é¢çš„structå®šä¹‰ä¸€æ ·ï¼š 12345678910111213141516type InsInfo struct &#123; Connections string `gorm:"column:connections"` CPU int `gorm:"column:cpu"` CreateTime time.Time `gorm:"column:create_time"` Env int `gorm:"column:env"` ID int64 `gorm:"column:id;primary_key"` IP string `gorm:"column:ip"` Organization string `gorm:"column:organization"` Pass string `gorm:"column:pass"` Port string `gorm:"column:port"` RegionId string `gorm:"column:regionid"` ServerIP string `gorm:"column:server_ip"` Status int `gorm:"column:status"` Type string `gorm:"column:type"` UUID string `gorm:"column:uuid"`&#125; è¿™æ˜¯gormå¯¹åº”çš„æ•°æ®åº“è¡¨çš„structæ˜ å°„ï¼Œå³ä½¿æ•°æ®è¡¨çš„å­—æ®µä¸å¤šï¼Œå¦‚æžœæ˜¯æ‰‹åŠ¨å†™èµ·æ¥ä¹Ÿæ˜¯ä¸€äº›é‡å¤æ€§çš„å·¥ä½œã€‚åƒMySQLè¿™ç§å…³ç³»åž‹æ•°æ®åº“ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šç”¨ormåŽ»æ“ä½œæ•°æ®åº“ï¼ŒäºŽæ˜¯å°±æƒ³ï¼Œmysqlçš„æ•°æ®è¡¨èƒ½ä¸èƒ½æ¥è‡ªåŠ¨ç”Ÿæˆgolang çš„structå®šä¹‰ã€‚æˆ‘ä»¬çŸ¥é“mysqlæœ‰ä¸ªè‡ªå¸¦çš„æ•°æ®åº“information_schemaï¼Œæœ‰ä¸€å¼ è¡¨COLUMNSï¼Œå®ƒçš„å­—æ®µåŒ…å«æ•°æ®åº“åã€è¡¨åã€å­—æ®µåã€å­—æ®µç±»åž‹ç­‰ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè¡¨çš„æ•°æ®ï¼ŒæŠŠå¯¹åº”çš„è¡¨çš„å­—æ®µä¿¡æ¯è¯»å–å‡ºæ¥ï¼Œç„¶åŽå†æ ¹æ®golangçš„è¯­æ³•è§„åˆ™ï¼Œç”Ÿæˆå¯¹åº”çš„structã€‚ è°ƒç ”äº†ä¸€ä¸‹ç›®å‰æœ‰ä¸€äº›å‘½ä»¤è¡Œå·¥å…·åƒ db2structç­‰ï¼Œæ„Ÿè§‰ç”¨èµ·æ¥æ¯”è¾ƒç¹çï¼Œåœ¨æƒ³èƒ½ä¸èƒ½æä¾›ä¸€ä¸ªå¼€ç®±å³ç”¨çš„çŽ¯å¢ƒï¼Œæä¾›webç•Œé¢ï¼Œæˆ‘ä»¬åªéœ€è¦å¡«å†™æ•°æ®åº“ä¿¡æ¯ï¼Œå°±å¯ä»¥ä¸€é”®ç”Ÿæˆå¯¹åº”çš„ORMçš„structï¼ŒäºŽæ˜¯å°±è¯žç”Ÿäº†è¿™ä¸ªé¡¹ç›®ï¼šhttps://github.com/hantmac/fuckdb å¦‚æžœä½ çš„æ•°æ®åº“åœ¨æœ¬åœ°ï¼Œé‚£ä¹ˆåªéœ€è¦æ‰§è¡Œ docker-compose up -dï¼Œè®¿é—®localhost:8088ï¼Œä½ å°±ä¼šå¾—åˆ°ä¸‹é¢çš„ç•Œé¢ï¼š å¦‚æžœä½ çš„æ•°æ®åº“åœ¨å†…ç½‘æœåŠ¡å™¨ä¸Šï¼Œä½ éœ€è¦å…ˆä¿®æ”¹åŽç«¯æŽ¥å£çš„ip:port,ç„¶åŽé‡æ–°build Dockeré•œåƒï¼Œpushåˆ°è‡ªå·±çš„é•œåƒä»“åº“ï¼Œç„¶åŽä¿®æ”¹docker-compose.yamlï¼Œå†æ‰§è¡Œdocker-compose up -dã€‚ä¿®æ”¹çš„ä½ç½®æ˜¯ï¼šfuckdb/frontend/src/config/index.js. åªéœ€è¦å¡«å…¥æ•°æ®åº“ç›¸å…³ä¿¡æ¯ï¼Œä»¥åŠä½ æƒ³å¾—åˆ°çš„golangä»£ç çš„package nameã€struct name,ç„¶åŽç‚¹å‡»ç”Ÿæˆï¼Œå°±å¯ä»¥å¾—åˆ°gormå¯¹åº”çš„ç»“æž„ä½“æ˜ å°„ï¼š ä½ åªéœ€è¦æ‹·è´ä½ çš„ä»£ç åˆ°é¡¹ç›®ä¸­å³å¯ã€‚æˆ‘ä»¬éƒ½çŸ¥é“golangçš„structçš„tagæœ‰å¾ˆå¤šåŠŸèƒ½ï¼Œè¿™é‡Œä¹Ÿæä¾›äº†å¾ˆå¤štagçš„å¯é€‰é¡¹ï¼Œæ¯”å¦‚json,xmlç­‰ï¼ŒåŽé¢ä¼šæ›¾åŠ æ›´å¤šçš„tagå¯é€‰é¡¹æ”¯æŒã€‚ ä¸Šé¢çš„GIFå±•ç¤ºäº†å¢žåŠ äº†ç¼“å­˜åŠŸèƒ½çš„ç‰ˆæœ¬ï¼Œè®°å¿†ä½ ä¹‹å‰å¡«å†™è¿‡çš„æ•°æ®åº“ä¿¡æ¯ï¼ŒçœåŽ»äº†å¤§é‡é‡å¤çš„æ“ä½œï¼Œä½ ä¸ç”¨å†å¡«å†™ç¹ççš„æ•°æ®åº“åï¼Œè¡¨åï¼Œç­‰ç­‰ï¼Œåªéœ€ä¸€é”®ï¼Œå°±å¯ä»¥å¾—åˆ°å¯¹åº”çš„ä»£ç ï¼Œæ˜¯ä¸æ˜¯å¾ˆæ–¹ä¾¿å•Šã€‚ps:ç›®å‰æ•°æ®åº“ä¿¡æ¯æ²¡æœ‰åšåŠ å¯†ï¼Œæ‰€ä»¥ä¸æ–¹ä¾¿æ”¾åˆ°å…¬ç½‘ä¸Šä½¿ç”¨ï¼Œä»…é™äºŽå†…ç½‘ï¼ŒåŽé¢ä¼šè¿›è¡Œç›¸åº”çš„å¼€å‘æ”¯æŒã€‚ç›®å‰è¿™ä¸ªå·¥å…·åœ¨æˆ‘ä»¬ç»„å†…å·²ç»å¼€å§‹ä½¿ç”¨ï¼Œåé¦ˆæ¯”è¾ƒå¥½ï¼ŒèŠ‚çœäº†å¾ˆå¤šé‡å¤çš„å·¥ä½œï¼Œå°¤å…¶æ˜¯åœ¨å¼€å‘çš„æ—¶å€™ç”¨åˆ°åŒä¸€ä¸ªåº“çš„å¤šå¼ è¡¨ï¼Œå¾ˆå¿«å°±å¯ä»¥å®Œæˆæ•°æ®åº“è¡¨-&gt;strcutçš„æ˜ å°„ã€‚ æ¬¢è¿Žè¯•ç”¨&amp;åé¦ˆ&amp;Contributeã€‚ä»£ç åœ°å€ï¼šhttps://github.com/hantmac/fuckdb]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[viperé…ç½®è¯¦è§£]]></title>
    <url>%2F2019%2F12%2F23%2Fviper%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[viper è¯»å–é…ç½®æ–‡ä»¶ viper é¡¹ç›®åœ°å€ ï¼šgithub.com/spf13/viper viper æ˜¯ä»€ä¹ˆ go å¼€å‘å·¥å…·ï¼Œä¸»è¦æ˜¯ç”¨äºŽå¤„ç†å„ç§æ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼Œç®€åŒ–ç¨‹åºé…ç½®çš„è¯»å–é—®é¢˜ viper æ”¯æŒï¼š è®¾ç½®é»˜è®¤é…ç½® æ”¯æŒè¯»å– JSON TOML YAML HCL å’Œ Java å±žæ€§é…ç½®æ–‡ä»¶ ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–ï¼Œå®žæ—¶è¯»å–è¯»å–é…ç½®æ–‡ä»¶å†…å®¹ è¯»å–çŽ¯å¢ƒå˜é‡å€¼ è¯»å–è¿œç¨‹é…ç½®ç³»ç»Ÿ (etcd Consul) å’Œç›‘æŽ§é…ç½®å˜åŒ– è¯»å–å‘½ä»¤ Flag å€¼ è¯»å– buffer å€¼ è¯»å–ç¡®åˆ‡å€¼ å®‰è£…12go get github.com/fsnotify/fsnotifygo get github.com/spf13/viper viper çš„åŸºæœ¬ç”¨æ³•é…ç½®æ–‡ä»¶ json é…ç½®æ–‡ä»¶ (config.json) 12345678910111213141516&#123;"port": 10666,"mysql": &#123; "url": "(127.0.0.1:3306)/biezhi", "username": "root", "password": "123456"&#125;,"redis": ["127.0.0.1:6377", "127.0.0.1:6378", "127.0.0.1:6379"],"smtp": &#123; "enable": true, "addr": "mail_addr", "username": "mail_user", "password": "mail_password", "to": ["xxx@gmail.com", "xxx@163.com"]&#125;&#125; yaml é…ç½®æ–‡ä»¶ (config1.yaml) 1234567891011121314151617port: 10666mysql:url: "(127.0.0.1:3306)/biezhi"username: rootpassword: 123456redis:- 127.0.0.1:6377- 127.0.0.1:6378- 127.0.0.1:6379smtp:enable: trueaddr: mail_addrusername: mail_userpassword: mail_passwordto: - xxx@gmail.com- xxx@163.com æœ¬åœ°é…ç½®æ–‡ä»¶è¯»å–æ–¹å¼ å°†ä¸Šè¿°ä¸¤ä¸ªé…ç½®æ–‡ä»¶å’Œä¸‹é¢çš„ main.go æ”¾åœ¨ç»Ÿä¸€ç›®å½•ä¹‹ä¸‹ï¼Œå³å¯å®žçŽ°è¯»å–é…ç½®æ–‡ä»¶ 1234567891011121314151617181920212223242526272829303132333435package mainimport ( "fmt" "log" "github.com/spf13/viper")func init() &#123; // viper.SetConfigName("config1") // è¯»å–yamlé…ç½®æ–‡ä»¶ viper.SetConfigName("config") // è¯»å–jsoné…ç½®æ–‡ä»¶ //viper.AddConfigPath("/etc/appname/") //è®¾ç½®é…ç½®æ–‡ä»¶çš„æœç´¢ç›®å½• //viper.AddConfigPath("$HOME/.appname") // è®¾ç½®é…ç½®æ–‡ä»¶çš„æœç´¢ç›®å½• viper.AddConfigPath(".") // è®¾ç½®é…ç½®æ–‡ä»¶å’Œå¯æ‰§è¡ŒäºŒè¿›åˆ¶æ–‡ä»¶åœ¨ç”¨ä¸€ä¸ªç›®å½• if err := viper.ReadInConfig(); err != nil &#123; if _, ok := err.(viper.ConfigFileNotFoundError); ok &#123; // Config file not found; ignore error if desired log.Println("no such config file") &#125; else &#123; // Config file was found but another error was produced log.Println("read config error") &#125; log.Fatal(err) // è¯»å–é…ç½®æ–‡ä»¶å¤±è´¥è‡´å‘½é”™è¯¯ &#125;&#125;func main() &#123; fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„port", viper.GetInt("port")) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.url", viper.GetString(`mysql.url`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.username", viper.GetString(`mysql.username`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.password", viper.GetString(`mysql.password`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„redis", viper.GetStringSlice("redis")) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„smtp", viper.GetStringMap("smtp"))&#125; ä»£ç è¯¦è§£ viper.SetConfigName (â€œconfigâ€) è®¾ç½®é…ç½®æ–‡ä»¶åä¸º config, ä¸éœ€è¦é…ç½®æ–‡ä»¶æ‰©å±•åï¼Œé…ç½®æ–‡ä»¶çš„ç±»åž‹ viper ä¼šè‡ªåŠ¨æ ¹æ®æ‰©å±•åè‡ªåŠ¨åŒ¹é…. viper.AddConfigPath (â€œ.â€) è®¾ç½®é…ç½®æ–‡ä»¶æœç´¢çš„ç›®å½•ï¼Œ. è¡¨ç¤ºå’Œå½“å‰ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åœ¨åŒä¸€ä¸ªç›®å½•ã€‚å¯ä»¥æ·»åŠ å¤šä¸ªé…ç½®æ–‡ä»¶ç›®å½•ï¼Œå¦‚åœ¨ç¬¬ä¸€ä¸ªç›®å½•ä¸­æ‰¾åˆ°å°±ä¸ä¸ç»§ç»­åˆ°å…¶ä»–ç›®å½•ä¸­æŸ¥æ‰¾. viper.ReadInConfig () åŠ è½½é…ç½®æ–‡ä»¶å†…å®¹ viper.Get*** èŽ·å–é…ç½®æ–‡ä»¶ä¸­é…ç½®é¡¹çš„ä¿¡æ¯ viper çš„ä¸€äº›é«˜çº§ç”¨æ³• viper è®¾ç½®é…ç½®é¡¹çš„é»˜è®¤å€¼ 12345678// set default configviper.SetDefault("ContentDir", "content")viper.SetDefault("LayoutDir", "layouts")viper.SetDefault("Taxonomies", map[string]string&#123;"tag": "tags", "category": "categories"&#125;)fmt.Println(viper.GetBool("ContentDir"))fmt.Println(viper.GetString("LayoutDir"))fmt.Println(viper.GetStringMapString("Taxonomies")) ç›‘å¬å’Œé‡æ–°è¯»å–é…ç½®æ–‡ä»¶ import â€œgithub.com/fsnotify/fsnotifyâ€ 12345viper.WatchConfig()viper.OnConfigChange(func(e fsnotify.Event) &#123; //viperé…ç½®å‘ç”Ÿå˜åŒ–äº† æ‰§è¡Œå“åº”çš„æ“ä½œ fmt.Println("Config file changed:", e.Name)&#125;) ä»ŽçŽ¯å¢ƒå˜é‡å˜é‡ä¸­è¯»å– ä¸»è¦ç”¨åˆ°çš„æ˜¯ä¸‹é¢ä¸‰ä¸ªä¸ªæ–¹æ³• 1234567891011121314// AutomaticEnv has Viper check ENV variables for all.// keys set in config, default &amp; flagsAutomaticEnv()// BindEnv binds a Viper key to a ENV variable.// ENV variables are case sensitive.// If only a key is provided, it will use the env key matching the key, uppercased.// EnvPrefix will be used when set when env name is not provided.BindEnv(stringâ€¦) : error// SetEnvPrefix defines a prefix that ENVIRONMENT variables will use.// E.g. if your prefix is "spf", the env registry will look for env// variables that start with "SPF_".SetEnvPrefix(string) ç®€å•çš„ä½¿ç”¨ demo å¦‚ä¸‹æ‰€ç¤º 1234567891011121314151617181920212223242526272829package main import ( "fmt" "os" "github.com/spf13/viper")func main() &#123; prefix := "PROJECTNAME" envs := map[string]string&#123; "LOG_LEVEL": "INFO", "MODE": "DEV", "MYSQL_USERNAME": "root", "MYSQL_PASSWORD": "xxxx", &#125; for k, v := range envs &#123; os.Setenv(fmt.Sprintf("%s_%s", prefix, k), v) &#125; v := viper.New() v.SetEnvPrefix(prefix) v.AutomaticEnv() for k, _ := range envs &#123; fmt.Printf("env `%s` = %s\n", k, v.GetString(k)) &#125;&#125; èŽ·å–è¿œç¨‹é…ç½® ä½¿ç”¨ github.com/spf13/viper/remote åŒ… import _ â€œgithub.com/spf13/viper/remoteâ€ Viper å¯ä»¥ä»Žä¾‹å¦‚ etcdã€Consul çš„è¿œç¨‹ Key/Value å­˜å‚¨ç³»ç»Ÿçš„ä¸€ä¸ªè·¯å¾„ä¸Šï¼Œè¯»å–ä¸€ä¸ªé…ç½®å­—ç¬¦ä¸²ï¼ˆJSON, TOML, YAML æˆ– HCL æ ¼å¼ï¼‰. è¿™äº›å€¼ä¼˜å…ˆäºŽé»˜è®¤å€¼ï¼Œä½†ä¼šè¢«ä»Žç£ç›˜æ–‡ä»¶ã€å‘½ä»¤è¡Œ flagã€çŽ¯å¢ƒå˜é‡çš„é…ç½®æ‰€è¦†ç›–. æœ¬äººå¯¹ consul æ¯”è¾ƒç†Ÿæ‚‰ï¼Œç”¨å®ƒæ¥åšä¾‹å­ é¦–å…ˆåœ¨æœ¬åœ°å¯åŠ¨ consul 1consul agent -dev å¹¶åœ¨ consul ä¸Šè®¾ç½®åä¸º config çš„ json é…ç½®æ–‡ä»¶ ä»£ç å¦‚ä¸‹ 1234567891011121314151617181920212223242526package mainimport ( "fmt" "log" "github.com/spf13/viper" _ "github.com/spf13/viper/remote")func main() &#123; v := viper.New() v.AddRemoteProvider("consul", "localhost:8500", "config") v.SetConfigType("json") // Need to explicitly set this to json if err := v.ReadRemoteConfig(); err != nil &#123; log.Println(err) return &#125; fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„port", v.GetInt("port")) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.url", v.GetString(`mysql.url`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.username", v.GetString(`mysql.username`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.password", v.GetString(`mysql.password`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„redis", v.GetStringSlice("redis")) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„smtp", v.GetStringMap("smtp"))&#125; ä»Ž io.Reader ä¸­è¯»å–é…ç½®ä¿¡æ¯ é¦–å…ˆç»™å¤§å®¶æ¥æ®µä¾‹å­ 123456789101112131415161718192021222324252627282930313233343536373839404142package mainimport ( "bytes" "fmt" "github.com/spf13/viper")func main() &#123; v := viper.New() v.SetConfigType("json") // è®¾ç½®é…ç½®æ–‡ä»¶çš„ç±»åž‹ // é…ç½®æ–‡ä»¶å†…å®¹ var jsonExample = []byte(`&#123; "port": 10666, "mysql": &#123; "url": "(127.0.0.1:3306)/biezhi", "username": "root", "password": "123456" &#125;, "redis": ["127.0.0.1:6377", "127.0.0.1:6378", "127.0.0.1:6379"], "smtp": &#123; "enable": true, "addr": "mail_addr", "username": "mail_user", "password": "mail_password", "to": ["xxx@gmail.com", "xxx@163.com"] &#125;&#125;`) //åˆ›å»ºio.Reader v.ReadConfig(bytes.NewBuffer(jsonExample)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„port", v.GetInt("port")) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.url", v.GetString(`mysql.url`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.username", v.GetString(`mysql.username`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„mysql.password", v.GetString(`mysql.password`)) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„redis", v.GetStringSlice("redis")) fmt.Println("èŽ·å–é…ç½®æ–‡ä»¶çš„smtp", v.GetStringMap("smtp"))&#125; è¿™ä¸ªåŠŸèƒ½æ—¥å¸¸çš„ä½¿ç”¨æƒ…å†µè¾ƒå°‘ï¼Œä¾‹å¦‚è¿™æ ·çš„ä¸€ä¸ªæƒ…æ™¯ï¼š é…ç½®æ–‡ä»¶æ”¾åœ¨ oss ä¸Šæˆ–è€… github æŸä¸ªç§æœ‰ä»“åº“ä¸Šï¼Œviper å¹¶æ²¡æœ‰æä¾›ç›´æŽ¥çš„æŽ¥å£åŽ»èŽ·å–ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥åŸºäºŽç¬¬ä¸‰æ–¹æ‰˜ç®¡å¹³å°çš„ sdk å†™ä¸€å¥—èŽ·å–é…ç½®æ–‡ä»¶ bytes çš„å·¥å…·ï¼Œå°†ç»“æžœæ”¾å…¥ io.Reader ä¸­ï¼Œå†è¿›è¡Œé…ç½®æ–‡ä»¶çš„è§£æžã€‚ ä¸Šè¿°æµç¨‹æ„Ÿè§‰å¥½åƒæ¯”è¾ƒé¸¡è‚‹ï¼Œå¤æ‚äº†æ•´ä¸ªæµç¨‹ï¼šæˆ‘æ—¢ç„¶å¯ä»¥é€šè¿‡ç¬¬ä¸‰æ–¹çš„ sdk ç›´æŽ¥æ‹¿åˆ° bytesï¼Œä¸ºä½•ä¸è‡ªå·±ç›´æŽ¥è¿›è¡Œè§£æžå‘¢ï¼Ÿè€Œè¦å€ŸåŠ© viper æ¥è§£æžã€‚å¯èƒ½æœ‰äººä¼šè¯´ï¼Œé…ç½®æ–‡ä»¶å¦‚æžœæ ¼å¼ä¸åŒå‘¢ï¼Ÿç¡®å®žï¼Œviper çš„å‡ºçŽ°å°±æ˜¯ä¸ºäº†é’ˆå¯¹å¤šç§æ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯åœ¨æ­£å¼çš„é¡¹ç›®ä¸­ï¼Œé…ç½®æ–‡ä»¶çš„æ ¼å¼ä¸€èˆ¬ä¸ä¼šå˜ï¼Œå¯ä»¥è‡ªå·±å†™ä¸€å¥—è§£æžçš„å·¥å…·ï¼Œä¹Ÿå°±æ²¡æœ‰ä½¿ç”¨ viper çš„éœ€æ±‚äº†ã€‚è€Œä¸”å¯¹äºŽæŸä¸€ç§ç‰¹å®šæ ¼å¼çš„é…ç½®æ–‡ä»¶ï¼ˆJSONï¼ŒYAMLâ€¦ï¼‰ï¼ŒGolang å·²ç»æœ‰è¶³å¤Ÿå¼ºå¤§çš„åŒ…æ¥è¿›è¡Œè§£æžäº†ã€‚ ä½†æ˜¯ä¸å¾—ä¸æ‰¿è®¤ viper çš„å®žçŽ°ç¡®å®žæ˜¯å¾ˆæµå¼Šçš„ã€‚åœ¨ä¸€èˆ¬çš„å¿«é€Ÿå¼€å‘è¿‡ç¨‹ä¸­ï¼Œç›´æŽ¥ä½¿ç”¨ viper ç¡®å®žå¯ä»¥å¸®åŠ©æˆ‘ä»¬çœåŽ»å¾ˆå¤šçš„éº»çƒ¦ï¼Œè®©æˆ‘ä»¬é›†ä¸­ç²¾åŠ›é’ˆå¯¹äºŽä¸šåŠ¡é€»è¾‘çš„å®žçŽ°ã€‚ ä¸ªäººè§‰å¾—å¯ä»¥æ ¹æ®å®žé™…éœ€æ±‚åœ¨ viper å†è¿›è¡Œä¸€å±‚å°è£…ï¼ŒæŽ¥å…¥ä¸€äº›å¸¸ç”¨çš„ç¬¬ä¸‰æ–¹å¹³å°çš„ sdkï¼ˆgithubï¼Œaliyun ossâ€¦ï¼‰, è¿™æ ·å³å¯ä»¥è¯»å–æœ¬åœ°é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥è¯»å–è¿œç«¯çš„é…ç½®æ–‡ä»¶ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥å®žçŽ° dev æ¨¡å¼å’Œ deploy æ¨¡å¼çš„åˆ‡æ¢ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä½¿ç”¨swaggoè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£]]></title>
    <url>%2F2019%2F12%2F10%2F%E4%BD%BF%E7%94%A8swaggo%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90API%E6%96%87%E6%A1%A3%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡è½¬è½½è‡ªï¼š https://razeencheng.com/post/go-swagger.html ç›¸ä¿¡å¾ˆå¤šç¨‹åºçŒ¿å’Œæˆ‘ä¸€æ ·ä¸å–œæ¬¢å†™APIæ–‡æ¡£ã€‚å†™ä»£ç å¤šèˆ’æœï¼Œå†™æ–‡æ¡£ä¸ä»…è¦èŠ±è´¹å¤§é‡çš„æ—¶é—´ï¼Œæœ‰æ—¶å€™è¿˜ä¸èƒ½åšåˆ°é¢é¢å…·å…¨ã€‚ä½†APIæ–‡æ¡£æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œç›¸ä¿¡å…¶é‡è¦æ€§å°±ä¸ç”¨æˆ‘è¯´äº†ï¼Œä¸€ä»½å«ç³Šçš„æ–‡æ¡£ç”šè‡³èƒ½è®©å‰åŽç«¯äººå‘˜æ‰“èµ·æ¥ã€‚ è€Œä»Šå¤©è¿™ç¯‡åšå®¢ä»‹ç»çš„swaggoå°±æ˜¯è®©ä½ åªéœ€è¦ä¸“æ³¨äºŽä»£ç å°±å¯ä»¥ç”Ÿæˆå®Œç¾ŽAPIæ–‡æ¡£çš„å·¥å…·ã€‚åºŸè¯è¯´çš„æœ‰ç‚¹å¤šï¼Œæˆ‘ä»¬ç›´æŽ¥çœ‹æ–‡ç« ã€‚ å¤§æ¦‚æœ€åŽæ–‡æ¡£æ•ˆæžœæ˜¯è¿™æ ·çš„ï¼š å…³äºŽSwaggoæˆ–è®¸ä½ ä½¿ç”¨è¿‡Swagger, è€Œ swaggoå°±æ˜¯ä»£æ›¿äº†ä½ æ‰‹åŠ¨ç¼–å†™yamlçš„éƒ¨åˆ†ã€‚åªè¦é€šè¿‡ä¸€ä¸ªå‘½ä»¤å°±å¯ä»¥å°†æ³¨é‡Šè½¬æ¢æˆæ–‡æ¡£ï¼Œè¿™è®©æˆ‘ä»¬å¯ä»¥æ›´åŠ ä¸“æ³¨äºŽä»£ç ã€‚ ç›®å‰swaggoä¸»è¦å®žçŽ°äº†swagger 2.0 çš„ä»¥ä¸‹éƒ¨åˆ†åŠŸèƒ½ï¼š åŸºæœ¬ç»“æž„ï¼ˆBasic Structureï¼‰ API åœ°å€ä¸ŽåŸºæœ¬è·¯å¾„ï¼ˆAPI Host and Base Pathï¼‰ è·¯å¾„ä¸Žæ“ä½œ ï¼ˆPaths and Operationsï¼‰ å‚æ•°æè¿°ï¼ˆDescribing Parametersï¼‰ è¯·æ±‚å‚æ•°æè¿°ï¼ˆDescribing Request Bodyï¼‰ è¿”å›žæè¿°ï¼ˆDescribing Responsesï¼‰ MIME ç±»åž‹ï¼ˆMIME Typesï¼‰ è®¤è¯ï¼ˆAuthenticationï¼‰ Basic Authentication API Keys æ·»åŠ å®žä¾‹ï¼ˆAdding Examplesï¼‰ æ–‡ä»¶ä¸Šä¼ ï¼ˆFile Uploadï¼‰ æžšä¸¾ï¼ˆEnumsï¼‰ æŒ‰æ ‡ç­¾åˆ†ç»„ï¼ˆGrouping Operations With Tagsï¼‰ æ‰©å±•ï¼ˆSwagger Extensionsï¼‰ ä¸‹æ–‡å†…å®¹å‡ä»¥gin-swaggoä¸ºä¾‹ è¿™é‡Œæ˜¯demoåœ°å€ ä½¿ç”¨å®‰è£…swag cli åŠä¸‹è½½ç›¸å…³åŒ…è¦ä½¿ç”¨swaggo,é¦–å…ˆéœ€è¦å®‰è£…swag cliã€‚ å¤åˆ¶ 1go get -u github.com/swaggo/swag/cmd/swag ç„¶åŽæˆ‘ä»¬è¿˜éœ€è¦ä¸¤ä¸ªåŒ…ã€‚ å¤åˆ¶ 1234# gin-swagger ä¸­é—´ä»¶go get github.com/swaggo/gin-swagger# swagger å†…ç½®æ–‡ä»¶go get github.com/swaggo/gin-swagger/swaggerFiles åœ¨main.goå†…æ·»åŠ æ³¨é‡Šå¤åˆ¶ 1234567891011121314151617181920212223242526272829303132333435363738394041424344package mainimport ( &quot;github.com/gin-gonic/gin&quot; ginSwagger &quot;github.com/swaggo/gin-swagger&quot; &quot;github.com/swaggo/gin-swagger/swaggerFiles&quot;)// @title Swagger Example API// @version 1.0// @description This is a sample server celler server.// @termsOfService https://razeen.me// @contact.name Razeen// @contact.url https://razeen.me// @contact.email me@razeen.me// @license.name Apache 2.0// @license.url http://www.apache.org/licenses/LICENSE-2.0.html// @host 127.0.0.1:8080// @BasePath /api/v1func main() &#123; r := gin.Default() store := sessions.NewCookieStore([]byte(&quot;secret&quot;)) r.Use(sessions.Sessions(&quot;mysession&quot;, store)) r.GET(&quot;/swagger/*any&quot;, ginSwagger.WrapHandler(swaggerFiles.Handler)) v1 := r.Group(&quot;/api/v1&quot;) &#123; v1.GET(&quot;/hello&quot;, HandleHello) v1.POST(&quot;/login&quot;, HandleLogin) v1Auth := r.Use(HandleAuth) &#123; v1Auth.POST(&quot;/upload&quot;, HandleUpload) v1Auth.GET(&quot;/list&quot;, HandleList) &#125; &#125; r.Run(&quot;:8080&quot;)&#125; å¦‚ä¸Šæ‰€ç¤ºï¼Œæˆ‘ä»¬éœ€è¦å¯¼å…¥ å¤åˆ¶ 12ginSwagger &quot;github.com/swaggo/gin-swagger&quot;&quot;github.com/swaggo/gin-swagger/swaggerFiles&quot; åŒæ—¶ï¼Œæ·»åŠ æ³¨é‡Šã€‚å…¶ä¸­ï¼š titile: æ–‡æ¡£æ ‡é¢˜ version: ç‰ˆæœ¬ description,termsOfService,contact ... è¿™äº›éƒ½æ˜¯ä¸€äº›å£°æ˜Žï¼Œå¯ä¸å†™ã€‚ license.name é¢ï¼Œè¿™ä¸ªæ˜¯å¿…é¡»çš„ã€‚ host,BasePath: å¦‚æžœä½ æƒ³ç›´æŽ¥swaggerè°ƒè¯•APIï¼Œè¿™ä¸¤é¡¹éœ€è¦å¡«å†™æ­£ç¡®ã€‚å‰è€…ä¸ºæœåŠ¡æ–‡æ¡£çš„ç«¯å£ï¼Œipã€‚åŽè€…ä¸ºåŸºç¡€è·¯å¾„ï¼Œåƒæˆ‘è¿™é‡Œå°±æ˜¯â€œ/api/v1â€ã€‚ åœ¨åŽŸæ–‡æ¡£ä¸­è¿˜æœ‰securityDefinitions.basic,securityDefinitions.apikeyç­‰ï¼Œè¿™äº›éƒ½æ˜¯ç”¨æ¥åšè®¤è¯çš„ï¼Œæˆ‘è¿™é‡Œæš‚ä¸å±•å¼€ã€‚ åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬åœ¨mian.goåŒç›®å½•ä¸‹æ‰§è¡Œswag initå°±å¯ä»¥è‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£ï¼Œå¦‚ä¸‹ï¼š å¤åˆ¶ 1234âžœ swaggo-gin git:(master) âœ— swag init2019/01/12 21:29:14 Generate swagger docs....2019/01/12 21:29:14 Generate general API Info2019/01/12 21:29:14 create docs.go at docs/docs.go ç„¶åŽæˆ‘ä»¬å¯¼å…¥è¿™ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„docsåŒ…ï¼Œè¿è¡Œï¼š å¤åˆ¶ 12345678910111213package mainimport ( &quot;github.com/gin-gonic/gin&quot; ginSwagger &quot;github.com/swaggo/gin-swagger&quot; &quot;github.com/swaggo/gin-swagger/swaggerFiles&quot; _ &quot;github.com/razeencheng/demo-go/swaggo-gin/docs&quot;)// @title Swagger Example API// @version 1.0// ... å¤åˆ¶ 1234567891011121314âžœ swaggo-gin git:(master) âœ— go buildâžœ swaggo-gin git:(master) âœ— ./swaggo-gin[GIN-debug] [WARNING] Creating an Engine instance with the Logger and Recovery middleware already attached.[GIN-debug] [WARNING] Running in &quot;debug&quot; mode. Switch to &quot;release&quot; mode in production. - using env: export GIN_MODE=release - using code: gin.SetMode(gin.ReleaseMode)[GIN-debug] GET /api/v1/hello --&gt; main.HandleHello (3 handlers)[GIN-debug] POST /api/v1/login --&gt; main.HandleLogin (3 handlers)[GIN-debug] POST /upload --&gt; main.HandleUpload (4 handlers)[GIN-debug] GET /list --&gt; main.HandleList (4 handlers)[GIN-debug] GET /swagger/*any --&gt; github.com/swaggo/gin-swagger.WrapHandler.func1 (4 handlers)[GIN-debug] Listening and serving HTTP on :8080 æµè§ˆå™¨æ‰“å¼€http://127.0.0.1:8080/swagger/index.html, æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¦‚ä¸‹æ–‡æ¡£æ ‡é¢˜å·²ç»ç”Ÿæˆã€‚ åœ¨Handleå‡½æ•°ä¸Šæ·»åŠ æ³¨é‡ŠæŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦åœ¨æ¯ä¸ªè·¯ç”±å¤„ç†å‡½æ•°ä¸ŠåŠ ä¸Šæ³¨é‡Šï¼Œå¦‚ï¼š å¤åˆ¶ 12345678910111213141516171819// @Summary æµ‹è¯•SayHello// @Description å‘ä½ è¯´Hello// @Tags æµ‹è¯•// @Accept mpfd// @Produce json// @Param who query string true &quot;äººå&quot;// @Success 200 &#123;string&#125; json &quot;&#123;&quot;msg&quot;: &quot;hello Razeen&quot;&#125;&quot;// @Failure 400 &#123;string&#125; json &quot;&#123;&quot;msg&quot;: &quot;who are you&quot;&#125;&quot;// @Router /hello [get]func HandleHello(c *gin.Context) &#123; who := c.Query(&quot;who&quot;) if who == &quot;&quot; &#123; c.JSON(http.StatusBadRequest, gin.H&#123;&quot;msg&quot;: &quot;who are u?&quot;&#125;) return &#125; c.JSON(http.StatusOK, gin.H&#123;&quot;msg&quot;: &quot;hello &quot; + who&#125;)&#125; æˆ‘ä»¬å†æ¬¡swag init, è¿è¡Œä¸€ä¸‹ã€‚ æ­¤æ—¶ï¼Œè¯¥APIçš„ç›¸å…³æè¿°å·²ç»ç”Ÿæˆäº†ï¼Œæˆ‘ä»¬ç‚¹å‡»Try it outè¿˜å¯ä»¥ç›´æŽ¥æµ‹è¯•è¯¥APIã€‚ æ˜¯ä¸æ˜¯å¾ˆå¥½ç”¨ï¼Œå½“ç„¶è¿™å¹¶æ²¡æœ‰ç»“æŸï¼Œè¿™äº›æ³¨é‡Šå­—æ®µï¼Œæˆ‘ä»¬ä¸€ä¸ªä¸ªè§£é‡Šã€‚ è¿™äº›æ³¨é‡Šå¯¹åº”å‡ºçŽ°åœ¨APIæ–‡æ¡£çš„ä½ç½®ï¼Œæˆ‘åœ¨ä¸Šå›¾ä¸­å·²ç»æ ‡å‡ºï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è¯¦ç»†è¯´è¯´ä¸‹é¢å‚æ•°ï¼š TagsTags æ˜¯ç”¨æ¥ç»™APIåˆ†ç»„çš„ã€‚ AcceptæŽ¥æ”¶çš„å‚æ•°ç±»åž‹ï¼Œæ”¯æŒè¡¨å•(mpfd) å’Œ JSON(json) Produceè¿”å›žçš„æ•°æ®ç»“æž„ï¼Œä¸€èˆ¬éƒ½æ˜¯json, å…¶ä»–æ”¯æŒå¦‚ä¸‹è¡¨ï¼š Mime Type å£°æ˜Ž application/json json text/xml xml text/plain plain html html multipart/form-data mpfd application/x-www-form-urlencoded x-www-form-urlencoded application/vnd.api+json json-api application/x-json-stream json-stream application/octet-stream octet-stream image/png png image/jpeg jpeg image/gif gif Paramå‚æ•°ï¼Œä»Žå‰å¾€åŽåˆ†åˆ«æ˜¯ï¼š @Param 1.å‚æ•°å 2.å‚æ•°ç±»åž‹ 3.å‚æ•°æ•°æ®ç±»åž‹ 4.æ˜¯å¦å¿…é¡» 5.å‚æ•°æè¿° 6.å…¶ä»–å±žæ€§ 1.å‚æ•°å å‚æ•°åå°±æ˜¯æˆ‘ä»¬è§£é‡Šå‚æ•°çš„åå­—ã€‚ 2.å‚æ•°ç±»åž‹ å‚æ•°ç±»åž‹ä¸»è¦æœ‰å››ç§ï¼š path è¯¥ç±»åž‹å‚æ•°ç›´æŽ¥æ‹¼æŽ¥åœ¨URLä¸­ï¼Œå¦‚Demoä¸­HandleGetFileï¼š å¤åˆ¶ 1// @Param id path integer true &quot;æ–‡ä»¶ID&quot; query è¯¥ç±»åž‹å‚æ•°ä¸€èˆ¬æ˜¯ç»„åˆåœ¨URLä¸­çš„ï¼Œå¦‚Demoä¸­HandleHello å¤åˆ¶ 1// @Param who query string true &quot;äººå&quot; formData è¯¥ç±»åž‹å‚æ•°ä¸€èˆ¬æ˜¯POST,PUTæ–¹æ³•æ‰€ç”¨ï¼Œå¦‚Demoä¸­HandleLogin å¤åˆ¶ 1// @Param user formData string true &quot;ç”¨æˆ·å&quot; default(admin) body å½“Acceptæ˜¯JSONæ ¼å¼æ—¶ï¼Œæˆ‘ä»¬ä½¿ç”¨è¯¥å­—æ®µæŒ‡å®šæŽ¥æ”¶çš„JSONç±»åž‹ å¤åˆ¶ 1// @Param param body main.JSONParams true &quot;éœ€è¦ä¸Šä¼ çš„JSON&quot; 3.å‚æ•°æ•°æ®ç±»åž‹ æ•°æ®ç±»åž‹ä¸»è¦æ”¯æŒä¸€ä¸‹å‡ ç§ï¼š string (string) integer (int, uint, uint32, uint64) number (float32) boolean (bool) æ³¨æ„ï¼Œå¦‚æžœä½ æ˜¯ä¸Šä¼ æ–‡ä»¶å¯ä»¥ä½¿ç”¨file, ä½†å‚æ•°ç±»åž‹ä¸€å®šæ˜¯formData, å¦‚ä¸‹ï¼š å¤åˆ¶ 1// @Param file formData file true &quot;æ–‡ä»¶&quot; 4.æ˜¯å¦æ˜¯å¿…é¡» è¡¨æ˜Žè¯¥å‚æ•°æ˜¯å¦æ˜¯å¿…é¡»éœ€è¦çš„ï¼Œå¿…é¡»çš„åœ¨æ–‡æ¡£ä¸­ä¼šé»‘ä½“æ ‡å‡ºï¼Œæµ‹è¯•æ—¶å¿…é¡»å¡«å†™ã€‚ 5.å‚æ•°æè¿° å°±æ˜¯å‚æ•°çš„ä¸€äº›è¯´æ˜Ž 6.å…¶ä»–å±žæ€§ é™¤äº†ä¸Šé¢è¿™äº›å±žæ€§å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥ä¸ºè¯¥å‚æ•°å¡«å†™ä¸€äº›é¢å¤–çš„å±žæ€§ï¼Œå¦‚æžšä¸¾ï¼Œé»˜è®¤å€¼ï¼Œå€¼èŒƒå›´ç­‰ã€‚å¦‚ä¸‹ï¼š å¤åˆ¶ 1234567891011æžšä¸¾// @Param enumstring query string false &quot;string enums&quot; Enums(A, B, C)// @Param enumint query int false &quot;int enums&quot; Enums(1, 2, 3)// @Param enumnumber query number false &quot;int enums&quot; Enums(1.1, 1.2, 1.3)å€¼æ·»åŠ èŒƒå›´// @Param string query string false &quot;string valid&quot; minlength(5) maxlength(10)// @Param int query int false &quot;int valid&quot; mininum(1) maxinum(10)è®¾ç½®é»˜è®¤å€¼// @Param default query string false &quot;string default&quot; default(A) è€Œä¸”è¿™äº›å‚æ•°æ˜¯å¯ä»¥ç»„åˆä½¿ç”¨çš„ï¼Œå¦‚ï¼š å¤åˆ¶ 1// @Param enumstring query string false &quot;string enums&quot; Enums(A, B, C) default(A) SuccessæŒ‡å®šæˆåŠŸå“åº”çš„æ•°æ®ã€‚æ ¼å¼ä¸ºï¼š // @Success 1.HTTPå“åº”ç  {2.å“åº”å‚æ•°ç±»åž‹} 3.å“åº”æ•°æ®ç±»åž‹ 4.å…¶ä»–æè¿° 1.HTTPå“åº”ç  ä¹Ÿå°±æ˜¯200ï¼Œ400ï¼Œ500é‚£äº›ã€‚ 2.å“åº”å‚æ•°ç±»åž‹ / 3.å“åº”æ•°æ®ç±»åž‹ è¿”å›žçš„æ•°æ®ç±»åž‹ï¼Œå¯ä»¥æ˜¯è‡ªå®šä¹‰ç±»åž‹ï¼Œå¯ä»¥æ˜¯jsonã€‚ è‡ªå®šä¹‰ç±»åž‹ åœ¨å¹³å¸¸çš„ä½¿ç”¨ä¸­ï¼Œæˆ‘éƒ½ä¼šè¿”å›žä¸€äº›æŒ‡å®šçš„æ¨¡åž‹åºåˆ—åŒ–JSONçš„æ•°æ®ï¼Œè¿™æ—¶ï¼Œå°±å¯ä»¥è¿™ä¹ˆå†™ï¼š å¤åˆ¶ 1// @Success 200 &#123;object&#125; main.File å…¶ä¸­ï¼Œæ¨¡åž‹ç›´æŽ¥ç”¨åŒ…å.æ¨¡åž‹å³å¯ã€‚ä½ ä¼šè¯´ï¼Œå‡å¦‚æˆ‘è¿”å›žæ¨¡åž‹æ•°ç»„æ€Žä¹ˆåŠžï¼Ÿè¿™æ—¶ä½ å¯ä»¥è¿™ä¹ˆå†™ï¼š å¤åˆ¶ 1// @Success 200 &#123;anrry&#125; main.File json å°†å¦‚ä½ åªæ˜¯è¿”å›žå…¶ä»–çš„jsonæ•°æ®å¯å¦‚ä¸‹å†™ï¼š å¤åˆ¶ 1// @Success 200 &#123;string&#125; json &quot;&quot; 4.å…¶ä»–æè¿° å¯ä»¥æ·»åŠ ä¸€äº›è¯´æ˜Žã€‚ Failure åŒSuccessã€‚ Router æŒ‡å®šè·¯ç”±ä¸ŽHTTPæ–¹æ³•ã€‚æ ¼å¼ä¸ºï¼š // @Router /path/to/handle [HTTPæ–¹æ³•] ä¸ç”¨åŠ åŸºç¡€è·¯å¾„å“¦ã€‚ ç”Ÿæˆæ–‡æ¡£ä¸Žæµ‹è¯•å…¶å®žä¸Šé¢å·²ç»ç©¿æ’çš„ä»‹ç»äº†ã€‚ åœ¨main.goä¸‹è¿è¡Œswag initå³å¯ç”Ÿæˆå’Œæ›´æ–°æ–‡æ¡£ã€‚ ç‚¹å‡»æ–‡æ¡£ä¸­çš„Try it outå³å¯æµ‹è¯•ã€‚ å¦‚æžœéƒ¨åˆ†APIéœ€è¦ç™»é™†ï¼Œå¯ä»¥Tryç™»é™†æŽ¥å£å³å¯ã€‚ ä¼˜åŒ–çœ‹åˆ°è¿™é‡Œï¼ŒåŸºæœ¬å¯ä»¥ä½¿ç”¨äº†ã€‚ä½†æ–‡æ¡£ä¸€èˆ¬åªæ˜¯æˆ‘ä»¬æµ‹è¯•çš„æ—¶å€™éœ€è¦ï¼Œå½“æˆ‘çš„äº§å“ä¸Šçº¿åŽï¼ŒæŽ¥å£æ–‡æ¡£æ˜¯ä¸åº”è¯¥ç»™ç”¨æˆ·çš„ï¼Œè€Œä¸”å¸¦æœ‰æŽ¥å£æ–‡æ¡£çš„åŒ…ä¹Ÿä¼šå¤§å¾ˆå¤šï¼ˆswaggoæ˜¯ç›´æŽ¥buildåˆ°äºŒè¿›åˆ¶é‡Œçš„ï¼‰ã€‚ æƒ³è¦å¤„ç†è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ç¼–è¯‘çš„æ—¶å€™ä¼˜åŒ–ä¸€ä¸‹ï¼Œå¦‚åˆ©ç”¨build tagæ¥æŽ§åˆ¶æ˜¯å¦ç¼–è¯‘æ–‡æ¡£ã€‚ åœ¨main.goå£°æ˜ŽswagHandler,å¹¶åœ¨è¯¥å‚æ•°ä¸ä¸ºç©ºæ—¶æ‰åŠ å…¥è·¯ç”±ï¼š å¤åˆ¶ 123456789101112131415package main//...var swagHandler gin.HandlerFuncfunc main()&#123; // ... if swagHandler != nil &#123; r.GET(&quot;/swagger/*any&quot;, swagHandler) &#125; //...&#125; åŒæ—¶,æˆ‘ä»¬å°†è¯¥å‚æ•°åœ¨å¦å¤–åŠ äº†build tagçš„åŒ…ä¸­åˆå§‹åŒ–ã€‚ å¤åˆ¶ 1234567891011121314// +build docpackage mainimport ( _ &quot;github.com/razeencheng/demo-go/swaggo-gin/docs&quot; ginSwagger &quot;github.com/swaggo/gin-swagger&quot; &quot;github.com/swaggo/gin-swagger/swaggerFiles&quot;)func init() &#123; swagHandler = ginSwagger.WrapHandler(swaggerFiles.Handler)&#125; ä¹‹åŽæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨go build -tags &quot;doc&quot;æ¥æ‰“åŒ…å¸¦æ–‡æ¡£çš„åŒ…ï¼Œç›´æŽ¥go buildæ¥æ‰“åŒ…ä¸å¸¦æ–‡æ¡£çš„åŒ…ã€‚ ä½ ä¼šå‘çŽ°ï¼Œå³ä½¿æˆ‘è¿™ä¹ˆå°çš„Demo,ç¼–è¯‘åŽçš„å¤§å°ä¹Ÿè¦ç›¸å·®19M ! å¤åˆ¶ 123456âžœ swaggo-gin git:(master) âœ— go buildâžœ swaggo-gin git:(master) âœ— ll swaggo-gin-rwxr-xr-x 1 xxx staff 15M Jan 13 00:23 swaggo-ginâžœ swaggo-gin git:(master) âœ— go build -tags &quot;doc&quot;âžœ swaggo-gin git:(master) âœ— ll swaggo-gin-rwxr-xr-x 1 xxx staff 34M Jan 13 00:24 swaggo-gin æ–‡ç« åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ï¼Œå®Œæ•´çš„Demoåœ°å€åœ¨è¿™é‡Œã€‚ ç›¸å…³é“¾æŽ¥ Swaggo Github Swagger]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>go</tag>
        <tag>swagger</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangå¼€å‘æ•ˆçŽ‡ç¥žå¥‡æ±‡æ€»]]></title>
    <url>%2F2019%2F12%2F06%2Fgolang%E5%BC%80%E5%8F%91%E6%95%88%E7%8E%87%E7%A5%9E%E5%A5%87%E6%B1%87%E6%80%BB%2F</url>
    <content type="text"><![CDATA[ä¸€. å¼€å‘å·¥å…·1)sql2goç”¨äºŽå°† sql è¯­å¥è½¬æ¢ä¸º golang çš„ struct. ä½¿ç”¨ ddl è¯­å¥å³å¯ã€‚ä¾‹å¦‚å¯¹äºŽåˆ›å»ºè¡¨çš„è¯­å¥: show create table xxx. å°†è¾“å‡ºçš„è¯­å¥ï¼Œç›´æŽ¥ç²˜è´´è¿›åŽ»å°±è¡Œã€‚http://stming.cn/tool/sql2go.html 2)toml2goç”¨äºŽå°†ç¼–ç åŽçš„ toml æ–‡æœ¬è½¬æ¢é—® golang çš„ struct.https://xuri.me/toml-to-go/ 3)curl2goç”¨æ¥å°† curl å‘½ä»¤è½¬åŒ–ä¸ºå…·ä½“çš„ golang ä»£ç .https://mholt.github.io/curl-to-go/ 4)json2goç”¨äºŽå°† json æ–‡æœ¬è½¬æ¢ä¸º struct.https://mholt.github.io/json-to-go/ 5)mysql è½¬ ES å·¥å…·http://www.ischoolbar.com/EsParser/ 6)golangæ¨¡æ‹Ÿæ¨¡æ¿çš„å·¥å…·ï¼Œåœ¨æ”¯æŒæ³›åž‹ä¹‹å‰ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨ã€‚https://github.com/cheekybits/genny 7)æŸ¥çœ‹æŸä¸€ä¸ªåº“çš„ä¾èµ–æƒ…å†µï¼Œç±»ä¼¼äºŽ go list åŠŸèƒ½https://github.com/KyleBanks/depth 8)ä¸€ä¸ªå¥½ç”¨çš„æ–‡ä»¶åŽ‹ç¼©å’Œè§£åŽ‹å·¥å…·ï¼Œé›†æˆäº† zipï¼Œtar ç­‰å¤šç§åŠŸèƒ½ï¼Œä¸»è¦è¿˜æœ‰è·¨å¹³å°ã€‚https://github.com/mholt/archiver 9)go å†…ç½®å‘½ä»¤go list å¯ä»¥æŸ¥çœ‹æŸä¸€ä¸ªåŒ…çš„ä¾èµ–å…³ç³».go vet å¯ä»¥æ£€æŸ¥ä»£ç ä¸ç¬¦åˆ golang è§„èŒƒçš„åœ°æ–¹ã€‚ 10)çƒ­ç¼–è¯‘å·¥å…·https://github.com/silenceper/gowatch 11)revivegolang ä»£ç è´¨é‡æ£€æµ‹å·¥å…·https://github.com/mgechev/revive 12)Go Callvisgolang çš„ä»£ç è°ƒç”¨é“¾å›¾å·¥å…·https://github.com/TrueFurby/go-callvis 13)Realizeå¼€å‘æµç¨‹æ”¹è¿›å·¥å…·https://github.com/oxequa/realize 14)Gotestsè‡ªåŠ¨ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹å·¥å…·https://github.com/cweill/gotests äºŒ.è°ƒè¯•å·¥å…·1)perfä»£ç†å·¥å…·ï¼Œæ”¯æŒå†…å­˜ï¼Œcpuï¼Œå †æ ˆæŸ¥çœ‹ï¼Œå¹¶æ”¯æŒç«ç„°å›¾.perf å·¥å…·å’Œ go-torch å·¥å…·ï¼Œå¿«æ·å®šä½ç¨‹åºé—®é¢˜.https://github.com/uber-archive/go-torchhttps://github.com/google/gops 2)dlv è¿œç¨‹è°ƒè¯•åŸºäºŽ goland+dlv å¯ä»¥å®žçŽ°è¿œç¨‹è°ƒå¼çš„èƒ½åŠ›.https://github.com/go-delve/delveæä¾›äº†å¯¹ golang åŽŸç”Ÿçš„æ”¯æŒï¼Œç›¸æ¯” gdb è°ƒè¯•ï¼Œç®€å•å¤ªå¤šã€‚ 3)ç½‘ç»œä»£ç†å·¥å…·goproxy ä»£ç†ï¼Œæ”¯æŒå¤šç§åè®®ï¼Œæ”¯æŒ ssh ç©¿é€å’Œ kcp åè®®.https://github.com/snail007/goproxy 4)æŠ“åŒ…å·¥å…·go-sniffer å·¥å…·ï¼Œå¯æ‰©å±•çš„æŠ“åŒ…å·¥å…·ï¼Œå¯ä»¥å¼€å‘è‡ªå®šä¹‰åè®®çš„å·¥å…·åŒ…. çŽ°åœ¨åªæ”¯æŒäº† httpï¼Œmysqlï¼Œredisï¼Œmongodb.åŸºäºŽè¿™ä¸ªå·¥å…·ï¼Œæˆ‘ä»¬å¼€å‘äº† qapp åè®®çš„æŠ“åŒ…ã€‚https://github.com/40t/go-sniffer 5)åå‘ä»£ç†å·¥å…·ï¼Œå¿«æ·å¼€æ”¾å†…ç½‘ç«¯å£ä¾›å¤–éƒ¨ä½¿ç”¨ã€‚ngrok å¯ä»¥è®©å†…ç½‘æœåŠ¡å¤–éƒ¨è°ƒç”¨https://ngrok.com/https://github.com/inconshreveable/ngrok 6)é…ç½®åŒ–ç”Ÿæˆè¯ä¹¦ä»Žæ ¹è¯ä¹¦ï¼Œåˆ°ä¸šåŠ¡ä¾§è¯ä¹¦ä¸€é”®ç”Ÿæˆ.https://github.com/cloudflare/cfssl 7)å…è´¹çš„è¯ä¹¦èŽ·å–å·¥å…·åŸºäºŽ acme åè®®ï¼Œä»Ž letsencrypt ç”Ÿæˆå…è´¹çš„è¯ä¹¦ï¼Œæœ‰æ•ˆæœŸ 1 å¹´ï¼Œå¯è‡ªåŠ¨ç»­æœŸã€‚https://github.com/Neilpang/acme.sh 8)å¼€å‘çŽ¯å¢ƒç®¡ç†å·¥å…·ï¼Œå•æœºæ­å»ºå¯ç§»æ¤å·¥å…·çš„åˆ©å™¨ã€‚æ”¯æŒå¤šç§è™šæ‹ŸæœºåŽç«¯ã€‚vagrantå¸¸è¢«æ‹¿æ¥åŒ docker ç›¸æ¯”ï¼Œå€¼å¾—æ‹¥æœ‰ã€‚https://github.com/hashicorp/vagrant 9)è½»é‡çº§å®¹å™¨è°ƒåº¦å·¥å…·nomad å¯ä»¥éžå¸¸æ–¹ä¾¿çš„ç®¡ç†å®¹å™¨å’Œä¼ ç»Ÿåº”ç”¨ï¼Œç›¸æ¯” k8s æ¥è¯´ï¼Œç®€å•ä¸è¦å¤ªå¤š.https://github.com/hashicorp/nomad 10)æ•æ„Ÿä¿¡æ¯å’Œå¯†é’¥ç®¡ç†å·¥å…·https://github.com/hashicorp/vault 11)é«˜åº¦å¯é…ç½®åŒ–çš„ http è½¬å‘å·¥å…·ï¼ŒåŸºäºŽ etcd é…ç½®ã€‚https://github.com/gojek/weaver 12)è¿›ç¨‹ç›‘æŽ§å·¥å…· supervisorhttps://www.jianshu.com/p/39b476e808d8 13)åŸºäºŽprocFileè¿›ç¨‹ç®¡ç†å·¥å…·. ç›¸æ¯” supervisor æ›´åŠ ç®€å•ã€‚https://github.com/ddollar/foreman 14)åŸºäºŽ httpï¼Œhttpsï¼Œwebsocket çš„è°ƒè¯•ä»£ç†å·¥å…·ï¼Œé…ç½®åŠŸèƒ½ä¸°å¯Œã€‚åœ¨çº¿æ•™è‚²çš„ nohost web è°ƒè¯•å·¥å…·ï¼ŒåŸºäºŽæ­¤å¼€å‘.https://github.com/avwo/whistle 15)åˆ†å¸ƒå¼è°ƒåº¦å·¥å…·https://github.com/shunfei/cronsun/blob/master/README_ZH.mdhttps://github.com/ouqiang/gocron 16)è‡ªåŠ¨åŒ–è¿ç»´å¹³å° Gaiahttps://github.com/gaia-pipeline/gaia ä¸‰. ç½‘ç»œå·¥å…· å››. å¸¸ç”¨ç½‘ç«™go ç™¾ç§‘å…¨ä¹¦: https://awesome-go.com/ json è§£æž: https://www.json.cn/ å‡ºå£ IP: https://ipinfo.io/ redis å‘½ä»¤: http://doc.redisfans.com/ ES å‘½ä»¤é¦–é¡µ: https://www.elastic.co/guide/cn/elasticsearch/guide/current/index.html UrlEncode: http://tool.chinaz.com/Tools/urlencode.aspx Base64: https://tool.oschina.net/encrypt?type=3 Guid: https://www.guidgen.com/ å¸¸ç”¨å·¥å…·: http://www.ofmonkey.com/ äº”. golang å¸¸ç”¨åº“æ—¥å¿—https://github.com/Sirupsen/logrushttps://github.com/uber-go/zap é…ç½®å…¼å®¹ jsonï¼Œtomlï¼Œyamlï¼Œhcl ç­‰æ ¼å¼çš„æ—¥å¿—åº“.https://github.com/spf13/viper å­˜å‚¨mysql: https://github.com/go-xorm/xormes: https://github.com/elastic/elasticsearchredis: https://github.com/gomodule/redigomongo: https://github.com/mongodb/mongo-go-driverkafka: https://github.com/Shopify/sarama æ•°æ®ç»“æž„https://github.com/emirpasic/gods å‘½ä»¤è¡Œhttps://github.com/spf13/cobra æ¡†æž¶https://github.com/grpc/grpc-gohttps://github.com/gin-gonic/gin å¹¶å‘https://github.com/Jeffail/tunnyhttps://github.com/benmanns/goworkerçŽ°åœ¨æˆ‘ä»¬æ¡†æž¶åœ¨ç”¨çš„ï¼Œè™½ç„¶ star ä¸å¤šï¼Œä½†æ˜¯ç¡®å®žå¥½ç”¨ï¼Œå½“ç„¶è¿˜å¯ä»¥æ›´å¥½ç”¨.https://github.com/rafaeldias/async å·¥å…·å®šä¹‰äº†å®žç”¨çš„åˆ¤å®šç±»ï¼Œä»¥åŠé’ˆå¯¹ç»“æž„ä½“çš„æ ¡éªŒé€»è¾‘ï¼Œé¿å…ä¸šåŠ¡ä¾§å†™å¤æ‚çš„ä»£ç .https://github.com/asaskevich/govalidatorhttps://github.com/bytedance/go-tagexpr protobuf æ–‡ä»¶åŠ¨æ€è§£æžçš„æŽ¥å£ï¼Œå¯ä»¥å®žçŽ°åå°„ç›¸å…³çš„èƒ½åŠ›ã€‚https://github.com/jhump/protoreflect è¡¨è¾¾å¼å¼•æ“Žå·¥å…·https://github.com/Knetic/govaluatehttps://github.com/google/cel-go å­—ç¬¦ä¸²å¤„ç†https://github.com/huandu/xstrings ratelimit å·¥å…·https://github.com/uber-go/ratelimithttps://blog.csdn.net/chenchongg/article/details/85342086https://github.com/juju/ratelimit golang ç†”æ–­çš„åº“ç†”æ–­é™¤äº†è€ƒè™‘é¢‘çŽ‡é™åˆ¶ï¼Œè¿˜è¦è€ƒè™‘ qpsï¼Œå‡ºé”™çŽ‡ç­‰å…¶ä»–ä¸œè¥¿.https://github.com/afex/hystrix-gohttps://github.com/sony/gobreaker è¡¨æ ¼https://github.com/chenjiandongx/go-echarts tail å·¥å…·åº“https://github.com/hpcloud/taglshi]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangè®¾è®¡æ¨¡å¼ä¹‹è£…é¥°å™¨æ¨¡å¼]]></title>
    <url>%2F2019%2F11%2F30%2Fgolang%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E4%B9%8B%E8%A3%85%E9%A5%B0%E5%99%A8%E6%A8%A1%E5%BC%8F%2F</url>
    <content type="text"><![CDATA[è£…é¥°å™¨è£…é¥°å™¨ç»“æž„æ¨¡å¼å…è®¸åŠ¨æ€åœ°æ‰©å±•çŽ°æœ‰å¯¹è±¡çš„åŠŸèƒ½ï¼Œè€Œä¸æ”¹å˜å…¶å†…éƒ¨ç»“æž„ã€‚ è£…é¥°å™¨æä¾›äº†ä¸€ç§çµæ´»çš„æ–¹æ³•æ¥æ‰©å±•å¯¹è±¡çš„åŠŸèƒ½ã€‚ golang å®žçŽ°ä¸‹é¢çš„LogDecorateç”¨signature funcï¼ˆintï¼‰intä¿®é¥°å‡½æ•°ï¼Œè¯¥å‡½æ•°æ“ä½œæ•´æ•°å¹¶æ·»åŠ è¾“å…¥/è¾“å‡ºæ—¥å¿—è®°å½•åŠŸèƒ½ã€‚ 12345678910111213type Object func(int) intfunc LogDecorate(fn Object) Object &#123; return func(n int) int &#123; log.Println("Starting the execution with the integer", n) result := fn(n) log.Println("Execution is completed with the result", result) return result &#125;&#125; å¦‚ä½•ä½¿ç”¨1234567func Double(n int) int &#123; return n*2&#125;f := LogDecorate(Double)f(5)//å‚æ•°ä¸º5ï¼Œå¼€å§‹æ‰§è¡Œ//æ‰§è¡Œçš„ç»“æžœæ˜¯10 ç»éªŒ ä¸Žé€‚é…å™¨æ¨¡å¼ä¸åŒï¼Œè¦ä¿®é¥°çš„å¯¹è±¡æ˜¯é€šè¿‡æ³¨å…¥èŽ·å¾—çš„ã€‚ è£…é¥°å™¨ä¸åº”æ›´æ”¹å¯¹è±¡çš„æŽ¥å£ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[github&Daocloudæ¼”è®²ç¨¿æ•´ç†ä¸Žæ€»ç»“]]></title>
    <url>%2F2019%2F11%2F23%2FgithubXDaocloud%E6%BC%94%E8%AE%B2%E7%A8%BF%E6%95%B4%E7%90%86%E4%B8%8E%E6%80%BB%E7%BB%93-md%2F</url>
    <content type="text"><![CDATA[å¤§å®¶ä¸‹åˆå¥½ï¼Œä»Šå¤©ç»™å¤§å®¶å¸¦æ¥çš„åˆ†äº«ä¸»é¢˜æ˜¯ golang çš„å†…å­˜åˆ†æžä»¥åŠä¼˜åŒ–ï¼Œä¸»è¦åˆ†ä¸ºä¸¤éƒ¨åˆ†å†…å®¹ï¼Œä¸€æ˜¯ ä»¥å¼€æºé¡¹ç›®crawlabçš„å†…å­˜åˆ†æžä¸Žä¼˜åŒ–ä¸ºä¾‹ï¼Œè®²è§£golangå†…å­˜è°ƒä¼˜çš„ä¸€äº›å·¥å…·å’Œåˆ†æžçš„è¿‡ç¨‹ï¼› ç¬¬äºŒéƒ¨åˆ†æ˜¯ä»‹ç»å¹³æ—¶å¼€å‘ä¸­å®¹æ˜“å¿½ç•¥çš„å’Œå®¹æ˜“å¸¦æ¥æ€§èƒ½é—®é¢˜çš„ç‚¹ï¼Œä»¥åŠå¦‚ä½•åŽ»ä¼˜åŒ–ã€‚ å½“æ—¶è¿™ä¸ªè¯é¢˜çš„çµæ„Ÿæ¥è‡ªä¸€ä¸ªå¼€æºé¡¹ç›® crawlab, crawlabæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦å¹³å°ï¼Œè¿™é‡Œä¸å±•å¼€è¯¦ç»†è§£é‡Šäº†ï¼Œå¤§å®¶æœ‰å…´è¶£å¯ä»¥åˆ°GitHubä¸»é¡µçœ‹ä¸€ä¸‹ï¼Œhttps://github.com/crawlab-team/crawlab å½“æ—¶æ˜¯æœ‰ç”¨æˆ·æŠ¥å‡ºcrawlabå¯åŠ¨ä¸€æ®µæ—¶é—´åŽï¼Œä¸»èŠ‚ç‚¹æœºå™¨ä¼šå‡ºçŽ°å†…å­˜å ç”¨è¿‡é«˜çš„é—®é¢˜ï¼Œä¸€å°4Gå†…å­˜çš„æœåŠ¡å™¨åœ¨è¿è¡ŒcrawlabåŽç«Ÿç„¶èƒ½å ç”¨3Gä»¥çš„å†…å­˜ï¼Œç„¶åŽæ•´ä¸ªmasterå°±ä¼šdownæŽ‰ï¼ŒäºŽæ˜¯æˆ‘å¼€å§‹å¯¹crawlabçš„åŽç«¯æœåŠ¡è¿›è¡Œæ€§èƒ½çš„åˆ†æžï¼Œä¸‹é¢å°†å¸¦å¤§å®¶å›žé¡¾è¿™ä¸€è¿‡ç¨‹ã€‚ é¦–å…ˆä»‹ç»ï¼ŒGolangçš„æ€§èƒ½åˆ†æžä¸»è¦åˆ†ä¸ºä¸¤ç§æ–¹å¼ï¼Œ ä¸€ç§æ˜¯é€šè¿‡æ–‡ä»¶æ–¹å¼è¾“å‡ºprofileï¼Œç‰¹ç‚¹æ˜¯çµæ´»æ€§é«˜ï¼Œé€‚ç”¨äºŽç‰¹å®šä»£ç ç‰‡æ®µçš„åˆ†æžï¼Œæˆ‘ä»¬é€šè¿‡è°ƒç”¨/runtimeåŒ…ä¸­çš„/pprofçš„APIç”Ÿæˆç›¸åº”çš„pprofæ–‡ä»¶ï¼Œç„¶åŽä½¿ç”¨ pprofå°±å¯ä»¥è¿›å…¥ç±»ä¼¼GDBçš„çª—å£ã€‚åœ¨è¿™ä¸ªçª—å£ä¸­ä½ å°±å¯ä»¥ç”¨top,list functionç­‰å‘½ä»¤åŽ»æŸ¥çœ‹cpu,memoryçš„çŠ¶å†µä»¥åŠgoroutineè¿è¡Œæƒ…å†µã€‚ ç¬¬äºŒç§æ–¹å¼å°±æ˜¯é€šè¿‡HTTPè¾“å‡ºprofileï¼Œ è¿™ç§æ–¹å¼å°±é€‚åˆäºŽä½ è¿˜ä¸æ¸…æ¥šåˆ°åº•å“ªä¸€æ®µä»£ç å‡ºçŽ°é—®é¢˜ï¼Œè€Œä¸”ä½ çš„åº”ç”¨è¦æŒç»­è¿è¡Œçš„æƒ…å†µã€‚åœ¨åˆ†æžcrawlabçš„æ—¶å€™ï¼Œé‡‡ç”¨çš„æ˜¯è¿™ç§æ–¹å¼ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨crawlabé¡¹ç›®ä¸­åµŒå…¥å¦‚ä¸‹å‡ è¡Œä»£ç ï¼Œå°†crawlabåŽç«¯æœåŠ¡å¯åŠ¨åŽï¼Œæµè§ˆå™¨ä¸­è¾“å…¥http://ip:8899/debug/pprof/å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æžé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼Œç‚¹å‡»heapï¼Œåœ¨æ±‡æ€»åˆ†æžé¡µé¢çš„æœ€ä¸Šæ–¹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ çº¢è‰²ç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯å½“å‰å·²ç»ä½¿ç”¨çš„å †å†…å­˜æ˜¯25M,ï¼åœ¨æˆ‘åªä¸Šä¼ ä¸€ä¸ªçˆ¬è™«æ–‡ä»¶ï¼Œè€Œä¸”è¿™ä¸ªæ–‡ä»¶è¿˜ä¸æ˜¯ç‰¹åˆ«æ‰“å¤§çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåŽç«¯æœåŠ¡æ‰€ç”¨çš„å†…å­˜ä½¿ç”¨ç«Ÿç„¶èƒ½è¾¾åˆ°25Mã€‚ æˆ‘ä»¬å†ç”¨è¿™ä¸ªå‘½ä»¤è¿›å…¥å‘½ä»¤è¡Œè¯¦ç»†çœ‹ä¸€ä¸‹ï¼Œè¿™ä¸ªå‘½ä»¤è¿›å…¥åŽï¼Œè¾“å…¥topå‘½ä»¤å¯ä»¥æ˜¾ç¤ºå‰10çš„å†…å­˜åˆ†é…ï¼Œflatæ˜¯å †æ ˆä¸­å½“å‰å±‚çš„inuseå†…å­˜å€¼ï¼Œcumæ˜¯å †æ ˆä¸­æœ¬å±‚çº§çš„ç´¯è®¡inuseå†…å­˜å€¼ã€‚ å¯ä»¥çœ‹åˆ°ï¼Œbytes.makeSliceè¿™ä¸ªå†…ç½®æ–¹æ³•ç«Ÿç„¶ä½¿ç”¨äº†24Må†…å­˜ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è€ƒè™‘è°ä¼šç”¨åˆ°makesliceå‘¢ï¼Œ ç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ReadFromè¿™ä¸ªæ–¹æ³•ï¼Œçœ‹ä¸‹æºç ï¼Œå‘çŽ° ioutil.ReadAll() é‡Œä¼šè°ƒç”¨ bytes.Buffer.ReadFrom, è€Œ ReadFrom ä¼šè¿›è¡Œ makeSliceã€‚è®©æˆ‘ä»¬å†å›žå¤´çœ‹ä¸€ä¸‹readAllçš„ä»£ç å®žçŽ°ï¼š è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯ä»Ž io.Reader é‡Œè¯»å–çš„æ•°æ®æ”¾å…¥ buffer ä¸­ï¼Œå¦‚æžœ buffer ç©ºé—´ä¸å¤Ÿï¼Œå°±æŒ‰ç…§æ¯æ¬¡ 2x æ‰€è¯»å–å†…å®¹çš„å¤§å°+ MinRead çš„ç®—æ³•é€’å¢žï¼Œè¿™é‡Œ MinRead çš„å¤§å°æ˜¯ 512 ä¸ªå­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æžœæˆ‘ä»¬ä¸€æ¬¡æ€§è¯»å–çš„å†…å®¹è¿‡å¤§ï¼Œå°±ä¼šå¯¼è‡´æ‰€ä½¿ç”¨çš„å†…å­˜å€å¢žï¼Œå‡è®¾æˆ‘ä»¬çš„æ‰€æœ‰ä»»åŠ¡æ–‡ä»¶æ€»å…±æœ‰500M,é‚£ä¹ˆæ‰€ç”¨çš„å†…å­˜å°±æœ‰500M * 2 + 512Bï¼Œæ‰€ä»¥æˆ‘ä»¬åˆ†æžå¾ˆå¯èƒ½æ˜¯è¿™ä¸ªåŽŸå› å¯¼è‡´çš„ï¼Œé‚£çœ‹çœ‹crawlabæºç ä¸­æ˜¯å“ªä¸€æ®µä½¿ç”¨ReadAllè¯»äº†æ–‡ä»¶ï¼Œå®šä½åˆ°äº†è¿™é‡Œ è¿™æ®µä»£ç ç›´æŽ¥å°†å…¨éƒ¨çš„æ–‡ä»¶å†…å®¹ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¯»äº†è¿›æ¥ï¼Œå¯¼è‡´å†…å­˜å€å¢žï¼Œä»¤äººçª’æ¯çš„æ“ä½œã€‚è‡³æ­¤ï¼Œé—®é¢˜å·²ç»å‘çŽ°ï¼Œé‚£ä¹ˆå¦‚ä½•åŽ»ä¼˜åŒ–å‘¢ï¼Œå…¶å®žåœ¨è¯»å¤§æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»åˆ°å†…å­˜ï¼Œç›´æŽ¥å°±ç¿»è½¦äº†ï¼Œæ­£ç¡®æ˜¯å¤„ç†æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æµå¼å¤„ç† ï¼Œå¦‚ä»£ç æ‰€ç¤º ç¬¬äºŒç§æ–¹æ¡ˆå°±æ˜¯åˆ†ç‰‡å¤„ç†ï¼Œå½“è¯»å–çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰æ¢è¡Œç¬¦çš„æ—¶å€™ï¼Œä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒåˆé€‚ã€‚ æˆ‘ä»¬è¿™é‡Œé‡‡ç”¨çš„ç¬¬äºŒç§æ–¹å¼æ¥ä¼˜åŒ–ï¼Œä¼˜åŒ–åŽå†æ¥çœ‹ä¸‹å†…å­˜å ç”¨æƒ…å†µ æˆ‘ä»¬é‡‡æ ·ç¨‹åºè¿è¡Œ30sçš„å¹³å‡å†…å­˜ï¼Œå¹¶ä¸”åœ¨æ­¤æœŸé—´è®¿é—®ä¸Šä¼ æ–‡ä»¶çš„æŽ¥å£åŽï¼Œçœ‹åˆ°å†…å­˜å ç”¨å·²ç»é™åˆ°æ­£å¸¸çš„æ°´å¹³äº†ã€‚ v åˆšåˆšæˆ‘ç”¨ä¸€ä¸ªå®žé™…æ¡ˆä¾‹ä»‹ç»äº†å¦‚ä½•åŽ»ä¸€æ­¥ä¸€æ­¥çš„åˆ†æžåŠä¼˜åŒ–goç¨‹åºçš„å†…å­˜é—®é¢˜ï¼Œå¤§å®¶å¯ä»¥åœ¨å¹³æ—¶å¼€å‘ä¸­å¤šåŽ»æŽ¢ç´¢ï¼Œå¤šä½¿ç”¨ã€‚ æŽ¥ä¸‹æ¥ä»‹ç»ä¸€äº›go å¼€å‘ä¸­çš„å°æŠ€å·§ï¼Œä»Žç»†èŠ‚ä¸Šæé«˜ä½ çš„golangåº”ç”¨ç¨‹åºçš„æ€§èƒ½ã€‚ ä¼—æ‰€å‘¨çŸ¥Json ä½œä¸ºä¸€ç§é‡è¦çš„æ•°æ®æ ¼å¼ï¼Œå¤§å®¶å¼€å‘è€…ç»å¸¸ç”¨åˆ°ã€‚Go è¯­è¨€é‡Œé¢åŽŸç”Ÿæ”¯æŒäº†jsonçš„åºåˆ—åŒ–ä»¥åŠååºåˆ—åŒ–ï¼Œå†…éƒ¨ä½¿ç”¨åå°„æœºåˆ¶å®žçŽ°ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“ï¼Œåå°„çš„æ€§èƒ½æœ‰ç‚¹å·®ï¼Œåœ¨é«˜åº¦ä¾èµ– json è§£æžçš„æŽ¥å£é‡Œï¼Œè¿™å¾€å¾€ä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œå¥½åœ¨å·²æœ‰å¾ˆå¤šç¬¬ä¸‰æ–¹åº“å¸®æˆ‘ä»¬è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è¿™ä¹ˆå¤šåº“ï¼Œåˆ°åº•è¦æ€Žä¹ˆé€‰æ‹©å‘¢ï¼Œä¸‹é¢å°±ç»™å¤§å®¶æ¥ä¸€ä¸€åˆ†æžä¸€ä¸‹ï¼Œè¿™é‡Œä»‹ç»4ä¸ªjsonåºåˆ—åŒ–ååºåˆ—åŒ–çš„åº“, çœ‹å®Œè¿™äº›ä½ å¯èƒ½ä¸çŸ¥é“åˆ°åº•è¯¥ç”¨å“ªä¸€ä¸ªï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸‹benchmark. â€‹ â€¢easyjson æ— è®ºæ˜¯åºåˆ—åŒ–è¿˜æ˜¯ååºåˆ—åŒ–éƒ½æ˜¯æœ€ä¼˜çš„ï¼Œåºåˆ—åŒ–æå‡äº†1å€ï¼Œååºåˆ—åŒ–æå‡äº†3å€ â€‹ â€¢jsoniter æ€§èƒ½ä¹Ÿå¾ˆå¥½ï¼ŒæŽ¥è¿‘äºŽeasyjsonï¼Œå…³é”®æ˜¯æ²¡æœ‰é¢„ç¼–è¯‘è¿‡ç¨‹ï¼Œ100%å…¼å®¹åŽŸç”Ÿåº“ â€‹ â€¢ffjson çš„åºåˆ—åŒ–æå‡å¹¶ä¸æ˜Žæ˜¾ï¼Œååºåˆ—åŒ–æå‡äº†1å€ æ‰€ä»¥ç»¼åˆè€ƒè™‘ï¼Œå»ºè®®å¤§å®¶ä½¿ç”¨ jsoniterï¼Œå¦‚æžœè¿½æ±‚æžè‡´çš„æ€§èƒ½ï¼Œè€ƒè™‘ easyjson å­—ç¬¦ä¸²æ‹¼æŽ¥åœ¨å¼€å‘ä¸­è‚¯å®šæ˜¯ç»å¸¸ç”¨åˆ°çš„ï¼Œå½“ä½ çš„åº”ç”¨ä¸­çš„æŸä¸€éƒ¨åˆ†å¤§é‡ç”¨åˆ°å­—ç¬¦ä¸²æ‹¼æŽ¥ï¼Œä½ æœ€å¥½ç•™æ„ä¸€ä¸‹ä¸‹é¢çš„å†…å®¹ã€‚æˆ‘ä»¬åˆ—ä¸¾4ä¸­å­—ç¬¦ä¸²æ‹¼æŽ¥çš„æ–¹å¼ï¼Œçœ‹çœ‹ä½ ç»å¸¸ç”¨çš„æ˜¯å“ªä¸ªï¼Ÿ ç¬¬ä¸€ç§ + å·è¿ç®—ç¬¦ï¼Œç¬¬äºŒç§æ˜¯golangç‰¹æœ‰çš„ä¸€ç§æ–¹å¼ï¼Œç¬¬ä¸‰ä¸­æ˜¯ strings.builder, æœ€åŽä¸€ç§æ˜¯strings.bufferã€‚ çœ‹ä¸‹benchmarkä½ å°±ä¼šåšå‡ºä½ æœ€ç»ˆçš„é€‰æ‹©ã€‚æ€§èƒ½æœ€å¥½çš„æ˜¯strings.builder,è€Œsprintfæ€§èƒ½æœ€å·®ï¼Œ+ å·è¿ç®—ç¬¦ä¹Ÿæ²¡å¥½åˆ°å“ªé‡ŒåŽ»ã€‚ ä»¥ä¸Šå°±æ˜¯æˆ‘ä»Šå¤©åˆ†äº«çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›èƒ½å¸®åŠ©åˆ°å¤§å®¶ï¼Œä¸‹é¢æ˜¯æˆ‘çš„è”ç³»æ–¹å¼ï¼Œæœ‰é—®é¢˜çš„å¯ä»¥çº¿ä¸‹ç»§ç»­äº¤æµã€‚è°¢è°¢ï¼]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>ç”Ÿæ´»</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golang cronä½¿ç”¨]]></title>
    <url>%2F2019%2F10%2F29%2Fgolang-cron%E4%BD%BF%E7%94%A8%2F</url>
    <content type="text"><![CDATA[Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£ æ›´æ–°æ—¶é—´ï¼š2018å¹´01æœˆ11æ—¥ 10:51:02 ä½œè€…ï¼šéª‘å¤´çŒªé€›è¡— æˆ‘è¦è¯„è®º æœ¬ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†Goå®šæ—¶å™¨cronçš„ä½¿ç”¨è¯¦è§£ï¼Œå°ç¼–è§‰å¾—æŒºä¸é”™çš„ï¼ŒçŽ°åœ¨åˆ†äº«ç»™å¤§å®¶ï¼Œä¹Ÿç»™å¤§å®¶åšä¸ªå‚è€ƒã€‚ä¸€èµ·è·Ÿéšå°ç¼–è¿‡æ¥çœ‹çœ‹å§ cronæ˜¯ä»€ä¹ˆ cronçš„æ„æ€å°±æ˜¯ï¼šè®¡åˆ’ä»»åŠ¡ï¼Œè¯´ç™½äº†å°±æ˜¯å®šæ—¶ä»»åŠ¡ã€‚æˆ‘å’Œç³»ç»Ÿçº¦ä¸ªæ—¶é—´ï¼Œä½ åœ¨å‡ ç‚¹å‡ åˆ†å‡ ç§’æˆ–è€…æ¯éš”å‡ åˆ†é’Ÿè·‘ä¸€ä¸ªä»»åŠ¡(job)ï¼Œå°±é‚£ä¹ˆç®€å•ã€‚ cronè¡¨è¾¾å¼ cronè¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå¥½ä¸œè¥¿ï¼Œè¿™ä¸ªä¸œè¥¿ä¸ä»…Javaçš„quartZèƒ½ç”¨åˆ°ï¼ŒGoè¯­è¨€ä¸­ä¹Ÿå¯ä»¥ç”¨åˆ°ã€‚æˆ‘æ²¡æœ‰ç”¨è¿‡Linuxçš„cronï¼Œä½†ç½‘ä¸Šè¯´Linuxä¹Ÿæ˜¯å¯ä»¥ç”¨crontab -e å‘½ä»¤æ¥é…ç½®å®šæ—¶ä»»åŠ¡ã€‚Goè¯­è¨€å’ŒJavaä¸­éƒ½æ˜¯å¯ä»¥ç²¾ç¡®åˆ°ç§’çš„ï¼Œä½†æ˜¯Linuxä¸­ä¸è¡Œã€‚ cronè¡¨è¾¾å¼ä»£è¡¨ä¸€ä¸ªæ—¶é—´çš„é›†åˆï¼Œä½¿ç”¨6ä¸ªç©ºæ ¼åˆ†éš”çš„å­—æ®µè¡¨ç¤ºï¼š å­—æ®µå æ˜¯å¦å¿…é¡» å…è®¸çš„å€¼ å…è®¸çš„ç‰¹å®šå­—ç¬¦ ç§’(Seconds) æ˜¯ 0-59 * / , - åˆ†(Minute) æ˜¯ 0-59 * / , - æ—¶(Hours) æ˜¯ 0-23 * / , - æ—¥(Day of month) æ˜¯ 1-31 * / , - ? æœˆ(Month) æ˜¯ 1-12 æˆ– JAN-DEC * / , - æ˜ŸæœŸ(Day of week) å¦ 0-6 æˆ– SUM-SAT * / , - ? 1.æœˆ(Month)å’Œæ˜ŸæœŸ(Day of week)å­—æ®µçš„å€¼ä¸åŒºåˆ†å¤§å°å†™ï¼Œå¦‚ï¼šSUNã€Sun å’Œ sun æ˜¯ä¸€æ ·çš„ã€‚ 2.æ˜ŸæœŸ(Day of week)å­—æ®µå¦‚æžœæ²¡æä¾›ï¼Œç›¸å½“äºŽæ˜¯ * ? 1`# â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ min (0 - 59)``# â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ hour (0 - 23)``# â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of month (1 - 31)``# â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ month (1 - 12)``# â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ day of week (0 - 6) (0 to 6 are Sunday to``# â”‚ â”‚ â”‚ â”‚ â”‚ Saturday, or use names; 7 is also Sunday)``# â”‚ â”‚ â”‚ â”‚ â”‚``# â”‚ â”‚ â”‚ â”‚ â”‚``# * * * * * command to execute` cronç‰¹å®šå­—ç¬¦è¯´æ˜Ž 1ï¼‰æ˜Ÿå·(*) è¡¨ç¤º cron è¡¨è¾¾å¼èƒ½åŒ¹é…è¯¥å­—æ®µçš„æ‰€æœ‰å€¼ã€‚å¦‚åœ¨ç¬¬5ä¸ªå­—æ®µä½¿ç”¨æ˜Ÿå·(month)ï¼Œè¡¨ç¤ºæ¯ä¸ªæœˆ 2ï¼‰æ–œçº¿(/) è¡¨ç¤ºå¢žé•¿é—´éš”ï¼Œå¦‚ç¬¬1ä¸ªå­—æ®µ(minutes) å€¼æ˜¯ 3-59/15ï¼Œè¡¨ç¤ºæ¯å°æ—¶çš„ç¬¬3åˆ†é’Ÿå¼€å§‹æ‰§è¡Œä¸€æ¬¡ï¼Œä¹‹åŽæ¯éš” 15 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼ˆå³ 3ã€18ã€33ã€48 è¿™äº›æ—¶é—´ç‚¹æ‰§è¡Œï¼‰ï¼Œè¿™é‡Œä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºï¼š3/15 3ï¼‰é€—å·(,) ç”¨äºŽæžšä¸¾å€¼ï¼Œå¦‚ç¬¬6ä¸ªå­—æ®µå€¼æ˜¯ MON,WED,FRIï¼Œè¡¨ç¤º æ˜ŸæœŸä¸€ã€ä¸‰ã€äº” æ‰§è¡Œ 4ï¼‰è¿žå­—å·(-) è¡¨ç¤ºä¸€ä¸ªèŒƒå›´ï¼Œå¦‚ç¬¬3ä¸ªå­—æ®µçš„å€¼ä¸º 9-17 è¡¨ç¤º 9am åˆ° 5pm ç›´æŽ¥æ¯ä¸ªå°æ—¶ï¼ˆåŒ…æ‹¬9å’Œ17ï¼‰ 5ï¼‰é—®å·(?) åªç”¨äºŽ æ—¥(Day of month) å’Œ æ˜ŸæœŸ(Day of week)ï¼Œè¡¨ç¤ºä¸æŒ‡å®šå€¼ï¼Œå¯ä»¥ç”¨äºŽä»£æ›¿ * 6ï¼‰Lï¼ŒWï¼Œ# Goä¸­æ²¡æœ‰Lï¼ŒWï¼Œ#çš„ç”¨æ³•ï¼Œä¸‹æ–‡ä½œè§£é‡Šã€‚ cronä¸¾ä¾‹è¯´æ˜Ž æ¯éš”5ç§’æ‰§è¡Œä¸€æ¬¡ï¼š/5 * ? æ¯éš”1åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼š0 /1 ? æ¯å¤©23ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼š0 0 23 ? æ¯å¤©å‡Œæ™¨1ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼š0 0 1 ? æ¯æœˆ1å·å‡Œæ™¨1ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼š0 0 1 1 * ? åœ¨26åˆ†ã€29åˆ†ã€33åˆ†æ‰§è¡Œä¸€æ¬¡ï¼š0 26,29,33 * ? æ¯å¤©çš„0ç‚¹ã€13ç‚¹ã€18ç‚¹ã€21ç‚¹éƒ½æ‰§è¡Œä¸€æ¬¡ï¼š0 0 0,13,18,21 ? ä¸‹è½½å®‰è£… æŽ§åˆ¶å°è¾“å…¥ go get github.com/robfig/cronåŽ»ä¸‹è½½å®šæ—¶ä»»åŠ¡çš„GoåŒ…ï¼Œå‰ææ˜¯ä½ çš„$GOPATHå·²ç»é…ç½®å¥½ æºç è§£æž æ–‡ä»¶ç›®å½•è®²è§£ ? 1`constantdelay.go #ä¸€ä¸ªæœ€ç®€å•çš„ç§’çº§åˆ«å®šæ—¶ç³»ç»Ÿã€‚ä¸Žcronæ— å…³``constantdelay_test.go #æµ‹è¯•``cron.go #Cronç³»ç»Ÿã€‚ç®¡ç†ä¸€ç³»åˆ—çš„cronå®šæ—¶ä»»åŠ¡ï¼ˆSchedule Jobï¼‰``cron_test.go #æµ‹è¯•``doc.go #è¯´æ˜Žæ–‡æ¡£``LICENSE #æŽˆæƒä¹¦ ``parser.go #è§£æžå™¨ï¼Œè§£æžcronæ ¼å¼å­—ç¬¦ä¸²åŸŽä¸€ä¸ªå…·ä½“çš„å®šæ—¶å™¨ï¼ˆScheduleï¼‰``parser_test.go #æµ‹è¯•``README.md #README``spec.go #å•ä¸ªå®šæ—¶å™¨ï¼ˆScheduleï¼‰ç»“æž„ä½“ã€‚å¦‚ä½•è®¡ç®—è‡ªå·±çš„ä¸‹ä¸€æ¬¡è§¦å‘æ—¶é—´``spec_test.go #æµ‹è¯•` cron.go ç»“æž„ä½“ï¼š ? 1`// Cron keeps track of any number of entries, invoking the associated func as``// specified by the schedule. It may be started, stopped, and the entries may``// be inspected while running. ``// Cronä¿æŒä»»æ„æ•°é‡çš„æ¡ç›®çš„è½¨é“ï¼Œè°ƒç”¨ç›¸å…³çš„funcæ—¶é—´è¡¨æŒ‡å®šã€‚å®ƒå¯ä»¥è¢«å¯åŠ¨ï¼Œåœæ­¢å’Œæ¡ç›®ï¼Œå¯è¿è¡Œçš„åŒæ—¶è¿›è¡Œæ£€æŸ¥ã€‚``type Cron struct &#123;`` ``entries []*Entry // ä»»åŠ¡`` ``stop chan struct&#123;&#125; // å«åœæ­¢çš„é€”å¾„`` ``add chan *Entry // æ·»åŠ æ–°ä»»åŠ¡çš„æ–¹å¼`` ``snapshot chan []*Entry // è¯·æ±‚èŽ·å–ä»»åŠ¡å¿«ç…§çš„æ–¹å¼`` ``running bool // æ˜¯å¦åœ¨è¿è¡Œ`` ``ErrorLog *log.Logger // å‡ºé”™æ—¥å¿—(æ–°å¢žå±žæ€§)`` ``location *time.Location // æ‰€åœ¨åœ°åŒº(æ–°å¢žå±žæ€§) ``&#125;` ? 1`// Entry consists of a schedule and the func to execute on that schedule.``// å…¥å£åŒ…æ‹¬æ—¶é—´è¡¨å’Œå¯åœ¨æ—¶é—´è¡¨ä¸Šæ‰§è¡Œçš„func``type Entry struct &#123;`` ``// è®¡æ—¶å™¨`` ``Schedule Schedule`` ``// ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´`` ``Next time.Time`` ``// ä¸Šæ¬¡æ‰§è¡Œæ—¶é—´`` ``Prev time.Time`` ``// ä»»åŠ¡`` ``Job Job``&#125;` å…³é”®æ–¹æ³•ï¼š ? 1`// å¼€å§‹ä»»åŠ¡``// Start the cron scheduler in its own go-routine, or no-op if already started.``func (c *Cron) Start() &#123;`` ``if c.running &#123;`` ``return`` ``&#125;`` ``c.running = true`` ``go c.run()``&#125;``// ç»“æŸä»»åŠ¡``// Stop stops the cron scheduler if it is running; otherwise it does nothing.``func (c *Cron) Stop() &#123;`` ``if !c.running &#123;`` ``return`` ``&#125;`` ``c.stop &lt;- struct&#123;&#125;&#123;&#125;`` ``c.running = false``&#125;` `// æ‰§è¡Œå®šæ—¶ä»»åŠ¡``// Run the scheduler.. this is private just due to the need to synchronize``// access to the &apos;running&apos; state variable.``func (c *Cron) run() &#123;`` ``// Figure out the next activation times for each entry.`` ``now := time.Now().In(c.location)`` ``for _, entry := range c.entries &#123;`` ``entry.Next = entry.Schedule.Next(now)`` ``&#125;`` ``// æ— é™å¾ªçŽ¯`` ``for &#123;`` ``//é€šè¿‡å¯¹ä¸‹ä¸€ä¸ªæ‰§è¡Œæ—¶é—´è¿›è¡ŒæŽ’åºï¼Œåˆ¤æ–­é‚£äº›ä»»åŠ¡æ˜¯ä¸‹ä¸€æ¬¡è¢«æ‰§è¡Œçš„ï¼Œé˜²åœ¨é˜Ÿåˆ—çš„å‰é¢.sortæ˜¯ç”¨æ¥åšæŽ’åºçš„`` ``sort.Sort(byTime(c.entries))` ` ``var effective time.Time`` ``if len(c.entries) == 0 || c.entries[0].Next.IsZero() &#123;`` ``// If there are no entries yet, just sleep - it still handles new entries`` ``// and stop requests.`` ``effective = now.AddDate(10, 0, 0)`` ``&#125; else &#123;`` ``effective = c.entries[0].Next`` ``&#125;` ` ``timer := time.NewTimer(effective.Sub(now))`` ``select &#123;`` ``case now = &lt;-timer.C: // æ‰§è¡Œå½“å‰ä»»åŠ¡`` ``now = now.In(c.location)`` ``// Run every entry whose next time was this effective time.`` ``for _, e := range c.entries &#123;`` ``if e.Next != effective &#123;`` ``break`` ``&#125;`` ``go c.runWithRecovery(e.Job)`` ``e.Prev = e.Next`` ``e.Next = e.Schedule.Next(now)`` ``&#125;`` ``continue` ` ``case newEntry := &lt;-c.add: // æ·»åŠ æ–°çš„ä»»åŠ¡`` ``c.entries = append(c.entries, newEntry)`` ``newEntry.Next = newEntry.Schedule.Next(time.Now().In(c.location))` ` ``case &lt;-c.snapshot: // èŽ·å–å¿«ç…§`` ``c.snapshot &lt;- c.entrySnapshot()` ` ``case &lt;-c.stop: // åœæ­¢ä»»åŠ¡`` ``timer.Stop()`` ``return`` ``&#125;` ` ``// &apos;now&apos; should be updated after newEntry and snapshot cases.`` ``now = time.Now().In(c.location)`` ``timer.Stop()`` ``&#125;``&#125;` spec.go ç»“æž„ä½“åŠå…³é”®æ–¹æ³•ï¼š ? 1`// SpecSchedule specifies a duty cycle (to the second granularity), based on a``// traditional crontab specification. It is computed initially and stored as bit sets.``type SpecSchedule struct &#123;`` ``// è¡¨è¾¾å¼ä¸­é”è¡¨æ˜Žçš„ï¼Œç§’ï¼Œåˆ†ï¼Œæ—¶ï¼Œæ—¥ï¼Œæœˆï¼Œå‘¨ï¼Œæ¯ä¸ªéƒ½æ˜¯uint64`` ``// Dom:Day of Month,Dow:Day of week`` ``Second, Minute, Hour, Dom, Month, Dow uint64``&#125;` `// bounds provides a range of acceptable values (plus a map of name to value).``// å®šä¹‰äº†è¡¨è¾¾å¼çš„ç»“æž„ä½“``type bounds struct &#123;`` ``min, max uint`` ``names map[string]uint``&#125;` `// The bounds for each field.``// è¿™æ ·å°±èƒ½çœ‹å‡ºå„ä¸ªè¡¨è¾¾å¼çš„èŒƒå›´``var (`` ``seconds = bounds&#123;0, 59, nil&#125;`` ``minutes = bounds&#123;0, 59, nil&#125;`` ``hours = bounds&#123;0, 23, nil&#125;`` ``dom = bounds&#123;1, 31, nil&#125;`` ``months = bounds&#123;1, 12, map[string]uint&#123;`` ``&quot;jan&quot;: 1,`` ``&quot;feb&quot;: 2,`` ``&quot;mar&quot;: 3,`` ``&quot;apr&quot;: 4,`` ``&quot;may&quot;: 5,`` ``&quot;jun&quot;: 6,`` ``&quot;jul&quot;: 7,`` ``&quot;aug&quot;: 8,`` ``&quot;sep&quot;: 9,`` ``&quot;oct&quot;: 10,`` ``&quot;nov&quot;: 11,`` ``&quot;dec&quot;: 12,`` ``&#125;&#125;`` ``dow = bounds&#123;0, 6, map[string]uint&#123;`` ``&quot;sun&quot;: 0,`` ``&quot;mon&quot;: 1,`` ``&quot;tue&quot;: 2,`` ``&quot;wed&quot;: 3,`` ``&quot;thu&quot;: 4,`` ``&quot;fri&quot;: 5,`` ``&quot;sat&quot;: 6,`` ``&#125;&#125;``)` `const (`` ``// Set the top bit if a star was included in the expression.`` ``starBit = 1 &lt;&lt; 63``)` çœ‹äº†ä¸Šé¢çš„ä¸œè¥¿è‚¯å®šæœ‰äººç–‘æƒ‘ä¸ºä»€ä¹ˆç§’åˆ†æ—¶è¿™äº›éƒ½æ˜¯å®šä¹‰äº†unit64,ä»¥åŠå®šä¹‰äº†ä¸€ä¸ªå¸¸é‡starBit = 1 &lt;&lt; 63è¿™ç§å†™æ³•ï¼Œè¿™æ˜¯é€»è¾‘è¿ç®—ç¬¦ã€‚è¡¨ç¤ºäºŒè¿›åˆ¶1å‘å·¦ç§»åŠ¨63ä½ã€‚åŽŸå› å¦‚ä¸‹ï¼š cronè¡¨è¾¾å¼æ˜¯ç”¨æ¥è¡¨ç¤ºä¸€ç³»åˆ—æ—¶é—´çš„ï¼Œè€Œæ—¶é—´æ˜¯æ— æ³•é€ƒè„±è‡ªå·±çš„åŒºé—´çš„ ï¼Œ åˆ†ï¼Œç§’ 0 - 59 ï¼Œ æ—¶ 0 - 23 ï¼Œ å¤©/æœˆ 0 - 31 ï¼Œ å¤©/å‘¨ 0 - 6 ï¼Œ æœˆ0 - 11 ã€‚ è¿™äº›æœ¬è´¨ä¸Šéƒ½æ˜¯ä¸€ä¸ªç‚¹é›†åˆï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ªæ•´æ•°åŒºé—´ã€‚ é‚£ä¹ˆå¯¹äºŽä»»æ„çš„æ•´æ•°åŒºé—´ ï¼Œ å¯ä»¥æè¿°cronçš„å¦‚ä¸‹éƒ¨åˆ†è§„åˆ™ã€‚ * | ? ä»»æ„ ï¼Œ å¯¹åº”åŒºé—´ä¸Šçš„æ‰€æœ‰ç‚¹ã€‚ ï¼ˆ é¢å¤–æ³¨æ„ æ—¥/å‘¨ ï¼Œ æ—¥ / æœˆ çš„ç›¸äº’å¹²æ‰°ã€‚ï¼‰ çº¯æ•°å­— ï¼Œ å¯¹åº”ä¸€ä¸ªå…·ä½“çš„ç‚¹ã€‚ / åˆ†å‰²çš„ä¸¤ä¸ªæ•°å­— a , bï¼Œ åŒºé—´ä¸Šç¬¦åˆ a + n * b çš„æ‰€æœ‰ç‚¹ ï¼ˆ n &gt;= 0 )ã€‚ - åˆ†å‰²çš„ä¸¤ä¸ªæ•°å­—ï¼Œ å¯¹åº”è¿™ä¸¤ä¸ªæ•°å­—å†³å®šçš„åŒºé—´å†…çš„æ‰€æœ‰ç‚¹ã€‚ L | W éœ€è¦å¯¹äºŽç‰¹å®šçš„æ—¶é—´ç‰¹æ®Šåˆ¤æ–­ï¼Œ æ— æ³•é€šç”¨çš„å¯¹åº”åˆ°åŒºé—´ä¸Šçš„ç‚¹ã€‚ è‡³æ­¤ï¼Œ robfig/cronä¸ºä»€ä¹ˆä¸æ”¯æŒ L | Wçš„åŽŸå› å·²ç»æ˜Žäº†äº†ã€‚åŽ»é™¤è¿™ä¸¤æ¡è§„åˆ™åŽï¼Œ å…¶ä½™çš„è§„åˆ™å…¶å®žå®Œå…¨å¯ä»¥ä½¿ç”¨ç‚¹çš„ç©·ä¸¾æ¥é€šç”¨è¡¨ç¤ºã€‚ è€ƒè™‘åˆ°æœ€å¤§çš„åŒºé—´ä¹Ÿä¸è¿‡æ˜¯60ä¸ªç‚¹ï¼Œé‚£ä¹ˆä½¿ç”¨ä¸€ä¸ªuint64çš„æ•´æ•°çš„æ¯ä¸€ä½æ¥è¡¨ç¤ºä¸€ä¸ªç‚¹ä¾¿å¾ˆåˆé€‚äº†ã€‚æ‰€ä»¥å®šä¹‰unit64ä¸ä¸ºè¿‡ ä¸‹é¢æ˜¯goä¸­cronè¡¨è¾¾å¼çš„æ–¹æ³•ï¼š ? 1`/* `` ``------------------------------------------------------------`` ``ç¬¬64ä½æ ‡è®°ä»»æ„ ï¼Œ ç”¨äºŽ æ—¥/å‘¨ ï¼Œ æ—¥ / æœˆ çš„ç›¸äº’å¹²æ‰°ã€‚`` ``63 - 0 ä¸º è¡¨ç¤ºåŒºé—´ [63 , 0] çš„ æ¯ä¸€ä¸ªç‚¹ã€‚`` ``------------------------------------------------------------` ` ``å‡è®¾åŒºé—´æ˜¯ 0 - 63 ï¼Œ åˆ™æœ‰å¦‚ä¸‹çš„ä¾‹å­ ï¼š` ` ``æ¯”å¦‚ 0/3 çš„è¡¨ç¤ºå¦‚ä¸‹ ï¼š (è¡¨ç¤ºæ¯éš”ä¸¤ä½ä¸º1)`` ``* / ? `` ``+---+--------------------------------------------------------+`` ``| 0 | 1 0 0 1 0 0 1 ~~ ~~ 1 0 0 1 0 0 1 |`` ``+---+--------------------------------------------------------+ `` ``63 ~ ~ ~~ 0` ` ``æ¯”å¦‚ 2-5 çš„è¡¨ç¤ºå¦‚ä¸‹ ï¼š (è¡¨ç¤ºä»Žå³å¾€å·¦2-5ä½ä¸Šéƒ½æ˜¯1)`` ``* / ? `` ``+---+--------------------------------------------------------+`` ``| 0 | 0 0 0 0 ~ ~ ~~ ~ 0 0 0 1 1 1 1 0 0 |`` ``+---+--------------------------------------------------------+ `` ``63 ~ ~ ~~ 0` ` ``æ¯”å¦‚ * çš„è¡¨ç¤ºå¦‚ä¸‹ ï¼š (è¡¨ç¤ºæ‰€æœ‰ä½ç½®ä¸Šéƒ½ä¸º1)`` ``* / ? `` ``+---+--------------------------------------------------------+`` ``| 1 | 1 1 1 1 1 ~ ~ ~ 1 1 1 1 1 1 1 1 1 |`` ``+---+--------------------------------------------------------+ `` ``63 ~ ~ ~~ 0 ``*/` parser.go å°†å­—ç¬¦ä¸²è§£æžä¸ºSpecScheduleçš„ç±»ã€‚ ? 1`package cron` `import (`` ``&quot;fmt&quot;`` ``&quot;math&quot;`` ``&quot;strconv&quot;`` ``&quot;strings&quot;`` ``&quot;time&quot;``)` `// Configuration options for creating a parser. Most options specify which``// fields should be included, while others enable features. If a field is not``// included the parser will assume a default value. These options do not change``// the order fields are parse in.``type ParseOption int` `const (`` ``Second ParseOption = 1 &lt;&lt; iota // Seconds field, default 0`` ``Minute // Minutes field, default 0`` ``Hour // Hours field, default 0`` ``Dom // Day of month field, default *`` ``Month // Month field, default *`` ``Dow // Day of week field, default *`` ``DowOptional // Optional day of week field, default *`` ``Descriptor // Allow descriptors such as @monthly, @weekly, etc.``)` `var places = []ParseOption&#123;`` ``Second,`` ``Minute,`` ``Hour,`` ``Dom,`` ``Month,`` ``Dow,``&#125;` `var defaults = []string&#123;`` ``&quot;0&quot;,`` ``&quot;0&quot;,`` ``&quot;0&quot;,`` ``&quot;*&quot;,`` ``&quot;*&quot;,`` ``&quot;*&quot;,``&#125;` `// A custom Parser that can be configured.``type Parser struct &#123;`` ``options ParseOption`` ``optionals int``&#125;` `// Creates a custom Parser with custom options.``//``// // Standard parser without descriptors``// specParser := NewParser(Minute | Hour | Dom | Month | Dow)``// sched, err := specParser.Parse(&quot;0 0 15 */3 *&quot;)``//``// // Same as above, just excludes time fields``// subsParser := NewParser(Dom | Month | Dow)``// sched, err := specParser.Parse(&quot;15 */3 *&quot;)``//``// // Same as above, just makes Dow optional``// subsParser := NewParser(Dom | Month | DowOptional)``// sched, err := specParser.Parse(&quot;15 */3&quot;)``//``func NewParser(options ParseOption) Parser &#123;`` ``optionals := 0`` ``if options&amp;DowOptional &gt; 0 &#123;`` ``options |= Dow`` ``optionals++`` ``&#125;`` ``return Parser&#123;options, optionals&#125;``&#125;` `// Parse returns a new crontab schedule representing the given spec.``// It returns a descriptive error if the spec is not valid.``// It accepts crontab specs and features configured by NewParser.``// å°†å­—ç¬¦ä¸²è§£æžæˆä¸ºSpecSchedule ã€‚ SpecScheduleç¬¦åˆScheduleæŽ¥å£` `func (p Parser) Parse(spec string) (Schedule, error) &#123;`` // ç›´æŽ¥å¤„ç†ç‰¹æ®Šçš„ç‰¹æ®Šçš„å­—ç¬¦ä¸²`` ``if spec[0] == &apos;@&apos; &amp;&amp; p.options&amp;Descriptor &gt; 0 &#123;`` ``return parseDescriptor(spec)`` ``&#125;` ` ``// Figure out how many fields we need`` ``max := 0`` ``for _, place := range places &#123;`` ``if p.options&amp;place &gt; 0 &#123;`` ``max++`` ``&#125;`` ``&#125;`` ``min := max - p.optionals` ` ``// cronåˆ©ç”¨ç©ºç™½æ‹†è§£å‡ºç‹¬ç«‹çš„itemsã€‚`` ``fields := strings.Fields(spec)` ` ``// éªŒè¯è¡¨è¾¾å¼å–å€¼èŒƒå›´`` ``if count := len(fields); count &lt; min || count &gt; max &#123;`` ``if min == max &#123;`` ``return nil, fmt.Errorf(&quot;Expected exactly %d fields, found %d: %s&quot;, min, count, spec)`` ``&#125;`` ``return nil, fmt.Errorf(&quot;Expected %d to %d fields, found %d: %s&quot;, min, max, count, spec)`` ``&#125;` ` ``// Fill in missing fields`` ``fields = expandFields(fields, p.options)` ` ``var err error`` ``field := func(field string, r bounds) uint64 &#123;`` ``if err != nil &#123;`` ``return 0`` ``&#125;`` ``var bits uint64`` ``bits, err = getField(field, r)`` ``return bits`` ``&#125;` ` ``var (`` ``second = field(fields[0], seconds)`` ``minute = field(fields[1], minutes)`` ``hour = field(fields[2], hours)`` ``dayofmonth = field(fields[3], dom)`` ``month = field(fields[4], months)`` ``dayofweek = field(fields[5], dow)`` ``)`` ``if err != nil &#123;`` ``return nil, err`` ``&#125;`` ``// è¿”å›žæ‰€éœ€è¦çš„SpecSchedule`` ``return &amp;SpecSchedule&#123;`` ``Second: second,`` ``Minute: minute,`` ``Hour: hour,`` ``Dom: dayofmonth,`` ``Month: month,`` ``Dow: dayofweek,`` ``&#125;, nil``&#125;` `func expandFields(fields []string, options ParseOption) []string &#123;`` ``n := 0`` ``count := len(fields)`` ``expFields := make([]string, len(places))`` ``copy(expFields, defaults)`` ``for i, place := range places &#123;`` ``if options&amp;place &gt; 0 &#123;`` ``expFields[i] = fields[n]`` ``n++`` ``&#125;`` ``if n == count &#123;`` ``break`` ``&#125;`` ``&#125;`` ``return expFields``&#125;` `var standardParser = NewParser(`` ``Minute | Hour | Dom | Month | Dow | Descriptor,``)` `// ParseStandard returns a new crontab schedule representing the given standardSpec``// (https://en.wikipedia.org/wiki/Cron). It differs from Parse requiring to always``// pass 5 entries representing: minute, hour, day of month, month and day of week,``// in that order. It returns a descriptive error if the spec is not valid.``//``// It accepts``// - Standard crontab specs, e.g. &quot;* * * * ?&quot;``// - Descriptors, e.g. &quot;@midnight&quot;, &quot;@every 1h30m&quot;``// è¿™é‡Œè¡¨ç¤ºä¸ä»…å¯ä»¥ä½¿ç”¨cronè¡¨è¾¾å¼ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨@midnight @everyç­‰æ–¹æ³•` `func ParseStandard(standardSpec string) (Schedule, error) &#123;`` ``return standardParser.Parse(standardSpec)``&#125;` `var defaultParser = NewParser(`` ``Second | Minute | Hour | Dom | Month | DowOptional | Descriptor,``)` `// Parse returns a new crontab schedule representing the given spec.``// It returns a descriptive error if the spec is not valid.``//``// It accepts``// - Full crontab specs, e.g. &quot;* * * * * ?&quot;``// - Descriptors, e.g. &quot;@midnight&quot;, &quot;@every 1h30m&quot;``func Parse(spec string) (Schedule, error) &#123;`` ``return defaultParser.Parse(spec)``&#125;` `// getField returns an Int with the bits set representing all of the times that``// the field represents or error parsing field value. A &quot;field&quot; is a comma-separated``// list of &quot;ranges&quot;.``func getField(field string, r bounds) (uint64, error) &#123;`` ``var bits uint64`` ``ranges := strings.FieldsFunc(field, func(r rune) bool &#123; return r == &apos;,&apos; &#125;)`` ``for _, expr := range ranges &#123;`` ``bit, err := getRange(expr, r)`` ``if err != nil &#123;`` ``return bits, err`` ``&#125;`` ``bits |= bit`` ``&#125;`` ``return bits, nil``&#125;` `// getRange returns the bits indicated by the given expression:``// number | number &quot;-&quot; number [ &quot;/&quot; number ]``// or error parsing range.``func getRange(expr string, r bounds) (uint64, error) &#123;`` ``var (`` ``start, end, step uint`` ``rangeAndStep = strings.Split(expr, &quot;/&quot;)`` ``lowAndHigh = strings.Split(rangeAndStep[0], &quot;-&quot;)`` ``singleDigit = len(lowAndHigh) == 1`` ``err error`` ``)` ` ``var extra uint64`` ``if lowAndHigh[0] == &quot;*&quot; || lowAndHigh[0] == &quot;?&quot; &#123;`` ``start = r.min`` ``end = r.max`` ``extra = starBit`` ``&#125; else &#123;`` ``start, err = parseIntOrName(lowAndHigh[0], r.names)`` ``if err != nil &#123;`` ``return 0, err`` ``&#125;`` ``switch len(lowAndHigh) &#123;`` ``case 1:`` ``end = start`` ``case 2:`` ``end, err = parseIntOrName(lowAndHigh[1], r.names)`` ``if err != nil &#123;`` ``return 0, err`` ``&#125;`` ``default:`` ``return 0, fmt.Errorf(&quot;Too many hyphens: %s&quot;, expr)`` ``&#125;`` ``&#125;` ` ``switch len(rangeAndStep) &#123;`` ``case 1:`` ``step = 1`` ``case 2:`` ``step, err = mustParseInt(rangeAndStep[1])`` ``if err != nil &#123;`` ``return 0, err`` ``&#125;` ` ``// Special handling: &quot;N/step&quot; means &quot;N-max/step&quot;.`` ``if singleDigit &#123;`` ``end = r.max`` ``&#125;`` ``default:`` ``return 0, fmt.Errorf(&quot;Too many slashes: %s&quot;, expr)`` ``&#125;` ` ``if start &lt; r.min &#123;`` ``return 0, fmt.Errorf(&quot;Beginning of range (%d) below minimum (%d): %s&quot;, start, r.min, expr)`` ``&#125;`` ``if end &gt; r.max &#123;`` ``return 0, fmt.Errorf(&quot;End of range (%d) above maximum (%d): %s&quot;, end, r.max, expr)`` ``&#125;`` ``if start &gt; end &#123;`` ``return 0, fmt.Errorf(&quot;Beginning of range (%d) beyond end of range (%d): %s&quot;, start, end, expr)`` ``&#125;`` ``if step == 0 &#123;`` ``return 0, fmt.Errorf(&quot;Step of range should be a positive number: %s&quot;, expr)`` ``&#125;` ` ``return getBits(start, end, step) | extra, nil``&#125;` `// parseIntOrName returns the (possibly-named) integer contained in expr.``func parseIntOrName(expr string, names map[string]uint) (uint, error) &#123;`` ``if names != nil &#123;`` ``if namedInt, ok := names[strings.ToLower(expr)]; ok &#123;`` ``return namedInt, nil`` ``&#125;`` ``&#125;`` ``return mustParseInt(expr)``&#125;` `// mustParseInt parses the given expression as an int or returns an error.``func mustParseInt(expr string) (uint, error) &#123;`` ``num, err := strconv.Atoi(expr)`` ``if err != nil &#123;`` ``return 0, fmt.Errorf(&quot;Failed to parse int from %s: %s&quot;, expr, err)`` ``&#125;`` ``if num &lt; 0 &#123;`` ``return 0, fmt.Errorf(&quot;Negative number (%d) not allowed: %s&quot;, num, expr)`` ``&#125;` ` ``return uint(num), nil``&#125;` `// getBits sets all bits in the range [min, max], modulo the given step size.``func getBits(min, max, step uint) uint64 &#123;`` ``var bits uint64` ` ``// If step is 1, use shifts.`` ``if step == 1 &#123;`` ``return ^(math.MaxUint64 &lt;&lt; (max + 1)) &amp; (math.MaxUint64 &lt;&lt; min)`` ``&#125;` ` ``// Else, use a simple loop.`` ``for i := min; i &lt;= max; i += step &#123;`` ``bits |= 1 &lt;&lt; i`` ``&#125;`` ``return bits``&#125;` `// all returns all bits within the given bounds. (plus the star bit)``func all(r bounds) uint64 &#123;`` ``return getBits(r.min, r.max, 1) | starBit``&#125;` `// parseDescriptor returns a predefined schedule for the expression, or error if none matches.``func parseDescriptor(descriptor string) (Schedule, error) &#123;`` ``switch descriptor &#123;`` ``case &quot;@yearly&quot;, &quot;@annually&quot;:`` ``return &amp;SpecSchedule&#123;`` ``Second: 1 &lt;&lt; seconds.min,`` ``Minute: 1 &lt;&lt; minutes.min,`` ``Hour: 1 &lt;&lt; hours.min,`` ``Dom: 1 &lt;&lt; dom.min,`` ``Month: 1 &lt;&lt; months.min,`` ``Dow: all(dow),`` ``&#125;, nil` ` ``case &quot;@monthly&quot;:`` ``return &amp;SpecSchedule&#123;`` ``Second: 1 &lt;&lt; seconds.min,`` ``Minute: 1 &lt;&lt; minutes.min,`` ``Hour: 1 &lt;&lt; hours.min,`` ``Dom: 1 &lt;&lt; dom.min,`` ``Month: all(months),`` ``Dow: all(dow),`` ``&#125;, nil` ` ``case &quot;@weekly&quot;:`` ``return &amp;SpecSchedule&#123;`` ``Second: 1 &lt;&lt; seconds.min,`` ``Minute: 1 &lt;&lt; minutes.min,`` ``Hour: 1 &lt;&lt; hours.min,`` ``Dom: all(dom),`` ``Month: all(months),`` ``Dow: 1 &lt;&lt; dow.min,`` ``&#125;, nil` ` ``case &quot;@daily&quot;, &quot;@midnight&quot;:`` ``return &amp;SpecSchedule&#123;`` ``Second: 1 &lt;&lt; seconds.min,`` ``Minute: 1 &lt;&lt; minutes.min,`` ``Hour: 1 &lt;&lt; hours.min,`` ``Dom: all(dom),`` ``Month: all(months),`` ``Dow: all(dow),`` ``&#125;, nil` ` ``case &quot;@hourly&quot;:`` ``return &amp;SpecSchedule&#123;`` ``Second: 1 &lt;&lt; seconds.min,`` ``Minute: 1 &lt;&lt; minutes.min,`` ``Hour: all(hours),`` ``Dom: all(dom),`` ``Month: all(months),`` ``Dow: all(dow),`` ``&#125;, nil`` ``&#125;` ` ``const every = &quot;@every &quot;`` ``if strings.HasPrefix(descriptor, every) &#123;`` ``duration, err := time.ParseDuration(descriptor[len(every):])`` ``if err != nil &#123;`` ``return nil, fmt.Errorf(&quot;Failed to parse duration %s: %s&quot;, descriptor, err)`` ``&#125;`` ``return Every(duration), nil`` ``&#125;` ` ``return nil, fmt.Errorf(&quot;Unrecognized descriptor: %s&quot;, descriptor)``&#125;` é¡¹ç›®ä¸­åº”ç”¨ 1`package main``import (`` ``&quot;github.com/robfig/cron&quot;`` ``&quot;log&quot;``)` `func main() &#123;`` ``i := 0`` ``c := cron.New()`` ``spec := &quot;*/5 * * * * ?&quot;`` ``c.AddFunc(spec, func() &#123;`` ``i++`` ``log.Println(&quot;cron running:&quot;, i)`` ``&#125;)`` ``c.AddFunc(&quot;@every 1h1m&quot;, func() &#123;`` ``i++`` ``log.Println(&quot;cron running:&quot;, i)`` ``&#125;)`` ``c.Start()``&#125;` æ³¨ï¼š @every ç”¨æ³•æ¯”è¾ƒç‰¹æ®Šï¼Œè¿™æ˜¯Goé‡Œé¢æ¯”è¾ƒç‰¹è‰²çš„ç”¨æ³•ã€‚åŒæ ·çš„è¿˜æœ‰ @yearly @annually @monthly @weekly @daily @midnight @hourly è¿™é‡Œé¢å°±ä¸ä¸€ä¸€èµ˜è¿°äº†ã€‚å¸Œæœ›å¤§å®¶èƒ½å¤Ÿè‡ªå·±æŽ¢ç´¢ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Docker compose ç½‘ç»œè®¾ç½®]]></title>
    <url>%2F2019%2F10%2F27%2FDocker-compose-%E7%BD%91%E7%BB%9C%E8%AE%BE%E7%BD%AE%2F</url>
    <content type="text"><![CDATA[Docker Compose ç½‘ç»œè®¾ç½®åŸºæœ¬æ¦‚å¿µé»˜è®¤æƒ…å†µä¸‹ï¼ŒComposeä¼šä¸ºæˆ‘ä»¬çš„åº”ç”¨åˆ›å»ºä¸€ä¸ªç½‘ç»œï¼ŒæœåŠ¡çš„æ¯ä¸ªå®¹å™¨éƒ½ä¼šåŠ å…¥è¯¥ç½‘ç»œä¸­ã€‚è¿™æ ·ï¼Œå®¹å™¨å°±å¯è¢«è¯¥ç½‘ç»œä¸­çš„å…¶ä»–å®¹å™¨è®¿é—®ï¼Œä¸ä»…å¦‚æ­¤ï¼Œè¯¥å®¹å™¨è¿˜èƒ½ä»¥æœåŠ¡åç§°ä½œä¸ºhostnameè¢«å…¶ä»–å®¹å™¨è®¿é—®ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œåº”ç”¨ç¨‹åºçš„ç½‘ç»œåç§°åŸºäºŽComposeçš„å·¥ç¨‹åç§°ï¼Œè€Œé¡¹ç›®åç§°åŸºäºŽdocker-compose.ymlæ‰€åœ¨ç›®å½•çš„åç§°ã€‚å¦‚éœ€ä¿®æ”¹å·¥ç¨‹åç§°ï¼Œå¯ä½¿ç”¨â€“project-nameæ ‡è¯†æˆ–COMPOSE_PORJECT_NAMEçŽ¯å¢ƒå˜é‡ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚ä¸€ä¸ªåº”ç”¨ç¨‹åºåœ¨åä¸ºmyappçš„ç›®å½•ä¸­ï¼Œå¹¶ä¸”docker-compose.ymlå¦‚ä¸‹æ‰€ç¤ºï¼š 12345678version: &apos;2&apos;services: web: build: . ports: - &quot;8000:8000&quot; db: image: postgres å½“æˆ‘ä»¬è¿è¡Œdocker-compose upæ—¶ï¼Œå°†ä¼šæ‰§è¡Œä»¥ä¸‹å‡ æ­¥ï¼š åˆ›å»ºä¸€ä¸ªåä¸ºmyapp_defaultçš„ç½‘ç»œï¼› ä½¿ç”¨webæœåŠ¡çš„é…ç½®åˆ›å»ºå®¹å™¨ï¼Œå®ƒä»¥â€œwebâ€è¿™ä¸ªåç§°åŠ å…¥ç½‘ç»œmyapp_defaultï¼› ä½¿ç”¨dbæœåŠ¡çš„é…ç½®åˆ›å»ºå®¹å™¨ï¼Œå®ƒä»¥â€œdbâ€è¿™ä¸ªåç§°åŠ å…¥ç½‘ç»œmyapp_defaultã€‚ å®¹å™¨é—´å¯ä½¿ç”¨æœåŠ¡åç§°ï¼ˆwebæˆ–dbï¼‰ä½œä¸ºhostnameç›¸äº’è®¿é—®ã€‚ä¾‹å¦‚ï¼Œwebè¿™ä¸ªæœåŠ¡å¯ä½¿ç”¨postgres://db:5432 è®¿é—®dbå®¹å™¨ã€‚ æ›´æ–°å®¹å™¨å½“æœåŠ¡çš„é…ç½®å‘ç”Ÿæ›´æ”¹æ—¶ï¼Œå¯ä½¿ç”¨docker-compose upå‘½ä»¤æ›´æ–°é…ç½®ã€‚ æ­¤æ—¶ï¼ŒComposeä¼šåˆ é™¤æ—§å®¹å™¨å¹¶åˆ›å»ºæ–°å®¹å™¨ã€‚æ–°å®¹å™¨ä¼šä»¥ä¸åŒçš„IPåœ°å€åŠ å…¥ç½‘ç»œï¼Œåç§°ä¿æŒä¸å˜ã€‚ä»»ä½•æŒ‡å‘æ—§å®¹å™¨çš„è¿žæŽ¥éƒ½ä¼šè¢«å…³é—­ï¼Œå®¹å™¨ä¼šé‡æ–°æ‰¾åˆ°æ–°å®¹å™¨å¹¶è¿žæŽ¥ä¸ŠåŽ»ã€‚ linkså‰æ–‡è®²è¿‡ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼ŒæœåŠ¡ä¹‹é—´å¯ä½¿ç”¨æœåŠ¡åç§°ç›¸äº’è®¿é—®ã€‚linkså…è®¸æˆ‘ä»¬å®šä¹‰ä¸€ä¸ªåˆ«åï¼Œä»Žè€Œä½¿ç”¨è¯¥åˆ«åè®¿é—®å…¶ä»–æœåŠ¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678version: &apos;2&apos;services: web: build: . links: - &quot;db:database&quot; db: image: postgres è¿™æ ·webæœåŠ¡å°±å¯ä½¿ç”¨dbæˆ–databaseä½œä¸ºhostnameè®¿é—®dbæœåŠ¡äº†ã€‚ æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œä¸€äº›åœºæ™¯ä¸‹ï¼Œé»˜è®¤çš„ç½‘ç»œé…ç½®æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä½¿ç”¨networkså‘½ä»¤è‡ªå®šä¹‰ç½‘ç»œã€‚networkså‘½ä»¤å…è®¸æˆ‘ä»¬åˆ›å»ºæ›´åŠ å¤æ‚çš„ç½‘ç»œæ‹“æ‰‘å¹¶æŒ‡å®šè‡ªå®šä¹‰ç½‘ç»œé©±åŠ¨å’Œé€‰é¡¹ã€‚ä¸ä»…å¦‚æ­¤ï¼Œæˆ‘ä»¬è¿˜å¯ä½¿ç”¨networkså°†æœåŠ¡è¿žæŽ¥åˆ°ä¸æ˜¯ç”±Composeç®¡ç†çš„ã€å¤–éƒ¨åˆ›å»ºçš„ç½‘ç»œã€‚ å¦‚ä¸‹ï¼Œæˆ‘ä»¬åœ¨å…¶ä¸­å®šä¹‰äº†ä¸¤ä¸ªè‡ªå®šä¹‰ç½‘ç»œã€‚ 123456789101112131415161718192021222324252627version: &apos;2&apos;services: proxy: build: ./proxy networks: - front app: build: ./app networks: - front - back db: image: postgres networks: - backnetworks: front: # Use a custom driver driver: custom-driver-1 back: # Use a custom driver which takes special options driver: custom-driver-2 driver_opts: foo: &quot;1&quot; bar: &quot;2&quot; å…¶ä¸­ï¼ŒproxyæœåŠ¡ä¸ŽdbæœåŠ¡éš”ç¦»ï¼Œä¸¤è€…åˆ†åˆ«ä½¿ç”¨è‡ªå·±çš„ç½‘ç»œï¼›appæœåŠ¡å¯ä¸Žä¸¤è€…é€šä¿¡ã€‚ ç”±æœ¬ä¾‹ä¸éš¾å‘çŽ°ï¼Œä½¿ç”¨networkså‘½ä»¤ï¼Œå³å¯æ–¹ä¾¿å®žçŽ°æœåŠ¡é—´çš„ç½‘ç»œéš”ç¦»ä¸Žè¿žæŽ¥ã€‚ é…ç½®é»˜è®¤ç½‘ç»œé™¤è‡ªå®šä¹‰ç½‘ç»œå¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä¸ºé»˜è®¤ç½‘ç»œè‡ªå®šä¹‰é…ç½®ã€‚ 1234567891011121314version: &apos;2&apos;services: web: build: . ports: - &quot;8000:8000&quot; db: image: postgresnetworks: default: # Use a custom driver driver: custom-driver-1 è¿™æ ·ï¼Œå°±å¯ä¸ºè¯¥åº”ç”¨æŒ‡å®šè‡ªå®šä¹‰çš„ç½‘ç»œé©±åŠ¨ã€‚ ä½¿ç”¨å·²å­˜åœ¨çš„ç½‘ç»œä¸€äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸éœ€è¦åˆ›å»ºæ–°çš„ç½‘ç»œï¼Œè€Œåªéœ€åŠ å…¥å·²å­˜åœ¨çš„ç½‘ç»œï¼Œæ­¤æ—¶å¯ä½¿ç”¨externalé€‰é¡¹ã€‚ç¤ºä¾‹ï¼š 1234networks: default: external: name: my-pre-existing-network Docker Compose é“¾æŽ¥å¤–éƒ¨å®¹å™¨çš„å‡ ç§æ–¹å¼åœ¨Dockerä¸­ï¼Œå®¹å™¨ä¹‹é—´çš„é“¾æŽ¥æ˜¯ä¸€ç§å¾ˆå¸¸è§çš„æ“ä½œï¼šå®ƒæä¾›äº†è®¿é—®å…¶ä¸­çš„æŸä¸ªå®¹å™¨çš„ç½‘ç»œæœåŠ¡è€Œä¸éœ€è¦å°†æ‰€éœ€çš„ç«¯å£æš´éœ²ç»™Docker Hostä¸»æœºçš„åŠŸèƒ½ã€‚Docker Composeä¸­å¯¹è¯¥ç‰¹æ€§çš„æ”¯æŒåŒæ ·æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ç„¶è€Œï¼Œå¦‚æžœéœ€è¦é“¾æŽ¥çš„å®¹å™¨æ²¡æœ‰å®šä¹‰åœ¨åŒä¸€ä¸ªdocker-compose.ymlä¸­çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™å°±ç¨å¾®éº»çƒ¦å¤æ‚äº†ç‚¹ã€‚ åœ¨ä¸ä½¿ç”¨Docker Composeçš„æ—¶å€™ï¼Œå°†ä¸¤ä¸ªå®¹å™¨é“¾æŽ¥èµ·æ¥ä½¿ç”¨â€”linkå‚æ•°ï¼Œç›¸å¯¹æ¥è¯´æ¯”è¾ƒç®€å•ï¼Œä»¥nginxé•œåƒä¸ºä¾‹å­ï¼š 12docker run --rm --name test1 -d nginx #å¼€å¯ä¸€ä¸ªå®žä¾‹test1docker run --rm --name test2 --link test1 -d nginx #å¼€å¯ä¸€ä¸ªå®žä¾‹test2å¹¶ä¸Žtest1å»ºç«‹é“¾æŽ¥ è¿™æ ·ï¼Œtest2ä¸Žtest1ä¾¿å»ºç«‹äº†é“¾æŽ¥ï¼Œå°±å¯ä»¥åœ¨test2ä¸­ä½¿ç”¨è®¿é—®test1ä¸­çš„æœåŠ¡äº†ã€‚ å¦‚æžœä½¿ç”¨Docker Composeï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹æƒ…å°±æ›´ç®€å•äº†ï¼Œè¿˜æ˜¯ä»¥ä¸Šé¢çš„nginxé•œåƒä¸ºä¾‹å­ï¼Œç¼–è¾‘docker-compose.ymlæ–‡ä»¶ä¸ºï¼š 12345678910version: &quot;3&quot;services: test2: image: nginx depends_on: - test1 links: - test1 test1: image: nginx æœ€ç»ˆæ•ˆæžœä¸Žä½¿ç”¨æ™®é€šçš„Dockerå‘½ä»¤docker run xxxxå»ºç«‹çš„é“¾æŽ¥å¹¶æ— åŒºåˆ«ã€‚è¿™åªæ˜¯ä¸€ç§æœ€ä¸ºç†æƒ³çš„æƒ…å†µã€‚ å¦‚æžœå®¹å™¨æ²¡æœ‰å®šä¹‰åœ¨åŒä¸€ä¸ªdocker-compose.ymlæ–‡ä»¶ä¸­ï¼Œåº”è¯¥å¦‚ä½•é“¾æŽ¥å®ƒä»¬å‘¢ï¼Ÿ åˆå¦‚æžœå®šä¹‰åœ¨docker-compose.ymlæ–‡ä»¶ä¸­çš„å®¹å™¨éœ€è¦ä¸Ždocker run xxxå¯åŠ¨çš„å®¹å™¨é“¾æŽ¥ï¼Œéœ€è¦å¦‚ä½•å¤„ç†ï¼Ÿ é’ˆå¯¹è¿™ä¸¤ç§å…¸åž‹çš„æƒ…å†µï¼Œä¸‹é¢ç»™å‡ºæˆ‘ä¸ªäººæµ‹è¯•å¯è¡Œçš„åŠžæ³•ï¼š æ–¹å¼ä¸€ï¼šè®©éœ€è¦é“¾æŽ¥çš„å®¹å™¨åŒå±žä¸€ä¸ªå¤–éƒ¨ç½‘ç»œæˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨nginxé•œåƒæ¥æ¨¡æ‹Ÿè¿™æ ·çš„ä¸€ä¸ªæƒ…æ™¯ï¼šå‡è®¾æˆ‘ä»¬éœ€è¦å°†ä¸¤ä¸ªä½¿ç”¨Docker Composeç®¡ç†çš„nignxå®¹å™¨ï¼ˆtest1å’Œtest2ï¼‰é“¾æŽ¥èµ·æ¥ï¼Œä½¿å¾—test2èƒ½å¤Ÿè®¿é—®test1ä¸­æä¾›çš„æœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä»¥èƒ½pingé€šä¸ºå‡†ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬å®šä¹‰å®¹å™¨test1çš„docker-compose.ymlæ–‡ä»¶å†…å®¹ä¸ºï¼š 1234567891011version: &quot;3&quot;services: test2: image: nginx container_name: test1 networks: - default - app_netnetworks: app_net: external: true å®¹å™¨test2å†…å®¹ä¸Žtest1åŸºæœ¬ä¸€æ ·ï¼Œåªæ˜¯å¤šäº†ä¸€ä¸ªexternal_links,éœ€è¦ç‰¹åˆ«è¯´æ˜Žçš„æ˜¯ï¼šæœ€è¿‘å‘å¸ƒçš„Dockerç‰ˆæœ¬å·²ç»ä¸éœ€è¦ä½¿ç”¨external_linksæ¥é“¾æŽ¥å®¹å™¨ï¼Œå®¹å™¨çš„DNSæœåŠ¡å¯ä»¥æ­£ç¡®çš„ä½œå‡ºåˆ¤æ–­ï¼Œå› æ­¤å¦‚æžœä½ ä½ éœ€è¦å…¼å®¹è¾ƒè€ç‰ˆæœ¬çš„Dockerçš„è¯ï¼Œé‚£ä¹ˆå®¹å™¨test2çš„docker-compose.ymlæ–‡ä»¶å†…å®¹ä¸ºï¼š 12345678910111213version: &quot;3&quot;services: test2: image: nginx networks: - default - app_net external_links: - test1 container_name: test2networks: app_net: external: true å¦åˆ™çš„è¯ï¼Œtest2çš„docker-compose.ymlå’Œtest1çš„å®šä¹‰å®Œå…¨ä¸€è‡´ï¼Œä¸éœ€è¦é¢å¤–å¤šæŒ‡å®šä¸€ä¸ªexternal_linksã€‚ç›¸å…³çš„é—®é¢˜è¯·å‚è§stackoverflowä¸Šçš„ç›¸å…³é—®é¢˜ï¼šdocker-compose + external container æ­£å¦‚ä½ çœ‹åˆ°çš„é‚£æ ·ï¼Œè¿™é‡Œä¸¤ä¸ªå®¹å™¨çš„å®šä¹‰é‡Œéƒ½ä½¿ç”¨äº†åŒä¸€ä¸ªå¤–éƒ¨ç½‘ç»œapp_net,å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ä¹‹å‰é€šè¿‡ä»¥ä¸‹å‘½ä»¤å†åˆ›å»ºå¤–éƒ¨ç½‘ç»œï¼š 1docker network create app_net ä¹‹åŽï¼Œé€šè¿‡docker-compose up -då‘½ä»¤å¯åŠ¨è¿™ä¸¤ä¸ªå®¹å™¨ï¼Œç„¶åŽæ‰§è¡Œdocker exec -it test2 ping test1,ä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºï¼š 12345678docker exec -it test2 ping test1PING test1 (172.18.0.2): 56 data bytes64 bytes from 172.18.0.2: icmp_seq=0 ttl=64 time=0.091 ms64 bytes from 172.18.0.2: icmp_seq=1 ttl=64 time=0.146 ms64 bytes from 172.18.0.2: icmp_seq=2 ttl=64 time=0.150 ms64 bytes from 172.18.0.2: icmp_seq=3 ttl=64 time=0.145 ms64 bytes from 172.18.0.2: icmp_seq=4 ttl=64 time=0.126 ms64 bytes from 172.18.0.2: icmp_seq=5 ttl=64 time=0.147 ms è¯æ˜Žè¿™ä¸¤ä¸ªå®¹å™¨æ˜¯æˆåŠŸé“¾æŽ¥äº†ï¼Œåè¿‡æ¥åœ¨test1ä¸­pingtest2ä¹Ÿæ˜¯èƒ½å¤Ÿæ­£å¸¸pingé€šçš„ã€‚ å¦‚æžœæˆ‘ä»¬é€šè¿‡docker run --rm --name test3 -d nginxè¿™ç§æ–¹å¼æ¥å…ˆå¯åŠ¨äº†ä¸€ä¸ªå®¹å™¨(test3)å¹¶ä¸”æ²¡æœ‰æŒ‡å®šå®ƒæ‰€å±žçš„å¤–éƒ¨ç½‘ç»œï¼Œè€Œéœ€è¦å°†å…¶ä¸Žtest1æˆ–è€…test2é“¾æŽ¥çš„è¯ï¼Œè¿™ä¸ªæ—¶å€™æ‰‹åŠ¨é“¾æŽ¥å¤–éƒ¨ç½‘ç»œå³å¯ï¼š 1docker network connect app_net test3 è¿™æ ·ï¼Œä¸‰ä¸ªå®¹å™¨éƒ½å¯ä»¥ç›¸äº’è®¿é—®äº†ã€‚ æ–¹å¼äºŒï¼šæ›´æ”¹éœ€è¦é“¾æŽ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼é€šè¿‡æ›´æ”¹ä½ æƒ³è¦ç›¸äº’é“¾æŽ¥çš„å®¹å™¨çš„ç½‘ç»œæ¨¡å¼ä¸ºbridge,å¹¶æŒ‡å®šéœ€è¦é“¾æŽ¥çš„å¤–éƒ¨å®¹å™¨ï¼ˆexternal_links)å³å¯ã€‚ä¸ŽåŒå±žå¤–éƒ¨ç½‘ç»œçš„å®¹å™¨å¯ä»¥ç›¸äº’è®¿é—®çš„é“¾æŽ¥æ–¹å¼ä¸€ä¸åŒï¼Œè¿™ç§æ–¹å¼çš„è®¿é—®æ˜¯å•å‘çš„ã€‚ è¿˜æ˜¯ä»¥nginxå®¹å™¨é•œåƒä¸ºä¾‹å­ï¼Œå¦‚æžœå®¹å™¨å®žä¾‹nginx1éœ€è¦è®¿é—®å®¹å™¨å®žä¾‹nginx2ï¼Œé‚£ä¹ˆnginx2çš„doker-compose.ymlå®šä¹‰ä¸ºï¼š 123456version: &quot;3&quot;services: nginx2: image: nginx container_name: nginx2 network_mode: bridge ä¸Žå…¶å¯¹åº”çš„ï¼Œnginx1çš„docker-compose.ymlå®šä¹‰ä¸ºï¼š 12345678version: &quot;3&quot;services: nginx1: image: nginx external_links: - nginx2 container_name: nginx1 network_mode: bridge éœ€è¦ç‰¹åˆ«è¯´æ˜Žçš„æ˜¯ï¼Œè¿™é‡Œçš„external_linksæ˜¯ä¸èƒ½çœç•¥çš„ï¼Œè€Œä¸”nginx1çš„å¯åŠ¨å¿…é¡»è¦åœ¨nginx2ä¹‹åŽï¼Œå¦åˆ™å¯èƒ½ä¼šæŠ¥æ‰¾ä¸åˆ°å®¹å™¨nginx2çš„é”™è¯¯ã€‚ æŽ¥ç€æˆ‘ä»¬ä½¿ç”¨pingæ¥æµ‹è¯•ä¸‹è¿žé€šæ€§ï¼š 12345678$ docker exec -it nginx1 ping nginx2 # nginx1 to nginx2PING nginx2 (172.17.0.4): 56 data bytes64 bytes from 172.17.0.4: icmp_seq=0 ttl=64 time=0.141 ms64 bytes from 172.17.0.4: icmp_seq=1 ttl=64 time=0.139 ms64 bytes from 172.17.0.4: icmp_seq=2 ttl=64 time=0.145 ms$ docker exec -it nginx2 ping nginx1 #nginx2 to nginx1ping: unknown host ä»¥ä¸Šä¹Ÿèƒ½å……åˆ†è¯æ˜Žè¿™ç§æ–¹å¼æ˜¯å±žäºŽå•å‘è”é€šçš„ã€‚ åœ¨å®žé™…åº”ç”¨ä¸­æ ¹æ®è‡ªå·±çš„éœ€è¦çµæ´»çš„é€‰æ‹©è¿™ä¸¤ç§é“¾æŽ¥æ–¹å¼ï¼Œå¦‚æžœæƒ³å·æ‡’çš„è¯ï¼Œå¤§å¯é€‰æ‹©ç¬¬äºŒç§ã€‚ä¸è¿‡æˆ‘æ›´æŽ¨èç¬¬ä¸€ç§ï¼Œä¸éš¾çœ‹å‡ºæ— è®ºæ˜¯è”é€šæ€§è¿˜æ˜¯çµæ´»æ€§ï¼Œç¬¬ä¸€ç§éƒ½æ¯”è¾ƒå¥½ã€‚ é™„docker-compose.ymlæ–‡ä»¶è¯¦è§£ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294Composeå’ŒDockerå…¼å®¹æ€§ï¼š Compose æ–‡ä»¶æ ¼å¼æœ‰3ä¸ªç‰ˆæœ¬,åˆ†åˆ«ä¸º1, 2.x å’Œ 3.x ç›®å‰ä¸»æµçš„ä¸º 3.x å…¶æ”¯æŒ docker 1.13.0 åŠå…¶ä»¥ä¸Šçš„ç‰ˆæœ¬å¸¸ç”¨å‚æ•°ï¼š version # æŒ‡å®š compose æ–‡ä»¶çš„ç‰ˆæœ¬ services # å®šä¹‰æ‰€æœ‰çš„ service ä¿¡æ¯, services ä¸‹é¢çš„ç¬¬ä¸€çº§åˆ«çš„ key æ˜¯ä¸€ä¸ª service çš„åç§° build # æŒ‡å®šåŒ…å«æž„å»ºä¸Šä¸‹æ–‡çš„è·¯å¾„, æˆ–ä½œä¸ºä¸€ä¸ªå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å…·æœ‰ context å’ŒæŒ‡å®šçš„ dockerfile æ–‡ä»¶ä»¥åŠ args å‚æ•°å€¼ context # context: æŒ‡å®š Dockerfile æ–‡ä»¶æ‰€åœ¨çš„è·¯å¾„ dockerfile # dockerfile: æŒ‡å®š context æŒ‡å®šçš„ç›®å½•ä¸‹é¢çš„ Dockerfile çš„åç§°(é»˜è®¤ä¸º Dockerfile) args # args: Dockerfile åœ¨ build è¿‡ç¨‹ä¸­éœ€è¦çš„å‚æ•° (ç­‰åŒäºŽ docker container build --build-arg çš„ä½œç”¨) cache_from # v3.2ä¸­æ–°å¢žçš„å‚æ•°, æŒ‡å®šç¼“å­˜çš„é•œåƒåˆ—è¡¨ (ç­‰åŒäºŽ docker container build --cache_from çš„ä½œç”¨) labels # v3.3ä¸­æ–°å¢žçš„å‚æ•°, è®¾ç½®é•œåƒçš„å…ƒæ•°æ® (ç­‰åŒäºŽ docker container build --labels çš„ä½œç”¨) shm_size # v3.5ä¸­æ–°å¢žçš„å‚æ•°, è®¾ç½®å®¹å™¨ /dev/shm åˆ†åŒºçš„å¤§å° (ç­‰åŒäºŽ docker container build --shm-size çš„ä½œç”¨) command # è¦†ç›–å®¹å™¨å¯åŠ¨åŽé»˜è®¤æ‰§è¡Œçš„å‘½ä»¤, æ”¯æŒ shell æ ¼å¼å’Œ [] æ ¼å¼ configs # ä¸çŸ¥é“æ€Žä¹ˆç”¨ cgroup_parent # ä¸çŸ¥é“æ€Žä¹ˆç”¨ container_name # æŒ‡å®šå®¹å™¨çš„åç§° (ç­‰åŒäºŽ docker run --name çš„ä½œç”¨) credential_spec # ä¸çŸ¥é“æ€Žä¹ˆç”¨ deploy # v3 ç‰ˆæœ¬ä»¥ä¸Š, æŒ‡å®šä¸Žéƒ¨ç½²å’Œè¿è¡ŒæœåŠ¡ç›¸å…³çš„é…ç½®, deploy éƒ¨åˆ†æ˜¯ docker stack ä½¿ç”¨çš„, docker stack ä¾èµ– docker swarm endpoint_mode # v3.3 ç‰ˆæœ¬ä¸­æ–°å¢žçš„åŠŸèƒ½, æŒ‡å®šæœåŠ¡æš´éœ²çš„æ–¹å¼ vip # Docker ä¸ºè¯¥æœåŠ¡åˆ†é…äº†ä¸€ä¸ªè™šæ‹Ÿ IP(VIP), ä½œä¸ºå®¢æˆ·ç«¯çš„è®¿é—®æœåŠ¡çš„åœ°å€ dnsrr # DNSè½®è¯¢, Docker ä¸ºè¯¥æœåŠ¡è®¾ç½® DNS æ¡ç›®, ä½¿å¾—æœåŠ¡åç§°çš„ DNS æŸ¥è¯¢è¿”å›žä¸€ä¸ª IP åœ°å€åˆ—è¡¨, å®¢æˆ·ç«¯ç›´æŽ¥è®¿é—®å…¶ä¸­çš„ä¸€ä¸ªåœ°å€ labels # æŒ‡å®šæœåŠ¡çš„æ ‡ç­¾ï¼Œè¿™äº›æ ‡ç­¾ä»…åœ¨æœåŠ¡ä¸Šè®¾ç½® mode # æŒ‡å®š deploy çš„æ¨¡å¼ global # æ¯ä¸ªé›†ç¾¤èŠ‚ç‚¹éƒ½åªæœ‰ä¸€ä¸ªå®¹å™¨ replicated # ç”¨æˆ·å¯ä»¥æŒ‡å®šé›†ç¾¤ä¸­å®¹å™¨çš„æ•°é‡(é»˜è®¤) placement # ä¸çŸ¥é“æ€Žä¹ˆç”¨ replicas # deploy çš„ mode ä¸º replicated æ—¶, æŒ‡å®šå®¹å™¨å‰¯æœ¬çš„æ•°é‡ resources # èµ„æºé™åˆ¶ limits # è®¾ç½®å®¹å™¨çš„èµ„æºé™åˆ¶ cpus: &quot;0.5&quot; # è®¾ç½®è¯¥å®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ 50% çš„ CPU memory: 50M # è®¾ç½®è¯¥å®¹å™¨æœ€å¤šåªèƒ½ä½¿ç”¨ 50M çš„å†…å­˜ç©ºé—´ reservations # è®¾ç½®ä¸ºå®¹å™¨é¢„ç•™çš„ç³»ç»Ÿèµ„æº(éšæ—¶å¯ç”¨) cpus: &quot;0.2&quot; # ä¸ºè¯¥å®¹å™¨ä¿ç•™ 20% çš„ CPU memory: 20M # ä¸ºè¯¥å®¹å™¨ä¿ç•™ 20M çš„å†…å­˜ç©ºé—´ restart_policy # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥, ç”¨äºŽä»£æ›¿ restart å‚æ•° condition # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥(æŽ¥å—ä¸‰ä¸ªå‚æ•°) none # ä¸å°è¯•é‡å¯ on-failure # åªæœ‰å½“å®¹å™¨å†…éƒ¨åº”ç”¨ç¨‹åºå‡ºçŽ°é—®é¢˜æ‰ä¼šé‡å¯ any # æ— è®ºå¦‚ä½•éƒ½ä¼šå°è¯•é‡å¯(é»˜è®¤) delay # å°è¯•é‡å¯çš„é—´éš”æ—¶é—´(é»˜è®¤ä¸º 0s) max_attempts # å°è¯•é‡å¯æ¬¡æ•°(é»˜è®¤ä¸€ç›´å°è¯•é‡å¯) window # æ£€æŸ¥é‡å¯æ˜¯å¦æˆåŠŸä¹‹å‰çš„ç­‰å¾…æ—¶é—´(å³å¦‚æžœå®¹å™¨å¯åŠ¨äº†, éš”å¤šå°‘ç§’ä¹‹åŽåŽ»æ£€æµ‹å®¹å™¨æ˜¯å¦æ­£å¸¸, é»˜è®¤ 0s) update_config # ç”¨äºŽé…ç½®æ»šåŠ¨æ›´æ–°é…ç½® parallelism # ä¸€æ¬¡æ€§æ›´æ–°çš„å®¹å™¨æ•°é‡ delay # æ›´æ–°ä¸€ç»„å®¹å™¨ä¹‹é—´çš„é—´éš”æ—¶é—´ failure_action # å®šä¹‰æ›´æ–°å¤±è´¥çš„ç­–ç•¥ continue # ç»§ç»­æ›´æ–° rollback # å›žæ»šæ›´æ–° pause # æš‚åœæ›´æ–°(é»˜è®¤) monitor # æ¯æ¬¡æ›´æ–°åŽçš„æŒç»­æ—¶é—´ä»¥ç›‘è§†æ›´æ–°æ˜¯å¦å¤±è´¥(å•ä½: ns|us|ms|s|m|h) (é»˜è®¤ä¸º0) max_failure_ratio # å›žæ»šæœŸé—´å®¹å¿çš„å¤±è´¥çŽ‡(é»˜è®¤å€¼ä¸º0) order # v3.4 ç‰ˆæœ¬ä¸­æ–°å¢žçš„å‚æ•°, å›žæ»šæœŸé—´çš„æ“ä½œé¡ºåº stop-first #æ—§ä»»åŠ¡åœ¨å¯åŠ¨æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢(é»˜è®¤) start-first #é¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡, å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚æ—¶é‡å  rollback_config # v3.7 ç‰ˆæœ¬ä¸­æ–°å¢žçš„å‚æ•°, ç”¨äºŽå®šä¹‰åœ¨ update_config æ›´æ–°å¤±è´¥çš„å›žæ»šç­–ç•¥ parallelism # ä¸€æ¬¡å›žæ»šçš„å®¹å™¨æ•°, å¦‚æžœè®¾ç½®ä¸º0, åˆ™æ‰€æœ‰å®¹å™¨åŒæ—¶å›žæ»š delay # æ¯ä¸ªç»„å›žæ»šä¹‹é—´çš„æ—¶é—´é—´éš”(é»˜è®¤ä¸º0) failure_action # å®šä¹‰å›žæ»šå¤±è´¥çš„ç­–ç•¥ continue # ç»§ç»­å›žæ»š pause # æš‚åœå›žæ»š monitor # æ¯æ¬¡å›žæ»šä»»åŠ¡åŽçš„æŒç»­æ—¶é—´ä»¥ç›‘è§†å¤±è´¥(å•ä½: ns|us|ms|s|m|h) (é»˜è®¤ä¸º0) max_failure_ratio # å›žæ»šæœŸé—´å®¹å¿çš„å¤±è´¥çŽ‡(é»˜è®¤å€¼0) order # å›žæ»šæœŸé—´çš„æ“ä½œé¡ºåº stop-first # æ—§ä»»åŠ¡åœ¨å¯åŠ¨æ–°ä»»åŠ¡ä¹‹å‰åœæ­¢(é»˜è®¤) start-first # é¦–å…ˆå¯åŠ¨æ–°ä»»åŠ¡, å¹¶ä¸”æ­£åœ¨è¿è¡Œçš„ä»»åŠ¡æš‚æ—¶é‡å  æ³¨æ„ï¼š æ”¯æŒ docker-compose up å’Œ docker-compose run ä½†ä¸æ”¯æŒ docker stack deploy çš„å­é€‰é¡¹ security_opt container_name devices tmpfs stop_signal links cgroup_parent network_mode external_links restart build userns_mode sysctls devices # æŒ‡å®šè®¾å¤‡æ˜ å°„åˆ—è¡¨ (ç­‰åŒäºŽ docker run --device çš„ä½œç”¨) depends_on # å®šä¹‰å®¹å™¨å¯åŠ¨é¡ºåº (æ­¤é€‰é¡¹è§£å†³äº†å®¹å™¨ä¹‹é—´çš„ä¾èµ–å…³ç³»ï¼Œ æ­¤é€‰é¡¹åœ¨ v3 ç‰ˆæœ¬ä¸­ ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) ç¤ºä¾‹ï¼š docker-compose up ä»¥ä¾èµ–é¡ºåºå¯åŠ¨æœåŠ¡ï¼Œä¸‹é¢ä¾‹å­ä¸­ redis å’Œ db æœåŠ¡åœ¨ web å¯åŠ¨å‰å¯åŠ¨ é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ docker-compose up web è¿™æ ·çš„æ–¹å¼å¯åŠ¨ web æœåŠ¡æ—¶ï¼Œä¹Ÿä¼šå¯åŠ¨ redis å’Œ db ä¸¤ä¸ªæœåŠ¡ï¼Œå› ä¸ºåœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰äº†ä¾èµ–å…³ç³» version: &apos;3&apos; services: web: build: . depends_on: - db - redis redis: image: redis db: image: postgres dns # è®¾ç½® DNS åœ°å€(ç­‰åŒäºŽ docker run --dns çš„ä½œç”¨) dns_search # è®¾ç½® DNS æœç´¢åŸŸ(ç­‰åŒäºŽ docker run --dns-search çš„ä½œç”¨) tmpfs # v2 ç‰ˆæœ¬ä»¥ä¸Š, æŒ‚è½½ç›®å½•åˆ°å®¹å™¨ä¸­, ä½œä¸ºå®¹å™¨çš„ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ(ç­‰åŒäºŽ docker run --tmpfs çš„ä½œç”¨, åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) entrypoint # è¦†ç›–å®¹å™¨çš„é»˜è®¤ entrypoint æŒ‡ä»¤ (ç­‰åŒäºŽ docker run --entrypoint çš„ä½œç”¨) env_file # ä»ŽæŒ‡å®šæ–‡ä»¶ä¸­è¯»å–å˜é‡è®¾ç½®ä¸ºå®¹å™¨ä¸­çš„çŽ¯å¢ƒå˜é‡, å¯ä»¥æ˜¯å•ä¸ªå€¼æˆ–è€…ä¸€ä¸ªæ–‡ä»¶åˆ—è¡¨, å¦‚æžœå¤šä¸ªæ–‡ä»¶ä¸­çš„å˜é‡é‡ååˆ™åŽé¢çš„å˜é‡è¦†ç›–å‰é¢çš„å˜é‡, environment çš„å€¼è¦†ç›– env_file çš„å€¼ æ–‡ä»¶æ ¼å¼ï¼š RACK_ENV=development environment # è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼Œ environment çš„å€¼å¯ä»¥è¦†ç›– env_file çš„å€¼ (ç­‰åŒäºŽ docker run --env çš„ä½œç”¨) expose # æš´éœ²ç«¯å£, ä½†æ˜¯ä¸èƒ½å’Œå®¿ä¸»æœºå»ºç«‹æ˜ å°„å…³ç³», ç±»ä¼¼äºŽ Dockerfile çš„ EXPOSE æŒ‡ä»¤ external_links # è¿žæŽ¥ä¸åœ¨ docker-compose.yml ä¸­å®šä¹‰çš„å®¹å™¨æˆ–è€…ä¸åœ¨ compose ç®¡ç†çš„å®¹å™¨(docker run å¯åŠ¨çš„å®¹å™¨, åœ¨ v3 ç‰ˆæœ¬ä¸­ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) extra_hosts # æ·»åŠ  host è®°å½•åˆ°å®¹å™¨ä¸­çš„ /etc/hosts ä¸­ (ç­‰åŒäºŽ docker run --add-host çš„ä½œç”¨) healthcheck # v2.1 ä»¥ä¸Šç‰ˆæœ¬, å®šä¹‰å®¹å™¨å¥åº·çŠ¶æ€æ£€æŸ¥, ç±»ä¼¼äºŽ Dockerfile çš„ HEALTHCHECK æŒ‡ä»¤ test # æ£€æŸ¥å®¹å™¨æ£€æŸ¥çŠ¶æ€çš„å‘½ä»¤, è¯¥é€‰é¡¹å¿…é¡»æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²æˆ–è€…åˆ—è¡¨, ç¬¬ä¸€é¡¹å¿…é¡»æ˜¯ NONE, CMD æˆ– CMD-SHELL, å¦‚æžœå…¶æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²åˆ™ç›¸å½“äºŽ CMD-SHELL åŠ è¯¥å­—ç¬¦ä¸² NONE # ç¦ç”¨å®¹å™¨çš„å¥åº·çŠ¶æ€æ£€æµ‹ CMD # test: [&quot;CMD&quot;, &quot;curl&quot;, &quot;-f&quot;, &quot;http://localhost&quot;] CMD-SHELL # test: [&quot;CMD-SHELL&quot;, &quot;curl -f http://localhost || exit 1&quot;] æˆ–è€… test: curl -f https://localhost || exit 1 interval: 1m30s # æ¯æ¬¡æ£€æŸ¥ä¹‹é—´çš„é—´éš”æ—¶é—´ timeout: 10s # è¿è¡Œå‘½ä»¤çš„è¶…æ—¶æ—¶é—´ retries: 3 # é‡è¯•æ¬¡æ•° start_period: 40s # v3.4 ä»¥ä¸Šæ–°å¢žçš„é€‰é¡¹, å®šä¹‰å®¹å™¨å¯åŠ¨æ—¶é—´é—´éš” disable: true # true æˆ– false, è¡¨ç¤ºæ˜¯å¦ç¦ç”¨å¥åº·çŠ¶æ€æ£€æµ‹å’Œ test: NONE ç›¸åŒ image # æŒ‡å®š docker é•œåƒ, å¯ä»¥æ˜¯è¿œç¨‹ä»“åº“é•œåƒã€æœ¬åœ°é•œåƒ init # v3.7 ä¸­æ–°å¢žçš„å‚æ•°, true æˆ– false è¡¨ç¤ºæ˜¯å¦åœ¨å®¹å™¨ä¸­è¿è¡Œä¸€ä¸ª init, å®ƒæŽ¥æ”¶ä¿¡å·å¹¶ä¼ é€’ç»™è¿›ç¨‹ isolation # éš”ç¦»å®¹å™¨æŠ€æœ¯, åœ¨ Linux ä¸­ä»…æ”¯æŒ default å€¼ labels # ä½¿ç”¨ Docker æ ‡ç­¾å°†å…ƒæ•°æ®æ·»åŠ åˆ°å®¹å™¨, ä¸Ž Dockerfile ä¸­çš„ LABELS ç±»ä¼¼ links # é“¾æŽ¥åˆ°å…¶å®ƒæœåŠ¡ä¸­çš„å®¹å™¨, è¯¥é€‰é¡¹æ˜¯ docker åŽ†å²é—ç•™çš„é€‰é¡¹, ç›®å‰å·²è¢«ç”¨æˆ·è‡ªå®šä¹‰ç½‘ç»œåç§°ç©ºé—´å–ä»£, æœ€ç»ˆæœ‰å¯èƒ½è¢«åºŸå¼ƒ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) logging # è®¾ç½®å®¹å™¨æ—¥å¿—æœåŠ¡ driver # æŒ‡å®šæ—¥å¿—è®°å½•é©±åŠ¨ç¨‹åº, é»˜è®¤ json-file (ç­‰åŒäºŽ docker run --log-driver çš„ä½œç”¨) options # æŒ‡å®šæ—¥å¿—çš„ç›¸å…³å‚æ•° (ç­‰åŒäºŽ docker run --log-opt çš„ä½œç”¨) max-size # è®¾ç½®å•ä¸ªæ—¥å¿—æ–‡ä»¶çš„å¤§å°, å½“åˆ°è¾¾è¿™ä¸ªå€¼åŽä¼šè¿›è¡Œæ—¥å¿—æ»šåŠ¨æ“ä½œ max-file # æ—¥å¿—æ–‡ä»¶ä¿ç•™çš„æ•°é‡ network_mode # æŒ‡å®šç½‘ç»œæ¨¡å¼ (ç­‰åŒäºŽ docker run --net çš„ä½œç”¨, åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) networks # å°†å®¹å™¨åŠ å…¥æŒ‡å®šç½‘ç»œ (ç­‰åŒäºŽ docker network connect çš„ä½œç”¨), networks å¯ä»¥ä½äºŽ compose æ–‡ä»¶é¡¶çº§é”®å’Œ services é”®çš„äºŒçº§é”® aliases # åŒä¸€ç½‘ç»œä¸Šçš„å®¹å™¨å¯ä»¥ä½¿ç”¨æœåŠ¡åç§°æˆ–åˆ«åè¿žæŽ¥åˆ°å…¶ä¸­ä¸€ä¸ªæœåŠ¡çš„å®¹å™¨ ipv4_address # IP V4 æ ¼å¼ ipv6_address # IP V6 æ ¼å¼ ç¤ºä¾‹: version: &apos;3.7&apos; services: test: image: nginx:1.14-alpine container_name: mynginx command: ifconfig networks: app_net: # è°ƒç”¨ä¸‹é¢ networks å®šä¹‰çš„ app_net ç½‘ç»œ ipv4_address: 172.16.238.10 networks: app_net: driver: bridge ipam: driver: default config: - subnet: 172.16.238.0/24 pid: &apos;host&apos; # å…±äº«å®¿ä¸»æœºçš„ è¿›ç¨‹ç©ºé—´(PID) ports # å»ºç«‹å®¿ä¸»æœºå’Œå®¹å™¨ä¹‹é—´çš„ç«¯å£æ˜ å°„å…³ç³», ports æ”¯æŒä¸¤ç§è¯­æ³•æ ¼å¼ SHORT è¯­æ³•æ ¼å¼ç¤ºä¾‹: - &quot;3000&quot; # æš´éœ²å®¹å™¨çš„ 3000 ç«¯å£, å®¿ä¸»æœºçš„ç«¯å£ç”± docker éšæœºæ˜ å°„ä¸€ä¸ªæ²¡æœ‰è¢«å ç”¨çš„ç«¯å£ - &quot;3000-3005&quot; # æš´éœ²å®¹å™¨çš„ 3000 åˆ° 3005 ç«¯å£, å®¿ä¸»æœºçš„ç«¯å£ç”± docker éšæœºæ˜ å°„æ²¡æœ‰è¢«å ç”¨çš„ç«¯å£ - &quot;8000:8000&quot; # å®¹å™¨çš„ 8000 ç«¯å£å’Œå®¿ä¸»æœºçš„ 8000 ç«¯å£å»ºç«‹æ˜ å°„å…³ç³» - &quot;9090-9091:8080-8081&quot; - &quot;127.0.0.1:8001:8001&quot; # æŒ‡å®šæ˜ å°„å®¿ä¸»æœºçš„æŒ‡å®šåœ°å€çš„ - &quot;127.0.0.1:5000-5010:5000-5010&quot; - &quot;6060:6060/udp&quot; # æŒ‡å®šåè®® LONG è¯­æ³•æ ¼å¼ç¤ºä¾‹:(v3.2 æ–°å¢žçš„è¯­æ³•æ ¼å¼) ports: - target: 80 # å®¹å™¨ç«¯å£ published: 8080 # å®¿ä¸»æœºç«¯å£ protocol: tcp # åè®®ç±»åž‹ mode: host # host åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šå‘å¸ƒä¸»æœºç«¯å£, ingress å¯¹äºŽç¾¤æ¨¡å¼ç«¯å£è¿›è¡Œè´Ÿè½½å‡è¡¡ secrets # ä¸çŸ¥é“æ€Žä¹ˆç”¨ security_opt # ä¸ºæ¯ä¸ªå®¹å™¨è¦†ç›–é»˜è®¤çš„æ ‡ç­¾ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) stop_grace_period # æŒ‡å®šåœ¨å‘é€äº† SIGTERM ä¿¡å·ä¹‹åŽ, å®¹å™¨ç­‰å¾…å¤šå°‘ç§’ä¹‹åŽé€€å‡º(é»˜è®¤ 10s) stop_signal # æŒ‡å®šåœæ­¢å®¹å™¨å‘é€çš„ä¿¡å· (é»˜è®¤ä¸º SIGTERM ç›¸å½“äºŽ kill PID; SIGKILL ç›¸å½“äºŽ kill -9 PID; åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) sysctls # è®¾ç½®å®¹å™¨ä¸­çš„å†…æ ¸å‚æ•° (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) ulimits # è®¾ç½®å®¹å™¨çš„ limit userns_mode # å¦‚æžœDockerå®ˆæŠ¤ç¨‹åºé…ç½®äº†ç”¨æˆ·åç§°ç©ºé—´, åˆ™ç¦ç”¨æ­¤æœåŠ¡çš„ç”¨æˆ·åç§°ç©ºé—´ (åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹) volumes # å®šä¹‰å®¹å™¨å’Œå®¿ä¸»æœºçš„å·æ˜ å°„å…³ç³», å…¶å’Œ networks ä¸€æ ·å¯ä»¥ä½äºŽ services é”®çš„äºŒçº§é”®å’Œ compose é¡¶çº§é”®, å¦‚æžœéœ€è¦è·¨æœåŠ¡é—´ä½¿ç”¨åˆ™åœ¨é¡¶çº§é”®å®šä¹‰, åœ¨ services ä¸­å¼•ç”¨ SHORT è¯­æ³•æ ¼å¼ç¤ºä¾‹: volumes: - /var/lib/mysql # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœºçš„ä¸€ä¸ªéšæœºç›®å½•ä¸­ - /opt/data:/var/lib/mysql # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœºçš„ /opt/data - ./cache:/tmp/cache # æ˜ å°„å®¹å™¨å†…çš„ /var/lib/mysql åˆ°å®¿ä¸»æœº compose æ–‡ä»¶æ‰€åœ¨çš„ä½ç½® - ~/configs:/etc/configs/:ro # æ˜ å°„å®¹å™¨å®¿ä¸»æœºçš„ç›®å½•åˆ°å®¹å™¨ä¸­åŽ», æƒé™åªè¯» - datavolume:/var/lib/mysql # datavolume ä¸º volumes é¡¶çº§é”®å®šä¹‰çš„ç›®å½•, åœ¨æ­¤å¤„ç›´æŽ¥è°ƒç”¨ LONG è¯­æ³•æ ¼å¼ç¤ºä¾‹:(v3.2 æ–°å¢žçš„è¯­æ³•æ ¼å¼) version: &quot;3.2&quot; services: web: image: nginx:alpine ports: - &quot;80:80&quot; volumes: - type: volume # mount çš„ç±»åž‹, å¿…é¡»æ˜¯ bindã€volume æˆ– tmpfs source: mydata # å®¿ä¸»æœºç›®å½• target: /data # å®¹å™¨ç›®å½• volume: # é…ç½®é¢å¤–çš„é€‰é¡¹, å…¶ key å¿…é¡»å’Œ type çš„å€¼ç›¸åŒ nocopy: true # volume é¢å¤–çš„é€‰é¡¹, åœ¨åˆ›å»ºå·æ—¶ç¦ç”¨ä»Žå®¹å™¨å¤åˆ¶æ•°æ® - type: bind # volume æ¨¡å¼åªæŒ‡å®šå®¹å™¨è·¯å¾„å³å¯, å®¿ä¸»æœºè·¯å¾„éšæœºç”Ÿæˆ; bind éœ€è¦æŒ‡å®šå®¹å™¨å’Œæ•°æ®æœºçš„æ˜ å°„è·¯å¾„ source: ./static target: /opt/app/static read_only: true # è®¾ç½®æ–‡ä»¶ç³»ç»Ÿä¸ºåªè¯»æ–‡ä»¶ç³»ç»Ÿ volumes: mydata: # å®šä¹‰åœ¨ volume, å¯åœ¨æ‰€æœ‰æœåŠ¡ä¸­è°ƒç”¨ restart # å®šä¹‰å®¹å™¨é‡å¯ç­–ç•¥(åœ¨ä½¿ç”¨ swarm éƒ¨ç½²æ—¶å°†å¿½ç•¥è¯¥é€‰é¡¹, åœ¨ swarm ä½¿ç”¨ restart_policy ä»£æ›¿ restart) no # ç¦æ­¢è‡ªåŠ¨é‡å¯å®¹å™¨(é»˜è®¤) always # æ— è®ºå¦‚ä½•å®¹å™¨éƒ½ä¼šé‡å¯ on-failure # å½“å‡ºçŽ° on-failure æŠ¥é”™æ—¶, å®¹å™¨é‡æ–°å¯åŠ¨ å…¶ä»–é€‰é¡¹ï¼š domainname, hostname, ipc, mac_address, privileged, read_only, shm_size, stdin_open, tty, user, working_dir ä¸Šé¢è¿™äº›é€‰é¡¹éƒ½åªæŽ¥å—å•ä¸ªå€¼å’Œ docker run çš„å¯¹åº”å‚æ•°ç±»ä¼¼ å¯¹äºŽå€¼ä¸ºæ—¶é—´çš„å¯æŽ¥å—çš„å€¼ï¼š 2.5s 10s 1m30s 2h32m 5h34m56s æ—¶é—´å•ä½: us, ms, s, mï¼Œ h å¯¹äºŽå€¼ä¸ºå¤§å°çš„å¯æŽ¥å—çš„å€¼ï¼š 2b 1024kb 2048k 300m 1gb å•ä½: b, k, m, g æˆ–è€… kb, mb, gb networks # å®šä¹‰ networks ä¿¡æ¯ driver # æŒ‡å®šç½‘ç»œæ¨¡å¼, å¤§å¤šæ•°æƒ…å†µä¸‹, å®ƒ bridge äºŽå•ä¸ªä¸»æœºå’Œ overlay Swarm ä¸Š bridge # Docker é»˜è®¤ä½¿ç”¨ bridge è¿žæŽ¥å•ä¸ªä¸»æœºä¸Šçš„ç½‘ç»œ overlay # overlay é©±åŠ¨ç¨‹åºåˆ›å»ºä¸€ä¸ªè·¨å¤šä¸ªèŠ‚ç‚¹å‘½åçš„ç½‘ç»œ host # å…±äº«ä¸»æœºç½‘ç»œåç§°ç©ºé—´(ç­‰åŒäºŽ docker run --net=host) none # ç­‰åŒäºŽ docker run --net=none driver_opts # v3.2ä»¥ä¸Šç‰ˆæœ¬, ä¼ é€’ç»™é©±åŠ¨ç¨‹åºçš„å‚æ•°, è¿™äº›å‚æ•°å–å†³äºŽé©±åŠ¨ç¨‹åº attachable # driver ä¸º overlay æ—¶ä½¿ç”¨, å¦‚æžœè®¾ç½®ä¸º true åˆ™é™¤äº†æœåŠ¡ä¹‹å¤–ï¼Œç‹¬ç«‹å®¹å™¨ä¹Ÿå¯ä»¥é™„åŠ åˆ°è¯¥ç½‘ç»œ; å¦‚æžœç‹¬ç«‹å®¹å™¨è¿žæŽ¥åˆ°è¯¥ç½‘ç»œï¼Œåˆ™å®ƒå¯ä»¥ä¸Žå…¶ä»– Docker å®ˆæŠ¤è¿›ç¨‹è¿žæŽ¥åˆ°çš„è¯¥ç½‘ç»œçš„æœåŠ¡å’Œç‹¬ç«‹å®¹å™¨è¿›è¡Œé€šä¿¡ ipam # è‡ªå®šä¹‰ IPAM é…ç½®. è¿™æ˜¯ä¸€ä¸ªå…·æœ‰å¤šä¸ªå±žæ€§çš„å¯¹è±¡, æ¯ä¸ªå±žæ€§éƒ½æ˜¯å¯é€‰çš„ driver # IPAM é©±åŠ¨ç¨‹åº, bridge æˆ–è€… default config # é…ç½®é¡¹ subnet # CIDRæ ¼å¼çš„å­ç½‘ï¼Œè¡¨ç¤ºè¯¥ç½‘ç»œçš„ç½‘æ®µ external # å¤–éƒ¨ç½‘ç»œ, å¦‚æžœè®¾ç½®ä¸º true åˆ™ docker-compose up ä¸ä¼šå°è¯•åˆ›å»ºå®ƒ, å¦‚æžœå®ƒä¸å­˜åœ¨åˆ™å¼•å‘é”™è¯¯ name # v3.5 ä»¥ä¸Šç‰ˆæœ¬, ä¸ºæ­¤ç½‘ç»œè®¾ç½®åç§°æ–‡ä»¶æ ¼å¼ç¤ºä¾‹ï¼š version: &quot;3&quot; services: redis: image: redis:alpine ports: - &quot;6379&quot; networks: - frontend deploy: replicas: 2 update_config: parallelism: 2 delay: 10s restart_policy: condition: on-failure db: image: postgres:9.4 volumes: - db-data:/var/lib/postgresql/data networks: - backend deploy: placement: constraints: [node.role == manager]]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python withçš„åŽŸç†åŠåœ¨å¼‚å¸¸å¤„ç†ä¸­çš„åº”ç”¨]]></title>
    <url>%2F2019%2F09%2F11%2Fpython-with%E7%9A%84%E5%8E%9F%E7%90%86%E5%8F%8A%E5%9C%A8%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8%2F</url>
    <content type="text"><![CDATA[åªè¦å¯¹è±¡å†…å®žçŽ° enter() å’Œ exit() æ–¹æ³•ï¼Œå°±èƒ½å…¼å®¹ with è¯­å¥ï¼Œè§¦å‘ä¸Šä¸‹æ–‡ç®¡ç†ã€‚ ä¸€ã€ä¸Šä¸‹æ–‡ç®¡ç†çš„ç®€å•æ‰§è¡Œæµç¨‹with å·¥ä½œåŽŸç† ï¼ˆï¼‘ï¼‰ç´§è·ŸwithåŽé¢çš„è¯­å¥è¢«æ±‚å€¼åŽï¼Œè¿”å›žå¯¹è±¡çš„â€œenter()â€æ–¹æ³•è¢«è°ƒç”¨ï¼Œè¿™ä¸ªæ–¹æ³•çš„è¿”å›žå€¼å°†è¢«èµ‹å€¼ç»™asåŽé¢çš„å˜é‡ï¼› ï¼ˆï¼’ï¼‰å½“withåŽé¢çš„ä»£ç å—å…¨éƒ¨è¢«æ‰§è¡Œå®Œä¹‹åŽï¼Œå°†è°ƒç”¨å‰é¢è¿”å›žå¯¹è±¡çš„â€œexit()â€æ–¹æ³•ã€‚ class Sample: def enter(self): print â€œin enterâ€œ return â€œFooâ€ def exit(self, exc_type, exc_val, exc_tb): â€˜â€™â€™ è‹¥åœ¨æ‰§è¡Œæµç¨‹ä¸­å› ä¸ºé”™è¯¯è€Œé€€å‡ºï¼Œè°ƒç”¨exitæ—¶ï¼Œä¼šè‡ªåŠ¨æ•èŽ·é”™è¯¯ä¿¡æ¯ exc_typeï¼š é”™è¯¯çš„ç±»åž‹(å¼‚å¸¸ç±»åž‹) exc_valï¼š é”™è¯¯ç±»åž‹å¯¹åº”çš„å€¼ (å¼‚å¸¸å€¼) exc_tbï¼š ä»£ç ä¸­é”™è¯¯å‘ç”Ÿçš„ä½ç½® (é”™è¯¯æ ˆ) â€˜â€™â€™ print â€œin exitâ€œ def get_sample(): return Sample() with get_sample() as sample: print â€œSample: â€œ, sampleâ€˜â€™â€™æµç¨‹æ€»ç»“ï¼š1- æ‰§è¡Œget_sample()å‡½æ•°2- å‡½æ•°å†…å®žä¾‹åŒ–Sampleå¯¹è±¡ï¼Œæ‰§è¡Œenterè¿”å›žå­—ç¬¦ä¸²èµ‹äºˆsampleå˜é‡3- æ‰§è¡Œwithå†…çš„ä»£ç å—ï¼Œè¾“å‡ºsampleå˜é‡å€¼4- æ‰§è¡ŒSampleå¯¹è±¡å†…çš„exitæ–¹æ³•â€˜â€™â€™äºŒã€é”™è¯¯æ‰§è¡Œæµç¨‹class Sample(): def enter(self): print(â€˜in enterâ€™) return self def __exit__(self, exc_type, exc_val, exc_tb): print &quot;type: &quot;, exc_type print &quot;val: &quot;, exc_val print &quot;tb: &quot;, exc_tb def do_something(self): bar = 1 / 0 return bar + 10 with Sample() as sample: sample.do_something() â€˜â€™â€™in enterTraceback (most recent call last):type: val: integer division or modulo by zero File â€œ/home/user/cltdevelop/Code/TF_Practice_2017_06_06/with_test.pyâ€, line 36, in tb: sample.do_something() File â€œ/home/user/cltdevelop/Code/TF_Practice_2017_06_06/with_test.pyâ€, line 32, in do_something bar = 1 / 0ZeroDivisionError: integer division or modulo by zero Process finished with exit code 1 â€˜â€™â€™ä¸‰ã€å¼‚å¸¸å¤„ç† with åº”ç”¨å¼‚å¸¸å¤„ç†é€»è¾‘å¤ªå¤šï¼Œä»¥è‡³äºŽæ‰°ä¹±äº†ä»£ç æ ¸å¿ƒé€»è¾‘ã€‚å…·ä½“è¡¨çŽ°å°±æ˜¯ï¼Œä»£ç é‡Œå……æ–¥ç€å¤§é‡çš„ tryã€exceptã€raise è¯­å¥ï¼Œè®©æ ¸å¿ƒé€»è¾‘å˜å¾—éš¾ä»¥è¾¨è¯†ã€‚ def upload_avatar(request): â€œâ€â€ç”¨æˆ·ä¸Šä¼ æ–°å¤´åƒâ€â€â€ try: avatar_file = request.FILES[â€˜avatarâ€™] except KeyError: raise error_codes.AVATAR_FILE_NOT_PROVIDED try: resized_avatar_file = resize_avatar(avatar_file) except FileTooLargeError as e: raise error_codes.AVATAR_FILE_TOO_LARGE except ResizeAvatarError as e: raise error_codes.AVATAR_FILE_INVALID try: request.user.avatar = resized_avatar_file request.user.save() except Exception: raise error_codes.INTERNAL_SERVER_ERROR return HttpResponse({}) è¿™æ˜¯ä¸€ä¸ªå¤„ç†ç”¨æˆ·ä¸Šä¼ å¤´åƒçš„è§†å›¾å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å†…åšäº†ä¸‰ä»¶äº‹æƒ…ï¼Œå¹¶ä¸”é’ˆå¯¹æ¯ä»¶äº‹éƒ½åšäº†å¼‚å¸¸æ•èŽ·ã€‚å¦‚æžœåšæŸä»¶äº‹æ—¶å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå°±è¿”å›žå¯¹ç”¨æˆ·å‹å¥½çš„é”™è¯¯åˆ°å‰ç«¯ã€‚ è¿™æ ·çš„å¤„ç†æµç¨‹çºµç„¶åˆç†ï¼Œä½†æ˜¯æ˜¾ç„¶ä»£ç é‡Œçš„å¼‚å¸¸å¤„ç†é€»è¾‘æœ‰ç‚¹â€œå–§å®¾å¤ºä¸»â€äº†ã€‚ä¸€çœ¼çœ‹è¿‡åŽ»å…¨æ˜¯ä»£ç ç¼©è¿›ï¼Œå¾ˆéš¾æç‚¼å‡ºä»£ç çš„æ ¸å¿ƒé€»è¾‘ã€‚ æ—©åœ¨ 2.5 ç‰ˆæœ¬æ—¶ï¼ŒPython è¯­è¨€å°±å·²ç»æä¾›äº†å¯¹ä»˜è¿™ç±»åœºæ™¯çš„å·¥å…·ï¼šâ€œä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼ˆcontext managerï¼‰â€ã€‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨æ˜¯ä¸€ç§é…åˆ with è¯­å¥ä½¿ç”¨çš„ç‰¹æ®Š Python å¯¹è±¡ï¼Œé€šè¿‡å®ƒï¼Œå¯ä»¥è®©å¼‚å¸¸å¤„ç†å·¥ä½œå˜å¾—æ›´æ–¹ä¾¿ã€‚ class raise_api_error: â€œâ€â€ captures specified exception and raise ApiErrorCode instead æ•èŽ·æŒ‡å®šçš„å¼‚å¸¸å¹¶æ”¹ä¸ºå¼•å‘ApiErrorCode :raises: AttributeError if code_name is not valid â€œâ€â€ def init(self, captures, code_name): self.captures = captures self.code = getattr(error_codes, code_name) def __enter__(self): # åˆšæ–¹æ³•å°†åœ¨è¿›å…¥ä¸Šä¸‹æ–‡æ—¶è°ƒç”¨ return self def __exit__(self, exc_type, exc_val, exc_tb): # è¯¥æ–¹æ³•å°†åœ¨é€€å‡ºä¸Šä¸‹æ–‡æ—¶è°ƒç”¨ # exc_type, exc_val, exc_tb åˆ†åˆ«è¡¨ç¤ºè¯¥ä¸Šä¸‹æ–‡å†…æŠ›å‡ºçš„ # å¼‚å¸¸ç±»åž‹ã€å¼‚å¸¸å€¼ã€é”™è¯¯æ ˆ if exc_type is None: return False if exc_type == self.captures: raise self.code from exc_val return False åœ¨ä¸Šé¢çš„ä»£ç é‡Œï¼Œæˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåä¸º raise_api_error çš„ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ƒåœ¨è¿›å…¥ä¸Šä¸‹æ–‡æ—¶ä»€ä¹ˆä¹Ÿä¸åšã€‚ä½†æ˜¯åœ¨é€€å‡ºä¸Šä¸‹æ–‡æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰ä¸Šä¸‹æ–‡ä¸­æ˜¯å¦æŠ›å‡ºäº†ç±»åž‹ä¸º self.captures çš„å¼‚å¸¸ï¼Œå¦‚æžœæœ‰ï¼Œå°±ç”¨ APIErrorCode å¼‚å¸¸ç±»æ›¿ä»£å®ƒã€‚ ä½¿ç”¨è¯¥ä¸Šä¸‹æ–‡ç®¡ç†å™¨åŽï¼Œæ•´ä¸ªå‡½æ•°å¯ä»¥å˜å¾—æ›´æ¸…æ™°ç®€æ´ï¼š def upload_avatar(request): â€œâ€â€ç”¨æˆ·ä¸Šä¼ æ–°å¤´åƒâ€â€â€ with raise_api_error(KeyError, â€˜AVATAR_FILE_NOT_PROVIDEDâ€™): avatar_file = request.FILES[â€˜avatarâ€™] with raise_api_error(ResizeAvatarError, &apos;AVATAR_FILE_INVALID&apos;),\ raise_api_error(FileTooLargeError, &apos;AVATAR_FILE_TOO_LARGE&apos;): resized_avatar_file = resize_avatar(avatar_file) with raise_api_error(Exception, &apos;INTERNAL_SERVER_ERROR&apos;): request.user.avatar = resized_avatar_file request.user.save() return HttpResponse({}) å››ã€raies å’Œ raiseâ€¦â€¦from çš„åŒºåˆ« try:â€¦ print(1 / 0)â€¦ except:â€¦ raise RuntimeError(â€œSomething bad happenedâ€)â€¦ Traceback (most recent call last): File â€œâ€œ, line 2, in ZeroDivisionError: division by zero åœ¨å¤„ç†ä¸Šè¿°å¼‚å¸¸æœŸé—´ï¼Œå‘ç”Ÿäº†å¦ä¸€ä¸ªå¼‚å¸¸ï¼šDuring handling of the above exception, another exception occurred: Traceback (most recent call last): File â€œâ€œ, line 4, in RuntimeError: Something bad happened try:â€¦ print(1 / 0)â€¦ except Exception as exc:â€¦ raise RuntimeError(â€œSomething bad happenedâ€) from excâ€¦ Traceback (most recent call last): File â€œâ€œ, line 2, in ZeroDivisionError: division by zero ä¸Šè¿°å¼‚å¸¸æ˜¯ä»¥ä¸‹å¼‚å¸¸çš„ç›´æŽ¥åŽŸå› ï¼šThe above exception was the direct cause of the following exception: Traceback (most recent call last): File â€œâ€œ, line 4, in RuntimeError: Something bad happenedä¸åŒä¹‹å¤„åœ¨äºŽï¼Œfrom ä¼šä¸ºå¼‚å¸¸å¯¹è±¡è®¾ç½® cause å±žæ€§è¡¨æ˜Žå¼‚å¸¸çš„æ˜¯ç”±è°ç›´æŽ¥å¼•èµ·çš„ã€‚ å¤„ç†å¼‚å¸¸æ—¶å‘ç”Ÿäº†æ–°çš„å¼‚å¸¸ï¼Œåœ¨ä¸ä½¿ç”¨ from æ—¶æ›´å€¾å‘äºŽæ–°å¼‚å¸¸ä¸Žæ­£åœ¨å¤„ç†çš„å¼‚å¸¸æ²¡æœ‰å…³è”ã€‚è€Œ from åˆ™æ˜¯èƒ½æŒ‡å‡ºæ–°å¼‚å¸¸æ˜¯å› æ—§å¼‚å¸¸ç›´æŽ¥å¼•èµ·çš„ã€‚è¿™æ ·çš„å¼‚å¸¸ä¹‹é—´çš„å…³è”æœ‰åŠ©äºŽåŽç»­å¯¹å¼‚å¸¸çš„åˆ†æžå’ŒæŽ’æŸ¥ã€‚from è¯­æ³•ä¼šæœ‰ä¸ªé™åˆ¶ï¼Œå°±æ˜¯ç¬¬äºŒä¸ªè¡¨è¾¾å¼å¿…é¡»æ˜¯å¦ä¸€ä¸ªå¼‚å¸¸ç±»æˆ–å®žä¾‹ã€‚ å¦‚æžœåœ¨å¼‚å¸¸å¤„ç†ç¨‹åºæˆ– finally å—ä¸­å¼•å‘å¼‚å¸¸ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œå¼‚å¸¸æœºåˆ¶ä¼šéšå¼å·¥ä½œä¼šå°†å…ˆå‰çš„å¼‚å¸¸é™„åŠ ä¸ºæ–°å¼‚å¸¸çš„ _context _å±žæ€§ã€‚ å½“ç„¶ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ with_traceback() æ–¹æ³•ä¸ºå¼‚å¸¸è®¾ç½®ä¸Šä¸‹æ–‡ context å±žæ€§ï¼Œè¿™ä¹Ÿèƒ½åœ¨ traceback æ›´å¥½çš„æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯ã€‚]]></content>
      <categories>
        <category>Python</category>
      </categories>
      <tags>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[TCP/IPè¯¦è§£--TCPè¿žæŽ¥ä¸­time_waitçŠ¶æ€è¿‡å¤š]]></title>
    <url>%2F2019%2F09%2F10%2FTCP-IP%E8%AF%A6%E8%A7%A3-TCP%E8%BF%9E%E6%8E%A5%E4%B8%ADtime-wait%E7%8A%B6%E6%80%81%E8%BF%87%E5%A4%9A%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡é“¾æŽ¥ï¼šhttps://blog.csdn.net/yusiguyuan/article/details/21445883TIMEWAITçŠ¶æ€æœ¬èº«å’Œåº”ç”¨å±‚çš„å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨æ˜¯æ²¡æœ‰å…³ç³»çš„ã€‚ä»…ä»…æ˜¯ä¸»åŠ¨å…³é—­çš„ä¸€æ–¹ï¼Œåœ¨ä½¿ç”¨FIN|ACK|FIN|ACKå››åˆ†ç»„æ­£å¸¸å…³é—­TCPè¿žæŽ¥çš„æ—¶å€™ä¼šå‡ºçŽ°è¿™ä¸ªTIMEWAITã€‚æœåŠ¡å™¨åœ¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶å€™ï¼Œå¦‚æžœä½ çš„ç¨‹åºè®¾è®¡ä¸ºæœåŠ¡å™¨ä¸»åŠ¨å…³é—­ï¼Œé‚£ä¹ˆä½ æ‰æœ‰å¯èƒ½éœ€è¦å…³æ³¨è¿™ä¸ªTIMEWAITçŠ¶æ€è¿‡å¤šçš„é—®é¢˜ã€‚å¦‚æžœä½ çš„æœåŠ¡å™¨è®¾è®¡ä¸ºè¢«åŠ¨å…³é—­ï¼Œé‚£ä¹ˆä½ é¦–å…ˆè¦å…³æ³¨çš„æ˜¯CLOSE_WAITã€‚ åŽŸåˆ™TIMEWAITå¹¶ä¸æ˜¯å¤šä½™çš„ã€‚åœ¨TCPåè®®è¢«åˆ›é€ ï¼Œç»åŽ†äº†å¤§é‡çš„å®žé™…åœºæ™¯å®žè·µä¹‹åŽï¼ŒTIMEWAITå‡ºçŽ°äº†ï¼Œå› ä¸ºTCPä¸»åŠ¨å…³é—­è¿žæŽ¥çš„ä¸€æ–¹éœ€è¦TIMEWAITçŠ¶æ€ï¼Œå®ƒæ˜¯æˆ‘ä»¬çš„æœ‹å‹ã€‚è¿™æ˜¯ã€ŠUNIXç½‘ç»œç¼–ç¨‹ã€‹çš„ä½œè€…â€”-Stevenå¯¹TIMEWAITçš„æ€åº¦ã€‚ TIMEWAITæ˜¯å‹å¥½çš„ TCPè¦ä¿è¯åœ¨æ‰€æœ‰å¯èƒ½çš„æƒ…å†µä¸‹ä½¿å¾—æ‰€æœ‰çš„æ•°æ®éƒ½èƒ½å¤Ÿè¢«æ­£ç¡®é€è¾¾ã€‚å½“ä½ å…³é—­ä¸€ä¸ªsocketæ—¶ï¼Œä¸»åŠ¨å…³é—­ä¸€ç«¯çš„socketå°†è¿›å…¥TIME_WAITçŠ¶æ€ï¼Œè€Œè¢«åŠ¨å…³é—­ä¸€æ–¹åˆ™è½¬å…¥CLOSEDçŠ¶æ€ï¼Œè¿™çš„ç¡®èƒ½å¤Ÿä¿è¯æ‰€æœ‰çš„æ•°æ®éƒ½è¢«ä¼ è¾“ã€‚å½“ä¸€ä¸ªsocketå…³é—­çš„æ—¶å€™ï¼Œæ˜¯é€šè¿‡ä¸¤ç«¯å››æ¬¡æ¡æ‰‹å®Œæˆçš„ï¼Œå½“ä¸€ç«¯è°ƒç”¨close()æ—¶ï¼Œå°±è¯´æ˜Žæœ¬ç«¯æ²¡æœ‰æ•°æ®è¦å‘é€äº†ã€‚è¿™å¥½ä¼¼çœ‹æ¥åœ¨æ¡æ‰‹å®Œæˆä»¥åŽï¼Œsocketå°±éƒ½å¯ä»¥å¤„äºŽåˆå§‹çš„CLOSEDçŠ¶æ€äº†ï¼Œå…¶å®žä¸ç„¶ã€‚åŽŸå› æ˜¯è¿™æ ·å®‰æŽ’çŠ¶æ€æœ‰ä¸¤ä¸ªé—®é¢˜ï¼Œ é¦–å…ˆï¼Œæˆ‘ä»¬æ²¡æœ‰ä»»ä½•æœºåˆ¶ä¿è¯æœ€åŽçš„ä¸€ä¸ªACKèƒ½å¤Ÿæ­£å¸¸ä¼ è¾“ï¼Œç¬¬äºŒï¼Œç½‘ç»œä¸Šä»ç„¶æœ‰å¯èƒ½æœ‰æ®‹ä½™çš„æ•°æ®åŒ…(wandering duplicates)ï¼Œæˆ‘ä»¬ä¹Ÿå¿…é¡»èƒ½å¤Ÿæ­£å¸¸å¤„ç†ã€‚TIMEWAITå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸¤ä¸ªé—®é¢˜è€Œç”Ÿçš„ã€‚1.å‡è®¾æœ€åŽä¸€ä¸ªACKä¸¢å¤±äº†ï¼Œè¢«åŠ¨å…³é—­ä¸€æ–¹ä¼šé‡å‘å®ƒçš„FINã€‚ä¸»åŠ¨å…³é—­ä¸€æ–¹å¿…é¡»ç»´æŒä¸€ä¸ªæœ‰æ•ˆçŠ¶æ€ä¿¡æ¯ï¼ˆTIMEWAITçŠ¶æ€ä¸‹ç»´æŒï¼‰ï¼Œä»¥ä¾¿èƒ½å¤Ÿé‡å‘ACKã€‚å¦‚æžœä¸»åŠ¨å…³é—­çš„socketä¸ç»´æŒè¿™ç§çŠ¶æ€è€Œè¿›å…¥CLOSEDçŠ¶æ€ï¼Œé‚£ä¹ˆä¸»åŠ¨å…³é—­çš„socketåœ¨å¤„äºŽCLOSEDçŠ¶æ€æ—¶ï¼ŒæŽ¥æ”¶åˆ°FINåŽå°†ä¼šå“åº”ä¸€ä¸ªRSTã€‚è¢«åŠ¨å…³é—­ä¸€æ–¹æŽ¥æ”¶åˆ°RSTåŽä¼šè®¤ä¸ºå‡ºé”™äº†ã€‚å¦‚æžœTCPåè®®æƒ³è¦æ­£å¸¸å®Œæˆå¿…è¦çš„æ“ä½œè€Œç»ˆæ­¢åŒæ–¹çš„æ•°æ®æµä¼ è¾“ï¼Œå°±å¿…é¡»å®Œå…¨æ­£ç¡®çš„ä¼ è¾“å››æ¬¡æ¡æ‰‹çš„å››ä¸ªèŠ‚ï¼Œä¸èƒ½æœ‰ä»»ä½•çš„ä¸¢å¤±ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆsocketåœ¨å…³é—­åŽï¼Œä»ç„¶å¤„äºŽTIME_WAITçŠ¶æ€çš„ç¬¬ä¸€ä¸ªåŽŸå› ï¼Œå› ä¸ºä»–è¦ç­‰å¾…ä»¥ä¾¿é‡å‘ACKã€‚ 2.å‡è®¾ç›®å‰è¿žæŽ¥çš„é€šä¿¡åŒæ–¹éƒ½å·²ç»è°ƒç”¨äº†close()ï¼ŒåŒæ–¹åŒæ—¶è¿›å…¥CLOSEDçš„ç»ˆç»“çŠ¶æ€ï¼Œè€Œæ²¡æœ‰èµ°TIME_WAITçŠ¶æ€ã€‚ä¼šå‡ºçŽ°å¦‚ä¸‹é—®é¢˜ï¼ŒçŽ°åœ¨æœ‰ä¸€ä¸ªæ–°çš„è¿žæŽ¥è¢«å»ºç«‹èµ·æ¥ï¼Œä½¿ç”¨çš„IPåœ°å€ä¸Žç«¯å£ä¸Žå…ˆå‰çš„å®Œå…¨ç›¸åŒï¼ŒåŽå»ºç«‹çš„è¿žæŽ¥æ˜¯åŽŸå…ˆè¿žæŽ¥çš„ä¸€ä¸ªå®Œå…¨å¤ç”¨ã€‚è¿˜å‡å®šåŽŸå…ˆçš„è¿žæŽ¥ä¸­æœ‰æ•°æ®æŠ¥æ®‹å­˜äºŽç½‘ç»œä¹‹ä¸­ï¼Œè¿™æ ·æ–°çš„è¿žæŽ¥æ”¶åˆ°çš„æ•°æ®æŠ¥ä¸­æœ‰å¯èƒ½æ˜¯å…ˆå‰è¿žæŽ¥çš„æ•°æ®æŠ¥ã€‚ä¸ºäº†é˜²æ­¢è¿™ä¸€ç‚¹ï¼ŒTCPä¸å…è®¸æ–°è¿žæŽ¥å¤ç”¨TIME_WAITçŠ¶æ€ä¸‹çš„socketã€‚å¤„äºŽTIME_WAITçŠ¶æ€çš„socketåœ¨ç­‰å¾…ä¸¤å€çš„MSLæ—¶é—´ä»¥åŽï¼ˆä¹‹æ‰€ä»¥æ˜¯ä¸¤å€çš„MSLï¼Œæ˜¯ç”±äºŽMSLæ˜¯ä¸€ä¸ªæ•°æ®æŠ¥åœ¨ç½‘ç»œä¸­å•å‘å‘å‡ºåˆ°è®¤å®šä¸¢å¤±çš„æ—¶é—´ï¼Œä¸€ä¸ªæ•°æ®æŠ¥æœ‰å¯èƒ½åœ¨å‘é€é€”ä¸­æˆ–æ˜¯å…¶å“åº”è¿‡ç¨‹ä¸­æˆä¸ºæ®‹ä½™æ•°æ®æŠ¥ï¼Œç¡®è®¤ä¸€ä¸ªæ•°æ®æŠ¥åŠå…¶å“åº”çš„ä¸¢å¼ƒçš„éœ€è¦ä¸¤å€çš„MSLï¼‰ï¼Œå°†ä¼šè½¬å˜ä¸ºCLOSEDçŠ¶æ€ã€‚è¿™å°±æ„å‘³ç€ï¼Œä¸€ä¸ªæˆåŠŸå»ºç«‹çš„è¿žæŽ¥ï¼Œå¿…ç„¶ä½¿å¾—å…ˆå‰ç½‘ç»œä¸­æ®‹ä½™çš„æ•°æ®æŠ¥éƒ½ä¸¢å¤±äº†ã€‚ å¤§é‡TIMEWAITåœ¨æŸäº›åœºæ™¯ä¸­å¯¼è‡´çš„ä»¤äººå¤´ç–¼çš„ä¸šåŠ¡é—®é¢˜å¤§é‡TIMEWAITå‡ºçŽ°ï¼Œå¹¶ä¸”éœ€è¦è§£å†³çš„åœºæ™¯ åœ¨é«˜å¹¶å‘çŸ­è¿žæŽ¥çš„TCPæœåŠ¡å™¨ä¸Šï¼Œå½“æœåŠ¡å™¨å¤„ç†å®Œè¯·æ±‚åŽç«‹åˆ»æŒ‰ç…§ä¸»åŠ¨æ­£å¸¸å…³é—­è¿žæŽ¥ã€‚ã€‚ã€‚è¿™ä¸ªåœºæ™¯ä¸‹ï¼Œä¼šå‡ºçŽ°å¤§é‡socketå¤„äºŽTIMEWAITçŠ¶æ€ã€‚å¦‚æžœå®¢æˆ·ç«¯çš„å¹¶å‘é‡æŒç»­å¾ˆé«˜ï¼Œæ­¤æ—¶éƒ¨åˆ†å®¢æˆ·ç«¯å°±ä¼šæ˜¾ç¤ºè¿žæŽ¥ä¸ä¸Šã€‚æˆ‘æ¥è§£é‡Šä¸‹è¿™ä¸ªåœºæ™¯ã€‚ä¸»åŠ¨æ­£å¸¸å…³é—­TCPè¿žæŽ¥ï¼Œéƒ½ä¼šå‡ºçŽ°TIMEWAITã€‚ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦å…³æ³¨è¿™ä¸ªé«˜å¹¶å‘çŸ­è¿žæŽ¥å‘¢ï¼Ÿæœ‰ä¸¤ä¸ªæ–¹é¢éœ€è¦æ³¨æ„ï¼š é«˜å¹¶å‘å¯ä»¥è®©æœåŠ¡å™¨åœ¨çŸ­æ—¶é—´èŒƒå›´å†…åŒæ—¶å ç”¨å¤§é‡ç«¯å£ï¼Œè€Œç«¯å£æœ‰ä¸ª0~65535çš„èŒƒå›´ï¼Œå¹¶ä¸æ˜¯å¾ˆå¤šï¼Œåˆ¨é™¤ç³»ç»Ÿå’Œå…¶ä»–æœåŠ¡è¦ç”¨çš„ï¼Œå‰©ä¸‹çš„å°±æ›´å°‘äº†ã€‚ åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒçŸ­è¿žæŽ¥è¡¨ç¤ºâ€œä¸šåŠ¡å¤„ç†+ä¼ è¾“æ•°æ®çš„æ—¶é—´ è¿œè¿œå°äºŽ TIMEWAITè¶…æ—¶çš„æ—¶é—´â€çš„è¿žæŽ¥ã€‚è¿™é‡Œæœ‰ä¸ªç›¸å¯¹é•¿çŸ­çš„æ¦‚å¿µï¼Œæ¯”å¦‚ï¼Œå–ä¸€ä¸ªwebé¡µé¢ï¼Œ1ç§’é’Ÿçš„httpçŸ­è¿žæŽ¥å¤„ç†å®Œä¸šåŠ¡ï¼Œåœ¨å…³é—­è¿žæŽ¥ä¹‹åŽï¼Œè¿™ä¸ªä¸šåŠ¡ç”¨è¿‡çš„ç«¯å£ä¼šåœç•™åœ¨TIMEWAITçŠ¶æ€å‡ åˆ†é’Ÿï¼Œè€Œè¿™å‡ åˆ†é’Ÿï¼Œå…¶ä»–HTTPè¯·æ±‚æ¥ä¸´çš„æ—¶å€™æ˜¯æ— æ³•å ç”¨æ­¤ç«¯å£çš„ã€‚å•ç”¨è¿™ä¸ªä¸šåŠ¡è®¡ç®—æœåŠ¡å™¨çš„åˆ©ç”¨çŽ‡ä¼šå‘çŽ°ï¼ŒæœåŠ¡å™¨å¹²æ­£ç»äº‹çš„æ—¶é—´å’Œç«¯å£ï¼ˆèµ„æºï¼‰è¢«æŒ‚ç€æ— æ³•è¢«ä½¿ç”¨çš„æ—¶é—´çš„æ¯”ä¾‹æ˜¯ 1ï¼šå‡ ç™¾ï¼ŒæœåŠ¡å™¨èµ„æºä¸¥é‡æµªè´¹ã€‚ï¼ˆè¯´ä¸ªé¢˜å¤–è¯ï¼Œä»Žè¿™ä¸ªæ„ä¹‰å‡ºå‘æ¥è€ƒè™‘æœåŠ¡å™¨æ€§èƒ½è°ƒä¼˜çš„è¯ï¼Œé•¿è¿žæŽ¥ä¸šåŠ¡çš„æœåŠ¡å°±ä¸éœ€è¦è€ƒè™‘TIMEWAITçŠ¶æ€ã€‚åŒæ—¶ï¼Œå‡å¦‚ä½ å¯¹æœåŠ¡å™¨ä¸šåŠ¡åœºæ™¯éžå¸¸ç†Ÿæ‚‰ï¼Œä½ ä¼šå‘çŽ°ï¼Œåœ¨å®žé™…ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œä¸€èˆ¬é•¿è¿žæŽ¥å¯¹åº”çš„ä¸šåŠ¡çš„å¹¶å‘é‡å¹¶ä¸ä¼šå¾ˆé«˜ï¼‰ç»¼åˆè¿™ä¸¤ä¸ªæ–¹é¢ï¼ŒæŒç»­çš„åˆ°è¾¾ä¸€å®šé‡çš„é«˜å¹¶å‘çŸ­è¿žæŽ¥ï¼Œä¼šä½¿æœåŠ¡å™¨å› ç«¯å£èµ„æºä¸è¶³è€Œæ‹’ç»ä¸ºä¸€éƒ¨åˆ†å®¢æˆ·æœåŠ¡ã€‚åŒæ—¶ï¼Œè¿™äº›ç«¯å£éƒ½æ˜¯æœåŠ¡å™¨ä¸´æ—¶åˆ†é…ï¼Œæ— æ³•ç”¨SO_REUSEADDRé€‰é¡¹è§£å†³è¿™ä¸ªé—®é¢˜:( ä¸€å¯¹çŸ›ç›¾TIMEWAITæ—¢å‹å¥½ï¼Œåˆä»¤äººå¤´ç–¼ã€‚ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯è¦æŠ±ç€ä¸€ä¸ªå‹å¥½çš„æ€åº¦æ¥çœ‹å¾…å®ƒï¼Œå› ä¸ºå®ƒå°½å®ƒçš„èƒ½åŠ›ä¿è¯äº†æœåŠ¡å™¨çš„å¥å£®æ€§ã€‚ å¯è¡Œè€Œä¸”å¿…é¡»å­˜åœ¨ï¼Œä½†æ˜¯ä¸ç¬¦åˆåŽŸåˆ™çš„è§£å†³æ–¹å¼ linuxæ²¡æœ‰åœ¨sysctlæˆ–è€…procæ–‡ä»¶ç³»ç»Ÿæš´éœ²ä¿®æ”¹è¿™ä¸ªTIMEWAITè¶…æ—¶æ—¶é—´çš„æŽ¥å£ï¼Œå¯ä»¥ä¿®æ”¹å†…æ ¸åè®®æ ˆä»£ç ä¸­å…³äºŽè¿™ä¸ªTIMEWAITçš„è¶…æ—¶æ—¶é—´å‚æ•°ï¼Œé‡ç¼–å†…æ ¸ï¼Œè®©å®ƒç¼©çŸ­è¶…æ—¶æ—¶é—´ï¼ŒåŠ å¿«å›žæ”¶ï¼› åˆ©ç”¨SO_LINGERé€‰é¡¹çš„å¼ºåˆ¶å…³é—­æ–¹å¼ï¼Œå‘RSTè€Œä¸æ˜¯FINï¼Œæ¥è¶Šè¿‡TIMEWAITçŠ¶æ€ï¼Œç›´æŽ¥è¿›å…¥CLOSEDçŠ¶æ€ã€‚è¯¦è§æˆ‘çš„åšæ–‡ã€ŠTCPä¹‹é€‰é¡¹SO_LINGERã€‹ã€‚ æˆ‘å¦‚ä½•çœ‹å¾…è¿™ä¸ªé—®é¢˜ä¸ºä»€ä¹ˆè¯´ä¸Šè¿°ä¸¤ç§è§£å†³æ–¹å¼æˆ‘è§‰å¾—å¯è¡Œï¼Œä½†æ˜¯ä¸ç¬¦åˆåŽŸåˆ™ï¼Ÿæˆ‘é¦–å…ˆè®¤ä¸ºï¼Œæˆ‘è¦ä¾é TIMEWAITçŠ¶æ€æ¥ä¿è¯æˆ‘çš„æœåŠ¡å™¨ç¨‹åºå¥å£®ï¼Œç½‘ç»œä¸Šå‘ç”Ÿçš„ä¹±ä¸ƒå…«ç³Ÿçš„é—®é¢˜å¤ªå¤šäº†ï¼Œæˆ‘å…ˆè¦æœåŠ¡åŠŸèƒ½æ­£å¸¸ã€‚é‚£æ˜¯ä¸æ˜¯å°±ä¸è¦æ€§èƒ½äº†å‘¢ï¼Ÿå¹¶ä¸æ˜¯ã€‚å¦‚æžœæœåŠ¡å™¨ä¸Šè·‘çš„çŸ­è¿žæŽ¥ä¸šåŠ¡é‡åˆ°äº†æˆ‘çœŸçš„å¿…é¡»å¤„ç†è¿™ä¸ªTIMEWAITçŠ¶æ€è¿‡å¤šçš„é—®é¢˜çš„æ—¶å€™ï¼Œæˆ‘çš„åŽŸåˆ™æ˜¯å°½é‡å¤„ç†ï¼Œè€Œä¸æ˜¯è·ŸTIMEWAITå¹²ä¸Šï¼Œéžå…ˆé™¤ä¹‹è€ŒåŽå¿«ï¼šï¼‰å¦‚æžœå°½é‡å¤„ç†äº†ï¼Œè¿˜æ˜¯è§£å†³ä¸äº†é—®é¢˜ï¼Œä»ç„¶æ‹’ç»æœåŠ¡éƒ¨åˆ†è¯·æ±‚ï¼Œé‚£æˆ‘ä¼šé‡‡å–åˆ†æœºå™¨çš„æ–¹æ³•ï¼Œè®©å¤šå°æœºå™¨æ¥æŠ—è¿™äº›é«˜å¹¶å‘çš„çŸ­è¯·æ±‚ã€‚æŒç»­åä¸‡å¹¶å‘çš„çŸ­è¿žæŽ¥è¯·æ±‚ï¼Œä¸¤å°æœºå™¨ï¼Œæ¯å°5ä¸‡ä¸ªï¼Œåº”è¯¥å¤Ÿç”¨äº†å§ã€‚ä¸€èˆ¬çš„ä¸šåŠ¡é‡ä»¥åŠå›½å†…å¤§éƒ¨åˆ†ç½‘ç«™å…¶å®žå¹¶ä¸éœ€è¦å…³æ³¨è¿™ä¸ªé—®é¢˜ï¼Œä¸€å¥è¯ï¼Œè¾¾ä¸åˆ°éœ€è¦å…³æ³¨è¿™ä¸ªé—®é¢˜çš„è®¿é—®é‡ã€‚çœŸæ­£åœ°å¿…é¡»ä½¿ç”¨ä¸Šè¿°æˆ‘è®¤ä¸ºä¸åˆç†çš„æ–¹å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜çš„åœºæ™¯æœ‰æ²¡æœ‰å‘¢ï¼Ÿç­”æ¡ˆæ˜¯æœ‰ã€‚åƒæ·˜å®ã€ç™¾åº¦ã€æ–°æµªã€äº¬ä¸œå•†åŸŽè¿™æ ·çš„ç«™ç‚¹ï¼Œç”±äºŽæœ‰å¾ˆå¤šé™æ€å°å›¾ç‰‡ä¸šåŠ¡ï¼Œå¦‚æžœè¿‡åº¦åˆ†æœä¼šå¯¼è‡´éœ€è¦ä¸Šçº¿å¤§é‡æœºå™¨ï¼Œå¤šä¹°æœºå™¨å¤šèŠ±é’±ï¼Œå¾—å¤šé…æœºæˆ¿ï¼Œå¤šé…å¤‡è¿ç»´å·¥ç¨‹å¸ˆæ¥å®ˆæŠ¤è¿™äº›æœºå™¨ï¼Œæˆæœ¬å¢žé•¿éžå¸¸ä¸¥é‡ã€‚ã€‚ã€‚è¿™ä¸ªæ—¶å€™å°±è¦å°½ä¸€åˆ‡å¯èƒ½åŽ»ä¼˜åŒ–ã€‚é¢˜å¤–è¯ï¼ŒæœåŠ¡å™¨ä¸Šçš„æŠ€æœ¯é—®é¢˜æ²¡æœ‰ç»å¯¹ï¼Œä¸€åˆ‡éƒ½æ˜¯ä¸ºä¸šåŠ¡éœ€æ±‚æœåŠ¡çš„ã€‚ å¦‚ä½•å°½é‡å¤„ç†TIMEWAITè¿‡å¤šsysctlæ”¹ä¸¤ä¸ªå†…æ ¸å‚æ•°å°±è¡Œäº†ï¼Œå¦‚ä¸‹ï¼šnet.ipv4.tcp_tw_reuse = 1net.ipv4.tcp_tw_recycle = 1ç®€å•æ¥è¯´ï¼Œå°±æ˜¯æ‰“å¼€ç³»ç»Ÿçš„TIMEWAITé‡ç”¨å’Œå¿«é€Ÿå›žæ”¶ï¼Œè‡³äºŽæ€Žä¹ˆé‡ç”¨å’Œå¿«é€Ÿå›žæ”¶ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘æ²¡æœ‰æ·±ç©¶ï¼Œå®žé™…åœºæ™¯ä¸­è¿™ä¹ˆåšç¡®å®žæœ‰æ•ˆæžœã€‚ç”¨netstatæˆ–è€…ssè§‚å¯Ÿå°±èƒ½å¾—å‡ºç»“è®ºã€‚è¿˜æœ‰äº›æœ‹å‹åŒæ—¶ä¹Ÿä¼šæ‰“å¼€syncookiesè¿™ä¸ªåŠŸèƒ½ï¼Œå¦‚ä¸‹ï¼šnet.ipv4.tcp_syncookies = 1æ‰“å¼€è¿™ä¸ªsyncookiesçš„ç›®çš„å®žé™…ä¸Šæ˜¯ï¼šâ€œåœ¨æœåŠ¡å™¨èµ„æºï¼ˆå¹¶éžå•æŒ‡ç«¯å£èµ„æºï¼Œæ‹’ç»æœåŠ¡æœ‰å¾ˆå¤šç§èµ„æºä¸è¶³çš„æƒ…å†µï¼‰ä¸è¶³çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä¸è¦æ‹’ç»TCPçš„synï¼ˆè¿žæŽ¥ï¼‰è¯·æ±‚ï¼Œå°½é‡æŠŠsynè¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œç•™ç€è¿‡ä¼šå„¿æœ‰èƒ½åŠ›çš„æ—¶å€™å¤„ç†è¿™äº›TCPçš„è¿žæŽ¥è¯·æ±‚â€ã€‚å¦‚æžœå¹¶å‘é‡çœŸçš„éžå¸¸éžå¸¸é«˜ï¼Œæ‰“å¼€è¿™ä¸ªå…¶å®žç”¨å¤„ä¸å¤§ã€‚]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>TCP/IP</tag>
        <tag>ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[crawlabçš„golangåŽç«¯å†…å­˜åˆ†æžåŠä¼˜åŒ–-åŸºäºŽgo pprof]]></title>
    <url>%2F2019%2F08%2F20%2Fcrawlab%E7%9A%84%E5%86%85%E5%AD%98%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96-%E5%9F%BA%E4%BA%8Ego-pprof%2F</url>
    <content type="text"><![CDATA[èƒŒæ™¯Crawlabå‘å¸ƒå‡ ä¸ªæœˆä»¥æ¥ï¼Œå…¶ä¸­ç»åŽ†è¿‡å¤šæ¬¡è¿­ä»£ï¼Œåœ¨ä½¿ç”¨è€…ä»¬çš„ç§¯æžåé¦ˆä¸‹ï¼Œcrawlabçˆ¬è™«å¹³å°é€æ¸ç¨³å®šï¼Œä½†æ˜¯æœ€è¿‘æœ‰ç”¨æˆ·æŠ¥å‡ºcrawlabå¯åŠ¨ä¸€æ®µæ—¶é—´åŽï¼Œä¸»èŠ‚ç‚¹æœºå™¨ä¼šå‡ºçŽ°å†…å­˜å ç”¨è¿‡é«˜çš„é—®é¢˜ï¼Œä¸€å°4Gå†…å­˜çš„æœºå™¨åœ¨è¿è¡ŒcrawlabåŽç«Ÿç„¶èƒ½å ç”¨3.5Gä»¥ä¸Šï¼Œå‡ ä¹Žå¯ä»¥è‚¯å®šåŽç«¯æœåŠ¡çš„æŸä¸ªæŽ¥å£ç”±äºŽä»£ç ä¸è§„èŒƒå¯¼è‡´å†…å­˜å ç”¨ï¼ŒäºŽæ˜¯å†³å®šå¯¹crawlabè¿›è¡Œä¸€æ¬¡å†…å­˜åˆ†æžã€‚ 2. åˆ†æžåˆ†æžå†…å­˜å…‰é æ‰‹æ’•ä»£ç æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæ€»è¦å€ŸåŠ©ä¸€äº›å·¥å…·ã€‚Golang pprofæ˜¯Goå®˜æ–¹çš„profilingå·¥å…·ï¼Œéžå¸¸å¼ºå¤§ï¼Œä½¿ç”¨èµ·æ¥ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚ é¦–å…ˆï¼Œæˆ‘ä»¬åœ¨crawlabé¡¹ç›®ä¸­åµŒå…¥å¦‚ä¸‹å‡ è¡Œä»£ç ï¼š 1234_ "net/http/pprof"go func() &#123; http.ListenAndServe("0.0.0.0:8888", nil) &#125;() å°†crawlabåŽç«¯æœåŠ¡å¯åŠ¨åŽï¼Œæµè§ˆå™¨ä¸­è¾“å…¥http://ip:8899/debug/pprof/å°±å¯ä»¥çœ‹åˆ°ä¸€ä¸ªæ±‡æ€»åˆ†æžé¡µé¢ï¼Œæ˜¾ç¤ºå¦‚ä¸‹ä¿¡æ¯ï¼š 12345678910/debug/pprof/profiles:0 block32 goroutine552 heap0 mutex51 threadcreatefull goroutine stack dump ç‚¹å‡»heapï¼Œåœ¨æ±‡æ€»åˆ†æžé¡µé¢çš„æœ€ä¸Šæ–¹å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œçº¢è‰²ç®­å¤´æ‰€æŒ‡çš„å°±æ˜¯å½“å‰å·²ç»ä½¿ç”¨çš„å †å†…å­˜æ˜¯25M,amazingï¼åœ¨æˆ‘åªä¸Šä¼ ä¸€ä¸ªçˆ¬è™«æ–‡ä»¶çš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªåŽç«¯æœåŠ¡æ‰€ç”¨çš„å†…å­˜ç«Ÿç„¶èƒ½è¾¾åˆ°25M æŽ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å€ŸåŠ©go tool pprofæ¥åˆ†æžï¼š 1go tool pprof -inuse_space http://æœ¬æœºIp:8888/debug/pprof/heap è¿™ä¸ªå‘½ä»¤è¿›å…¥åŽï¼Œæ˜¯ä¸€ä¸ªç±»ä¼¼gdbçš„äº¤äº’å¼ç•Œé¢ï¼Œè¾“å…¥topå‘½ä»¤å¯ä»¥å‰10å¤§çš„å†…å­˜åˆ†é…ï¼Œflatæ˜¯å †æ ˆä¸­å½“å‰å±‚çš„inuseå†…å­˜å€¼ï¼Œcumæ˜¯å †æ ˆä¸­æœ¬å±‚çº§çš„ç´¯è®¡inuseå†…å­˜å€¼ï¼ˆåŒ…æ‹¬è°ƒç”¨çš„å‡½æ•°çš„inuseå†…å­˜å€¼ï¼Œä¸Šé¢çš„å±‚çº§ï¼‰ å¯ä»¥çœ‹åˆ°ï¼Œbytes.makeSliceè¿™ä¸ªå†…ç½®æ–¹æ³•ç«Ÿç„¶ä½¿ç”¨äº†24Må†…å­˜ï¼Œç»§ç»­å¾€ä¸‹çœ‹ï¼Œå¯ä»¥çœ‹åˆ°ReadFromè¿™ä¸ªæ–¹æ³•ï¼Œæœäº†ä¸€ä¸‹ï¼Œå‘çŽ° ioutil.ReadAll() é‡Œä¼šè°ƒç”¨ bytes.Buffer.ReadFrom, è€Œ bytes.Buffer.ReadFrom ä¼šè¿›è¡Œ makeSliceã€‚å†å›žå¤´çœ‹ä¸€ä¸‹io/ioutil.readAllçš„ä»£ç å®žçŽ°ï¼Œ 123456789101112131415161718192021func readAll(r io.Reader, capacity int64) (b []byte, err error) &#123; buf := bytes.NewBuffer(make([]byte, 0, capacity)) defer func() &#123; e := recover() if e == nil &#123; return &#125; if panicErr, ok := e.(error); ok &amp;&amp; panicErr == bytes.ErrTooLarge &#123; err = panicErr &#125; else &#123; panic(e) &#125; &#125;() _, err = buf.ReadFrom(r) return buf.Bytes(), err&#125;// bytes.MinRead = 512func ReadAll(r io.Reader) ([]byte, error) &#123; return readAll(r, bytes.MinRead)&#125; å¯ä»¥çœ‹åˆ°ï¼Œioutil.ReadAll æ¯æ¬¡éƒ½ä¼šåˆ†é…åˆå§‹åŒ–ä¸€ä¸ªå¤§å°ä¸º bytes.MinRead çš„ buffer ï¼Œbytes.MinRead åœ¨ Golang é‡Œæ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå€¼ä¸º 512 ã€‚å°±æ˜¯è¯´æ¯æ¬¡è°ƒç”¨ ioutil.ReadAll éƒ½ä¼šåˆ†é…ä¸€å—å¤§å°ä¸º 512 å­—èŠ‚çš„å†…å­˜ï¼Œçœ‹èµ·æ¥æ˜¯æ­£å¸¸çš„ï¼Œä½†æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ReadFromçš„å®žçŽ°ï¼Œ 1234567891011121314151617181920212223242526272829303132333435// ReadFrom reads data from r until EOF and appends it to the buffer, growing// the buffer as needed. The return value n is the number of bytes read. Any// error except io.EOF encountered during the read is also returned. If the// buffer becomes too large, ReadFrom will panic with ErrTooLarge.func (b *Buffer) ReadFrom(r io.Reader) (n int64, err error) &#123; b.lastRead = opInvalid // If buffer is empty, reset to recover space. if b.off &gt;= len(b.buf) &#123; b.Truncate(0) &#125; for &#123; if free := cap(b.buf) - len(b.buf); free &lt; MinRead &#123; // not enough space at end newBuf := b.buf if b.off+free &lt; MinRead &#123; // not enough space using beginning of buffer; // double buffer capacity newBuf = makeSlice(2*cap(b.buf) + MinRead) &#125; copy(newBuf, b.buf[b.off:]) b.buf = newBuf[:len(b.buf)-b.off] b.off = 0 &#125; m, e := r.Read(b.buf[len(b.buf):cap(b.buf)]) b.buf = b.buf[0 : len(b.buf)+m] n += int64(m) if e == io.EOF &#123; break &#125; if e != nil &#123; return n, e &#125; &#125; return n, nil // err is EOF, so return nil explicitly&#125; è¿™ä¸ªå‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯ä»Ž io.Reader é‡Œè¯»å–çš„æ•°æ®æ”¾å…¥ buffer ä¸­ï¼Œå¦‚æžœ buffer ç©ºé—´ä¸å¤Ÿï¼Œå°±æŒ‰ç…§æ¯æ¬¡ 2x + MinRead çš„ç®—æ³•é€’å¢žï¼Œè¿™é‡Œ MinRead çš„å¤§å°ä¹Ÿæ˜¯ 512 Bytes ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æžœæˆ‘ä»¬ä¸€æ¬¡æ€§è¯»å–çš„æ–‡ä»¶è¿‡å¤§ï¼Œå°±ä¼šå¯¼è‡´æ‰€ä½¿ç”¨çš„å†…å­˜å€å¢žï¼Œå‡è®¾æˆ‘ä»¬çš„çˆ¬è™«æ–‡ä»¶æ€»å…±æœ‰500M,é‚£ä¹ˆæ‰€ç”¨çš„å†…å­˜å°±æœ‰500M * 2 + 512Bï¼Œå†µä¸”çˆ¬è™«æ–‡ä»¶ä¸­è¿˜å¸¦äº†é‚£ä¹ˆå¤šlogæ–‡ä»¶ï¼Œé‚£çœ‹çœ‹crawlabæºç ä¸­æ˜¯å“ªä¸€æ®µä½¿ç”¨ioutil.ReadAllè¯»äº†çˆ¬è™«æ–‡ä»¶ï¼Œå®šä½åˆ°äº†è¿™é‡Œï¼š è¿™é‡Œç›´æŽ¥å°†å…¨éƒ¨çš„æ–‡ä»¶å†…å®¹ï¼Œä»¥äºŒè¿›åˆ¶çš„å½¢å¼è¯»äº†è¿›æ¥ï¼Œå¯¼è‡´å†…å­˜å€å¢žï¼Œä»¤äººçª’æ¯çš„æ“ä½œã€‚ å…¶å®žåœ¨è¯»å¤§æ–‡ä»¶çš„æ—¶å€™ï¼ŒæŠŠæ–‡ä»¶å†…å®¹å…¨éƒ¨è¯»åˆ°å†…å­˜ï¼Œç›´æŽ¥å°±ç¿»è½¦äº†ï¼Œæ­£ç¡®æ˜¯å¤„ç†æ–¹æ³•æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯æµå¼å¤„ç†ï¼š 123456789101112131415161718192021func ReadFile(filePath string, handle func(string)) error &#123; f, err := os.Open(filePath) defer f.Close() if err != nil &#123; return err &#125; buf := bufio.NewReader(f) for &#123; line, err := buf.ReadLine("\n") line = strings.TrimSpace(line) handle(line) if err != nil &#123; if err == io.EOF&#123; return nil &#125; return err &#125; return nil &#125;&#125; ç¬¬äºŒç§æ–¹æ¡ˆå°±æ˜¯åˆ†ç‰‡å¤„ç†ï¼Œå½“è¯»å–çš„æ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ²¡æœ‰æ¢è¡Œç¬¦çš„æ—¶å€™ï¼Œä½¿ç”¨è¿™ç§æ–¹æ¡ˆæ¯”è¾ƒåˆé€‚ï¼š 123456789101112131415161718192021func ReadBigFile(fileName string, handle func([]byte)) error &#123; f, err := os.Open(fileName) if err != nil &#123; fmt.Println("can't opened this file") return err &#125; defer f.Close() s := make([]byte, 4096) for &#123; switch nr, err := f.Read(s[:]); true &#123; case nr &lt; 0: fmt.Fprintf(os.Stderr, "cat: error reading: %s\n", err.Error()) os.Exit(1) case nr == 0: // EOF return nil case nr &gt; 0: handle(s[0:nr]) &#125; &#125; return nil&#125; æˆ‘ä»¬è¿™ç±»é‡‡ç”¨çš„ç¬¬äºŒç§æ–¹å¼æ¥ä¼˜åŒ–ï¼Œä¼˜åŒ–åŽå†æ¥çœ‹ä¸‹å†…å­˜åˆ†æžï¼š å ç”¨1Må†…å­˜ï¼Œè¿™æ‰æ˜¯ä¸€ä¸ªæ­£å¸¸åŽç«¯æœåŠ¡è¯¥æœ‰çš„å†…å­˜å¤§å°ï¼Œæºç å·²pushåˆ°crawlabï¼Œå¯ä»¥åœ¨GitHubé¡¹ç›®æºç ä¸­é˜…è¯»ã€‚ æœ€åŽé™„ä¸Šé¡¹ç›®é“¾æŽ¥ï¼Œhttps://github.com/tikazyq/crawlabï¼Œä¸ºcrawlabæ‰“ç”µè¯ï¼Œæ¬¢è¿Žå¤§å®¶ä¸€èµ·è´¡çŒ®ï¼Œè®©crawlabå˜å¾—æ›´å¥½ç”¨ï¼]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pythonä¸­ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼çš„çŽ¯è§†åŠŸèƒ½]]></title>
    <url>%2F2019%2F08%2F16%2FPython%E4%B8%AD%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E7%9A%84%E7%8E%AF%E8%A7%86%E5%8A%9F%E8%83%BD%2F</url>
    <content type="text"><![CDATA[ä»€ä¹ˆæ˜¯çŽ¯è§†çŽ¯è§†åªæ˜¯è¿›è¡Œå­è¡¨è¾¾å¼çš„åŒ¹é…ï¼Œå¹¶ä¸å å­—ç¬¦ï¼ŒåŒ¹é…åˆ°çš„å†…å®¹ä¸ä¿å­˜ï¼Œå› æ­¤ä¹Ÿå«åšé›¶å®½æ–­è¨€ï¼ŒçŽ¯è§†æœ€ç»ˆçš„åŒ¹é…ç»“æžœå°±æ˜¯ä¸€ä¸ªä½ç½®ã€‚ çŽ¯è§†æŒ‰ç…§æ–¹å‘å¯ä»¥åˆ†ä¸ºé¡ºåºçŽ¯è§†å’Œé€†åºçŽ¯è§†ä¸¤ç§ï¼ŒæŒ‰æ˜¯å¦è¿›è¡ŒåŒ¹é…åˆ†ä¸ºè‚¯å®šå’Œå¦å®šä¸¤ç§ï¼Œç»„åˆèµ·æ¥å°±æ˜¯å››ç§æ¨¡å¼ã€‚ çŽ¯è§†è¡¨è¾¾å¼ è§£é‡Š (?=expression) é¡ºåºè‚¯å®šçŽ¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å³ä¾§èƒ½åŒ¹é…expression (?!rexpression) é¡ºåºå¦å®šçŽ¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å³ä¾§ä¸åŒ¹é…expression (?&lt;=expression) é€†åºè‚¯å®šçŽ¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å·¦ä¾§èƒ½åŒ¹é…expression (?&lt;!expression) é€†åºå¦å®šçŽ¯è§†ï¼Œè¡¨ç¤ºæ‰€åœ¨ä½ç½®å·¦ä¾§ä¸åŒ¹é…expression åªè¯´æ¦‚å¿µå¯èƒ½æœ‰äº›æŠ½è±¡ï¼Œåˆ†åˆ«ä¸¾ä¾‹å­æ¥æ¼”ç¤ºä¸€ä¸‹å…·ä½“çš„ä½¿ç”¨åœºæ™¯ã€‚ ä¸€äº›ç¤ºä¾‹ é¡ºåºè‚¯å®šçŽ¯è§† 1234# s = 'xiaomi9iphone8iphone7',éœ€è¦åœ¨æ¯ä¸ªæ‰‹æœºåž‹å·åŽé¢åŠ ä¸Šé€—å·ï¼Œå˜æˆ s= 'xiaomi9,iphone8,iphone7'import reprint(re.sub(r'(?=iphone)',',',s))# é¡ºåºè‚¯å®šçŽ¯è§†ï¼Œæ‰€ç¡®å®šçš„ä½ç½®å³è¾¹æ˜¯å­—ç¬¦ä¸²iPhoneï¼Œåœ¨æ­¤ä½ç½®å³å¯æ·»åŠ é€—å· é€†åºè‚¯å®šçŽ¯è§† 123456# s = 'Takes Reservations:No Delivery:No Take-out:Yes Accepts Credit Cards:Yes Good for Groups:No'# éœ€æ±‚æ˜¯è¦åœ¨Yesï¼Œå’ŒNoçš„åŽé¢åŠ ä¸Šé€—å·ï¼Œä½¿ä¹‹å˜æˆ# s = 'Takes Reservations:No, Delivery:No, Take-out:Yes, Accepts Credit Cards:Yes, Good for Groups:No'import rere.sub(r"(?&lt;=(No))(?=(\s+))|(?&lt;=(Yes))(?=(\s+))",',',s)# é€†åºè‚¯å®šçŽ¯è§†ï¼Œæ‰€è¦ç¡®å®šçš„ä½å·¦è¾¹å¿…é¡»èƒ½åŒ¹é…ä¸ŠNo,æˆ–è€…Yes é¡ºåºå¦å®šçŽ¯è§† 1234# s = '123aaa',å°†så­—ç¬¦ä¸²å˜æˆ s='123,a,a,a,'# åˆ†æžä¸€ä¸‹ï¼Œå°±æ˜¯åœ¨å­—ç¬¦ä¸²å³ä¾§éžæ•°å­—çš„ä½ç½®ï¼Œæ·»åŠ é€—å·ï¼Œå³ä½¿ç”¨é¡ºåºå¦å®šçŽ¯è§†ï¼ŒåŒ¹é…å³ä¾§éžæ•°å­—ä½ç½®s = '123aaa're.sub(r'(?!\d+)',',',s) é€†åºå¦å®šçŽ¯è§† 1234# å°† s= 'aaa123'å˜æˆ s= ',a,a,a,123'# åˆ†æžä¸€ä¸‹ï¼Œå°±æ˜¯åœ¨éžæ•°å­—å·¦ä¾§çš„ä½ç½®åŠ é€—å·ï¼Œä½¿ç”¨é€†åºå¦å®šçŽ¯è§†ï¼ŒåŒ¹é…å·¦ä¾§éžæ•°å­—çš„ä½ç½®s= 'aaa123're.sub(r'(?&lt;!\d)',',',b) æœ‰äº›ä¾‹å­ä¸æ˜¯å¾ˆåˆç†ï¼Œå°½é‡èƒ½è¡¨è¾¾æ¸…æ¥šçŽ¯è§†çš„å«ä¹‰å³å¯ã€‚ æ€»ç»“ï¼š 1çŽ¯è§†çš„åŠŸèƒ½éžå¸¸å¼ºå¤§ï¼Œä¹Ÿæ˜¯æ­£åˆ™ä¸­çš„ä¸€ä¸ªéš¾ç‚¹ï¼Œå¯¹äºŽçŽ¯è§†çš„ç†è§£ï¼Œå¯ä»¥ä»Žåº”ç”¨å’ŒåŽŸç†ä¸¤ä¸ªè§’åº¦ç†è§£ï¼Œå¦‚æžœæƒ³ç†è§£å¾—æ›´æ¸…æ™°ã€æ·±å…¥ä¸€äº›ï¼Œè¿˜æ˜¯ä»ŽåŽŸç†çš„è§’åº¦ç†è§£å¥½ä¸€äº›ï¼Œæ­£åˆ™åŒ¹é…åŸºæœ¬åŽŸç†å‚è€ƒ NFAå¼•æ“ŽåŒ¹é…åŽŸç†]]></content>
      <categories>
        <category>æ­£åˆ™è¡¨è¾¾å¼</category>
      </categories>
      <tags>
        <tag>æ­£åˆ™è¡¨è¾¾å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[centos7 ç¼–è¯‘ã€å®‰è£…ã€é…ç½®ã€å¯åŠ¨redis]]></title>
    <url>%2F2019%2F08%2F02%2Fcentos7-%E7%BC%96%E8%AF%91%E3%80%81%E5%AE%89%E8%A3%85%E3%80%81%E9%85%8D%E7%BD%AE%E3%80%81%E5%90%AF%E5%8A%A8reds%2F</url>
    <content type="text"><![CDATA[ä¸‹è½½Redisçš„å®‰è£…åŒ… wget http://download.redis.io/releases/redis-4.0.6.tar.gz è§£åŽ‹ tar -zxvf redis-4.0.6.tar.gz cd redis-4.0.6 ç¼–è¯‘ make MALLOC=libc çŽ¯å¢ƒé…ç½®ï¼Œå°†é…ç½®æ–‡ä»¶ä»¥ä½ æƒ³æš´éœ²çš„Redisä¸ºåï¼Œå¤åˆ¶åˆ°/etc/redis mkdir /etc/redis(éœ€è¦rootæƒé™) cp redis.conf /etc/redis/6379.conf cd utils &amp; vim redis_init_script ä¿®æ”¹ redis_init_scriptä¸­å¦‚å›¾æ‰€ç¤ºçš„éƒ¨åˆ† é…ç½®chkconfigæ˜¯ä¸ºäº†å¼€æœºé…ç½®å¼€æœºè‡ªå¯Redisï¼Œä¸‹é¢çš„æ¨ªçº¿éƒ¨åˆ†æ¢æˆä½ è‡ªå·±çš„Rediså®‰è£…è·¯å¾„ï¼Œå¯é€‰æ‹©è‡ªå·±æƒ³è¦æš´éœ²çš„ç«¯å£ å°†ä¿®æ”¹åŽçš„redis_init_scriptæ‹·è´è‡³å¼€æœºå¯åŠ¨ç›®å½•ï¼Œå¹¶ä¿®æ”¹æ–‡ä»¶åä¸ºredisd, ä¸€èˆ¬åŽå°æœåŠ¡éƒ½å·²dç»“å°¾ cp redis_init_script /etc/init.d/redisd è®¾ç½®å¼€æœºå¯åŠ¨ chkconfig redisd on å¦‚æžœä¹‹å‰æ²¡æœ‰åœ¨redis_init_scriptä¸­æ·»åŠ chkconfig,å°±ä¼šæç¤ºä¸æ”¯æŒè¯¥å‘½ä»¤ service redisd start å¯åŠ¨Redis åŽå°å¯åŠ¨çš„è¯ï¼Œservice redis start &amp;]]></content>
      <categories>
        <category>redis</category>
      </categories>
      <tags>
        <tag>redis</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysqlæ•°æ®åŽ»é‡]]></title>
    <url>%2F2019%2F07%2F01%2Fmysql%E6%95%B0%E6%8D%AE%E5%8E%BB%E9%87%8D%2F</url>
    <content type="text"><![CDATA[ä»Žexcelä¸­å¯¼å…¥äº†ä¸€éƒ¨åˆ†æ•°æ®åˆ°mysqlä¸­ï¼Œæœ‰å¾ˆå¤šæ•°æ®æ˜¯é‡å¤çš„ï¼Œè€Œä¸”æ²¡æœ‰ä¸»é”®ï¼Œéœ€è¦æŒ‰ç…§å…¶ä¸­å·²ç»å­˜åœ¨æŸä¸€åˆ—å¯¹æ•°æ®è¿›è¡ŒåŽ»é‡ã€‚ æ·»åŠ ä¸»é”®ç”±äºŽä¹‹å‰çš„å­—æ®µä¸­æ²¡æœ‰ä¸»é”®ï¼Œæ‰€ä»¥éœ€è¦æ–°å¢žä¸€ä¸ªå­—æ®µï¼Œå¹¶ä¸”å°†å…¶ä½œä¸ºä¸»é”®ã€‚ æ·»åŠ ä¸€ä¸ªæ–°çš„å­—æ®µidï¼Œå¯¹idä¸­çš„å€¼è¿›è¡Œé€’å¢žæ“ä½œï¼Œç„¶åŽå†è®¾ç½®ä¸ºä¸»é”®ã€‚ å¯¹idå­—æ®µè¿›è¡Œé€’å¢žçš„èµ‹å€¼æ“ä½œå¦‚ä¸‹ï¼š 12SET @r:=0;UPDATE table SET id=(@r:=@r+1); ç„¶åŽè®¾ç½®ä¸ºä¸»é”®å³å¯ã€‚ åŽ»é‡æ·»åŠ é€’å¢žçš„idå­—æ®µåŽï¼Œå°±å¯ä»¥å¯¹æ•°æ®æ ¹æ®æŸä¸ªå­—æ®µè¿›è¡ŒåŽ»é‡æ“ä½œï¼Œç­–ç•¥å°±æ˜¯ä¿å­˜idæœ€å°çš„é‚£æ¡æ•°æ®ã€‚ 123456789101112131415161718192021DELETE FROM `table`WHERE`åŽ»é‡å­—æ®µå` IN ( SELECT x FROM ( SELECT `åŽ»é‡å­—æ®µå` AS x FROM `table` GROUP BY `åŽ»é‡å­—æ®µå` HAVING COUNT(`åŽ»é‡å­—æ®µå`) &gt; 1 ) tmp0)AND `é€’å¢žä¸»é”®å` NOT IN ( SELECT y FROM ( SELECT min(`é€’å¢žä¸»é”®å`) AS y FROM `table` GROUP BY `åŽ»é‡å­—æ®µå` HAVING COUNT(`åŽ»é‡å­—æ®µå`) &gt; 1 ) tmp1)]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[dokcer.service æç¤ºç¼ºå¤±bridgeç½‘ç»œï¼Œå¯¼è‡´Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?]]></title>
    <url>%2F2019%2F06%2F04%2Fdokcer-service-%E6%8F%90%E7%A4%BA%E7%BC%BA%E5%A4%B1bridge%E7%BD%91%E7%BB%9C%EF%BC%8C%E5%AF%BC%E8%87%B4Cannot-connect-to-the-Docker-daemon-at-unix-var-run-docker-sock-Is-the-docker-daemon-running%2F</url>
    <content type="text"><![CDATA[æ“ä½œè¿‡ç¨‹ï¼š ä¸ºCentOS7å®‰è£…Dockerï¼Œå®‰è£…æˆåŠŸåŽï¼Œå¯ä»¥æ‰§è¡Œdockerï¼Œä½†æ˜¯docker psç­‰å‘½ä»¤ä¼šæŠ¥é”™ï¼š 1Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running? åˆ†æžï¼š ä¸€èˆ¬è¿™ç§é”™è¯¯éƒ½æ˜¯ç”±äºŽæ“ä½œè€…æ²¡æœ‰rootæƒé™ï¼Œä½†æ˜¯ä½¿ç”¨sudoæ‰§è¡Œä¹Ÿæ˜¯åŒæ ·çš„é—®é¢˜ï¼Œè¿™å°±çº³é—·äº†ï¼Œæ²¡å…³ç³»ï¼Œçœ‹ä¸€ä¸‹docker.serviceçš„æ‰§è¡Œæ—¥å¿—ï¼š 1systemctl status docker.service å‘çŽ°æœ‰ä¸€å¥å¾ˆé‡è¦çš„è¯ï¼š 1Error starting daemon: Error initializing network controller: list bridge addresses failed: no available network è¿™æ˜¯ç”±äºŽå¯åŠ¨Dockerçš„æ—¶å€™ï¼Œé»˜è®¤çš„ç½‘ç»œæ¨¡å¼æ˜¯æ¡¥æŽ¥æ¨¡å¼ï¼Œè¿™å°±éœ€è¦å‘æ“ä½œç³»ç»Ÿå‘é€ä¿¡å·ï¼Œè®©å®ƒå¸®æˆ‘ä»¬å»ºç«‹ä¸€ä¸ªbridgeç½‘ç»œå‘½åä¸ºdocker0, å¹¶ä¸”åˆ†é…172.17.0.1/16ã€‚ä½†æ˜¯å‡ºäºŽæŸç§åŽŸå› ï¼Œè¯¥ç½‘ç»œæ²¡æœ‰å»ºç«‹èµ·æ¥ï¼Œæˆ‘ä»¬åªè¦æ‰‹åŠ¨æ‰§è¡Œè¿™ä¸€ç³»åˆ—æ“ä½œå°±å¯ä»¥ï¼š 123ip link add name docker0 type bridgeip addr add dev docker0 172.17.0.1/16 æœ€åŽé‡å¯docker: 1systemclt restart docker]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python æ­£åˆ™è¡¨è¾¾å¼åŠreè¯¦è§£]]></title>
    <url>%2F2019%2F04%2F28%2Fpython-%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F%E5%8F%8Are%E8%AF%A6%E8%A7%A3%2F</url>
    <content type="text"><![CDATA[Python æ­£åˆ™è¡¨è¾¾å¼ re æ¨¡å—ç®€ä»‹æ­£åˆ™è¡¨è¾¾å¼ï¼ˆregular expressionï¼‰æ˜¯å¯ä»¥åŒ¹é…æ–‡æœ¬ç‰‡æ®µçš„æ¨¡å¼ã€‚æœ€ç®€å•çš„æ­£åˆ™è¡¨è¾¾å¼å°±æ˜¯æ™®é€šå­—ç¬¦ä¸²ï¼Œå¯ä»¥åŒ¹é…å…¶è‡ªèº«ã€‚æ¯”å¦‚ï¼Œæ­£åˆ™è¡¨è¾¾å¼ â€˜helloâ€™ å¯ä»¥åŒ¹é…å­—ç¬¦ä¸² â€˜helloâ€™ã€‚ è¦æ³¨æ„çš„æ˜¯ï¼Œæ­£åˆ™è¡¨è¾¾å¼å¹¶ä¸æ˜¯ä¸€ä¸ªç¨‹åºï¼Œè€Œæ˜¯ç”¨äºŽå¤„ç†å­—ç¬¦ä¸²çš„ä¸€ç§æ¨¡å¼ï¼Œå¦‚æžœä½ æƒ³ç”¨å®ƒæ¥å¤„ç†å­—ç¬¦ä¸²ï¼Œå°±å¿…é¡»ä½¿ç”¨æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼çš„å·¥å…·ï¼Œæ¯”å¦‚ Linux ä¸­çš„ awk, sed, grepï¼Œæˆ–è€…ç¼–ç¨‹è¯­è¨€ Perl, Python, Java ç­‰ç­‰ã€‚ æ­£åˆ™è¡¨è¾¾å¼æœ‰å¤šç§ä¸åŒçš„é£Žæ ¼ï¼Œä¸‹è¡¨åˆ—å‡ºäº†é€‚ç”¨äºŽ Python æˆ– Perl ç­‰ç¼–ç¨‹è¯­è¨€çš„éƒ¨åˆ†å…ƒå­—ç¬¦ä»¥åŠè¯´æ˜Žï¼š re æ¨¡å—åœ¨ Python ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…ç½®çš„ re æ¨¡å—æ¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ã€‚ æœ‰ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œæ­£åˆ™è¡¨è¾¾å¼ä½¿ç”¨ \ å¯¹ç‰¹æ®Šå­—ç¬¦è¿›è¡Œè½¬ä¹‰ï¼Œæ¯”å¦‚ï¼Œä¸ºäº†åŒ¹é…å­—ç¬¦ä¸² â€˜python.orgâ€™ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ &#39;python\.org&#39;ï¼Œè€Œ Python çš„å­—ç¬¦ä¸²æœ¬èº«ä¹Ÿç”¨ \ è½¬ä¹‰ï¼Œæ‰€ä»¥ä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼åœ¨ Python ä¸­åº”è¯¥å†™æˆ &#39;python\\.org&#39;ï¼Œè¿™ä¼šå¾ˆå®¹æ˜“é™·å…¥ \ çš„å›°æ‰°ä¸­ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å»ºè®®ä½¿ç”¨ Python çš„åŽŸå§‹å­—ç¬¦ä¸²ï¼Œåªéœ€åŠ ä¸€ä¸ª r å‰ç¼€ï¼Œä¸Šé¢çš„æ­£åˆ™è¡¨è¾¾å¼å¯ä»¥å†™æˆï¼š 1r&apos;python\.org&apos; re æ¨¡å—æä¾›äº†ä¸å°‘æœ‰ç”¨çš„å‡½æ•°ï¼Œç”¨ä»¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œæ¯”å¦‚ï¼š compile å‡½æ•° match å‡½æ•° search å‡½æ•° findall å‡½æ•° finditer å‡½æ•° split å‡½æ•° sub å‡½æ•° subn å‡½æ•° re æ¨¡å—çš„ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š ä½¿ç”¨ compile å‡½æ•°å°†æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å½¢å¼ç¼–è¯‘ä¸ºä¸€ä¸ª Pattern å¯¹è±¡ é€šè¿‡ Pattern å¯¹è±¡æä¾›çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼ŒèŽ·å¾—åŒ¹é…ç»“æžœï¼ˆä¸€ä¸ª Match å¯¹è±¡ï¼‰ æœ€åŽä½¿ç”¨ Match å¯¹è±¡æä¾›çš„å±žæ€§å’Œæ–¹æ³•èŽ·å¾—ä¿¡æ¯ï¼Œæ ¹æ®éœ€è¦è¿›è¡Œå…¶ä»–çš„æ“ä½œ compile å‡½æ•°compile å‡½æ•°ç”¨äºŽç¼–è¯‘æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”Ÿæˆä¸€ä¸ª Pattern å¯¹è±¡ï¼Œå®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.compile(pattern[, flag]) å…¶ä¸­ï¼Œpattern æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å½¢å¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œflag æ˜¯ä¸€ä¸ªå¯é€‰å‚æ•°ï¼Œè¡¨ç¤ºåŒ¹é…æ¨¡å¼ï¼Œæ¯”å¦‚å¿½ç•¥å¤§å°å†™ï¼Œå¤šè¡Œæ¨¡å¼ç­‰ã€‚ ä¸‹é¢ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹ä¾‹å­ã€‚ 1234import re# å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆ Pattern å¯¹è±¡ pattern = re.compile(r&apos;\d+&apos;) åœ¨ä¸Šé¢ï¼Œæˆ‘ä»¬å·²å°†ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆ Pattern å¯¹è±¡ï¼ŒæŽ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ©ç”¨ pattern çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾äº†ã€‚Pattern å¯¹è±¡çš„ä¸€äº›å¸¸ç”¨æ–¹æ³•ä¸»è¦æœ‰ï¼š match æ–¹æ³• search æ–¹æ³• findall æ–¹æ³• finditer æ–¹æ³• split æ–¹æ³• sub æ–¹æ³• subn æ–¹æ³• match æ–¹æ³•match æ–¹æ³•ç”¨äºŽæŸ¥æ‰¾å­—ç¬¦ä¸²çš„å¤´éƒ¨ï¼ˆä¹Ÿå¯ä»¥æŒ‡å®šèµ·å§‹ä½ç½®ï¼‰ï¼Œå®ƒæ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æžœå°±è¿”å›žï¼Œè€Œä¸æ˜¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç»“æžœã€‚å®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1match(string[, pos[, endpos]]) å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚å› æ­¤ï¼Œå½“ä½ ä¸æŒ‡å®š pos å’Œ endpos æ—¶ï¼Œmatch æ–¹æ³•é»˜è®¤åŒ¹é…å­—ç¬¦ä¸²çš„å¤´éƒ¨ã€‚ å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›žä¸€ä¸ª Match å¯¹è±¡ï¼Œå¦‚æžœæ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™è¿”å›ž Noneã€‚ çœ‹çœ‹ä¾‹å­ã€‚ 12345678910111213141516171819&gt;&gt;&gt; import re&gt;&gt;&gt; pattern = re.compile(r&apos;\d+&apos;) # ç”¨äºŽåŒ¹é…è‡³å°‘ä¸€ä¸ªæ•°å­—&gt;&gt;&gt; m = pattern.match(&apos;one12twothree34four&apos;) # æŸ¥æ‰¾å¤´éƒ¨ï¼Œæ²¡æœ‰åŒ¹é…&gt;&gt;&gt; print mNone&gt;&gt;&gt; m = pattern.match(&apos;one12twothree34four&apos;, 2, 10) # ä»Ž&apos;e&apos;çš„ä½ç½®å¼€å§‹åŒ¹é…ï¼Œæ²¡æœ‰åŒ¹é…&gt;&gt;&gt; print mNone&gt;&gt;&gt; m = pattern.match(&apos;one12twothree34four&apos;, 3, 10) # ä»Ž&apos;1&apos;çš„ä½ç½®å¼€å§‹åŒ¹é…ï¼Œæ­£å¥½åŒ¹é…&gt;&gt;&gt; print m # è¿”å›žä¸€ä¸ª Match å¯¹è±¡&lt;_sre.SRE_Match object at 0x10a42aac0&gt;&gt;&gt;&gt; m.group(0) # å¯çœç•¥ 0&apos;12&apos;&gt;&gt;&gt; m.start(0) # å¯çœç•¥ 03&gt;&gt;&gt; m.end(0) # å¯çœç•¥ 05&gt;&gt;&gt; m.span(0) # å¯çœç•¥ 0(3, 5) åœ¨ä¸Šé¢ï¼Œå½“åŒ¹é…æˆåŠŸæ—¶è¿”å›žä¸€ä¸ª Match å¯¹è±¡ï¼Œå…¶ä¸­ï¼š group([group1, â€¦]) æ–¹æ³•ç”¨äºŽèŽ·å¾—ä¸€ä¸ªæˆ–å¤šä¸ªåˆ†ç»„åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œå½“è¦èŽ·å¾—æ•´ä¸ªåŒ¹é…çš„å­ä¸²æ—¶ï¼Œå¯ç›´æŽ¥ä½¿ç”¨ group() æˆ– group(0)ï¼› start([group]) æ–¹æ³•ç”¨äºŽèŽ·å–åˆ†ç»„åŒ¹é…çš„å­ä¸²åœ¨æ•´ä¸ªå­—ç¬¦ä¸²ä¸­çš„èµ·å§‹ä½ç½®ï¼ˆå­ä¸²ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•ï¼‰ï¼Œå‚æ•°é»˜è®¤å€¼ä¸º 0ï¼› end([group]) æ–¹æ³•ç”¨äºŽèŽ·å–åˆ†ç»„åŒ¹é…çš„å­ä¸²åœ¨æ•´ä¸ªå­—ç¬¦ä¸²ä¸­çš„ç»“æŸä½ç½®ï¼ˆå­ä¸²æœ€åŽä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•+1ï¼‰ï¼Œå‚æ•°é»˜è®¤å€¼ä¸º 0ï¼› span([group]) æ–¹æ³•è¿”å›ž (start(group), end(group))ã€‚ å†çœ‹çœ‹ä¸€ä¸ªä¾‹å­ï¼š 1234567891011121314151617181920212223&gt;&gt;&gt; import re&gt;&gt;&gt; pattern = re.compile(r&apos;([a-z]+) ([a-z]+)&apos;, re.I) # re.I è¡¨ç¤ºå¿½ç•¥å¤§å°å†™&gt;&gt;&gt; m = pattern.match(&apos;Hello World Wide Web&apos;)&gt;&gt;&gt; print m # åŒ¹é…æˆåŠŸï¼Œè¿”å›žä¸€ä¸ª Match å¯¹è±¡&lt;_sre.SRE_Match object at 0x10bea83e8&gt;&gt;&gt;&gt; m.group(0) # è¿”å›žåŒ¹é…æˆåŠŸçš„æ•´ä¸ªå­ä¸²&apos;Hello World&apos;&gt;&gt;&gt; m.span(0) # è¿”å›žåŒ¹é…æˆåŠŸçš„æ•´ä¸ªå­ä¸²çš„ç´¢å¼•(0, 11)&gt;&gt;&gt; m.group(1) # è¿”å›žç¬¬ä¸€ä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²&apos;Hello&apos;&gt;&gt;&gt; m.span(1) # è¿”å›žç¬¬ä¸€ä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²çš„ç´¢å¼•(0, 5)&gt;&gt;&gt; m.group(2) # è¿”å›žç¬¬äºŒä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²&apos;World&apos;&gt;&gt;&gt; m.span(2) # è¿”å›žç¬¬äºŒä¸ªåˆ†ç»„åŒ¹é…æˆåŠŸçš„å­ä¸²(6, 11)&gt;&gt;&gt; m.groups() # ç­‰ä»·äºŽ (m.group(1), m.group(2), ...)(&apos;Hello&apos;, &apos;World&apos;)&gt;&gt;&gt; m.group(3) # ä¸å­˜åœ¨ç¬¬ä¸‰ä¸ªåˆ†ç»„Traceback (most recent call last): File &quot;&lt;stdin&gt;&quot;, line 1, in &lt;module&gt;IndexError: no such group search æ–¹æ³•search æ–¹æ³•ç”¨äºŽæŸ¥æ‰¾å­—ç¬¦ä¸²çš„ä»»ä½•ä½ç½®ï¼Œå®ƒä¹Ÿæ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æžœå°±è¿”å›žï¼Œè€Œä¸æ˜¯æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„ç»“æžœï¼Œå®ƒçš„ä¸€èˆ¬ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1search(string[, pos[, endpos]]) å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚ å½“åŒ¹é…æˆåŠŸæ—¶ï¼Œè¿”å›žä¸€ä¸ª Match å¯¹è±¡ï¼Œå¦‚æžœæ²¡æœ‰åŒ¹é…ä¸Šï¼Œåˆ™è¿”å›ž Noneã€‚ è®©æˆ‘ä»¬çœ‹çœ‹ä¾‹å­ï¼š 1234567891011121314&gt;&gt;&gt; import re&gt;&gt;&gt; pattern = re.compile(&apos;\d+&apos;)&gt;&gt;&gt; m = pattern.search(&apos;one12twothree34four&apos;) # è¿™é‡Œå¦‚æžœä½¿ç”¨ match æ–¹æ³•åˆ™ä¸åŒ¹é…&gt;&gt;&gt; m&lt;_sre.SRE_Match object at 0x10cc03ac0&gt;&gt;&gt;&gt; m.group()&apos;12&apos;&gt;&gt;&gt; m = pattern.search(&apos;one12twothree34four&apos;, 10, 30) # æŒ‡å®šå­—ç¬¦ä¸²åŒºé—´&gt;&gt;&gt; m&lt;_sre.SRE_Match object at 0x10cc03b28&gt;&gt;&gt;&gt; m.group()&apos;34&apos;&gt;&gt;&gt; m.span()(13, 15) å†æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š 123456789101112131415# -*- coding: utf-8 -*-import re # å°†æ­£åˆ™è¡¨è¾¾å¼ç¼–è¯‘æˆ Pattern å¯¹è±¡pattern = re.compile(r&apos;\d+&apos;) # ä½¿ç”¨ search() æŸ¥æ‰¾åŒ¹é…çš„å­ä¸²ï¼Œä¸å­˜åœ¨åŒ¹é…çš„å­ä¸²æ—¶å°†è¿”å›ž None # è¿™é‡Œä½¿ç”¨ match() æ— æ³•æˆåŠŸåŒ¹é… m = pattern.search(&apos;hello 123456 789&apos;) if m: # ä½¿ç”¨ Match èŽ·å¾—åˆ†ç»„ä¿¡æ¯ print &apos;matching string:&apos;,m.group() print &apos;position:&apos;,m.span() æ‰§è¡Œç»“æžœï¼š 12matching string: 123456position: (6, 12) findall æ–¹æ³•ä¸Šé¢çš„ match å’Œ search æ–¹æ³•éƒ½æ˜¯ä¸€æ¬¡åŒ¹é…ï¼Œåªè¦æ‰¾åˆ°äº†ä¸€ä¸ªåŒ¹é…çš„ç»“æžœå°±è¿”å›žã€‚ç„¶è€Œï¼Œåœ¨å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æœç´¢æ•´ä¸ªå­—ç¬¦ä¸²ï¼ŒèŽ·å¾—æ‰€æœ‰åŒ¹é…çš„ç»“æžœã€‚ findall æ–¹æ³•çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1findall(string[, pos[, endpos]]) å…¶ä¸­ï¼Œstring æ˜¯å¾…åŒ¹é…çš„å­—ç¬¦ä¸²ï¼Œpos å’Œ endpos æ˜¯å¯é€‰å‚æ•°ï¼ŒæŒ‡å®šå­—ç¬¦ä¸²çš„èµ·å§‹å’Œç»ˆç‚¹ä½ç½®ï¼Œé»˜è®¤å€¼åˆ†åˆ«æ˜¯ 0 å’Œ len (å­—ç¬¦ä¸²é•¿åº¦)ã€‚ findall ä»¥åˆ—è¡¨å½¢å¼è¿”å›žå…¨éƒ¨èƒ½åŒ¹é…çš„å­ä¸²ï¼Œå¦‚æžœæ²¡æœ‰åŒ¹é…ï¼Œåˆ™è¿”å›žä¸€ä¸ªç©ºåˆ—è¡¨ã€‚ çœ‹çœ‹ä¾‹å­ï¼š 12345678import re pattern = re.compile(r&apos;\d+&apos;) # æŸ¥æ‰¾æ•°å­—result1 = pattern.findall(&apos;hello 123456 789&apos;)result2 = pattern.findall(&apos;one1two2three3four4&apos;, 0, 10) print result1print result2 æ‰§è¡Œç»“æžœï¼š 12[&apos;123456&apos;, &apos;789&apos;][&apos;1&apos;, &apos;2&apos;] finditer æ–¹æ³•finditer æ–¹æ³•çš„è¡Œä¸ºè·Ÿ findall çš„è¡Œä¸ºç±»ä¼¼ï¼Œä¹Ÿæ˜¯æœç´¢æ•´ä¸ªå­—ç¬¦ä¸²ï¼ŒèŽ·å¾—æ‰€æœ‰åŒ¹é…çš„ç»“æžœã€‚ä½†å®ƒè¿”å›žä¸€ä¸ªé¡ºåºè®¿é—®æ¯ä¸€ä¸ªåŒ¹é…ç»“æžœï¼ˆMatch å¯¹è±¡ï¼‰çš„è¿­ä»£å™¨ã€‚ çœ‹çœ‹ä¾‹å­ï¼š 12345678910111213141516171819# -*- coding: utf-8 -*-import re pattern = re.compile(r&apos;\d+&apos;)result_iter1 = pattern.finditer(&apos;hello 123456 789&apos;)result_iter2 = pattern.finditer(&apos;one1two2three3four4&apos;, 0, 10)print type(result_iter1)print type(result_iter2)print &apos;result1...&apos;for m1 in result_iter1: # m1 æ˜¯ Match å¯¹è±¡ print &apos;matching string: &#123;&#125;, position: &#123;&#125;&apos;.format(m1.group(), m1.span())print &apos;result2...&apos;for m2 in result_iter2: print &apos;matching string: &#123;&#125;, position: &#123;&#125;&apos;.format(m2.group(), m2.span()) æ‰§è¡Œç»“æžœï¼š 12345678&lt;type &apos;callable-iterator&apos;&gt;&lt;type &apos;callable-iterator&apos;&gt;result1...matching string: 123456, position: (6, 12)matching string: 789, position: (13, 16)result2...matching string: 1, position: (3, 4)matching string: 2, position: (7, 8) split æ–¹æ³•split æ–¹æ³•æŒ‰ç…§èƒ½å¤ŸåŒ¹é…çš„å­ä¸²å°†å­—ç¬¦ä¸²åˆ†å‰²åŽè¿”å›žåˆ—è¡¨ï¼Œå®ƒçš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1split(string[, maxsplit]) å…¶ä¸­ï¼Œmaxsplit ç”¨äºŽæŒ‡å®šæœ€å¤§åˆ†å‰²æ¬¡æ•°ï¼Œä¸æŒ‡å®šå°†å…¨éƒ¨åˆ†å‰²ã€‚ çœ‹çœ‹ä¾‹å­ï¼š 1234import re p = re.compile(r&apos;[\s\,\;]+&apos;)print p.split(&apos;a,b;; c d&apos;) æ‰§è¡Œç»“æžœï¼š 1[&apos;a&apos;, &apos;b&apos;, &apos;c&apos;, &apos;d&apos;] sub æ–¹æ³•sub æ–¹æ³•ç”¨äºŽæ›¿æ¢ã€‚å®ƒçš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1sub(repl, string[, count]) å…¶ä¸­ï¼Œrepl å¯ä»¥æ˜¯å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªå‡½æ•°ï¼š å¦‚æžœ repl æ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™ä¼šä½¿ç”¨ repl åŽ»æ›¿æ¢å­—ç¬¦ä¸²æ¯ä¸€ä¸ªåŒ¹é…çš„å­ä¸²ï¼Œå¹¶è¿”å›žæ›¿æ¢åŽçš„å­—ç¬¦ä¸²ï¼Œå¦å¤–ï¼Œrepl è¿˜å¯ä»¥ä½¿ç”¨ \id çš„å½¢å¼æ¥å¼•ç”¨åˆ†ç»„ï¼Œä½†ä¸èƒ½ä½¿ç”¨ç¼–å· 0ï¼› å¦‚æžœ repl æ˜¯å‡½æ•°ï¼Œè¿™ä¸ªæ–¹æ³•åº”å½“åªæŽ¥å—ä¸€ä¸ªå‚æ•°ï¼ˆMatch å¯¹è±¡ï¼‰ï¼Œå¹¶è¿”å›žä¸€ä¸ªå­—ç¬¦ä¸²ç”¨äºŽæ›¿æ¢ï¼ˆè¿”å›žçš„å­—ç¬¦ä¸²ä¸­ä¸èƒ½å†å¼•ç”¨åˆ†ç»„ï¼‰ã€‚ count ç”¨äºŽæŒ‡å®šæœ€å¤šæ›¿æ¢æ¬¡æ•°ï¼Œä¸æŒ‡å®šæ—¶å…¨éƒ¨æ›¿æ¢ã€‚ çœ‹çœ‹ä¾‹å­ï¼š 123456789101112import re p = re.compile(r&apos;(\w+) (\w+)&apos;)s = &apos;hello 123, hello 456&apos;def func(m): return &apos;hi&apos; + &apos; &apos; + m.group(2)print p.sub(r&apos;hello world&apos;, s) # ä½¿ç”¨ &apos;hello world&apos; æ›¿æ¢ &apos;hello 123&apos; å’Œ &apos;hello 456&apos;print p.sub(r&apos;\2 \1&apos;, s) # å¼•ç”¨åˆ†ç»„print p.sub(func, s)print p.sub(func, s, 1) # æœ€å¤šæ›¿æ¢ä¸€æ¬¡ æ‰§è¡Œç»“æžœï¼š 1234hello world, hello world123 hello, 456 hellohi 123, hi 456hi 123, hello 456 subn æ–¹æ³•subn æ–¹æ³•è·Ÿ sub æ–¹æ³•çš„è¡Œä¸ºç±»ä¼¼ï¼Œä¹Ÿç”¨äºŽæ›¿æ¢ã€‚å®ƒçš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1subn(repl, string[, count]) å®ƒè¿”å›žä¸€ä¸ªå…ƒç»„ï¼š 1(sub(repl, string[, count]), æ›¿æ¢æ¬¡æ•°) å…ƒç»„æœ‰ä¸¤ä¸ªå…ƒç´ ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ æ˜¯ä½¿ç”¨ sub æ–¹æ³•çš„ç»“æžœï¼Œç¬¬äºŒä¸ªå…ƒç´ è¿”å›žåŽŸå­—ç¬¦ä¸²è¢«æ›¿æ¢çš„æ¬¡æ•°ã€‚ çœ‹çœ‹ä¾‹å­ï¼š 123456789101112import re p = re.compile(r&apos;(\w+) (\w+)&apos;)s = &apos;hello 123, hello 456&apos;def func(m): return &apos;hi&apos; + &apos; &apos; + m.group(2)print p.subn(r&apos;hello world&apos;, s)print p.subn(r&apos;\2 \1&apos;, s)print p.subn(func, s)print p.subn(func, s, 1) æ‰§è¡Œç»“æžœï¼š 1234(&apos;hello world, hello world&apos;, 2)(&apos;123 hello, 456 hello&apos;, 2)(&apos;hi 123, hi 456&apos;, 2)(&apos;hi 123, hello 456&apos;, 1) å…¶ä»–å‡½æ•°äº‹å®žä¸Šï¼Œä½¿ç”¨ compile å‡½æ•°ç”Ÿæˆçš„ Pattern å¯¹è±¡çš„ä¸€ç³»åˆ—æ–¹æ³•è·Ÿ re æ¨¡å—çš„å¤šæ•°å‡½æ•°æ˜¯å¯¹åº”çš„ï¼Œä½†åœ¨ä½¿ç”¨ä¸Šæœ‰ç»†å¾®å·®åˆ«ã€‚ match å‡½æ•°match å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.match(pattern, string[, flags]): å…¶ä¸­ï¼Œpattern æ˜¯æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å½¢å¼ï¼Œæ¯”å¦‚ \d+, [a-z]+ã€‚ è€Œ Pattern å¯¹è±¡çš„ match æ–¹æ³•ä½¿ç”¨å½¢å¼æ˜¯ï¼š 1match(string[, pos[, endpos]]) å¯ä»¥çœ‹åˆ°ï¼Œmatch å‡½æ•°ä¸èƒ½æŒ‡å®šå­—ç¬¦ä¸²çš„åŒºé—´ï¼Œå®ƒåªèƒ½æœç´¢å¤´éƒ¨ï¼Œçœ‹çœ‹ä¾‹å­ï¼š 12345678910111213import rem1 = re.match(r&apos;\d+&apos;, &apos;One12twothree34four&apos;)if m1: print &apos;matching string:&apos;,m1.group()else: print &apos;m1 is:&apos;,m1 m2 = re.match(r&apos;\d+&apos;, &apos;12twothree34four&apos;)if m2: print &apos;matching string:&apos;, m2.group()else: print &apos;m2 is:&apos;,m2 æ‰§è¡Œç»“æžœï¼š 12m1 is: Nonematching string: 12 search å‡½æ•°search å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.search(pattern, string[, flags]) search å‡½æ•°ä¸èƒ½æŒ‡å®šå­—ç¬¦ä¸²çš„æœç´¢åŒºé—´ï¼Œç”¨æ³•è·Ÿ Pattern å¯¹è±¡çš„ search æ–¹æ³•ç±»ä¼¼ã€‚ findall å‡½æ•°findall å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.findall(pattern, string[, flags]) findall å‡½æ•°ä¸èƒ½æŒ‡å®šå­—ç¬¦ä¸²çš„æœç´¢åŒºé—´ï¼Œç”¨æ³•è·Ÿ Pattern å¯¹è±¡çš„ findall æ–¹æ³•ç±»ä¼¼ã€‚ çœ‹çœ‹ä¾‹å­ï¼š 123456import reprint re.findall(r&apos;\d+&apos;, &apos;hello 12345 789&apos;)# è¾“å‡º[&apos;12345&apos;, &apos;789&apos;] finditer å‡½æ•°finditer å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•è·Ÿ Pattern çš„ finditer æ–¹æ³•ç±»ä¼¼ï¼Œå½¢å¼å¦‚ä¸‹ï¼š 1re.finditer(pattern, string[, flags]) split å‡½æ•°split å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.split(pattern, string[, maxsplit]) sub å‡½æ•°sub å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.sub(pattern, repl, string[, count]) subn å‡½æ•°subn å‡½æ•°çš„ä½¿ç”¨å½¢å¼å¦‚ä¸‹ï¼š 1re.subn(pattern, repl, string[, count]) åˆ°åº•ç”¨å“ªç§æ–¹å¼ä»Žä¸Šæ–‡å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨ re æ¨¡å—æœ‰ä¸¤ç§æ–¹å¼ï¼š ä½¿ç”¨ re.compile å‡½æ•°ç”Ÿæˆä¸€ä¸ª Pattern å¯¹è±¡ï¼Œç„¶åŽä½¿ç”¨ Pattern å¯¹è±¡çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼› ç›´æŽ¥ä½¿ç”¨ re.match, re.search å’Œ re.findall ç­‰å‡½æ•°ç›´æŽ¥å¯¹æ–‡æœ¬åŒ¹é…æŸ¥æ‰¾ï¼› ä¸‹é¢ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªä¾‹å­å±•ç¤ºè¿™ä¸¤ç§æ–¹æ³•ã€‚ å…ˆçœ‹ç¬¬ 1 ç§ç”¨æ³•ï¼š 12345678import re# å°†æ­£åˆ™è¡¨è¾¾å¼å…ˆç¼–è¯‘æˆ Pattern å¯¹è±¡pattern = re.compile(r&apos;\d+&apos;)print pattern.match(&apos;123, 123&apos;)print pattern.search(&apos;234, 234&apos;)print pattern.findall(&apos;345, 345&apos;) å†çœ‹ç¬¬ 2 ç§ç”¨æ³•ï¼š 12345import reprint re.match(r&apos;\d+&apos;, &apos;123, 123&apos;)print re.search(r&apos;\d+&apos;, &apos;234, 234&apos;)print re.findall(r&apos;\d+&apos;, &apos;345, 345&apos;) å¦‚æžœä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼éœ€è¦ç”¨åˆ°å¤šæ¬¡ï¼ˆæ¯”å¦‚ä¸Šé¢çš„ \d+ï¼‰ï¼Œåœ¨å¤šç§åœºåˆç»å¸¸éœ€è¦è¢«ç”¨åˆ°ï¼Œå‡ºäºŽæ•ˆçŽ‡çš„è€ƒè™‘ï¼Œæˆ‘ä»¬åº”è¯¥é¢„å…ˆç¼–è¯‘è¯¥æ­£åˆ™è¡¨è¾¾å¼ï¼Œç”Ÿæˆä¸€ä¸ª Pattern å¯¹è±¡ï¼Œå†ä½¿ç”¨è¯¥å¯¹è±¡çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹éœ€è¦åŒ¹é…çš„æ–‡ä»¶è¿›è¡ŒåŒ¹é…ï¼›è€Œå¦‚æžœç›´æŽ¥ä½¿ç”¨ re.match, re.search ç­‰å‡½æ•°ï¼Œæ¯æ¬¡ä¼ å…¥ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ï¼Œå®ƒéƒ½ä¼šè¢«ç¼–è¯‘ä¸€æ¬¡ï¼Œæ•ˆçŽ‡å°±ä¼šå¤§æ‰“æŠ˜æ‰£ã€‚ å› æ­¤ï¼Œæˆ‘ä»¬æŽ¨èä½¿ç”¨ç¬¬ 1 ç§ç”¨æ³•ã€‚ åŒ¹é…ä¸­æ–‡åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æƒ³åŒ¹é…æ–‡æœ¬ä¸­çš„æ±‰å­—ï¼Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸­æ–‡çš„ unicode ç¼–ç èŒƒå›´ ä¸»è¦åœ¨ [\u4e00-\u9fa5]ï¼Œè¿™é‡Œè¯´ä¸»è¦æ˜¯å› ä¸ºè¿™ä¸ªèŒƒå›´å¹¶ä¸å®Œæ•´ï¼Œæ¯”å¦‚æ²¡æœ‰åŒ…æ‹¬å…¨è§’ï¼ˆä¸­æ–‡ï¼‰æ ‡ç‚¹ï¼Œä¸è¿‡ï¼Œåœ¨å¤§éƒ¨åˆ†æƒ…å†µä¸‹ï¼Œåº”è¯¥æ˜¯å¤Ÿç”¨çš„ã€‚ å‡è®¾çŽ°åœ¨æƒ³æŠŠå­—ç¬¦ä¸² title = u&#39;ä½ å¥½ï¼Œhelloï¼Œä¸–ç•Œ&#39; ä¸­çš„ä¸­æ–‡æå–å‡ºæ¥ï¼Œå¯ä»¥è¿™ä¹ˆåšï¼š 123456789# -*- coding: utf-8 -*-import retitle = u&apos;ä½ å¥½ï¼Œhelloï¼Œä¸–ç•Œ&apos;pattern = re.compile(ur&apos;[\u4e00-\u9fa5]+&apos;)result = pattern.findall(title)print result æ³¨æ„åˆ°ï¼Œæˆ‘ä»¬åœ¨æ­£åˆ™è¡¨è¾¾å¼å‰é¢åŠ ä¸Šäº†ä¸¤ä¸ªå‰ç¼€ urï¼Œå…¶ä¸­ r è¡¨ç¤ºä½¿ç”¨åŽŸå§‹å­—ç¬¦ä¸²ï¼Œu è¡¨ç¤ºæ˜¯ unicode å­—ç¬¦ä¸²ã€‚ æ‰§è¡Œç»“æžœ: 1[u&apos;\u4f60\u597d&apos;, u&apos;\u4e16\u754c&apos;] è´ªå©ªåŒ¹é…åœ¨ Python ä¸­ï¼Œæ­£åˆ™åŒ¹é…é»˜è®¤æ˜¯è´ªå©ªåŒ¹é…ï¼ˆåœ¨å°‘æ•°è¯­è¨€ä¸­å¯èƒ½æ˜¯éžè´ªå©ªï¼‰ï¼Œä¹Ÿå°±æ˜¯åŒ¹é…å°½å¯èƒ½å¤šçš„å­—ç¬¦ã€‚ æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³æ‰¾å‡ºå­—ç¬¦ä¸²ä¸­çš„æ‰€æœ‰ div å—ï¼š 1234567import recontent = &apos;aa&lt;div&gt;test1&lt;/div&gt;bb&lt;div&gt;test2&lt;/div&gt;cc&apos;pattern = re.compile(r&apos;&lt;div&gt;.*&lt;/div&gt;&apos;)result = pattern.findall(content)print result æ‰§è¡Œç»“æžœï¼š 1[&apos;&lt;div&gt;test1&lt;/div&gt;bb&lt;div&gt;test2&lt;/div&gt;&apos;] ç”±äºŽæ­£åˆ™åŒ¹é…æ˜¯è´ªå©ªåŒ¹é…ï¼Œä¹Ÿå°±æ˜¯å°½å¯èƒ½å¤šçš„åŒ¹é…ï¼Œå› æ­¤ï¼Œåœ¨æˆåŠŸåŒ¹é…åˆ°ç¬¬ä¸€ä¸ª &lt;/div&gt; æ—¶ï¼Œå®ƒè¿˜ä¼šå‘å³å°è¯•åŒ¹é…ï¼ŒæŸ¥çœ‹æ˜¯å¦è¿˜æœ‰æ›´é•¿çš„å¯ä»¥æˆåŠŸåŒ¹é…çš„å­ä¸²ã€‚ å¦‚æžœæˆ‘ä»¬æƒ³éžè´ªå©ªåŒ¹é…ï¼Œå¯ä»¥åŠ ä¸€ä¸ª ?ï¼Œå¦‚ä¸‹ï¼š 1234567import recontent = &apos;aa&lt;div&gt;test1&lt;/div&gt;bb&lt;div&gt;test2&lt;/div&gt;cc&apos;pattern = re.compile(r&apos;&lt;div&gt;.*?&lt;/div&gt;&apos;) # åŠ ä¸Š ?result = pattern.findall(content)print result ç»“æžœï¼š 1[&apos;&lt;div&gt;test1&lt;/div&gt;&apos;, &apos;&lt;div&gt;test2&lt;/div&gt;&apos;] å°ç»“ re æ¨¡å—çš„ä¸€èˆ¬ä½¿ç”¨æ­¥éª¤å¦‚ä¸‹ï¼š ä½¿ç”¨ compile å‡½æ•°å°†æ­£åˆ™è¡¨è¾¾å¼çš„å­—ç¬¦ä¸²å½¢å¼ç¼–è¯‘ä¸ºä¸€ä¸ª Pattern å¯¹è±¡ï¼› é€šè¿‡ Pattern å¯¹è±¡æä¾›çš„ä¸€ç³»åˆ—æ–¹æ³•å¯¹æ–‡æœ¬è¿›è¡ŒåŒ¹é…æŸ¥æ‰¾ï¼ŒèŽ·å¾—åŒ¹é…ç»“æžœï¼ˆä¸€ä¸ª Match å¯¹è±¡ï¼‰ï¼› æœ€åŽä½¿ç”¨ Match å¯¹è±¡æä¾›çš„å±žæ€§å’Œæ–¹æ³•èŽ·å¾—ä¿¡æ¯ï¼Œæ ¹æ®éœ€è¦è¿›è¡Œå…¶ä»–çš„æ“ä½œï¼› Python çš„æ­£åˆ™åŒ¹é…é»˜è®¤æ˜¯è´ªå©ªåŒ¹é…ã€‚]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[vimå¸¸ç”¨å‘½ä»¤ä¸ŽæŠ€å·§(ä¸å®šæœŸæ›´æ–°).md]]></title>
    <url>%2F2019%2F04%2F21%2Fvim%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E4%B8%8E%E6%8A%80%E5%B7%A7-md%2F</url>
    <content type="text"><![CDATA[Vimå¸¸ç”¨çš„å‘½ä»¤ä¸ŽæŠ€å·§æ€»ç»“ï¼š åœ¨æ¯è¡Œè¡Œé¦–æ·»åŠ ç›¸åŒçš„å†…å®¹ï¼š 1:%s/^/è¦æ·»åŠ çš„å†…å®¹ åœ¨æ¯è¡Œè¡Œå°¾æ·»åŠ ç›¸åŒçš„å†…å®¹ï¼š 1:%s/$/è¦æ·»åŠ çš„å†…å®¹ åˆ©ç”¨æ­£åˆ™è¡¨è¾¾å¼åˆ é™¤ä»£ç æ®µæ¯è¡Œçš„è¡Œå· 123:%s/^\s*[0-9]*\s*//gcå…¶ä¸­ï¼Œ^è¡¨ç¤ºè¡Œé¦–ï¼Œ$è¡¨ç¤ºè¡Œå°¾ï¼Œ\sè¡¨ç¤ºç©ºæ ¼ï¼Œ[0-9]è¡¨ç¤º0~9çš„æ•°å­—ï¼Œ*è¡¨ç¤º0æˆ–å¤šä¸ªï¼Œ%s/^\s*[0-9]*\s*//gcçš„æ„æ€æ˜¯å°†æ¯è¡Œä»¥0æˆ–å¤šä¸ªç©ºæ ¼å¼€å§‹ä¸­é—´åŒ…å«0æˆ–å¤šä¸ªæ•°å­—å¹¶ä»¥0æˆ–å¤šä¸ªç©ºæ ¼ç»“æŸçš„å­—ç¬¦ä¸²æ›¿æ¢ä¸ºç©ºã€‚ æŒ‡å®šè¡Œé¦–æ·»åŠ â€#â€ 12:447,945 s/^/#447-945è¡Œçš„è¡Œé¦–æ·»åŠ  # åˆ é™¤æ¯è¡Œå‰é¢çš„å†…å®¹ 1:10,15 s/^/#//gc ç»Ÿè®¡måˆ°nè¡Œä¸­â€å­—ç¬¦ä¸²â€å‡ºçŽ°çš„æ¬¡æ•° 1:m,n s/å­—ç¬¦ä¸²//gn ç»Ÿè®¡â€å­—ç¬¦ä¸²â€åœ¨å½“å‰ç¼–è¾‘æ–‡ä»¶å‡ºçŽ°çš„æ¬¡æ•° 1: %s/å­—ç¬¦ä¸²/ng ç»Ÿè®¡è¯è¯­åœ¨æ–‡ä»¶ä¸­å‡ºçŽ°çš„è¡Œæ•°: 1cat file|grep -i å­—ç¬¦ä¸² |wc -l pycharmä¸­vimæ’ä»¶æ‰¹é‡ç¼©è¿›ï¼š 12345:m,n &gt;//å‘å³ç¼©è¿›4ç©ºæ ¼:m,n &lt; //å‘å·¦ç¼©è¿›4ç©ºæ ¼ è·³è½¬åˆ°è¡Œé¦–: ^ è·³è½¬åˆ°è¡Œå°¾:$ è·³è½¬åˆ°æ–‡ä»¶å¼€å¤´: gg è·³è½¬åˆ°è¡Œå°¾ï¼šG]]></content>
      <categories>
        <category>vim</category>
      </categories>
      <tags>
        <tag>vim</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[IRCå¸¸ç”¨å‘½ä»¤]]></title>
    <url>%2F2019%2F04%2F19%2FIRC%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%2F</url>
    <content type="text"><![CDATA[ä¸‹é¢æ˜¯å¸¸ç”¨å‘½ä»¤ /åœ¨ä¸å¼•èµ·æ··æ·†çš„æƒ…å†µä¸‹ï¼ŒIRCå‘½ä»¤å…è®¸ç®€å†™ã€‚ä¾‹å¦‚ï¼Œ/join å‘½ä»¤å¯ä»¥ç®€å†™ä¸º/jï¼Œ/joæˆ–è€…/joiã€‚ /nick æ›´æ”¹æ˜µç§°çš„åŸºæœ¬æ–¹æ³•æ˜¯ï¼š/n(ick) æ–°çš„æ˜µç§° æ‚¨çš„æ˜µç§°å¯ä»¥åŒ…å«è‹±æ–‡å­—æ¯ï¼Œæ•°å­—ï¼Œæ±‰å­—åŠä¸‹åˆ’çº¿ç­‰ã€‚ä½†æ˜¯ï¼Œæ˜µç§°ä¸èƒ½è¶…è¿‡50ä¸ªï¼ˆæ¯ä¸ªå­—ç¬¦å’Œæ±‰å­—éƒ½ç®—ä¸€ä¸ªå­—ï¼‰ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«$ï¼Œ+ï¼Œï¼å’Œç©ºæ ¼ã€‚ /nick å‘½ä»¤ç­‰ä»·äºŽå·¥å…·æŒ‰é’®ä¸­çš„â€œæ”¹å˜åˆ«åâ€ã€‚ /join /joinå‘½ä»¤çš„æ ¼å¼æ˜¯ï¼š/j(oin) èŠå¤©å®¤å å¦‚æžœèŠå¤©å®¤å·²ç»å­˜åœ¨ï¼Œæ‚¨å°±è¿›å…¥è¯¥èŠå¤©å®¤ã€‚æ­¤æ—¶ï¼Œ/join å‘½ä»¤ç­‰ä»·äºŽèŠå¤©å®¤åˆ—è¡¨å·¥å…·æŒ‰é’®ä¸­çš„â€œè¿›å…¥â€ã€‚ å¦‚æžœèŠå¤©å®¤ä¸å­˜åœ¨ï¼Œæ‚¨å°±å»ºç«‹äº†ä¸€ä¸ªæ–°çš„èŠå¤©å®¤å¹¶è¿›å…¥ã€‚æ­¤æ—¶ï¼Œ/join å‘½ä»¤ç­‰ä»·äºŽå·¥å…·æŒ‰é’®ä¸­çš„â€œå»ºèŠå¤©å®¤â€ã€‚ èŠå¤©å®¤çš„åå­—å¯ä»¥åŒ…å«è‹±æ–‡å­—æ¯ï¼Œæ•°å­—ï¼Œæ±‰å­—åŠä¸‹åˆ’çº¿ç­‰ã€‚ä½†æ˜¯ï¼Œä¸èƒ½è¶…è¿‡50ä¸ªå­—ï¼ˆæ¯ä¸ªå­—ç¬¦å’Œæ±‰å­—éƒ½ç®—ä¸€ä¸ªå­—ï¼‰ï¼Œè€Œä¸”ä¸èƒ½åŒ…å«$ï¼Œ+ï¼Œï¼å’Œç©ºæ ¼ã€‚ /mode +(-)i /mode +(-)i å‘½ä»¤å¯ä»¥ç”¨æ¥é”ä½ï¼ˆè§£é”ï¼‰ç”¨æˆ·è‡ªå»ºçš„èŠå¤©å®¤ï¼ˆç§äººèŠå¤©å®¤ï¼‰ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯:/m(ode) +i æˆ– /m(ode) -i åªæœ‰ç”¨æˆ·è‡ªå»ºçš„èŠå¤©å®¤æ‰èƒ½åŠ é”ã€‚ æœªç»ç®¡ç†å‘˜é‚€è¯·ï¼Œå…¶ä»–ç”¨æˆ·ä¸èƒ½è¿›å…¥ç§äººèŠå¤©å®¤ã€‚ /mode +(-)o /mode +(-)o å‘½ä»¤å¯ä»¥è®©èŠå¤©å®¤ç®¡ç†å‘˜èµ‹äºˆæˆ–è€…å‰¥å¤ºå…¶ä»–ç”¨æˆ·çš„ç®¡ç†å‘˜èº«ä»½ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯ï¼š/m(ode) +o ç”¨æˆ·æ˜µç§°æˆ–/m(ode)-oç”¨æˆ·æ˜µç§°åªæœ‰èŠå¤©å®¤ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚ /knock /knock å‘½ä»¤å¯ä»¥è®©æ‚¨è¯¢é—®ç§äººèŠå¤©å®¤ç®¡ç†å‘˜æ˜¯å¦å¯ä»¥è¿›å…¥è¯¥ç§äººèŠå¤©å®¤ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯ï¼š/k(nock) æˆ¿é—´å æ¶ˆæ¯] /invite /invite å‘½ä»¤å¯ä»¥è®©èŠå¤©å®¤ç®¡ç†å‘˜é‚€è¯·å…¶ä»–ç”¨æˆ·è¿›å…¥ç§äººèŠå¤©å®¤ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯:/i(nvite) ç”¨æˆ·æ˜µç§° åªæœ‰ç§äººèŠå¤©å®¤çš„ç®¡ç†å‘˜æ‰èƒ½ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ã€‚ /privmsg /privmsg å‘½ä»¤ç”¨æ¥å‘åœ¨åŒä¸€é—´èŠå¤©å®¤çš„æŸä¸ªç”¨æˆ·å‘é€ç§äººæ¶ˆæ¯ï¼ˆæ‚„æ‚„è¯ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨çš„æ¶ˆæ¯åªé€ç»™æŒ‡å®šçš„äººï¼Œè€Œä¸ä¼šæ˜¾ç¤ºç»™å…¶ä»–ç”¨æˆ·ã€‚ /privmsg å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š /p(rivmsg) ç”¨æˆ·æ˜µç§° æ¶ˆæ¯ æŽ¥å—æ‚¨çš„ç§äººæ¶ˆæ¯çš„ç”¨æˆ·å¿…é¡»å’Œæ‚¨åœ¨åŒä¸€é—´èŠå¤©å®¤ã€‚ â€œç”¨æˆ·æ˜µç§°â€å’Œâ€œæ¶ˆæ¯â€è¿™ä¸¤ä¸ªå‚æ•°æ˜¯ä¸èƒ½çœç•¥çš„ã€‚ å¦‚æžœæŸä¸ªç”¨æˆ·çš„æ˜µç§°å¤ªé•¿ï¼Œåœ¨ä¸ä¼šäº§ç”Ÿæ··æ·†çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åªè¾“å…¥ç”¨æˆ·æ˜µç§°çš„å¤´å‡ ä¸ªå­—æ¯ï¼Œç³»ç»Ÿä¼šè¿›è¡Œè‡ªåŠ¨åŒ¹é…ã€‚ ä¾‹å¦‚ï¼šèŠå¤©å®¤é‡Œé™¤äº†æ‚¨ä¹‹å¤–è¿˜æœ‰ä¸¤ä¸ªç”¨æˆ·ï¼Œä»–ä»¬çš„æ˜µç§°åˆ†åˆ«æ˜¯xiaobaoå’Œsoftmanã€‚æ‚¨è‹¥æƒ³ç»™softmanå‘é€æ‚„æ‚„è¯ï¼Œå¯ä»¥åœ¨è¾“å…¥æ¡†é‡Œè¾“å…¥ä¸‹é¢çš„å‘½ä»¤ï¼š /p s Have you etanged today? ç”±äºŽxiaobaoå’Œsoftmançš„ç¬¬ä¸€ä¸ªå­—æ¯å°±ä¸ä¸€æ ·ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šæŠŠæ‚¨è¾“å…¥çš„æ˜µç§°â€œsâ€è‡ªåŠ¨åŒ¹é…ä¸ºâ€œsoftmanâ€ã€‚å¦å¤–ï¼Œâ€œ/pâ€æ˜¯â€œ/privmsgâ€çš„ç¼©å†™ã€‚ /ignore /ignore å‘½ä»¤ç”¨æ¥æŠŠæŸä¸ªç”¨æˆ·åŠ å…¥æ‚¨çš„â€œåäººé»‘åå•â€ã€‚ä¸€æ—¦æŸä¸ªç”¨æˆ·è¿›å…¥äº†æ‚¨çš„é»‘åå•ï¼Œä»–è¯´çš„ä»»ä½•è¯éƒ½å°†ä¸ä¼šæ˜¾ç¤ºåœ¨æ‚¨çš„ç»ˆç«¯ä¸Šã€‚ /ignore å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/ig(nore) ç”¨æˆ·æ˜µç§° ç”¨æˆ·æ˜µç§°æ‰€ä»£è¡¨çš„ç”¨æˆ·å¿…é¡»å’Œæ‚¨åœ¨åŒä¸€ä¸ªèŠå¤©å®¤ã€‚ /ignore å‘½ä»¤ç­‰ä»·äºŽç”¨æˆ·åˆ—è¡¨å·¥å…·æŒ‰é’®ä¸­çš„â€œå¿½ç•¥â€ã€‚ å¦‚æžœæŸä¸ªç”¨æˆ·çš„æ˜µç§°å¤ªé•¿ï¼Œåœ¨ä¸ä¼šäº§ç”Ÿæ··æ·†çš„æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥åªè¾“å…¥ç”¨æˆ·æ˜µç§°çš„å¤´å‡ ä¸ªå­—æ¯ï¼Œç³»ç»Ÿä¼šè¿›è¡Œè‡ªåŠ¨åŒ¹é…ã€‚ åœ¨æ‚¨çš„ç”¨æˆ·åˆ—è¡¨ä¸­ï¼Œå¦‚æžœæŸä¸ªç”¨æˆ·æ˜µç§°å‰æœ‰ä¸€ä¸ª#ï¼Œè¡¨ç¤ºè¯¥ç”¨æˆ·å·²ç»è¢«æ‚¨åˆ—å…¥é»‘åå•ã€‚ å¦‚æžœä¸€ä¸ªç”¨æˆ·å·²ç»åœ¨æ‚¨çš„é»‘åå•ä¸­ï¼Œæ‚¨å¯ä»¥ç”¨ /ignore ç”¨æˆ·æ˜µç§° æŠŠä»–ä»Žé»‘åå•ä¸­åŽ»æŽ‰ã€‚ /away /away å‘½ä»¤ç”¨æ¥æŠŠè‡ªå·±è®¾ä¸ºâ€œæš‚æ—¶ç¦»å¼€â€çŠ¶æ€ï¼Œå¹¶å¯ä»¥ç•™è¨€ç»™å…¶ä»–ç”¨æˆ·ã€‚å½“å…¶ä»–ç”¨æˆ·å’Œæ‚¨è¯´æ‚„æ‚„è¯æ—¶ï¼Œæ‚¨é¢„å…ˆè®¾ç½®çš„ç•™è¨€ä¼šè‡ªåŠ¨å›žå¤ç»™å…¶ä»–ç”¨æˆ·ã€‚ /away å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/a(way) [ç•™è¨€] â€œç•™è¨€â€è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚å¦‚æžœæœ‰è¿™ä¸ªå‚æ•°ï¼Œæ‚¨çš„çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºâ€œæš‚æ—¶ç¦»å¼€â€ã€‚å¦åˆ™ï¼Œæ‚¨çš„çŠ¶æ€ä¼šè¢«è®¾ç½®ä¸ºâ€œæˆ‘å›žæ¥äº†â€ã€‚ å½“æ‚¨æš‚æ—¶ç¦»å¼€èŠå¤©å®¤æ—¶ï¼Œç”¨æˆ·åˆ—è¡¨ä¸­æ‚¨çš„æ˜µç§°å‰ä¼šå‡ºçŽ°ä¸€ä¸ª?ï¼Œè¡¨ç¤ºæ‚¨å¤„äºŽâ€œç¦»å¼€â€çŠ¶æ€ã€‚å·¥å…·æŒ‰é’®ä¸­çš„â€œæš‚æ—¶ç¦»å¼€â€ä¹Ÿä¼šå˜ä¸ºâ€œæˆ‘å›žæ¥äº†â€ã€‚ å½“æ‚¨å›žæ¥ç»§ç»­èŠå¤©æ—¶ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»å·¥å…·æŒ‰é’®ä¸­çš„â€œæˆ‘å›žæ¥äº†â€ï¼Œæˆ–è€…åœ¨è¾“å…¥æ¡†é‡Œè¾“å…¥ /away å‘½ä»¤ï¼Œå°†è‡ªå·±è®¾ç½®ä¸ºæ­£å¸¸çŠ¶æ€ã€‚ /away å‘½ä»¤ç­‰ä»·äºŽå·¥å…·æŒ‰é’®ä¸­çš„â€œæš‚æ—¶ç¦»å¼€â€ /whois /whois å‘½ä»¤ç”¨æ¥æŸ¥è¯¢æŸä¸ªç”¨æˆ·çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”¨æˆ·çš„äº¿å”IDï¼ŒIPåœ°å€ï¼Œç›®å‰æ‰€åœ¨çš„èŠå¤©å®¤å’Œå‘å‘†æ—¶é—´ã€‚ /whois å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/w(hois) ç”¨æˆ·æ˜µç§° /whoiså‘½ä»¤ç­‰ä»·äºŽç”¨æˆ·åˆ—è¡¨å·¥å…·æŒ‰é’®ä¸­çš„â€œæŸ¥è¯¢â€ã€‚ /names /names å‘½ä»¤ç”¨æ¥æŸ¥çœ‹å½“å‰æ‰€æœ‰ï¼ˆæˆ–æŸä¸ªèŠå¤©å®¤å†…ï¼‰çš„åœ¨çº¿èŠå¤©ç”¨æˆ·ã€‚å…¶å‘½ä»¤æ ¼å¼æ˜¯ï¼š/na(mes) [èŠå¤©å®¤] /topic /topic å‘½ä»¤ç”¨æ¥è®¾å®šå½“å‰èŠå¤©å®¤çš„ä¸»é¢˜ã€‚ /topic å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/t(opic) èŠå¤©å®¤ä¸»é¢˜ åªæœ‰å½“å‰èŠå¤©å®¤çš„ç®¡ç†å‘˜ï¼ˆopï¼‰æ‰æœ‰æƒåˆ©è®¾å®šèŠå¤©å®¤ä¸»é¢˜ã€‚ èŠå¤©å®¤çš„åˆ›å»ºè€…å°±æ˜¯è¯¥èŠå¤©å®¤çš„ç®¡ç†å‘˜ã€‚ ç®¡ç†å‘˜æƒé™å¯ä»¥é€šè¿‡ /mode +o å‘½ä»¤è½¬äº¤ã€‚ /kick /kick å‘½ä»¤ç”¨æ¥æŠŠæŸä¸ªç”¨æˆ·è¸¢å‡ºå½“å‰èŠå¤©å®¤ã€‚ /kick å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/ki(ck) ç”¨æˆ·æ˜µç§° [æ¶ˆæ¯] åªæœ‰å½“å‰èŠå¤©å®¤çš„ç®¡ç†å‘˜ï¼ˆopï¼‰æ‰æœ‰æƒåˆ©æŠŠå…¶ä»–ç”¨æˆ·è¸¢å‡ºå½“å‰èŠå¤©å®¤ã€‚ èŠå¤©å®¤çš„åˆ›å»ºè€…å°±æ˜¯è¯¥èŠå¤©å®¤çš„ç®¡ç†å‘˜ã€‚ ç®¡ç†å‘˜æƒé™å¯ä»¥é€šè¿‡/mode +oå‘½ä»¤è½¬äº¤ã€‚ è¯·è¯¸ä½ç½‘å‹æ…Žç”¨è¿™ä¸ªå‘½ä»¤ã€‚â€œå›å­åŠ¨å£ä¸åŠ¨æ‰‹â€å˜›ï¼ /quit /quit å‘½ä»¤ç”¨æ¥é€€å‡ºèŠå¤©å®¤ã€‚ /quit å‘½ä»¤çš„åŸºæœ¬æ ¼å¼æ˜¯ï¼š/q(uit) [æ¶ˆæ¯] â€œæ¶ˆæ¯â€è¿™ä¸ªå‚æ•°æ˜¯å¯é€‰çš„ã€‚å¦‚æžœæ‚¨æŒ‡å®šé€€å‡ºæ—¶çš„æ¶ˆæ¯ï¼Œè¯¥æ¶ˆæ¯ä¼šå‘é€ç»™å½“å‰èŠå¤©å®¤ä¸­çš„å…¶ä»–ç”¨æˆ·ã€‚æ‚¨å¯ä»¥ä½¿ç”¨è¿™ä¸ªæ¶ˆæ¯å‘å…¶ä»–ç”¨æˆ·é“åˆ«ã€‚ /quit å‘½ä»¤ç­‰ä»·äºŽå·¥å…·æŒ‰é’®ä¸­çš„â€œç»“æŸèŠå¤©â€ è¯¦æƒ…å¯å‚è€ƒï¼šhttps://www.cnblogs.com/z-books/p/5197840.html]]></content>
      <categories>
        <category>IRC</category>
      </categories>
      <tags>
        <tag>IRC</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangé¢è¯•é—®é¢˜æ±‡æ€»]]></title>
    <url>%2F2019%2F04%2F12%2Fgolang%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡è½¬è½½è‡ªï¼šhttps://github.com/KeKe-Li/golang-interview-questions Golangé¢è¯•é—®é¢˜æ±‡æ€»é€šå¸¸æˆ‘ä»¬åŽ»é¢è¯•è‚¯å®šä¼šæœ‰äº›ä¸é”™çš„Golangçš„é¢è¯•é¢˜ç›®çš„ï¼Œæ‰€ä»¥æ€»ç»“ä¸‹ï¼Œè®©å…¶ä»–Golangå¼€å‘è€…ä¹Ÿå¯ä»¥æŸ¥çœ‹åˆ°ï¼ŒåŒæ—¶ä¹Ÿç”¨æ¥æ£€æµ‹è‡ªå·±çš„èƒ½åŠ›å’Œæé†’è‡ªå·±çš„ä¸è¶³ä¹‹å¤„,æ¬¢è¿Žå¤§å®¶è¡¥å……å’Œæäº¤æ–°çš„é¢è¯•é¢˜ç›®. Golangé¢è¯•é—®é¢˜æ±‡æ€»: 1. Golangä¸­é™¤äº†åŠ Mutexé”ä»¥å¤–è¿˜æœ‰å“ªäº›æ–¹å¼å®‰å…¨è¯»å†™å…±äº«å˜é‡ï¼ŸGolangä¸­Goroutine å¯ä»¥é€šè¿‡ Channel è¿›è¡Œå®‰å…¨è¯»å†™å…±äº«å˜é‡ã€‚ 2. æ— ç¼“å†² Chan çš„å‘é€å’ŒæŽ¥æ”¶æ˜¯å¦åŒæ­¥?12ch := make(chan int) æ— ç¼“å†²çš„channelç”±äºŽæ²¡æœ‰ç¼“å†²å‘é€å’ŒæŽ¥æ”¶éœ€è¦åŒæ­¥.ch := make(chan int, 2) æœ‰ç¼“å†²channelä¸è¦æ±‚å‘é€å’ŒæŽ¥æ”¶æ“ä½œåŒæ­¥. channelæ— ç¼“å†²æ—¶ï¼Œå‘é€é˜»å¡žç›´åˆ°æ•°æ®è¢«æŽ¥æ”¶ï¼ŒæŽ¥æ”¶é˜»å¡žç›´åˆ°è¯»åˆ°æ•°æ®ã€‚ channelæœ‰ç¼“å†²æ—¶ï¼Œå½“ç¼“å†²æ»¡æ—¶å‘é€é˜»å¡žï¼Œå½“ç¼“å†²ç©ºæ—¶æŽ¥æ”¶é˜»å¡žã€‚ 3. goè¯­è¨€çš„å¹¶å‘æœºåˆ¶ä»¥åŠå®ƒæ‰€ä½¿ç”¨çš„CSPå¹¶å‘æ¨¡åž‹ï¼ŽCSPæ¨¡åž‹æ˜¯ä¸Šä¸ªä¸–çºªä¸ƒåå¹´ä»£æå‡ºçš„,ä¸åŒäºŽä¼ ç»Ÿçš„å¤šçº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼ŒCSPè®²ç©¶çš„æ˜¯â€œä»¥é€šä¿¡çš„æ–¹å¼æ¥å…±äº«å†…å­˜â€ã€‚ç”¨äºŽæè¿°ä¸¤ä¸ªç‹¬ç«‹çš„å¹¶å‘å®žä½“é€šè¿‡å…±äº«çš„é€šè®¯ channel(ç®¡é“)è¿›è¡Œé€šä¿¡çš„å¹¶å‘æ¨¡åž‹ã€‚ CSPä¸­channelæ˜¯ç¬¬ä¸€ç±»å¯¹è±¡ï¼Œå®ƒä¸å…³æ³¨å‘é€æ¶ˆæ¯çš„å®žä½“ï¼Œè€Œå…³æ³¨ä¸Žå‘é€æ¶ˆæ¯æ—¶ä½¿ç”¨çš„channelã€‚ Golangä¸­channel æ˜¯è¢«å•ç‹¬åˆ›å»ºå¹¶ä¸”å¯ä»¥åœ¨è¿›ç¨‹ä¹‹é—´ä¼ é€’ï¼Œå®ƒçš„é€šä¿¡æ¨¡å¼ç±»ä¼¼äºŽ boss-worker æ¨¡å¼çš„ï¼Œä¸€ä¸ªå®žä½“é€šè¿‡å°†æ¶ˆæ¯å‘é€åˆ°channel ä¸­ï¼Œç„¶åŽåˆç›‘å¬è¿™ä¸ª channel çš„å®žä½“å¤„ç†ï¼Œä¸¤ä¸ªå®žä½“ä¹‹é—´æ˜¯åŒ¿åçš„ï¼Œè¿™ä¸ªå°±å®žçŽ°å®žä½“ä¸­é—´çš„è§£è€¦ï¼Œå…¶ä¸­ channel æ˜¯åŒæ­¥çš„ä¸€ä¸ªæ¶ˆæ¯è¢«å‘é€åˆ° channel ä¸­ï¼Œæœ€ç»ˆæ˜¯ä¸€å®šè¦è¢«å¦å¤–çš„å®žä½“æ¶ˆè´¹æŽ‰çš„ï¼Œåœ¨å®žçŽ°åŽŸç†ä¸Šå…¶å®žç±»ä¼¼ä¸€ä¸ªé˜»å¡žçš„æ¶ˆæ¯é˜Ÿåˆ—ã€‚ Goroutine æ˜¯Golangå®žé™…å¹¶å‘æ‰§è¡Œçš„å®žä½“ï¼Œå®ƒåº•å±‚æ˜¯ä½¿ç”¨åç¨‹(coroutine)å®žçŽ°å¹¶å‘ï¼Œcoroutineæ˜¯ä¸€ç§è¿è¡Œåœ¨ç”¨æˆ·æ€çš„ç”¨æˆ·çº¿ç¨‹ï¼Œç±»ä¼¼äºŽ greenthreadï¼Œgoåº•å±‚é€‰æ‹©ä½¿ç”¨coroutineçš„å‡ºå‘ç‚¹æ˜¯å› ä¸ºï¼Œå®ƒå…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š ç”¨æˆ·ç©ºé—´ é¿å…äº†å†…æ ¸æ€å’Œç”¨æˆ·æ€çš„åˆ‡æ¢å¯¼è‡´çš„æˆæœ¬ã€‚ å¯ä»¥ç”±è¯­è¨€å’Œæ¡†æž¶å±‚è¿›è¡Œè°ƒåº¦ã€‚ æ›´å°çš„æ ˆç©ºé—´å…è®¸åˆ›å»ºå¤§é‡çš„å®žä¾‹ã€‚ Golangä¸­çš„Goroutineçš„ç‰¹æ€§: Golangå†…éƒ¨æœ‰ä¸‰ä¸ªå¯¹è±¡ï¼š På¯¹è±¡(processor) ä»£è¡¨ä¸Šä¸‹æ–‡ï¼ˆæˆ–è€…å¯ä»¥è®¤ä¸ºæ˜¯cpuï¼‰ï¼ŒM(work thread)ä»£è¡¨å·¥ä½œçº¿ç¨‹ï¼ŒGå¯¹è±¡ï¼ˆgoroutineï¼‰. æ­£å¸¸æƒ…å†µä¸‹ä¸€ä¸ªcpuå¯¹è±¡å¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å¯¹è±¡ï¼Œçº¿ç¨‹åŽ»æ£€æŸ¥å¹¶æ‰§è¡Œgoroutineå¯¹è±¡ã€‚ç¢°åˆ°goroutineå¯¹è±¡é˜»å¡žçš„æ—¶å€™ï¼Œä¼šå¯åŠ¨ä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œä»¥å……åˆ†åˆ©ç”¨cpuèµ„æºã€‚ æ‰€æœ‰æœ‰æ—¶å€™çº¿ç¨‹å¯¹è±¡ä¼šæ¯”å¤„ç†å™¨å¯¹è±¡å¤šå¾ˆå¤š. æˆ‘ä»¬ç”¨å¦‚ä¸‹å›¾åˆ†åˆ«è¡¨ç¤ºPã€Mã€G: Gï¼ˆGoroutineï¼‰ ï¼šæˆ‘ä»¬æ‰€è¯´çš„åç¨‹ï¼Œä¸ºç”¨æˆ·çº§çš„è½»é‡çº§çº¿ç¨‹ï¼Œæ¯ä¸ªGoroutineå¯¹è±¡ä¸­çš„schedä¿å­˜ç€å…¶ä¸Šä¸‹æ–‡ä¿¡æ¯. Mï¼ˆMachineï¼‰ ï¼šå¯¹å†…æ ¸çº§çº¿ç¨‹çš„å°è£…ï¼Œæ•°é‡å¯¹åº”çœŸå®žçš„CPUæ•°ï¼ˆçœŸæ­£å¹²æ´»çš„å¯¹è±¡ï¼‰. Pï¼ˆProcessorï¼‰ ï¼šå³ä¸ºGå’ŒMçš„è°ƒåº¦å¯¹è±¡ï¼Œç”¨æ¥è°ƒåº¦Gå’ŒMä¹‹é—´çš„å…³è”å…³ç³»ï¼Œå…¶æ•°é‡å¯é€šè¿‡GOMAXPROCS()æ¥è®¾ç½®ï¼Œé»˜è®¤ä¸ºæ ¸å¿ƒæ•°. åœ¨å•æ ¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰Goroutineè¿è¡Œåœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼ˆM0ï¼‰ä¸­ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹ç»´æŠ¤ä¸€ä¸ªä¸Šä¸‹æ–‡ï¼ˆPï¼‰ï¼Œä»»ä½•æ—¶åˆ»ï¼Œä¸€ä¸ªä¸Šä¸‹æ–‡ä¸­åªæœ‰ä¸€ä¸ªGoroutineï¼Œå…¶ä»–Goroutineåœ¨runqueueä¸­ç­‰å¾…ã€‚ ä¸€ä¸ªGoroutineè¿è¡Œå®Œè‡ªå·±çš„æ—¶é—´ç‰‡åŽï¼Œè®©å‡ºä¸Šä¸‹æ–‡ï¼Œè‡ªå·±å›žåˆ°runqueueä¸­ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚ å½“æ­£åœ¨è¿è¡Œçš„G0é˜»å¡žçš„æ—¶å€™ï¼ˆå¯ä»¥éœ€è¦IOï¼‰ï¼Œä¼šå†åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼ˆM1ï¼‰ï¼ŒPè½¬åˆ°æ–°çš„çº¿ç¨‹ä¸­åŽ»è¿è¡Œã€‚ å½“M0è¿”å›žæ—¶ï¼Œå®ƒä¼šå°è¯•ä»Žå…¶ä»–çº¿ç¨‹ä¸­â€œå·â€ä¸€ä¸ªä¸Šä¸‹æ–‡è¿‡æ¥ï¼Œå¦‚æžœæ²¡æœ‰å·åˆ°ï¼Œä¼šæŠŠGoroutineæ”¾åˆ°Global runqueueä¸­åŽ»ï¼Œç„¶åŽæŠŠè‡ªå·±æ”¾å…¥çº¿ç¨‹ç¼“å­˜ä¸­ã€‚ ä¸Šä¸‹æ–‡ä¼šå®šæ—¶æ£€æŸ¥Global runqueueã€‚ Golangæ˜¯ä¸ºå¹¶å‘è€Œç”Ÿçš„è¯­è¨€ï¼ŒGoè¯­è¨€æ˜¯ä¸ºæ•°ä¸å¤šçš„åœ¨è¯­è¨€å±‚é¢å®žçŽ°å¹¶å‘çš„è¯­è¨€ï¼›ä¹Ÿæ­£æ˜¯Goè¯­è¨€çš„å¹¶å‘ç‰¹æ€§ï¼Œå¸å¼•äº†å…¨çƒæ— æ•°çš„å¼€å‘è€…ã€‚ Golangçš„CSPå¹¶å‘æ¨¡åž‹ï¼Œæ˜¯é€šè¿‡Goroutineå’ŒChannelæ¥å®žçŽ°çš„ã€‚ Goroutine æ˜¯Goè¯­è¨€ä¸­å¹¶å‘çš„æ‰§è¡Œå•ä½ã€‚æœ‰ç‚¹æŠ½è±¡ï¼Œå…¶å®žå°±æ˜¯å’Œä¼ ç»Ÿæ¦‚å¿µä¸Šçš„â€çº¿ç¨‹â€œç±»ä¼¼ï¼Œå¯ä»¥ç†è§£ä¸ºâ€çº¿ç¨‹â€œã€‚ Channelæ˜¯Goè¯­è¨€ä¸­å„ä¸ªå¹¶å‘ç»“æž„ä½“(Goroutine)ä¹‹å‰çš„é€šä¿¡æœºåˆ¶ã€‚é€šå¸¸Channelï¼Œæ˜¯å„ä¸ªGoroutineä¹‹é—´é€šä¿¡çš„â€ç®¡é“â€œï¼Œæœ‰ç‚¹ç±»ä¼¼äºŽLinuxä¸­çš„ç®¡é“ã€‚ é€šä¿¡æœºåˆ¶channelä¹Ÿå¾ˆæ–¹ä¾¿ï¼Œä¼ æ•°æ®ç”¨channel &lt;- dataï¼Œå–æ•°æ®ç”¨&lt;-channelã€‚ åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œä¼ æ•°æ®channel &lt;- dataå’Œå–æ•°æ®&lt;-channelå¿…ç„¶ä¼šæˆå¯¹å‡ºçŽ°ï¼Œå› ä¸ºè¿™è¾¹ä¼ ï¼Œé‚£è¾¹å–ï¼Œä¸¤ä¸ªgoroutineä¹‹é—´æ‰ä¼šå®žçŽ°é€šä¿¡ã€‚ è€Œä¸”ä¸ç®¡ä¼ è¿˜æ˜¯å–ï¼Œå¿…é˜»å¡žï¼Œç›´åˆ°å¦å¤–çš„goroutineä¼ æˆ–è€…å–ä¸ºæ­¢ã€‚ 4. Golang ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡åž‹ï¼ŸGolang ä¸­å¸¸ç”¨çš„å¹¶å‘æ¨¡åž‹æœ‰ä¸‰ç§: é€šè¿‡channelé€šçŸ¥å®žçŽ°å¹¶å‘æŽ§åˆ¶ æ— ç¼“å†²çš„é€šé“æŒ‡çš„æ˜¯é€šé“çš„å¤§å°ä¸º0ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ç§ç±»åž‹çš„é€šé“åœ¨æŽ¥æ”¶å‰æ²¡æœ‰èƒ½åŠ›ä¿å­˜ä»»ä½•å€¼ï¼Œå®ƒè¦æ±‚å‘é€ goroutine å’ŒæŽ¥æ”¶ goroutine åŒæ—¶å‡†å¤‡å¥½ï¼Œæ‰å¯ä»¥å®Œæˆå‘é€å’ŒæŽ¥æ”¶æ“ä½œã€‚ ä»Žä¸Šé¢æ— ç¼“å†²çš„é€šé“å®šä¹‰æ¥çœ‹ï¼Œå‘é€ goroutine å’ŒæŽ¥æ”¶ gouroutine å¿…é¡»æ˜¯åŒæ­¥çš„ï¼ŒåŒæ—¶å‡†å¤‡åŽï¼Œå¦‚æžœæ²¡æœ‰åŒæ—¶å‡†å¤‡å¥½çš„è¯ï¼Œå…ˆæ‰§è¡Œçš„æ“ä½œå°±ä¼šé˜»å¡žç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªç›¸å¯¹åº”çš„æ“ä½œå‡†å¤‡å¥½ä¸ºæ­¢ã€‚è¿™ç§æ— ç¼“å†²çš„é€šé“æˆ‘ä»¬ä¹Ÿç§°ä¹‹ä¸ºåŒæ­¥é€šé“ã€‚ 123456789101112func main() &#123; ch := make(chan struct&#123;&#125;) go func() &#123; fmt.Println(&quot;start working&quot;) time.Sleep(time.Second * 1) ch &lt;- struct&#123;&#125;&#123;&#125; &#125;() &lt;-ch fmt.Println(&quot;finished&quot;)&#125; å½“ä¸» goroutine è¿è¡Œåˆ° &lt;-ch æŽ¥å— channel çš„å€¼çš„æ—¶å€™ï¼Œå¦‚æžœè¯¥ channel ä¸­æ²¡æœ‰æ•°æ®ï¼Œå°±ä¼šä¸€ç›´é˜»å¡žç­‰å¾…ï¼Œç›´åˆ°æœ‰å€¼ã€‚ è¿™æ ·å°±å¯ä»¥ç®€å•å®žçŽ°å¹¶å‘æŽ§åˆ¶ é€šè¿‡syncåŒ…ä¸­çš„WaitGroupå®žçŽ°å¹¶å‘æŽ§åˆ¶ Goroutineæ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæœ‰çš„æ—¶å€™ä¸ºäº†é˜²æ­¢åœ¨ç»“æŸmianå‡½æ•°çš„æ—¶å€™ç»“æŸæŽ‰Goroutineï¼Œæ‰€ä»¥éœ€è¦åŒæ­¥ç­‰å¾…ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨ WaitGroupäº†ï¼Œåœ¨ sync åŒ…ä¸­ï¼Œæä¾›äº† WaitGroup ï¼Œå®ƒä¼šç­‰å¾…å®ƒæ”¶é›†çš„æ‰€æœ‰ goroutine ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚åœ¨WaitGroupé‡Œä¸»è¦æœ‰ä¸‰ä¸ªæ–¹æ³•: Add, å¯ä»¥æ·»åŠ æˆ–å‡å°‘ goroutineçš„æ•°é‡. Done, ç›¸å½“äºŽAdd(-1). Wait, æ‰§è¡ŒåŽä¼šå µå¡žä¸»çº¿ç¨‹ï¼Œç›´åˆ°WaitGroup é‡Œçš„å€¼å‡è‡³0. åœ¨ä¸» goroutine ä¸­ Add(delta int) ç´¢è¦ç­‰å¾…goroutine çš„æ•°é‡ã€‚ åœ¨æ¯ä¸€ä¸ª goroutine å®ŒæˆåŽ Done() è¡¨ç¤ºè¿™ä¸€ä¸ªgoroutine å·²ç»å®Œæˆï¼Œå½“æ‰€æœ‰çš„ goroutine éƒ½å®ŒæˆåŽï¼Œåœ¨ä¸» goroutine ä¸­ WaitGroup è¿”å›žè¿”å›žã€‚ 123456789101112131415func main()&#123; var wg sync.WaitGroup var urls = []string&#123; &quot;http://www.golang.org/&quot;, &quot;http://www.google.com/&quot;, &#125; for _, url := range urls &#123; wg.Add(1) go func(url string) &#123; defer wg.Done() http.Get(url) &#125;(url) &#125; wg.Wait()&#125; åœ¨Golangå®˜ç½‘ä¸­å¯¹äºŽWaitGroupä»‹ç»æ˜¯A WaitGroup must not be copied after first use,åœ¨ WaitGroup ç¬¬ä¸€æ¬¡ä½¿ç”¨åŽï¼Œä¸èƒ½è¢«æ‹·è´ åº”ç”¨ç¤ºä¾‹: 123456789101112func main()&#123; wg := sync.WaitGroup&#123;&#125; for i := 0; i &lt; 5; i++ &#123; wg.Add(1) go func(wg sync.WaitGroup, i int) &#123; fmt.Printf(&quot;i:%d&quot;, i) wg.Done() &#125;(wg, i) &#125; wg.Wait() fmt.Println(&quot;exit&quot;)&#125; è¿è¡Œ: 12345678910i:1i:3i:2i:0i:4fatal error: all goroutines are asleep - deadlock!goroutine 1 [semacquire]:sync.runtime_Semacquire(0xc000094018) /home/keke/soft/go/src/runtime/sema.go:56 +0x39sync.(*WaitGroup).Wait(0xc000094010) /home/keke/soft/go/src/sync/waitgroup.go:130 +0x64main.main() /home/keke/go/Test/wait.go:17 +0xabexit status 2 å®ƒæç¤ºæ‰€æœ‰çš„ goroutine éƒ½å·²ç»ç¡çœ äº†ï¼Œå‡ºçŽ°äº†æ­»é”ã€‚è¿™æ˜¯å› ä¸º wg ç»™æ‹·è´ä¼ é€’åˆ°äº† goroutine ä¸­ï¼Œå¯¼è‡´åªæœ‰ Add æ“ä½œï¼Œå…¶å®ž Doneæ“ä½œæ˜¯åœ¨ wg çš„å‰¯æœ¬æ‰§è¡Œçš„ã€‚ å› æ­¤ Wait å°±æ­»é”äº†ã€‚ è¿™ä¸ªç¬¬ä¸€ä¸ªä¿®æ”¹æ–¹å¼:å°†åŒ¿åå‡½æ•°ä¸­ wg çš„ä¼ å…¥ç±»åž‹æ”¹ä¸º *sync.WaitGrou,è¿™æ ·å°±èƒ½å¼•ç”¨åˆ°æ­£ç¡®çš„WaitGroupäº†ã€‚ è¿™ä¸ªç¬¬äºŒä¸ªä¿®æ”¹æ–¹å¼:å°†åŒ¿åå‡½æ•°ä¸­çš„ wg çš„ä¼ å…¥å‚æ•°åŽ»æŽ‰ï¼Œå› ä¸ºGoæ”¯æŒé—­åŒ…ç±»åž‹ï¼Œåœ¨åŒ¿åå‡½æ•°ä¸­å¯ä»¥ç›´æŽ¥ä½¿ç”¨å¤–é¢çš„ wg å˜é‡ åœ¨Go 1.7 ä»¥åŽå¼•è¿›çš„å¼ºå¤§çš„Contextä¸Šä¸‹æ–‡ï¼Œå®žçŽ°å¹¶å‘æŽ§åˆ¶ é€šå¸¸,åœ¨ä¸€äº›ç®€å•åœºæ™¯ä¸‹ä½¿ç”¨ channel å’Œ WaitGroup å·²ç»è¶³å¤Ÿäº†ï¼Œä½†æ˜¯å½“é¢ä¸´ä¸€äº›å¤æ‚å¤šå˜çš„ç½‘ç»œå¹¶å‘åœºæ™¯ä¸‹ channel å’Œ WaitGroup æ˜¾å¾—æœ‰äº›åŠ›ä¸ä»Žå¿ƒäº†ã€‚ æ¯”å¦‚ä¸€ä¸ªç½‘ç»œè¯·æ±‚ Requestï¼Œæ¯ä¸ª Request éƒ½éœ€è¦å¼€å¯ä¸€ä¸ª goroutine åšä¸€äº›äº‹æƒ…ï¼Œè¿™äº› goroutine åˆå¯èƒ½ä¼šå¼€å¯å…¶ä»–çš„ goroutineï¼Œæ¯”å¦‚æ•°æ®åº“å’ŒRPCæœåŠ¡ã€‚ æ‰€ä»¥æˆ‘ä»¬éœ€è¦ä¸€ç§å¯ä»¥è·Ÿè¸ª goroutine çš„æ–¹æ¡ˆï¼Œæ‰å¯ä»¥è¾¾åˆ°æŽ§åˆ¶ä»–ä»¬çš„ç›®çš„ï¼Œè¿™å°±æ˜¯Goè¯­è¨€ä¸ºæˆ‘ä»¬æä¾›çš„ Contextï¼Œç§°ä¹‹ä¸ºä¸Šä¸‹æ–‡éžå¸¸è´´åˆ‡ï¼Œå®ƒå°±æ˜¯goroutine çš„ä¸Šä¸‹æ–‡ã€‚ å®ƒæ˜¯åŒ…æ‹¬ä¸€ä¸ªç¨‹åºçš„è¿è¡ŒçŽ¯å¢ƒã€çŽ°åœºå’Œå¿«ç…§ç­‰ã€‚æ¯ä¸ªç¨‹åºè¦è¿è¡Œæ—¶ï¼Œéƒ½éœ€è¦çŸ¥é“å½“å‰ç¨‹åºçš„è¿è¡ŒçŠ¶æ€ï¼Œé€šå¸¸Go å°†è¿™äº›å°è£…åœ¨ä¸€ä¸ª Context é‡Œï¼Œå†å°†å®ƒä¼ ç»™è¦æ‰§è¡Œçš„ goroutine ã€‚ context åŒ…ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†å¤šä¸ª goroutine ä¹‹é—´å…±äº«æ•°æ®ï¼ŒåŠå¤šä¸ª goroutine çš„ç®¡ç†ã€‚ context åŒ…çš„æ ¸å¿ƒæ˜¯ struct Contextï¼ŒæŽ¥å£å£°æ˜Žå¦‚ä¸‹ï¼š 123456789101112131415161718// A Context carries a deadline, cancelation signal, and request-scoped values// across API boundaries. Its methods are safe for simultaneous use by multiple// goroutines.type Context interface &#123; // Done returns a channel that is closed when this `Context` is canceled // or times out. Done() &lt;-chan struct&#123;&#125; // Err indicates why this Context was canceled, after the Done channel // is closed. Err() error // Deadline returns the time when this Context will be canceled, if any. Deadline() (deadline time.Time, ok bool) // Value returns the value associated with key or nil if none. Value(key interface&#123;&#125;) interface&#123;&#125;&#125; Done() è¿”å›žä¸€ä¸ªåªèƒ½æŽ¥å—æ•°æ®çš„channelç±»åž‹ï¼Œå½“è¯¥contextå…³é—­æˆ–è€…è¶…æ—¶æ—¶é—´åˆ°äº†çš„æ—¶å€™ï¼Œè¯¥channelå°±ä¼šæœ‰ä¸€ä¸ªå–æ¶ˆä¿¡å· Err() åœ¨Done() ä¹‹åŽï¼Œè¿”å›žcontext å–æ¶ˆçš„åŽŸå› ã€‚ Deadline() è®¾ç½®è¯¥context cancelçš„æ—¶é—´ç‚¹ Value() æ–¹æ³•å…è®¸ Context å¯¹è±¡æºå¸¦requestä½œç”¨åŸŸçš„æ•°æ®ï¼Œè¯¥æ•°æ®å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ Context å¯¹è±¡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½ å¯ä»¥æŠŠä¸€ä¸ª Context å¯¹è±¡ä¼ é€’ç»™ä»»æ„ä¸ªæ•°çš„ gorotuineï¼Œå¯¹å®ƒæ‰§è¡Œ å–æ¶ˆ æ“ä½œæ—¶ï¼Œæ‰€æœ‰ goroutine éƒ½ä¼šæŽ¥æ”¶åˆ°å–æ¶ˆä¿¡å·ã€‚ ä¸€ä¸ª Context ä¸èƒ½æ‹¥æœ‰ Cancel æ–¹æ³•ï¼ŒåŒæ—¶æˆ‘ä»¬ä¹Ÿåªèƒ½ Done channel æŽ¥æ”¶æ•°æ®ã€‚ å…¶ä¸­çš„åŽŸå› æ˜¯ä¸€è‡´çš„ï¼šæŽ¥æ”¶å–æ¶ˆä¿¡å·çš„å‡½æ•°å’Œå‘é€ä¿¡å·çš„å‡½æ•°é€šå¸¸ä¸æ˜¯ä¸€ä¸ªã€‚ å…¸åž‹çš„åœºæ™¯æ˜¯ï¼šçˆ¶æ“ä½œä¸ºå­æ“ä½œæ“ä½œå¯åŠ¨ goroutineï¼Œå­æ“ä½œä¹Ÿå°±ä¸èƒ½å–æ¶ˆçˆ¶æ“ä½œã€‚ 5. JSON æ ‡å‡†åº“å¯¹ nil slice å’Œ ç©º slice çš„å¤„ç†æ˜¯ä¸€è‡´çš„å—ï¼Ÿ é¦–å…ˆJSON æ ‡å‡†åº“å¯¹ nil slice å’Œ ç©º slice çš„å¤„ç†æ˜¯ä¸ä¸€è‡´. é€šå¸¸é”™è¯¯çš„ç”¨æ³•ï¼Œä¼šæŠ¥æ•°ç»„è¶Šç•Œçš„é”™è¯¯ï¼Œå› ä¸ºåªæ˜¯å£°æ˜Žäº†sliceï¼Œå´æ²¡æœ‰ç»™å®žä¾‹åŒ–çš„å¯¹è±¡ã€‚ 12var slice []intslice[1] = 0 æ­¤æ—¶sliceçš„å€¼æ˜¯nilï¼Œè¿™ç§æƒ…å†µå¯ä»¥ç”¨äºŽéœ€è¦è¿”å›žsliceçš„å‡½æ•°ï¼Œå½“å‡½æ•°å‡ºçŽ°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¿è¯å‡½æ•°ä¾ç„¶ä¼šæœ‰nilçš„è¿”å›žå€¼ã€‚ empty slice æ˜¯æŒ‡sliceä¸ä¸ºnilï¼Œä½†æ˜¯sliceæ²¡æœ‰å€¼ï¼Œsliceçš„åº•å±‚çš„ç©ºé—´æ˜¯ç©ºçš„ï¼Œæ­¤æ—¶çš„å®šä¹‰å¦‚ä¸‹ï¼š 12slice := make([]int,0ï¼‰slice := []int&#123;&#125; å½“æˆ‘ä»¬æŸ¥è¯¢æˆ–è€…å¤„ç†ä¸€ä¸ªç©ºçš„åˆ—è¡¨çš„æ—¶å€™ï¼Œè¿™éžå¸¸æœ‰ç”¨ï¼Œå®ƒä¼šå‘Šè¯‰æˆ‘ä»¬è¿”å›žçš„æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œä½†æ˜¯åˆ—è¡¨å†…æ²¡æœ‰ä»»ä½•å€¼ã€‚ æ€»ä¹‹ï¼Œnil slice å’Œ empty sliceæ˜¯ä¸åŒçš„ä¸œè¥¿,éœ€è¦æˆ‘ä»¬åŠ ä»¥åŒºåˆ†çš„. 6. åç¨‹ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹çš„åŒºåˆ«ã€‚ è¿›ç¨‹ è¿›ç¨‹æ˜¯å…·æœ‰ä¸€å®šç‹¬ç«‹åŠŸèƒ½çš„ç¨‹åºå…³äºŽæŸä¸ªæ•°æ®é›†åˆä¸Šçš„ä¸€æ¬¡è¿è¡Œæ´»åŠ¨,è¿›ç¨‹æ˜¯ç³»ç»Ÿè¿›è¡Œèµ„æºåˆ†é…å’Œè°ƒåº¦çš„ä¸€ä¸ªç‹¬ç«‹å•ä½ã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±çš„ç‹¬ç«‹å†…å­˜ç©ºé—´ï¼Œä¸åŒè¿›ç¨‹é€šè¿‡è¿›ç¨‹é—´é€šä¿¡æ¥é€šä¿¡ã€‚ç”±äºŽè¿›ç¨‹æ¯”è¾ƒé‡é‡ï¼Œå æ®ç‹¬ç«‹çš„å†…å­˜ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡è¿›ç¨‹é—´çš„åˆ‡æ¢å¼€é”€ï¼ˆæ ˆã€å¯„å­˜å™¨ã€è™šæ‹Ÿå†…å­˜ã€æ–‡ä»¶å¥æŸ„ç­‰ï¼‰æ¯”è¾ƒå¤§ï¼Œä½†ç›¸å¯¹æ¯”è¾ƒç¨³å®šå®‰å…¨ã€‚ çº¿ç¨‹ çº¿ç¨‹æ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå®žä½“,æ˜¯CPUè°ƒåº¦å’Œåˆ†æ´¾çš„åŸºæœ¬å•ä½,å®ƒæ˜¯æ¯”è¿›ç¨‹æ›´å°çš„èƒ½ç‹¬ç«‹è¿è¡Œçš„åŸºæœ¬å•ä½.çº¿ç¨‹è‡ªå·±åŸºæœ¬ä¸Šä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æº,åªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æº(å¦‚ç¨‹åºè®¡æ•°å™¨,ä¸€ç»„å¯„å­˜å™¨å’Œæ ˆ),ä½†æ˜¯å®ƒå¯ä¸ŽåŒå±žä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çš„çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æºã€‚çº¿ç¨‹é—´é€šä¿¡ä¸»è¦é€šè¿‡å…±äº«å†…å­˜ï¼Œä¸Šä¸‹æ–‡åˆ‡æ¢å¾ˆå¿«ï¼Œèµ„æºå¼€é”€è¾ƒå°‘ï¼Œä½†ç›¸æ¯”è¿›ç¨‹ä¸å¤Ÿç¨³å®šå®¹æ˜“ä¸¢å¤±æ•°æ®ã€‚ åç¨‹ åç¨‹æ˜¯ä¸€ç§ç”¨æˆ·æ€çš„è½»é‡çº§çº¿ç¨‹ï¼Œåç¨‹çš„è°ƒåº¦å®Œå…¨ç”±ç”¨æˆ·æŽ§åˆ¶ã€‚åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›žæ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆï¼Œç›´æŽ¥æ“ä½œæ ˆåˆ™åŸºæœ¬æ²¡æœ‰å†…æ ¸åˆ‡æ¢çš„å¼€é”€ï¼Œå¯ä»¥ä¸åŠ é”çš„è®¿é—®å…¨å±€å˜é‡ï¼Œæ‰€ä»¥ä¸Šä¸‹æ–‡çš„åˆ‡æ¢éžå¸¸å¿«ã€‚ 7. äº’æ–¥é”ï¼Œè¯»å†™é”ï¼Œæ­»é”é—®é¢˜æ˜¯æ€Žä¹ˆè§£å†³ã€‚ äº’æ–¥é” äº’æ–¥é”å°±æ˜¯äº’æ–¥å˜é‡mutexï¼Œç”¨æ¥é”ä½ä¸´ç•ŒåŒºçš„. æ¡ä»¶é”å°±æ˜¯æ¡ä»¶å˜é‡ï¼Œå½“è¿›ç¨‹çš„æŸäº›èµ„æºè¦æ±‚ä¸æ»¡è¶³æ—¶å°±è¿›å…¥ä¼‘çœ ï¼Œä¹Ÿå°±æ˜¯é”ä½äº†ã€‚å½“èµ„æºè¢«åˆ†é…åˆ°äº†ï¼Œæ¡ä»¶é”æ‰“å¼€ï¼Œè¿›ç¨‹ç»§ç»­è¿è¡Œï¼›è¯»å†™é”ï¼Œä¹Ÿç±»ä¼¼ï¼Œç”¨äºŽç¼“å†²åŒºç­‰ä¸´ç•Œèµ„æºèƒ½äº’æ–¥è®¿é—®çš„ã€‚ è¯»å†™é” é€šå¸¸æœ‰äº›å…¬å…±æ•°æ®ä¿®æ”¹çš„æœºä¼šå¾ˆå°‘ï¼Œä½†å…¶è¯»çš„æœºä¼šå¾ˆå¤šã€‚å¹¶ä¸”åœ¨è¯»çš„è¿‡ç¨‹ä¸­ä¼šä¼´éšç€æŸ¥æ‰¾ï¼Œç»™è¿™ç§ä»£ç åŠ é”ä¼šé™ä½Žæˆ‘ä»¬çš„ç¨‹åºæ•ˆçŽ‡ã€‚è¯»å†™é”å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ æ³¨æ„ï¼šå†™ç‹¬å ï¼Œè¯»å…±äº«ï¼Œå†™é”ä¼˜å…ˆçº§é«˜ æ­»é” ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æžœåŒä¸€ä¸ªçº¿ç¨‹å…ˆåŽä¸¤æ¬¡è°ƒç”¨lockï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨æ—¶ï¼Œç”±äºŽé”å·²ç»è¢«å ç”¨ï¼Œè¯¥çº¿ç¨‹ä¼šæŒ‚èµ·ç­‰å¾…åˆ«çš„çº¿ç¨‹é‡Šæ”¾é”ï¼Œç„¶è€Œé”æ­£æ˜¯è¢«è‡ªå·±å ç”¨ç€çš„ï¼Œè¯¥çº¿ç¨‹åˆè¢«æŒ‚èµ·è€Œæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå› æ­¤å°±æ°¸è¿œå¤„äºŽæŒ‚èµ·ç­‰å¾…çŠ¶æ€äº†ï¼Œè¿™å«åšæ­»é”ï¼ˆDeadlockï¼‰ã€‚ å¦å¤–ä¸€ç§æƒ…å†µæ˜¯ï¼šè‹¥çº¿ç¨‹AèŽ·å¾—äº†é”1ï¼Œçº¿ç¨‹BèŽ·å¾—äº†é”2ï¼Œè¿™æ—¶çº¿ç¨‹Aè°ƒç”¨lockè¯•å›¾èŽ·å¾—é”2ï¼Œç»“æžœæ˜¯éœ€è¦æŒ‚èµ·ç­‰å¾…çº¿ç¨‹Bé‡Šæ”¾é”2ï¼Œè€Œè¿™æ—¶çº¿ç¨‹Bä¹Ÿè°ƒç”¨lockè¯•å›¾èŽ·å¾—é”1ï¼Œç»“æžœæ˜¯éœ€è¦æŒ‚èµ·ç­‰å¾…çº¿ç¨‹Aé‡Šæ”¾é”1ï¼ŒäºŽæ˜¯çº¿ç¨‹Aå’ŒBéƒ½æ°¸è¿œå¤„äºŽæŒ‚èµ·çŠ¶æ€äº†ã€‚ æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶: äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ è¯·æ±‚ä¸Žä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡žæ—¶ï¼Œå¯¹å·²èŽ·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚ ä¸å‰¥å¤ºæ¡ä»¶:è¿›ç¨‹å·²èŽ·å¾—çš„èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚ å¾ªçŽ¯ç­‰å¾…æ¡ä»¶:è‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æŽ¥çš„å¾ªçŽ¯ç­‰å¾…èµ„æºå…³ç³»ã€‚ è¿™å››ä¸ªæ¡ä»¶æ˜¯æ­»é”çš„å¿…è¦æ¡ä»¶ï¼Œåªè¦ç³»ç»Ÿå‘ç”Ÿæ­»é”ï¼Œè¿™äº›æ¡ä»¶å¿…ç„¶æˆç«‹ï¼Œè€Œåªè¦ä¸Šè¿°æ¡ä»¶ä¹‹ä¸€ä¸æ»¡è¶³ï¼Œå°±ä¸ä¼šå‘ç”Ÿæ­»é”ã€‚ a. é¢„é˜²æ­»é” å¯ä»¥æŠŠèµ„æºä¸€æ¬¡æ€§åˆ†é…ï¼šï¼ˆç ´åè¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼‰ ç„¶åŽå‰¥å¤ºèµ„æºï¼šå³å½“æŸè¿›ç¨‹æ–°çš„èµ„æºæœªæ»¡è¶³æ—¶ï¼Œé‡Šæ”¾å·²å æœ‰çš„èµ„æºï¼ˆç ´åä¸å¯å‰¥å¤ºæ¡ä»¶ï¼‰ èµ„æºæœ‰åºåˆ†é…æ³•ï¼šç³»ç»Ÿç»™æ¯ç±»èµ„æºèµ‹äºˆä¸€ä¸ªç¼–å·ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹æŒ‰ç¼–å·é€’å¢žçš„é¡ºåºè¯·æ±‚èµ„æºï¼Œé‡Šæ”¾åˆ™ç›¸åï¼ˆç ´åçŽ¯è·¯ç­‰å¾…æ¡ä»¶ï¼‰ b. é¿å…æ­»é” é¢„é˜²æ­»é”çš„å‡ ç§ç­–ç•¥ï¼Œä¼šä¸¥é‡åœ°æŸå®³ç³»ç»Ÿæ€§èƒ½ã€‚å› æ­¤åœ¨é¿å…æ­»é”æ—¶ï¼Œè¦æ–½åŠ è¾ƒå¼±çš„é™åˆ¶ï¼Œä»Žè€ŒèŽ·å¾— è¾ƒæ»¡æ„çš„ç³»ç»Ÿæ€§èƒ½ã€‚ç”±äºŽåœ¨é¿å…æ­»é”çš„ç­–ç•¥ä¸­ï¼Œå…è®¸è¿›ç¨‹åŠ¨æ€åœ°ç”³è¯·èµ„æºã€‚å› è€Œï¼Œç³»ç»Ÿåœ¨è¿›è¡Œèµ„æºåˆ†é…ä¹‹å‰é¢„å…ˆè®¡ç®—èµ„æºåˆ†é…çš„å®‰å…¨æ€§ã€‚è‹¥æ­¤æ¬¡åˆ†é…ä¸ä¼šå¯¼è‡´ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ï¼Œåˆ™å°†èµ„æºåˆ†é…ç»™è¿›ç¨‹ï¼›å¦åˆ™ï¼Œè¿›ç¨‹ç­‰å¾…ã€‚å…¶ä¸­æœ€å…·æœ‰ä»£è¡¨æ€§çš„é¿å…æ­»é”ç®—æ³•æ˜¯é“¶è¡Œå®¶ç®—æ³•ã€‚ c. æ£€æµ‹æ­»é” é¦–å…ˆä¸ºæ¯ä¸ªè¿›ç¨‹å’Œæ¯ä¸ªèµ„æºæŒ‡å®šä¸€ä¸ªå”¯ä¸€çš„å·ç ,ç„¶åŽå»ºç«‹èµ„æºåˆ†é…è¡¨å’Œè¿›ç¨‹ç­‰å¾…è¡¨. d. è§£é™¤æ­»é” å½“å‘çŽ°æœ‰è¿›ç¨‹æ­»é”åŽï¼Œä¾¿åº”ç«‹å³æŠŠå®ƒä»Žæ­»é”çŠ¶æ€ä¸­è§£è„±å‡ºæ¥ï¼Œå¸¸é‡‡ç”¨çš„æ–¹æ³•æœ‰. e. å‰¥å¤ºèµ„æº ä»Žå…¶å®ƒè¿›ç¨‹å‰¥å¤ºè¶³å¤Ÿæ•°é‡çš„èµ„æºç»™æ­»é”è¿›ç¨‹ï¼Œä»¥è§£é™¤æ­»é”çŠ¶æ€. f. æ’¤æ¶ˆè¿›ç¨‹ å¯ä»¥ç›´æŽ¥æ’¤æ¶ˆæ­»é”è¿›ç¨‹æˆ–æ’¤æ¶ˆä»£ä»·æœ€å°çš„è¿›ç¨‹ï¼Œç›´è‡³æœ‰è¶³å¤Ÿçš„èµ„æºå¯ç”¨ï¼Œæ­»é”çŠ¶æ€.æ¶ˆé™¤ä¸ºæ­¢.æ‰€è°“ä»£ä»·æ˜¯æŒ‡ä¼˜å…ˆçº§ã€è¿è¡Œä»£ä»·ã€è¿›ç¨‹çš„é‡è¦æ€§å’Œä»·å€¼ç­‰ã€‚ 8. Golangçš„å†…å­˜æ¨¡åž‹ï¼Œä¸ºä»€ä¹ˆå°å¯¹è±¡å¤šäº†ä¼šé€ æˆgcåŽ‹åŠ›ã€‚é€šå¸¸å°å¯¹è±¡è¿‡å¤šä¼šå¯¼è‡´GCä¸‰è‰²æ³•æ¶ˆè€—è¿‡å¤šçš„GPUã€‚ä¼˜åŒ–æ€è·¯æ˜¯ï¼Œå‡å°‘å¯¹è±¡åˆ†é…. 9. Data Raceé—®é¢˜æ€Žä¹ˆè§£å†³ï¼Ÿèƒ½ä¸èƒ½ä¸åŠ é”è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŸåŒæ­¥è®¿é—®å…±äº«æ•°æ®æ˜¯å¤„ç†æ•°æ®ç«žäº‰çš„ä¸€ç§æœ‰æ•ˆçš„æ–¹æ³•.golangåœ¨1.1ä¹‹åŽå¼•å…¥äº†ç«žäº‰æ£€æµ‹æœºåˆ¶ï¼Œå¯ä»¥ä½¿ç”¨ go run -race æˆ–è€… go build -raceæ¥è¿›è¡Œé™æ€æ£€æµ‹ã€‚ å…¶åœ¨å†…éƒ¨çš„å®žçŽ°æ˜¯,å¼€å¯å¤šä¸ªåç¨‹æ‰§è¡ŒåŒä¸€ä¸ªå‘½ä»¤ï¼Œ å¹¶ä¸”è®°å½•ä¸‹æ¯ä¸ªå˜é‡çš„çŠ¶æ€. ç«žäº‰æ£€æµ‹å™¨åŸºäºŽC/C++çš„ThreadSanitizer è¿è¡Œæ—¶åº“ï¼Œè¯¥åº“åœ¨Googleå†…éƒ¨ä»£ç åŸºåœ°å’ŒChromiumæ‰¾åˆ°è®¸å¤šé”™è¯¯ã€‚è¿™ä¸ªæŠ€æœ¯åœ¨2012å¹´ä¹æœˆé›†æˆåˆ°Goä¸­ï¼Œä»Žé‚£æ—¶å¼€å§‹ï¼Œå®ƒå·²ç»åœ¨æ ‡å‡†åº“ä¸­æ£€æµ‹åˆ°42ä¸ªç«žäº‰æ¡ä»¶ã€‚çŽ°åœ¨ï¼Œå®ƒå·²ç»æ˜¯æˆ‘ä»¬æŒç»­æž„å»ºè¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ï¼Œå½“ç«žäº‰æ¡ä»¶å‡ºçŽ°æ—¶ï¼Œå®ƒä¼šç»§ç»­æ•æ‰åˆ°è¿™äº›é”™è¯¯ã€‚ ç«žäº‰æ£€æµ‹å™¨å·²ç»å®Œå…¨é›†æˆåˆ°Goå·¥å…·é“¾ä¸­ï¼Œä»…ä»…æ·»åŠ -raceæ ‡å¿—åˆ°å‘½ä»¤è¡Œå°±ä½¿ç”¨äº†æ£€æµ‹å™¨ã€‚ 1234$ go test -race mypkg // æµ‹è¯•åŒ…$ go run -race mysrc.go // ç¼–è¯‘å’Œè¿è¡Œç¨‹åº$ go build -race mycmd // æž„å»ºç¨‹åº$ go install -race mypkg // å®‰è£…ç¨‹åº è¦æƒ³è§£å†³æ•°æ®ç«žäº‰çš„é—®é¢˜å¯ä»¥ä½¿ç”¨äº’æ–¥é”sync.Mutex,è§£å†³æ•°æ®ç«žäº‰(Data race),ä¹Ÿå¯ä»¥ä½¿ç”¨ç®¡é“è§£å†³,ä½¿ç”¨ç®¡é“çš„æ•ˆçŽ‡è¦æ¯”äº’æ–¥é”é«˜. 10. ä»€ä¹ˆæ˜¯channelï¼Œä¸ºä»€ä¹ˆå®ƒå¯ä»¥åšåˆ°çº¿ç¨‹å®‰å…¨ï¼ŸChannelæ˜¯Goä¸­çš„ä¸€ä¸ªæ ¸å¿ƒç±»åž‹ï¼Œå¯ä»¥æŠŠå®ƒçœ‹æˆä¸€ä¸ªç®¡é“ï¼Œé€šè¿‡å®ƒå¹¶å‘æ ¸å¿ƒå•å…ƒå°±å¯ä»¥å‘é€æˆ–è€…æŽ¥æ”¶æ•°æ®è¿›è¡Œé€šè®¯(communication),Channelä¹Ÿå¯ä»¥ç†è§£æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œé€šè¿‡ç®¡é“è¿›è¡Œé€šä¿¡ã€‚ Golangçš„Channel,å‘é€ä¸€ä¸ªæ•°æ®åˆ°Channel å’Œ ä»ŽChannelæŽ¥æ”¶ä¸€ä¸ªæ•°æ® éƒ½æ˜¯ åŽŸå­æ€§çš„ã€‚è€Œä¸”Goçš„è®¾è®¡æ€æƒ³å°±æ˜¯:ä¸è¦é€šè¿‡å…±äº«å†…å­˜æ¥é€šä¿¡ï¼Œè€Œæ˜¯é€šè¿‡é€šä¿¡æ¥å…±äº«å†…å­˜ï¼Œå‰è€…å°±æ˜¯ä¼ ç»Ÿçš„åŠ é”ï¼ŒåŽè€…å°±æ˜¯Channelã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¾è®¡Channelçš„ä¸»è¦ç›®çš„å°±æ˜¯åœ¨å¤šä»»åŠ¡é—´ä¼ é€’æ•°æ®çš„ï¼Œè¿™å½“ç„¶æ˜¯å®‰å…¨çš„ã€‚ 11. EpollåŽŸç†.å¼€å‘é«˜æ€§èƒ½ç½‘ç»œç¨‹åºæ—¶ï¼Œwindowså¼€å‘è€…ä»¬è¨€å¿…ç§°Iocpï¼Œlinuxå¼€å‘è€…ä»¬åˆ™è¨€å¿…ç§°Epollã€‚å¤§å®¶éƒ½æ˜Žç™½Epollæ˜¯ä¸€ç§IOå¤šè·¯å¤ç”¨æŠ€æœ¯ï¼Œå¯ä»¥éžå¸¸é«˜æ•ˆçš„å¤„ç†æ•°ä»¥ç™¾ä¸‡è®¡çš„Socketå¥æŸ„ï¼Œæ¯”èµ·ä»¥å‰çš„Selectå’ŒPollæ•ˆçŽ‡æé«˜äº†å¾ˆå¤šã€‚ å…ˆç®€å•äº†è§£ä¸‹å¦‚ä½•ä½¿ç”¨Cåº“å°è£…çš„3ä¸ªepollç³»ç»Ÿè°ƒç”¨ã€‚ 123int epoll_create(int size); int epoll_ctl(int epfd, int op, int fd, struct epoll_event *event); int epoll_wait(int epfd, struct epoll_event *events,int maxevents, int timeout); ä½¿ç”¨èµ·æ¥å¾ˆæ¸…æ™°ï¼Œé¦–å…ˆè¦è°ƒç”¨epoll_createå»ºç«‹ä¸€ä¸ªepollå¯¹è±¡ã€‚å‚æ•°sizeæ˜¯å†…æ ¸ä¿è¯èƒ½å¤Ÿæ­£ç¡®å¤„ç†çš„æœ€å¤§å¥æŸ„æ•°ï¼Œå¤šäºŽè¿™ä¸ªæœ€å¤§æ•°æ—¶å†…æ ¸å¯ä¸ä¿è¯æ•ˆæžœã€‚ epoll_ctlå¯ä»¥æ“ä½œä¸Šé¢å»ºç«‹çš„epollï¼Œä¾‹å¦‚ï¼Œå°†åˆšå»ºç«‹çš„socketåŠ å…¥åˆ°epollä¸­è®©å…¶ç›‘æŽ§ï¼Œæˆ–è€…æŠŠ epollæ­£åœ¨ç›‘æŽ§çš„æŸä¸ªsocketå¥æŸ„ç§»å‡ºepollï¼Œä¸å†ç›‘æŽ§å®ƒç­‰ç­‰ã€‚ epoll_waitåœ¨è°ƒç”¨æ—¶ï¼Œåœ¨ç»™å®šçš„timeoutæ—¶é—´å†…ï¼Œå½“åœ¨ç›‘æŽ§çš„æ‰€æœ‰å¥æŸ„ä¸­æœ‰äº‹ä»¶å‘ç”Ÿæ—¶ï¼Œå°±è¿”å›žç”¨æˆ·æ€çš„è¿›ç¨‹ã€‚ ä»Žè°ƒç”¨æ–¹å¼å°±å¯ä»¥çœ‹åˆ°epollç›¸æ¯”select/pollçš„ä¼˜è¶Šä¹‹å¤„æ˜¯,å› ä¸ºåŽè€…æ¯æ¬¡è°ƒç”¨æ—¶éƒ½è¦ä¼ é€’ä½ æ‰€è¦ç›‘æŽ§çš„æ‰€æœ‰socketç»™select/pollç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ„å‘³ç€éœ€è¦å°†ç”¨æˆ·æ€çš„socketåˆ—è¡¨copyåˆ°å†…æ ¸æ€ï¼Œå¦‚æžœä»¥ä¸‡è®¡çš„å¥æŸ„ä¼šå¯¼è‡´æ¯æ¬¡éƒ½è¦copyå‡ åå‡ ç™¾KBçš„å†…å­˜åˆ°å†…æ ¸æ€ï¼Œéžå¸¸ä½Žæ•ˆã€‚è€Œæˆ‘ä»¬è°ƒç”¨epoll_waitæ—¶å°±ç›¸å½“äºŽä»¥å¾€è°ƒç”¨select/pollï¼Œä½†æ˜¯è¿™æ—¶å´ä¸ç”¨ä¼ é€’socketå¥æŸ„ç»™å†…æ ¸ï¼Œå› ä¸ºå†…æ ¸å·²ç»åœ¨epoll_ctlä¸­æ‹¿åˆ°äº†è¦ç›‘æŽ§çš„å¥æŸ„åˆ—è¡¨ã€‚ æ‰€ä»¥ï¼Œå®žé™…ä¸Šåœ¨ä½ è°ƒç”¨epoll_createåŽï¼Œå†…æ ¸å°±å·²ç»åœ¨å†…æ ¸æ€å¼€å§‹å‡†å¤‡å¸®ä½ å­˜å‚¨è¦ç›‘æŽ§çš„å¥æŸ„äº†ï¼Œæ¯æ¬¡è°ƒç”¨epoll_ctlåªæ˜¯åœ¨å¾€å†…æ ¸çš„æ•°æ®ç»“æž„é‡Œå¡žå…¥æ–°çš„socketå¥æŸ„ã€‚ åœ¨å†…æ ¸é‡Œï¼Œä¸€åˆ‡çš†æ–‡ä»¶ã€‚æ‰€ä»¥ï¼Œepollå‘å†…æ ¸æ³¨å†Œäº†ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºŽå­˜å‚¨ä¸Šè¿°çš„è¢«ç›‘æŽ§socketã€‚å½“ä½ è°ƒç”¨epoll_createæ—¶ï¼Œå°±ä¼šåœ¨è¿™ä¸ªè™šæ‹Ÿçš„epollæ–‡ä»¶ç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªfileç»“ç‚¹ã€‚å½“ç„¶è¿™ä¸ªfileä¸æ˜¯æ™®é€šæ–‡ä»¶ï¼Œå®ƒåªæœåŠ¡äºŽepollã€‚ epollåœ¨è¢«å†…æ ¸åˆå§‹åŒ–æ—¶ï¼ˆæ“ä½œç³»ç»Ÿå¯åŠ¨ï¼‰ï¼ŒåŒæ—¶ä¼šå¼€è¾Ÿå‡ºepollè‡ªå·±çš„å†…æ ¸é«˜é€ŸcacheåŒºï¼Œç”¨äºŽå®‰ç½®æ¯ä¸€ä¸ªæˆ‘ä»¬æƒ³ç›‘æŽ§çš„socketï¼Œè¿™äº›socketä¼šä»¥çº¢é»‘æ ‘çš„å½¢å¼ä¿å­˜åœ¨å†…æ ¸cacheé‡Œï¼Œä»¥æ”¯æŒå¿«é€Ÿçš„æŸ¥æ‰¾ã€æ’å…¥ã€åˆ é™¤ã€‚è¿™ä¸ªå†…æ ¸é«˜é€ŸcacheåŒºï¼Œå°±æ˜¯å»ºç«‹è¿žç»­çš„ç‰©ç†å†…å­˜é¡µï¼Œç„¶åŽåœ¨ä¹‹ä¸Šå»ºç«‹slabå±‚ï¼Œé€šå¸¸æ¥è®²ï¼Œå°±æ˜¯ç‰©ç†ä¸Šåˆ†é…å¥½ä½ æƒ³è¦çš„sizeçš„å†…å­˜å¯¹è±¡ï¼Œæ¯æ¬¡ä½¿ç”¨æ—¶éƒ½æ˜¯ä½¿ç”¨ç©ºé—²çš„å·²åˆ†é…å¥½çš„å¯¹è±¡ã€‚ 1234567891011121314static int __init eventpoll_init(void) &#123; ... ... /* Allocates slab cache used to allocate &quot;struct epitem&quot; items */ epi_cache = kmem_cache_create(&quot;eventpoll_epi&quot;, sizeof(struct epitem), 0, SLAB_HWCACHE_ALIGN|EPI_SLAB_DEBUG|SLAB_PANIC, NULL, NULL); /* Allocates slab cache used to allocate &quot;struct eppoll_entry&quot; */ pwq_cache = kmem_cache_create(&quot;eventpoll_pwq&quot;, sizeof(struct eppoll_entry), 0, EPI_SLAB_DEBUG|SLAB_PANIC, NULL, NULL); ... ... &#125; epollçš„é«˜æ•ˆå°±åœ¨äºŽï¼Œå½“æˆ‘ä»¬è°ƒç”¨epoll_ctlå¾€é‡Œå¡žå…¥ç™¾ä¸‡ä¸ªå¥æŸ„æ—¶ï¼Œepoll_waitä»ç„¶å¯ä»¥é£žå¿«çš„è¿”å›žï¼Œå¹¶æœ‰æ•ˆçš„å°†å‘ç”Ÿäº‹ä»¶çš„å¥æŸ„ç»™æˆ‘ä»¬ç”¨æˆ·ã€‚è¿™æ˜¯ç”±äºŽæˆ‘ä»¬åœ¨è°ƒç”¨epoll_createæ—¶ï¼Œå†…æ ¸é™¤äº†å¸®æˆ‘ä»¬åœ¨epollæ–‡ä»¶ç³»ç»Ÿé‡Œå»ºäº†ä¸ªfileç»“ç‚¹ï¼Œåœ¨å†…æ ¸cacheé‡Œå»ºäº†ä¸ªçº¢é»‘æ ‘ç”¨äºŽå­˜å‚¨ä»¥åŽepoll_ctlä¼ æ¥çš„socketå¤–ï¼Œè¿˜ä¼šå†å»ºç«‹ä¸€ä¸ªlisté“¾è¡¨ï¼Œç”¨äºŽå­˜å‚¨å‡†å¤‡å°±ç»ªçš„äº‹ä»¶ï¼Œå½“epoll_waitè°ƒç”¨æ—¶ï¼Œä»…ä»…è§‚å¯Ÿè¿™ä¸ªlisté“¾è¡¨é‡Œæœ‰æ²¡æœ‰æ•°æ®å³å¯ã€‚æœ‰æ•°æ®å°±è¿”å›žï¼Œæ²¡æœ‰æ•°æ®å°±sleepï¼Œç­‰åˆ°timeoutæ—¶é—´åˆ°åŽå³ä½¿é“¾è¡¨æ²¡æ•°æ®ä¹Ÿè¿”å›žã€‚æ‰€ä»¥ï¼Œepoll_waitéžå¸¸é«˜æ•ˆã€‚ è€Œä¸”ï¼Œé€šå¸¸æƒ…å†µä¸‹å³ä½¿æˆ‘ä»¬è¦ç›‘æŽ§ç™¾ä¸‡è®¡çš„å¥æŸ„ï¼Œå¤§å¤šä¸€æ¬¡ä¹Ÿåªè¿”å›žå¾ˆå°‘é‡çš„å‡†å¤‡å°±ç»ªå¥æŸ„è€Œå·²ï¼Œæ‰€ä»¥ï¼Œepoll_waitä»…éœ€è¦ä»Žå†…æ ¸æ€copyå°‘é‡çš„å¥æŸ„åˆ°ç”¨æˆ·æ€è€Œå·²ï¼Œå› æ­¤å°±ä¼šéžå¸¸çš„é«˜æ•ˆï¼ ç„¶è€Œ,è¿™ä¸ªå‡†å¤‡å°±ç»ªlisté“¾è¡¨æ˜¯æ€Žä¹ˆç»´æŠ¤çš„å‘¢ï¼Ÿå½“æˆ‘ä»¬æ‰§è¡Œepoll_ctlæ—¶ï¼Œé™¤äº†æŠŠsocketæ”¾åˆ°epollæ–‡ä»¶ç³»ç»Ÿé‡Œfileå¯¹è±¡å¯¹åº”çš„çº¢é»‘æ ‘ä¸Šä¹‹å¤–ï¼Œè¿˜ä¼šç»™å†…æ ¸ä¸­æ–­å¤„ç†ç¨‹åºæ³¨å†Œä¸€ä¸ªå›žè°ƒå‡½æ•°ï¼Œå‘Šè¯‰å†…æ ¸ï¼Œå¦‚æžœè¿™ä¸ªå¥æŸ„çš„ä¸­æ–­åˆ°äº†ï¼Œå°±æŠŠå®ƒæ”¾åˆ°å‡†å¤‡å°±ç»ªlisté“¾è¡¨é‡Œã€‚æ‰€ä»¥ï¼Œå½“ä¸€ä¸ªsocketä¸Šæœ‰æ•°æ®åˆ°äº†ï¼Œå†…æ ¸åœ¨æŠŠç½‘å¡ä¸Šçš„æ•°æ®copyåˆ°å†…æ ¸ä¸­åŽå°±æ¥æŠŠsocketæ’å…¥åˆ°å‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œäº†ã€‚ å¦‚æ­¤ï¼Œä¸€ä¸ªçº¢é»‘æ ‘ï¼Œä¸€å¼ å‡†å¤‡å°±ç»ªå¥æŸ„é“¾è¡¨ï¼Œå°‘é‡çš„å†…æ ¸cacheï¼Œå°±å¸®æˆ‘ä»¬è§£å†³äº†å¤§å¹¶å‘ä¸‹çš„socketå¤„ç†é—®é¢˜ã€‚æ‰§è¡Œepoll_createæ—¶ï¼Œåˆ›å»ºäº†çº¢é»‘æ ‘å’Œå°±ç»ªé“¾è¡¨ï¼Œæ‰§è¡Œepoll_ctlæ—¶ï¼Œå¦‚æžœå¢žåŠ socketå¥æŸ„ï¼Œåˆ™æ£€æŸ¥åœ¨çº¢é»‘æ ‘ä¸­æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨ç«‹å³è¿”å›žï¼Œä¸å­˜åœ¨åˆ™æ·»åŠ åˆ°æ ‘å¹²ä¸Šï¼Œç„¶åŽå‘å†…æ ¸æ³¨å†Œå›žè°ƒå‡½æ•°ï¼Œç”¨äºŽå½“ä¸­æ–­äº‹ä»¶æ¥ä¸´æ—¶å‘å‡†å¤‡å°±ç»ªé“¾è¡¨ä¸­æ’å…¥æ•°æ®ã€‚æ‰§è¡Œepoll_waitæ—¶ç«‹åˆ»è¿”å›žå‡†å¤‡å°±ç»ªé“¾è¡¨é‡Œçš„æ•°æ®å³å¯ã€‚ æœ€åŽçœ‹çœ‹epollç‹¬æœ‰çš„ä¸¤ç§æ¨¡å¼LTå’ŒETã€‚æ— è®ºæ˜¯LTå’ŒETæ¨¡å¼ï¼Œéƒ½é€‚ç”¨äºŽä»¥ä¸Šæ‰€è¯´çš„æµç¨‹ã€‚åŒºåˆ«æ˜¯ï¼ŒLTæ¨¡å¼ä¸‹ï¼Œåªè¦ä¸€ä¸ªå¥æŸ„ä¸Šçš„äº‹ä»¶ä¸€æ¬¡æ²¡æœ‰å¤„ç†å®Œï¼Œä¼šåœ¨ä»¥åŽè°ƒç”¨epoll_waitæ—¶æ¯æ¬¡è¿”å›žè¿™ä¸ªå¥æŸ„ï¼Œè€ŒETæ¨¡å¼ä»…åœ¨ç¬¬ä¸€æ¬¡è¿”å›žã€‚ å½“ä¸€ä¸ªsocketå¥æŸ„ä¸Šæœ‰äº‹ä»¶æ—¶ï¼Œå†…æ ¸ä¼šæŠŠè¯¥å¥æŸ„æ’å…¥ä¸Šé¢æ‰€è¯´çš„å‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œè¿™æ—¶æˆ‘ä»¬è°ƒç”¨epoll_waitï¼Œä¼šæŠŠå‡†å¤‡å°±ç»ªçš„socketæ‹·è´åˆ°ç”¨æˆ·æ€å†…å­˜ï¼Œç„¶åŽæ¸…ç©ºå‡†å¤‡å°±ç»ªlisté“¾è¡¨ï¼Œæœ€åŽï¼Œepoll_waitéœ€è¦åšçš„äº‹æƒ…ï¼Œå°±æ˜¯æ£€æŸ¥è¿™äº›socketï¼Œå¦‚æžœä¸æ˜¯ETæ¨¡å¼ï¼ˆå°±æ˜¯LTæ¨¡å¼çš„å¥æŸ„äº†ï¼‰ï¼Œå¹¶ä¸”è¿™äº›socketä¸Šç¡®å®žæœ‰æœªå¤„ç†çš„äº‹ä»¶æ—¶ï¼ŒåˆæŠŠè¯¥å¥æŸ„æ”¾å›žåˆ°åˆšåˆšæ¸…ç©ºçš„å‡†å¤‡å°±ç»ªé“¾è¡¨äº†ã€‚æ‰€ä»¥ï¼ŒéžETçš„å¥æŸ„ï¼Œåªè¦å®ƒä¸Šé¢è¿˜æœ‰äº‹ä»¶ï¼Œepoll_waitæ¯æ¬¡éƒ½ä¼šè¿”å›žã€‚è€ŒETæ¨¡å¼çš„å¥æŸ„ï¼Œé™¤éžæœ‰æ–°ä¸­æ–­åˆ°ï¼Œå³ä½¿socketä¸Šçš„äº‹ä»¶æ²¡æœ‰å¤„ç†å®Œï¼Œä¹Ÿæ˜¯ä¸ä¼šæ¯æ¬¡ä»Žepoll_waitè¿”å›žçš„ã€‚ å› æ­¤epollæ¯”selectçš„æé«˜å®žé™…ä¸Šæ˜¯ä¸€ä¸ªç”¨ç©ºé—´æ¢æ—¶é—´æ€æƒ³çš„å…·ä½“åº”ç”¨.å¯¹æ¯”é˜»å¡žIOçš„å¤„ç†æ¨¡åž‹, å¯ä»¥çœ‹åˆ°é‡‡ç”¨äº†å¤šè·¯å¤ç”¨IOä¹‹åŽ, ç¨‹åºå¯ä»¥è‡ªç”±çš„è¿›è¡Œè‡ªå·±é™¤äº†IOæ“ä½œä¹‹å¤–çš„å·¥ä½œ, åªæœ‰åˆ°IOçŠ¶æ€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ç”±å¤šè·¯å¤ç”¨IOè¿›è¡Œé€šçŸ¥, ç„¶åŽå†é‡‡å–ç›¸åº”çš„æ“ä½œ, è€Œä¸ç”¨ä¸€ç›´é˜»å¡žç­‰å¾…IOçŠ¶æ€å‘ç”Ÿå˜åŒ–,æé«˜æ•ˆçŽ‡. 12. Golang GC æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ?é¦–å…ˆæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹åžƒåœ¾å›žæ”¶.ä»€ä¹ˆæ˜¯åžƒåœ¾å›žæ”¶ï¼Ÿ å†…å­˜ç®¡ç†æ˜¯ç¨‹åºå‘˜å¼€å‘åº”ç”¨çš„ä¸€å¤§éš¾é¢˜ã€‚ä¼ ç»Ÿçš„ç³»ç»Ÿçº§ç¼–ç¨‹è¯­è¨€ï¼ˆä¸»è¦æŒ‡C/C++ï¼‰ä¸­ï¼Œç¨‹åºå¼€å‘è€…å¿…é¡»å¯¹å†…å­˜å°å¿ƒçš„è¿›è¡Œç®¡ç†æ“ä½œï¼ŒæŽ§åˆ¶å†…å­˜çš„ç”³è¯·åŠé‡Šæ”¾ã€‚å› ä¸ºç¨æœ‰ä¸æ…Žï¼Œå°±å¯èƒ½äº§ç”Ÿå†…å­˜æ³„éœ²é—®é¢˜ï¼Œè¿™ç§é—®é¢˜ä¸æ˜“å‘çŽ°å¹¶ä¸”éš¾ä»¥å®šä½ï¼Œä¸€ç›´æˆä¸ºå›°æ‰°ç¨‹åºå¼€å‘è€…çš„å™©æ¢¦ã€‚å¦‚ä½•è§£å†³è¿™ä¸ªå¤´ç–¼çš„é—®é¢˜å‘¢ï¼Ÿ è¿‡åŽ»ä¸€èˆ¬é‡‡ç”¨ä¸¤ç§åŠžæ³•ï¼š å†…å­˜æ³„éœ²æ£€æµ‹å·¥å…·ã€‚è¿™ç§å·¥å…·çš„åŽŸç†ä¸€èˆ¬æ˜¯é™æ€ä»£ç æ‰«æï¼Œé€šè¿‡æ‰«æç¨‹åºæ£€æµ‹å¯èƒ½å‡ºçŽ°å†…å­˜æ³„éœ²çš„ä»£ç æ®µã€‚ç„¶è€Œæ£€æµ‹å·¥å…·éš¾å…æœ‰ç–æ¼å’Œä¸è¶³ï¼Œåªèƒ½èµ·åˆ°è¾…åŠ©ä½œç”¨ã€‚ æ™ºèƒ½æŒ‡é’ˆã€‚è¿™æ˜¯ c++ ä¸­å¼•å…¥çš„è‡ªåŠ¨å†…å­˜ç®¡ç†æ–¹æ³•ï¼Œé€šè¿‡æ‹¥æœ‰è‡ªåŠ¨å†…å­˜ç®¡ç†åŠŸèƒ½çš„æŒ‡é’ˆå¯¹è±¡æ¥å¼•ç”¨å¯¹è±¡ï¼Œæ˜¯ç¨‹åºå‘˜ä¸ç”¨å¤ªå…³æ³¨å†…å­˜çš„é‡Šæ”¾ï¼Œè€Œè¾¾åˆ°å†…å­˜è‡ªåŠ¨é‡Šæ”¾çš„ç›®çš„ã€‚è¿™ç§æ–¹æ³•æ˜¯é‡‡ç”¨æœ€å¹¿æ³›çš„åšæ³•ï¼Œä½†æ˜¯å¯¹ç¨‹åºå¼€å‘è€…æœ‰ä¸€å®šçš„å­¦ä¹ æˆæœ¬ï¼ˆå¹¶éžè¯­è¨€å±‚é¢çš„åŽŸç”Ÿæ”¯æŒï¼‰ï¼Œè€Œä¸”ä¸€æ—¦æœ‰å¿˜è®°ä½¿ç”¨çš„åœºæ™¯ä¾ç„¶æ— æ³•é¿å…å†…å­˜æ³„éœ²ã€‚ ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒåŽæ¥å¼€å‘å‡ºæ¥çš„å‡ ä¹Žæ‰€æœ‰æ–°è¯­è¨€ï¼ˆjavaï¼Œpythonï¼Œphpç­‰ç­‰ï¼‰éƒ½å¼•å…¥äº†è¯­è¨€å±‚é¢çš„è‡ªåŠ¨å†…å­˜ç®¡ç† â€“ ä¹Ÿå°±æ˜¯è¯­è¨€çš„ä½¿ç”¨è€…åªç”¨å…³æ³¨å†…å­˜çš„ç”³è¯·è€Œä¸å¿…å…³å¿ƒå†…å­˜çš„é‡Šæ”¾ï¼Œå†…å­˜é‡Šæ”¾ç”±è™šæ‹Ÿæœºï¼ˆvirtual machineï¼‰æˆ–è¿è¡Œæ—¶ï¼ˆruntimeï¼‰æ¥è‡ªåŠ¨è¿›è¡Œç®¡ç†ã€‚è€Œè¿™ç§å¯¹ä¸å†ä½¿ç”¨çš„å†…å­˜èµ„æºè¿›è¡Œè‡ªåŠ¨å›žæ”¶çš„è¡Œä¸ºå°±è¢«ç§°ä¸ºåžƒåœ¾å›žæ”¶ã€‚ å¸¸ç”¨çš„åžƒåœ¾å›žæ”¶çš„æ–¹æ³•: å¼•ç”¨è®¡æ•°ï¼ˆreference countingï¼‰ è¿™æ˜¯æœ€ç®€å•çš„ä¸€ç§åžƒåœ¾å›žæ”¶ç®—æ³•ï¼Œå’Œä¹‹å‰æåˆ°çš„æ™ºèƒ½æŒ‡é’ˆå¼‚æ›²åŒå·¥ã€‚å¯¹æ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è¯¥å¯¹è±¡çš„å¯¹è±¡è¢«é”€æ¯æˆ–æ›´æ–°æ—¶è¢«å¼•ç”¨å¯¹è±¡çš„å¼•ç”¨è®¡æ•°è‡ªåŠ¨å‡ä¸€ï¼Œå½“è¢«å¼•ç”¨å¯¹è±¡è¢«åˆ›å»ºæˆ–è¢«èµ‹å€¼ç»™å…¶ä»–å¯¹è±¡æ—¶å¼•ç”¨è®¡æ•°è‡ªåŠ¨åŠ ä¸€ã€‚å½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶åˆ™ç«‹å³å›žæ”¶å¯¹è±¡ã€‚ è¿™ç§æ–¹æ³•çš„ä¼˜ç‚¹æ˜¯å®žçŽ°ç®€å•ï¼Œå¹¶ä¸”å†…å­˜çš„å›žæ”¶å¾ˆåŠæ—¶ã€‚è¿™ç§ç®—æ³•åœ¨å†…å­˜æ¯”è¾ƒç´§å¼ å’Œå®žæ—¶æ€§æ¯”è¾ƒé«˜çš„ç³»ç»Ÿä¸­ä½¿ç”¨çš„æ¯”è¾ƒå¹¿æ³›ï¼Œå¦‚ios cocoaæ¡†æž¶ï¼Œphpï¼Œpythonç­‰ã€‚ ä½†æ˜¯ç®€å•å¼•ç”¨è®¡æ•°ç®—æ³•ä¹Ÿæœ‰æ˜Žæ˜¾çš„ç¼ºç‚¹ï¼š é¢‘ç¹æ›´æ–°å¼•ç”¨è®¡æ•°é™ä½Žäº†æ€§èƒ½ã€‚ ä¸€ç§ç®€å•çš„è§£å†³æ–¹æ³•å°±æ˜¯ç¼–è¯‘å™¨å°†ç›¸é‚»çš„å¼•ç”¨è®¡æ•°æ›´æ–°æ“ä½œåˆå¹¶åˆ°ä¸€æ¬¡æ›´æ–°ï¼›è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯é’ˆå¯¹é¢‘ç¹å‘ç”Ÿçš„ä¸´æ—¶å˜é‡å¼•ç”¨ä¸è¿›è¡Œè®¡æ•°ï¼Œè€Œæ˜¯åœ¨å¼•ç”¨è¾¾åˆ°0æ—¶é€šè¿‡æ‰«æå †æ ˆç¡®è®¤æ˜¯å¦è¿˜æœ‰ä¸´æ—¶å¯¹è±¡å¼•ç”¨è€Œå†³å®šæ˜¯å¦é‡Šæ”¾ã€‚ç­‰ç­‰è¿˜æœ‰å¾ˆå¤šå…¶ä»–æ–¹æ³•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™é‡Œã€‚ å¾ªçŽ¯å¼•ç”¨ã€‚ å½“å¯¹è±¡é—´å‘ç”Ÿå¾ªçŽ¯å¼•ç”¨æ—¶å¼•ç”¨é“¾ä¸­çš„å¯¹è±¡éƒ½æ— æ³•å¾—åˆ°é‡Šæ”¾ã€‚æœ€æ˜Žæ˜¾çš„è§£å†³åŠžæ³•æ˜¯é¿å…äº§ç”Ÿå¾ªçŽ¯å¼•ç”¨ï¼Œå¦‚cocoaå¼•å…¥äº†strongæŒ‡é’ˆå’ŒweakæŒ‡é’ˆä¸¤ç§æŒ‡é’ˆç±»åž‹ã€‚æˆ–è€…ç³»ç»Ÿæ£€æµ‹å¾ªçŽ¯å¼•ç”¨å¹¶ä¸»åŠ¨æ‰“ç ´å¾ªçŽ¯é“¾ã€‚å½“ç„¶è¿™ä¹Ÿå¢žåŠ äº†åžƒåœ¾å›žæ”¶çš„å¤æ‚åº¦ã€‚ æ ‡è®°-æ¸…é™¤ï¼ˆmark and sweepï¼‰ æ ‡è®°-æ¸…é™¤ï¼ˆmark and sweepï¼‰åˆ†ä¸ºä¸¤æ­¥ï¼Œæ ‡è®°ä»Žæ ¹å˜é‡å¼€å§‹è¿­ä»£å¾—éåŽ†æ‰€æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå¯¹èƒ½å¤Ÿé€šè¿‡åº”ç”¨éåŽ†è®¿é—®åˆ°çš„å¯¹è±¡éƒ½è¿›è¡Œæ ‡è®°ä¸ºâ€œè¢«å¼•ç”¨â€ï¼›æ ‡è®°å®ŒæˆåŽè¿›è¡Œæ¸…é™¤æ“ä½œï¼Œå¯¹æ²¡æœ‰æ ‡è®°è¿‡çš„å†…å­˜è¿›è¡Œå›žæ”¶ï¼ˆå›žæ”¶åŒæ—¶å¯èƒ½ä¼´æœ‰ç¢Žç‰‡æ•´ç†æ“ä½œï¼‰ã€‚è¿™ç§æ–¹æ³•è§£å†³äº†å¼•ç”¨è®¡æ•°çš„ä¸è¶³ï¼Œä½†æ˜¯ä¹Ÿæœ‰æ¯”è¾ƒæ˜Žæ˜¾çš„é—®é¢˜ï¼šæ¯æ¬¡å¯åŠ¨åžƒåœ¾å›žæ”¶éƒ½ä¼šæš‚åœå½“å‰æ‰€æœ‰çš„æ­£å¸¸ä»£ç æ‰§è¡Œï¼Œå›žæ”¶æ˜¯ç³»ç»Ÿå“åº”èƒ½åŠ›å¤§å¤§é™ä½Žï¼å½“ç„¶åŽç»­ä¹Ÿå‡ºçŽ°äº†å¾ˆå¤šmark&amp;sweepç®—æ³•çš„å˜ç§ï¼ˆå¦‚ä¸‰è‰²æ ‡è®°æ³•ï¼‰ä¼˜åŒ–äº†è¿™ä¸ªé—®é¢˜ã€‚ åˆ†ä»£æœé›†ï¼ˆgenerationï¼‰ javaçš„jvm å°±ä½¿ç”¨çš„åˆ†ä»£å›žæ”¶çš„æ€è·¯ã€‚åœ¨é¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œç»å¤§å¤šæ•°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸéƒ½éžå¸¸çŸ­ã€‚åˆ†ä»£æ”¶é›†çš„åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå°†å †åˆ’åˆ†ä¸ºä¸¤ä¸ªæˆ–å¤šä¸ªç§°ä¸ºä»£ï¼ˆgenerationï¼‰çš„ç©ºé—´ã€‚æ–°åˆ›å»ºçš„å¯¹è±¡å­˜æ”¾åœ¨ç§°ä¸ºæ–°ç”Ÿä»£ï¼ˆyoung generationï¼‰ä¸­ï¼ˆä¸€èˆ¬æ¥è¯´ï¼Œæ–°ç”Ÿä»£çš„å¤§å°ä¼šæ¯” è€å¹´ä»£å°å¾ˆå¤šï¼‰ï¼Œéšç€åžƒåœ¾å›žæ”¶çš„é‡å¤æ‰§è¡Œï¼Œç”Ÿå‘½å‘¨æœŸè¾ƒé•¿çš„å¯¹è±¡ä¼šè¢«æå‡ï¼ˆpromotionï¼‰åˆ°è€å¹´ä»£ä¸­ï¼ˆè¿™é‡Œç”¨åˆ°äº†ä¸€ä¸ªåˆ†ç±»çš„æ€è·¯ï¼Œè¿™ä¸ªæ˜¯ä¹Ÿæ˜¯ç§‘å­¦æ€è€ƒçš„ä¸€ä¸ªåŸºæœ¬æ€è·¯ï¼‰ã€‚ å› æ­¤ï¼Œæ–°ç”Ÿä»£åžƒåœ¾å›žæ”¶å’Œè€å¹´ä»£åžƒåœ¾å›žæ”¶ä¸¤ç§ä¸åŒçš„åžƒåœ¾å›žæ”¶æ–¹å¼åº”è¿è€Œç”Ÿï¼Œåˆ†åˆ«ç”¨äºŽå¯¹å„è‡ªç©ºé—´ä¸­çš„å¯¹è±¡æ‰§è¡Œåžƒåœ¾å›žæ”¶ã€‚æ–°ç”Ÿä»£åžƒåœ¾å›žæ”¶çš„é€Ÿåº¦éžå¸¸å¿«ï¼Œæ¯”è€å¹´ä»£å¿«å‡ ä¸ªæ•°é‡çº§ï¼Œå³ä½¿æ–°ç”Ÿä»£åžƒåœ¾å›žæ”¶çš„é¢‘çŽ‡æ›´é«˜ï¼Œæ‰§è¡Œæ•ˆçŽ‡ä¹Ÿä»ç„¶æ¯”è€å¹´ä»£åžƒåœ¾å›žæ”¶å¼ºï¼Œè¿™æ˜¯å› ä¸ºå¤§å¤šæ•°å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸéƒ½å¾ˆçŸ­ï¼Œæ ¹æœ¬æ— éœ€æå‡åˆ°è€å¹´ä»£ã€‚ Golang GC æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆ? Golang 1.5åŽï¼Œé‡‡å–çš„æ˜¯â€œéžåˆ†ä»£çš„ã€éžç§»åŠ¨çš„ã€å¹¶å‘çš„ã€ä¸‰è‰²çš„â€æ ‡è®°æ¸…é™¤åžƒåœ¾å›žæ”¶ç®—æ³•ã€‚ golang ä¸­çš„ gc åŸºæœ¬ä¸Šæ˜¯æ ‡è®°æ¸…é™¤çš„è¿‡ç¨‹ï¼š gcçš„è¿‡ç¨‹ä¸€å…±åˆ†ä¸ºå››ä¸ªé˜¶æ®µï¼š æ ˆæ‰«æï¼ˆå¼€å§‹æ—¶STWï¼‰ ç¬¬ä¸€æ¬¡æ ‡è®°ï¼ˆå¹¶å‘ï¼‰ ç¬¬äºŒæ¬¡æ ‡è®°ï¼ˆSTWï¼‰ æ¸…é™¤ï¼ˆå¹¶å‘ï¼‰ æ•´ä¸ªè¿›ç¨‹ç©ºé—´é‡Œç”³è¯·æ¯ä¸ªå¯¹è±¡å æ®çš„å†…å­˜å¯ä»¥è§†ä¸ºä¸€ä¸ªå›¾ï¼Œåˆå§‹çŠ¶æ€ä¸‹æ¯ä¸ªå†…å­˜å¯¹è±¡éƒ½æ˜¯ç™½è‰²æ ‡è®°ã€‚ å…ˆSTWï¼Œåšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ enable write barrierã€‚ç„¶åŽå–æ¶ˆSTWï¼Œå°†æ‰«æä»»åŠ¡ä½œä¸ºå¤šä¸ªå¹¶å‘çš„goroutineç«‹å³å…¥é˜Ÿç»™è°ƒåº¦å™¨ï¼Œè¿›è€Œè¢«CPUå¤„ç† ç¬¬ä¸€è½®å…ˆæ‰«ærootå¯¹è±¡ï¼ŒåŒ…æ‹¬å…¨å±€æŒ‡é’ˆå’Œ goroutine æ ˆä¸Šçš„æŒ‡é’ˆï¼Œæ ‡è®°ä¸ºç°è‰²æ”¾å…¥é˜Ÿåˆ— ç¬¬äºŒè½®å°†ç¬¬ä¸€æ­¥é˜Ÿåˆ—ä¸­çš„å¯¹è±¡å¼•ç”¨çš„å¯¹è±¡ç½®ä¸ºç°è‰²åŠ å…¥é˜Ÿåˆ—ï¼Œä¸€ä¸ªå¯¹è±¡å¼•ç”¨çš„æ‰€æœ‰å¯¹è±¡éƒ½ç½®ç°å¹¶åŠ å…¥é˜Ÿåˆ—åŽï¼Œè¿™ä¸ªå¯¹è±¡æ‰èƒ½ç½®ä¸ºé»‘è‰²å¹¶ä»Žé˜Ÿåˆ—ä¹‹ä¸­å–å‡ºã€‚å¾ªçŽ¯å¾€å¤ï¼Œæœ€åŽé˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œæ•´ä¸ªå›¾å‰©ä¸‹çš„ç™½è‰²å†…å­˜ç©ºé—´å³ä¸å¯åˆ°è¾¾çš„å¯¹è±¡ï¼Œå³æ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼› ç¬¬ä¸‰è½®å†æ¬¡STWï¼Œå°†ç¬¬äºŒè½®è¿‡ç¨‹ä¸­æ–°å¢žå¯¹è±¡ç”³è¯·çš„å†…å­˜è¿›è¡Œæ ‡è®°ï¼ˆç°è‰²ï¼‰ï¼Œè¿™é‡Œä½¿ç”¨äº†write barrierï¼ˆå†™å±éšœï¼‰åŽ»è®°å½• Golang gc ä¼˜åŒ–çš„æ ¸å¿ƒå°±æ˜¯å°½é‡ä½¿å¾— STW(Stop The World) çš„æ—¶é—´è¶Šæ¥è¶ŠçŸ­ã€‚ è¯¦ç»†çš„Golangçš„GCä»‹ç»å¯ä»¥å‚çœ‹Golangåžƒåœ¾å›žæ”¶. 13. Golang ä¸­ Goroutine å¦‚ä½•è°ƒåº¦?goroutineæ˜¯Golangè¯­è¨€ä¸­æœ€ç»å…¸çš„è®¾è®¡ï¼Œä¹Ÿæ˜¯å…¶é­…åŠ›æ‰€åœ¨ï¼Œgoroutineçš„æœ¬è´¨æ˜¯åç¨‹ï¼Œæ˜¯å®žçŽ°å¹¶è¡Œè®¡ç®—çš„æ ¸å¿ƒã€‚ goroutineä½¿ç”¨æ–¹å¼éžå¸¸çš„ç®€å•ï¼Œåªéœ€ä½¿ç”¨goå…³é”®å­—å³å¯å¯åŠ¨ä¸€ä¸ªåç¨‹ï¼Œå¹¶ä¸”å®ƒæ˜¯å¤„äºŽå¼‚æ­¥æ–¹å¼è¿è¡Œï¼Œä½ ä¸éœ€è¦ç­‰å®ƒè¿è¡Œå®Œæˆä»¥åŽåœ¨æ‰§è¡Œä»¥åŽçš„ä»£ç ã€‚ 1go func()//é€šè¿‡goå…³é”®å­—å¯åŠ¨ä¸€ä¸ªåç¨‹æ¥è¿è¡Œå‡½æ•° åç¨‹: åç¨‹æ‹¥æœ‰è‡ªå·±çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚åç¨‹è°ƒåº¦åˆ‡æ¢æ—¶ï¼Œå°†å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆä¿å­˜åˆ°å…¶ä»–åœ°æ–¹ï¼Œåœ¨åˆ‡å›žæ¥çš„æ—¶å€™ï¼Œæ¢å¤å…ˆå‰ä¿å­˜çš„å¯„å­˜å™¨ä¸Šä¸‹æ–‡å’Œæ ˆã€‚ å› æ­¤ï¼Œåç¨‹èƒ½ä¿ç•™ä¸Šä¸€æ¬¡è°ƒç”¨æ—¶çš„çŠ¶æ€ï¼ˆå³æ‰€æœ‰å±€éƒ¨çŠ¶æ€çš„ä¸€ä¸ªç‰¹å®šç»„åˆï¼‰ï¼Œæ¯æ¬¡è¿‡ç¨‹é‡å…¥æ—¶ï¼Œå°±ç›¸å½“äºŽè¿›å…¥ä¸Šä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ï¼Œæ¢ç§è¯´æ³•ï¼šè¿›å…¥ä¸Šä¸€æ¬¡ç¦»å¼€æ—¶æ‰€å¤„é€»è¾‘æµçš„ä½ç½®ã€‚ çº¿ç¨‹å’Œè¿›ç¨‹çš„æ“ä½œæ˜¯ç”±ç¨‹åºè§¦å‘ç³»ç»ŸæŽ¥å£ï¼Œæœ€åŽçš„æ‰§è¡Œè€…æ˜¯ç³»ç»Ÿï¼›åç¨‹çš„æ“ä½œæ‰§è¡Œè€…åˆ™æ˜¯ç”¨æˆ·è‡ªèº«ç¨‹åºï¼Œgoroutineä¹Ÿæ˜¯åç¨‹ã€‚ groutineèƒ½æ‹¥æœ‰å¼ºå¤§çš„å¹¶å‘å®žçŽ°æ˜¯é€šè¿‡GPMè°ƒåº¦æ¨¡åž‹å®žçŽ°. Goçš„è°ƒåº¦å™¨å†…éƒ¨æœ‰å››ä¸ªé‡è¦çš„ç»“æž„ï¼šMï¼ŒPï¼ŒSï¼ŒSchedï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼ˆSchedæœªç»™å‡ºï¼‰. M:Mä»£è¡¨å†…æ ¸çº§çº¿ç¨‹ï¼Œä¸€ä¸ªMå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œgoroutineå°±æ˜¯è·‘åœ¨Mä¹‹ä¸Šçš„ï¼›Mæ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç»“æž„ï¼Œé‡Œé¢ç»´æŠ¤å°å¯¹è±¡å†…å­˜cacheï¼ˆmcacheï¼‰ã€å½“å‰æ‰§è¡Œçš„goroutineã€éšæœºæ•°å‘ç”Ÿå™¨ç­‰ç­‰éžå¸¸å¤šçš„ä¿¡æ¯ G:ä»£è¡¨ä¸€ä¸ªgoroutineï¼Œå®ƒæœ‰è‡ªå·±çš„æ ˆï¼Œinstruction pointerå’Œå…¶ä»–ä¿¡æ¯ï¼ˆæ­£åœ¨ç­‰å¾…çš„channelç­‰ç­‰ï¼‰ï¼Œç”¨äºŽè°ƒåº¦ã€‚ P:På…¨ç§°æ˜¯Processorï¼Œå¤„ç†å™¨ï¼Œå®ƒçš„ä¸»è¦ç”¨é€”å°±æ˜¯ç”¨æ¥æ‰§è¡Œgoroutineçš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿç»´æŠ¤äº†ä¸€ä¸ªgoroutineé˜Ÿåˆ—ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰éœ€è¦å®ƒæ¥æ‰§è¡Œçš„goroutine Schedï¼šä»£è¡¨è°ƒåº¦å™¨ï¼Œå®ƒç»´æŠ¤æœ‰å­˜å‚¨Må’ŒGçš„é˜Ÿåˆ—ä»¥åŠè°ƒåº¦å™¨çš„ä¸€äº›çŠ¶æ€ä¿¡æ¯ç­‰ã€‚ è°ƒåº¦å®žçŽ°: ä»Žä¸Šå›¾ä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ‰2ä¸ªç‰©ç†çº¿ç¨‹Mï¼Œæ¯ä¸€ä¸ªMéƒ½æ‹¥æœ‰ä¸€ä¸ªå¤„ç†å™¨Pï¼Œæ¯ä¸€ä¸ªä¹Ÿéƒ½æœ‰ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„goroutineã€‚Pçš„æ•°é‡å¯ä»¥é€šè¿‡GOMAXPROCS()æ¥è®¾ç½®ï¼Œå®ƒå…¶å®žä¹Ÿå°±ä»£è¡¨äº†çœŸæ­£çš„å¹¶å‘åº¦ï¼Œå³æœ‰å¤šå°‘ä¸ªgoroutineå¯ä»¥åŒæ—¶è¿è¡Œã€‚ å›¾ä¸­ç°è‰²çš„é‚£äº›goroutineå¹¶æ²¡æœ‰è¿è¡Œï¼Œè€Œæ˜¯å‡ºäºŽreadyçš„å°±ç»ªæ€ï¼Œæ­£åœ¨ç­‰å¾…è¢«è°ƒåº¦ã€‚Pç»´æŠ¤ç€è¿™ä¸ªé˜Ÿåˆ—ï¼ˆç§°ä¹‹ä¸ºrunqueueï¼‰ï¼ŒGoè¯­è¨€é‡Œï¼Œå¯åŠ¨ä¸€ä¸ªgoroutineå¾ˆå®¹æ˜“ï¼šgo function å°±è¡Œï¼Œæ‰€ä»¥æ¯æœ‰ä¸€ä¸ªgoè¯­å¥è¢«æ‰§è¡Œï¼Œrunqueueé˜Ÿåˆ—å°±åœ¨å…¶æœ«å°¾åŠ å…¥ä¸€ä¸ªgoroutineï¼Œåœ¨ä¸‹ä¸€ä¸ªè°ƒåº¦ç‚¹ï¼Œå°±ä»Žrunqueueä¸­å–å‡ºï¼ˆå¦‚ä½•å†³å®šå–å“ªä¸ªgoroutineï¼Ÿï¼‰ä¸€ä¸ªgoroutineæ‰§è¡Œã€‚ å½“ä¸€ä¸ªOSçº¿ç¨‹M0é™·å…¥é˜»å¡žæ—¶ï¼ŒPè½¬è€Œåœ¨è¿è¡ŒM1ï¼Œå›¾ä¸­çš„M1å¯èƒ½æ˜¯æ­£è¢«åˆ›å»ºï¼Œæˆ–è€…ä»Žçº¿ç¨‹ç¼“å­˜ä¸­å–å‡ºã€‚ å½“MOè¿”å›žæ—¶ï¼Œå®ƒå¿…é¡»å°è¯•å–å¾—ä¸€ä¸ªPæ¥è¿è¡Œgoroutineï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒä¼šä»Žå…¶ä»–çš„OSçº¿ç¨‹é‚£é‡Œæ‹¿ä¸€ä¸ªPè¿‡æ¥ï¼Œ å¦‚æžœæ²¡æœ‰æ‹¿åˆ°çš„è¯ï¼Œå®ƒå°±æŠŠgoroutineæ”¾åœ¨ä¸€ä¸ªglobal runqueueé‡Œï¼Œç„¶åŽè‡ªå·±ç¡çœ ï¼ˆæ”¾å…¥çº¿ç¨‹ç¼“å­˜é‡Œï¼‰ã€‚æ‰€æœ‰çš„Pä¹Ÿä¼šå‘¨æœŸæ€§çš„æ£€æŸ¥global runqueueå¹¶è¿è¡Œå…¶ä¸­çš„goroutineï¼Œå¦åˆ™global runqueueä¸Šçš„goroutineæ°¸è¿œæ— æ³•æ‰§è¡Œã€‚ å¦ä¸€ç§æƒ…å†µæ˜¯Pæ‰€åˆ†é…çš„ä»»åŠ¡Gå¾ˆå¿«å°±æ‰§è¡Œå®Œäº†ï¼ˆåˆ†é…ä¸å‡ï¼‰ï¼Œè¿™å°±å¯¼è‡´äº†è¿™ä¸ªå¤„ç†å™¨På¾ˆå¿™ï¼Œä½†æ˜¯å…¶ä»–çš„Pè¿˜æœ‰ä»»åŠ¡ï¼Œæ­¤æ—¶å¦‚æžœglobal runqueueæ²¡æœ‰ä»»åŠ¡Gäº†ï¼Œé‚£ä¹ˆPä¸å¾—ä¸ä»Žå…¶ä»–çš„Pé‡Œæ‹¿ä¸€äº›Gæ¥æ‰§è¡Œã€‚ é€šå¸¸æ¥è¯´ï¼Œå¦‚æžœPä»Žå…¶ä»–çš„Pé‚£é‡Œè¦æ‹¿ä»»åŠ¡çš„è¯ï¼Œä¸€èˆ¬å°±æ‹¿run queueçš„ä¸€åŠï¼Œè¿™å°±ç¡®ä¿äº†æ¯ä¸ªOSçº¿ç¨‹éƒ½èƒ½å……åˆ†çš„ä½¿ç”¨ã€‚ 14. å¹¶å‘ç¼–ç¨‹æ¦‚å¿µæ˜¯ä»€ä¹ˆï¼Ÿå¹¶è¡Œæ˜¯æŒ‡ä¸¤ä¸ªæˆ–è€…å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶åˆ»å‘ç”Ÿï¼›å¹¶å‘æ˜¯æŒ‡ä¸¤ä¸ªæˆ–å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´é—´éš”å‘ç”Ÿã€‚ å¹¶è¡Œæ˜¯åœ¨ä¸åŒå®žä½“ä¸Šçš„å¤šä¸ªäº‹ä»¶ï¼Œå¹¶å‘æ˜¯åœ¨åŒä¸€å®žä½“ä¸Šçš„å¤šä¸ªäº‹ä»¶ã€‚åœ¨ä¸€å°å¤„ç†å™¨ä¸Šâ€œåŒæ—¶â€å¤„ç†å¤šä¸ªä»»åŠ¡ï¼Œåœ¨å¤šå°å¤„ç†å™¨ä¸ŠåŒæ—¶å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚å¦‚hadoopåˆ†å¸ƒå¼é›†ç¾¤ å¹¶å‘åé‡äºŽå¤šä¸ªä»»åŠ¡äº¤æ›¿æ‰§è¡Œï¼Œè€Œå¤šä¸ªä»»åŠ¡ä¹‹é—´æœ‰å¯èƒ½è¿˜æ˜¯ä¸²è¡Œçš„ã€‚è€Œå¹¶è¡Œæ˜¯çœŸæ­£æ„ä¹‰ä¸Šçš„â€œåŒæ—¶æ‰§è¡Œâ€ã€‚ å¹¶å‘ç¼–ç¨‹æ˜¯æŒ‡åœ¨ä¸€å°å¤„ç†å™¨ä¸Šâ€œåŒæ—¶â€å¤„ç†å¤šä¸ªä»»åŠ¡ã€‚å¹¶å‘æ˜¯åœ¨åŒä¸€å®žä½“ä¸Šçš„å¤šä¸ªäº‹ä»¶ã€‚å¤šä¸ªäº‹ä»¶åœ¨åŒä¸€æ—¶é—´é—´éš”å‘ç”Ÿã€‚å¹¶å‘ç¼–ç¨‹çš„ç›®æ ‡æ˜¯å……åˆ†çš„åˆ©ç”¨å¤„ç†å™¨çš„æ¯ä¸€ä¸ªæ ¸ï¼Œä»¥è¾¾åˆ°æœ€é«˜çš„å¤„ç†æ€§èƒ½ã€‚ 15. è´Ÿè½½å‡è¡¡åŽŸç†æ˜¯ä»€ä¹ˆ?è´Ÿè½½å‡è¡¡Load Balanceï¼‰æ˜¯é«˜å¯ç”¨ç½‘ç»œåŸºç¡€æž¶æž„çš„å…³é”®ç»„ä»¶ï¼Œé€šå¸¸ç”¨äºŽå°†å·¥ä½œè´Ÿè½½åˆ†å¸ƒåˆ°å¤šä¸ªæœåŠ¡å™¨æ¥æé«˜ç½‘ç«™ã€åº”ç”¨ã€æ•°æ®åº“æˆ–å…¶ä»–æœåŠ¡çš„æ€§èƒ½å’Œå¯é æ€§ã€‚è´Ÿè½½å‡è¡¡ï¼Œå…¶æ ¸å¿ƒå°±æ˜¯ç½‘ç»œæµé‡åˆ†å‘ï¼Œåˆ†å¾ˆå¤šç»´åº¦ã€‚ è´Ÿè½½å‡è¡¡ï¼ˆLoad Balanceï¼‰é€šå¸¸æ˜¯åˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒä¸Šè¿›è¡Œæ‰§è¡Œï¼Œä¾‹å¦‚WebæœåŠ¡å™¨ã€FTPæœåŠ¡å™¨ã€ä¼ä¸šå…³é”®åº”ç”¨æœåŠ¡å™¨å’Œå…¶å®ƒå…³é”®ä»»åŠ¡æœåŠ¡å™¨ç­‰ï¼Œä»Žè€Œå…±åŒå®Œæˆå·¥ä½œä»»åŠ¡ã€‚ è´Ÿè½½å‡è¡¡æ˜¯å»ºç«‹åœ¨çŽ°æœ‰ç½‘ç»œç»“æž„ä¹‹ä¸Šï¼Œå®ƒæä¾›äº†ä¸€ç§å»‰ä»·æœ‰æ•ˆé€æ˜Žçš„æ–¹æ³•æ‰©å±•ç½‘ç»œè®¾å¤‡å’ŒæœåŠ¡å™¨çš„å¸¦å®½ã€å¢žåŠ åžåé‡ã€åŠ å¼ºç½‘ç»œæ•°æ®å¤„ç†èƒ½åŠ›ã€æé«˜ç½‘ç»œçš„çµæ´»æ€§å’Œå¯ç”¨æ€§ã€‚ é€šè¿‡ä¸€ä¸ªä¾‹å­è¯¦ç»†ä»‹ç»: æ²¡æœ‰è´Ÿè½½å‡è¡¡ web æž¶æž„ åœ¨è¿™é‡Œç”¨æˆ·æ˜¯ç›´è¿žåˆ° web æœåŠ¡å™¨ï¼Œå¦‚æžœè¿™ä¸ªæœåŠ¡å™¨å®•æœºäº†ï¼Œé‚£ä¹ˆç”¨æˆ·è‡ªç„¶ä¹Ÿå°±æ²¡åŠžæ³•è®¿é—®äº†ã€‚ å¦å¤–ï¼Œå¦‚æžœåŒæ—¶æœ‰å¾ˆå¤šç”¨æˆ·è¯•å›¾è®¿é—®æœåŠ¡å™¨ï¼Œè¶…è¿‡äº†å…¶èƒ½å¤„ç†çš„æžé™ï¼Œå°±ä¼šå‡ºçŽ°åŠ è½½é€Ÿåº¦ç¼“æ…¢æˆ–æ ¹æœ¬æ— æ³•è¿žæŽ¥çš„æƒ…å†µã€‚ è€Œé€šè¿‡åœ¨åŽç«¯å¼•å…¥ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨å’Œè‡³å°‘ä¸€ä¸ªé¢å¤–çš„ web æœåŠ¡å™¨ï¼Œå¯ä»¥ç¼“è§£è¿™ä¸ªæ•…éšœã€‚ é€šå¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰çš„åŽç«¯æœåŠ¡å™¨ä¼šä¿è¯æä¾›ç›¸åŒçš„å†…å®¹ï¼Œä»¥ä¾¿ç”¨æˆ·æ— è®ºå“ªä¸ªæœåŠ¡å™¨å“åº”ï¼Œéƒ½èƒ½æ”¶åˆ°ä¸€è‡´çš„å†…å®¹ã€‚ æœ‰è´Ÿè½½å‡è¡¡ web æž¶æž„ ç”¨æˆ·è®¿é—®è´Ÿè½½å‡è¡¡å™¨ï¼Œå†ç”±è´Ÿè½½å‡è¡¡å™¨å°†è¯·æ±‚è½¬å‘ç»™åŽç«¯æœåŠ¡å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå•ç‚¹æ•…éšœçŽ°åœ¨è½¬ç§»åˆ°è´Ÿè½½å‡è¡¡å™¨ä¸Šäº†ã€‚ è¿™é‡Œåˆå¯ä»¥é€šè¿‡å¼•å…¥ç¬¬äºŒä¸ªè´Ÿè½½å‡è¡¡å™¨æ¥ç¼“è§£ã€‚ é‚£ä¹ˆè´Ÿè½½å‡è¡¡å™¨çš„å·¥ä½œæ–¹å¼æ˜¯ä»€ä¹ˆæ ·çš„å‘¢,è´Ÿè½½å‡è¡¡å™¨åˆå¯ä»¥å¤„ç†ä»€ä¹ˆæ ·çš„è¯·æ±‚ï¼Ÿ è´Ÿè½½å‡è¡¡å™¨çš„ç®¡ç†å‘˜èƒ½ä¸»è¦ä¸ºä¸‹é¢å››ç§ä¸»è¦ç±»åž‹çš„è¯·æ±‚è®¾ç½®è½¬å‘è§„åˆ™ï¼š HTTP (ä¸ƒå±‚) HTTPS (ä¸ƒå±‚) TCP (å››å±‚) UDP (å››å±‚) è´Ÿè½½å‡è¡¡å™¨å¦‚ä½•é€‰æ‹©è¦è½¬å‘çš„åŽç«¯æœåŠ¡å™¨ï¼Ÿ è´Ÿè½½å‡è¡¡å™¨ä¸€èˆ¬æ ¹æ®ä¸¤ä¸ªå› ç´ æ¥å†³å®šè¦å°†è¯·æ±‚è½¬å‘åˆ°å“ªä¸ªæœåŠ¡å™¨ã€‚é¦–å…ˆï¼Œç¡®ä¿æ‰€é€‰æ‹©çš„æœåŠ¡å™¨èƒ½å¤Ÿå¯¹è¯·æ±‚åšå‡ºå“åº”ï¼Œç„¶åŽæ ¹æ®é¢„å…ˆé…ç½®çš„è§„åˆ™ä»Žå¥åº·æœåŠ¡å™¨æ± ï¼ˆhealthy poolï¼‰ä¸­è¿›è¡Œé€‰æ‹©ã€‚ å› ä¸ºï¼Œè´Ÿè½½å‡è¡¡å™¨åº”å½“åªé€‰æ‹©èƒ½æ­£å¸¸åšå‡ºå“åº”çš„åŽç«¯æœåŠ¡å™¨ï¼Œå› æ­¤å°±éœ€è¦æœ‰ä¸€ç§åˆ¤æ–­åŽç«¯æœåŠ¡å™¨æ˜¯å¦å¥åº·çš„æ–¹æ³•ã€‚ä¸ºäº†ç›‘è§†åŽå°æœåŠ¡å™¨çš„è¿è¡ŒçŠ¶å†µï¼Œè¿è¡ŒçŠ¶æ€æ£€æŸ¥æœåŠ¡ä¼šå®šæœŸå°è¯•ä½¿ç”¨è½¬å‘è§„åˆ™å®šä¹‰çš„åè®®å’Œç«¯å£åŽ»è¿žæŽ¥åŽç«¯æœåŠ¡å™¨ã€‚ å¦‚æžœï¼ŒæœåŠ¡å™¨æ— æ³•é€šè¿‡å¥åº·æ£€æŸ¥ï¼Œå°±ä¼šä»Žæ± ä¸­å‰”é™¤ï¼Œä¿è¯æµé‡ä¸ä¼šè¢«è½¬å‘åˆ°è¯¥æœåŠ¡å™¨ï¼Œç›´åˆ°å…¶å†æ¬¡é€šè¿‡å¥åº·æ£€æŸ¥ä¸ºæ­¢ã€‚ è´Ÿè½½å‡è¡¡ç®—æ³• è´Ÿè½½å‡è¡¡ç®—æ³•å†³å®šäº†åŽç«¯çš„å“ªäº›å¥åº·æœåŠ¡å™¨ä¼šè¢«é€‰ä¸­ã€‚ å…¶ä¸­å¸¸ç”¨çš„ç®—æ³•åŒ…æ‹¬ï¼š Round Robinï¼ˆè½®è¯¢ï¼‰ï¼šä¸ºç¬¬ä¸€ä¸ªè¯·æ±‚é€‰æ‹©åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨ï¼Œç„¶åŽæŒ‰é¡ºåºå‘ä¸‹ç§»åŠ¨åˆ—è¡¨ç›´åˆ°ç»“å°¾ï¼Œç„¶åŽå¾ªçŽ¯ã€‚ Least Connectionsï¼ˆæœ€å°è¿žæŽ¥ï¼‰ï¼šä¼˜å…ˆé€‰æ‹©è¿žæŽ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼Œåœ¨æ™®éä¼šè¯è¾ƒé•¿çš„æƒ…å†µä¸‹æŽ¨èä½¿ç”¨ã€‚ Sourceï¼šæ ¹æ®è¯·æ±‚æºçš„ IP çš„æ•£åˆ—ï¼ˆhashï¼‰æ¥é€‰æ‹©è¦è½¬å‘çš„æœåŠ¡å™¨ã€‚è¿™ç§æ–¹å¼å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šä¿è¯ç‰¹å®šç”¨æˆ·èƒ½è¿žæŽ¥åˆ°ç›¸åŒçš„æœåŠ¡å™¨ã€‚ å¦‚æžœä½ çš„åº”ç”¨éœ€è¦å¤„ç†çŠ¶æ€è€Œè¦æ±‚ç”¨æˆ·èƒ½è¿žæŽ¥åˆ°å’Œä¹‹å‰ç›¸åŒçš„æœåŠ¡å™¨ã€‚å¯ä»¥é€šè¿‡ Source ç®—æ³•åŸºäºŽå®¢æˆ·ç«¯çš„ IP ä¿¡æ¯åˆ›å»ºå…³è”ï¼Œæˆ–è€…ä½¿ç”¨ç²˜æ€§ä¼šè¯ï¼ˆsticky sessionsï¼‰ã€‚ é™¤æ­¤ä¹‹å¤–ï¼Œæƒ³è¦è§£å†³è´Ÿè½½å‡è¡¡å™¨çš„å•ç‚¹æ•…éšœé—®é¢˜ï¼Œå¯ä»¥å°†ç¬¬äºŒä¸ªè´Ÿè½½å‡è¡¡å™¨è¿žæŽ¥åˆ°ç¬¬ä¸€ä¸ªä¸Šï¼Œä»Žè€Œå½¢æˆä¸€ä¸ªé›†ç¾¤ã€‚ 16. LVSç›¸å…³äº†è§£.LVSæ˜¯ Linux Virtual Server çš„ç®€ç§°ï¼Œä¹Ÿå°±æ˜¯Linuxè™šæ‹ŸæœåŠ¡å™¨ã€‚è¿™æ˜¯ä¸€ä¸ªç”±ç« æ–‡åµ©åšå£«å‘èµ·çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒçš„å®˜æ–¹ç½‘ç«™æ˜¯LinuxVirtualServerçŽ°åœ¨ LVS å·²ç»æ˜¯ Linux å†…æ ¸æ ‡å‡†çš„ä¸€éƒ¨åˆ†ã€‚ä½¿ç”¨ LVS å¯ä»¥è¾¾åˆ°çš„æŠ€æœ¯ç›®æ ‡æ˜¯ï¼šé€šè¿‡ LVS è¾¾åˆ°çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯å’Œ Linux æ“ä½œç³»ç»Ÿå®žçŽ°ä¸€ä¸ªé«˜æ€§èƒ½é«˜å¯ç”¨çš„ Linux æœåŠ¡å™¨é›†ç¾¤ï¼Œå®ƒå…·æœ‰è‰¯å¥½çš„å¯é æ€§ã€å¯æ‰©å±•æ€§å’Œå¯æ“ä½œæ€§ã€‚ ä»Žè€Œä»¥ä½Žå»‰çš„æˆæœ¬å®žçŽ°æœ€ä¼˜çš„æ€§èƒ½ã€‚LVS æ˜¯ä¸€ä¸ªå®žçŽ°è´Ÿè½½å‡è¡¡é›†ç¾¤çš„å¼€æºè½¯ä»¶é¡¹ç›®ï¼ŒLVSæž¶æž„ä»Žé€»è¾‘ä¸Šå¯åˆ†ä¸ºè°ƒåº¦å±‚ã€Serveré›†ç¾¤å±‚å’Œå…±äº«å­˜å‚¨ã€‚ LVSçš„åŸºæœ¬å·¥ä½œåŽŸç†: å½“ç”¨æˆ·å‘è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨ï¼ˆDirector Serverï¼‰å‘èµ·è¯·æ±‚ï¼Œè°ƒåº¦å™¨å°†è¯·æ±‚å‘å¾€è‡³å†…æ ¸ç©ºé—´ PREROUTINGé“¾é¦–å…ˆä¼šæŽ¥æ”¶åˆ°ç”¨æˆ·è¯·æ±‚ï¼Œåˆ¤æ–­ç›®æ ‡IPç¡®å®šæ˜¯æœ¬æœºIPï¼Œå°†æ•°æ®åŒ…å‘å¾€INPUTé“¾ IPVSæ˜¯å·¥ä½œåœ¨INPUTé“¾ä¸Šçš„ï¼Œå½“ç”¨æˆ·è¯·æ±‚åˆ°è¾¾INPUTæ—¶ï¼ŒIPVSä¼šå°†ç”¨æˆ·è¯·æ±‚å’Œè‡ªå·±å·²å®šä¹‰å¥½çš„é›†ç¾¤æœåŠ¡è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æžœç”¨æˆ·è¯·æ±‚çš„å°±æ˜¯å®šä¹‰çš„é›†ç¾¤æœåŠ¡ï¼Œé‚£ä¹ˆæ­¤æ—¶IPVSä¼šå¼ºè¡Œä¿®æ”¹æ•°æ®åŒ…é‡Œçš„ç›®æ ‡IPåœ°å€åŠç«¯å£ï¼Œå¹¶å°†æ–°çš„æ•°æ®åŒ…å‘å¾€POSTROUTINGé“¾ POSTROUTINGé“¾æŽ¥æ”¶æ•°æ®åŒ…åŽå‘çŽ°ç›®æ ‡IPåœ°å€åˆšå¥½æ˜¯è‡ªå·±çš„åŽç«¯æœåŠ¡å™¨ï¼Œé‚£ä¹ˆæ­¤æ—¶é€šè¿‡é€‰è·¯ï¼Œå°†æ•°æ®åŒ…æœ€ç»ˆå‘é€ç»™åŽç«¯çš„æœåŠ¡å™¨ LVSçš„ç»„æˆ: LVS ç”±2éƒ¨åˆ†ç¨‹åºç»„æˆï¼ŒåŒ…æ‹¬ ipvs å’Œ ipvsadmã€‚ ipvs(ip virtual server)ï¼šä¸€æ®µä»£ç å·¥ä½œåœ¨å†…æ ¸ç©ºé—´ï¼Œå«ipvsï¼Œæ˜¯çœŸæ­£ç”Ÿæ•ˆå®žçŽ°è°ƒåº¦çš„ä»£ç ã€‚ ipvsadmï¼šå¦å¤–ä¸€æ®µæ˜¯å·¥ä½œåœ¨ç”¨æˆ·ç©ºé—´ï¼Œå«ipvsadmï¼Œè´Ÿè´£ä¸ºipvså†…æ ¸æ¡†æž¶ç¼–å†™è§„åˆ™ï¼Œå®šä¹‰è°æ˜¯é›†ç¾¤æœåŠ¡ï¼Œè€Œè°æ˜¯åŽç«¯çœŸå®žçš„æœåŠ¡å™¨(Real Server) è¯¦ç»†çš„LVSçš„ä»‹ç»å¯ä»¥å‚è€ƒLVSè¯¦è§£. 17. å¾®æœåŠ¡æž¶æž„æ˜¯ä»€ä¹ˆæ ·å­çš„?é€šå¸¸ä¼ ç»Ÿçš„é¡¹ç›®ä½“ç§¯åºžå¤§ï¼Œéœ€æ±‚ã€è®¾è®¡ã€å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²æµç¨‹å›ºå®šã€‚æ–°åŠŸèƒ½éœ€è¦åœ¨åŽŸé¡¹ç›®ä¸Šåšä¿®æ”¹ã€‚ ä½†æ˜¯å¾®æœåŠ¡å¯ä»¥çœ‹åšæ˜¯å¯¹å¤§é¡¹ç›®çš„æ‹†åˆ†ï¼Œæ˜¯åœ¨å¿«é€Ÿè¿­ä»£æ›´æ–°ä¸Šçº¿çš„éœ€æ±‚ä¸‹äº§ç”Ÿçš„ã€‚æ–°çš„åŠŸèƒ½æ¨¡å—ä¼šå‘å¸ƒæˆæ–°çš„æœåŠ¡ç»„ä»¶ï¼Œä¸Žå…¶ä»–å·²å‘å¸ƒçš„æœåŠ¡ç»„ä»¶ä¸€åŒåä½œã€‚ æœåŠ¡å†…éƒ¨æœ‰å¤šä¸ªç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ï¼Œé€šå¸¸ä»¥http restçš„æ–¹å¼è°ƒç”¨ï¼ŒæœåŠ¡æ€»ä½“ä»¥ä¸€ä¸ªï¼ˆæˆ–å‡ ä¸ªï¼‰æœåŠ¡çš„å½¢å¼å‘ˆçŽ°ç»™å®¢æˆ·ä½¿ç”¨ã€‚ å¾®æœåŠ¡æž¶æž„æ˜¯ä¸€ç§æ€æƒ³å¯¹å¾®æœåŠ¡æž¶æž„æˆ‘ä»¬æ²¡æœ‰ä¸€ä¸ªæ˜Žç¡®çš„å®šä¹‰ï¼Œä½†ç®€å•æ¥è¯´å¾®æœåŠ¡æž¶æž„æ˜¯ï¼š é‡‡ç”¨ä¸€ç»„æœåŠ¡çš„æ–¹å¼æ¥æž„å»ºä¸€ä¸ªåº”ç”¨ï¼ŒæœåŠ¡ç‹¬ç«‹éƒ¨ç½²åœ¨ä¸åŒçš„è¿›ç¨‹ä¸­ï¼Œä¸åŒæœåŠ¡é€šè¿‡ä¸€äº›è½»é‡çº§äº¤äº’æœºåˆ¶æ¥é€šä¿¡ï¼Œä¾‹å¦‚ RPCã€HTTP ç­‰ï¼ŒæœåŠ¡å¯ç‹¬ç«‹æ‰©å±•ä¼¸ç¼©ï¼Œæ¯ä¸ªæœåŠ¡å®šä¹‰äº†æ˜Žç¡®çš„è¾¹ç•Œï¼Œä¸åŒçš„æœåŠ¡ç”šè‡³å¯ä»¥é‡‡ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®žçŽ°ï¼Œç”±ç‹¬ç«‹çš„å›¢é˜Ÿæ¥ç»´æŠ¤ã€‚ Golangçš„å¾®æœåŠ¡æ¡†æž¶kitä¸­æœ‰è¯¦ç»†çš„å¾®æœåŠ¡çš„ä¾‹å­,å¯ä»¥å‚è€ƒå­¦ä¹ . å¾®æœåŠ¡æž¶æž„è®¾è®¡åŒ…æ‹¬ï¼š æœåŠ¡ç†”æ–­é™çº§é™æµæœºåˆ¶ ç†”æ–­é™çº§çš„æ¦‚å¿µ(Rate Limiter é™æµå™¨,Circuit breaker æ–­è·¯å™¨). æ¡†æž¶è°ƒç”¨æ–¹å¼è§£è€¦æ–¹å¼ Kit æˆ– Istio æˆ– Micro æœåŠ¡å‘çŽ°(consul zookeeper kubeneters etcd ) RPCè°ƒç”¨æ¡†æž¶. é“¾è·¯ç›‘æŽ§,zipkinå’Œprometheus. å¤šçº§ç¼“å­˜. ç½‘å…³ (kong gateway). Dockeréƒ¨ç½²ç®¡ç† Kubenetters. è‡ªåŠ¨é›†æˆéƒ¨ç½² CI/CD å®žè·µ. è‡ªåŠ¨æ‰©å®¹æœºåˆ¶è§„åˆ™. åŽ‹æµ‹ ä¼˜åŒ–. Trasport æ•°æ®ä¼ è¾“(åºåˆ—åŒ–å’Œååºåˆ—åŒ–). Logging æ—¥å¿—. Metrics æŒ‡é’ˆå¯¹æ¯ä¸ªè¯·æ±‚ä¿¡æ¯çš„ä»ªè¡¨ç›˜åŒ–. å¾®æœåŠ¡æž¶æž„ä»‹ç»è¯¦ç»†çš„å¯ä»¥å‚è€ƒ: Microservice Architectures 18. åˆ†å¸ƒå¼é”å®žçŽ°åŽŸç†ï¼Œç”¨è¿‡å—ï¼Ÿåœ¨åˆ†æžåˆ†å¸ƒå¼é”çš„ä¸‰ç§å®žçŽ°æ–¹å¼ä¹‹å‰ï¼Œå…ˆäº†è§£ä¸€ä¸‹åˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å“ªäº›æ¡ä»¶ï¼š åœ¨åˆ†å¸ƒå¼ç³»ç»ŸçŽ¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ–¹æ³•åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªæœºå™¨çš„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼› é«˜å¯ç”¨çš„èŽ·å–é”ä¸Žé‡Šæ”¾é”ï¼› é«˜æ€§èƒ½çš„èŽ·å–é”ä¸Žé‡Šæ”¾é”ï¼› å…·å¤‡å¯é‡å…¥ç‰¹æ€§ï¼› å…·å¤‡é”å¤±æ•ˆæœºåˆ¶ï¼Œé˜²æ­¢æ­»é”ï¼› å…·å¤‡éžé˜»å¡žé”ç‰¹æ€§ï¼Œå³æ²¡æœ‰èŽ·å–åˆ°é”å°†ç›´æŽ¥è¿”å›žèŽ·å–é”å¤±è´¥ã€‚ åˆ†å¸ƒå¼çš„CAPç†è®ºå‘Šè¯‰æˆ‘ä»¬â€œä»»ä½•ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿéƒ½æ— æ³•åŒæ—¶æ»¡è¶³ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ã€å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰å’Œåˆ†åŒºå®¹é”™æ€§ï¼ˆPartition toleranceï¼‰ï¼Œæœ€å¤šåªèƒ½åŒæ—¶æ»¡è¶³ä¸¤é¡¹ã€‚â€æ‰€ä»¥ï¼Œå¾ˆå¤šç³»ç»Ÿåœ¨è®¾è®¡ä¹‹åˆå°±è¦å¯¹è¿™ä¸‰è€…åšå‡ºå–èˆã€‚åœ¨äº’è”ç½‘é¢†åŸŸçš„ç»å¤§å¤šæ•°çš„åœºæ™¯ä¸­ï¼Œéƒ½éœ€è¦ç‰ºç‰²å¼ºä¸€è‡´æ€§æ¥æ¢å–ç³»ç»Ÿçš„é«˜å¯ç”¨æ€§ï¼Œç³»ç»Ÿå¾€å¾€åªéœ€è¦ä¿è¯â€œæœ€ç»ˆä¸€è‡´æ€§â€ï¼Œåªè¦è¿™ä¸ªæœ€ç»ˆæ—¶é—´æ˜¯åœ¨ç”¨æˆ·å¯ä»¥æŽ¥å—çš„èŒƒå›´å†…å³å¯ã€‚ é€šå¸¸åˆ†å¸ƒå¼é”ä»¥å•ç‹¬çš„æœåŠ¡æ–¹å¼å®žçŽ°ï¼Œç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„åˆ†å¸ƒå¼é”å®žçŽ°æœ‰ä¸‰ç§ï¼š åŸºäºŽæ•°æ®åº“å®žçŽ°åˆ†å¸ƒå¼é”ã€‚ åŸºäºŽç¼“å­˜ï¼ˆredisï¼Œmemcachedï¼Œtairï¼‰å®žçŽ°åˆ†å¸ƒå¼é”ã€‚ åŸºäºŽZookeeperå®žçŽ°åˆ†å¸ƒå¼é”ã€‚ å°½ç®¡æœ‰è¿™ä¸‰ç§æ–¹æ¡ˆï¼Œä½†æ˜¯ä¸åŒçš„ä¸šåŠ¡ä¹Ÿè¦æ ¹æ®è‡ªå·±çš„æƒ…å†µè¿›è¡Œé€‰åž‹ï¼Œä»–ä»¬ä¹‹é—´æ²¡æœ‰æœ€å¥½åªæœ‰æ›´é€‚åˆï¼ åŸºäºŽæ•°æ®åº“çš„å®žçŽ°æ–¹å¼ åŸºäºŽæ•°æ®åº“çš„å®žçŽ°æ–¹å¼çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼šåœ¨æ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªè¡¨ï¼Œè¡¨ä¸­åŒ…å«æ–¹æ³•åç­‰å­—æ®µï¼Œå¹¶åœ¨æ–¹æ³•åå­—æ®µä¸Šåˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œæƒ³è¦æ‰§è¡ŒæŸä¸ªæ–¹æ³•ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•åå‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼ŒæˆåŠŸæ’å…¥åˆ™èŽ·å–é”ï¼Œæ‰§è¡Œå®ŒæˆåŽåˆ é™¤å¯¹åº”çš„è¡Œæ•°æ®é‡Šæ”¾é”ã€‚ åˆ›å»ºä¸€ä¸ªè¡¨ï¼š 123456789DROP TABLE IF EXISTS `method_lock`;CREATE TABLE `method_lock` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &apos;ä¸»é”®&apos;, `method_name` varchar(64) NOT NULL COMMENT &apos;é”å®šçš„æ–¹æ³•å&apos;, `desc` varchar(255) NOT NULL COMMENT &apos;å¤‡æ³¨ä¿¡æ¯&apos;, `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, PRIMARY KEY (`id`), UNIQUE KEY `uidx_method_name` (`method_name`) USING BTREE) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 COMMENT=&apos;é”å®šä¸­çš„æ–¹æ³•&apos;; æƒ³è¦æ‰§è¡ŒæŸä¸ªæ–¹æ³•ï¼Œå°±ä½¿ç”¨è¿™ä¸ªæ–¹æ³•åå‘è¡¨ä¸­æ’å…¥æ•°æ®ï¼š 1INSERT INTO method_lock (method_name, desc) VALUES (&apos;methodName&apos;, &apos;æµ‹è¯•çš„methodName&apos;); å› ä¸ºæˆ‘ä»¬å¯¹method_nameåšäº†å”¯ä¸€æ€§çº¦æŸï¼Œè¿™é‡Œå¦‚æžœæœ‰å¤šä¸ªè¯·æ±‚åŒæ—¶æäº¤åˆ°æ•°æ®åº“çš„è¯ï¼Œæ•°æ®åº“ä¼šä¿è¯åªæœ‰ä¸€ä¸ªæ“ä½œå¯ä»¥æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºæ“ä½œæˆåŠŸçš„é‚£ä¸ªçº¿ç¨‹èŽ·å¾—äº†è¯¥æ–¹æ³•çš„é”ï¼Œå¯ä»¥æ‰§è¡Œæ–¹æ³•ä½“å†…å®¹ã€‚ æˆåŠŸæ’å…¥åˆ™èŽ·å–é”ï¼Œæ‰§è¡Œå®ŒæˆåŽåˆ é™¤å¯¹åº”çš„è¡Œæ•°æ®é‡Šæ”¾é”ï¼š 1delete from method_lock where method_name =&apos;methodName&apos;; æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯ä½¿ç”¨åŸºäºŽæ•°æ®åº“çš„ä¸€ç§æ–¹æ³•ï¼Œä½¿ç”¨æ•°æ®åº“å®žçŽ°åˆ†å¸ƒå¼é”è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„ç”¨æ³•å¯ä»¥å®žçŽ°ï¼ ä½¿ç”¨åŸºäºŽæ•°æ®åº“çš„è¿™ç§å®žçŽ°æ–¹å¼å¾ˆç®€å•ï¼Œä½†æ˜¯å¯¹äºŽåˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡çš„æ¡ä»¶æ¥è¯´ï¼Œå®ƒæœ‰ä¸€äº›é—®é¢˜éœ€è¦è§£å†³åŠä¼˜åŒ–ï¼š 1ã€å› ä¸ºæ˜¯åŸºäºŽæ•°æ®åº“å®žçŽ°çš„ï¼Œæ•°æ®åº“çš„å¯ç”¨æ€§å’Œæ€§èƒ½å°†ç›´æŽ¥å½±å“åˆ†å¸ƒå¼é”çš„å¯ç”¨æ€§åŠæ€§èƒ½ï¼Œæ‰€ä»¥ï¼Œæ•°æ®åº“éœ€è¦åŒæœºéƒ¨ç½²ã€æ•°æ®åŒæ­¥ã€ä¸»å¤‡åˆ‡æ¢ï¼› 2ã€ä¸å…·å¤‡å¯é‡å…¥çš„ç‰¹æ€§ï¼Œå› ä¸ºåŒä¸€ä¸ªçº¿ç¨‹åœ¨é‡Šæ”¾é”ä¹‹å‰ï¼Œè¡Œæ•°æ®ä¸€ç›´å­˜åœ¨ï¼Œæ— æ³•å†æ¬¡æˆåŠŸæ’å…¥æ•°æ®ï¼Œæ‰€ä»¥ï¼Œéœ€è¦åœ¨è¡¨ä¸­æ–°å¢žä¸€åˆ—ï¼Œç”¨äºŽè®°å½•å½“å‰èŽ·å–åˆ°é”çš„æœºå™¨å’Œçº¿ç¨‹ä¿¡æ¯ï¼Œåœ¨å†æ¬¡èŽ·å–é”çš„æ—¶å€™ï¼Œå…ˆæŸ¥è¯¢è¡¨ä¸­æœºå™¨å’Œçº¿ç¨‹ä¿¡æ¯æ˜¯å¦å’Œå½“å‰æœºå™¨å’Œçº¿ç¨‹ç›¸åŒï¼Œè‹¥ç›¸åŒåˆ™ç›´æŽ¥èŽ·å–é”ï¼› 3ã€æ²¡æœ‰é”å¤±æ•ˆæœºåˆ¶ï¼Œå› ä¸ºæœ‰å¯èƒ½å‡ºçŽ°æˆåŠŸæ’å…¥æ•°æ®åŽï¼ŒæœåŠ¡å™¨å®•æœºäº†ï¼Œå¯¹åº”çš„æ•°æ®æ²¡æœ‰è¢«åˆ é™¤ï¼Œå½“æœåŠ¡æ¢å¤åŽä¸€ç›´èŽ·å–ä¸åˆ°é”ï¼Œæ‰€ä»¥ï¼Œéœ€è¦åœ¨è¡¨ä¸­æ–°å¢žä¸€åˆ—ï¼Œç”¨äºŽè®°å½•å¤±æ•ˆæ—¶é—´ï¼Œå¹¶ä¸”éœ€è¦æœ‰å®šæ—¶ä»»åŠ¡æ¸…é™¤è¿™äº›å¤±æ•ˆçš„æ•°æ®ï¼› 4ã€ä¸å…·å¤‡é˜»å¡žé”ç‰¹æ€§ï¼ŒèŽ·å–ä¸åˆ°é”ç›´æŽ¥è¿”å›žå¤±è´¥ï¼Œæ‰€ä»¥éœ€è¦ä¼˜åŒ–èŽ·å–é€»è¾‘ï¼Œå¾ªçŽ¯å¤šæ¬¡åŽ»èŽ·å–ã€‚ 5ã€åœ¨å®žæ–½çš„è¿‡ç¨‹ä¸­ä¼šé‡åˆ°å„ç§ä¸åŒçš„é—®é¢˜ï¼Œä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œå®žçŽ°æ–¹å¼å°†ä¼šè¶Šæ¥è¶Šå¤æ‚ï¼›ä¾èµ–æ•°æ®åº“éœ€è¦ä¸€å®šçš„èµ„æºå¼€é”€ï¼Œæ€§èƒ½é—®é¢˜éœ€è¦è€ƒè™‘ã€‚ åŸºäºŽRedisçš„å®žçŽ°æ–¹å¼ é€‰ç”¨Rediså®žçŽ°åˆ†å¸ƒå¼é”åŽŸå› ï¼š Redisæœ‰å¾ˆé«˜çš„æ€§èƒ½ï¼› Rediså‘½ä»¤å¯¹æ­¤æ”¯æŒè¾ƒå¥½ï¼Œå®žçŽ°èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ ä¸»è¦å®žçŽ°æ–¹å¼: SET lock currentTime+expireTime EX 600 NXï¼Œä½¿ç”¨setè®¾ç½®lockå€¼ï¼Œå¹¶è®¾ç½®è¿‡æœŸæ—¶é—´ä¸º600ç§’ï¼Œå¦‚æžœæˆåŠŸï¼Œåˆ™èŽ·å–é”ï¼› èŽ·å–é”åŽï¼Œå¦‚æžœè¯¥èŠ‚ç‚¹æŽ‰çº¿ï¼Œåˆ™åˆ°è¿‡æœŸæ—¶é—´ockå€¼è‡ªåŠ¨å¤±æ•ˆï¼› é‡Šæ”¾é”æ—¶ï¼Œä½¿ç”¨delåˆ é™¤locké”®å€¼ï¼› ä½¿ç”¨rediså•æœºæ¥åšåˆ†å¸ƒå¼é”æœåŠ¡ï¼Œå¯èƒ½ä¼šå‡ºçŽ°å•ç‚¹é—®é¢˜ï¼Œå¯¼è‡´æœåŠ¡å¯ç”¨æ€§å·®ï¼Œå› æ­¤åœ¨æœåŠ¡ç¨³å®šæ€§è¦æ±‚é«˜çš„åœºåˆï¼Œå®˜æ–¹å»ºè®®ä½¿ç”¨redisé›†ç¾¤ï¼ˆä¾‹å¦‚5å°ï¼ŒæˆåŠŸè¯·æ±‚é”è¶…è¿‡3å°å°±è®¤ä¸ºèŽ·å–é”ï¼‰ï¼Œæ¥å®žçŽ°redisåˆ†å¸ƒå¼é”ã€‚è¯¦è§RedLockã€‚ ä¼˜ç‚¹:æ€§èƒ½é«˜ï¼Œrediså¯æŒä¹…åŒ–ï¼Œä¹Ÿèƒ½ä¿è¯æ•°æ®ä¸æ˜“ä¸¢å¤±,redisé›†ç¾¤æ–¹å¼æé«˜ç¨³å®šæ€§ã€‚ ç¼ºç‚¹:ä½¿ç”¨redisä¸»ä»Žåˆ‡æ¢æ—¶å¯èƒ½ä¸¢å¤±éƒ¨åˆ†æ•°æ®ã€‚ åŸºäºŽZooKeeperçš„å®žçŽ°æ–¹å¼ ZooKeeperæ˜¯ä¸€ä¸ªä¸ºåˆ†å¸ƒå¼åº”ç”¨æä¾›ä¸€è‡´æ€§æœåŠ¡çš„å¼€æºç»„ä»¶ï¼Œå®ƒå†…éƒ¨æ˜¯ä¸€ä¸ªåˆ†å±‚çš„æ–‡ä»¶ç³»ç»Ÿç›®å½•æ ‘ç»“æž„ï¼Œè§„å®šåŒä¸€ä¸ªç›®å½•ä¸‹åªèƒ½æœ‰ä¸€ä¸ªå”¯ä¸€æ–‡ä»¶åã€‚åŸºäºŽZooKeeperå®žçŽ°åˆ†å¸ƒå¼é”çš„æ­¥éª¤å¦‚ä¸‹ï¼š åˆ›å»ºä¸€ä¸ªç›®å½•mylockï¼› çº¿ç¨‹Aæƒ³èŽ·å–é”å°±åœ¨mylockç›®å½•ä¸‹åˆ›å»ºä¸´æ—¶é¡ºåºèŠ‚ç‚¹ï¼› èŽ·å–mylockç›®å½•ä¸‹æ‰€æœ‰çš„å­èŠ‚ç‚¹ï¼Œç„¶åŽèŽ·å–æ¯”è‡ªå·±å°çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œå¦‚æžœä¸å­˜åœ¨ï¼Œåˆ™è¯´æ˜Žå½“å‰çº¿ç¨‹é¡ºåºå·æœ€å°ï¼ŒèŽ·å¾—é”ï¼› çº¿ç¨‹BèŽ·å–æ‰€æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­è‡ªå·±ä¸æ˜¯æœ€å°èŠ‚ç‚¹ï¼Œè®¾ç½®ç›‘å¬æ¯”è‡ªå·±æ¬¡å°çš„èŠ‚ç‚¹ï¼› çº¿ç¨‹Aå¤„ç†å®Œï¼Œåˆ é™¤è‡ªå·±çš„èŠ‚ç‚¹ï¼Œçº¿ç¨‹Bç›‘å¬åˆ°å˜æ›´äº‹ä»¶ï¼Œåˆ¤æ–­è‡ªå·±æ˜¯ä¸æ˜¯æœ€å°çš„èŠ‚ç‚¹ï¼Œå¦‚æžœæ˜¯åˆ™èŽ·å¾—é”ã€‚ è¿™é‡ŒæŽ¨èä¸€ä¸ªApacheçš„å¼€æºåº“Curatorï¼Œå®ƒæ˜¯ä¸€ä¸ªZooKeeperå®¢æˆ·ç«¯ï¼ŒCuratoræä¾›çš„InterProcessMutexæ˜¯åˆ†å¸ƒå¼é”çš„å®žçŽ°ï¼Œacquireæ–¹æ³•ç”¨äºŽèŽ·å–é”ï¼Œreleaseæ–¹æ³•ç”¨äºŽé‡Šæ”¾é”ã€‚ ä¼˜ç‚¹ï¼šå…·å¤‡é«˜å¯ç”¨ã€å¯é‡å…¥ã€é˜»å¡žé”ç‰¹æ€§ï¼Œå¯è§£å†³å¤±æ•ˆæ­»é”é—®é¢˜ã€‚ ç¼ºç‚¹ï¼šå› ä¸ºéœ€è¦é¢‘ç¹çš„åˆ›å»ºå’Œåˆ é™¤èŠ‚ç‚¹ï¼Œæ€§èƒ½ä¸Šä¸å¦‚Redisæ–¹å¼ã€‚ ä¸Šé¢çš„ä¸‰ç§å®žçŽ°æ–¹å¼ï¼Œæ²¡æœ‰åœ¨æ‰€æœ‰åœºåˆéƒ½æ˜¯å®Œç¾Žçš„ï¼Œæ‰€ä»¥ï¼Œåº”æ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„å®žçŽ°æ–¹å¼ã€‚ åœ¨åˆ†å¸ƒå¼çŽ¯å¢ƒä¸­ï¼Œå¯¹èµ„æºè¿›è¡Œä¸Šé”æœ‰æ—¶å€™æ˜¯å¾ˆé‡è¦çš„ï¼Œæ¯”å¦‚æŠ¢è´­æŸä¸€èµ„æºï¼Œè¿™æ—¶å€™ä½¿ç”¨åˆ†å¸ƒå¼é”å°±å¯ä»¥å¾ˆå¥½åœ°æŽ§åˆ¶èµ„æºã€‚ 19. Etcdæ€Žä¹ˆå®žçŽ°åˆ†å¸ƒå¼é”?é¦–å…ˆæ€è€ƒä¸‹Etcdæ˜¯ä»€ä¹ˆï¼Ÿå¯èƒ½å¾ˆå¤šäººç¬¬ä¸€ååº”å¯èƒ½æ˜¯ä¸€ä¸ªé”®å€¼å­˜å‚¨ä»“åº“ï¼Œå´æ²¡æœ‰é‡è§†å®˜æ–¹å®šä¹‰çš„åŽåŠå¥ï¼Œç”¨äºŽé…ç½®å…±äº«å’ŒæœåŠ¡å‘çŽ°ã€‚ 1A highly-available key value store for shared configuration and service discovery. å®žé™…ä¸Šï¼Œetcd ä½œä¸ºä¸€ä¸ªå—åˆ° ZooKeeper ä¸Ž doozer å¯å‘è€Œå‚¬ç”Ÿçš„é¡¹ç›®ï¼Œé™¤äº†æ‹¥æœ‰ä¸Žä¹‹ç±»ä¼¼çš„åŠŸèƒ½å¤–ï¼Œæ›´ä¸“æ³¨äºŽä»¥ä¸‹å››ç‚¹ã€‚ ç®€å•ï¼šåŸºäºŽ HTTP+JSON çš„ API è®©ä½ ç”¨ curl å°±å¯ä»¥è½»æ¾ä½¿ç”¨ã€‚ å®‰å…¨ï¼šå¯é€‰ SSL å®¢æˆ·è®¤è¯æœºåˆ¶ã€‚ å¿«é€Ÿï¼šæ¯ä¸ªå®žä¾‹æ¯ç§’æ”¯æŒä¸€åƒæ¬¡å†™æ“ä½œã€‚ å¯ä¿¡ï¼šä½¿ç”¨ Raft ç®—æ³•å……åˆ†å®žçŽ°äº†åˆ†å¸ƒå¼ã€‚ ä½†æ˜¯è¿™é‡Œæˆ‘ä»¬ä¸»è¦è®²è¿°Etcdå¦‚ä½•å®žçŽ°åˆ†å¸ƒå¼é”? å› ä¸º Etcd ä½¿ç”¨ Raft ç®—æ³•ä¿æŒäº†æ•°æ®çš„å¼ºä¸€è‡´æ€§ï¼ŒæŸæ¬¡æ“ä½œå­˜å‚¨åˆ°é›†ç¾¤ä¸­çš„å€¼å¿…ç„¶æ˜¯å…¨å±€ä¸€è‡´çš„ï¼Œæ‰€ä»¥å¾ˆå®¹æ˜“å®žçŽ°åˆ†å¸ƒå¼é”ã€‚é”æœåŠ¡æœ‰ä¸¤ç§ä½¿ç”¨æ–¹å¼ï¼Œä¸€æ˜¯ä¿æŒç‹¬å ï¼ŒäºŒæ˜¯æŽ§åˆ¶æ—¶åºã€‚ ä¿æŒç‹¬å å³æ‰€æœ‰èŽ·å–é”çš„ç”¨æˆ·æœ€ç»ˆåªæœ‰ä¸€ä¸ªå¯ä»¥å¾—åˆ°ã€‚etcd ä¸ºæ­¤æä¾›äº†ä¸€å¥—å®žçŽ°åˆ†å¸ƒå¼é”åŽŸå­æ“ä½œ CASï¼ˆCompareAndSwapï¼‰çš„ APIã€‚é€šè¿‡è®¾ç½®prevExistå€¼ï¼Œå¯ä»¥ä¿è¯åœ¨å¤šä¸ªèŠ‚ç‚¹åŒæ—¶åŽ»åˆ›å»ºæŸä¸ªç›®å½•æ—¶ï¼Œåªæœ‰ä¸€ä¸ªæˆåŠŸã€‚è€Œåˆ›å»ºæˆåŠŸçš„ç”¨æˆ·å°±å¯ä»¥è®¤ä¸ºæ˜¯èŽ·å¾—äº†é”ã€‚ æŽ§åˆ¶æ—¶åºï¼Œå³æ‰€æœ‰æƒ³è¦èŽ·å¾—é”çš„ç”¨æˆ·éƒ½ä¼šè¢«å®‰æŽ’æ‰§è¡Œï¼Œä½†æ˜¯èŽ·å¾—é”çš„é¡ºåºä¹Ÿæ˜¯å…¨å±€å”¯ä¸€çš„ï¼ŒåŒæ—¶å†³å®šäº†æ‰§è¡Œé¡ºåºã€‚etcd ä¸ºæ­¤ä¹Ÿæä¾›äº†ä¸€å¥— APIï¼ˆè‡ªåŠ¨åˆ›å»ºæœ‰åºé”®ï¼‰ï¼Œå¯¹ä¸€ä¸ªç›®å½•å»ºå€¼æ—¶æŒ‡å®šä¸ºPOSTåŠ¨ä½œï¼Œè¿™æ · etcd ä¼šè‡ªåŠ¨åœ¨ç›®å½•ä¸‹ç”Ÿæˆä¸€ä¸ªå½“å‰æœ€å¤§çš„å€¼ä¸ºé”®ï¼Œå­˜å‚¨è¿™ä¸ªæ–°çš„å€¼ï¼ˆå®¢æˆ·ç«¯ç¼–å·ï¼‰ã€‚åŒæ—¶è¿˜å¯ä»¥ä½¿ç”¨ API æŒ‰é¡ºåºåˆ—å‡ºæ‰€æœ‰å½“å‰ç›®å½•ä¸‹çš„é”®å€¼ã€‚æ­¤æ—¶è¿™äº›é”®çš„å€¼å°±æ˜¯å®¢æˆ·ç«¯çš„æ—¶åºï¼Œè€Œè¿™äº›é”®ä¸­å­˜å‚¨çš„å€¼å¯ä»¥æ˜¯ä»£è¡¨å®¢æˆ·ç«¯çš„ç¼–å·ã€‚ åœ¨è¿™é‡ŒEctdå®žçŽ°åˆ†å¸ƒå¼é”åŸºæœ¬å®žçŽ°åŽŸç†ä¸ºï¼š åœ¨ectdç³»ç»Ÿé‡Œåˆ›å»ºä¸€ä¸ªkey å¦‚æžœåˆ›å»ºå¤±è´¥ï¼Œkeyå­˜åœ¨ï¼Œåˆ™ç›‘å¬è¯¥keyçš„å˜åŒ–äº‹ä»¶ï¼Œç›´åˆ°è¯¥keyè¢«åˆ é™¤ï¼Œå›žåˆ°1 å¦‚æžœåˆ›å»ºæˆåŠŸï¼Œåˆ™è®¤ä¸ºæˆ‘èŽ·å¾—äº†é” åº”ç”¨ç¤ºä¾‹: 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176package etcdsyncimport ( &quot;fmt&quot; &quot;io&quot; &quot;os&quot; &quot;sync&quot; &quot;time&quot; &quot;github.com/coreos/etcd/client&quot; &quot;github.com/coreos/etcd/Godeps/_workspace/src/golang.org/x/net/context&quot;)const ( defaultTTL = 60 defaultTry = 3 deleteAction = &quot;delete&quot; expireAction = &quot;expire&quot;)// A Mutex is a mutual exclusion lock which is distributed across a cluster.type Mutex struct &#123; key string id string // The identity of the caller client client.Client kapi client.KeysAPI ctx context.Context ttl time.Duration mutex *sync.Mutex logger io.Writer&#125;// New creates a Mutex with the given key which must be the same// across the cluster nodes.// machines are the ectd cluster addressesfunc New(key string, ttl int, machines []string) *Mutex &#123; cfg := client.Config&#123; Endpoints: machines, Transport: client.DefaultTransport, HeaderTimeoutPerRequest: time.Second, &#125; c, err := client.New(cfg) if err != nil &#123; return nil &#125; hostname, err := os.Hostname() if err != nil &#123; return nil &#125; if len(key) == 0 || len(machines) == 0 &#123; return nil &#125; if key[0] != &apos;/&apos; &#123; key = &quot;/&quot; + key &#125; if ttl &lt; 1 &#123; ttl = defaultTTL &#125; return &amp;Mutex&#123; key: key, id: fmt.Sprintf(&quot;%v-%v-%v&quot;, hostname, os.Getpid(), time.Now().Format(&quot;20060102-15:04:05.999999999&quot;)), client: c, kapi: client.NewKeysAPI(c), ctx: context.TODO(), ttl: time.Second * time.Duration(ttl), mutex: new(sync.Mutex), &#125;&#125;// Lock locks m.// If the lock is already in use, the calling goroutine// blocks until the mutex is available.func (m *Mutex) Lock() (err error) &#123; m.mutex.Lock() for try := 1; try &lt;= defaultTry; try++ &#123; if m.lock() == nil &#123; return nil &#125; m.debug(&quot;Lock node %v ERROR %v&quot;, m.key, err) if try &lt; defaultTry &#123; m.debug(&quot;Try to lock node %v again&quot;, m.key, err) &#125; &#125; return err&#125;func (m *Mutex) lock() (err error) &#123; m.debug(&quot;Trying to create a node : key=%v&quot;, m.key) setOptions := &amp;client.SetOptions&#123; PrevExist:client.PrevNoExist, TTL: m.ttl, &#125; resp, err := m.kapi.Set(m.ctx, m.key, m.id, setOptions) if err == nil &#123; m.debug(&quot;Create node %v OK [%q]&quot;, m.key, resp) return nil &#125; m.debug(&quot;Create node %v failed [%v]&quot;, m.key, err) e, ok := err.(client.Error) if !ok &#123; return err &#125; if e.Code != client.ErrorCodeNodeExist &#123; return err &#125; // Get the already node&apos;s value. resp, err = m.kapi.Get(m.ctx, m.key, nil) if err != nil &#123; return err &#125; m.debug(&quot;Get node %v OK&quot;, m.key) watcherOptions := &amp;client.WatcherOptions&#123; AfterIndex : resp.Index, Recursive:false, &#125; watcher := m.kapi.Watcher(m.key, watcherOptions) for &#123; m.debug(&quot;Watching %v ...&quot;, m.key) resp, err = watcher.Next(m.ctx) if err != nil &#123; return err &#125; m.debug(&quot;Received an event : %q&quot;, resp) if resp.Action == deleteAction || resp.Action == expireAction &#123; return nil &#125; &#125;&#125;// Unlock unlocks m.// It is a run-time error if m is not locked on entry to Unlock.//// A locked Mutex is not associated with a particular goroutine.// It is allowed for one goroutine to lock a Mutex and then// arrange for another goroutine to unlock it.func (m *Mutex) Unlock() (err error) &#123; defer m.mutex.Unlock() for i := 1; i &lt;= defaultTry; i++ &#123; var resp *client.Response resp, err = m.kapi.Delete(m.ctx, m.key, nil) if err == nil &#123; m.debug(&quot;Delete %v OK&quot;, m.key) return nil &#125; m.debug(&quot;Delete %v falied: %q&quot;, m.key, resp) e, ok := err.(client.Error) if ok &amp;&amp; e.Code == client.ErrorCodeKeyNotFound &#123; return nil &#125; &#125; return err&#125;func (m *Mutex) debug(format string, v ...interface&#123;&#125;) &#123; if m.logger != nil &#123; m.logger.Write([]byte(m.id)) m.logger.Write([]byte(&quot; &quot;)) m.logger.Write([]byte(fmt.Sprintf(format, v...))) m.logger.Write([]byte(&quot;\n&quot;)) &#125;&#125;func (m *Mutex) SetDebugLogger(w io.Writer) &#123; m.logger = w&#125; å…¶å®žç±»ä¼¼çš„å®žçŽ°æœ‰å¾ˆå¤šï¼Œä½†ç›®å‰éƒ½å·²ç»è¿‡æ—¶ï¼Œä½¿ç”¨çš„éƒ½æ˜¯è¢«å®˜æ–¹æ ‡è®°ä¸ºdeprecatedçš„é¡¹ç›®ã€‚ä¸”å¤§éƒ¨åˆ†æŽ¥å£éƒ½ä¸å¦‚ä¸Šè¿°ä»£ç ç®€å•ã€‚ ä½¿ç”¨ä¸Šï¼Œè·ŸGolangå®˜æ–¹syncåŒ…çš„MutexæŽ¥å£éžå¸¸ç±»ä¼¼ï¼Œå…ˆNew()ï¼Œç„¶åŽè°ƒç”¨Lock()ï¼Œä½¿ç”¨å®ŒåŽè°ƒç”¨Unlock()ï¼Œå°±ä¸‰ä¸ªæŽ¥å£ï¼Œå°±æ˜¯è¿™ä¹ˆç®€å•ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930package mainimport ( &quot;github.com/zieckey/etcdsync&quot; &quot;log&quot;)func main() &#123; //etcdsync.SetDebug(true) log.SetFlags(log.Ldate|log.Ltime|log.Lshortfile) m := etcdsync.New(&quot;/etcdsync&quot;, &quot;123&quot;, []string&#123;&quot;http://127.0.0.1:2379&quot;&#125;) if m == nil &#123; log.Printf(&quot;etcdsync.NewMutex failed&quot;) &#125; err := m.Lock() if err != nil &#123; log.Printf(&quot;etcdsync.Lock failed&quot;) &#125; else &#123; log.Printf(&quot;etcdsync.Lock OK&quot;) &#125; log.Printf(&quot;Get the lock. Do something here.&quot;) err = m.Unlock() if err != nil &#123; log.Printf(&quot;etcdsync.Unlock failed&quot;) &#125; else &#123; log.Printf(&quot;etcdsync.Unlock OK&quot;) &#125;&#125; 20. Redisçš„æ•°æ®ç»“æž„æœ‰å“ªäº›ï¼Œä»¥åŠå®žçŽ°åœºæ™¯?Redisçš„æ•°æ®ç»“æž„æœ‰äº”ç§: string å­—ç¬¦ä¸² String æ•°æ®ç»“æž„æ˜¯ç®€å•çš„ key-value ç±»åž‹ï¼Œvalue ä¸ä»…å¯ä»¥æ˜¯ Stringï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å­—ï¼ˆå½“æ•°å­—ç±»åž‹ç”¨ Long å¯ä»¥è¡¨ç¤ºçš„æ—¶å€™encoding å°±æ˜¯æ•´åž‹ï¼Œå…¶ä»–éƒ½å­˜å‚¨åœ¨ sdshdr å½“åšå­—ç¬¦ä¸²ï¼‰ã€‚ä½¿ç”¨ Strings ç±»åž‹ï¼Œå¯ä»¥å®Œå…¨å®žçŽ°ç›®å‰ Memcached çš„åŠŸèƒ½ï¼Œå¹¶ä¸”æ•ˆçŽ‡æ›´é«˜ã€‚è¿˜å¯ä»¥äº«å— Redis çš„å®šæ—¶æŒä¹…åŒ–ï¼ˆå¯ä»¥é€‰æ‹© RDB æ¨¡å¼æˆ–è€… AOF æ¨¡å¼ï¼‰ï¼Œæ“ä½œæ—¥å¿—åŠ Replication ç­‰åŠŸèƒ½ã€‚ é™¤äº†æä¾›ä¸Ž Memcached ä¸€æ ·çš„ getã€setã€incrã€decr ç­‰æ“ä½œå¤–ï¼ŒRedis è¿˜æä¾›äº†ä¸‹é¢ä¸€äº›æ“ä½œï¼š LEN niushuaiï¼šO(1)èŽ·å–å­—ç¬¦ä¸²é•¿åº¦. APPEND niushuai redisï¼šå¾€å­—ç¬¦ä¸² append å†…å®¹ï¼Œè€Œä¸”é‡‡ç”¨æ™ºèƒ½åˆ†é…å†…å­˜ï¼ˆæ¯æ¬¡2å€ï¼‰. è®¾ç½®å’ŒèŽ·å–å­—ç¬¦ä¸²çš„æŸä¸€æ®µå†…å®¹. è®¾ç½®åŠèŽ·å–å­—ç¬¦ä¸²çš„æŸä¸€ä½ï¼ˆbitï¼‰. æ‰¹é‡è®¾ç½®ä¸€ç³»åˆ—å­—ç¬¦ä¸²çš„å†…å®¹. åŽŸå­è®¡æ•°å™¨. GETSET å‘½ä»¤çš„å¦™ç”¨ï¼Œè¯·äºŽæ¸…ç©ºæ—§å€¼çš„åŒæ—¶è®¾ç½®ä¸€ä¸ªæ–°å€¼ï¼Œé…åˆåŽŸå­è®¡æ•°å™¨ä½¿ç”¨. Hash å­—å…¸ åœ¨ Memcached ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸å°†ä¸€äº›ç»“æž„åŒ–çš„ä¿¡æ¯æ‰“åŒ…æˆ hashmapï¼Œåœ¨å®¢æˆ·ç«¯åºåˆ—åŒ–åŽå­˜å‚¨ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²çš„å€¼ï¼ˆä¸€èˆ¬æ˜¯ JSON æ ¼å¼ï¼‰ï¼Œæ¯”å¦‚ç”¨æˆ·çš„æ˜µç§°ã€å¹´é¾„ã€æ€§åˆ«ã€ç§¯åˆ†ç­‰ã€‚è¿™æ—¶å€™åœ¨éœ€è¦ä¿®æ”¹å…¶ä¸­æŸä¸€é¡¹æ—¶ï¼Œé€šå¸¸éœ€è¦å°†å­—ç¬¦ä¸²ï¼ˆJSONï¼‰å–å‡ºæ¥ï¼Œç„¶åŽè¿›è¡Œååºåˆ—åŒ–ï¼Œä¿®æ”¹æŸä¸€é¡¹çš„å€¼ï¼Œå†åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼ˆJSONï¼‰å­˜å‚¨å›žåŽ»ã€‚ç®€å•ä¿®æ”¹ä¸€ä¸ªå±žæ€§å°±å¹²è¿™ä¹ˆå¤šäº‹æƒ…ï¼Œæ¶ˆè€—å¿…å®šæ˜¯å¾ˆå¤§çš„ï¼Œä¹Ÿä¸é€‚ç”¨äºŽä¸€äº›å¯èƒ½å¹¶å‘æ“ä½œçš„åœºåˆï¼ˆæ¯”å¦‚ä¸¤ä¸ªå¹¶å‘çš„æ“ä½œéƒ½éœ€è¦ä¿®æ”¹ç§¯åˆ†ï¼‰ã€‚è€Œ Redis çš„ Hash ç»“æž„å¯ä»¥ä½¿ä½ åƒåœ¨æ•°æ®åº“ä¸­ Update ä¸€ä¸ªå±žæ€§ä¸€æ ·åªä¿®æ”¹æŸä¸€é¡¹å±žæ€§å€¼ã€‚ Hashå¯ä»¥ç”¨æ¥å­˜å‚¨ã€è¯»å–ã€ä¿®æ”¹ç”¨æˆ·å±žæ€§ã€‚ List åˆ—è¡¨ List è¯´ç™½äº†å°±æ˜¯é“¾è¡¨ï¼ˆredis ä½¿ç”¨åŒç«¯é“¾è¡¨å®žçŽ°çš„ Listï¼‰ï¼Œç›¸ä¿¡å­¦è¿‡æ•°æ®ç»“æž„çŸ¥è¯†çš„äººéƒ½åº”è¯¥èƒ½ç†è§£å…¶ç»“æž„ã€‚ä½¿ç”¨ List ç»“æž„ï¼Œæˆ‘ä»¬å¯ä»¥è½»æ¾åœ°å®žçŽ°æœ€æ–°æ¶ˆæ¯æŽ’è¡Œç­‰åŠŸèƒ½ï¼ˆæ¯”å¦‚æ–°æµªå¾®åšçš„ TimeLine ï¼‰ã€‚List çš„å¦ä¸€ä¸ªåº”ç”¨å°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¯ä»¥åˆ©ç”¨ List çš„ *PUSH æ“ä½œï¼Œå°†ä»»åŠ¡å­˜åœ¨ List ä¸­ï¼Œç„¶åŽå·¥ä½œçº¿ç¨‹å†ç”¨ POP æ“ä½œå°†ä»»åŠ¡å–å‡ºè¿›è¡Œæ‰§è¡Œã€‚ Redis è¿˜æä¾›äº†æ“ä½œ List ä¸­æŸä¸€æ®µå…ƒç´ çš„ APIï¼Œä½ å¯ä»¥ç›´æŽ¥æŸ¥è¯¢ï¼Œåˆ é™¤ List ä¸­æŸä¸€æ®µçš„å…ƒç´ ã€‚ List åˆ—è¡¨åº”ç”¨: å¾®åš TimeLine. æ¶ˆæ¯é˜Ÿåˆ—. Set é›†åˆ Set å°±æ˜¯ä¸€ä¸ªé›†åˆï¼Œé›†åˆçš„æ¦‚å¿µå°±æ˜¯ä¸€å †ä¸é‡å¤å€¼çš„ç»„åˆã€‚åˆ©ç”¨ Redis æä¾›çš„ Set æ•°æ®ç»“æž„ï¼Œå¯ä»¥å­˜å‚¨ä¸€äº›é›†åˆæ€§çš„æ•°æ®ã€‚æ¯”å¦‚åœ¨å¾®åšåº”ç”¨ä¸­ï¼Œå¯ä»¥å°†ä¸€ä¸ªç”¨æˆ·æ‰€æœ‰çš„å…³æ³¨äººå­˜åœ¨ä¸€ä¸ªé›†åˆä¸­ï¼Œå°†å…¶æ‰€æœ‰ç²‰ä¸å­˜åœ¨ä¸€ä¸ªé›†åˆã€‚å› ä¸º Redis éžå¸¸äººæ€§åŒ–çš„ä¸ºé›†åˆæä¾›äº†æ±‚äº¤é›†ã€å¹¶é›†ã€å·®é›†ç­‰æ“ä½œï¼Œé‚£ä¹ˆå°±å¯ä»¥éžå¸¸æ–¹ä¾¿çš„å®žçŽ°å¦‚å…±åŒå…³æ³¨ã€å…±åŒå–œå¥½ã€äºŒåº¦å¥½å‹ç­‰åŠŸèƒ½ï¼Œå¯¹ä¸Šé¢çš„æ‰€æœ‰é›†åˆæ“ä½œï¼Œä½ è¿˜å¯ä»¥ä½¿ç”¨ä¸åŒçš„å‘½ä»¤é€‰æ‹©å°†ç»“æžœè¿”å›žç»™å®¢æˆ·ç«¯è¿˜æ˜¯å­˜é›†åˆ°ä¸€ä¸ªæ–°çš„é›†åˆä¸­ã€‚ Set é›†åˆåº”ç”¨: å…±åŒå¥½å‹ã€äºŒåº¦å¥½å‹ åˆ©ç”¨å”¯ä¸€æ€§ï¼Œå¯ä»¥ç»Ÿè®¡è®¿é—®ç½‘ç«™çš„æ‰€æœ‰ç‹¬ç«‹ IP. å¥½å‹æŽ¨èçš„æ—¶å€™ï¼Œæ ¹æ® tag æ±‚äº¤é›†ï¼Œå¤§äºŽæŸä¸ª threshold å°±å¯ä»¥æŽ¨è. Sorted Setæœ‰åºé›†åˆ å’ŒSetsç›¸æ¯”ï¼ŒSorted Setsæ˜¯å°† Set ä¸­çš„å…ƒç´ å¢žåŠ äº†ä¸€ä¸ªæƒé‡å‚æ•° scoreï¼Œä½¿å¾—é›†åˆä¸­çš„å…ƒç´ èƒ½å¤ŸæŒ‰ score è¿›è¡Œæœ‰åºæŽ’åˆ—ï¼Œæ¯”å¦‚ä¸€ä¸ªå­˜å‚¨å…¨ç­åŒå­¦æˆç»©çš„ Sorted Setsï¼Œå…¶é›†åˆ value å¯ä»¥æ˜¯åŒå­¦çš„å­¦å·ï¼Œè€Œ score å°±å¯ä»¥æ˜¯å…¶è€ƒè¯•å¾—åˆ†ï¼Œè¿™æ ·åœ¨æ•°æ®æ’å…¥é›†åˆçš„æ—¶å€™ï¼Œå°±å·²ç»è¿›è¡Œäº†å¤©ç„¶çš„æŽ’åºã€‚å¦å¤–è¿˜å¯ä»¥ç”¨ Sorted Sets æ¥åšå¸¦æƒé‡çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚æ™®é€šæ¶ˆæ¯çš„ score ä¸º1ï¼Œé‡è¦æ¶ˆæ¯çš„ score ä¸º2ï¼Œç„¶åŽå·¥ä½œçº¿ç¨‹å¯ä»¥é€‰æ‹©æŒ‰ score çš„å€’åºæ¥èŽ·å–å·¥ä½œä»»åŠ¡ã€‚è®©é‡è¦çš„ä»»åŠ¡ä¼˜å…ˆæ‰§è¡Œã€‚ Sorted Setæœ‰åºé›†åˆåº”ç”¨: 1.å¸¦æœ‰æƒé‡çš„å…ƒç´ ï¼Œæ¯”å¦‚ä¸€ä¸ªæ¸¸æˆçš„ç”¨æˆ·å¾—åˆ†æŽ’è¡Œæ¦œ. 2.æ¯”è¾ƒå¤æ‚çš„æ•°æ®ç»“æž„ï¼Œä¸€èˆ¬ç”¨åˆ°çš„åœºæ™¯ä¸ç®—å¤ªå¤š. Redis å…¶ä»–åŠŸèƒ½ä½¿ç”¨åœºæ™¯: è®¢é˜…-å‘å¸ƒç³»ç»Ÿ Pub/Sub ä»Žå­—é¢ä¸Šç†è§£å°±æ˜¯å‘å¸ƒï¼ˆPublishï¼‰ä¸Žè®¢é˜…ï¼ˆSubscribeï¼‰ï¼Œåœ¨ Redis ä¸­ï¼Œä½ å¯ä»¥è®¾å®šå¯¹æŸä¸€ä¸ª key å€¼è¿›è¡Œæ¶ˆæ¯å‘å¸ƒåŠæ¶ˆæ¯è®¢é˜…ï¼Œå½“ä¸€ä¸ª key å€¼ä¸Šè¿›è¡Œäº†æ¶ˆæ¯å‘å¸ƒåŽï¼Œæ‰€æœ‰è®¢é˜…å®ƒçš„å®¢æˆ·ç«¯éƒ½ä¼šæ”¶åˆ°ç›¸åº”çš„æ¶ˆæ¯ã€‚è¿™ä¸€åŠŸèƒ½æœ€æ˜Žæ˜¾çš„ç”¨æ³•å°±æ˜¯ç”¨ä½œå®žæ—¶æ¶ˆæ¯ç³»ç»Ÿï¼Œæ¯”å¦‚æ™®é€šçš„å³æ—¶èŠå¤©ï¼Œç¾¤èŠç­‰åŠŸèƒ½ã€‚ äº‹åŠ¡â€”â€”Transactions è°è¯´ NoSQL éƒ½ä¸æ”¯æŒäº‹åŠ¡ï¼Œè™½ç„¶ Redis çš„ Transactions æä¾›çš„å¹¶ä¸æ˜¯ä¸¥æ ¼çš„ ACID çš„äº‹åŠ¡ï¼ˆæ¯”å¦‚ä¸€ä¸²ç”¨ EXEC æäº¤æ‰§è¡Œçš„å‘½ä»¤ï¼Œåœ¨æ‰§è¡Œä¸­æœåŠ¡å™¨å®•æœºï¼Œé‚£ä¹ˆä¼šæœ‰ä¸€éƒ¨åˆ†å‘½ä»¤æ‰§è¡Œäº†ï¼Œå‰©ä¸‹çš„æ²¡æ‰§è¡Œï¼‰ï¼Œä½†æ˜¯è¿™ä¸ª Transactions è¿˜æ˜¯æä¾›äº†åŸºæœ¬çš„å‘½ä»¤æ‰“åŒ…æ‰§è¡Œçš„åŠŸèƒ½ï¼ˆåœ¨æœåŠ¡å™¨ä¸å‡ºé—®é¢˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä¿è¯ä¸€è¿žä¸²çš„å‘½ä»¤æ˜¯é¡ºåºåœ¨ä¸€èµ·æ‰§è¡Œçš„ï¼Œä¸­é—´æœ‰ä¼šæœ‰å…¶å®ƒå®¢æˆ·ç«¯å‘½ä»¤æ’è¿›æ¥æ‰§è¡Œï¼‰ã€‚Redis è¿˜æä¾›äº†ä¸€ä¸ª Watch åŠŸèƒ½ï¼Œä½ å¯ä»¥å¯¹ä¸€ä¸ª key è¿›è¡Œ Watchï¼Œç„¶åŽå†æ‰§è¡Œ Transactionsï¼Œåœ¨è¿™è¿‡ç¨‹ä¸­ï¼Œå¦‚æžœè¿™ä¸ª Watched çš„å€¼è¿›è¡Œäº†ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ª Transactions ä¼šå‘çŽ°å¹¶æ‹’ç»æ‰§è¡Œã€‚ 21. Mysqlé«˜å¯ç”¨æ–¹æ¡ˆæœ‰å“ªäº›?Mysqlé«˜å¯ç”¨æ–¹æ¡ˆåŒ…æ‹¬: ä¸»ä»Žå¤åˆ¶æ–¹æ¡ˆ è¿™æ˜¯MySQLè‡ªèº«æä¾›çš„ä¸€ç§é«˜å¯ç”¨è§£å†³æ–¹æ¡ˆï¼Œæ•°æ®åŒæ­¥æ–¹æ³•é‡‡ç”¨çš„æ˜¯MySQL replicationæŠ€æœ¯ã€‚MySQL replicationå°±æ˜¯ä»ŽæœåŠ¡å™¨åˆ°ä¸»æœåŠ¡å™¨æ‹‰å–äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œç„¶åŽå†å°†æ—¥å¿—æ–‡ä»¶è§£æžæˆç›¸åº”çš„SQLåœ¨ä»ŽæœåŠ¡å™¨ä¸Šé‡æ–°æ‰§è¡Œä¸€éä¸»æœåŠ¡å™¨çš„æ“ä½œï¼Œé€šè¿‡è¿™ç§æ–¹å¼ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ã€‚ä¸ºäº†è¾¾åˆ°æ›´é«˜çš„å¯ç”¨æ€§ï¼Œåœ¨å®žé™…çš„åº”ç”¨çŽ¯å¢ƒä¸­ï¼Œä¸€èˆ¬éƒ½æ˜¯é‡‡ç”¨MySQL replicationæŠ€æœ¯é…åˆé«˜å¯ç”¨é›†ç¾¤è½¯ä»¶keepalivedæ¥å®žçŽ°è‡ªåŠ¨failoverï¼Œè¿™ç§æ–¹å¼å¯ä»¥å®žçŽ°95.000%çš„SLAã€‚ MMM/MHAé«˜å¯ç”¨æ–¹æ¡ˆ MMMæä¾›äº†MySQLä¸»ä¸»å¤åˆ¶é…ç½®çš„ç›‘æŽ§ã€æ•…éšœè½¬ç§»å’Œç®¡ç†çš„ä¸€å¥—å¯ä¼¸ç¼©çš„è„šæœ¬å¥—ä»¶ã€‚åœ¨MMMé«˜å¯ç”¨æ–¹æ¡ˆä¸­ï¼Œå…¸åž‹çš„åº”ç”¨æ˜¯åŒä¸»å¤šä»Žæž¶æž„ï¼Œé€šè¿‡MySQL replicationæŠ€æœ¯å¯ä»¥å®žçŽ°ä¸¤ä¸ªæœåŠ¡å™¨äº’ä¸ºä¸»ä»Žï¼Œä¸”åœ¨ä»»ä½•æ—¶å€™åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥è¢«å†™å…¥ï¼Œé¿å…äº†å¤šç‚¹å†™å…¥çš„æ•°æ®å†²çªã€‚åŒæ—¶ï¼Œå½“å¯å†™çš„ä¸»èŠ‚ç‚¹æ•…éšœæ—¶ï¼ŒMMMå¥—ä»¶å¯ä»¥ç«‹åˆ»ç›‘æŽ§åˆ°ï¼Œç„¶åŽå°†æœåŠ¡è‡ªåŠ¨åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä¸»èŠ‚ç‚¹ï¼Œç»§ç»­æä¾›æœåŠ¡ï¼Œä»Žè€Œå®žçŽ°MySQLçš„é«˜å¯ç”¨ã€‚ Heartbeat/SANé«˜å¯ç”¨æ–¹æ¡ˆ åœ¨è¿™ä¸ªæ–¹æ¡ˆä¸­ï¼Œå¤„ç†failoverçš„æ–¹å¼æ˜¯é«˜å¯ç”¨é›†ç¾¤è½¯ä»¶Heartbeatï¼Œå®ƒç›‘æŽ§å’Œç®¡ç†å„ä¸ªèŠ‚ç‚¹é—´è¿žæŽ¥çš„ç½‘ç»œï¼Œå¹¶ç›‘æŽ§é›†ç¾¤æœåŠ¡ï¼Œå½“èŠ‚ç‚¹å‡ºçŽ°æ•…éšœæˆ–è€…æœåŠ¡ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨åœ¨å…¶ä»–èŠ‚ç‚¹å¯åŠ¨é›†ç¾¤æœåŠ¡ã€‚åœ¨æ•°æ®å…±äº«æ–¹é¢ï¼Œé€šè¿‡SANï¼ˆStorage Area Networkï¼‰å­˜å‚¨æ¥å…±äº«æ•°æ®ï¼Œè¿™ç§æ–¹æ¡ˆå¯ä»¥å®žçŽ°99.990%çš„SLAã€‚ Heartbeat/DRBDé«˜å¯ç”¨æ–¹æ¡ˆ è¿™ä¸ªæ–¹æ¡ˆå¤„ç†failoverçš„æ–¹å¼ä¸Šä¾æ—§é‡‡ç”¨Heartbeatï¼Œä¸åŒçš„æ˜¯ï¼Œåœ¨æ•°æ®å…±äº«æ–¹é¢ï¼Œé‡‡ç”¨äº†åŸºäºŽå—çº§åˆ«çš„æ•°æ®åŒæ­¥è½¯ä»¶DRBDæ¥å®žçŽ°ã€‚DRBDæ˜¯ä¸€ä¸ªç”¨è½¯ä»¶å®žçŽ°çš„ã€æ— å…±äº«çš„ã€æœåŠ¡å™¨ä¹‹é—´é•œåƒå—è®¾å¤‡å†…å®¹çš„å­˜å‚¨å¤åˆ¶è§£å†³æ–¹æ¡ˆã€‚å’ŒSANç½‘ç»œä¸åŒï¼Œå®ƒå¹¶ä¸å…±äº«å­˜å‚¨ï¼Œè€Œæ˜¯é€šè¿‡æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œå¤åˆ¶æ•°æ®ã€‚ NDB CLUSTERé«˜å¯ç”¨æ–¹æ¡ˆ å›½å†…ç”¨NDBé›†ç¾¤çš„å…¬å¸éžå¸¸å°‘ï¼Œè²Œä¼¼æœ‰äº›é“¶è¡Œæœ‰ç”¨ã€‚NDBé›†ç¾¤ä¸éœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹ç»„ä»¶ï¼Œå…¨éƒ¨éƒ½ä½¿ç”¨å®˜æ–¹ç»„ä»¶ï¼Œèƒ½ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼ŒæŸä¸ªæ•°æ®èŠ‚ç‚¹æŒ‚æŽ‰ï¼Œå…¶ä»–æ•°æ®èŠ‚ç‚¹ä¾ç„¶å¯ä»¥æä¾›æœåŠ¡ï¼Œç®¡ç†èŠ‚ç‚¹éœ€è¦åšå†—ä½™ä»¥é˜²æŒ‚æŽ‰ã€‚ç¼ºç‚¹æ˜¯ï¼šç®¡ç†å’Œé…ç½®éƒ½å¾ˆå¤æ‚ï¼Œè€Œä¸”æŸäº›SQLè¯­å¥ä¾‹å¦‚joinè¯­å¥éœ€è¦é¿å…ã€‚ 22. Goè¯­è¨€çš„æ ˆç©ºé—´ç®¡ç†æ˜¯æ€Žä¹ˆæ ·çš„?Goè¯­è¨€çš„è¿è¡ŒçŽ¯å¢ƒï¼ˆruntimeï¼‰ä¼šåœ¨goroutineéœ€è¦çš„æ—¶å€™åŠ¨æ€åœ°åˆ†é…æ ˆç©ºé—´ï¼Œè€Œä¸æ˜¯ç»™æ¯ä¸ªgoroutineåˆ†é…å›ºå®šå¤§å°çš„å†…å­˜ç©ºé—´ã€‚è¿™æ ·å°±é¿å…äº†éœ€è¦ç¨‹åºå‘˜æ¥å†³å®šæ ˆçš„å¤§å°ã€‚ åˆ†å—å¼çš„æ ˆæ˜¯æœ€åˆGoè¯­è¨€ç»„ç»‡æ ˆçš„æ–¹å¼ã€‚å½“åˆ›å»ºä¸€ä¸ªgoroutineçš„æ—¶å€™ï¼Œå®ƒä¼šåˆ†é…ä¸€ä¸ª8KBçš„å†…å­˜ç©ºé—´æ¥ç»™goroutineçš„æ ˆä½¿ç”¨ã€‚æˆ‘ä»¬å¯èƒ½ä¼šè€ƒè™‘å½“è¿™8KBçš„æ ˆç©ºé—´è¢«ç”¨å®Œçš„æ—¶å€™è¯¥æ€Žä¹ˆåŠž? ä¸ºäº†å¤„ç†è¿™ç§æƒ…å†µï¼Œæ¯ä¸ªGoå‡½æ•°çš„å¼€å¤´éƒ½æœ‰ä¸€å°æ®µæ£€æµ‹ä»£ç ã€‚è¿™æ®µä»£ç ä¼šæ£€æŸ¥æˆ‘ä»¬æ˜¯å¦å·²ç»ç”¨å®Œäº†åˆ†é…çš„æ ˆç©ºé—´ã€‚å¦‚æžœæ˜¯çš„è¯ï¼Œå®ƒä¼šè°ƒç”¨morestackå‡½æ•°ã€‚morestackå‡½æ•°åˆ†é…ä¸€å—æ–°çš„å†…å­˜ä½œä¸ºæ ˆç©ºé—´ï¼Œå¹¶ä¸”åœ¨è¿™å—æ ˆç©ºé—´çš„åº•éƒ¨å¡«å…¥å„ç§ä¿¡æ¯ï¼ˆåŒ…æ‹¬ä¹‹å‰çš„é‚£å—æ ˆåœ°å€ï¼‰ã€‚åœ¨åˆ†é…äº†è¿™å—æ–°çš„æ ˆç©ºé—´ä¹‹åŽï¼Œå®ƒä¼šé‡è¯•åˆšæ‰é€ æˆæ ˆç©ºé—´ä¸è¶³çš„å‡½æ•°ã€‚è¿™ä¸ªè¿‡ç¨‹å«åšæ ˆåˆ†è£‚ï¼ˆstack splitï¼‰ã€‚ åœ¨æ–°åˆ†é…çš„æ ˆåº•éƒ¨ï¼Œè¿˜æ’å…¥äº†ä¸€ä¸ªå«åšlessstackçš„å‡½æ•°æŒ‡é’ˆã€‚è¿™ä¸ªå‡½æ•°è¿˜æ²¡æœ‰è¢«è°ƒç”¨ã€‚è¿™æ ·è®¾ç½®æ˜¯ä¸ºäº†ä»Žåˆšæ‰é€ æˆæ ˆç©ºé—´ä¸è¶³çš„é‚£ä¸ªå‡½æ•°è¿”å›žæ—¶åšå‡†å¤‡çš„ã€‚å½“æˆ‘ä»¬ä»Žé‚£ä¸ªå‡½æ•°è¿”å›žæ—¶ï¼Œå®ƒä¼šè·³è½¬åˆ°lessstackã€‚lessstackå‡½æ•°ä¼šæŸ¥çœ‹åœ¨æ ˆåº•éƒ¨å­˜æ”¾çš„æ•°æ®ç»“æž„é‡Œçš„ä¿¡æ¯ï¼Œç„¶åŽè°ƒæ•´æ ˆæŒ‡é’ˆï¼ˆstack pointerï¼‰ã€‚è¿™æ ·å°±å®Œæˆäº†ä»Žæ–°çš„æ ˆå—åˆ°è€çš„æ ˆå—çš„è·³è½¬ã€‚æŽ¥ä¸‹æ¥ï¼Œæ–°åˆ†é…çš„è¿™ä¸ªå—æ ˆç©ºé—´å°±å¯ä»¥è¢«é‡Šæ”¾æŽ‰äº†ã€‚ åˆ†å—å¼çš„æ ˆè®©æˆ‘ä»¬èƒ½å¤ŸæŒ‰ç…§éœ€æ±‚æ¥æ‰©å±•å’Œæ”¶ç¼©æ ˆçš„å¤§å°ã€‚ Goå¼€å‘è€…ä¸éœ€è¦èŠ±ç²¾åŠ›åŽ»ä¼°è®¡goroutineä¼šç”¨åˆ°å¤šå¤§çš„æ ˆã€‚åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineçš„å¼€é”€ä¹Ÿä¸å¤§ã€‚å½“ Goå¼€å‘è€…ä¸çŸ¥é“æ ˆä¼šæ‰©å±•åˆ°å¤šå°‘å¤§æ—¶ï¼Œå®ƒä¹Ÿèƒ½å¾ˆå¥½çš„å¤„ç†è¿™ç§æƒ…å†µã€‚ è¿™ä¸€ç›´æ˜¯ä¹‹å‰Goè¯­è¨€ç®¡ç†æ ˆçš„çš„æ–¹æ³•ã€‚ä½†è¿™ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªé—®é¢˜ã€‚ç¼©å‡æ ˆç©ºé—´æ˜¯ä¸€ä¸ªå¼€é”€ç›¸å¯¹è¾ƒå¤§çš„æ“ä½œã€‚å¦‚æžœåœ¨ä¸€ä¸ªå¾ªçŽ¯é‡Œæœ‰æ ˆåˆ†è£‚ï¼Œé‚£ä¹ˆå®ƒçš„å¼€é”€å°±å˜å¾—ä¸å¯å¿½ç•¥äº†ã€‚ä¸€ä¸ªå‡½æ•°ä¼šæ‰©å±•ï¼Œç„¶åŽåˆ†è£‚æ ˆã€‚å½“å®ƒè¿”å›žçš„æ—¶å€™åˆä¼šé‡Šæ”¾ä¹‹å‰åˆ†é…çš„å†…å­˜å—ã€‚å¦‚æžœè¿™äº›éƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªå¾ªçŽ¯é‡Œçš„è¯ï¼Œä»£ä»·æ˜¯ç›¸å½“å¤§çš„ã€‚ è¿™å°±æ˜¯æ‰€è°“çš„çƒ­åˆ†è£‚é—®é¢˜ï¼ˆhot split problemï¼‰ã€‚å®ƒæ˜¯Goè¯­è¨€å¼€å‘è€…é€‰æ‹©æ–°çš„æ ˆç®¡ç†æ–¹æ³•çš„ä¸»è¦åŽŸå› ã€‚æ–°çš„æ–¹æ³•å«åšæ ˆå¤åˆ¶æ³•ï¼ˆstack copyingï¼‰ã€‚ æ ˆå¤åˆ¶æ³•ä¸€å¼€å§‹å’Œåˆ†å—å¼çš„æ ˆå¾ˆåƒã€‚å½“goroutineè¿è¡Œå¹¶ç”¨å®Œæ ˆç©ºé—´çš„æ—¶å€™ï¼Œä¸Žä¹‹å‰çš„æ–¹æ³•ä¸€æ ·ï¼Œæ ˆæº¢å‡ºæ£€æŸ¥ä¼šè¢«è§¦å‘ã€‚ä½†æ˜¯ï¼Œä¸åƒä¹‹å‰çš„æ–¹æ³•é‚£æ ·åˆ†é…ä¸€ä¸ªæ–°çš„å†…å­˜å—å¹¶é“¾æŽ¥åˆ°è€çš„æ ˆå†…å­˜å—ï¼Œæ–°çš„æ–¹æ³•ä¼šåˆ†é…ä¸€ä¸ªä¸¤å€å¤§çš„å†…å­˜å—å¹¶æŠŠè€çš„å†…å­˜å—å†…å®¹å¤åˆ¶åˆ°æ–°çš„å†…å­˜å—é‡Œã€‚è¿™æ ·åšæ„å‘³ç€å½“æ ˆç¼©å‡å›žä¹‹å‰å¤§å°æ—¶ï¼Œæˆ‘ä»¬ä¸éœ€è¦åšä»»ä½•äº‹æƒ…ã€‚æ ˆçš„ç¼©å‡æ²¡æœ‰ä»»ä½•ä»£ä»·ã€‚è€Œä¸”ï¼Œå½“æ ˆå†æ¬¡æ‰©å±•æ—¶ï¼Œè¿è¡ŒçŽ¯å¢ƒä¹Ÿä¸éœ€è¦å†åšä»»ä½•äº‹ã€‚å®ƒå¯ä»¥é‡ç”¨ä¹‹å‰åˆ†é…çš„ç©ºé—´ã€‚ æ ˆçš„å¤åˆ¶å¬èµ·æ¥å¾ˆå®¹æ˜“ï¼Œä½†å®žé™…æ“ä½œå¹¶éžé‚£ä¹ˆç®€å•ã€‚å­˜å‚¨åœ¨æ ˆä¸Šçš„å˜é‡çš„åœ°å€å¯èƒ½å·²ç»è¢«ä½¿ç”¨åˆ°ã€‚ä¹Ÿå°±æ˜¯è¯´ç¨‹åºä½¿ç”¨åˆ°äº†ä¸€äº›æŒ‡å‘æ ˆçš„æŒ‡é’ˆã€‚å½“ç§»åŠ¨æ ˆçš„æ—¶å€™ï¼Œæ‰€æœ‰æŒ‡å‘æ ˆé‡Œå†…å®¹çš„æŒ‡é’ˆéƒ½ä¼šå˜å¾—æ— æ•ˆã€‚ç„¶è€Œï¼ŒæŒ‡å‘æ ˆå†…å®¹çš„æŒ‡é’ˆè‡ªèº«ä¹Ÿå¿…å®šæ˜¯ä¿å­˜åœ¨æ ˆä¸Šçš„ã€‚è¿™æ˜¯ä¸ºäº†ä¿è¯å†…å­˜å®‰å…¨çš„å¿…è¦æ¡ä»¶ã€‚å¦åˆ™ä¸€ä¸ªç¨‹åºå°±æœ‰å¯èƒ½è®¿é—®ä¸€æ®µå·²ç»æ— æ•ˆçš„æ ˆç©ºé—´äº†ã€‚ å› ä¸ºåžƒåœ¾å›žæ”¶çš„éœ€è¦ï¼Œæˆ‘ä»¬å¿…é¡»çŸ¥é“æ ˆçš„å“ªäº›éƒ¨åˆ†æ˜¯è¢«ç”¨ä½œæŒ‡é’ˆäº†ã€‚å½“æˆ‘ä»¬ç§»åŠ¨æ ˆçš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ›´æ–°æ ˆé‡Œçš„æŒ‡é’ˆè®©å®ƒä»¬æŒ‡å‘æ–°çš„åœ°å€ã€‚æ‰€æœ‰ç›¸å…³çš„æŒ‡é’ˆéƒ½ä¼šè¢«æ›´æ–°ã€‚æˆ‘ä»¬ä½¿ç”¨äº†åžƒåœ¾å›žæ”¶çš„ä¿¡æ¯æ¥å¤åˆ¶æ ˆï¼Œä½†å¹¶ä¸æ˜¯ä»»ä½•ä½¿ç”¨æ ˆçš„å‡½æ•°éƒ½æœ‰è¿™äº›ä¿¡æ¯ã€‚å› ä¸ºå¾ˆå¤§ä¸€éƒ¨åˆ†è¿è¡ŒçŽ¯å¢ƒæ˜¯ç”¨Cè¯­è¨€å†™çš„ï¼Œå¾ˆå¤šè¢«è°ƒç”¨çš„è¿è¡ŒçŽ¯å¢ƒé‡Œçš„å‡½æ•°å¹¶æ²¡æœ‰æŒ‡é’ˆçš„ä¿¡æ¯ï¼Œæ‰€ä»¥ä¹Ÿå°±ä¸èƒ½å¤Ÿè¢«å¤åˆ¶äº†ã€‚å½“é‡åˆ°è¿™ç§æƒ…å†µæ—¶ï¼Œæˆ‘ä»¬åªèƒ½é€€å›žåˆ°åˆ†å—å¼çš„æ ˆå¹¶æ”¯ä»˜ç›¸åº”çš„å¼€é”€ã€‚ è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆçŽ°åœ¨è¿è¡ŒçŽ¯å¢ƒçš„å¼€å‘è€…æ­£åœ¨ç”¨Goè¯­è¨€é‡å†™è¿è¡ŒçŽ¯å¢ƒçš„å¤§éƒ¨åˆ†ä»£ç ã€‚æ— æ³•ç”¨Goè¯­è¨€é‡å†™çš„éƒ¨åˆ†ï¼ˆæ¯”å¦‚è°ƒåº¦å™¨çš„æ ¸å¿ƒä»£ç å’Œåžƒåœ¾å›žæ”¶å™¨ï¼‰ä¼šåœ¨ç‰¹æ®Šçš„æ ˆä¸Šè¿è¡Œã€‚è¿™ä¸ªç‰¹æ®Šæ ˆçš„å¤§å°ç”±è¿è¡ŒçŽ¯å¢ƒçš„å¼€å‘è€…è®¾ç½®ã€‚ è¿™äº›æ”¹å˜é™¤äº†ä½¿æ ˆå¤åˆ¶æˆä¸ºå¯èƒ½ï¼Œå®ƒä¹Ÿå…è®¸æˆ‘ä»¬åœ¨å°†æ¥å®žçŽ°å¹¶è¡Œåžƒåœ¾å›žæ”¶ã€‚ å¦å¤–ä¸€ç§ä¸åŒçš„æ ˆå¤„ç†æ–¹å¼å°±æ˜¯åœ¨è™šæ‹Ÿå†…å­˜ä¸­åˆ†é…å¤§å†…å­˜æ®µã€‚ç”±äºŽç‰©ç†å†…å­˜åªæ˜¯åœ¨çœŸæ­£ä½¿ç”¨æ—¶æ‰ä¼šè¢«åˆ†é…ï¼Œå› æ­¤çœ‹èµ·æ¥å¥½ä¼¼ä½ å¯ä»¥åˆ†é…ä¸€ä¸ªå¤§å†…å­˜æ®µå¹¶è®©æ“ ä½œç³»ç»Ÿå¤„ç†å®ƒã€‚ä¸‹é¢æ˜¯è¿™ç§æ–¹æ³•çš„ä¸€äº›é—®é¢˜ é¦–å…ˆï¼Œ32ä½ç³»ç»Ÿåªèƒ½æ”¯æŒ4Gå­—èŠ‚è™šæ‹Ÿå†…å­˜ï¼Œå¹¶ä¸”åº”ç”¨åªèƒ½ç”¨åˆ°å…¶ä¸­çš„3Gç©ºé—´ã€‚ç”±äºŽåŒæ—¶è¿è¡Œç™¾ä¸‡goroutinesçš„æƒ…å†µå¹¶ä¸å°‘è§ï¼Œå› æ­¤ä½ å¾ˆå¯ èƒ½ç”¨å…‰è™šæ‹Ÿå†…å­˜ï¼Œå³ä¾¿æˆ‘ä»¬å‡è®¾æ¯ä¸ªgoroutineçš„stackåªæœ‰8Kã€‚ ç¬¬äºŒï¼Œç„¶è€Œæˆ‘ä»¬å¯ä»¥åœ¨64ä½ç³»ç»Ÿä¸­åˆ†é…å¤§å†…å­˜ï¼Œå®ƒä¾èµ–äºŽè¿‡é‡å†…å­˜ä½¿ç”¨ã€‚æ‰€è°“è¿‡é‡ä½¿ç”¨æ˜¯æŒ‡å½“ä½ åˆ†é…çš„å†…å­˜å¤§å°è¶…å‡ºç‰©ç†å†…å­˜å¤§å°æ—¶ï¼Œä¾èµ–æ“ä½œç³»ç»Ÿä¿è¯ åœ¨éœ€è¦æ—¶èƒ½å¤Ÿåˆ†é…å‡ºç‰©ç†å†…å­˜ã€‚ç„¶è€Œï¼Œå…è®¸è¿‡é‡ä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä¸€äº›é£Žé™©ã€‚ç”±äºŽä¸€äº›è¿›ç¨‹åˆ†é…äº†è¶…å‡ºæœºå™¨ç‰©ç†å†…å­˜å¤§å°çš„å†…å­˜ï¼Œå¦‚æžœè¿™äº›è¿›ç¨‹ä½¿ç”¨æ›´å¤šå†…å­˜ æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°†ä¸å¾—ä¸ä¸ºå®ƒä»¬è¡¥å……åˆ†é…å†…å­˜ã€‚è¿™ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿå°†ä¸€äº›å†…å­˜æ®µæ”¾å…¥ç£ç›˜ç¼“å­˜ï¼Œè¿™å¸¸å¸¸ä¼šå¢žåŠ ä¸å¯é¢„æµ‹çš„å¤„ç†å»¶è¿Ÿã€‚æ­£æ˜¯è€ƒè™‘åˆ°è¿™ä¸ªåŽŸå› ï¼Œä¸€ äº›æ–°ç³»ç»Ÿå…³é—­äº†å¯¹è¿‡é‡ä½¿ç”¨çš„æ”¯æŒã€‚ 23. Goroutineå’ŒChannelçš„ä½œç”¨åˆ†åˆ«æ˜¯ä»€ä¹ˆ?è¿›ç¨‹æ˜¯å†…å­˜èµ„æºç®¡ç†å’Œcpuè°ƒåº¦çš„æ‰§è¡Œå•å…ƒã€‚ä¸ºäº†æœ‰æ•ˆåˆ©ç”¨å¤šæ ¸å¤„ç†å™¨çš„ä¼˜åŠ¿ï¼Œå°†è¿›ç¨‹è¿›ä¸€æ­¥ç»†åˆ†ï¼Œå…è®¸ä¸€ä¸ªè¿›ç¨‹é‡Œå­˜åœ¨å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å¤šä¸ªçº¿ç¨‹è¿˜æ˜¯å…±äº«åŒä¸€ç‰‡å†…å­˜ç©ºé—´ï¼Œä½†cpuè°ƒåº¦çš„æœ€å°å•å…ƒå˜æˆäº†çº¿ç¨‹ã€‚ é‚£åç¨‹åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Œä»¥åŠä¸Žçº¿ç¨‹çš„å·®å¼‚æ€§?? åç¨‹ï¼Œå¯ä»¥çœ‹ä½œæ˜¯è½»é‡çº§çš„çº¿ç¨‹ã€‚ä½†ä¸Žçº¿ç¨‹ä¸åŒçš„æ˜¯ï¼Œçº¿ç¨‹çš„åˆ‡æ¢æ˜¯ç”±æ“ä½œç³»ç»ŸæŽ§åˆ¶çš„ï¼Œè€Œåç¨‹çš„åˆ‡æ¢åˆ™æ˜¯ç”±ç”¨æˆ·æŽ§åˆ¶çš„ã€‚ æœ€æ—©æ”¯æŒåç¨‹çš„ç¨‹åºè¯­è¨€åº”è¯¥æ˜¯lispæ–¹è¨€schemeé‡Œçš„continuationï¼ˆç»­å»¶ï¼‰ï¼Œç»­å»¶å…è®¸schemeä¿å­˜ä»»æ„å‡½æ•°è°ƒç”¨çš„çŽ°åœºï¼Œä¿å­˜èµ·æ¥å¹¶é‡æ–°æ‰§è¡Œã€‚Lua,C#,pythonç­‰è¯­è¨€ä¹Ÿæœ‰è‡ªå·±çš„åç¨‹å®žçŽ°ã€‚ Goä¸­çš„goroutinueå°±æ˜¯åç¨‹,å¯ä»¥å®žçŽ°å¹¶è¡Œï¼Œå¤šä¸ªåç¨‹å¯ä»¥åœ¨å¤šä¸ªå¤„ç†å™¨åŒæ—¶è·‘ã€‚è€Œåç¨‹åŒä¸€æ—¶åˆ»åªèƒ½åœ¨ä¸€ä¸ªå¤„ç†å™¨ä¸Šè·‘ï¼ˆå¯ä»¥æŠŠå®¿ä¸»è¯­è¨€æƒ³è±¡æˆå•çº¿ç¨‹çš„å°±å¥½äº†ï¼‰ã€‚ ç„¶è€Œ,å¤šä¸ªgoroutineä¹‹é—´çš„é€šä¿¡æ˜¯é€šè¿‡channelï¼Œè€Œåç¨‹çš„é€šä¿¡æ˜¯é€šè¿‡yieldå’Œresume()æ“ä½œã€‚ goroutineéžå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨å‡½æ•°çš„è°ƒç”¨å‰é¢åŠ å…³é”®å­—goå³å¯ï¼Œä¾‹å¦‚: 1go elegance() æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯åŠ¨5ä¸ªgoroutinesåˆ†åˆ«æ‰“å°ç´¢å¼•ã€‚ 123456789func main() &#123; for i:=1;i&lt;5;i++ &#123; go func(i int) &#123; fmt.Println(i) &#125;(i) &#125; // åœæ­‡5sï¼Œä¿è¯æ‰“å°å…¨éƒ¨ç»“æŸ time.Sleep(5*time.Second)&#125; åœ¨åˆ†æžgoroutineæ‰§è¡Œçš„éšæœºæ€§å’Œå¹¶å‘æ€§ï¼Œå¯åŠ¨äº†5ä¸ªgoroutineï¼Œå†åŠ ä¸Šmainå‡½æ•°çš„ä¸»goroutineï¼Œæ€»å…±æœ‰6ä¸ªgoroutinesã€‚ç”±äºŽgoroutineç±»ä¼¼äºŽâ€å®ˆæŠ¤çº¿ç¨‹â€œï¼Œå¼‚æ­¥æ‰§è¡Œçš„,å¦‚æžœä¸»goroutineä¸ç­‰å¾…ç‰‡åˆ»ï¼Œå¯èƒ½ç¨‹åºå°±æ²¡æœ‰è¾“å‡ºæ‰“å°äº†ã€‚ åœ¨Golangä¸­channelåˆ™æ˜¯goroutinuesä¹‹é—´è¿›è¡Œé€šä¿¡çš„æ¸ é“ã€‚ å¯ä»¥æŠŠchannelå½¢è±¡æ¯”å–»ä¸ºå·¥åŽ‚é‡Œçš„ä¼ é€å¸¦,ä¸€å¤´çš„ç”Ÿäº§è€…goroutineå¾€ä¼ è¾“å¸¦æ”¾ä¸œè¥¿,å¦ä¸€å¤´çš„æ¶ˆè´¹è€…goroutinueåˆ™ä»Žè¾“é€å¸¦å–ä¸œè¥¿ã€‚channelå®žé™…ä¸Šæ˜¯ä¸€ä¸ªæœ‰ç±»åž‹çš„æ¶ˆæ¯é˜Ÿåˆ—,éµå¾ªå…ˆè¿›å…ˆå‡ºçš„ç‰¹ç‚¹ã€‚ channelçš„æ“ä½œç¬¦å· ch &lt;- data è¡¨ç¤ºdataè¢«å‘é€ç»™channel chï¼› data &lt;- ch è¡¨ç¤ºä»Žchannel chå–ä¸€ä¸ªå€¼ï¼Œç„¶åŽèµ‹ç»™dataã€‚ é˜»å¡žå¼channel channelé»˜è®¤æ˜¯æ²¡æœ‰ç¼“å†²åŒºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œé€šä¿¡æ˜¯é˜»å¡žçš„ã€‚sendæ“ä½œå¿…é¡»ç­‰åˆ°æœ‰æ¶ˆè´¹è€…acceptæ‰ç®—å®Œæˆã€‚ åº”ç”¨ç¤ºä¾‹: 1234567891011func main() &#123; ch1 := make(chan int) go pump(ch1) // pump hangs fmt.Println(&lt;-ch1) // prints only 1&#125;func pump(ch chan int) &#123; for i:= 1; ; i++ &#123; ch &lt;- i &#125;&#125; åœ¨å‡½æ•°pump()é‡Œçš„channelåœ¨æŽ¥å—åˆ°ç¬¬ä¸€ä¸ªå…ƒç´ åŽå°±è¢«é˜»å¡žäº†ï¼Œç›´åˆ°ä¸»goroutinueå–èµ°äº†æ•°æ®ã€‚æœ€ç»ˆchannelé˜»å¡žåœ¨æŽ¥å—ç¬¬äºŒä¸ªå…ƒç´ ï¼Œç¨‹åºåªæ‰“å° 1ã€‚ æ²¡æœ‰ç¼“å†²(buffer)çš„channelåªèƒ½å®¹çº³ä¸€ä¸ªå…ƒç´ ï¼Œè€Œå¸¦æœ‰ç¼“å†²(buffer)channelåˆ™å¯ä»¥éžé˜»å¡žå®¹çº³Nä¸ªå…ƒç´ ã€‚å‘é€æ•°æ®åˆ°ç¼“å†²(buffer) channelä¸ä¼šè¢«é˜»å¡žï¼Œé™¤éžchannelå·²æ»¡ï¼›åŒæ ·çš„ï¼Œä»Žç¼“å†²(buffer) channelå–æ•°æ®ä¹Ÿä¸ä¼šè¢«é˜»å¡žï¼Œé™¤éžchannelç©ºäº†ã€‚ 24. æ€Žä¹ˆæŸ¥çœ‹Goroutineçš„æ•°é‡?GOMAXPROCSä¸­æŽ§åˆ¶çš„æ˜¯æœªè¢«é˜»å¡žçš„æ‰€æœ‰Goroutine,å¯ä»¥è¢«Multiplexåˆ°å¤šå°‘ä¸ªçº¿ç¨‹ä¸Šè¿è¡Œ,é€šè¿‡GOMAXPROCSå¯ä»¥æŸ¥çœ‹Goroutineçš„æ•°é‡ã€‚ 25. è¯´ä¸‹Goä¸­çš„é”æœ‰å“ªäº›?ä¸‰ç§é”ï¼Œè¯»å†™é”ï¼Œäº’æ–¥é”ï¼Œè¿˜æœ‰mapçš„å®‰å…¨çš„é”?Goä¸­çš„ä¸‰ç§é”åŒ…æ‹¬:äº’æ–¥é”,è¯»å†™é”,sync.Mapçš„å®‰å…¨çš„é”. äº’æ–¥é” Goå¹¶å‘ç¨‹åºå¯¹å…±äº«èµ„æºè¿›è¡Œè®¿é—®æŽ§åˆ¶çš„ä¸»è¦æ‰‹æ®µï¼Œç”±æ ‡å‡†åº“ä»£ç åŒ…ä¸­syncä¸­çš„Mutexç»“æž„ä½“è¡¨ç¤ºã€‚ 12345//Mutex æ˜¯äº’æ–¥é”ï¼Œ é›¶å€¼æ˜¯è§£é”çš„äº’æ–¥é”ï¼Œ é¦–æ¬¡ä½¿ç”¨åŽä¸å¾—å¤åˆ¶äº’æ–¥é”ã€‚type Mutex struct &#123; state int32 sema uint32&#125; sync.MutexåŒ…ä¸­çš„ç±»åž‹åªæœ‰ä¸¤ä¸ªå…¬å¼€çš„æŒ‡é’ˆæ–¹æ³•Lockå’ŒUnlockã€‚ 12345678910111213141516//Lockerè¡¨ç¤ºå¯ä»¥é”å®šå’Œè§£é”çš„å¯¹è±¡ã€‚type Locker interface &#123; Lock() Unlock()&#125;//é”å®šå½“å‰çš„äº’æ–¥é‡//å¦‚æžœé”å·²è¢«ä½¿ç”¨ï¼Œåˆ™è°ƒç”¨goroutine//é˜»å¡žç›´åˆ°äº’æ–¥é”å¯ç”¨ã€‚func (m *Mutex) Lock() //å¯¹å½“å‰äº’æ–¥é‡è¿›è¡Œè§£é”//å¦‚æžœåœ¨è¿›å…¥è§£é”æ—¶æœªé”å®šmï¼Œåˆ™ä¸ºè¿è¡Œæ—¶é”™è¯¯ã€‚//é”å®šçš„äº’æ–¥é”ä¸Žç‰¹å®šçš„goroutineæ— å…³ã€‚//å…è®¸ä¸€ä¸ªgoroutineé”å®šMutexç„¶åŽå®‰æŽ’å¦ä¸€ä¸ªgoroutineæ¥è§£é”å®ƒã€‚func (m *Mutex) Unlock() å£°æ˜Žä¸€ä¸ªäº’æ–¥é”ï¼š 1var mutex sync.Mutex ä¸åƒCæˆ–Javaçš„é”ç±»å·¥å…·ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šçŠ¯ä¸€ä¸ªé”™è¯¯ï¼šå¿˜è®°åŠæ—¶è§£å¼€å·²è¢«é”ä½çš„é”ï¼Œä»Žè€Œå¯¼è‡´æµç¨‹å¼‚å¸¸ã€‚ä½†Goç”±äºŽå­˜åœ¨deferï¼Œæ‰€ä»¥æ­¤ç±»é—®é¢˜å‡ºçŽ°çš„æ¦‚çŽ‡æžä½Žã€‚å…³äºŽdeferè§£é”çš„æ–¹å¼å¦‚ä¸‹ï¼š 12345var mutex sync.Mutexfunc Write() &#123; mutex.Lock() defer mutex.Unlock()&#125; å¦‚æžœå¯¹ä¸€ä¸ªå·²ç»ä¸Šé”çš„å¯¹è±¡å†æ¬¡ä¸Šé”ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´è¯¥é”å®šæ“ä½œè¢«é˜»å¡žï¼Œç›´åˆ°è¯¥äº’æ–¥é”å›žåˆ°è¢«è§£é”çŠ¶æ€. 12345678910111213141516171819202122232425262728fpackage mainimport ( &quot;fmt&quot; &quot;sync&quot; &quot;time&quot;)func main() &#123; var mutex sync.Mutex fmt.Println(&quot;begin lock&quot;) mutex.Lock() fmt.Println(&quot;get locked&quot;) for i := 1; i &lt;= 3; i++ &#123; go func(i int) &#123; fmt.Println(&quot;begin lock &quot;, i) mutex.Lock() fmt.Println(&quot;get locked &quot;, i) &#125;(i) &#125; time.Sleep(time.Second) fmt.Println(&quot;Unlock the lock&quot;) mutex.Unlock() fmt.Println(&quot;get unlocked&quot;) time.Sleep(time.Second)&#125; æˆ‘ä»¬åœ¨forå¾ªçŽ¯ä¹‹å‰å¼€å§‹åŠ é”ï¼Œç„¶åŽåœ¨æ¯ä¸€æ¬¡å¾ªçŽ¯ä¸­åˆ›å»ºä¸€ä¸ªåç¨‹ï¼Œå¹¶å¯¹å…¶åŠ é”ï¼Œä½†æ˜¯ç”±äºŽä¹‹å‰å·²ç»åŠ é”äº†ï¼Œæ‰€ä»¥è¿™ä¸ªforå¾ªçŽ¯ä¸­çš„åŠ é”ä¼šé™·å…¥é˜»å¡žç›´åˆ°mainä¸­çš„é”è¢«è§£é”ï¼Œ time.Sleep(time.Second) æ˜¯ä¸ºäº†èƒ½è®©ç³»ç»Ÿæœ‰è¶³å¤Ÿçš„æ—¶é—´è¿è¡Œforå¾ªçŽ¯ï¼Œè¾“å‡ºç»“æžœå¦‚ä¸‹ï¼š 123456789&gt; go run mutex.go begin lockget lockedbegin lock 3begin lock 1begin lock 2Unlock the lockget unlockedget locked 3 è¿™é‡Œå¯ä»¥çœ‹åˆ°è§£é”åŽï¼Œä¸‰ä¸ªåç¨‹ä¼šé‡æ–°æŠ¢å¤ºäº’æ–¥é”æƒï¼Œæœ€ç»ˆåç¨‹3èŽ·èƒœã€‚ äº’æ–¥é”é”å®šæ“ä½œçš„é€†æ“ä½œå¹¶ä¸ä¼šå¯¼è‡´åç¨‹é˜»å¡žï¼Œä½†æ˜¯æœ‰å¯èƒ½å¯¼è‡´å¼•å‘ä¸€ä¸ªæ— æ³•æ¢å¤çš„è¿è¡Œæ—¶çš„panicï¼Œæ¯”å¦‚å¯¹ä¸€ä¸ªæœªé”å®šçš„äº’æ–¥é”è¿›è¡Œè§£é”æ—¶å°±ä¼šå‘ç”Ÿpanicã€‚é¿å…è¿™ç§æƒ…å†µçš„æœ€æœ‰æ•ˆæ–¹å¼å°±æ˜¯ä½¿ç”¨deferã€‚ æˆ‘ä»¬çŸ¥é“å¦‚æžœé‡åˆ°panicï¼Œå¯ä»¥ä½¿ç”¨recoveræ–¹æ³•è¿›è¡Œæ¢å¤ï¼Œä½†æ˜¯å¦‚æžœå¯¹é‡å¤è§£é”äº’æ–¥é”å¼•å‘çš„panicå´æ˜¯æ— ç”¨çš„ï¼ˆGo 1.8åŠä»¥åŽï¼‰ã€‚ 123456789101112131415161718192021222324package mainimport ( &quot;fmt&quot; &quot;sync&quot;)func main() &#123; defer func() &#123; fmt.Println(&quot;Try to recover the panic&quot;) if p := recover(); p != nil &#123; fmt.Println(&quot;recover the panic : &quot;, p) &#125; &#125;() var mutex sync.Mutex fmt.Println(&quot;begin lock&quot;) mutex.Lock() fmt.Println(&quot;get locked&quot;) fmt.Println(&quot;unlock lock&quot;) mutex.Unlock() fmt.Println(&quot;lock is unlocked&quot;) fmt.Println(&quot;unlock lock again&quot;) mutex.Unlock()&#125; è¿è¡Œ: 12345678910111213141516171819202122&gt; go run mutex.go begin lockget lockedunlock locklock is unlockedunlock lock againfatal error: sync: unlock of unlocked mutexgoroutine 1 [running]:runtime.throw(0x4bc1a8, 0x1e) /home/keke/soft/go/src/runtime/panic.go:617 +0x72 fp=0xc000084ea8 sp=0xc000084e78 pc=0x427ba2sync.throw(0x4bc1a8, 0x1e) /home/keke/soft/go/src/runtime/panic.go:603 +0x35 fp=0xc000084ec8 sp=0xc000084ea8 pc=0x427b25sync.(*Mutex).Unlock(0xc00001a0c8) /home/keke/soft/go/src/sync/mutex.go:184 +0xc1 fp=0xc000084ef0 sp=0xc000084ec8 pc=0x45f821main.main() /home/keke/go/Test/mutex.go:25 +0x25f fp=0xc000084f98 sp=0xc000084ef0 pc=0x486c1fruntime.main() /home/keke/soft/go/src/runtime/proc.go:200 +0x20c fp=0xc000084fe0 sp=0xc000084f98 pc=0x4294ecruntime.goexit() /home/keke/soft/go/src/runtime/asm_amd64.s:1337 +0x1 fp=0xc000084fe8 sp=0xc000084fe0 pc=0x450ad1exit status 2 è¿™é‡Œè¯•å›¾å¯¹é‡å¤è§£é”å¼•å‘çš„panicè¿›è¡Œrecoverï¼Œä½†æ˜¯æˆ‘ä»¬å‘çŽ°æ“ä½œå¤±è´¥ï¼Œè™½ç„¶äº’æ–¥é”å¯ä»¥è¢«å¤šä¸ªåç¨‹å…±äº«ï¼Œä½†è¿˜æ˜¯å»ºè®®å°†å¯¹åŒä¸€ä¸ªäº’æ–¥é”çš„åŠ é”è§£é”æ“ä½œæ”¾åœ¨åŒä¸€ä¸ªå±‚æ¬¡çš„ä»£ç ä¸­ã€‚ è¯»å†™é” è¯»å†™é”æ˜¯é’ˆå¯¹è¯»å†™æ“ä½œçš„äº’æ–¥é”ï¼Œå¯ä»¥åˆ†åˆ«é’ˆå¯¹è¯»æ“ä½œä¸Žå†™æ“ä½œè¿›è¡Œé”å®šå’Œè§£é”æ“ä½œ ã€‚ è¯»å†™é”çš„è®¿é—®æŽ§åˆ¶è§„åˆ™å¦‚ä¸‹ï¼š â‘  å¤šä¸ªå†™æ“ä½œä¹‹é—´æ˜¯äº’æ–¥çš„ â‘¡ å†™æ“ä½œä¸Žè¯»æ“ä½œä¹‹é—´ä¹Ÿæ˜¯äº’æ–¥çš„ â‘¢ å¤šä¸ªè¯»æ“ä½œä¹‹é—´ä¸æ˜¯äº’æ–¥çš„ åœ¨è¿™æ ·çš„æŽ§åˆ¶è§„åˆ™ä¸‹ï¼Œè¯»å†™é”å¯ä»¥å¤§å¤§é™ä½Žæ€§èƒ½æŸè€—ã€‚ åœ¨Goçš„æ ‡å‡†åº“ä»£ç åŒ…ä¸­syncä¸­çš„RWMutexç»“æž„ä½“è¡¨ç¤ºä¸º: 123456789101112// RWMutexæ˜¯ä¸€ä¸ªè¯»/å†™äº’æ–¥é”ï¼Œå¯ä»¥ç”±ä»»æ„æ•°é‡çš„è¯»æ“ä½œæˆ–å•ä¸ªå†™æ“ä½œæŒæœ‰ã€‚// RWMutexçš„é›¶å€¼æ˜¯æœªé”å®šçš„äº’æ–¥é”ã€‚//é¦–æ¬¡ä½¿ç”¨åŽï¼Œä¸å¾—å¤åˆ¶RWMutexã€‚//å¦‚æžœgoroutineæŒæœ‰RWMutexè¿›è¡Œè¯»å–è€Œå¦ä¸€ä¸ªgoroutineå¯èƒ½ä¼šè°ƒç”¨Lockï¼Œé‚£ä¹ˆåœ¨é‡Šæ”¾åˆå§‹è¯»é”ä¹‹å‰ï¼Œgoroutineä¸åº”è¯¥æœŸæœ›èƒ½å¤ŸèŽ·å–è¯»é”å®šã€‚ //ç‰¹åˆ«æ˜¯ï¼Œè¿™ç§ç¦æ­¢é€’å½’è¯»é”å®šã€‚ è¿™æ˜¯ä¸ºäº†ç¡®ä¿é”æœ€ç»ˆå˜å¾—å¯ç”¨; é˜»æ­¢çš„é”å®šä¼šé˜»æ­¢æ–°è¯»æ“ä½œèŽ·å–é”å®šã€‚type RWMutex struct &#123; w Mutex //å¦‚æžœæœ‰å¾…å¤„ç†çš„å†™æ“ä½œå°±æŒæœ‰ writerSem uint32 // å†™æ“ä½œç­‰å¾…è¯»æ“ä½œå®Œæˆçš„ä¿¡å·é‡ readerSem uint32 //è¯»æ“ä½œç­‰å¾…å†™æ“ä½œå®Œæˆçš„ä¿¡å·é‡ readerCount int32 // å¾…å¤„ç†çš„è¯»æ“ä½œæ•°é‡ readerWait int32 // number of departing readers&#125; syncä¸­çš„RWMutexæœ‰ä»¥ä¸‹å‡ ç§æ–¹æ³•ï¼š 1234567891011//å¯¹è¯»æ“ä½œçš„é”å®šfunc (rw *RWMutex) RLock()//å¯¹è¯»æ“ä½œçš„è§£é”func (rw *RWMutex) RUnlock()//å¯¹å†™æ“ä½œçš„é”å®šfunc (rw *RWMutex) Lock()//å¯¹å†™æ“ä½œçš„è§£é”func (rw *RWMutex) Unlock()//è¿”å›žä¸€ä¸ªå®žçŽ°äº†sync.LockeræŽ¥å£ç±»åž‹çš„å€¼ï¼Œå®žé™…ä¸Šæ˜¯å›žè°ƒrw.RLock and rw.RUnlock.func (rw *RWMutex) RLocker() Locker Unlockæ–¹æ³•ä¼šè¯•å›¾å”¤é†’æ‰€æœ‰æƒ³è¿›è¡Œè¯»é”å®šè€Œè¢«é˜»å¡žçš„åç¨‹ï¼Œè€Œ RUnlockæ–¹æ³•åªä¼šåœ¨å·²æ— ä»»ä½•è¯»é”å®šçš„æƒ…å†µä¸‹ï¼Œè¯•å›¾å”¤é†’ä¸€ä¸ªå› æ¬²è¿›è¡Œå†™é”å®šè€Œè¢«é˜»å¡žçš„åç¨‹ã€‚è‹¥å¯¹ä¸€ä¸ªæœªè¢«å†™é”å®šçš„è¯»å†™é”è¿›è¡Œå†™è§£é”ï¼Œå°±ä¼šå¼•å‘ä¸€ä¸ªä¸å¯æ¢å¤çš„panicï¼ŒåŒç†å¯¹ä¸€ä¸ªæœªè¢«è¯»é”å®šçš„è¯»å†™é”è¿›è¡Œè¯»å†™é”ä¹Ÿä¼šå¦‚æ­¤ã€‚ ç”±äºŽè¯»å†™é”æŽ§åˆ¶ä¸‹çš„å¤šä¸ªè¯»æ“ä½œä¹‹é—´ä¸æ˜¯äº’æ–¥çš„ï¼Œå› æ­¤å¯¹äºŽè¯»è§£é”æ›´å®¹æ˜“è¢«å¿½è§†ã€‚å¯¹äºŽåŒä¸€ä¸ªè¯»å†™é”ï¼Œæ·»åŠ å¤šå°‘ä¸ªè¯»é”å®šï¼Œå°±å¿…è¦æœ‰ç­‰é‡çš„è¯»è§£é”ï¼Œè¿™æ ·æ‰èƒ½å…¶ä»–åç¨‹æœ‰æœºä¼šè¿›è¡Œæ“ä½œã€‚ 1234567891011121314151617181920212223242526package mainimport ( &quot;fmt&quot; &quot;sync&quot; &quot;time&quot;)func main() &#123; var rwm sync.RWMutex for i := 0; i &lt; 5; i++ &#123; go func(i int) &#123; fmt.Println(&quot;try to lock read &quot;, i) rwm.RLock() fmt.Println(&quot;get locked &quot;, i) time.Sleep(time.Second * 2) fmt.Println(&quot;try to unlock for reading &quot;, i) rwm.RUnlock() fmt.Println(&quot;unlocked for reading &quot;, i) &#125;(i) &#125; time.Sleep(time.Millisecond * 1000) fmt.Println(&quot;try to lock for writing&quot;) rwm.Lock() fmt.Println(&quot;locked for writing&quot;)&#125; è¿è¡Œ: 1234567891011121314151617181920212223&gt; go run rwmutex.go try to lock read 0get locked 0try to lock read 4get locked 4try to lock read 3get locked 3try to lock read 1get locked 1try to lock read 2get locked 2try to lock for writingtry to unlock for reading 0unlocked for reading 0try to unlock for reading 2unlocked for reading 2try to unlock for reading 1unlocked for reading 1try to unlock for reading 3unlocked for reading 3try to unlock for reading 4unlocked for reading 4locked for writing è¿™é‡Œå¯ä»¥çœ‹åˆ°åˆ›å»ºäº†äº”ä¸ªåç¨‹ç”¨äºŽå¯¹è¯»å†™é”çš„è¯»é”å®šä¸Žè¯»è§£é”æ“ä½œã€‚åœ¨ rwm.Lock()ç§ä¼šå¯¹mainä¸­åç¨‹è¿›è¡Œå†™é”å®šï¼Œä½†æ˜¯forå¾ªçŽ¯ä¸­çš„è¯»è§£é”å°šæœªå®Œæˆï¼Œå› æ­¤ä¼šé€ æˆmianä¸­çš„åç¨‹é˜»å¡žã€‚å½“forå¾ªçŽ¯ä¸­çš„è¯»è§£é”æ“ä½œéƒ½å®ŒæˆåŽå°±ä¼šè¯•å›¾å”¤é†’mainä¸­é˜»å¡žçš„åç¨‹ï¼Œmainä¸­çš„å†™é”å®šæ‰ä¼šå®Œæˆã€‚ sync.Mapå®‰å…¨é” golangä¸­çš„sync.Mapæ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œå…¶å®žä¹Ÿå°±æ˜¯syncåŒ…ä¸­golangè‡ªå®šä¹‰çš„ä¸€ä¸ªåå«Mapçš„ç»“æž„ä½“ã€‚ åº”ç”¨ç¤ºä¾‹: 1234567891011121314151617181920212223242526272829303132package mainimport ( &quot;sync&quot; &quot;fmt&quot;)func main() &#123; //å¼€ç®±å³ç”¨ var sm sync.Map //store æ–¹æ³•,æ·»åŠ å…ƒç´  sm.Store(1,&quot;a&quot;) //Load æ–¹æ³•ï¼ŒèŽ·å¾—value if v,ok:=sm.Load(1);ok&#123; fmt.Println(v) &#125; //LoadOrStoreæ–¹æ³•ï¼ŒèŽ·å–æˆ–è€…ä¿å­˜ //å‚æ•°æ˜¯ä¸€å¯¹keyï¼švalueï¼Œå¦‚æžœè¯¥keyå­˜åœ¨ä¸”æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤åˆ™è¿”å›žåŽŸå…ˆçš„valueï¼ˆä¸æ›´æ–°ï¼‰å’Œtrueï¼›ä¸å­˜åœ¨åˆ™storeï¼Œè¿”å›žè¯¥value å’Œfalse if vv,ok:=sm.LoadOrStore(1,&quot;c&quot;);ok&#123; fmt.Println(vv) &#125; if vv,ok:=sm.LoadOrStore(2,&quot;c&quot;);!ok&#123; fmt.Println(vv) &#125; //éåŽ†è¯¥mapï¼Œå‚æ•°æ˜¯ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°å‚çš„ä¸¤ä¸ªå‚æ•°æ˜¯éåŽ†èŽ·å¾—çš„keyå’Œvalueï¼Œè¿”å›žä¸€ä¸ªboolå€¼ï¼Œå½“è¿”å›žfalseæ—¶ï¼ŒéåŽ†ç«‹åˆ»ç»“æŸã€‚ sm.Range(func(k,v interface&#123;&#125;)bool&#123; fmt.Print(k) fmt.Print(&quot;:&quot;) fmt.Print(v) fmt.Println() return true &#125;)&#125; è¿è¡Œ : 12345aac1:a2:c sync.Mapçš„æ•°æ®ç»“æž„: 12345678910 type Map struct &#123; // è¯¥é”ç”¨æ¥ä¿æŠ¤dirty mu Mutex // å­˜è¯»çš„æ•°æ®ï¼Œå› ä¸ºæ˜¯atomic.valueç±»åž‹ï¼Œåªè¯»ç±»åž‹ï¼Œæ‰€ä»¥å®ƒçš„è¯»æ˜¯å¹¶å‘å®‰å…¨çš„ read atomic.Value // readOnly //åŒ…å«æœ€æ–°çš„å†™å…¥çš„æ•°æ®ï¼Œå¹¶ä¸”åœ¨å†™çš„æ—¶å€™ï¼Œä¼šæŠŠread ä¸­æœªè¢«åˆ é™¤çš„æ•°æ®æ‹·è´åˆ°è¯¥dirtyä¸­ï¼Œå› ä¸ºæ˜¯æ™®é€šçš„mapå­˜åœ¨å¹¶å‘å®‰å…¨é—®é¢˜ï¼Œéœ€è¦ç”¨åˆ°ä¸Šé¢çš„muå­—æ®µã€‚ dirty map[interface&#123;&#125;]*entry // ä»Žreadè¯»æ•°æ®çš„æ—¶å€™ï¼Œä¼šå°†è¯¥å­—æ®µ+1ï¼Œå½“ç­‰äºŽlenï¼ˆdirtyï¼‰çš„æ—¶å€™ï¼Œä¼šå°†dirtyæ‹·è´åˆ°readä¸­ï¼ˆä»Žè€Œæå‡è¯»çš„æ€§èƒ½ï¼‰ã€‚ misses int&#125; readçš„æ•°æ®ç»“æž„æ˜¯ï¼š 12345type readOnly struct &#123; m map[interface&#123;&#125;]*entry // å¦‚æžœMap.dirtyçš„æ•°æ®å’Œm ä¸­çš„æ•°æ®ä¸ä¸€æ ·æ˜¯ä¸ºtrue amended bool &#125; entryçš„æ•°æ®ç»“æž„ï¼š 1234type entry struct &#123; //å¯è§valueæ˜¯ä¸ªæŒ‡é’ˆç±»åž‹ï¼Œè™½ç„¶readå’Œdirtyå­˜åœ¨å†—ä½™æƒ…å†µï¼ˆamended=falseï¼‰ï¼Œä½†æ˜¯ç”±äºŽæ˜¯æŒ‡é’ˆç±»åž‹ï¼Œå­˜å‚¨çš„ç©ºé—´åº”è¯¥ä¸æ˜¯é—®é¢˜ p unsafe.Pointer // *interface&#123;&#125;&#125; Delete æ–¹æ³•: 1234567891011121314151617181920212223242526272829303132func (m *Map) Delete(key interface&#123;&#125;) &#123; read, _ := m.read.Load().(readOnly) e, ok := read.m[key] //å¦‚æžœreadä¸­æ²¡æœ‰ï¼Œå¹¶ä¸”dirtyä¸­æœ‰æ–°å…ƒç´ ï¼Œé‚£ä¹ˆå°±åŽ»dirtyä¸­åŽ»æ‰¾ if !ok &amp;&amp; read.amended &#123; m.mu.Lock() //è¿™æ˜¯åŒæ£€æŸ¥ï¼ˆä¸Šé¢çš„ifåˆ¤æ–­å’Œé”ä¸æ˜¯ä¸€ä¸ªåŽŸå­æ€§æ“ä½œï¼‰ read, _ = m.read.Load().(readOnly) e, ok = read.m[key] if !ok &amp;&amp; read.amended &#123; //ç›´æŽ¥åˆ é™¤ delete(m.dirty, key) &#125; m.mu.Unlock() &#125; if ok &#123; //å¦‚æžœreadä¸­å­˜åœ¨è¯¥keyï¼Œåˆ™å°†è¯¥value èµ‹å€¼nilï¼ˆé‡‡ç”¨æ ‡è®°çš„æ–¹å¼åˆ é™¤ï¼ï¼‰ e.delete() &#125;&#125;func (e *entry) delete() (hadValue bool) &#123; for &#123; p := atomic.LoadPointer(&amp;e.p) if p == nil || p == expunged &#123; return false &#125; if atomic.CompareAndSwapPointer(&amp;e.p, p, nil) &#123; return true &#125; &#125;&#125; Store æ–¹æ³•: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788func (m *Map) Store(key, value interface&#123;&#125;) &#123; // å¦‚æžœm.readå­˜åœ¨è¿™ä¸ªkeyï¼Œå¹¶ä¸”æ²¡æœ‰è¢«æ ‡è®°åˆ é™¤ï¼Œåˆ™å°è¯•æ›´æ–°ã€‚ read, _ := m.read.Load().(readOnly) if e, ok := read.m[key]; ok &amp;&amp; e.tryStore(&amp;value) &#123; return &#125; // å¦‚æžœreadä¸å­˜åœ¨æˆ–è€…å·²ç»è¢«æ ‡è®°åˆ é™¤ m.mu.Lock() read, _ = m.read.Load().(readOnly) if e, ok := read.m[key]; ok &#123; //å¦‚æžœentryè¢«æ ‡è®°expungeï¼Œåˆ™è¡¨æ˜Ždirtyæ²¡æœ‰keyï¼Œå¯æ·»åŠ å…¥dirtyï¼Œå¹¶æ›´æ–°entry if e.unexpungeLocked() &#123; //åŠ å…¥dirtyä¸­ m.dirty[key] = e &#125; //æ›´æ–°valueå€¼ e.storeLocked(&amp;value) //dirty å­˜åœ¨è¯¥keyï¼Œæ›´æ–° &#125; else if e, ok := m.dirty[key]; ok &#123; e.storeLocked(&amp;value) //read å’Œdirtyéƒ½æ²¡æœ‰ï¼Œæ–°æ·»åŠ ä¸€æ¡ &#125; else &#123; //dirtyä¸­æ²¡æœ‰æ–°çš„æ•°æ®ï¼Œå¾€dirtyä¸­å¢žåŠ ç¬¬ä¸€ä¸ªæ–°é”® if !read.amended &#123; //å°†readä¸­æœªåˆ é™¤çš„æ•°æ®åŠ å…¥åˆ°dirtyä¸­ m.dirtyLocked() m.read.Store(readOnly&#123;m: read.m, amended: true&#125;) &#125; m.dirty[key] = newEntry(value) &#125; m.mu.Unlock()&#125;//å°†readä¸­æœªåˆ é™¤çš„æ•°æ®åŠ å…¥åˆ°dirtyä¸­func (m *Map) dirtyLocked() &#123; if m.dirty != nil &#123; return &#125; read, _ := m.read.Load().(readOnly) m.dirty = make(map[interface&#123;&#125;]*entry, len(read.m)) //readå¦‚æžœè¾ƒå¤§çš„è¯ï¼Œå¯èƒ½å½±å“æ€§èƒ½ for k, e := range read.m &#123; //é€šè¿‡æ­¤æ¬¡æ“ä½œï¼Œdirtyä¸­çš„å…ƒç´ éƒ½æ˜¯æœªè¢«åˆ é™¤çš„ï¼Œå¯è§expungeçš„å…ƒç´ ä¸åœ¨dirtyä¸­ if !e.tryExpungeLocked() &#123; m.dirty[k] = e &#125; &#125;&#125;//åˆ¤æ–­entryæ˜¯å¦è¢«æ ‡è®°åˆ é™¤ï¼Œå¹¶ä¸”å°†æ ‡è®°ä¸ºnilçš„entryæ›´æ–°æ ‡è®°ä¸ºexpungefunc (e *entry) tryExpungeLocked() (isExpunged bool) &#123; p := atomic.LoadPointer(&amp;e.p) for p == nil &#123; // å°†å·²ç»åˆ é™¤æ ‡è®°ä¸ºnilçš„æ•°æ®æ ‡è®°ä¸ºexpunged if atomic.CompareAndSwapPointer(&amp;e.p, nil, expunged) &#123; return true &#125; p = atomic.LoadPointer(&amp;e.p) &#125; return p == expunged&#125;//å¯¹entry å°è¯•æ›´æ–°func (e *entry) tryStore(i *interface&#123;&#125;) bool &#123; p := atomic.LoadPointer(&amp;e.p) if p == expunged &#123; return false &#125; for &#123; if atomic.CompareAndSwapPointer(&amp;e.p, p, unsafe.Pointer(i)) &#123; return true &#125; p = atomic.LoadPointer(&amp;e.p) if p == expunged &#123; return false &#125; &#125;&#125;//readé‡Œ å°†æ ‡è®°ä¸ºexpungeçš„æ›´æ–°ä¸ºnilfunc (e *entry) unexpungeLocked() (wasExpunged bool) &#123; return atomic.CompareAndSwapPointer(&amp;e.p, expunged, nil)&#125;//æ›´æ–°entryfunc (e *entry) storeLocked(i *interface&#123;&#125;) &#123; atomic.StorePointer(&amp;e.p, unsafe.Pointer(i))&#125; å› æ­¤ï¼Œæ¯æ¬¡æ“ä½œå…ˆæ£€æŸ¥readï¼Œå› ä¸ºread å¹¶å‘å®‰å…¨ï¼Œæ€§èƒ½å¥½äº›ï¼›readä¸æ»¡è¶³ï¼Œåˆ™åŠ é”æ£€æŸ¥dirtyï¼Œä¸€æ—¦æ˜¯æ–°çš„é”®å€¼ï¼Œdirtyä¼šè¢«readæ›´æ–°ã€‚ Loadæ–¹æ³•: Loadæ–¹æ³•æ˜¯ä¸€ä¸ªåŠ è½½æ–¹æ³•ï¼ŒæŸ¥æ‰¾keyã€‚ 1234567891011121314151617181920212223242526272829303132333435func (m *Map) Load(key interface&#123;&#125;) (value interface&#123;&#125;, ok bool) &#123; //å› readåªè¯»ï¼Œçº¿ç¨‹å®‰å…¨ï¼Œå…ˆæŸ¥çœ‹æ˜¯å¦æ»¡è¶³æ¡ä»¶ read, _ := m.read.Load().(readOnly) e, ok := read.m[key] //å¦‚æžœreadæ²¡æœ‰ï¼Œå¹¶ä¸”dirtyæœ‰æ–°æ•°æ®ï¼Œé‚£ä»Ždirtyä¸­æŸ¥æ‰¾ï¼Œç”±äºŽdirtyæ˜¯æ™®é€šmapï¼Œçº¿ç¨‹ä¸å®‰å…¨ï¼Œè¿™ä¸ªæ—¶å€™ç”¨åˆ°äº’æ–¥é”äº† if !ok &amp;&amp; read.amended &#123; m.mu.Lock() // åŒé‡æ£€æŸ¥ read, _ = m.read.Load().(readOnly) e, ok = read.m[key] // å¦‚æžœreadä¸­è¿˜æ˜¯ä¸å­˜åœ¨ï¼Œå¹¶ä¸”dirtyä¸­æœ‰æ–°æ•°æ® if !ok &amp;&amp; read.amended &#123; e, ok = m.dirty[key] // mssLockedï¼ˆï¼‰å‡½æ•°æ˜¯æ€§èƒ½æ˜¯sync.Map æ€§èƒ½å¾—ä»¥ä¿è¯çš„é‡è¦å‡½æ•°ï¼Œç›®çš„è®²æœ‰é”çš„dirtyæ•°æ®ï¼Œæ›¿æ¢åˆ°åªè¯»çº¿ç¨‹å®‰å…¨çš„readé‡Œ m.missLocked() &#125; m.mu.Unlock() &#125; if !ok &#123; return nil, false &#125; return e.load()&#125;//dirty æå‡è‡³read å…³é”®å‡½æ•°ï¼Œå½“misses ç»è¿‡å¤šæ¬¡å› ä¸ºloadä¹‹åŽï¼Œå¤§å°ç­‰äºŽlenï¼ˆdirtyï¼‰æ—¶å€™ï¼Œè®²dirtyæ›¿æ¢åˆ°readé‡Œï¼Œä»¥æ­¤è¾¾åˆ°æ€§èƒ½æå‡ã€‚func (m *Map) missLocked() &#123; m.misses++ if m.misses &lt; len(m.dirty) &#123; return &#125; //åŽŸå­æ“ä½œï¼Œè€—æ—¶å¾ˆå° m.read.Store(readOnly&#123;m: m.dirty&#125;) m.dirty = nil m.misses = 0&#125; sync.Mapæ˜¯é€šè¿‡å†—ä½™çš„ä¸¤ä¸ªæ•°æ®ç»“æž„(readã€dirty),å®žçŽ°æ€§èƒ½çš„æå‡ã€‚ä¸ºäº†æå‡æ€§èƒ½ï¼Œloadã€deleteã€storeç­‰æ“ä½œå°½é‡ä½¿ç”¨åªè¯»çš„readï¼›ä¸ºäº†æé«˜readçš„keyå‡»ä¸­æ¦‚çŽ‡ï¼Œé‡‡ç”¨åŠ¨æ€è°ƒæ•´ï¼Œå°†dirtyæ•°æ®æå‡ä¸ºreadï¼›å¯¹äºŽæ•°æ®çš„åˆ é™¤ï¼Œé‡‡ç”¨å»¶è¿Ÿæ ‡è®°åˆ é™¤æ³•ï¼Œåªæœ‰åœ¨æå‡dirtyçš„æ—¶å€™æ‰åˆ é™¤ã€‚ 26. è¯»å†™é”æˆ–è€…äº’æ–¥é”è¯»çš„æ—¶å€™èƒ½å†™å—?Goä¸­è¯»å†™é”åŒ…æ‹¬è¯»é”å’Œå†™é”ï¼Œå¤šä¸ªè¯»çº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®å…±äº«æ•°æ®ï¼›å†™çº¿ç¨‹å¿…é¡»ç­‰å¾…æ‰€æœ‰è¯»çº¿ç¨‹éƒ½é‡Šæ”¾é”ä»¥åŽï¼Œæ‰èƒ½å–å¾—é”ï¼›åŒæ ·çš„ï¼Œè¯»çº¿ç¨‹å¿…é¡»ç­‰å¾…å†™çº¿ç¨‹é‡Šæ”¾é”åŽï¼Œæ‰èƒ½å–å¾—é”ï¼Œä¹Ÿå°±æ˜¯è¯´è¯»å†™é”è¦ç¡®ä¿çš„æ˜¯å¦‚ä¸‹äº’æ–¥å…³ç³»ï¼Œå¯ä»¥åŒæ—¶è¯»ï¼Œä½†æ˜¯è¯»-å†™ï¼Œå†™-å†™éƒ½æ˜¯äº’æ–¥çš„ã€‚ 27. æ€Žä¹ˆé™åˆ¶Goroutineçš„æ•°é‡.åœ¨Golangä¸­ï¼ŒGoroutineè™½ç„¶å¾ˆå¥½ï¼Œä½†æ˜¯æ•°é‡å¤ªå¤šäº†ï¼Œå¾€å¾€ä¼šå¸¦æ¥å¾ˆå¤šéº»çƒ¦ï¼Œæ¯”å¦‚è€—å°½ç³»ç»Ÿèµ„æºå¯¼è‡´ç¨‹åºå´©æºƒï¼Œæˆ–è€…CPUä½¿ç”¨çŽ‡è¿‡é«˜å¯¼è‡´ç³»ç»Ÿå¿™ä¸è¿‡æ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é™åˆ¶ä¸‹Goroutineçš„æ•°é‡,è¿™æ ·å°±éœ€è¦åœ¨æ¯ä¸€æ¬¡æ‰§è¡Œgoä¹‹å‰åˆ¤æ–­goroutineçš„æ•°é‡ï¼Œå¦‚æžœæ•°é‡è¶…äº†ï¼Œå°±è¦é˜»å¡žgoçš„æ‰§è¡Œã€‚ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„å°±æ˜¯ä½¿ç”¨é€šé“ã€‚æ¯æ¬¡æ‰§è¡Œçš„goä¹‹å‰å‘é€šé“å†™å…¥å€¼ï¼Œç›´åˆ°é€šé“æ»¡çš„æ—¶å€™å°±é˜»å¡žäº†ï¼Œ 123456789101112131415161718192021package mainimport &quot;fmt&quot;var ch chan intfunc elegance()&#123; &lt;-ch fmt.Println(&quot;the ch value receive&quot;,ch)&#125;func main()&#123; ch = make(chan int,5) for i:=0;i&lt;10;i++&#123; ch &lt;-1 fmt.Println(&quot;the ch value send&quot;,ch) go elegance() fmt.Println(&quot;the result i&quot;,i) &#125;&#125; è¿è¡Œ: 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768&gt; go run goroutine.go the ch value send 0xc00009c000the result i 0the ch value send 0xc00009c000the result i 1the ch value send 0xc00009c000the result i 2the ch value send 0xc00009c000the result i 3the ch value send 0xc00009c000the result i 4the ch value send 0xc00009c000the result i 5the ch value send 0xc00009c000the ch value receive 0xc00009c000the result i 6the ch value receive 0xc00009c000the ch value send 0xc00009c000the result i 7the ch value send 0xc00009c000the result i 8the ch value send 0xc00009c000the result i 9the ch value send 0xc00009c000the ch value receive 0xc00009c000the ch value receive 0xc00009c000the ch value receive 0xc00009c000the result i 10the ch value send 0xc00009c000the result i 11the ch value send 0xc00009c000the result i 12the ch value send 0xc00009c000the result i 13the ch value send 0xc00009c000the ch value receive 0xc00009c000the ch value receive 0xc00009c000the ch value receive 0xc00009c000the ch value receive 0xc00009c000the result i 14the ch value receive 0xc00009c000&gt; go run goroutine.go the ch value send 0xc00007e000the result i 0the ch value send 0xc00007e000the result i 1the ch value send 0xc00007e000the result i 2the ch value send 0xc00007e000the result i 3the ch value send 0xc00007e000the ch value receive 0xc00007e000the result i 4the ch value send 0xc00007e000the ch value receive 0xc00007e000the result i 5the ch value send 0xc00007e000the ch value receive 0xc00007e000the result i 6the ch value send 0xc00007e000the result i 7the ch value send 0xc00007e000the ch value receive 0xc00007e000the ch value receive 0xc00007e000the ch value receive 0xc00007e000the result i 8the ch value send 0xc00007e000the result i 9 è¿™æ ·æ¯æ¬¡åŒæ—¶è¿è¡Œçš„goroutineå°±è¢«é™åˆ¶ä¸º5ä¸ªäº†ã€‚ä½†æ˜¯æ–°çš„é—®é¢˜äºŽæ˜¯å°±å‡ºçŽ°äº†ï¼Œå› ä¸ºå¹¶ä¸æ˜¯æ‰€æœ‰çš„goroutineéƒ½æ‰§è¡Œå®Œäº†ï¼Œåœ¨mainå‡½æ•°é€€å‡ºä¹‹åŽï¼Œè¿˜æœ‰ä¸€äº›goroutineæ²¡æœ‰æ‰§è¡Œå®Œå°±è¢«å¼ºåˆ¶ç»“æŸäº†ã€‚è¿™ä¸ªæ—¶å€™æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°sync.WaitGroupã€‚ä½¿ç”¨WaitGroupç­‰å¾…æ‰€æœ‰çš„goroutineé€€å‡ºã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960package mainimport ( &quot;fmt&quot; &quot;runtime&quot; &quot;sync&quot; &quot;time&quot;)// Pool Goroutine Pooltype Pool struct &#123; queue chan int wg *sync.WaitGroup&#125;// New æ–°å»ºä¸€ä¸ªåç¨‹æ± func NewPool(size int) *Pool&#123; if size &lt;=0&#123; size = 1 &#125; return &amp;Pool&#123; queue:make(chan int,size), wg:&amp;sync.WaitGroup&#123;&#125;, &#125;&#125;// Add æ–°å¢žä¸€ä¸ªæ‰§è¡Œfunc (p *Pool)Add(delta int)&#123; // deltaä¸ºæ­£æ•°å°±æ·»åŠ  for i :=0;i&lt;delta;i++&#123; p.queue &lt;-1 &#125; // deltaä¸ºè´Ÿæ•°å°±å‡å°‘ for i:=0;i&gt;delta;i--&#123; &lt;-p.queue &#125; p.wg.Add(delta)&#125;// Done æ‰§è¡Œå®Œæˆå‡ä¸€func (p *Pool) Done()&#123; &lt;-p.queue p.wg.Done()&#125;// Wait ç­‰å¾…Goroutineæ‰§è¡Œå®Œæ¯•func (p *Pool) Wait()&#123; p.wg.Wait()&#125;func main()&#123; // è¿™é‡Œé™åˆ¶5ä¸ªå¹¶å‘ pool := NewPool(5) fmt.Println(&quot;the NumGoroutine begin is:&quot;,runtime.NumGoroutine()) for i:=0;i&lt;20;i++&#123; pool.Add(1) go func(i int) &#123; time.Sleep(time.Second) fmt.Println(&quot;the NumGoroutine continue is:&quot;,runtime.NumGoroutine()) pool.Done() &#125;(i) &#125; pool.Wait() fmt.Println(&quot;the NumGoroutine done is:&quot;,runtime.NumGoroutine())&#125; è¿è¡Œ: 12345678910111213141516171819202122the NumGoroutine begin is: 1the NumGoroutine continue is: 6the NumGoroutine continue is: 7the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 6the NumGoroutine continue is: 3the NumGoroutine continue is: 2the NumGoroutine done is: 1 å…¶ä¸­ï¼ŒGoçš„GOMAXPROCSé»˜è®¤å€¼å·²ç»è®¾ç½®ä¸ºCPUçš„æ ¸æ•°ï¼Œ è¿™é‡Œå…è®¸æˆ‘ä»¬çš„Goç¨‹åºå……åˆ†ä½¿ç”¨æœºå™¨çš„æ¯ä¸€ä¸ªCPU,æœ€å¤§ç¨‹åº¦çš„æé«˜æˆ‘ä»¬ç¨‹åºçš„å¹¶å‘æ€§èƒ½ã€‚runtime.NumGoroutineå‡½æ•°åœ¨è¢«è°ƒç”¨åŽï¼Œä¼šè¿”å›žç³»ç»Ÿä¸­çš„å¤„äºŽç‰¹å®šçŠ¶æ€çš„Goroutineçš„æ•°é‡ã€‚è¿™é‡Œçš„ç‰¹æŒ‡æ˜¯æŒ‡Grunnable\Gruning\Gsyscall\Gwaitionã€‚å¤„äºŽè¿™äº›çŠ¶æ€çš„Groutineå³è¢«çœ‹åšæ˜¯æ´»è·ƒçš„æˆ–è€…è¯´æ­£åœ¨è¢«è°ƒåº¦ã€‚ è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ï¼šåžƒåœ¾å›žæ”¶æ‰€åœ¨Groutineçš„çŠ¶æ€ä¹Ÿå¤„äºŽè¿™ä¸ªèŒƒå›´å†…çš„è¯ï¼Œä¹Ÿä¼šè¢«çº³å…¥è¯¥è®¡æ•°å™¨ã€‚ 28. Channelæ˜¯åŒæ­¥çš„è¿˜æ˜¯å¼‚æ­¥çš„.Channelæ˜¯å¼‚æ­¥è¿›è¡Œçš„ã€‚ channelå­˜åœ¨3ç§çŠ¶æ€ï¼š nilï¼Œæœªåˆå§‹åŒ–çš„çŠ¶æ€ï¼Œåªè¿›è¡Œäº†å£°æ˜Žï¼Œæˆ–è€…æ‰‹åŠ¨èµ‹å€¼ä¸ºnil activeï¼Œæ­£å¸¸çš„channelï¼Œå¯è¯»æˆ–è€…å¯å†™ closedï¼Œå·²å…³é—­ï¼Œåƒä¸‡ä¸è¦è¯¯è®¤ä¸ºå…³é—­channelåŽï¼Œchannelçš„å€¼æ˜¯nil 29. è¯´ä¸€ä¸‹å¼‚æ­¥å’Œéžé˜»å¡žçš„åŒºåˆ«? å¼‚æ­¥å’Œéžé˜»å¡žçš„åŒºåˆ«: å¼‚æ­¥ï¼šè°ƒç”¨åœ¨å‘å‡ºä¹‹åŽï¼Œè¿™ä¸ªè°ƒç”¨å°±ç›´æŽ¥è¿”å›žï¼Œä¸ç®¡æœ‰æ— ç»“æžœï¼›å¼‚æ­¥æ˜¯è¿‡ç¨‹ã€‚ éžé˜»å¡žï¼šå…³æ³¨çš„æ˜¯ç¨‹åºåœ¨ç­‰å¾…è°ƒç”¨ç»“æžœï¼ˆæ¶ˆæ¯ï¼Œè¿”å›žå€¼ï¼‰æ—¶çš„çŠ¶æ€ï¼ŒæŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æžœä¹‹å‰ï¼Œè¯¥è°ƒç”¨ä¸ä¼šé˜»å¡žå½“å‰çº¿ç¨‹ã€‚ åŒæ­¥å’Œå¼‚æ­¥çš„åŒºåˆ«ï¼š æ­¥ï¼šä¸€ä¸ªæœåŠ¡çš„å®Œæˆéœ€è¦ä¾èµ–å…¶ä»–æœåŠ¡æ—¶ï¼Œåªæœ‰ç­‰å¾…è¢«ä¾èµ–çš„æœåŠ¡å®ŒæˆåŽï¼Œæ‰ç®—å®Œæˆï¼Œè¿™æ˜¯ä¸€ç§å¯é çš„æœåŠ¡åºåˆ—ã€‚è¦ä¹ˆæˆåŠŸéƒ½æˆåŠŸï¼Œå¤±è´¥éƒ½å¤±è´¥ï¼ŒæœåŠ¡çš„çŠ¶æ€å¯ä»¥ä¿æŒä¸€è‡´ã€‚ å¼‚æ­¥ï¼šä¸€ä¸ªæœåŠ¡çš„å®Œæˆéœ€è¦ä¾èµ–å…¶ä»–æœåŠ¡æ—¶ï¼Œåªé€šçŸ¥å…¶ä»–ä¾èµ–æœåŠ¡å¼€å§‹æ‰§è¡Œï¼Œè€Œä¸éœ€è¦ç­‰å¾…è¢«ä¾èµ–çš„æœåŠ¡å®Œæˆï¼Œæ­¤æ—¶è¯¥æœåŠ¡å°±ç®—å®Œæˆäº†ã€‚è¢«ä¾èµ–çš„æœåŠ¡æ˜¯å¦æœ€ç»ˆå®Œæˆæ— æ³•ç¡®å®šï¼Œä¸€æ¬¡å®ƒæ˜¯ä¸€ä¸ªä¸å¯é çš„æœåŠ¡åºåˆ—ã€‚ æ¶ˆæ¯é€šçŸ¥ä¸­çš„åŒæ­¥å’Œå¼‚æ­¥ï¼š åŒæ­¥ï¼šå½“ä¸€ä¸ªåŒæ­¥è°ƒç”¨å‘å‡ºåŽï¼Œè°ƒç”¨è€…è¦ä¸€ç›´ç­‰å¾…è¿”å›žæ¶ˆæ¯ï¼ˆæˆ–è€…è°ƒç”¨ç»“æžœï¼‰é€šçŸ¥åŽï¼Œæ‰èƒ½è¿›è¡ŒåŽç»­çš„æ‰§è¡Œã€‚ å¼‚æ­¥ï¼šå½“ä¸€ä¸ªå¼‚æ­¥è¿‡ç¨‹è°ƒç”¨å‘å‡ºåŽï¼Œè°ƒç”¨è€…ä¸èƒ½ç«‹åˆ»å¾—åˆ°è¿”å›žæ¶ˆæ¯ï¼ˆç»“æžœï¼‰ã€‚åœ¨è°ƒç”¨ç»“æŸä¹‹åŽï¼Œé€šè¿‡æ¶ˆæ¯å›žè°ƒæ¥é€šçŸ¥è°ƒç”¨è€…æ˜¯å¦è°ƒç”¨æˆåŠŸã€‚ é˜»å¡žä¸Žéžé˜»å¡žçš„åŒºåˆ«ï¼š é˜»å¡žï¼šé˜»å¡žè°ƒç”¨æ˜¯æŒ‡è°ƒç”¨ç»“æžœè¿”å›žä¹‹å‰ï¼Œå½“å‰çº¿ç¨‹ä¼šè¢«æŒ‚èµ·ï¼Œä¸€ç›´å¤„äºŽç­‰å¾…æ¶ˆæ¯é€šçŸ¥ï¼Œä¸èƒ½å¤Ÿæ‰§è¡Œå…¶ä»–ä¸šåŠ¡,å‡½æ•°åªæœ‰åœ¨å¾—åˆ°ç»“æžœä¹‹åŽæ‰ä¼šè¿”å›žã€‚ éžé˜»å¡žï¼šéžé˜»å¡žå’Œé˜»å¡žçš„æ¦‚å¿µç›¸å¯¹åº”ï¼ŒæŒ‡åœ¨ä¸èƒ½ç«‹åˆ»å¾—åˆ°ç»“æžœä¹‹å‰ï¼Œè¯¥å‡½æ•°ä¸ä¼šé˜»å¡žå½“å‰çº¿ç¨‹ï¼Œè€Œä¼šç«‹åˆ»è¿”å›žã€‚ åŒæ­¥ä¸Žå¼‚æ­¥æ˜¯å¯¹åº”çš„ï¼Œå®ƒä»¬æ˜¯çº¿ç¨‹ä¹‹é—´çš„å…³ç³»ï¼Œä¸¤ä¸ªçº¿ç¨‹ä¹‹é—´è¦ä¹ˆæ˜¯åŒæ­¥çš„ï¼Œè¦ä¹ˆæ˜¯å¼‚æ­¥çš„ã€‚ é˜»å¡žä¸Žéžé˜»å¡žæ˜¯å¯¹åŒä¸€ä¸ªçº¿ç¨‹æ¥è¯´çš„ï¼Œåœ¨æŸä¸ªæ—¶åˆ»ï¼Œçº¿ç¨‹è¦ä¹ˆå¤„äºŽé˜»å¡žï¼Œè¦ä¹ˆå¤„äºŽéžé˜»å¡žã€‚ é˜»å¡žæ˜¯ä½¿ç”¨åŒæ­¥æœºåˆ¶çš„ç»“æžœï¼Œéžé˜»å¡žåˆ™æ˜¯ä½¿ç”¨å¼‚æ­¥æœºåˆ¶çš„ç»“æžœã€‚ 30. LogåŒ…çº¿ç¨‹å®‰å…¨å—ï¼ŸGolangçš„æ ‡å‡†åº“æä¾›äº†logçš„æœºåˆ¶ï¼Œä½†æ˜¯è¯¥æ¨¡å—çš„åŠŸèƒ½è¾ƒä¸ºç®€å•ï¼ˆçœ‹ä¼¼ç®€å•ï¼Œå…¶å®žä»–æœ‰ä»–çš„è®¾è®¡æ€è·¯ï¼‰ã€‚åœ¨è¾“å‡ºçš„ä½ç½®åšäº†çº¿ç¨‹å®‰å…¨çš„ä¿æŠ¤ã€‚ 31. Goroutineå’Œçº¿ç¨‹çš„åŒºåˆ«?ä»Žè°ƒåº¦ä¸Šçœ‹ï¼Œgoroutineçš„è°ƒåº¦å¼€é”€è¿œè¿œå°äºŽçº¿ç¨‹è°ƒåº¦å¼€é”€ã€‚ OSçš„çº¿ç¨‹ç”±OSå†…æ ¸è°ƒåº¦ï¼Œæ¯éš”å‡ æ¯«ç§’ï¼Œä¸€ä¸ªç¡¬ä»¶æ—¶é’Ÿä¸­æ–­å‘åˆ°CPUï¼ŒCPUè°ƒç”¨ä¸€ä¸ªè°ƒåº¦å™¨å†…æ ¸å‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°æš‚åœå½“å‰æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼ŒæŠŠä»–çš„å¯„å­˜å™¨ä¿¡æ¯ä¿å­˜åˆ°å†…å­˜ä¸­ï¼ŒæŸ¥çœ‹çº¿ç¨‹åˆ—è¡¨å¹¶å†³å®šæŽ¥ä¸‹æ¥è¿è¡Œå“ªä¸€ä¸ªçº¿ç¨‹ï¼Œå†ä»Žå†…å­˜ä¸­æ¢å¤çº¿ç¨‹çš„æ³¨å†Œè¡¨ä¿¡æ¯ï¼Œæœ€åŽç»§ç»­æ‰§è¡Œé€‰ä¸­çš„çº¿ç¨‹ã€‚è¿™ç§çº¿ç¨‹åˆ‡æ¢éœ€è¦ä¸€ä¸ªå®Œæ•´çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå³ä¿å­˜ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€åˆ°å†…å­˜ï¼Œå†æ¢å¤å¦å¤–ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œæœ€åŽæ›´æ–°è°ƒåº¦å™¨çš„æ•°æ®ç»“æž„ã€‚æŸç§æ„ä¹‰ä¸Šï¼Œè¿™ç§æ“ä½œè¿˜æ˜¯å¾ˆæ…¢çš„ã€‚ Goè¿è¡Œçš„æ—¶å€™åŒ…æ¶µä¸€ä¸ªè‡ªå·±çš„è°ƒåº¦å™¨ï¼Œè¿™ä¸ªè°ƒåº¦å™¨ä½¿ç”¨ä¸€ä¸ªç§°ä¸ºä¸€ä¸ªM:Nè°ƒåº¦æŠ€æœ¯ï¼Œmä¸ªgoroutineåˆ°nä¸ªosçº¿ç¨‹ï¼ˆå¯ä»¥ç”¨GOMAXPROCSæ¥æŽ§åˆ¶nçš„æ•°é‡ï¼‰ï¼ŒGoçš„è°ƒåº¦å™¨ä¸æ˜¯ç”±ç¡¬ä»¶æ—¶é’Ÿæ¥å®šæœŸè§¦å‘çš„ï¼Œè€Œæ˜¯ç”±ç‰¹å®šçš„goè¯­è¨€ç»“æž„æ¥è§¦å‘çš„ï¼Œä»–ä¸éœ€è¦åˆ‡æ¢åˆ°å†…æ ¸è¯­å¢ƒï¼Œæ‰€ä»¥è°ƒåº¦ä¸€ä¸ªgoroutineæ¯”è°ƒåº¦ä¸€ä¸ªçº¿ç¨‹çš„æˆæœ¬ä½Žå¾ˆå¤šã€‚ ä»Žæ ˆç©ºé—´ä¸Šï¼Œgoroutineçš„æ ˆç©ºé—´æ›´åŠ åŠ¨æ€çµæ´»ã€‚ æ¯ä¸ªOSçš„çº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªå›ºå®šå¤§å°çš„æ ˆå†…å­˜ï¼Œé€šå¸¸æ˜¯2MBï¼Œæ ˆå†…å­˜ç”¨äºŽä¿å­˜åœ¨å…¶ä»–å‡½æ•°è°ƒç”¨æœŸé—´å“ªäº›æ­£åœ¨æ‰§è¡Œæˆ–è€…ä¸´æ—¶æš‚åœçš„å‡½æ•°çš„å±€éƒ¨å˜é‡ã€‚è¿™ä¸ªå›ºå®šçš„æ ˆå¤§å°ï¼Œå¦‚æžœå¯¹äºŽgoroutineæ¥è¯´ï¼Œå¯èƒ½æ˜¯ä¸€ç§å·¨å¤§çš„æµªè´¹ã€‚ä½œä¸ºå¯¹æ¯”goroutineåœ¨ç”Ÿå‘½å‘¨æœŸå¼€å§‹åªæœ‰ä¸€ä¸ªå¾ˆå°çš„æ ˆï¼Œå…¸åž‹æƒ…å†µæ˜¯2KB, åœ¨goç¨‹åºä¸­ï¼Œä¸€æ¬¡åˆ›å»ºåä¸‡å·¦å³çš„goroutineä¹Ÿä¸ç½•è§ï¼ˆ2KB*100,000=200MBï¼‰ã€‚è€Œä¸”goroutineçš„æ ˆä¸æ˜¯å›ºå®šå¤§å°ï¼Œå®ƒå¯ä»¥æŒ‰éœ€å¢žå¤§å’Œç¼©å°ï¼Œæœ€å¤§é™åˆ¶å¯ä»¥åˆ°1GBã€‚ goroutineæ²¡æœ‰ä¸€ä¸ªç‰¹å®šçš„æ ‡è¯†ã€‚ åœ¨å¤§éƒ¨åˆ†æ”¯æŒå¤šçº¿ç¨‹çš„æ“ä½œç³»ç»Ÿå’Œç¼–ç¨‹è¯­è¨€ä¸­ï¼Œçº¿ç¨‹æœ‰ä¸€ä¸ªç‹¬ç‰¹çš„æ ‡è¯†ï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªæ•´æ•°æˆ–è€…æŒ‡é’ˆï¼Œè¿™ä¸ªç‰¹æ€§å¯ä»¥è®©æˆ‘ä»¬æž„å»ºä¸€ä¸ªçº¿ç¨‹çš„å±€éƒ¨å­˜å‚¨ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªå…¨å±€çš„mapï¼Œä»¥çº¿ç¨‹çš„æ ‡è¯†ä½œä¸ºé”®ï¼Œè¿™æ ·æ¯ä¸ªçº¿ç¨‹å¯ä»¥ç‹¬ç«‹ä½¿ç”¨è¿™ä¸ªmapå­˜å‚¨å’ŒèŽ·å–å€¼ï¼Œä¸å—å…¶ä»–çº¿ç¨‹å¹²æ‰°ã€‚ goroutineä¸­æ²¡æœ‰å¯ä¾›ç¨‹åºå‘˜è®¿é—®çš„æ ‡è¯†ï¼ŒåŽŸå› æ˜¯ä¸€ç§çº¯å‡½æ•°çš„ç†å¿µï¼Œä¸å¸Œæœ›æ»¥ç”¨çº¿ç¨‹å±€éƒ¨å­˜å‚¨å¯¼è‡´ä¸€ä¸ªä¸å¥åº·çš„è¶…è·ä½œç”¨ï¼Œå³å‡½æ•°çš„è¡Œä¸ºä¸ä»…å–å†³äºŽå®ƒçš„å‚æ•°ï¼Œè¿˜å–å†³äºŽè¿è¡Œå®ƒçš„çº¿ç¨‹æ ‡è¯†ã€‚ 32. æ»‘åŠ¨çª—å£çš„æ¦‚å¿µä»¥åŠåº”ç”¨?æ»‘åŠ¨çª—å£æ¦‚å¿µä¸ä»…å­˜åœ¨äºŽæ•°æ®é“¾è·¯å±‚ï¼Œä¹Ÿå­˜åœ¨äºŽä¼ è¾“å±‚ï¼Œä¸¤è€…æœ‰ä¸åŒçš„åè®®ï¼Œä½†åŸºæœ¬åŽŸç†æ˜¯ç›¸è¿‘çš„ã€‚å…¶ä¸­ä¸€ä¸ªé‡è¦åŒºåˆ«æ˜¯ï¼Œä¸€ä¸ªæ˜¯é’ˆå¯¹äºŽå¸§çš„ä¼ é€ï¼Œå¦ä¸€ä¸ªæ˜¯å­—èŠ‚æ•°æ®çš„ä¼ é€ã€‚ æ»‘åŠ¨çª—å£ï¼ˆSliding windowï¼‰æ˜¯ä¸€ç§æµé‡æŽ§åˆ¶æŠ€æœ¯ã€‚æ—©æœŸçš„ç½‘ç»œé€šä¿¡ä¸­ï¼Œé€šä¿¡åŒæ–¹ä¸ä¼šè€ƒè™‘ç½‘ç»œçš„æ‹¥æŒ¤æƒ…å†µç›´æŽ¥å‘é€æ•°æ®ã€‚ç”±äºŽå¤§å®¶ä¸çŸ¥é“ç½‘ç»œæ‹¥å¡žçŠ¶å†µï¼ŒåŒæ—¶å‘é€æ•°æ®ï¼Œå¯¼è‡´ä¸­é—´èŠ‚ç‚¹é˜»å¡žæŽ‰åŒ…ï¼Œè°ä¹Ÿå‘ä¸äº†æ•°æ®ï¼Œæ‰€ä»¥å°±æœ‰äº†æ»‘åŠ¨çª—å£æœºåˆ¶æ¥è§£å†³æ­¤é—®é¢˜ã€‚å‚è§æ»‘åŠ¨çª—å£å¦‚ä½•æ ¹æ®ç½‘ç»œæ‹¥å¡žå‘é€æ•°æ®ä»¿çœŸè§†é¢‘ã€‚ æ»‘åŠ¨çª—å£åè®®æ˜¯ç”¨æ¥æ”¹å–„åžåé‡çš„ä¸€ç§æŠ€æœ¯ï¼Œå³å®¹è®¸å‘é€æ–¹åœ¨æŽ¥æ”¶ä»»ä½•åº”ç­”ä¹‹å‰ä¼ é€é™„åŠ çš„åŒ…ã€‚æŽ¥æ”¶æ–¹å‘Šè¯‰å‘é€æ–¹åœ¨æŸä¸€æ—¶åˆ»èƒ½é€å¤šå°‘åŒ…ï¼ˆç§°çª—å£å°ºå¯¸ï¼‰ã€‚ CPä¸­é‡‡ç”¨æ»‘åŠ¨çª—å£æ¥è¿›è¡Œä¼ è¾“æŽ§åˆ¶ï¼Œæ»‘åŠ¨çª—å£çš„å¤§å°æ„å‘³ç€æŽ¥æ”¶æ–¹è¿˜æœ‰å¤šå¤§çš„ç¼“å†²åŒºå¯ä»¥ç”¨äºŽæŽ¥æ”¶æ•°æ®ã€‚å‘é€æ–¹å¯ä»¥é€šè¿‡æ»‘åŠ¨çª—å£çš„å¤§å°æ¥ç¡®å®šåº”è¯¥å‘é€å¤šå°‘å­—èŠ‚çš„æ•°æ®ã€‚å½“æ»‘åŠ¨çª—å£ä¸º0æ—¶ï¼Œå‘é€æ–¹ä¸€èˆ¬ä¸èƒ½å†å‘é€æ•°æ®æŠ¥ï¼Œä½†æœ‰ä¸¤ç§æƒ…å†µé™¤å¤–ï¼Œä¸€ç§æƒ…å†µæ˜¯å¯ä»¥å‘é€ç´§æ€¥æ•°æ®ï¼Œä¾‹å¦‚ï¼Œå…è®¸ç”¨æˆ·ç»ˆæ­¢åœ¨è¿œç«¯æœºä¸Šçš„è¿è¡Œè¿›ç¨‹ã€‚å¦ä¸€ç§æƒ…å†µæ˜¯å‘é€æ–¹å¯ä»¥å‘é€ä¸€ä¸ª1å­—èŠ‚çš„æ•°æ®æŠ¥æ¥é€šçŸ¥æŽ¥æ”¶æ–¹é‡æ–°å£°æ˜Žå®ƒå¸Œæœ›æŽ¥æ”¶çš„ä¸‹ä¸€å­—èŠ‚åŠå‘é€æ–¹çš„æ»‘åŠ¨çª—å£å¤§å°ã€‚ 33. æ€Žä¹ˆåšå¼¹æ€§æ‰©ç¼©å®¹ï¼ŒåŽŸç†æ˜¯ä»€ä¹ˆ?å¼¹æ€§ä¼¸ç¼©ï¼ˆAuto Scalingï¼‰æ ¹æ®æ‚¨çš„ä¸šåŠ¡éœ€æ±‚å’Œä¼¸ç¼©ç­–ç•¥ï¼Œä¸ºæ‚¨è‡ªåŠ¨è°ƒæ•´è®¡ç®—èµ„æºã€‚æ‚¨å¯è®¾ç½®å®šæ—¶ã€å‘¨æœŸæˆ–ç›‘æŽ§ç­–ç•¥ï¼Œæ°åˆ°å¥½å¤„åœ°å¢žåŠ æˆ–å‡å°‘CVMå®žä¾‹ï¼Œå¹¶å®Œæˆå®žä¾‹é…ç½®ï¼Œä¿è¯ä¸šåŠ¡å¹³ç¨³å¥åº·è¿è¡Œã€‚åœ¨éœ€æ±‚é«˜å³°æœŸæ—¶ï¼Œå¼¹æ€§ä¼¸ç¼©è‡ªåŠ¨å¢žåŠ CVMå®žä¾‹çš„æ•°é‡ï¼Œä»¥ä¿è¯æ€§èƒ½ä¸å—å½±å“ï¼›å½“éœ€æ±‚è¾ƒä½Žæ—¶ï¼Œåˆ™ä¼šå‡å°‘CVMå®žä¾‹æ•°é‡ä»¥é™ä½Žæˆæœ¬ã€‚å¼¹æ€§ä¼¸ç¼©æ—¢é€‚åˆéœ€æ±‚ç¨³å®šçš„åº”ç”¨ç¨‹åºï¼ŒåŒæ—¶ä¹Ÿé€‚åˆæ¯å¤©ã€æ¯å‘¨ã€æ¯æœˆä½¿ç”¨é‡ä¸åœæ³¢åŠ¨çš„åº”ç”¨ç¨‹åºã€‚ 34. è®©ä½ è®¾è®¡ä¸€ä¸ªwebæ¡†æž¶ï¼Œä½ è¦æ€Žä¹ˆè®¾è®¡ï¼Œè¯´ä¸€ä¸‹æ­¥éª¤.35. è¯´ä¸€ä¸‹ä¸­é—´ä»¶åŽŸç†.ä¸­é—´ä»¶ï¼ˆmiddlewareï¼‰æ˜¯åŸºç¡€è½¯ä»¶çš„ä¸€å¤§ç±»ï¼Œå±žäºŽå¯å¤ç”¨è½¯ä»¶çš„èŒƒç•´ã€‚ä¸­é—´ä»¶å¤„äºŽæ“ä½œç³»ç»Ÿè½¯ä»¶ä¸Žç”¨æˆ·çš„åº”ç”¨è½¯ä»¶çš„ä¸­é—´ã€‚ä¸­é—´ä»¶åœ¨æ“ä½œç³»ç»Ÿã€ç½‘ç»œå’Œæ•°æ®åº“ä¹‹ä¸Šï¼Œåº”ç”¨è½¯ä»¶çš„ä¸‹å±‚ï¼Œæ€»çš„ä½œç”¨æ˜¯ä¸ºå¤„äºŽè‡ªå·±ä¸Šå±‚çš„åº”ç”¨è½¯ä»¶æä¾›è¿è¡Œä¸Žå¼€å‘çš„çŽ¯å¢ƒï¼Œå¸®åŠ©ç”¨æˆ·çµæ´»ã€é«˜æ•ˆåœ°å¼€å‘å’Œé›†æˆå¤æ‚çš„åº”ç”¨è½¯ä»¶ IDCçš„å®šä¹‰æ˜¯ï¼šä¸­é—´ä»¶æ˜¯ä¸€ç§ç‹¬ç«‹çš„ç³»ç»Ÿè½¯ä»¶æˆ–æœåŠ¡ç¨‹åºï¼Œåˆ†å¸ƒå¼åº”ç”¨è½¯ä»¶å€ŸåŠ©è¿™ç§è½¯ä»¶åœ¨ä¸åŒçš„æŠ€æœ¯ä¹‹é—´å…±äº«èµ„æºï¼Œä¸­é—´ä»¶ä½äºŽå®¢æˆ·æœºæœåŠ¡å™¨çš„æ“ä½œç³»ç»Ÿä¹‹ä¸Šï¼Œç®¡ç†è®¡ç®—èµ„æºå’Œç½‘ç»œé€šä¿¡ã€‚ ä¸­é—´ä»¶è§£å†³çš„é—®é¢˜æ˜¯ï¼š åœ¨ä¸­é—´ä»¶äº§ç”Ÿä»¥å‰ï¼Œåº”ç”¨è½¯ä»¶ç›´æŽ¥ä½¿ç”¨æ“ä½œç³»ç»Ÿã€ç½‘ç»œåè®®å’Œæ•°æ®åº“ç­‰å¼€å‘ï¼Œè¿™äº›éƒ½æ˜¯è®¡ç®—æœºæœ€åº•å±‚çš„ä¸œè¥¿ï¼Œè¶Šåº•å±‚è¶Šå¤æ‚ï¼Œå¼€å‘è€…ä¸å¾—ä¸é¢ä¸´è®¸å¤šå¾ˆæ£˜æ‰‹çš„é—®é¢˜ï¼Œå¦‚æ“ä½œç³»ç»Ÿçš„å¤šæ ·æ€§ï¼Œç¹æ‚çš„ç½‘ç»œç¨‹åºè®¾è®¡ã€ç®¡ç†ï¼Œå¤æ‚å¤šå˜çš„ç½‘ç»œçŽ¯å¢ƒï¼Œæ•°æ®åˆ†æ•£å¤„ç†å¸¦æ¥çš„ä¸ä¸€è‡´æ€§é—®é¢˜ã€æ€§èƒ½å’Œæ•ˆçŽ‡ã€å®‰å…¨ï¼Œç­‰ç­‰ã€‚è¿™äº›ä¸Žç”¨æˆ·çš„ä¸šåŠ¡æ²¡æœ‰ç›´æŽ¥å…³ç³»ï¼Œä½†åˆå¿…é¡»è§£å†³ï¼Œè€—è´¹äº†å¤§é‡æœ‰é™çš„æ—¶é—´å’Œç²¾åŠ›ã€‚äºŽæ˜¯ï¼Œæœ‰äººæå‡ºèƒ½ä¸èƒ½å°†åº”ç”¨è½¯ä»¶æ‰€è¦é¢ä¸´çš„å…±æ€§é—®é¢˜è¿›è¡Œæç‚¼ã€æŠ½è±¡ï¼Œåœ¨æ“ä½œç³»ç»Ÿä¹‹ä¸Šå†å½¢æˆä¸€ä¸ªå¯å¤ç”¨çš„éƒ¨åˆ†ï¼Œä¾›æˆåƒä¸Šä¸‡çš„åº”ç”¨è½¯ä»¶é‡å¤ä½¿ç”¨ã€‚è¿™ä¸€æŠ€æœ¯æ€æƒ³æœ€ç»ˆæž„æˆäº†ä¸­é—´ä»¶è¿™ç±»çš„è½¯ä»¶ã€‚ä¸­é—´ä»¶å±è”½äº†åº•å±‚æ“ä½œç³»ç»Ÿçš„å¤æ‚æ€§ï¼Œä½¿ç¨‹åºå¼€å‘äººå‘˜é¢å¯¹ä¸€ä¸ªç®€å•è€Œç»Ÿä¸€çš„å¼€å‘çŽ¯å¢ƒï¼Œå‡å°‘ç¨‹åºè®¾è®¡çš„å¤æ‚æ€§ï¼Œå°†æ³¨æ„åŠ›é›†ä¸­åœ¨è‡ªå·±çš„ä¸šåŠ¡ä¸Šï¼Œä¸å¿…å†ä¸ºç¨‹åºåœ¨ä¸åŒç³»ç»Ÿè½¯ä»¶ä¸Šçš„ç§»æ¤è€Œé‡å¤å·¥ä½œï¼Œä»Žè€Œå¤§å¤§å‡å°‘äº†æŠ€æœ¯ä¸Šçš„è´Ÿæ‹…ã€‚ 36. æ€Žä¹ˆè®¾è®¡ormï¼Œè®©ä½ å†™,ä½ ä¼šæ€Žä¹ˆå†™?37. ç”¨è¿‡åŽŸç”Ÿçš„httpåŒ…å—ï¼Ÿ38. ä¸€ä¸ªéžå¸¸å¤§çš„æ•°ç»„ï¼Œè®©å…¶ä¸­ä¸¤ä¸ªæ•°æƒ³åŠ ç­‰äºŽ1000æ€Žä¹ˆç®—?39. å„ä¸ªç³»ç»Ÿå‡ºé—®é¢˜æ€Žä¹ˆç›‘æŽ§æŠ¥è­¦.å¯ä»¥ä½¿ç”¨prometheusæ­é…kongç½‘å…³ï¼Œç›‘æŽ§å„ä¸ªç³»ç»Ÿçš„æŽ¥å£è½¬å‘å¤„ï¼Œè¿›è¡Œå¤„ç†æŠ¥è­¦ï¼Œç„¶åŽä¸ŠæŠ¥ä¹‹åŽï¼Œè®¾ç½®é˜ˆå€¼ï¼ŒæŠ¥è­¦å’Œè‡ªæ¢å¤ç³»ç»Ÿè®¾è®¡ã€‚ 40. å¸¸ç”¨æµ‹è¯•å·¥å…·ï¼ŒåŽ‹æµ‹å·¥å…·ï¼Œæ–¹æ³•?1goconvey,vegeta 41. å¤æ‚çš„å•å…ƒæµ‹è¯•æ€Žä¹ˆæµ‹è¯•ï¼Œæ¯”å¦‚æœ‰å¤–éƒ¨æŽ¥å£mysqlæŽ¥å£çš„æƒ…å†µ42. redisé›†ç¾¤ï¼Œå“¨å…µï¼ŒæŒä¹…åŒ–ï¼Œäº‹åŠ¡43. mysqlå’ŒredisåŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ mysqlå’Œredisçš„æ•°æ®åº“ç±»åž‹ mysqlæ˜¯å…³ç³»åž‹æ•°æ®åº“ï¼Œä¸»è¦ç”¨äºŽå­˜æ”¾æŒä¹…åŒ–æ•°æ®ï¼Œå°†æ•°æ®å­˜å‚¨åœ¨ç¡¬ç›˜ä¸­ï¼Œè¯»å–é€Ÿåº¦è¾ƒæ…¢ã€‚ redisæ˜¯NOSQLï¼Œå³éžå…³ç³»åž‹æ•°æ®åº“ï¼Œä¹Ÿæ˜¯ç¼“å­˜æ•°æ®åº“ï¼Œå³å°†æ•°æ®å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œç¼“å­˜çš„è¯»å–é€Ÿåº¦å¿«ï¼Œèƒ½å¤Ÿå¤§å¤§çš„æé«˜è¿è¡Œæ•ˆçŽ‡ï¼Œä½†æ˜¯ä¿å­˜æ—¶é—´æœ‰é™ã€‚ mysqlçš„è¿è¡Œæœºåˆ¶ mysqlä½œä¸ºæŒä¹…åŒ–å­˜å‚¨çš„å…³ç³»åž‹æ•°æ®åº“ï¼Œç›¸å¯¹è–„å¼±çš„åœ°æ–¹åœ¨äºŽæ¯æ¬¡è¯·æ±‚è®¿é—®æ•°æ®åº“æ—¶ï¼Œéƒ½å­˜åœ¨ç€I/Oæ“ä½œï¼Œå¦‚æžœåå¤é¢‘ç¹çš„è®¿é—®æ•°æ®åº“ã€‚ç¬¬ä¸€ï¼šä¼šåœ¨åå¤é“¾æŽ¥æ•°æ®åº“ä¸ŠèŠ±è´¹å¤§é‡æ—¶é—´ï¼Œä»Žè€Œå¯¼è‡´è¿è¡Œæ•ˆçŽ‡è¿‡æ…¢ï¼›ç¬¬äºŒï¼šåå¤çš„è®¿é—®æ•°æ®åº“ä¹Ÿä¼šå¯¼è‡´æ•°æ®åº“çš„è´Ÿè½½è¿‡é«˜ï¼Œé‚£ä¹ˆæ­¤æ—¶ç¼“å­˜çš„æ¦‚å¿µå°±è¡ç”Ÿäº†å‡ºæ¥ã€‚ ç¼“å­˜ ç¼“å­˜å°±æ˜¯æ•°æ®äº¤æ¢çš„ç¼“å†²åŒºï¼ˆcacheï¼‰ï¼Œå½“æµè§ˆå™¨æ‰§è¡Œè¯·æ±‚æ—¶ï¼Œé¦–å…ˆä¼šå¯¹åœ¨ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æžœå­˜åœ¨ï¼Œå°±èŽ·å–ï¼›å¦åˆ™å°±è®¿é—®æ•°æ®åº“ã€‚ ç¼“å­˜çš„å¥½å¤„å°±æ˜¯è¯»å–é€Ÿåº¦å¿«ã€‚ redisæ•°æ®åº“ redisæ•°æ®åº“å°±æ˜¯ä¸€æ¬¾ç¼“å­˜æ•°æ®åº“ï¼Œç”¨äºŽå­˜å‚¨ä½¿ç”¨é¢‘ç¹çš„æ•°æ®ï¼Œè¿™æ ·å‡å°‘è®¿é—®æ•°æ®åº“çš„æ¬¡æ•°ï¼Œæé«˜è¿è¡Œæ•ˆçŽ‡ã€‚ rediså’Œmysqlçš„åŒºåˆ«æ€»ç»“ ï¼ˆ1ï¼‰ç±»åž‹ä¸Š ä»Žç±»åž‹ä¸Šæ¥è¯´ï¼Œmysqlæ˜¯å…³ç³»åž‹æ•°æ®åº“ï¼Œredisæ˜¯ç¼“å­˜æ•°æ®åº“ ï¼ˆ2ï¼‰ä½œç”¨ä¸Š mysqlç”¨äºŽæŒä¹…åŒ–çš„å­˜å‚¨æ•°æ®åˆ°ç¡¬ç›˜ï¼ŒåŠŸèƒ½å¼ºå¤§ï¼Œä½†æ˜¯é€Ÿåº¦è¾ƒæ…¢ redisç”¨äºŽå­˜å‚¨ä½¿ç”¨è¾ƒä¸ºé¢‘ç¹çš„æ•°æ®åˆ°ç¼“å­˜ä¸­ï¼Œè¯»å–é€Ÿåº¦å¿« ï¼ˆ3ï¼‰éœ€æ±‚ä¸Š mysqlå’Œrediså› ä¸ºéœ€æ±‚çš„ä¸åŒï¼Œä¸€èˆ¬éƒ½æ˜¯é…åˆä½¿ç”¨ã€‚ 44. é«˜å¯ç”¨è½¯ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ Heartbeat Heartbeatæ˜¯ä¸€ä¸ªæ¯”è¾ƒè€ç‰Œçš„é›†ç¾¤ç®¡ç†è½¯ä»¶ï¼Œæœ€æ–°ç‰ˆæœ¬æ˜¯V3.0ï¼Œ ä¹Ÿç§°ä¸ºHeartbeat 3.é€šè¿‡Heartbeatï¼Œå¯ä»¥å®žçŽ°å¯¹æœåŠ¡å™¨èµ„æºï¼ˆipä»¥åŠç¨‹åºæœåŠ¡ç­‰èµ„æºï¼‰çš„ç›‘æŽ§å’Œç®¡ç†ï¼Œå¹¶åœ¨å‡ºçŽ°æ•…éšœçš„æƒ…å†µä¸‹ï¼Œå°†èµ„æºé›†åˆä»Žä¸€å°å·²ç»æ•…éšœçš„è®¡ç®—æœºå¿«é€Ÿè½¬ç§»åˆ°å¦ä¸€å°æ­£å¸¸è¿è½¬çš„æœºå™¨ä¸Šç»§ç»­æä¾›æœåŠ¡ã€‚ Keepalived Keepalivedä¹Ÿæ˜¯ä¸€æ¬¾é«˜å¯ç”¨é›†ç¾¤ç®¡ç†è½¯ä»¶ï¼Œå…¶åŸºæœ¬åŠŸèƒ½ä¸ŽHeartbeatéžå¸¸ç±»ä¼¼ã€‚ Keepalivedå®ƒçš„åŠŸèƒ½ä¸»è¦åŒ…æ‹¬ä¸¤æ–¹é¢ï¼š 1ï¼‰é€šè¿‡IPæ¼‚ç§»ï¼Œå®žçŽ°æœåŠ¡çš„é«˜å¯ç”¨ï¼šæœåŠ¡å™¨é›†ç¾¤å…±äº«ä¸€ä¸ªè™šæ‹ŸIPï¼ŒåŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæœåŠ¡å™¨å æœ‰è™šæ‹ŸIPå¹¶å¯¹å¤–æä¾›æœåŠ¡ï¼Œè‹¥è¯¥æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™è™šæ‹ŸIPæ¼‚ç§»è‡³å¦ä¸€å°æœåŠ¡å™¨å¹¶å¯¹å¤–æä¾›æœåŠ¡ï¼› 2ï¼‰å¯¹LVSåº”ç”¨æœåŠ¡å±‚çš„åº”ç”¨æœåŠ¡å™¨é›†ç¾¤è¿›è¡ŒçŠ¶æ€ç›‘æŽ§ï¼šè‹¥åº”ç”¨æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œåˆ™keepalivedå°†å…¶ä»Žé›†ç¾¤ä¸­æ‘˜é™¤ï¼Œè‹¥åº”ç”¨æœåŠ¡å™¨æ¢å¤ï¼Œåˆ™keepalivedå°†å…¶é‡æ–°åŠ å…¥é›†ç¾¤ä¸­ã€‚ Keepalivedå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œå³é€šè¿‡IPæ¼‚ç§»å®žçŽ°æœåŠ¡çš„é«˜å¯ç”¨ï¼Œä¹Ÿå¯ä»¥ç»“åˆLVSä½¿ç”¨ï¼Œå³ä¸€æ–¹é¢é€šè¿‡IPæ¼‚ç§»å®žçŽ°LVSè´Ÿè½½å‡è¡¡å±‚çš„é«˜å¯ç”¨ï¼Œå¦ä¸€æ–¹é¢å®žçŽ°LVSåº”ç”¨æœåŠ¡å±‚çš„çŠ¶æ€ç›‘æŽ§ã€‚ 45. æ€Žä¹ˆæžä¸€ä¸ªå¹¶å‘æœåŠ¡ç¨‹åºï¼Ÿ46. è®²è§£ä¸€ä¸‹ä½ åšè¿‡çš„é¡¹ç›®ï¼Œç„¶åŽæ‰¾é—®é¢˜é—®å®žçŽ°ç»†èŠ‚ã€‚47. mysqläº‹åŠ¡è¯´ä¸‹äº‹åŠ¡æ˜¯ä¸€ç»„åŽŸå­æ€§çš„sqlå‘½ä»¤æˆ–è€…è¯´æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒ,å¦‚æžœæ•°æ®åº“å¼•æ“Žèƒ½å¤ŸæˆåŠŸçš„å¯¹æ•°æ®åº“åº”ç”¨è¯¥ç»„çš„å…¨éƒ¨sqlè¯­å¥,é‚£ä¹ˆå°±æ‰§è¡Œè¯¥ç»„å‘½ä»¤å¦‚æžœå…¶ä¸­æœ‰ä»»ä½•ä¸€æ¡è¯­å¥å› ä¸ºå´©æºƒæˆ–è€…å…¶å®ƒåŽŸå› æ— æ³•æ‰§è¡Œ,é‚£ä¹ˆè¯¥ç»„ä¸­æ‰€æœ‰çš„sqlè¯­å¥éƒ½ä¸ä¼šæ‰§è¡Œ,å¦‚æžœæ²¡æœ‰æ˜¾ç¤ºå¯åŠ¨äº‹åŠ¡,æ•°æ®åº“ä¼šæ ¹æ®autocommitçš„å€¼.é»˜è®¤æ¯æ¡sqlæ“ä½œéƒ½ä¼šè‡ªåŠ¨æäº¤ã€‚ åŽŸå­æ€§ ä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œ,è¦ä¹ˆéƒ½å®Œæˆ,è¦ä¹ˆéƒ½ä¸æ‰§è¡Œ.å¯¹äºŽä¸€ä¸ªäº‹åŠ¡æ¥è¯´,ä¸å¯èƒ½åªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†ã€‚ ä¸€è‡´æ€§ æ•°æ®åº“ä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡å¿…é¡»ä½¿æ•°æ®åº“ä»Žä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€å˜åˆ°å¦å¤–ä¸€ä¸ªä¸€è‡´çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯æ‰§è¡Œäº‹åŠ¡ä¹‹å‰å’Œä¹‹åŽçš„çŠ¶æ€éƒ½å¿…é¡»å¤„äºŽä¸€è‡´çš„çŠ¶æ€ã€‚ 1åœ¨äº‹åŠ¡Tå¼€å§‹æ—¶ï¼Œæ­¤æ—¶æ•°æ®åº“æœ‰ä¸€ç§çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€æ˜¯æ‰€æœ‰çš„MySQLå¯¹è±¡å¤„äºŽä¸€è‡´çš„çŠ¶æ€ï¼Œä¾‹å¦‚æ•°æ®åº“å®Œæ•´æ€§çº¦æŸæ­£ç¡®ï¼Œæ—¥å¿—çŠ¶æ€ä¸€è‡´ç­‰ï¼Œå½“äº‹åŠ¡Tæäº¤åŽï¼Œè¿™æ—¶æ•°æ®åº“åˆæœ‰äº†ä¸€ä¸ªæ–°çš„çŠ¶æ€ï¼Œä¸åŒçš„æ•°æ®ï¼Œä¸åŒçš„ç´¢å¼•ï¼Œä¸åŒçš„æ—¥å¿—ç­‰ï¼Œä½†æ­¤æ—¶ï¼Œçº¦æŸï¼Œæ•°æ®ï¼Œç´¢å¼•ï¼Œæ—¥å¿—ç­‰MySQLå„ç§å¯¹è±¡è¿˜æ˜¯è¦ä¿æŒä¸€è‡´æ€§ï¼ˆæ­£ç¡®æ€§ï¼‰ã€‚ è¿™å°±æ˜¯ ä»Žä¸€ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€ï¼Œå˜åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯äº‹åŠ¡æ‰§è¡ŒåŽï¼Œå¹¶æ²¡æœ‰ç ´åæ•°æ®åº“çš„å®Œæ•´æ€§çº¦æŸï¼ˆä¸€åˆ‡éƒ½æ˜¯å¯¹çš„ï¼‰ã€‚ éš”ç¦»æ€§ éš”ç¦»æ€§æ˜¯æŒ‡å½“å¤šä¸ªç”¨æˆ·å¹¶å‘è®¿é—®æ•°æ®åº“æ—¶ï¼Œæ¯”å¦‚æ“ä½œåŒä¸€å¼ è¡¨æ—¶ï¼Œæ•°æ®åº“ä¸ºæ¯ä¸€ä¸ªç”¨æˆ·å¼€å¯çš„äº‹åŠ¡ï¼Œä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡çš„æ“ä½œæ‰€å¹²æ‰°ï¼Œå¤šä¸ªå¹¶å‘äº‹åŠ¡ä¹‹é—´è¦ç›¸äº’éš”ç¦»ã€‚ 1å¯¹äºŽä»»æ„ä¸¤ä¸ªå¹¶å‘çš„äº‹åŠ¡T1å’ŒT2ï¼Œåœ¨äº‹åŠ¡T1çœ‹æ¥ï¼ŒT2è¦ä¹ˆåœ¨T1å¼€å§‹ä¹‹å‰å°±å·²ç»ç»“æŸï¼Œè¦ä¹ˆåœ¨T1ç»“æŸä¹‹åŽæ‰å¼€å§‹ï¼Œè¿™æ ·æ¯ä¸ªäº‹åŠ¡éƒ½æ„Ÿè§‰ä¸åˆ°æœ‰å…¶ä»–äº‹åŠ¡åœ¨å¹¶å‘åœ°æ‰§è¡Œã€‚ æŒä¹…æ€§ æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤äº†ï¼Œé‚£ä¹ˆå¯¹äºŽæ•°æ®åº“ä¸­çš„æ•°æ®æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä¾¿æ˜¯åœ¨æ•°æ®åº“ç³»ç»Ÿé­é‡åˆ°æ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿä¸ä¼šä¸¢å¤±æäº¤äº‹åŠ¡çš„æ“ä½œã€‚ 1æˆ‘ä»¬åœ¨ä½¿ç”¨è¿žæŽ¥æ± æ“ä½œæ•°æ®åº“æ—¶ï¼Œåœ¨æäº¤äº‹åŠ¡æ–¹æ³•åŽï¼Œæç¤ºç”¨æˆ·äº‹åŠ¡æ“ä½œå®Œæˆï¼Œå½“æˆ‘ä»¬ç¨‹åºæ‰§è¡Œå®Œæˆç›´åˆ°çœ‹åˆ°æç¤ºåŽï¼Œå°±å¯ä»¥è®¤å®šäº‹åŠ¡ä»¥åŠæ­£ç¡®æäº¤ï¼Œå³ä½¿è¿™æ—¶å€™æ•°æ®åº“å‡ºçŽ°äº†é—®é¢˜ï¼Œä¹Ÿå¿…é¡»è¦å°†æˆ‘ä»¬çš„äº‹åŠ¡å®Œå…¨æ‰§è¡Œå®Œæˆï¼Œå¦åˆ™å°±ä¼šé€ æˆæˆ‘ä»¬çœ‹åˆ°æç¤ºäº‹åŠ¡å¤„ç†å®Œæ¯•ï¼Œä½†æ˜¯æ•°æ®åº“å› ä¸ºæ•…éšœè€Œæ²¡æœ‰æ‰§è¡Œäº‹åŠ¡çš„é‡å¤§é”™è¯¯ã€‚ 48. æ€Žä¹ˆåšä¸€ä¸ªè‡ªåŠ¨åŒ–é…ç½®å¹³å°ç³»ç»Ÿï¼Ÿ49. grpcéµå¾ªä»€ä¹ˆåè®®ï¼Ÿ50. grpcå†…éƒ¨åŽŸç†æ˜¯ä»€ä¹ˆï¼Ÿ51. http2çš„ç‰¹ç‚¹æ˜¯ä»€ä¹ˆï¼Œä¸Žhttp1.1çš„å¯¹æ¯”ã€‚ HTTP1.1 HTTP2 QUIC æŒä¹…è¿žæŽ¥ äºŒè¿›åˆ¶åˆ†å¸§ åŸºäºŽUDPçš„å¤šè·¯ä¼ è¾“ï¼ˆå•è¿žæŽ¥ä¸‹ï¼‰ è¯·æ±‚ç®¡é“åŒ– å¤šè·¯å¤ç”¨ï¼ˆæˆ–è¿žæŽ¥å…±äº«ï¼‰ æžä½Žçš„ç­‰å¾…æ—¶å»¶ï¼ˆç›¸æ¯”äºŽTCPçš„ä¸‰æ¬¡æ¡æ‰‹ï¼‰ å¢žåŠ ç¼“å­˜å¤„ç†ï¼ˆæ–°çš„å­—æ®µå¦‚cache-controlï¼‰ å¤´éƒ¨åŽ‹ç¼© QUICä¸º ä¼ è¾“å±‚ åè®® ï¼Œæˆä¸ºæ›´å¤šåº”ç”¨å±‚çš„é«˜æ€§èƒ½é€‰æ‹© å¢žåŠ Hostå­—æ®µã€æ”¯æŒæ–­ç‚¹ä¼ è¾“ç­‰ï¼ˆæŠŠæ–‡ä»¶åˆ†æˆå‡ éƒ¨åˆ†ï¼‰ æœåŠ¡å™¨æŽ¨é€ 52. Goçš„è°ƒåº¦åŽŸç†. Goè°ƒåº¦å™¨: M, P å’Œ G Goè¯­è¨€å®žæˆ˜ç¬”è®°ï¼ˆåäºŒï¼‰| Go goroutine Golangè°ƒåº¦å™¨æºç åˆ†æž Goroutineè°ƒåº¦è¿‡ç¨‹ 53. go structèƒ½ä¸èƒ½æ¯”è¾ƒ ç›¸åŒstructç±»åž‹çš„å¯ä»¥æ¯”è¾ƒ ä¸åŒstructç±»åž‹çš„ä¸å¯ä»¥æ¯”è¾ƒ,ç¼–è¯‘éƒ½ä¸è¿‡ï¼Œç±»åž‹ä¸åŒ¹é… 123456789101112131415161718192021package mainimport &quot;fmt&quot;func main() &#123; type A struct &#123; a int &#125; type B struct &#123; a int &#125; a := A&#123;1&#125; //b := A&#123;1&#125; b := B&#123;1&#125; if a == b &#123; fmt.Println(&quot;a == b&quot;) &#125;else&#123; fmt.Println(&quot;a != b&quot;) &#125;&#125; // output// command-line-arguments [command-line-arguments.test]// ./.go:14:7: invalid operation: a == b (mismatched types A and B) go deferï¼ˆfor deferï¼‰ Go å…³é”®å­— defer çš„ä¸€äº›å‘ selectå¯ä»¥ç”¨äºŽä»€ä¹ˆ? Goçš„selectä¸»è¦æ˜¯å¤„ç†å¤šä¸ªchannelçš„æ“ä½œ. Goè¯­è¨€å¹¶å‘æ¨¡åž‹ï¼šä½¿ç”¨ select contextåŒ…çš„ç”¨é€”æ˜¯ä»€ä¹ˆ? godoc: https://golang.org/pkg/context/ Go Contextçš„è¸©å‘ç»åŽ† Goè¯­è¨€å®žæˆ˜ç¬”è®°ï¼ˆäºŒåï¼‰| Go Context clientå¦‚ä½•å®žçŽ°é•¿è¿žæŽ¥? TCPåè®®çš„KeepAliveæœºåˆ¶ä¸ŽHeartBeatå¿ƒè·³åŒ… HTTP Keep-Aliveæ˜¯ä»€ä¹ˆï¼Ÿå¦‚ä½•å·¥ä½œï¼Ÿ ä¸»åç¨‹å¦‚ä½•ç­‰å…¶ä½™åç¨‹å®Œå†æ“ä½œ? Goå¹¶å‘ï¼šåˆ©ç”¨sync.WaitGroupå®žçŽ°åç¨‹åŒæ­¥ Goè¯­è¨€é‡ç‚¹ç¬”è®°-æ·±å…¥äº†è§£sync.WaitGroup sliceï¼Œlenï¼Œcapï¼Œå…±äº«ï¼Œæ‰©å®¹. mapå¦‚ä½•é¡ºåºè¯»å–? å¯ä»¥é€šè¿‡sortä¸­çš„æŽ’åºåŒ…è¿›è¡Œå¯¹mapä¸­çš„keyè¿›è¡ŒæŽ’åº golang:ä½¿ç”¨ sort æ¥æŽ’åº 1234567891011121314151617181920212223package mainimport ( &quot;fmt&quot; &quot;sort&quot;)func main() &#123; var m = map[string]int&#123; &quot;hello&quot;: 0, &quot;morning&quot;: 1, &quot;my&quot;: 2, &quot;girl&quot;: 3, &#125; var keys []string for k := range m &#123; keys = append(keys, k) &#125; sort.Strings(keys) for _, k := range keys &#123; fmt.Println(&quot;Key:&quot;, k, &quot;Value:&quot;, m[k]) &#125;&#125; å®žçŽ°set æ ¹æ®goä¸­mapçš„keysçš„æ— åºæ€§å’Œå”¯ä¸€æ€§ï¼Œå¯ä»¥å°†å…¶ä½œä¸ºset golangå®žçŽ°seté›†åˆ,å˜ç›¸å®žçŽ°åˆ‡ç‰‡åŽ»é‡ å®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¤šç”Ÿäº§è€…ï¼Œå¤šæ¶ˆè´¹è€…ï¼‰ æ ¹æ®Goroutineå’Œchannelçš„è¯»å†™å¯ä»¥å®žçŽ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œ golang channelå¤šç”Ÿäº§è€…å’Œå¤šæ¶ˆè´¹è€…å®žä¾‹ å¤§æ–‡ä»¶æŽ’åº ã€ç®—æ³•ã€‘å¯¹ä¸€ä¸ª20GBå¤§çš„æ–‡ä»¶æŽ’åº 64.åŸºæœ¬æŽ’åºï¼Œå“ªäº›æ˜¯ç¨³å®šçš„ é€‰æ‹©æŽ’åºã€å¿«é€ŸæŽ’åºã€å¸Œå°”æŽ’åºã€å †æŽ’åºä¸æ˜¯ç¨³å®šçš„æŽ’åºç®—æ³•ï¼Œ å†’æ³¡æŽ’åºã€æ’å…¥æŽ’åºã€å½’å¹¶æŽ’åºå’ŒåŸºæ•°æŽ’åºæ˜¯ç¨³å®šçš„æŽ’åºç®—æ³• ç¨³å®šæŽ’åºå’Œä¸ç¨³å®šæŽ’åº Http getè·Ÿhead get:èŽ·å–ç”±Request-URIæ ‡è¯†çš„ä»»ä½•ä¿¡æ¯(ä»¥å®žä½“çš„å½¢å¼)ï¼Œå¦‚æžœRequest-URIå¼•ç”¨æŸä¸ªæ•°æ®å¤„ç†è¿‡ç¨‹ï¼Œåˆ™åº”è¯¥ä»¥å®ƒäº§ç”Ÿçš„æ•°æ®ä½œä¸ºåœ¨å“åº”ä¸­çš„å®žä½“ï¼Œè€Œä¸æ˜¯è¯¥è¿‡ç¨‹çš„æºä»£ç æ–‡æœ¬ï¼Œé™¤éžè¯¥è¿‡ç¨‹ç¢°å·§è¾“å‡ºè¯¥æ–‡æœ¬ã€‚ head: é™¤äº†æœåŠ¡å™¨ä¸èƒ½åœ¨å“åº”ä¸­è¿”å›žæ¶ˆæ¯ä½“ï¼ŒHEADæ–¹æ³•ä¸ŽGETç›¸åŒã€‚ç”¨æ¥èŽ·å–æš—ç¤ºå®žä½“çš„å…ƒä¿¡æ¯ï¼Œè€Œä¸éœ€è¦ä¼ è¾“å®žä½“æœ¬èº«ã€‚å¸¸ç”¨äºŽæµ‹è¯•è¶…æ–‡æœ¬é“¾æŽ¥çš„æœ‰æ•ˆæ€§ã€å¯ç”¨æ€§å’Œæœ€è¿‘çš„ä¿®æ”¹ã€‚ Httpä»‹ç» Http 401,403 401 Unauthorizedï¼š è¯¥HTTPçŠ¶æ€ç è¡¨ç¤ºè®¤è¯é”™è¯¯ï¼Œå®ƒæ˜¯ä¸ºäº†è®¤è¯è®¾è®¡çš„ï¼Œè€Œä¸æ˜¯ä¸ºäº†æŽˆæƒè®¾è®¡çš„ã€‚æ”¶åˆ°401å“åº”ï¼Œè¡¨ç¤ºè¯·æ±‚æ²¡æœ‰è¢«è®¤è¯â€”åŽ‹æ ¹æ²¡æœ‰è®¤è¯æˆ–è€…è®¤è¯ä¸æ­£ç¡®â€”ä½†æ˜¯è¯·é‡æ–°è®¤è¯å’Œé‡è¯•ã€‚ï¼ˆä¸€èˆ¬åœ¨å“åº”å¤´éƒ¨åŒ…å«ä¸€ä¸ªWWW-Authenticateæ¥æè¿°å¦‚ä½•è®¤è¯ï¼‰ã€‚é€šå¸¸ç”±webæœåŠ¡å™¨è¿”å›žï¼Œè€Œä¸æ˜¯webåº”ç”¨ã€‚ä»Žæ€§è´¨ä¸Šæ¥è¯´æ˜¯ä¸´æ—¶çš„ä¸œè¥¿ã€‚ï¼ˆæœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯é‡è¯•ï¼‰ 403 Forbiddenï¼šè¯¥HTTPçŠ¶æ€ç æ˜¯å…³äºŽæŽˆæƒæ–¹é¢çš„ã€‚ä»Žæ€§è´¨ä¸Šæ¥è¯´æ˜¯æ°¸ä¹…çš„ä¸œè¥¿ï¼Œå’Œåº”ç”¨çš„ä¸šåŠ¡é€»è¾‘ç›¸å…³è”ã€‚å®ƒæ¯”401æ›´å…·ä½“ï¼Œæ›´å®žé™…ã€‚æ”¶åˆ°403å“åº”è¡¨ç¤ºæœåŠ¡å™¨å®Œæˆè®¤è¯è¿‡ç¨‹ï¼Œä½†æ˜¯å®¢æˆ·ç«¯è¯·æ±‚æ²¡æœ‰æƒé™åŽ»è®¿é—®è¦æ±‚çš„èµ„æºã€‚ æ€»çš„æ¥è¯´ï¼Œ401 Unauthorizedå“åº”åº”è¯¥ç”¨æ¥è¡¨ç¤ºç¼ºå¤±æˆ–é”™è¯¯çš„è®¤è¯ï¼›403 Forbiddenå“åº”åº”è¯¥åœ¨è¿™ä¹‹åŽç”¨ï¼Œå½“ç”¨æˆ·è¢«è®¤è¯åŽï¼Œä½†ç”¨æˆ·æ²¡æœ‰è¢«æŽˆæƒåœ¨ç‰¹å®šèµ„æºä¸Šæ‰§è¡Œæ“ä½œã€‚ HTTPå“åº”ç 403 Forbiddenå’Œ401 Unauthorizedå¯¹æ¯” 67.Http keep-alive Httpèƒ½ä¸èƒ½ä¸€æ¬¡è¿žæŽ¥å¤šæ¬¡è¯·æ±‚ï¼Œä¸ç­‰åŽç«¯è¿”å›ž TCP å’Œ UDP æœ‰ä»€ä¹ˆåŒºåˆ«,é€‚ç”¨åœºæ™¯ TCP æ˜¯é¢å‘è¿žæŽ¥çš„ï¼ŒUDP æ˜¯é¢å‘æ— è¿žæŽ¥çš„ï¼›æ•… TCP éœ€è¦å»ºç«‹è¿žæŽ¥å’Œæ–­å¼€è¿žæŽ¥ï¼ŒUDP ä¸éœ€è¦ã€‚ TCP æ˜¯æµåè®®ï¼ŒUDP æ˜¯æ•°æ®åŒ…åè®®ï¼›æ•… TCP æ•°æ®æ²¡æœ‰å¤§å°é™åˆ¶ï¼ŒUDP æ•°æ®æŠ¥æœ‰å¤§å°é™åˆ¶ï¼ˆUDP åè®®æœ¬èº«é™åˆ¶ã€æ•°æ®é“¾è·¯å±‚çš„ MTUã€ç¼“å­˜åŒºå¤§å°ï¼‰ã€‚ TCP æ˜¯å¯é åè®®ï¼ŒUDP æ˜¯ä¸å¯é åè®®ï¼›æ•… TCP ä¼šå¤„ç†æ•°æ®ä¸¢åŒ…é‡å‘ä»¥åŠä¹±åºç­‰æƒ…å†µï¼ŒUDP åˆ™ä¸ä¼šå¤„ç†ã€‚ UDP çš„ç‰¹ç‚¹åŠä½¿ç”¨åœºæ™¯: UDP ä¸æä¾›å¤æ‚çš„æŽ§åˆ¶æœºåˆ¶ï¼Œåˆ©ç”¨ IP æä¾›é¢å‘æ— è¿žæŽ¥çš„é€šä¿¡æœåŠ¡ï¼Œéšæ—¶éƒ½å¯ä»¥å‘é€æ•°æ®ï¼Œå¤„ç†ç®€å•ä¸”é«˜æ•ˆï¼Œç»å¸¸ç”¨äºŽä»¥ä¸‹åœºæ™¯ï¼š åŒ…æ€»é‡è¾ƒå°çš„é€šä¿¡ï¼ˆDNSã€SNMPï¼‰ è§†é¢‘ã€éŸ³é¢‘ç­‰å¤šåª’ä½“é€šä¿¡ï¼ˆå³æ—¶é€šä¿¡ï¼‰ å¹¿æ’­é€šä¿¡ TCP çš„ç‰¹ç‚¹åŠä½¿ç”¨åœºæ™¯: ç›¸å¯¹äºŽ UDPï¼ŒTCP å®žçŽ°äº†æ•°æ®ä¼ è¾“è¿‡ç¨‹ä¸­çš„å„ç§æŽ§åˆ¶ï¼Œå¯ä»¥è¿›è¡Œä¸¢åŒ…æ—¶çš„é‡å‘æŽ§åˆ¶ï¼Œè¿˜å¯ä»¥å¯¹æ¬¡åºä¹±æŽ‰çš„åˆ†åŒ…è¿›è¡Œé¡ºåºæŽ§åˆ¶ã€‚ åœ¨å¯¹å¯é æ€§è¦æ±‚è¾ƒé«˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ TCPï¼Œå³ä¸è€ƒè™‘ UDP çš„æ—¶å€™ï¼Œéƒ½å¯ä»¥é€‰æ‹© TCPã€‚ iOS é¢è¯•é¢˜ TCP UDP æœ‰ä»€ä¹ˆåŒºåˆ«ï¼ŸTCP ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹ï¼Œå››æ¬¡æŒ¥æ‰‹ï¼Ÿ time-waitçš„ä½œç”¨ TCP/IPçŠ¶æ€å›¾çš„TIME_WAITä½œç”¨ æ•°æ®åº“å¦‚ä½•å»ºç´¢å¼• æ­£ç¡®åˆç†çš„å»ºç«‹MySQLæ•°æ®åº“ç´¢å¼• å­¤å„¿è¿›ç¨‹ï¼Œåƒµå°¸è¿›ç¨‹ å­¤å„¿è¿›ç¨‹ï¼šä¸€ä¸ªçˆ¶è¿›ç¨‹é€€å‡ºï¼Œè€Œå®ƒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå­è¿›ç¨‹è¿˜åœ¨è¿è¡Œï¼Œé‚£ä¹ˆé‚£äº›å­è¿›ç¨‹å°†æˆä¸ºå­¤å„¿è¿›ç¨‹ã€‚å­¤å„¿è¿›ç¨‹å°†è¢«initè¿›ç¨‹(è¿›ç¨‹å·ä¸º1)æ‰€æ”¶å…»ï¼Œå¹¶ç”±initè¿›ç¨‹å¯¹å®ƒä»¬å®ŒæˆçŠ¶æ€æ”¶é›†å·¥ä½œã€‚ åƒµå°¸è¿›ç¨‹ï¼šä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œå¦‚æžœå­è¿›ç¨‹é€€å‡ºï¼Œè€Œçˆ¶è¿›ç¨‹å¹¶æ²¡æœ‰è°ƒç”¨waitæˆ–waitpidèŽ·å–å­è¿›ç¨‹çš„çŠ¶æ€ä¿¡æ¯ï¼Œé‚£ä¹ˆå­è¿›ç¨‹çš„è¿›ç¨‹æè¿°ç¬¦ä»ç„¶ä¿å­˜åœ¨ç³»ç»Ÿä¸­ã€‚è¿™ç§è¿›ç¨‹ç§°ä¹‹ä¸ºåƒµæ­»è¿›ç¨‹ã€‚ æ­»é”æ¡ä»¶ï¼Œå¦‚ä½•é¿å… linuxå‘½ä»¤ï¼ŒæŸ¥çœ‹ç«¯å£å ç”¨ï¼Œcpuè´Ÿè½½ï¼Œå†…å­˜å ç”¨ï¼Œå¦‚ä½•å‘é€ä¿¡å·ç»™ä¸€ä¸ªè¿›ç¨‹ gitæ–‡ä»¶ç‰ˆæœ¬ï¼Œä½¿ç”¨é¡ºåºï¼Œmergeè·Ÿrebase é€šå¸¸ä¸€èˆ¬ä¼šç”¨åˆ°å“ªäº›æ•°æ®ç»“æž„? é“¾è¡¨å’Œæ•°ç»„ç›¸æ¯”, æœ‰ä»€ä¹ˆä¼˜ç¼ºç‚¹? å¦‚ä½•åˆ¤æ–­ä¸¤ä¸ªæ— çŽ¯å•é“¾è¡¨æœ‰æ²¡æœ‰äº¤å‰ç‚¹? å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªå•é“¾è¡¨æœ‰æ²¡æœ‰çŽ¯, å¹¶æ‰¾å‡ºå…¥çŽ¯ç‚¹? æè¿°ä¸€ä¸‹ TCP å››æ¬¡æŒ¥æ‰‹çš„è¿‡ç¨‹ä¸­ TCP æœ‰å“ªäº›çŠ¶æ€? TCP çš„ LISTEN çŠ¶æ€æ˜¯ä»€ä¹ˆ? TCP çš„ CLOSE_WAIT çŠ¶æ€æ˜¯ä»€ä¹ˆ? å»ºç«‹ä¸€ä¸ª socket è¿žæŽ¥è¦ç»è¿‡å“ªäº›æ­¥éª¤? å¸¸è§çš„ HTTP çŠ¶æ€ç æœ‰å“ªäº›? 301å’Œ302æœ‰ä»€ä¹ˆåŒºåˆ«? 504å’Œ500æœ‰ä»€ä¹ˆåŒºåˆ«? HTTPS å’Œ HTTP æœ‰ä»€ä¹ˆåŒºåˆ«? ç®—æ³•é¢˜: æ‰‹å†™ä¸€ä¸ªå¿«é€ŸæŽ’åº å¿«é€ŸæŽ’åº: 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364func main() &#123; var arr = []int&#123;19,8,16,15,23,34,6,3,1,0,2,9,7&#125; quickAscendingSort(arr, 0, len(arr)-1) fmt.Println(&quot;quickAscendingSort:&quot;,arr) quickDescendingSort(arr, 0, len(arr)-1) fmt.Println(&quot;quickDescendingSort:&quot;,arr)&#125;//å‡åºfunc quickAscendingSort(arr []int, start, end int) &#123; if (start &lt; end) &#123; i, j := start, end key := arr[(start + end)/2] for i &lt;= j &#123; for arr[i] &lt; key &#123; i++ &#125; for arr[j] &gt; key &#123; j-- &#125; if i &lt;= j &#123; arr[i], arr[j] = arr[j], arr[i] i++ j-- &#125; &#125; if start &lt; j &#123; quickAscendingSort(arr, start, j) &#125; if end &gt; i &#123; quickAscendingSort(arr, i, end) &#125; &#125;&#125;//é™åºfunc quickDescendingSort(arr []int, start, end int) &#123; if (start &lt; end) &#123; i, j := start, end key := arr[(start + end)/2] for i &lt;= j &#123; for arr[i] &gt; key &#123; i++ &#125; for arr[j] &lt; key &#123; j-- &#125; if i &lt;= j &#123; arr[i], arr[j] = arr[j], arr[i] i++ j-- &#125; &#125; if start &lt; j &#123; quickDescendingSort(arr, start, j) &#125; if end &gt; i &#123; quickDescendingSort(arr, i, end) &#125; &#125;&#125; Golang é‡Œçš„é€ƒé€¸åˆ†æžæ˜¯ä»€ä¹ˆï¼Ÿæ€Žä¹ˆé¿å…å†…å­˜é€ƒé€¸ï¼Ÿ é…ç½®ä¸­å¿ƒå¦‚ä½•ä¿è¯ä¸€è‡´æ€§ï¼Ÿ Golang çš„GCè§¦å‘æ—¶æœºæ˜¯ä»€ä¹ˆ? Redis é‡Œæ•°æ®ç»“æž„çš„å®žçŽ°ç†Ÿæ‚‰å—? Etcdçš„Raftä¸€è‡´æ€§ç®—æ³•åŽŸç†? å¾®æœåŠ¡æ¦‚å¿µ. SLBåŽŸç†. åˆ†å¸ƒå¼ä¸€ç›´æ€§åŽŸåˆ™. å¦‚ä½•ä¿è¯æœåŠ¡å®•æœºé€ æˆçš„åˆ†å¸ƒå¼æœåŠ¡èŠ‚ç‚¹å¤„ç†é—®é¢˜? æœåŠ¡å‘çŽ°æ€Žä¹ˆå®žçŽ°çš„. Goä¸­åˆ‡ç‰‡ï¼Œmapï¼Œstruct åœ¨64ä½æœºå™¨ä¸­å ç”¨å­—èŠ‚æ˜¯å¤šå°‘? åœ¨64ä½ç³»ç»Ÿä¸‹ï¼ŒGolangçš„åˆ‡ç‰‡å ç”¨å­—èŠ‚æ˜¯24ä½ï¼Œmapå’Œstructéƒ½æ˜¯8ä½. Goä¸­çš„deferå‡½æ•°ä½¿ç”¨ä¸‹é¢çš„ä¸¤ç§æƒ…å†µä¸‹ç»“æžœæ˜¯å¤šå°‘ï¼Œä¸ºä»€ä¹ˆ? 1234567a := 1defer fmt.Println(&quot;the value of a1:&quot;,a)a++defer func() &#123; fmt.Println(&quot;the value of a2:&quot;,a)&#125;() è¿è¡Œ: 12the value of a1: 1the value of a1: 2 ç¬¬ä¸€ç§æƒ…å†µï¼š 1defer fmt.Println(&quot;the value of a1:&quot;,a) deferå»¶è¿Ÿå‡½æ•°è°ƒç”¨çš„fmt.Println(a)å‡½æ•°çš„å‚æ•°å€¼åœ¨deferè¯­å¥å‡ºçŽ°æ—¶å°±å·²ç»ç¡®å®šäº†ï¼Œæ‰€ä»¥æ— è®ºåŽé¢å¦‚ä½•ä¿®æ”¹aå˜é‡éƒ½ä¸ä¼šå½±å“å»¶è¿Ÿå‡½æ•°ã€‚ ç¬¬äºŒç§æƒ…å†µ: 123defer func() &#123; fmt.Println(&quot;the value of a2:&quot;,a) &#125;() deferå»¶è¿Ÿå‡½æ•°è°ƒç”¨çš„å‡½æ•°å‚æ•°çš„å€¼åœ¨deferå®šä¹‰æ—¶å€™å°±ç¡®å®šäº†ï¼Œè€Œdeferå»¶è¿Ÿå‡½æ•°å†…éƒ¨æ‰€ä½¿ç”¨çš„å€¼éœ€è¦åœ¨è¿™ä¸ªå‡½æ•°è¿è¡Œæ—¶å€™æ‰ç¡®å®šã€‚ Golangé¢è¯•å‚è€ƒ Golangé¢è¯• Golangè°ƒåº¦]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mongodb å‘½ä»¤è¡Œç™»å½•æ“ä½œ]]></title>
    <url>%2F2019%2F04%2F11%2Fmongodb-%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C%2F</url>
    <content type="text"><![CDATA[Mac OSä¸‹è½½å®‰è£…åŠé…ç½®ä½¿ç”¨brewå¯ä»¥ç›´æŽ¥æžå®šï¼Œç®€å•æ–¹ä¾¿ï¼ 1brew install mongodb å®‰è£…å®ŒæˆåŽä¼šæç¤ºå¯åŠ¨çš„æ–¹å¼ï¼Œå®‰è£…ä½ç½®ç­‰ç­‰ä¿¡æ¯ã€‚ å®‰è£…å®Œæˆ å®‰è£…å®ŒæˆåŽï¼ŒæŒ‰ç…§æç¤ºå¯åŠ¨MongoDBï¼š 1mongod --config /usr/local/etc/mongod.conf é…ç½®æ–‡ä»¶å·²ä¿®æ”¹fork=trueï¼Œå› æ­¤å¯åŠ¨åŽå°†ä»¥åŽå°è¿›ç¨‹æ–¹å¼å­˜åœ¨ã€‚ MongoDBå¯åŠ¨ ç»ˆç«¯è¾“å…¥mongoè¿žæŽ¥MongoDBæ•°æ®åº“(é»˜è®¤è¿žæŽ¥æœ¬æœºçš„27017ç«¯å£) 1mongo å®¢æˆ·ç«¯è¿žæŽ¥ é…ç½®æ–‡ä»¶MongoDBå¼•å…¥ä¸€ä¸ªYAML-basedæ ¼å¼çš„é…ç½®æ–‡ä»¶ã€‚ çŽ°åœ¨çš„é…ç½®æ–‡ä»¶/usr/local/etc/mongod.confæ˜¾ç¤ºå¦‚ä¸‹ï¼š 12345678910111213141516171819# æ—¥å¿—systemLog:# æ—¥å¿—ä¸ºæ–‡ä»¶ destination: file# æ–‡ä»¶ä½ç½® path: /usr/local/var/log/mongodb/mongo.log# æ˜¯å¦è¿½åŠ  logAppend: true#è¿›ç¨‹processManagement:# å®ˆæŠ¤è¿›ç¨‹æ–¹å¼ fork: truestorage: dbPath: /usr/local/var/mongodbnet:# ç»‘å®šIPï¼Œé»˜è®¤127.0.0.1ï¼Œåªèƒ½æœ¬æœºè®¿é—® bindIp: 127.0.0.1# ç«¯å£ port: 27017 CentOS 7 å®‰è£…MongoDBè¯¦ç»†æ­¥éª¤åˆ›å»º/etc/yum.repos.d/mongodb-org-4.0.repoæ–‡ä»¶ï¼Œç¼–è¾‘å†…å®¹å¦‚ä¸‹ï¼š 123456[mongodb-org-4.0]name=MongoDB Repositorybaseurl=https://repo.mongodb.org/yum/redhat/$releasever/mongodb-org/4.0/x86_64/gpgcheck=1enabled=1gpgkey=https://www.mongodb.org/static/pgp/server-4.0.asc è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…æœ€æ–°ç‰ˆçš„mongodbï¼š 1sudo yum install -y mongodb-org é…ç½®mongod.confå…è®¸è¿œç¨‹è¿žæŽ¥ï¼š 1234$ vim /etc/mongod.conf# Listen to all ip addressbind_ip = 0.0.0.0 å¯åŠ¨mongodbï¼š 1sudo service mongod start åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·ï¼š 123456789$ mongo&gt;use admin db.createUser( &#123; user: &quot;myUserAdmin&quot;, pwd: &quot;abc123&quot;, roles: [ &#123; role: &quot;userAdminAnyDatabase&quot;, db: &quot;admin&quot; &#125;, &quot;readWriteAnyDatabase&quot; ] &#125; ) å¯ç”¨æƒé™ç®¡ç†ï¼š 12345$ vim /etc/mongod.conf#security security: authorization: enabled é‡å¯mongodbï¼š 1sudo service mongod restart Mongodb ç”¨æˆ·éªŒè¯ç™»é™†å¯åŠ¨å¸¦è®¿é—®æŽ§åˆ¶çš„ Mongodb æ–°å»ºç»ˆç«¯ 1mongod --auth --port 27017 --dbpath /data/db1 çŽ°åœ¨æœ‰ä¸¤ç§æ–¹å¼è¿›è¡Œç”¨æˆ·èº«ä»½çš„éªŒè¯ ç¬¬ä¸€ç§ ï¼ˆç±»ä¼¼ MySqlï¼‰ å®¢æˆ·ç«¯è¿žæŽ¥æ—¶ï¼ŒæŒ‡å®šç”¨æˆ·åï¼Œå¯†ç ï¼Œdbåç§° 1mongo --port 27017 -u &quot;adminUser&quot; -p &quot;adminPass&quot; --authenticationDatabase &quot;admin&quot; ç¬¬äºŒç§ å®¢æˆ·ç«¯è¿žæŽ¥åŽï¼Œå†è¿›è¡ŒéªŒè¯ 123456mongo --port 27017use admindb.auth(&quot;adminUser&quot;, &quot;adminPass&quot;)// è¾“å‡º 1 è¡¨ç¤ºéªŒè¯æˆåŠŸ åˆ›å»ºæ™®é€šç”¨æˆ·è¿‡ç¨‹ç±»ä¼¼åˆ›å»ºç®¡ç†å‘˜è´¦æˆ·ï¼Œåªæ˜¯ role æœ‰æ‰€ä¸åŒ 12345678910use foodb.createUser( &#123; user: &quot;simpleUser&quot;, pwd: &quot;simplePass&quot;, roles: [ &#123; role: &quot;readWrite&quot;, db: &quot;foo&quot; &#125;, &#123; role: &quot;read&quot;, db: &quot;bar&quot; &#125; ] &#125;) çŽ°åœ¨æˆ‘ä»¬æœ‰äº†ä¸€ä¸ªæ™®é€šç”¨æˆ· ç”¨æˆ·åï¼šsimpleUser å¯†ç ï¼šsimplePass æƒé™ï¼šè¯»å†™æ•°æ®åº“ fooï¼Œ åªè¯»æ•°æ®åº“ barã€‚ æ³¨æ„ NOTE WARN use fooè¡¨ç¤ºç”¨æˆ·åœ¨ foo åº“ä¸­åˆ›å»ºï¼Œå°±ä¸€å®šè¦ foo åº“éªŒè¯èº«ä»½ï¼Œå³ç”¨æˆ·çš„ä¿¡æ¯è·Ÿéšéšæ•°æ®åº“ã€‚æ¯”å¦‚ä¸Šè¿° simpleUser è™½ç„¶æœ‰ bar åº“çš„è¯»å–æƒé™ï¼Œä½†æ˜¯ä¸€å®šè¦å…ˆåœ¨ foo åº“è¿›è¡Œèº«ä»½éªŒè¯ï¼Œç›´æŽ¥è®¿é—®ä¼šæç¤ºéªŒè¯å¤±è´¥ã€‚ 12345use foodb.auth(&quot;simpleUser&quot;, &quot;simplePass&quot;)use barshow collections è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œå¦‚æžœ admin åº“æ²¡æœ‰ä»»ä½•ç”¨æˆ·çš„è¯ï¼Œå³ä½¿åœ¨å…¶ä»–æ•°æ®åº“ä¸­åˆ›å»ºäº†ç”¨æˆ·ï¼Œå¯ç”¨èº«ä»½éªŒè¯ï¼Œé»˜è®¤çš„è¿žæŽ¥æ–¹å¼ä¾ç„¶ä¼šæœ‰è¶…çº§æƒé™]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Scrapy è§£å†³URLè¢«é‡å®šå‘æ— æ³•æŠ“å–åˆ°æ•°æ®é—®é¢˜301å’Œ302]]></title>
    <url>%2F2019%2F04%2F10%2FScrapy-%E8%A7%A3%E5%86%B3URL%E8%A2%AB%E9%87%8D%E5%AE%9A%E5%90%91%E6%97%A0%E6%B3%95%E6%8A%93%E5%8F%96%E5%88%B0%E6%95%B0%E6%8D%AE%E9%97%AE%E9%A2%98301%E5%92%8C302%2F</url>
    <content type="text"><![CDATA[1.ä»€ä¹ˆæ˜¯çŠ¶æ€ç 301,302 301 Moved Permanentlyï¼ˆæ°¸ä¹…é‡å®šå‘ï¼‰ è¢«è¯·æ±‚çš„èµ„æºå·²æ°¸ä¹…ç§»åŠ¨åˆ°æ–°ä½ç½®ï¼Œå¹¶ä¸”å°†æ¥ä»»ä½•å¯¹æ­¤èµ„æºçš„å¼•ç”¨éƒ½åº”è¯¥ä½¿ç”¨æœ¬å“åº”è¿”å›žçš„è‹¥å¹²ä¸ªURIä¹‹ä¸€ã€‚ è§£å†³ï¼ˆä¸€ï¼‰ 1.åœ¨Requestä¸­å°†scrapyçš„dont_filter=Trueï¼Œå› ä¸ºscrapyæ˜¯é»˜è®¤è¿‡æ»¤æŽ‰é‡å¤çš„è¯·æ±‚URLï¼Œæ·»åŠ ä¸Šå‚æ•°ä¹‹åŽå³ä½¿è¢«é‡å®šå‘äº†ä¹Ÿèƒ½è¯·æ±‚åˆ°æ­£å¸¸çš„æ•°æ®äº† exampleRequest(url, callback=self.next_parse, dont_filter=True)è§£å†³ï¼ˆäºŒï¼‰ åœ¨scrapyæ¡†æž¶ä¸­çš„ settings.pyæ–‡ä»¶é‡Œæ·»åŠ  HTTPERROR_ALLOWED_CODES = [301]è§£å†³ï¼ˆä¸‰ï¼‰ ä½¿ç”¨requestsæ¨¡å—é‡åˆ°301å’Œ302é—®é¢˜æ—¶ def website(): â€˜urlâ€™ headers = {â€˜Acceptâ€™: â€˜text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,/;q=0.8â€™, â€˜Accept-Encodingâ€™: â€˜gzip, deflate, sdch, brâ€™, â€˜Accept-Languageâ€™: â€˜zh-CN,zh;q=0.8â€™, â€˜Connectionâ€™: â€˜keep-aliveâ€™, â€˜Hostâ€™: â€˜pan.baidu.comâ€™, â€˜Upgrade-Insecure-Requestsâ€™: â€˜1â€™, â€˜User-Agentâ€™: â€˜Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.87 Safari/537.36â€™} url = &apos;https://www.baidu.com/&apos; html = requests.get(url, headers=headers, allow_redirects=False) return html.headers[&apos;Location&apos;] allow_redirects=Falseçš„æ„ä¹‰ä¸ºæ‹’ç»é»˜è®¤çš„301/302é‡å®šå‘ä»Žè€Œå¯ä»¥é€šè¿‡html.headers[â€˜Locationâ€™]æ‹¿åˆ°é‡å®šå‘çš„URLã€‚]]></content>
      <categories>
        <category>Scrapy</category>
      </categories>
      <tags>
        <tag>Scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[scrapy æºç åˆ†æžä¹‹retryä¸­é—´ä»¶ä¸Žåº”ç”¨]]></title>
    <url>%2F2019%2F03%2F29%2Fscrapy-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8Bretry%E4%B8%AD%E9%97%B4%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[è¿™æ¬¡è®©æˆ‘ä»¬åˆ†æžscrapyé‡è¯•æœºåˆ¶çš„æºç ï¼Œå­¦ä¹ å…¶ä¸­çš„æ€æƒ³ï¼Œç¼–å†™å®šåˆ¶åŒ–middleware,æ•æ‰çˆ¬å–å¤±è´¥çš„URLç­‰ä¿¡æ¯ã€‚ scrapyç®€ä»‹Scrapyæ˜¯ä¸€ä¸ªä¸ºäº†çˆ¬å–ç½‘ç«™æ•°æ®ï¼Œæå–ç»“æž„æ€§æ•°æ®è€Œç¼–å†™çš„åº”ç”¨æ¡†æž¶ã€‚ å¯ä»¥åº”ç”¨åœ¨åŒ…æ‹¬æ•°æ®æŒ–æŽ˜ï¼Œä¿¡æ¯å¤„ç†æˆ–å­˜å‚¨åŽ†å²æ•°æ®ç­‰ä¸€ç³»åˆ—çš„ç¨‹åºä¸­ã€‚ å…¶æœ€åˆæ˜¯ä¸ºäº† é¡µé¢æŠ“å– (æ›´ç¡®åˆ‡æ¥è¯´, ç½‘ç»œæŠ“å– )æ‰€è®¾è®¡çš„ï¼Œ ä¹Ÿå¯ä»¥åº”ç”¨åœ¨èŽ·å–APIæ‰€è¿”å›žçš„æ•°æ®(ä¾‹å¦‚ Amazon Associates Web Services ) æˆ–è€…é€šç”¨çš„ç½‘ç»œçˆ¬è™«ã€‚ ä¸€å¼ å›¾å¯çœ‹æ¸…æ¥šscrapyä¸­æ•°æ®çš„æµå‘ï¼š ç®€å•äº†è§£ä¸€ä¸‹å„ä¸ªéƒ¨åˆ†çš„åŠŸèƒ½ï¼Œå¯ä»¥çœ‹ä¸‹é¢ç®€åŒ–ç‰ˆæ•°æ®æµï¼š æ€»æœ‰æ¼ç½‘ä¹‹é±¼ä¸ç®¡ä½ çš„ä¸»æœºé…ç½®å¤šä¹ˆåŠç‚¸å¤©ï¼Œè¿˜æ˜¯ç½‘é€Ÿå¤šä¹ˆç»™åŠ›ï¼Œåœ¨scrapyçš„å¤§è§„æ¨¡ä»»åŠ¡ä¸­ï¼Œæœ€ç»ˆçˆ¬å–çš„itemæ•°é‡éƒ½ä¸ä¼šç­‰äºŽæœŸæœ›çˆ¬å–çš„æ•°é‡ï¼Œä¹Ÿå°±æ˜¯è¯´æ€»æœ‰é‚£ä¹ˆä¸€äº›çˆ¬å–å¤±è´¥çš„æ¼ç½‘ä¹‹é±¼ï¼Œé€šè¿‡åˆ†æžscrapyçš„æ—¥å¿—ï¼Œå¯ä»¥çŸ¥é“é€ æˆå¤±è´¥çš„åŽŸå› æœ‰ä»¥ä¸‹ä¸¤ç§æƒ…å†µï¼š exception_count httperror ä»¥ä¸Šçš„ä¸ç®¡æ˜¯exceptionè¿˜æ˜¯httperror, scrapyä¸­éƒ½æœ‰å¯¹åº”çš„retryæœºåˆ¶ï¼Œåœ¨settings.pyæ–‡ä»¶ä¸­æˆ‘ä»¬å¯ä»¥è®¾ç½®æœ‰å…³é‡è¯•çš„å‚æ•°ï¼Œç­‰è¿è¡Œé‡åˆ°å¼‚å¸¸å’Œé”™è¯¯æ—¶å€™ï¼Œscrapyå°±ä¼šè‡ªåŠ¨å¤„ç†è¿™äº›é—®é¢˜ï¼Œå…¶ä¸­æœ€å…³é”®çš„éƒ¨åˆ†å°±æ˜¯é‡è¯•ä¸­é—´ä»¶ï¼Œä¸‹é¢è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹scrapyçš„retry middlewareã€‚ RetryMiddleæºç åˆ†æžåœ¨scrapyé¡¹ç›®çš„middlewares.pyæ–‡ä»¶ä¸­ æ•²å¦‚ä¸‹ä»£ç ï¼š 1from scrapy.downloadermiddlewares.retry import RetryMiddleware æŒ‰ä½ctrlé”®ï¼ˆMacæ˜¯commandé”®ï¼‰ï¼Œé¼ æ ‡å·¦é”®ç‚¹å‡»RetryMiddlewareè¿›å…¥è¯¥ä¸­é—´ä»¶æ‰€åœ¨çš„é¡¹ç›®æ–‡ä»¶çš„ä½ç½®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡æŸ¥çœ‹æ–‡ä»¶çš„å½¢å¼æ‰¾åˆ°è¯¥è¯¥ä¸­é—´ä»¶çš„ä½ç½®ï¼Œè·¯å¾„æ˜¯ï¼š 1site-packages/scrapy/downloadermiddlewares/retry.RetryMiddleware æºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364class RetryMiddleware(object): # IOError is raised by the HttpCompression middleware when trying to # decompress an empty response # éœ€è¦é‡è¯•çš„å¼‚å¸¸çŠ¶æ€ï¼Œå¯ä»¥çœ‹å‡ºï¼Œå…¶ä¸­æœ‰äº›æ˜¯ä¸Šé¢logä¸­çš„å¼‚å¸¸ EXCEPTIONS_TO_RETRY = (defer.TimeoutError, TimeoutError, DNSLookupError, ConnectionRefusedError, ConnectionDone, ConnectError, ConnectionLost, TCPTimedOutError, ResponseFailed, IOError, TunnelError) def __init__(self, settings): # è¯»å– settings.py ä¸­å…³äºŽé‡è¯•çš„é…ç½®ä¿¡æ¯ï¼Œå¦‚æžœæ²¡æœ‰é…ç½®é‡è¯•çš„è¯ï¼Œç›´æŽ¥è·³è¿‡ if not settings.getbool('RETRY_ENABLED'): raise NotConfigured self.max_retry_times = settings.getint('RETRY_TIMES') self.retry_http_codes = set(int(x) for x in settings.getlist('RETRY_HTTP_CODES')) self.priority_adjust = settings.getint('RETRY_PRIORITY_ADJUST') @classmethod def from_crawler(cls, crawler): return cls(crawler.settings)# å¦‚æžœresponseçš„çŠ¶æ€ç ï¼Œæ˜¯æˆ‘ä»¬è¦é‡è¯•çš„ def process_response(self, request, response, spider): if request.meta.get('dont_retry', False): return response if response.status in self.retry_http_codes: reason = response_status_message(response.status) return self._retry(request, reason, spider) or response return response# å‡ºçŽ°äº†éœ€è¦é‡è¯•çš„å¼‚å¸¸çŠ¶æ€ï¼Œ def process_exception(self, request, exception, spider): if isinstance(exception, self.EXCEPTIONS_TO_RETRY) \ and not request.meta.get('dont_retry', False): return self._retry(request, exception, spider)# é‡è¯•æ“ä½œ def _retry(self, request, reason, spider): retries = request.meta.get('retry_times', 0) + 1 retry_times = self.max_retry_times if 'max_retry_times' in request.meta: retry_times = request.meta['max_retry_times'] stats = spider.crawler.stats if retries &lt;= retry_times: logger.debug("Retrying %(request)s (failed %(retries)d times): %(reason)s", &#123;'request': request, 'retries': retries, 'reason': reason&#125;, extra=&#123;'spider': spider&#125;) retryreq = request.copy() retryreq.meta['retry_times'] = retries retryreq.dont_filter = True retryreq.priority = request.priority + self.priority_adjust if isinstance(reason, Exception): reason = global_object_name(reason.__class__) stats.inc_value('retry/count') stats.inc_value('retry/reason_count/%s' % reason) return retryreq else: stats.inc_value('retry/max_reached') logger.debug("Gave up retrying %(request)s (failed %(retries)d times): %(reason)s", &#123;'request': request, 'retries': retries, 'reason': reason&#125;, extra=&#123;'spider': spider&#125;) æŸ¥çœ‹æºç æˆ‘ä»¬å¯ä»¥å‘çŽ°ï¼Œå¯¹äºŽè¿”å›žhttp codeçš„responseï¼Œè¯¥ä¸­é—´ä»¶ä¼šé€šè¿‡process_responseæ–¹æ³•æ¥å¤„ç†ï¼Œå¤„ç†åŠžæ³•æ¯”è¾ƒç®€å•ï¼Œåˆ¤æ–­response.statusæ˜¯å¦åœ¨retry_http_codesé›†åˆä¸­ï¼Œè¿™ä¸ªé›†åˆæ˜¯è¯»å–çš„é…ç½®æ–‡ä»¶ï¼š 123RETRY_ENABLED = True # é»˜è®¤å¼€å¯å¤±è´¥é‡è¯•ï¼Œä¸€èˆ¬å…³é—­RETRY_TIMES = 3 # å¤±è´¥åŽé‡è¯•æ¬¡æ•°ï¼Œé»˜è®¤ä¸¤æ¬¡RETRY_HTTP_CODES = [500, 502, 503, 504, 522, 524, 408] # ç¢°åˆ°è¿™äº›éªŒè¯ç ï¼Œæ‰å¼€å¯é‡è¯• å¯¹äºŽhttperrorçš„å¤„ç†ä¹Ÿæ˜¯åŒæ ·çš„é“ç†ï¼Œå®šä¹‰äº†ä¸€ä¸ª EXCEPTIONS_TO_RETRYçš„åˆ—è¡¨ï¼Œé‡Œé¢å­˜æ”¾æ‰€æœ‰çš„å¼‚å¸¸ç±»åž‹ï¼Œç„¶åŽåˆ¤æ–­ä¼ å…¥çš„å¼‚å¸¸æ˜¯å¦å­˜åœ¨äºŽè¯¥é›†åˆä¸­ï¼Œå¦‚æžœåœ¨å°±è¿›å…¥retryé€»è¾‘ï¼Œä¸åœ¨å°±å¿½ç•¥ã€‚ æºç æ€æƒ³çš„åº”ç”¨äº†è§£scrapyå¦‚ä½•å¤„ç†å¼‚å¸¸åŽï¼Œå°±å¯ä»¥åˆ©ç”¨è¿™ç§æ€æƒ³ï¼Œå†™ä¸€ä¸ªmiddlewareï¼Œå¯¹çˆ¬å–å¤±è´¥çš„æ¼ç½‘ä¹‹é±¼è¿›è¡Œæ•èŽ·ï¼Œæ–¹ä¾¿ä»¥åŽåšè¡¥çˆ¬ã€‚ åœ¨middlewares.pyä¸­ from scrapy.downloadermiddlewares.retry import RetryMiddleware, å†™ä¸€ä¸ªclassï¼Œç»§æ‰¿è‡ªRetryMiddlewareï¼› å¯¹çˆ¶ç±»çš„process_response()å’Œprocess_exception()æ–¹æ³•è¿›è¡Œé‡å†™ï¼› å°†è¯¥middlewareåŠ å…¥setting.py; æ³¨æ„äº‹é¡¹ï¼šè¯¥ä¸­é—´ä»¶çš„Order_codeä¸èƒ½è¿‡å¤§ï¼Œå¦‚æžœè¿‡å¤§å°±ä¼šè¶ŠæŽ¥è¿‘ä¸‹è½½å™¨ï¼Œå°±ä¼šä¼˜å…ˆäºŽRetryMiddlewareå¤„ç†responseï¼Œä½†è¿™ä¸ªä¸­é—´ä»¶æ˜¯ç”¨æ¥å¤„ç†æœ€ç»ˆçš„é”™è¯¯çš„ï¼Œå³å½“ä¸€ä¸ªresponse 500è¿›å…¥ä¸­é—´ä»¶é“¾è·¯æ—¶ï¼Œéœ€è¦å…ˆç»è¿‡retryä¸­é—´ä»¶å¤„ç†ï¼Œä¸èƒ½å…ˆç”±æˆ‘ä»¬å†™çš„ä¸­é—´ä»¶æ¥å¤„ç†ï¼Œå®ƒä¸å…·æœ‰retryçš„åŠŸèƒ½ï¼ŒæŽ¥æ”¶åˆ°500çš„responseå°±ç›´æŽ¥æ”¾å¼ƒæŽ‰è¯¥requestç›´æŽ¥returnäº†ï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚åªæœ‰ç»è¿‡retryåŽä»ç„¶æœ‰å¼‚å¸¸çš„requestæ‰åº”å½“ç”±æˆ‘ä»¬å†™çš„ä¸­é—´ä»¶æ¥å¤„ç†ï¼Œè¿™æ—¶å€™ä½ æƒ³æ€Žä¹ˆå¤„ç†éƒ½å¯ä»¥ï¼Œæ¯”å¦‚å†æ¬¡retryã€returnä¸€ä¸ªé‡æ–°æž„é€ çš„responseï¼Œä½†æ˜¯å¦‚æžœä½ ä¸ºäº†åŠ å¿«çˆ¬è™«é€Ÿåº¦ï¼Œä¸è®¾ç½®retryä¹Ÿæ˜¯å¯ä»¥çš„ã€‚ Talk is cheap, show the code: 1234567891011121314151617181920class GetFailedUrl(RetryMiddleware): def __init__(self, settings): self.max_retry_times = settings.getint('RETRY_TIMES') self.retry_http_codes = set(int(x) for x in settings.getlist('RETRY_HTTP_CODES')) self.priority_adjust = settings.getint('RETRY_PRIORITY_ADJUST') def process_response(self, request, response, spider): if response.status in self.retry_http_codes: # å°†çˆ¬å–å¤±è´¥çš„URLå­˜ä¸‹æ¥ï¼Œä½ ä¹Ÿå¯ä»¥å­˜åˆ°åˆ«çš„å­˜å‚¨ with open(str(spider.name) + ".txt", "a") as f: f.write(response.url + "\n") return response return response def process_exception(self, request, exception, spider): # å‡ºçŽ°å¼‚å¸¸çš„å¤„ç† if isinstance(exception, self.EXCEPTIONS_TO_RETRY): with open(str(spider.name) + ".txt", "a") as f: f.write(str(request) + "\n") return None setting.pyä¸­æ·»åŠ è¯¥ä¸­é—´ä»¶ï¼š 12345DOWNLOADER_MIDDLEWARES = &#123; 'myspider.middlewares.TabelogDownloaderMiddleware': 543, 'myspider.middlewares.RandomProxy': 200, 'myspider.middlewares.GetFailedUrl': 220,&#125; ä¸ºäº†æµ‹è¯•ï¼Œæˆ‘ä»¬æ•…æ„å†™é”™URLï¼Œæˆ–è€…å°†download_delayç¼©çŸ­ï¼Œå°±ä¼šå‡ºçŽ°å„ç§å¼‚å¸¸ï¼Œä½†æ˜¯æˆ‘ä»¬çŽ°åœ¨èƒ½å¤Ÿæ•èŽ·å®ƒä»¬äº†ï¼š]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>scrapy</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Go Modulesä½¿ç”¨æ–¹æ³•]]></title>
    <url>%2F2019%2F03%2F29%2FGo-Modules%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%2F</url>
    <content type="text"><![CDATA[Go Modulesä½¿ç”¨æ•™ç¨‹å¼•å…¥https://talks.godoc.org/github.com/myitcv/talks/2018-08-15-glug-modules/main.slide#1 Go Modulesä»‹ç»Modulesæ˜¯Go 1.11ä¸­æ–°å¢žçš„å®žéªŒæ€§åŠŸèƒ½ï¼ŒåŸºäºŽvgoæ¼”å˜è€Œæ¥ï¼Œæ˜¯ä¸€ä¸ªæ–°åž‹çš„åŒ…ç®¡ç†å·¥å…·ã€‚ å¸¸è§çš„åŒ…ç®¡ç†å·¥å…· govendor dep glide godep è¿™äº›åŒ…ç®¡ç†å·¥å…·éƒ½æ˜¯åŸºäºŽGOPATHæˆ–è€…vendorç›®å½•ï¼Œå¹¶ä¸èƒ½å¾ˆå¥½çš„è§£å†³ä¸åŒç‰ˆæœ¬ä¾èµ–é—®é¢˜ã€‚Modulesæ˜¯åœ¨GOPATHä¹‹å¤–ä¸€å¥—æ–°çš„åŒ…ç®¡ç†æ–¹å¼ã€‚ å¦‚ä½•æ¿€æ´»Modulesé¦–å…ˆè¦æŠŠgoå‡çº§åˆ°1.11ã€‚ å‡çº§åŽï¼Œå¯ä»¥è®¾ç½®é€šè¿‡ä¸€ä¸ªçŽ¯å¢ƒå˜é‡GO111MODULEæ¥æ¿€æ´»modulesï¼š GO111MODULE=offï¼Œgoå‘½ä»¤è¡Œå°†ä¸ä¼šæ”¯æŒmoduleåŠŸèƒ½ï¼Œå¯»æ‰¾ä¾èµ–åŒ…çš„æ–¹å¼å°†ä¼šæ²¿ç”¨æ—§ç‰ˆæœ¬é‚£ç§é€šè¿‡vendorç›®å½•æˆ–è€…GOPATHæ¨¡å¼æ¥æŸ¥æ‰¾ã€‚ GO111MODULE=onï¼Œgoå‘½ä»¤è¡Œä¼šä½¿ç”¨modulesï¼Œè€Œä¸€ç‚¹ä¹Ÿä¸ä¼šåŽ»GOPATHç›®å½•ä¸‹æŸ¥æ‰¾ã€‚ GO111MODULE=autoï¼Œé»˜è®¤å€¼ï¼Œgoå‘½ä»¤è¡Œå°†ä¼šæ ¹æ®å½“å‰ç›®å½•æ¥å†³å®šæ˜¯å¦å¯ç”¨moduleåŠŸèƒ½ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥åˆ†ä¸ºä¸¤ç§æƒ…å½¢ï¼šå½“å‰ç›®å½•åœ¨GOPATH/srcä¹‹å¤–ä¸”è¯¥ç›®å½•åŒ…å«go.modæ–‡ä»¶ï¼Œæˆ–è€…å½“å‰æ–‡ä»¶åœ¨åŒ…å«go.modæ–‡ä»¶çš„ç›®å½•ä¸‹é¢ã€‚ å½“moduleåŠŸèƒ½å¯ç”¨æ—¶ï¼ŒGOPATHåœ¨é¡¹ç›®æž„å»ºè¿‡ç¨‹ä¸­ä¸å†æ‹…å½“importçš„è§’è‰²ï¼Œä½†å®ƒä»ç„¶å­˜å‚¨ä¸‹è½½çš„ä¾èµ–åŒ…ï¼Œå…·ä½“ä½ç½®åœ¨$GOPATH/pkg/modã€‚ åˆå§‹åŒ–ModulesGo1.11æ–°å¢žäº†å‘½ä»¤go modæ¥æ”¯æŒModulesçš„ä½¿ç”¨ã€‚ 123456789101112131415161718192021222324&gt; go help modGo mod provides access to operations on modules.Note that support for modules is built into all the go commands,not just &apos;go mod&apos;. For example, day-to-day adding, removing, upgrading,and downgrading of dependencies should be done using &apos;go get&apos;.See &apos;go help modules&apos; for an overview of module functionality.Usage: go mod &lt;command&gt; [arguments]The commands are: download download modules to local cache edit edit go.mod from tools or scripts graph print module requirement graph init initialize new module in current directory tidy add missing and remove unused modules vendor make vendored copy of dependencies verify verify dependencies have expected content why explain why packages or modules are neededUse &quot;go help mod &lt;command&gt;&quot; for more information about a command. é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®helloworldï¼š 1cd &amp;&amp; mkdir helloworld &amp;&amp; cd helloworld ç„¶åŽåˆ›å»ºæ–‡ä»¶main.goå¹¶å†™å…¥ï¼š 1234567891011package mainimport ( log &quot;github.com/sirupsen/logrus&quot;)func main() &#123; log.WithFields(log.Fields&#123; &quot;animal&quot;: &quot;walrus&quot;, &#125;).Info(&quot;A walrus appears&quot;)&#125; åˆå§‹åŒ–mod: 1go mod init helloworld ç³»ç»Ÿç”Ÿæˆäº†ä¸€ä¸ªgo.modçš„æ–‡ä»¶ï¼š 1module helloworld ç„¶åŽæ‰§è¡Œgo buildï¼Œå†æ¬¡æŸ¥çœ‹go.modæ–‡ä»¶å‘çŽ°å¤šäº†ä¸€äº›å†…å®¹ï¼š 123module helloworldrequire github.com/sirupsen/logrus v1.1.1 åŒæ—¶å¤šäº†ä¸€ä¸ªgo.sumçš„æ–‡ä»¶ï¼š 12345678910github.com/davecgh/go-spew v1.1.1/go.mod h1:J7Y8YcW2NihsgmVo/mv3lAwl/skON4iLHjSsI+c5H38=github.com/konsorten/go-windows-terminal-sequences v0.0.0-20180402223658-b729f2633dfe/go.mod h1:T0+1ngSBFLxvqU3pZ+m/2kptfBszLMUkC4ZK/EgS/cQ=github.com/pmezard/go-difflib v1.0.0/go.mod h1:iKH77koFhYxTK1pcRnkKkqfTogsbg7gZNVY4sRDYZ/4=github.com/sirupsen/logrus v1.1.1 h1:VzGj7lhU7KEB9e9gMpAV/v5XT2NVSvLJhJLCWbnkgXg=github.com/sirupsen/logrus v1.1.1/go.mod h1:zrgwTnHtNr00buQ1vSptGe8m1f/BbgsPukg8qsT7A+A=github.com/stretchr/testify v1.2.2/go.mod h1:a8OnRcib4nhh0OaRAV+Yts87kKdq0PP7pXfy6kDkUVs=golang.org/x/crypto v0.0.0-20180904163835-0709b304e793 h1:u+LnwYTOOW7Ukr/fppxEb1Nwz0AtPflrblfvUudpo+I=golang.org/x/crypto v0.0.0-20180904163835-0709b304e793/go.mod h1:6SG95UA2DQfeDnfUPMdvaQW0Q7yPrPDi9nlGo2tz2b4=golang.org/x/sys v0.0.0-20180905080454-ebe1bf3edb33 h1:I6FyU15t786LL7oL/hn43zqTuEGr4PN7F4XJ1p4E3Y8=golang.org/x/sys v0.0.0-20180905080454-ebe1bf3edb33/go.mod h1:STP8DvDyc/dI5b8T5hshtkjS+E42TnysNCUPdjciGhY= go.sumä¸æ˜¯ä¸€ä¸ªé”æ–‡ä»¶ï¼Œæ˜¯ä¸€ä¸ªæ¨¡å—ç‰ˆæœ¬å†…å®¹çš„æ ¡éªŒå€¼ï¼Œç”¨æ¥éªŒè¯å½“å‰ç¼“å­˜çš„æ¨¡å—ã€‚go.sumåŒ…å«äº†ç›´æŽ¥ä¾èµ–å’Œé—´æŽ¥ä¾èµ–çš„åŒ…çš„ä¿¡æ¯ï¼Œæ¯”go.modè¦å¤šä¸€äº›ã€‚ go.modæœ‰å››ç§æŒ‡ä»¤ï¼šmoduleï¼Œrequireï¼Œexcludeï¼Œreplaceã€‚ moduleï¼šæ¨¡å—åç§° requireï¼šä¾èµ–åŒ…åˆ—è¡¨ä»¥åŠç‰ˆæœ¬ excludeï¼šç¦æ­¢ä¾èµ–åŒ…åˆ—è¡¨ï¼ˆä»…åœ¨å½“å‰æ¨¡å—ä¸ºä¸»æ¨¡å—æ—¶ç”Ÿæ•ˆï¼‰ replaceï¼šæ›¿æ¢ä¾èµ–åŒ…åˆ—è¡¨ ï¼ˆä»…åœ¨å½“å‰æ¨¡å—ä¸ºä¸»æ¨¡å—æ—¶ç”Ÿæ•ˆï¼‰ å…¶ä»–å‘½ä»¤123456go mod tidy //æ‹‰å–ç¼ºå°‘çš„æ¨¡å—ï¼Œç§»é™¤ä¸ç”¨çš„æ¨¡å—ã€‚go mod download //ä¸‹è½½ä¾èµ–åŒ…go mod graph //æ‰“å°æ¨¡å—ä¾èµ–å›¾go mod vendor //å°†ä¾èµ–å¤åˆ¶åˆ°vendorä¸‹go mod verify //æ ¡éªŒä¾èµ–go mod why //è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦ä¾èµ– 1go list -m -json all //ä¾èµ–è¯¦æƒ…]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>Golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Pythonçš„map/reduce/filter]]></title>
    <url>%2F2019%2F03%2F27%2FPython%E7%9A%84map-reduce-filter%2F</url>
    <content type="text"><![CDATA[è½¬è½½è‡ªexplore_python http://funhacks.net/explore-python/Functional/map_reduce_filter.html]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangçš„å¤šæ€å®žçŽ°]]></title>
    <url>%2F2019%2F03%2F18%2Fgolang%E7%9A%84%E5%A4%9A%E6%80%81%E5%AE%9E%E7%8E%B0%2F</url>
    <content type="text"><![CDATA[å¤šæ€ï¼ˆpolymorphismï¼‰å¤šæ€æ˜¯æŽ¥å£çš„ä¸€ä¸ªå…³é”®åŠŸèƒ½å’ŒGoè¯­è¨€çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§ã€‚ å½“éžæŽ¥å£ç±»åž‹Tçš„ä¸€ä¸ªå€¼tè¢«åŒ…è£¹åœ¨æŽ¥å£ç±»åž‹Içš„ä¸€ä¸ªæŽ¥å£å€¼iä¸­ï¼Œé€šè¿‡iè°ƒç”¨æŽ¥å£ç±»åž‹IæŒ‡å®šçš„ä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œäº‹å®žä¸Šä¸ºéžæŽ¥å£ç±»åž‹Tå£°æ˜Žçš„å¯¹åº”æ–¹æ³•å°†é€šè¿‡éžæŽ¥å£å€¼tè¢«è°ƒç”¨ã€‚ æ¢å¥è¯è¯´ï¼Œè°ƒç”¨ä¸€ä¸ªæŽ¥å£å€¼çš„æ–¹æ³•å®žé™…ä¸Šå°†è°ƒç”¨æ­¤æŽ¥å£å€¼çš„åŠ¨æ€å€¼çš„å¯¹åº”æ–¹æ³•ã€‚ æ¯”å¦‚ï¼Œå½“æ–¹æ³•i.mè¢«è°ƒç”¨æ—¶ï¼Œå…¶å®žè¢«è°ƒç”¨çš„æ˜¯æ–¹æ³•t.mã€‚ ä¸€ä¸ªæŽ¥å£å€¼å¯ä»¥é€šè¿‡åŒ…è£¹ä¸åŒåŠ¨æ€ç±»åž‹çš„åŠ¨æ€å€¼æ¥è¡¨çŽ°å‡ºå„ç§ä¸åŒçš„è¡Œä¸ºï¼Œè¿™ç§°ä¸ºå¤šæ€ã€‚ å½“æ–¹æ³•i.mè¢«è°ƒç”¨æ—¶ï¼Œiå­˜å‚¨çš„å®žçŽ°å…³ç³»ä¿¡æ¯çš„æ–¹æ³•è¡¨ä¸­çš„æ–¹æ³•t.må°†è¢«æ‰¾åˆ°å¹¶è¢«è°ƒç”¨ã€‚ æ­¤æ–¹æ³•è¡¨æ˜¯ä¸€ä¸ªåˆ‡ç‰‡ï¼Œæ‰€ä»¥æ­¤å¯»æ‰¾è¿‡ç¨‹åªä¸è¿‡æ˜¯ä¸€ä¸ªåˆ‡ç‰‡å…ƒç´ è®¿é—®æ“ä½œï¼Œä¸ä¼šæ¶ˆè€—å¾ˆå¤šæ—¶é—´ã€‚ æ³¨æ„ï¼Œåœ¨nilæŽ¥å£å€¼ä¸Šè°ƒç”¨æ–¹æ³•å°†äº§ç”Ÿä¸€ä¸ªææ…Œï¼Œå› ä¸ºæ²¡æœ‰å…·ä½“çš„æ–¹æ³•å¯è¢«è°ƒç”¨ã€‚ ä¸€ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566package mainimport "fmt"type Filter interface &#123; About() string Process([]int) []int&#125;// UniqueFilterç”¨æ¥åˆ é™¤é‡å¤çš„æ•°å­—ã€‚type UniqueFilter struct&#123;&#125;func (UniqueFilter) About() string &#123; return "åˆ é™¤é‡å¤çš„æ•°å­—"&#125;func (UniqueFilter) Process(inputs []int) []int &#123; outs := make([]int, 0, len(inputs)) pusheds := make(map[int]bool) for _, n := range inputs &#123; if !pusheds[n] &#123; pusheds[n] = true outs = append(outs, n) &#125; &#125; return outs&#125;// MultipleFilterç”¨æ¥åªä¿ç•™æŸä¸ªæ•´æ•°çš„å€æ•°æ•°å­—ã€‚type MultipleFilter intfunc (mf MultipleFilter) About() string &#123; return fmt.Sprintf("ä¿ç•™%vçš„å€æ•°", mf)&#125;func (mf MultipleFilter) Process(inputs []int) []int &#123; var outs = make([]int, 0, len(inputs)) for _, n := range inputs &#123; if n % int(mf) == 0 &#123; outs = append(outs, n) &#125; &#125; return outs&#125;// åœ¨å¤šæ€ç‰¹æ€§çš„å¸®åŠ©ä¸‹ï¼Œåªéœ€è¦ä¸€ä¸ªfilteAndPrintå‡½æ•°ã€‚func filteAndPrint(fltr Filter, unfiltered []int) []int &#123; // åœ¨fltrå‚æ•°ä¸Šè°ƒç”¨æ–¹æ³•å…¶å®žæ˜¯è°ƒç”¨fltrçš„åŠ¨æ€å€¼çš„æ–¹æ³•ã€‚ filtered := fltr.Process(unfiltered) fmt.Println(fltr.About() + ":\n\t", filtered) return filtered&#125;func main() &#123; numbers := []int&#123;12, 7, 21, 12, 12, 26, 25, 21, 30&#125; fmt.Println("è¿‡æ»¤ä¹‹å‰ï¼š\n\t", numbers) // ä¸‰ä¸ªéžæŽ¥å£å€¼è¢«åŒ…è£¹åœ¨ä¸€ä¸ªFilteråˆ‡ç‰‡çš„ä¸‰ä¸ªæŽ¥å£å…ƒç´ ä¸­ã€‚ filters := []Filter&#123; UniqueFilter&#123;&#125;, MultipleFilter(2), MultipleFilter(3), &#125; // æ¯ä¸ªåˆ‡ç‰‡å…ƒç´ å°†è¢«èµ‹å€¼ç»™ç±»åž‹ä¸ºFilterçš„å¾ªçŽ¯å˜é‡fltrã€‚ // æ¯ä¸ªå…ƒç´ ä¸­çš„åŠ¨æ€å€¼ä¹Ÿå°†è¢«åŒæ—¶å¤åˆ¶å¹¶è¢«åŒ…è£¹åœ¨å¾ªçŽ¯å˜é‡flträ¸­ã€‚ for _, fltr := range filters &#123; numbers = filteAndPrint(fltr, numbers) &#125;&#125; è¾“å‡ºç»“æžœï¼š 12345678è¿‡æ»¤ä¹‹å‰ï¼š [12 7 21 12 12 26 25 21 30]åˆ é™¤é‡å¤çš„æ•°å­—: [12 7 21 26 25 30]ä¿ç•™2çš„å€æ•°: [12 26 30]ä¿ç•™3çš„å€æ•°: [12 30] åœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¤šæ€ä½¿å¾—æˆ‘ä»¬ä¸å¿…ä¸ºæ¯ä¸ªè¿‡æ»¤å™¨ç±»åž‹å†™ä¸€ä¸ªå•ç‹¬çš„filteAndPrintå‡½æ•°ã€‚ é™¤äº†ä¸Šè¿°è¿™ä¸ªå¥½å¤„ï¼Œå¤šæ€ä¹Ÿä½¿å¾—ä¸€ä¸ªä»£ç åŒ…çš„å¼€å‘è€…å¯ä»¥åœ¨æ­¤ä»£ç åŒ…ä¸­å£°æ˜Žä¸€ä¸ªæŽ¥å£ç±»åž‹å¹¶å£°æ˜Žä¸€ä¸ªæ‹¥æœ‰æ­¤æŽ¥å£ç±»åž‹å‚æ•°çš„å‡½æ•°ï¼ˆæˆ–è€…æ–¹æ³•ï¼‰ï¼Œä»Žè€Œæ­¤ä»£ç åŒ…çš„ä¸€ä¸ªç”¨æˆ·å¯ä»¥åœ¨ç”¨æˆ·åŒ…ä¸­å£°æ˜Žä¸€ä¸ªå®žçŽ°äº†æ­¤æŽ¥å£ç±»åž‹çš„ç”¨æˆ·ç±»åž‹ï¼Œå¹¶ä¸”å°†æ­¤ç”¨æˆ·ç±»åž‹çš„å€¼åšä¸ºå®žå‚ä¼ é€’ç»™æ­¤ä»£ç åŒ…ä¸­å£°æ˜Žçš„å‡½æ•°ï¼ˆæˆ–è€…æ–¹æ³•ï¼‰çš„è°ƒç”¨ã€‚ æ­¤ä»£ç åŒ…çš„å¼€å‘è€…å¹¶ä¸ç”¨å…³å¿ƒä¸€ä¸ªç”¨æˆ·ç±»åž‹å…·ä½“æ˜¯å¦‚ä½•å£°æ˜Žçš„ï¼Œåªè¦æ­¤ç”¨æˆ·ç±»åž‹æ»¡è¶³æ­¤ä»£ç åŒ…ä¸­å£°æ˜Žçš„æŽ¥å£ç±»åž‹è§„å®šçš„è¡Œä¸ºå³å¯ã€‚ äº‹å®žä¸Šï¼Œå¤šæ€å¯¹äºŽä¸€ä¸ªè¯­è¨€æ¥è¯´å¹¶éžä¸€ä¸ªä¸å¯æˆ–ç¼ºçš„ç‰¹æ€§ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡å…¶å®ƒé€”å¾„æ¥å®žçŽ°å¤šæ€çš„ä½œç”¨ã€‚ ä½†æ˜¯ï¼Œå¤šæ€å¯ä»¥ä½¿å¾—æˆ‘ä»¬çš„ä»£ç æ›´åŠ ç®€æ´å’Œä¼˜é›…ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysqlå…³é—­update safe mode]]></title>
    <url>%2F2019%2F03%2F11%2Fmysql%E5%85%B3%E9%97%ADupdate-safe-mode%2F</url>
    <content type="text"><![CDATA[SET SQL_SAFE_UPDATES = 0;]]></content>
      <categories>
        <category>mysql</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[git-ä¿æŒforkçš„é¡¹ç›®ä¸Žä¸Šæ¸¸åŒæ­¥]]></title>
    <url>%2F2019%2F02%2F26%2Fgit-%E4%BF%9D%E6%8C%81fork%E7%9A%84%E9%A1%B9%E7%9B%AE%E4%B8%8E%E4%B8%8A%E6%B8%B8%E5%90%8C%E6%AD%A5%2F</url>
    <content type="text"><![CDATA[æ·»åŠ ä¸Šæ¸¸ä»“åº“ï¼š git remote add upstream [upstream_url] fetch ä¹‹ï¼š git fetch upstream åˆ‡æ¢åˆ°æœ¬åœ°masteråˆ†æ”¯ï¼š git checkout master å°†upstream/master mergeåˆ° æœ¬åœ°masteråˆ†æ”¯ï¼š git merge upstream/master //å¯èƒ½ä¼šæŠ¥é”™ï¼Œå¦‚æžœæŠ¥é”™å°±æ‰§è¡Œï¼šgit pull åŒæ—¶pushåˆ°è‡ªå·±çš„githubä»“åº“ï¼š git push origin master]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è¯¦è§£Go regexpåŒ…ä¸­ ReplaceAllString çš„ç”¨æ³•]]></title>
    <url>%2F2019%2F02%2F01%2F%E8%AF%A6%E8%A7%A3Go-regexp%E5%8C%85%E4%B8%AD-ReplaceAllString-%E7%9A%84%E7%94%A8%E6%B3%95%2F</url>
    <content type="text"><![CDATA[æ˜¨å¤©æœ‰åŒäº‹åœ¨çœ‹k8sæºç ï¼Œçªç„¶é—®äº†ä¸€ä¸ªçœ‹ä¼¼å¾ˆç®€å•çš„é—®é¢˜ï¼Œhttps://golang.org/pkg/regexp/#Regexp.ReplaceAllString å®˜æ–¹æ–‡æ¡£ä¸­ReplaceAllStringçš„è§£é‡Šï¼Œåˆ°åº•æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿåˆ°åº•æ€Žä¹ˆç”¨ï¼Ÿ å®˜æ–¹è‹±æ–‡åŽŸæ–‡ï¼š func (re *Regexp) ReplaceAllString(src, repl string) string 12ReplaceAllString returns a copy of src, replacing matches of the Regexp with the replacement string repl. Inside repl, $ signs are interpreted as in Expand, so for instance $1 represents the text of the first submatch. ä¸­æ–‡æ–‡æ¡£ï¼š 1ReplaceAllLiteralè¿”å›žsrcçš„ä¸€ä¸ªæ‹·è´ï¼Œå°†srcä¸­æ‰€æœ‰reçš„åŒ¹é…ç»“æžœéƒ½æ›¿æ¢ä¸ºreplã€‚åœ¨æ›¿æ¢æ—¶ï¼Œreplä¸­çš„&apos;$&apos;ç¬¦å·ä¼šæŒ‰ç…§Expandæ–¹æ³•çš„è§„åˆ™è¿›è¡Œè§£é‡Šå’Œæ›¿æ¢ï¼Œä¾‹å¦‚$1ä¼šè¢«æ›¿æ¢ä¸ºç¬¬ä¸€ä¸ªåˆ†ç»„åŒ¹é…ç»“æžœã€‚ çœ‹ä¸ŠåŽ»ä¸€è„¸æ‡µé€¼ï¼Œè¿˜æ˜¯ä¸ç†è§£è¿™ä¸ªå‡½æ•°åˆ°åº•æ€Žä¹ˆç”¨ã€‚ åˆåŽ»çœ‹å®˜æ–¹çš„ç¤ºä¾‹ï¼š 12345678910111213Exampleï¼šre := regexp.MustCompile("a(x*)b")fmt.Println(re.ReplaceAllString("-ab-axxb-", "T"))fmt.Println(re.ReplaceAllString("-ab-axxb-", "$1"))fmt.Println(re.ReplaceAllString("-ab-axxb-", "$1W"))fmt.Println(re.ReplaceAllString("-ab-axxb-", "$&#123;1&#125;W"))Output:-T-T---xx-----W-xxW- ç¬¬ä¸€ä¸ªæ›¿æ¢å‹‰å¼ºèƒ½çœ‹æ˜Žç™½ï¼Œæ˜¯ç”¨TåŽ»æ›¿æ¢-ab-axxb-ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„éƒ¨åˆ†ï¼›ç¬¬äºŒä¸ªä¸­çš„$æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ$1çœ‹èµ·æ¥åƒæ˜¯åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼åˆ†ç»„ä¸­ç¬¬ä¸€éƒ¨åˆ†ï¼Œé‚£$1Wå‘¢ï¼Ÿ${1}Wå‘¢ï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜ï¼Œå¼€å§‹æ·±å…¥ç ”ç©¶è¿™ä¸ªå‡½æ•°åˆ°åº•æ€Žä¹ˆç”¨ã€‚ é¦–å…ˆï¼Œ$ç¬¦å·åœ¨Expandå‡½æ•°ä¸­æœ‰è§£é‡Šè¿‡ï¼š 123456789func (re *Regexp) Expand(dst []byte, template []byte, src []byte, match []int) []byteExpandè¿”å›žæ–°ç”Ÿæˆçš„å°†templateæ·»åŠ åˆ°dståŽé¢çš„åˆ‡ç‰‡ã€‚åœ¨æ·»åŠ æ—¶ï¼ŒExpandä¼šå°†templateä¸­çš„å˜é‡æ›¿æ¢ä¸ºä»ŽsrcåŒ¹é…çš„ç»“æžœã€‚matchåº”è¯¥æ˜¯è¢«FindSubmatchIndexè¿”å›žçš„åŒ¹é…ç»“æžœèµ·æ­¢ä½ç½®ç´¢å¼•ã€‚ï¼ˆé€šå¸¸å°±æ˜¯åŒ¹é…srcï¼Œé™¤éžä½ è¦å°†åŒ¹é…å¾—åˆ°çš„ä½ç½®ç”¨äºŽå¦ä¸€ä¸ª[]byteï¼‰åœ¨templateå‚æ•°é‡Œï¼Œä¸€ä¸ªå˜é‡è¡¨ç¤ºä¸ºæ ¼å¼å¦‚ï¼š$nameæˆ–$&#123;name&#125;çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­nameæ˜¯é•¿åº¦&gt;0çš„å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿çš„åºåˆ—ã€‚ä¸€ä¸ªå•çº¯çš„æ•°å­—å­—ç¬¦åå¦‚$1ä¼šä½œä¸ºæ•èŽ·åˆ†ç»„çš„æ•°å­—ç´¢å¼•ï¼›å…¶ä»–çš„åå­—å¯¹åº”(?P&lt;name&gt;...)è¯­æ³•äº§ç”Ÿçš„å‘½åæ•èŽ·åˆ†ç»„çš„åå­—ã€‚è¶…å‡ºèŒƒå›´çš„æ•°å­—ç´¢å¼•ã€ç´¢å¼•å¯¹åº”çš„åˆ†ç»„æœªåŒ¹é…åˆ°æ–‡æœ¬ã€æ­£åˆ™è¡¨è¾¾å¼ä¸­æœªå‡ºçŽ°çš„åˆ†ç»„åï¼Œéƒ½ä¼šè¢«æ›¿æ¢ä¸ºç©ºåˆ‡ç‰‡ã€‚$nameæ ¼å¼çš„å˜é‡åï¼Œnameä¼šå°½å¯èƒ½å–æœ€é•¿åºåˆ—ï¼š$1xç­‰ä»·äºŽ$&#123;1x&#125;è€Œéž$&#123;1&#125;xï¼Œ$10ç­‰ä»·äºŽ$&#123;10&#125;è€Œéž$&#123;1&#125;0ã€‚å› æ­¤$nameé€‚ç”¨åœ¨åŽè·Ÿç©ºæ ¼/æ¢è¡Œç­‰å­—ç¬¦çš„æƒ…å†µï¼Œ$&#123;name&#125;é€‚ç”¨æ‰€æœ‰æƒ…å†µã€‚å¦‚æžœè¦åœ¨è¾“å‡ºä¸­æ’å…¥ä¸€ä¸ªå­—é¢å€¼&apos;$&apos;ï¼Œåœ¨templateé‡Œå¯ä»¥ä½¿ç”¨$$ã€‚ è¯´äº†è¿™ä¹ˆå¤šï¼Œå…¶å®žæœ€ç»ˆè¦çš„éƒ¨åˆ†å¯ä»¥æ¦‚æ‹¬ä¸ºä¸‰ç‚¹ï¼š $åŽé¢åªæœ‰æ•°å­—ï¼Œåˆ™ä»£è¡¨æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„ç´¢å¼•ï¼Œå…³äºŽæ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„è§£é‡Šï¼š æ•èŽ·ç»„å¯ä»¥é€šè¿‡ä»Žå·¦åˆ°å³è®¡ç®—å…¶å¼€æ‹¬å·æ¥ç¼–å· ã€‚ä¾‹å¦‚ï¼Œåœ¨è¡¨è¾¾å¼ (A)(B(C)) ä¸­ï¼Œå­˜åœ¨å››ä¸ªè¿™æ ·çš„ç»„ï¼š 0 (A)(B(C)) 1 (A) 2 (B(C)) 3 (C) ç»„é›¶å§‹ç»ˆä»£è¡¨æ•´ä¸ªè¡¨è¾¾å¼ ä¹‹æ‰€ä»¥è¿™æ ·å‘½åæ•èŽ·ç»„æ˜¯å› ä¸ºåœ¨åŒ¹é…ä¸­ï¼Œä¿å­˜äº†ä¸Žè¿™äº›ç»„åŒ¹é…çš„è¾“å…¥åºåˆ—çš„æ¯ä¸ªå­åºåˆ—ã€‚æ•èŽ·çš„å­åºåˆ—ç¨åŽå¯ä»¥é€šè¿‡ Back å¼•ç”¨ï¼ˆåå‘å¼•ç”¨ï¼‰ åœ¨è¡¨è¾¾å¼ä¸­ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥åœ¨åŒ¹é…æ“ä½œå®ŒæˆåŽä»ŽåŒ¹é…å™¨æ£€ç´¢ã€‚ åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„$1éƒ¨åˆ†ï¼Œä¿ç•™è¯¥éƒ¨åˆ†ï¼ŒåŽ»æŽ‰å…¶ä½™éƒ¨åˆ†ï¼› $åŽé¢æ˜¯å­—ç¬¦ä¸²ï¼Œå³$name,ä»£è¡¨åŒ¹é…å¯¹åº”(?Pâ€¦)è¯­æ³•äº§ç”Ÿçš„å‘½åæ•èŽ·åˆ†ç»„çš„åå­— ${æ•°å­—}å­—ç¬¦ä¸²,å³${1}xxxï¼Œæ„æ€æ˜¯åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼çš„åˆ†ç»„1ï¼Œsrcä¸­åŒ¹é…åˆ†ç»„1çš„ä¿ç•™ï¼Œå¹¶åˆ é™¤srcå‰©ä½™éƒ¨åˆ†ï¼Œè¿½åŠ xxxï¼ŒåŽé¢ä¼šæœ‰ä»£ç ç¤ºä¾‹è§£é‡Šè¿™éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯æœ€éš¾ç†è§£çš„éƒ¨åˆ† æœ€ç®€å•çš„æƒ…å†µï¼Œå‚æ•°replæ˜¯å­—ç¬¦ä¸²ï¼Œå°†srcä¸­æ‰€æœ‰reçš„åŒ¹é…ç»“æžœéƒ½æ›¿æ¢ä¸ºrepl ä¸‹é¢ç”¨ä»£ç æ¥è§£é‡Šä»¥ä¸Šå‡ ç§æƒ…å†µï¼š 1234567891011121314151617181920212223242526272829303132333435package mainimport ("fmt""regexp")func main() &#123; s := "Hello World, 123 Go!" //å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼regï¼ŒåŒ¹é…Helloæˆ–è€…Go reg := regexp.MustCompile(`(Hell|G)o`) s2 := "2019-12-01,test" //å®šä¹‰ä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼reg2,åŒ¹é… YYYY-MM-DD çš„æ—¥æœŸæ ¼å¼ reg2 := regexp.MustCompile(`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`) //æœ€ç®€å•çš„æƒ…å†µï¼Œç”¨â€œTæ›¿æ¢â€"-ab-axxb-"ä¸­ç¬¦åˆæ­£åˆ™"a(x*)b"çš„éƒ¨åˆ† reg3 := regexp.MustCompile("a(x*)b") fmt.Println(re.ReplaceAllString("-ab-axxb-", "T")) //$&#123;1&#125;åŒ¹é…"Hello World, 123 Go!"ä¸­ç¬¦åˆæ­£åˆ™`(Hell|G)`çš„éƒ¨åˆ†å¹¶ä¿ç•™ï¼ŒåŽ»æŽ‰"Hello"ä¸Ž"Go"ä¸­çš„'o'å¹¶ç”¨"ddd"è¿½åŠ  rep1 := "$&#123;1&#125;ddd" fmt.Printf("%q\n", reg.ReplaceAllString(s, rep1)) //é¦–å…ˆï¼Œ"2019-12-01,test"ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`çš„éƒ¨åˆ†æ˜¯"2019-12-01",å°†è¯¥éƒ¨åˆ†åŒ¹é…'(\d&#123;4&#125;)'çš„'2019'ä¿ç•™ï¼ŒåŽ»æŽ‰å‰©ä½™éƒ¨åˆ† rep2 := "$&#123;1&#125;" fmt.Printf("%q\n", reg2.ReplaceAllString(s2,rep2)) //é¦–å…ˆï¼Œ"2019-12-01,test"ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`çš„éƒ¨åˆ†æ˜¯"2019-12-01",å°†è¯¥éƒ¨åˆ†åŒ¹é…'(\d&#123;2&#125;)'çš„'12'ä¿ç•™ï¼ŒåŽ»æŽ‰å‰©ä½™éƒ¨åˆ† rep3 := "$&#123;2&#125;" fmt.Printf("%q\n", reg2.ReplaceAllString(s2,rep3)) //é¦–å…ˆï¼Œ"2019-12-01,test"ä¸­ç¬¦åˆæ­£åˆ™è¡¨è¾¾å¼`(\d&#123;4&#125;)-(\d&#123;2&#125;)-(\d&#123;2&#125;)`çš„éƒ¨åˆ†æ˜¯"2019-12-01",å°†è¯¥éƒ¨åˆ†åŒ¹é…'(\d&#123;2&#125;)'çš„'01'ä¿ç•™ï¼ŒåŽ»æŽ‰å‰©ä½™éƒ¨åˆ†,å¹¶è¿½åŠ "13:30:12" rep4 := "$&#123;3&#125;:13:30:12" fmt.Printf("%q\n", reg2.ReplaceAllString(s2,rep4)) &#125; ä¸Šé¢ä»£ç è¾“å‡ºä¾æ¬¡æ˜¯ï¼š 123456$ go run main.go-T-T-"Hellddd World, 123 Gddd!""2019,test""12,test""01:13:30:12,test" æ€»ç»“GoregexpåŒ…ä¸­çš„ReplaceAllStringè®¾è®¡æœ‰äº›è®¸åäººç±»ï¼Œç†è§£å’Œä½¿ç”¨ä¸Šæ„Ÿè§‰ä¸æ–¹ä¾¿ï¼Œå¦‚æžœä½ æœ‰æ›´å¥½çš„ç†è§£æˆ–è€…ç¤ºä¾‹ä»£ç ï¼ŒCall me!]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[goè¯­è¨€å‘ä¹‹for range]]></title>
    <url>%2F2019%2F01%2F31%2Fgo%E8%AF%AD%E8%A8%80%E5%9D%91%E4%B9%8Bfor-range%2F</url>
    <content type="text"><![CDATA[goè¯­è¨€å‘ä¹‹for range è¿™ç¯‡æ–‡ç« ç®€å•æ¸…æ™°åœ°è§£é‡Šäº†ä¹‹å‰éåŽ†structåˆ‡ç‰‡æ—¶é‡åˆ°çš„ä¸€äº›æ€ªå¼‚çŽ°è±¡ï¼Œè¿™ä¸ªé—®é¢˜å½“æ—¶ä¹Ÿå†™äº†ä¸€ç¯‡æ–‡ç« æ¥è®¨è®ºï¼Œæ–‡ç« åœ°å€ï¼Œä½†æ˜¯æ²¡æœ‰åˆ‡ä¸­è¦ç‚¹ã€‚æ˜¨å¤©æ— æ„ä¸­çœ‹åˆ°è¿™ç¯‡åšå®¢ï¼Œè±ç„¶å¼€æœ—ã€‚ goåªæä¾›äº†ä¸€ç§å¾ªçŽ¯æ–¹å¼ï¼Œå³forå¾ªçŽ¯ï¼Œåœ¨ä½¿ç”¨æ—¶å¯ä»¥åƒcé‚£æ ·ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥é€šè¿‡for rangeæ–¹å¼éåŽ†å®¹å™¨ç±»åž‹å¦‚æ•°ç»„ã€åˆ‡ç‰‡å’Œæ˜ å°„ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨for rangeæ—¶ï¼Œå¦‚æžœä½¿ç”¨ä¸å½“ï¼Œå°±ä¼šå‡ºçŽ°ä¸€äº›é—®é¢˜ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œè¡Œä¸ºä¸å¦‚é¢„æœŸã€‚æ¯”å¦‚ï¼Œä¸‹é¢çš„ç¤ºä¾‹ç¨‹åºå°†éåŽ†ä¸€ä¸ªåˆ‡ç‰‡ï¼Œå¹¶å°†åˆ‡ç‰‡çš„å€¼å½“æˆæ˜ å°„çš„é”®å’Œå€¼å­˜å…¥ï¼Œåˆ‡ç‰‡ç±»åž‹æ˜¯ä¸€ä¸ªintåž‹ï¼Œæ˜ å°„çš„ç±»åž‹æ˜¯é”®ä¸ºintåž‹ï¼Œå€¼ä¸º*intï¼Œå³å€¼æ˜¯ä¸€ä¸ªåœ°å€ã€‚ 1234567891011121314151617181920package mainimport &quot;fmt&quot;func main() &#123; slice := []int&#123;0, 1, 2, 3&#125; myMap := make(map[int]*int) for index, value := range slice &#123; myMap[index] = &amp;value &#125; fmt.Println(&quot;=====new map=====&quot;) prtMap(myMap)&#125;func prtMap(myMap map[int]*int) &#123; for key, value := range myMap &#123; fmt.Printf(&quot;map[%v]=%v\n&quot;, key, *value) &#125;&#125; è¿è¡Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š 12345=====new map=====map[3]=3map[0]=3map[1]=3map[2]=3 ç”±è¾“å‡ºå¯ä»¥çŸ¥é“ï¼Œä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„è¾“å‡ºï¼Œæ­£ç¡®è¾“å‡ºåº”è¯¥å¦‚ä¸‹ï¼š 123456=====new map=====map[0]=0map[1]=1map[2]=2map[3]=3ï¼ˆæ— åºè¾“å‡ºï¼Œä½†æ˜¯å€¼æ˜¯0,1,2,3ï¼‰ ä½†æ˜¯ç”±è¾“å‡ºå¯ä»¥çŸ¥é“ï¼Œæ˜ å°„çš„å€¼éƒ½ç›¸åŒä¸”éƒ½æ˜¯3ã€‚å…¶å®žå¯ä»¥çŒœæµ‹æ˜ å°„çš„å€¼éƒ½æ˜¯åŒä¸€ä¸ªåœ°å€ï¼ŒéåŽ†åˆ°åˆ‡ç‰‡çš„æœ€åŽä¸€ä¸ªå…ƒç´ 3æ—¶ï¼Œå°†3å†™å…¥äº†è¯¥åœ°å€ï¼Œæ‰€ä»¥å¯¼è‡´æ˜ å°„æ‰€æœ‰å€¼éƒ½ç›¸åŒã€‚å…¶å®žçœŸå®žåŽŸå› ä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå› ä¸ºfor rangeåˆ›å»ºäº†æ¯ä¸ªå…ƒç´ çš„å‰¯æœ¬ï¼Œè€Œä¸æ˜¯ç›´æŽ¥è¿”å›žæ¯ä¸ªå…ƒç´ çš„å¼•ç”¨ï¼Œå¦‚æžœä½¿ç”¨è¯¥å€¼å˜é‡çš„åœ°å€ä½œä¸ºæŒ‡å‘æ¯ä¸ªå…ƒç´ çš„æŒ‡é’ˆï¼Œå°±ä¼šå¯¼è‡´é”™è¯¯ï¼Œåœ¨è¿­ä»£æ—¶ï¼Œè¿”å›žçš„å˜é‡æ˜¯ä¸€ä¸ªè¿­ä»£è¿‡ç¨‹ä¸­æ ¹æ®åˆ‡ç‰‡ä¾æ¬¡èµ‹å€¼çš„æ–°å˜é‡ï¼Œæ‰€ä»¥å€¼çš„åœ°å€æ€»æ˜¯ç›¸åŒçš„ï¼Œå¯¼è‡´ç»“æžœä¸å¦‚é¢„æœŸã€‚ ä¿®æ­£åŽç¨‹åºå¦‚ä¸‹ï¼š 123456789101112131415161718192021package mainimport &quot;fmt&quot;func main() &#123; slice := []int&#123;0, 1, 2, 3&#125; myMap := make(map[int]*int) for index, value := range slice &#123; num := value myMap[index] = &amp;num &#125; fmt.Println(&quot;=====new map=====&quot;) prtMap(myMap)&#125;func prtMap(myMap map[int]*int) &#123; for key, value := range myMap &#123; fmt.Printf(&quot;map[%v]=%v\n&quot;, key, *value) &#125;&#125; è¿è¡Œç¨‹åºè¾“å‡ºå¦‚ä¸‹ï¼š 12345=====new map=====map[2]=2map[3]=3map[0]=0map[1]=1 å¼•ç”¨å£°æ˜Žï¼šè¯¥åšå®¢æ¥è‡ªäºŽè¿™é‡Œ.]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è®°ç¬¬ä¸€ä¸ªVueé¡¹ç›®å°å‰å¹•åŽçš„ç»åŽ†]]></title>
    <url>%2F2019%2F01%2F28%2F%E8%AE%B0%E7%AC%AC%E4%B8%80%E4%B8%AAVue%E9%A1%B9%E7%9B%AE%E5%8F%B0%E5%89%8D%E5%B9%95%E5%90%8E%E7%9A%84%E7%BB%8F%E5%8E%86%2F</url>
    <content type="text"><![CDATA[0å‰ç«¯å¼€å‘ç»éªŒï¼Œåˆæ¬¡æŽ¥è§¦Vueï¼Œä»ŽåŽç«¯åˆ°å‰ç«¯ï¼Œä»Žå¼€å‘ã€æ‰“åŒ…åˆ°éƒ¨ç½²ï¼Œå®Œæ•´çš„åŽ†ç¨‹ã€‚ é¦–å…ˆç²—ç•¥é€šè¯»äº†ä¸€éå®˜æ–¹æ–‡æ¡£ï¼ŒåŠ¨æ‰‹ç”¨webpackæ­å»ºäº†ä¸€ä¸ªç®€å•çš„demoã€‚ çœ‹äº†Echartsçš„å®˜æ–¹demoï¼Œäº†è§£äº†å‡ ç§æ•°æ®å›¾è¡¨çš„æ•°æ®ç»“æž„ã€‚å› ä¸ºæˆ‘è¦åšçš„é¡¹ç›®å°±æ˜¯è¦å°†åŽç«¯æŽ¥å£çš„æ•°æ®æ‹¿åˆ°ï¼Œç„¶åŽå›¾å½¢åŒ–çš„å½¢å¼å±•ç¤ºå‡ºæ¥ã€‚ å¯¹æŽ¥åŽç«¯ï¼Œè¿›è¡ŒaxiosäºŒæ¬¡å¼€å‘åœ¨æž„å»ºåº”ç”¨æ—¶éœ€è¦è®¿é—®ä¸€ä¸ª API å¹¶å±•ç¤ºå…¶æ•°æ®ï¼Œè°ƒç ”Vueçš„å¤šç§æ–¹å¼åŽé€‰æ‹©äº†å®˜æ–¹æŽ¨èçš„axioxã€‚ ä»Žajaxåˆ°fetchã€axioså‰ç«¯æ˜¯ä¸ªå‘å±•è¿…é€Ÿçš„é¢†åŸŸï¼Œå‰ç«¯è¯·æ±‚è‡ªç„¶ä¹Ÿå‘å±•è¿…é€Ÿï¼Œä»ŽåŽŸç”Ÿçš„XHRåˆ°jquery ajaxï¼Œå†åˆ°çŽ°åœ¨çš„axioså’Œfetchã€‚ jquery ajax123456789$.ajax(&#123; type: &apos;POST&apos;, url: url, data: data, dataType: dataType, success: function() &#123;&#125;, error: function() &#123;&#125;&#125;)å¤åˆ¶ä»£ç  å®ƒæ˜¯å¯¹åŽŸç”ŸXHRçš„å°è£…ï¼Œè¿˜æ”¯æŒJSONPï¼Œéžå¸¸æ–¹ä¾¿ï¼›çœŸçš„æ˜¯ç”¨è¿‡çš„éƒ½è¯´å¥½ã€‚ä½†æ˜¯éšç€reactï¼Œvueç­‰å‰ç«¯æ¡†æž¶çš„å…´èµ·ï¼Œjqueryæ—©å·²ä¸å¤å½“å¹´ä¹‹å‹‡ã€‚å¾ˆå¤šæƒ…å†µä¸‹æˆ‘ä»¬åªéœ€è¦ä½¿ç”¨ajaxï¼Œä½†æ˜¯å´éœ€è¦å¼•å…¥æ•´ä¸ªjqueryï¼Œè¿™éžå¸¸çš„ä¸åˆç†ï¼ŒäºŽæ˜¯ä¾¿æœ‰äº†fetchçš„è§£å†³æ–¹æ¡ˆã€‚ fetchfetchå·ç§°æ˜¯ajaxçš„æ›¿ä»£å“ï¼Œå®ƒçš„APIæ˜¯åŸºäºŽPromiseè®¾è®¡çš„ï¼Œæ—§ç‰ˆæœ¬çš„æµè§ˆå™¨ä¸æ”¯æŒPromiseï¼Œéœ€è¦ä½¿ç”¨polyfill es6-promise ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819// åŽŸç”ŸXHRvar xhr = new XMLHttpRequest();xhr.open(&apos;GET&apos;, url);xhr.onreadystatechange = function() &#123; if (xhr.readyState === 4 &amp;&amp; xhr.status === 200) &#123; console.log(xhr.responseText) // ä»ŽæœåŠ¡å™¨èŽ·å–æ•°æ® &#125;&#125;xhr.send()// fetchfetch(url) .then(response =&gt; &#123; if (response.ok) &#123; response.json() &#125; &#125;) .then(data =&gt; console.log(data)) .catch(err =&gt; console.log(err))å¤åˆ¶ä»£ç  çœ‹èµ·æ¥å¥½åƒæ˜¯æ–¹ä¾¿ç‚¹ï¼Œthené“¾å°±åƒä¹‹å‰ç†Ÿæ‚‰çš„callbackã€‚ åœ¨MDNä¸Šï¼Œè®²åˆ°å®ƒè·Ÿjquery ajaxçš„åŒºåˆ«ï¼Œè¿™ä¹Ÿæ˜¯fetchå¾ˆå¥‡æ€ªçš„åœ°æ–¹ï¼š å½“æŽ¥æ”¶åˆ°ä¸€ä¸ªä»£è¡¨é”™è¯¯çš„ HTTP çŠ¶æ€ç æ—¶ï¼Œä»Ž fetch()è¿”å›žçš„ Promise ä¸ä¼šè¢«æ ‡è®°ä¸º rejectï¼Œ å³ä½¿è¯¥ HTTP å“åº”çš„çŠ¶æ€ç æ˜¯ 404 æˆ– 500ã€‚ç›¸åï¼Œå®ƒä¼šå°† Promise çŠ¶æ€æ ‡è®°ä¸º resolve ï¼ˆä½†æ˜¯ä¼šå°† resolve çš„è¿”å›žå€¼çš„ ok å±žæ€§è®¾ç½®ä¸º false ï¼‰ï¼Œ ä»…å½“ç½‘ç»œæ•…éšœæ—¶æˆ–è¯·æ±‚è¢«é˜»æ­¢æ—¶ï¼Œæ‰ä¼šæ ‡è®°ä¸º rejectã€‚ é»˜è®¤æƒ…å†µä¸‹, fetch ä¸ä¼šä»ŽæœåŠ¡ç«¯å‘é€æˆ–æŽ¥æ”¶ä»»ä½• cookies, å¦‚æžœç«™ç‚¹ä¾èµ–äºŽç”¨æˆ· sessionï¼Œåˆ™ä¼šå¯¼è‡´æœªç»è®¤è¯çš„è¯·æ±‚ï¼ˆè¦å‘é€ cookiesï¼Œå¿…é¡»è®¾ç½® credentials é€‰é¡¹ï¼‰. çªç„¶æ„Ÿè§‰è¿™è¿˜ä¸å¦‚jquery ajaxå¥½ç”¨å‘¢ï¼Ÿåˆ«æ€¥ï¼Œå†æ­é…ä¸Šasync/awaitå°†ä¼šè®©æˆ‘ä»¬çš„å¼‚æ­¥ä»£ç æ›´åŠ ä¼˜é›…ï¼š 123456async function test() &#123; let response = await fetch(url); let data = await response.json(); console.log(data)&#125;å¤åˆ¶ä»£ç  çœ‹èµ·æ¥æ˜¯ä¸æ˜¯åƒåŒæ­¥ä»£ç ä¸€æ ·ï¼Ÿç®€ç›´å®Œç¾Žï¼å¥½å§ï¼Œå…¶å®žå¹¶ä¸å®Œç¾Žï¼Œasync/awaitæ˜¯ES7çš„APIï¼Œç›®å‰è¿˜åœ¨è¯•éªŒé˜¶æ®µï¼Œè¿˜éœ€è¦æˆ‘ä»¬ä½¿ç”¨babelè¿›è¡Œè½¬è¯‘æˆES5ä»£ç ã€‚ è¿˜è¦æä¸€ä¸‹çš„æ˜¯ï¼Œfetchæ˜¯æ¯”è¾ƒåº•å±‚çš„APIï¼Œå¾ˆå¤šæƒ…å†µä¸‹éƒ½éœ€è¦æˆ‘ä»¬å†æ¬¡å°è£…ã€‚ æ¯”å¦‚ï¼š 12345678910// jquery ajax$.post(url, &#123;name: &apos;test&apos;&#125;)// fetchfetch(url, &#123; method: &apos;POST&apos;, body: Object.keys(&#123;name: &apos;test&apos;&#125;).map((key) =&gt; &#123; return encodeURIComponent(key) + &apos;=&apos; + encodeURIComponent(params[key]); &#125;).join(&apos;&amp;&apos;)&#125;)å¤åˆ¶ä»£ç  ç”±äºŽfetchæ˜¯æ¯”è¾ƒåº•å±‚çš„APIï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨å°†å‚æ•°æ‹¼æŽ¥æˆâ€™name=testâ€™çš„æ ¼å¼ï¼Œè€Œjquery ajaxå·²ç»å°è£…å¥½äº†ã€‚æ‰€ä»¥fetchå¹¶ä¸æ˜¯å¼€ç®±å³ç”¨çš„ã€‚ å¦å¤–ï¼Œfetchè¿˜ä¸æ”¯æŒè¶…æ—¶æŽ§åˆ¶ã€‚ å“Žå‘€ï¼Œæ„Ÿè§‰fetchå¥½åžƒåœ¾å•Šï¼Œï¼Œè¿˜éœ€è¦ç»§ç»­æˆé•¿ã€‚ã€‚ axiosaxiosæ˜¯å°¤é›¨æºªå¤§ç¥žæŽ¨èä½¿ç”¨çš„ï¼Œå®ƒä¹Ÿæ˜¯å¯¹åŽŸç”ŸXHRçš„å°è£…ã€‚å®ƒæœ‰ä»¥ä¸‹å‡ å¤§ç‰¹æ€§ï¼š å¯ä»¥åœ¨node.jsä¸­ä½¿ç”¨ æä¾›äº†å¹¶å‘è¯·æ±‚çš„æŽ¥å£ æ”¯æŒPromise API ç®€å•ä½¿ç”¨ 123456axios(&#123; method: &apos;GET&apos;, url: url,&#125;).then(res =&gt; &#123;console.log(res)&#125;).catch(err =&gt; &#123;console.log(err)&#125;) å¹¶å‘è¯·æ±‚,å®˜æ–¹çš„å¹¶å‘ä¾‹å­ï¼š 123456789101112function getUserAccount() &#123; return axios.get(&apos;/user/12345&apos;);&#125;function getUserPermissions() &#123; return axios.get(&apos;/user/12345/permissions&apos;);&#125;axios.all([getUserAccount(), getUserPermissions()]) .then(axios.spread(function (acct, perms) &#123; // Both requests are now complete &#125;)); axiosä½“ç§¯æ¯”è¾ƒå°ï¼Œä¹Ÿæ²¡æœ‰ä¸Šé¢fetchçš„å„ç§é—®é¢˜ï¼Œæˆ‘è®¤ä¸ºæ˜¯å½“å‰æœ€å¥½çš„è¯·æ±‚æ–¹å¼ è¯¦æƒ…å‚è€ƒå®˜æ–¹æ–‡æ¡£ #äºŒæ¬¡å°è£…axios é¦–å…ˆåˆ›å»ºä¸€ä¸ªrequest.js,å†…å®¹å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788import axios from 'axios';import Qs from 'qs';function checkStatus(err) &#123; let msg = "", level = "error"; switch (err.response.status) &#123; case 401: msg = "æ‚¨è¿˜æ²¡æœ‰ç™»é™†"; break; case 403: msg = "æ‚¨æ²¡æœ‰è¯¥é¡¹æƒé™"; break; case 404: msg = "èµ„æºä¸å­˜åœ¨"; break; case 500: msg = "æœåŠ¡å™¨å‘ç”Ÿäº†ç‚¹æ„å¤–"; break; &#125; try &#123; msg = res.data.msg; &#125; catch (err) &#123; &#125; finally &#123; if (msg !== "" &amp;&amp; msg !== undefined &amp;&amp; msg !== null) &#123; store.dispatch('showSnackBar', &#123;text: msg, level: level&#125;); &#125; &#125; return err.response; &#125; function checkCode(res) &#123; if ((res.status &gt;= 200 &amp;&amp; res.status &lt; 400) &amp;&amp; (res.data.status &gt;= 200 &amp;&amp; res.data.status &lt; 400)) &#123; let msg = "", level = "success"; switch (res.data.status) &#123; case 201: msg = "åˆ›å»ºæˆåŠŸ"; break; case 204: msg = "åˆ é™¤æˆåŠŸ"; break; &#125; try &#123; msg = res.data.success; &#125; catch (err) &#123; &#125; finally &#123; &#125; return res; &#125; return res; &#125;//è¿™é‡Œå°è£…axiosçš„get,post,put,deleteç­‰æ–¹æ³•export default &#123; get(url, params) &#123; return axios.get( url, params, ).then(checkCode).catch((error)=&gt;&#123;console.log(error)&#125;); &#125;, post(url, data) &#123; return axios.post( url, Qs.stringify(data), ).then(checkCode).catch(checkStatus); &#125;, put(url, data) &#123; return axios.put( url, Qs.stringify(data), ).then(checkCode).catch(checkStatus); &#125;, delete(url, data) &#123; return axios.delete( url, &#123;data: Qs.stringify(data)&#125;, ).then(checkCode).catch(checkStatus); &#125;, patch(url, data) &#123; return axios.patch( url, data, ).then(checkCode).catch(checkStatus); &#125;, &#125;; åˆ›å»ºä¸€ä¸ªapi.js,å­˜æ”¾åŽç«¯çš„æŽ¥å£ï¼š 12345678910//å¯¼å…¥ä¸Šé¢çš„requestæ¨¡å—import request from './request';//å£°æ˜ŽåŽç«¯æŽ¥å£export const urlUserPrefix = '/v1/users';export const urlProductPrefix = '/v1/products';//ä½¿ç”¨å‰é¢å°è£…å¥½çš„æ–¹æ³•ï¼Œè°ƒç”¨åŽç«¯æŽ¥å£export const getUserslInfoLast = data =&gt; request.get(`$&#123;urlUserPrefix&#125;`, data);export const getProductsInfo = data =&gt; request.get(`$&#123;urlProductPrefix&#125;`, data); åœ¨.vueæ–‡ä»¶ä¸­ä½¿ç”¨å®šä¹‰çš„æ–¹æ³•ï¼ŒèŽ·å–åŽç«¯æŽ¥å£çš„æ•°æ®ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344export default &#123; components: &#123; chart: ECharts, &#125;, store, name: 'ResourceTypeLine', data: () =&gt;(&#123; seconds: -1, //define dataset apiResponse:&#123;&#125;, initOptions: &#123; renderer: options.renderer || 'canvas' &#125;, mounted:function() &#123; this.fTimeArray = this.getFormatTime()//è°ƒç”¨methodé‡Œé¢çš„æ–¹æ³•this.getUserInfo() &#125;, methods: &#123;//å¼‚æ­¥æ–¹å¼è°ƒç”¨åŽç«¯æŽ¥å£ async getUserInfo() &#123; const resThis = await urlUserPrefix(&#123; params: &#123; //getçš„å‚æ•°åœ¨è¿™é‡Œæ·»åŠ  beginTime: this.fTimeArray[0], endTime: this.fTimeArray[1], &#125; &#125;); this.apiResponseThisMonth = resThis.data try &#123; &#125; catch (err) &#123; console.log(err); &#125; &#125;, å¼€å‘çŽ¯å¢ƒé…ç½®è·¨åŸŸä¸ºäº†æ›´æ–¹ä¾¿åœ°ä¸ŽåŽå°è”è°ƒï¼Œéœ€è¦åœ¨ç”¨vueè„šæ‰‹æž¶åˆ›å»ºåœ°é¡¹ç›®ä¸­ï¼Œåœ¨configç›®å½•åœ°index.jsè®¾ç½®proxytableæ¥å®žçŽ°è·¨åŸŸè¯·æ±‚ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647module.exports = &#123; build: &#123; env: require('./prod.env'), index: path.resolve(__dirname, '../dist/index.html'), assetsRoot: path.resolve(__dirname, '../dist'), assetsSubDirectory: 'static', assetsPublicPath: '.', productionSourceMap: false, // Gzip off by default as many popular static hosts such as // Surge or Netlify already gzip all static assets for you. // Before setting to `true`, make sure to: // npm install --save-dev compression-webpack-plugin productionGzip: false, productionGzipExtensions: ['js', 'css'], // Run the build command with an extra argument to // View the bundle analyzer report after build finishes: // `npm run build --report` // Set to `true` or `false` to always turn it on or off bundleAnalyzerReport: process.env.npm_config_report &#125;, dev: &#123; env: require('./dev.env'), port: 8080, // hosts:"0.0.0.0", autoOpenBrowser: true, assetsSubDirectory: 'static', assetsPublicPath: '/', //é…ç½®è·¨åŸŸè¯·æ±‚,æ³¨æ„é…ç½®å®Œä¹‹åŽéœ€è¦é‡å¯ç¼–è¯‘è¯¥é¡¹ç›® proxyTable: &#123; //è¯·æ±‚åå­—å˜é‡å¯ä»¥è‡ªå·±å®šä¹‰ '/api': &#123; target: 'http://test.com', // è¯·æ±‚çš„æŽ¥å£åŸŸåæˆ–IPåœ°å€ï¼Œå¼€å¤´æ˜¯httpæˆ–https // secure: false, // å¦‚æžœæ˜¯httpsæŽ¥å£ï¼Œéœ€è¦é…ç½®è¿™ä¸ªå‚æ•° changeOrigin: true,// æ˜¯å¦è·¨åŸŸï¼Œå¦‚æžœæŽ¥å£è·¨åŸŸï¼Œéœ€è¦è¿›è¡Œè¿™ä¸ªå‚æ•°é…ç½® pathRewrite: &#123; '^/api':""//è¡¨ç¤ºéœ€è¦rewriteé‡å†™è·¯å¾„ &#125; &#125; &#125;, // CSS Sourcemaps off by default because relative paths are "buggy" // with this option, according to the CSS-Loader README // (https://github.com/webpack/css-loader#sourcemaps) // In our experience, they generally work as expected, // just be aware of this issue when enabling this option. cssSourceMap: false &#125;&#125; vue é¡¹ç›®æ‰“åŒ…éƒ¨ç½²ï¼Œé€šè¿‡nginx è§£å†³è·¨åŸŸé—®é¢˜â€‹ æœ€è¿‘å°†å…¬å¸vue é¡¹ç›®æ‰“åŒ…éƒ¨ç½²æœåŠ¡å™¨æ—¶ï¼Œäº§ç”Ÿäº†ä¸€ç‚¹å°æ’æ›²ï¼Œå¼€å‘çŽ¯å¢ƒä¸­é…ç½®çš„è·¨åŸŸåœ¨å°†é¡¹ç›®æ‰“åŒ…ä¸ºé™æ€æ–‡ä»¶æ—¶æ˜¯æ²¡æœ‰ç”¨çš„ ï¼Œå°±æƒ³åˆ°äº†ç”¨ nginx é€šè¿‡åå‘ä»£ç†çš„æ–¹å¼è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å…¶ä¸­æœ‰ä¸€ä¸ªå·¨å¤§çš„å‘ï¼ŒåŽé¢ä¼šè®²åˆ°ã€‚ å‰ææ¡ä»¶liunx ä¸‹ nginx å®‰è£…é…ç½®ï¼ˆå°†ä¸åšå¤šçš„é˜è¿°ï¼Œè¯·è‡ªè¡Œç™¾åº¦ï¼‰ é…ç½®nginx é€šè¿‡ Xshell è¿žæŽ¥ liunx æœåŠ¡å™¨ ï¼Œæ‰“å¼€ nginx.conf é…ç½®æ–‡ä»¶ï¼Œæˆ–é€šè¿‡ WinSCP ç›´æŽ¥æ‰“å¼€å¹¶ç¼–è¾‘nginx.confæ–‡ä»¶ ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©åŽè€… ã€‚ï¼ˆå…·ä½“é…ç½®æ–‡ä»¶çš„è·¯å¾„æ ¹æ®ä½ å®‰è£…æ—¶å†³å®šï¼‰ åœ¨é…ç½®æ–‡ä»¶ä¸­æ–°å¢žä¸€ä¸ªserver 123456789101112131415161718192021222324# æ–°å¢žçš„æœåŠ¡ # æ–°å¢žçš„æœåŠ¡ server &#123; listen 8086; # ç›‘å¬çš„ç«¯å£ location / &#123; root /var/www; # vue æ‰“åŒ…åŽé™æ€æ–‡ä»¶å­˜æ”¾çš„åœ°å€ index index.html; # é»˜è®¤ä¸»é¡µåœ°å€ &#125; location /v1 &#123; proxy_pass http://47.106.184.89:9010/v1; # ä»£ç†æŽ¥å£åœ°å€ &#125; location /testApi &#123; proxy_pass http://40.106.197.89:9086/testApi; # ä»£ç†æŽ¥å£åœ°å€ &#125; error_page 500 502 503 504 /50x.html; location = /50x.html &#123; root html; &#125; &#125;å¤åˆ¶ä»£ç  è§£é‡Šè¯´æ˜Ž /var/wwwæ˜¯æˆ‘å½“å‰å°†vue æ–‡ä»¶æ‰“åŒ…åŽå­˜æ”¾åœ¨ liunxä¸‹çš„è·¯å¾„ ï¼Œ å½“æˆ‘ä»¬å¯åŠ¨ nginx åŽ å°±å¯ä»¥é€šè¿‡http://ipåœ°å€:8086/è®¿é—®åˆ°vue æ‰“åŒ…çš„é™æ€æ–‡ä»¶ã€‚ 2.location /v1 æŒ‡æ‹¦æˆªä»¥v1å¼€å¤´çš„è¯·æ±‚ï¼Œhttpè¯·æ±‚æ ¼å¼ä¸ºhttp://ipåœ°å€:8086/v1/***`,è¿™é‡Œæœ‰ä¸€ä¸ªå‘ï¼ä¸€å®šè¦æŒ‰ç…§ä¸Šé¢çš„é…ç½®æ–‡ä»¶**ï¼šproxy_pass http://47.106.184.89:9010/v1; # ä»£ç†æŽ¥å£åœ°å€ï¼Œå¦‚æžœä½ åƒæˆ‘ä¸€å¼€å§‹å†™çš„proxy_pass http://47.106.184.89:9010/; # ä»£ç†æŽ¥å£åœ°å€**ï¼Œä½ æ°¸è¿œä¹ŸåŒ¹é…ä¸åˆ°å¯¹åº”çš„æŽ¥å£ï¼ã€‚ proxy_pass http://47.106.197.89:9093/v1;` å½“æ‹¦æˆªåˆ°éœ€è¦å¤„ç†çš„è¯·æ±‚æ—¶ï¼Œå°†æ‹¦æˆªè¯·æ±‚ä»£ç†åˆ°çš„ æŽ¥å£åœ°å€ã€‚ webpackæ‰“åŒ…ä¸‹é¢æ˜¯config/index.jsé…ç½®æ–‡ä»¶ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950// see http://vuejs-templates.github.io/webpack for documentation.var path = require(&apos;path&apos;)module.exports = &#123; build: &#123; env: require(&apos;./prod.env&apos;), index: path.resolve(__dirname, &apos;../dist/index.html&apos;), assetsRoot: path.resolve(__dirname, &apos;../dist&apos;), assetsSubDirectory: &apos;static&apos;, assetsPublicPath: &apos;.&apos;, productionSourceMap: false, // Gzip off by default as many popular static hosts such as // Surge or Netlify already gzip all static assets for you. // Before setting to `true`, make sure to: // npm install --save-dev compression-webpack-plugin productionGzip: false, productionGzipExtensions: [&apos;js&apos;, &apos;css&apos;], // Run the build command with an extra argument to // View the bundle analyzer report after build finishes: // `npm run build --report` // Set to `true` or `false` to always turn it on or off bundleAnalyzerReport: process.env.npm_config_report &#125;, dev: &#123; env: require(&apos;./dev.env&apos;), port: 8080, // hosts:&quot;0.0.0.0&quot;, autoOpenBrowser: true, assetsSubDirectory: &apos;static&apos;, assetsPublicPath: &apos;/&apos;, //é…ç½®è·¨åŸŸè¯·æ±‚,æ³¨æ„é…ç½®å®Œä¹‹åŽéœ€è¦é‡å¯ç¼–è¯‘è¯¥é¡¹ç›® proxyTable: &#123; //è¯·æ±‚åå­—å˜é‡å¯ä»¥è‡ªå·±å®šä¹‰ &apos;/api&apos;: &#123; target: &apos;http://billing.hybrid.cloud.ctripcorp.com&apos;, // è¯·æ±‚çš„æŽ¥å£åŸŸåæˆ–IPåœ°å€ï¼Œå¼€å¤´æ˜¯httpæˆ–https // secure: false, // å¦‚æžœæ˜¯httpsæŽ¥å£ï¼Œéœ€è¦é…ç½®è¿™ä¸ªå‚æ•° changeOrigin: true,// æ˜¯å¦è·¨åŸŸï¼Œå¦‚æžœæŽ¥å£è·¨åŸŸï¼Œéœ€è¦è¿›è¡Œè¿™ä¸ªå‚æ•°é…ç½® pathRewrite: &#123; &apos;^/api&apos;:&quot;&quot;//è¡¨ç¤ºéœ€è¦rewriteé‡å†™è·¯å¾„ &#125; &#125; &#125;, // CSS Sourcemaps off by default because relative paths are &quot;buggy&quot; // with this option, according to the CSS-Loader README // (https://github.com/webpack/css-loader#sourcemaps) // In our experience, they generally work as expected, // just be aware of this issue when enabling this option. cssSourceMap: false &#125;&#125; Dockerfileæ‰“åŒ…Dockeré•œåƒ 123456789101112FROM Nginx:baseMAINTAINER author &lt;hantmac@outlook.com&gt;WORKDIR /opt/workDirRUN mkdir /var/log/workDirCOPY dist /var/wwwADD nginx/default.conf /etc/nginx/conf.d/default.confENTRYPOINT nginx -g "daemon off;" åŽè®°è¿™æ˜¯é¦–æ¬¡æŽ¥è§¦å‰ç«¯çš„ç¬¬ä¸€ä¸ªé¡¹ç›®ï¼ŒæœŸé—´ç»åŽ†äº†ä»ŽåŽç«¯æŽ¥å£å¼€å‘ï¼Œå‰ç«¯æ¡†æž¶é€‰åž‹ï¼ˆä¸€åº¦æƒ³è¦ç”¨reactï¼ŒåŽæ¥è¿˜æ˜¯æ”¾å¼ƒï¼‰ï¼Œç†Ÿæ‚‰Vueï¼Œåˆ°ç»„ä»¶å¼€å‘ï¼Œwebpackæž„å»ºï¼ŒNginxéƒ¨ç½²ï¼ŒDockerå‘å¸ƒçš„å®Œæ•´è¿‡ç¨‹ã€‚è™½ç„¶é¡µé¢æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æœŸé—´çš„é‡‡å‘æ— æ•°ï¼ŒåŽé¢è¿˜è¦ç»§ç»­åŠªåŠ›ï¼]]></content>
      <categories>
        <category>Frontend</category>
      </categories>
      <tags>
        <tag>Vue</tag>
        <tag>Frontend</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[20181202-Postmortem-debugging-Go-services-with-Delve[ç¿»è¯‘]]]></title>
    <url>%2F2019%2F01%2F20%2F20181202-Postmortem-debugging-Go-services-with-Delve-%E7%BF%BB%E8%AF%91%2F</url>
    <content type="text"><![CDATA[ä½¿ç”¨Delve è°ƒè¯•GoæœåŠ¡çš„ä¸€æ¬¡ç»åŽ† Vladimir Varankin å†™äºŽ 2018/12/02 æŸå¤©ï¼Œæˆ‘ä»¬çš„ç”Ÿäº§æœåŠ¡ä¸Šçš„å‡ ä¸ªå®žä¾‹çªç„¶ä¸èƒ½å¤„ç†å¤–éƒ¨è¿›å…¥çš„æµé‡ï¼ŒHTTPè¯·æ±‚æˆåŠŸé€šè¿‡è´Ÿè½½å‡è¡¡åˆ°è¾¾å®žä¾‹ï¼Œä½†æ˜¯ä¹‹åŽå´hangä½äº†ã€‚æŽ¥ä¸‹æ¥è®°å½•çš„æ˜¯ä¸€æ¬¡è°ƒè¯•åœ¨çº¿GoæœåŠ¡çš„æƒŠå¿ƒåŠ¨é­„çš„ç»åŽ†ã€‚ æ­£æ˜¯ä¸‹é¢é€æ­¥æ¼”ç¤ºçš„æ“ä½œï¼Œå¸®åŠ©æˆ‘ä»¬å®šä½äº†é—®é¢˜çš„æ ¹æœ¬åŽŸå› ã€‚ ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å°†èµ·ä¸€ä¸ªGoå†™çš„HTTPæœåŠ¡ä½œä¸ºè°ƒè¯•ä½¿ç”¨ï¼Œè¿™ä¸ªæœåŠ¡å®žçŽ°çš„ç»†èŠ‚æš‚æ—¶ä¸åšæ·±ç©¶ï¼ˆä¹‹åŽæˆ‘ä»¬å°†æ·±å…¥åˆ†æžä»£ç ï¼‰ã€‚ä¸€ä¸ªçœŸå®žçš„ç”Ÿäº§åº”ç”¨å¯èƒ½åŒ…å«å¾ˆå¤šç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å®žçŽ°äº†ä¸šåŠ¡ç½—å’ŒæœåŠ¡çš„åŸºç¡€æž¶æž„ã€‚æˆ‘ä»¬å¯ä»¥ç¡®ä¿¡ï¼Œè¿™äº›åº”ç”¨å·²ç»åœ¨ç”Ÿäº§çŽ¯å¢ƒâ€œèº«ç»ç™¾æˆ˜â€ :)ã€‚ æºä»£ç ä»¥åŠé…ç½®ç»†èŠ‚å¯ä»¥æŸ¥çœ‹GitHubä»“åº“ã€‚ä¸ºäº†å®ŒæˆæŽ¥ä¸‹æ¥çš„å·¥ä½œï¼Œä½ éœ€è¦ä¸€å°Linuxç³»ç»Ÿçš„è™šæœºï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨vagrant-hostmanageræ’ä»¶ã€‚Vagrantfileåœ¨GitHubä»“åº“çš„æ ¹ç›®å½•ï¼Œå¯ä»¥æŸ¥çœ‹æ›´å¤šç»†èŠ‚ã€‚ è®©æˆ‘ä»¬å¼€å¯è™šæœºï¼Œæž„å»ºHTTPæœåŠ¡å¹¶ä¸”è¿è¡Œèµ·æ¥ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š 12345678910$ vagrant upBringing machine 'server-test-1' up with 'virtualbox' provider...$ vagrant ssh server-test-1Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-33-generic x86_64)Â·Â·Â·vagrant@server-test-1:~$ cd /vagrant/example/servervagrant@server-test-1:/vagrant/example/server$ go buildvagrant@server-test-1:/vagrant/example/server$ ./server --addr=:10080server listening addr=:10080 é€šè¿‡curlå‘é€è¯·æ±‚åˆ°æ‰€èµ·çš„HTTPæœåŠ¡ï¼Œå¯ä»¥åˆ¤æ–­å…¶æ˜¯å¦å¤„äºŽå·¥ä½œçŠ¶æ€ï¼Œæ–°å¼€ä¸€ä¸ªterminalå¹¶æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š 12$ curl 'http://server-test-1:10080'OK ä¸ºäº†æ¨¡æ‹Ÿå¤±è´¥çš„æƒ…å†µï¼Œæˆ‘ä»¬éœ€è¦å‘é€å¤§é‡è¯·æ±‚åˆ°HTTPæœåŠ¡ï¼Œè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨HTTP benchmarkæµ‹è¯•å·¥å…·wrkè¿›è¡Œæ¨¡æ‹Ÿã€‚æˆ‘çš„MacBookæ˜¯4æ ¸çš„ï¼Œæ‰€ä»¥ä½¿ç”¨4ä¸ªçº¿ç¨‹è¿è¡Œwrkï¼Œèƒ½å¤Ÿäº§ç”Ÿ1000ä¸ªè¿žæŽ¥ï¼ŒåŸºæœ¬èƒ½å¤Ÿæ»¡è¶³éœ€æ±‚ã€‚ 1234$ wrk -d1m -t4 -c1000 'http://server-test-1:10080'Running 1m test @ http://server-test-1:10080 4 threads and 1000 connections Â·Â·Â· ä¸€ä¼šçš„æ—¶é—´ï¼ŒæœåŠ¡å™¨hangä½äº†ã€‚ç”šè‡³ç­‰wrkè·‘å®Œä¹‹åŽï¼ŒæœåŠ¡å™¨å·²ç»ä¸èƒ½å¤„ç†ä»»ä½•è¯·æ±‚ï¼š 12$ curl --max-time 5 'http://server-test-1:10080/'curl: (28) Operation timed out after 5001 milliseconds with 0 bytes received æˆ‘ä»¬é‡åˆ°éº»çƒ¦äº†ï¼è®©æˆ‘ä»¬åˆ†æžä¸€ä¸‹ã€‚ åœ¨æˆ‘ä»¬ç”Ÿäº§æœåŠ¡çš„çœŸå®žåœºæ™¯ä¸­ï¼ŒæœåŠ¡å™¨èµ·æ¥ä»¥åŽï¼Œgoroutinesçš„æ•°é‡ç”±äºŽè¯·æ±‚çš„å¢žå¤šè€Œè¿…é€Ÿå¢žåŠ ï¼Œä¹‹åŽä¾¿å¤±åŽ»å“åº”ã€‚å¯¹pprofè°ƒè¯•å¥æŸ„çš„è¯·æ±‚å˜å¾—éžå¸¸éžå¸¸æ…¢ï¼Œçœ‹èµ·æ¥å°±åƒæœåŠ¡å™¨â€œæ­»æŽ‰äº†â€ã€‚åŒæ ·ï¼Œæˆ‘ä»¬ä¹Ÿå°è¯•ä½¿ç”¨SIGQUITå‘½ä»¤æ€æŽ‰è¿›ç¨‹ä»¥é‡Šæ”¾æ‰€è¿è¡Œgoroutineså †æ ˆï¼Œä½†æ˜¯æ”¶ä¸åˆ°ä»»ä½•æ•ˆæžœã€‚ GDBå’ŒCoredumpæˆ‘ä»¬å¯ä»¥ä½¿ç”¨GDBï¼ˆGNU Debuggerï¼‰å°è¯•è¿›å…¥æ­£åœ¨è¿è¡Œçš„æœåŠ¡å†…éƒ¨ã€‚ åœ¨ç”Ÿäº§çŽ¯å¢ƒè¿è¡Œè°ƒè¯•å™¨å¯èƒ½éœ€è¦é¢å¤–çš„æƒé™ï¼Œæ‰€ä»¥ä¸Žä½ çš„å›¢é˜Ÿæå‰æ²Ÿé€šæ˜¯å¾ˆæ˜Žæ™ºçš„ã€‚ åœ¨è™šæœºä¸Šå†å¼€å¯ä¸€ä¸ªSSHä¼šè¯ï¼Œæ‰¾åˆ°æœåŠ¡å™¨çš„è¿›ç¨‹idå¹¶ä½¿ç”¨è°ƒè¯•å™¨è¿žæŽ¥åˆ°è¯¥è¿›ç¨‹ï¼š 123456789$ vagrant ssh server-test-1Welcome to Ubuntu 18.04.1 LTS (GNU/Linux 4.15.0-33-generic x86_64)Â·Â·Â·vagrant@server-test-1:~$ pgrep server1628vagrant@server-test-1:~$ cd /vagrantvagrant@server-test-1:/vagrant$ sudo gdb --pid=1628 example/server/serverGNU gdb (Ubuntu 8.1-0ubuntu3) 8.1.0.20180409-gitÂ·Â·Â· è°ƒè¯•å™¨è¿žæŽ¥åˆ°æœåŠ¡å™¨è¿›ç¨‹ä¹‹åŽï¼Œæˆ‘ä»¬å¯ä»¥è¿è¡ŒGDBçš„btå‘½ä»¤ï¼ˆaka backtraceï¼‰æ¥æ£€æŸ¥å½“å‰çº¿ç¨‹çš„å †æ ˆä¿¡æ¯ï¼š 12345678910(gdb) bt#0 runtime.futex () at /usr/local/go/src/runtime/sys_linux_amd64.s:532#1 0x000000000042b08b in runtime.futexsleep (addr=0xa9a160 &lt;runtime.m0+320&gt;, ns=-1, val=0) at /usr/local/go/src/runtime/os_linux.go:46#2 0x000000000040c382 in runtime.notesleep (n=0xa9a160 &lt;runtime.m0+320&gt;) at /usr/local/go/src/runtime/lock_futex.go:151#3 0x0000000000433b4a in runtime.stoplockedm () at /usr/local/go/src/runtime/proc.go:2165#4 0x0000000000435279 in runtime.schedule () at /usr/local/go/src/runtime/proc.go:2565#5 0x00000000004353fe in runtime.park_m (gp=0xc000066d80) at /usr/local/go/src/runtime/proc.go:2676#6 0x000000000045ae1b in runtime.mcall () at /usr/local/go/src/runtime/asm_amd64.s:299#7 0x000000000045ad39 in runtime.rt0_go () at /usr/local/go/src/runtime/asm_amd64.s:201#8 0x0000000000000000 in ?? () è¯´å®žè¯æˆ‘å¹¶ä¸æ˜¯GDBçš„ä¸“å®¶ï¼Œä½†æ˜¯æ˜¾è€Œæ˜“è§Goè¿è¡Œæ—¶ä¼¼ä¹Žä½¿çº¿ç¨‹è¿›å…¥ç¡çœ çŠ¶æ€äº†ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿ è°ƒè¯•ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„è¿›ç¨‹æ˜¯ä¸æ˜Žæ™ºçš„ï¼Œä¸å¦‚å°†è¯¥çº¿ç¨‹çš„coredumpä¿å­˜ä¸‹æ¥ï¼Œè¿›è¡Œç¦»çº¿åˆ†æžã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨GDBçš„gcoreå‘½ä»¤ï¼Œè¯¥å‘½ä»¤å°†coreæ–‡ä»¶ä¿å­˜åœ¨å½“å‰å·¥ä½œç›®å½•å¹¶å‘½åä¸ºcore.&lt;process_id&gt;ã€‚ 123456789(gdb) gcoreSaved corefile core.1628(gdb) quitA debugging session is active. Inferior 1 [process 1628] will be detached.Quit anyway? (y or n) yDetaching from program: /vagrant/example/server/server, process 1628 coreæ–‡ä»¶ä¿å­˜åŽï¼ŒæœåŠ¡å™¨æ²¡å¿…è¦ç»§ç»­è¿è¡Œï¼Œä½¿ç”¨kill -9ç»“æŸå®ƒã€‚ æˆ‘ä»¬èƒ½å¤Ÿæ³¨æ„åˆ°ï¼Œå³ä½¿æ˜¯ä¸€ä¸ªç®€å•çš„æœåŠ¡å™¨ï¼Œcoreæ–‡ä»¶ä¾ç„¶ä¼šå¾ˆå¤§ï¼ˆæˆ‘è¿™ä¸€ä»½æ˜¯1.2Gï¼‰,å¯¹äºŽç”Ÿäº§çš„æœåŠ¡æ¥è¯´ï¼Œå¯èƒ½ä¼šæ›´åŠ å·¨å¤§ã€‚ å¦‚æžœéœ€è¦äº†è§£æ›´å¤šä½¿ç”¨GDBè°ƒè¯•çš„æŠ€å·§ï¼Œå¯ä»¥ç»§ç»­é˜…è¯»ä½¿ç”¨GDBè°ƒè¯•Goä»£ç ã€‚ ä½¿ç”¨Delveè°ƒè¯•å™¨Delveæ˜¯ä¸€ä¸ªé’ˆå¯¹Goç¨‹åºçš„è°ƒè¯•å™¨ã€‚å®ƒç±»ä¼¼äºŽGDBï¼Œä½†æ˜¯æ›´å…³æ³¨Goçš„è¿è¡Œæ—¶ã€æ•°æ®ç»“æž„ä»¥åŠå…¶ä»–å†…éƒ¨çš„æœºåˆ¶ã€‚ å¦‚æžœä½ å¯¹Delveçš„å†…éƒ¨å®žçŽ°æœºåˆ¶å¾ˆæ„Ÿå…´è¶£ï¼Œé‚£ä¹ˆæˆ‘ååˆ†æŽ¨èä½ é˜…è¯»Alessandro Arzilliåœ¨GopherCon EU 2018æ‰€ä½œçš„æ¼”è®²ï¼Œ[Internal Architecture of Delve, a Debugger For Go]ã€‚ Delveæ˜¯ç”¨Goå†™çš„ï¼Œæ‰€ä»¥å®‰è£…èµ·æ¥éžå¸¸ç®€å•ï¼š 1$ go get -u github.com/derekparker/delve/cmd/dlv Delveå®‰è£…ä»¥åŽï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è¿è¡Œdlv core &lt;path to service binary&gt; &lt;core file&gt;æ¥åˆ†æžcoreæ–‡ä»¶ã€‚æˆ‘ä»¬å…ˆåˆ—å‡ºæ‰§è¡Œcoredumpæ—¶æ­£åœ¨è¿è¡Œçš„æ‰€æœ‰goroutinesã€‚Delveçš„goroutineså‘½ä»¤å¦‚ä¸‹ï¼š 1234567$ dlv core example/server/server core.1628(dlv) goroutines Â·Â·Â· Goroutine 4611 - User: /vagrant/example/server/metrics.go:113 main.(*Metrics).CountS (0x703948) Goroutine 4612 - User: /vagrant/example/server/metrics.go:113 main.(*Metrics).CountS (0x703948) Goroutine 4613 - User: /vagrant/example/server/metrics.go:113 main.(*Metrics).CountS (0x703948) ä¸å¹¸çš„æ˜¯ï¼Œåœ¨çœŸå®žç”Ÿäº§çŽ¯å¢ƒä¸‹ï¼Œè¿™ä¸ªåˆ—è¡¨å¯èƒ½ä¼šå¾ˆé•¿ï¼Œç”šè‡³ä¼šè¶…å‡ºterminalçš„ç¼“å†²åŒºã€‚ç”±äºŽæœåŠ¡å™¨ä¸ºæ¯ä¸€ä¸ªè¯·æ±‚éƒ½ç”Ÿæˆä¸€ä¸ªå¯¹åº”çš„goroutineï¼Œæ‰€ä»¥goroutineså‘½ä»¤ç”Ÿæˆçš„åˆ—è¡¨å¯èƒ½ä¼šæœ‰ç™¾ä¸‡æ¡ã€‚æˆ‘ä»¬å‡è®¾çŽ°åœ¨å·²ç»é‡åˆ°è¿™ä¸ªé—®é¢˜ï¼Œå¹¶æƒ³ä¸€ä¸ªæ–¹æ³•æ¥è§£å†³å®ƒã€‚ Delveæ”¯æŒâ€headlessâ€æ¨¡å¼ï¼Œå¹¶ä¸”èƒ½å¤Ÿé€šè¿‡JSON-RPC APIä¸Žè°ƒè¯•å™¨äº¤äº’ã€‚ è¿è¡Œdlv coreå‘½ä»¤ï¼ŒæŒ‡å®šæƒ³è¦å¯åŠ¨çš„Delve API serverï¼š 123$ dlv core example/server/server core.1628 --listen :44441 --headless --logAPI server listening at: [::]:44441INFO[0000] opening core file core.1628 (executable example/server/server) layer=debugger è°ƒè¯•æœåŠ¡å™¨è¿è¡ŒåŽï¼Œæˆ‘ä»¬å¯ä»¥å‘é€å‘½ä»¤åˆ°å…¶TCPç«¯å£å¹¶å°†è¿”å›žç»“æžœä»¥åŽŸç”ŸJSONçš„æ ¼å¼å­˜å‚¨ã€‚æˆ‘ä»¬ä»¥ä¸Šé¢ç›¸åŒçš„æ–¹å¼å¾—åˆ°æ­£åœ¨è¿è¡Œçš„goroutinesï¼Œä¸åŒçš„æ˜¯æˆ‘ä»¬å°†ç»“æžœå­˜å‚¨åˆ°æ–‡ä»¶ä¸­ï¼š 1$ echo -n '&#123;"method":"RPCServer.ListGoroutines","params":[],"id":2&#125;' | nc -w 1 localhost 44441 &gt; server-test-1_dlv-rpc-list_goroutines.json çŽ°åœ¨æˆ‘ä»¬æ‹¥æœ‰äº†ä¸€ä¸ªï¼ˆæ¯”è¾ƒå¤§çš„ï¼‰JSONæ–‡ä»¶ï¼Œé‡Œé¢å­˜å‚¨å¤§é‡åŽŸå§‹ä¿¡æ¯ã€‚æŽ¨èä½¿ç”¨jqå‘½ä»¤è¿›ä¸€æ­¥äº†è§£JSONæ•°æ®çš„åŽŸè²Œï¼Œä¸¾ä¾‹ï¼šè¿™é‡Œæˆ‘èŽ·å–JSONæ•°æ®çš„resultå­—æ®µçš„å‰ä¸‰ä¸ªå¯¹è±¡ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657$ jq '.result[0:3]' server-test-1_dlv-rpc-list_goroutines.json[ &#123; "id": 1, "currentLoc": &#123; "pc": 4380603, "file": "/usr/local/go/src/runtime/proc.go", "line": 303, "function": &#123; "name": "runtime.gopark", "value": 4380368, "type": 0, "goType": 0, "optimized": true &#125; &#125;, "userCurrentLoc": &#123; "pc": 6438159, "file": "/vagrant/example/server/main.go", "line": 52, "function": &#123; "name": "main.run", "value": 6437408, "type": 0, "goType": 0, "optimized": true &#125; &#125;, "goStatementLoc": &#123; "pc": 4547433, "file": "/usr/local/go/src/runtime/asm_amd64.s", "line": 201, "function": &#123; "name": "runtime.rt0_go", "value": 4547136, "type": 0, "goType": 0, "optimized": true &#125; &#125;, "startLoc": &#123; "pc": 4379072, "file": "/usr/local/go/src/runtime/proc.go", "line": 110, "function": &#123; "name": "runtime.main", "value": 4379072, "type": 0, "goType": 0, "optimized": true &#125; &#125;, "threadID": 0, "unreadable": "" &#125;, Â·Â·Â·] JSONæ•°æ®ä¸­çš„æ¯ä¸ªå¯¹è±¡éƒ½ä»£è¡¨äº†ä¸€ä¸ªgoroutineã€‚é€šè¿‡å‘½ä»¤æ‰‹å†Œ å¯çŸ¥ï¼Œgoroutineså‘½ä»¤å¯ä»¥èŽ·å¾—æ¯ä¸€ä¸ªgoroutinesçš„ä¿¡æ¯ã€‚é€šè¿‡æ‰‹å†Œæˆ‘ä»¬èƒ½å¤Ÿåˆ†æžå‡ºuserCurrentLocå­—æ®µæ˜¯æœåŠ¡å™¨æºç ä¸­goroutinesæœ€åŽå‡ºçŽ°çš„åœ°æ–¹ã€‚ ä¸ºäº†èƒ½å¤Ÿäº†è§£å½“core fileåˆ›å»ºçš„æ—¶å€™ï¼Œgoroutinesæ­£åœ¨åšä»€ä¹ˆï¼Œæˆ‘ä»¬éœ€è¦æ”¶é›†JSONæ–‡ä»¶ä¸­åŒ…å«userCurrentLocå­—æ®µçš„å‡½æ•°åå­—ä»¥åŠå…¶è¡Œå·ï¼š 123456789$ jq -c '.result[] | [.userCurrentLoc.function.name, .userCurrentLoc.line]' server-test-1_dlv-rpc-list_goroutines.json | sort | uniq -c 1 ["internal/poll.runtime_pollWait",173]1000 ["main.(*Metrics).CountS",95] 1 ["main.(*Metrics).SetM",105] 1 ["main.(*Metrics).startOutChannelConsumer",179] 1 ["main.run",52] 1 ["os/signal.signal_recv",139] 6 ["runtime.gopark",303] å¤§é‡çš„goroutines(ä¸Šé¢æ˜¯1000ä¸ª)åœ¨å‡½æ•°main.(*Metrics).CoutSçš„95è¡Œè¢«é˜»å¡žã€‚çŽ°åœ¨æˆ‘ä»¬å›žå¤´çœ‹ä¸€ä¸‹æˆ‘ä»¬æœåŠ¡å™¨çš„æºç ã€‚ åœ¨mainåŒ…ä¸­æ‰¾åˆ°Metricsç»“æž„ä½“å¹¶ä¸”æ‰¾åˆ°å®ƒçš„CountSæ–¹æ³•ï¼ˆexample/server/metrics.goï¼‰ã€‚ 1234// CountS increments counter per second.func (m *Metrics) CountS(key string) &#123; m.inChannel &lt;- NewCountMetric(key, 1, second)&#125; æˆ‘ä»¬çš„æœåŠ¡å™¨åœ¨å¾€inChannelé€šé“å‘é€çš„æ—¶å€™é˜»å¡žä½äº†ã€‚è®©æˆ‘ä»¬æ‰¾å‡ºè°è´Ÿè´£ä»Žè¿™ä¸ªé€šé“è¯»å–æ•°æ®ï¼Œæ·±å…¥ç ”ç©¶ä»£ç ä¹‹åŽæˆ‘ä»¬æ‰¾åˆ°äº†ä¸‹é¢çš„å‡½æ•°ï¼š 123456// starts a consumer for inChannelfunc (m *Metrics) startInChannelConsumer() &#123; for inMetrics := range m.inChannel &#123; // Â·Â·Â· &#125;&#125; è¿™ä¸ªå‡½æ•°é€ä¸ªåœ°ä»Žé€šé“ä¸­è¯»å–æ•°æ®å¹¶åŠ ä»¥å¤„ç†ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¸‹å‘é€åˆ°è¿™ä¸ªé€šé“çš„ä»»åŠ¡ä¼šè¢«é˜»å¡žå‘¢ï¼Ÿ å½“å¤„ç†é€šé“çš„æ—¶å€™ï¼Œæ ¹æ®Dave Cheneyçš„é€šé“å‡†åˆ™ï¼Œåªæœ‰å››ç§æƒ…å†µå¯èƒ½å¯¼è‡´é€šé“æœ‰é—®é¢˜ï¼š å‘ä¸€ä¸ªnilé€šé“å‘é€ ä»Žä¸€ä¸ªnilé€šé“æŽ¥æ”¶ å‘ä¸€ä¸ªå·²å…³é—­çš„é€šé“å‘é€ ä»Žä¸€ä¸ªå·²å…³é—­çš„é€šé“æŽ¥æ”¶å¹¶ç«‹å³è¿”å›žé›¶å€¼ ç¬¬ä¸€çœ¼å°±çœ‹åˆ°äº†â€œå‘ä¸€ä¸ªnilé€šé“å‘é€â€ï¼Œè¿™çœ‹èµ·æ¥åƒæ˜¯é—®é¢˜çš„åŽŸå› ã€‚ä½†æ˜¯åå¤æ£€æŸ¥ä»£ç åŽï¼ŒinChannelæ˜¯ç”±Metricsåˆå§‹åŒ–çš„ï¼Œä¸å¯èƒ½ä¸ºnilã€‚ nä½ å¯èƒ½ä¼šæ³¨æ„åˆ°ï¼Œä½¿ç”¨jqå‘½ä»¤èŽ·å–åˆ°çš„ä¿¡æ¯ä¸­ï¼Œæ²¡æœ‰startInChannelConsumeræ–¹æ³•ã€‚ä¼šä¸ä¼šæ˜¯å› ä¸ºåœ¨main.(*Metrics).startInChannelConsumerçš„æŸä¸ªåœ°æ–¹é˜»å¡žè€Œå¯¼è‡´è¿™ä¸ªï¼ˆå¯ç¼“å†²ï¼‰é€šé“æ»¡äº†ï¼Ÿ Delveèƒ½å¤Ÿæä¾›ä»Žå¼€å§‹ä½ç½®åˆ°userCurrentLocå­—æ®µä¹‹é—´çš„åˆå§‹ä½ç½®ä¿¡æ¯ï¼Œè¿™ä¸ªä¿¡æ¯å­˜å‚¨åˆ°startLocå­—æ®µä¸­ã€‚ä½¿ç”¨ä¸‹é¢çš„jqå‘½ä»¤å¯ä»¥æŸ¥è¯¢å‡ºæ‰€æœ‰goroutines,å…¶åˆå§‹ä½ç½®éƒ½åœ¨å‡½æ•°startInChannelConsumerä¸­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142$ jq '.result[] | select(.startLoc.function.name | test("startInChannelConsumer$"))' server-test-1_dlv-rpc-list_goroutines.json&#123; "id": 20, "currentLoc": &#123; "pc": 4380603, "file": "/usr/local/go/src/runtime/proc.go", "line": 303, "function": &#123; "name": "runtime.gopark", "value": 4380368, "type": 0, "goType": 0, "optimized": true &#125; &#125;, "userCurrentLoc": &#123; "pc": 6440847, "file": "/vagrant/example/server/metrics.go", "line": 105, "function": &#123; "name": "main.(*Metrics).SetM", "value": 6440672, "type": 0, "goType": 0, "optimized": true &#125; &#125;, "startLoc": &#123; "pc": 6440880, "file": "/vagrant/example/server/metrics.go", "line": 109, "function": &#123; "name": "main.(*Metrics).startInChannelConsumer", "value": 6440880, "type": 0, "goType": 0, "optimized": true &#125; &#125;, Â·Â·Â·&#125; ç»“æžœä¸­æœ‰ä¸€æ¡ä¿¡æ¯éžå¸¸æŒ¯å¥‹äººå¿ƒï¼ åœ¨main.(*Metrics).startInChannelConsumerï¼Œ109è¡Œï¼ˆçœ‹ç»“æžœä¸­çš„startLocå­—æ®µï¼‰ï¼Œæœ‰ä¸€ä¸ªidä¸º20çš„goroutinesé˜»å¡žä½äº†ï¼ æ‹¿åˆ°goroutinesçš„idèƒ½å¤Ÿå¤§å¤§é™ä½Žæˆ‘ä»¬æœç´¢çš„èŒƒå›´ï¼ˆå¹¶ä¸”æˆ‘ä»¬å†ä¹Ÿä¸ç”¨æ·±å…¥åºžå¤§çš„JSONæ–‡ä»¶äº†ï¼‰ã€‚ä½¿ç”¨Delveçš„goroutineså‘½ä»¤æˆ‘ä»¬èƒ½å¤Ÿå°†å½“å‰goroutinesåˆ‡æ¢åˆ°ç›®æ ‡goroutinesï¼Œç„¶åŽå¯ä»¥ä½¿ç”¨stackå‘½ä»¤æ‰“å°è¯¥goroutinesçš„å †æ ˆä¿¡æ¯ï¼š 123456789101112131415161718192021222324252627282930313233$ dlv core example/server/server core.1628(dlv) goroutine 20Switched from 0 to 20 (thread 1628)(dlv) stack -full0 0x000000000042d7bb in runtime.gopark at /usr/local/go/src/runtime/proc.go:303 lock = unsafe.Pointer(0xc000104058) reason = waitReasonChanSendÂ·Â·Â·3 0x00000000004066a5 in runtime.chansend1 at /usr/local/go/src/runtime/chan.go:125 c = (unreadable empty OP stack) elem = (unreadable empty OP stack)4 0x000000000062478f in main.(*Metrics).SetM at /vagrant/example/server/metrics.go:105 key = (unreadable empty OP stack) m = (unreadable empty OP stack) value = (unreadable empty OP stack)5 0x0000000000624e64 in main.(*Metrics).sendMetricsToOutChannel at /vagrant/example/server/metrics.go:146 m = (*main.Metrics)(0xc000056040) scope = 0 updateInterval = (unreadable could not find loclist entry at 0x89f76 for address 0x624e63)6 0x0000000000624a2f in main.(*Metrics).startInChannelConsumer at /vagrant/example/server/metrics.go:127 m = (*main.Metrics)(0xc000056040) inMetrics = main.Metric &#123;Type: TypeCount, Scope: 0, Key: "server.req-incoming",...+2 more&#125; nextUpdate = (unreadable could not find loclist entry at 0x89e86 for address 0x624a2e) ä»Žä¸‹å¾€ä¸Šåˆ†æžï¼š ï¼ˆ6ï¼‰ä¸€ä¸ªæ¥è‡ªé€šé“çš„æ–°inMetricså€¼åœ¨main.(*Metrics).startInChannelConsumerä¸­è¢«æŽ¥æ”¶ ï¼ˆ5ï¼‰æˆ‘ä»¬è°ƒç”¨main.(*Metrics).sendMetricsToOutChannelå¹¶ä¸”åœ¨example/server/metrics.goçš„146è¡Œè¿›è¡Œå¤„ç† ï¼ˆ4ï¼‰ç„¶åŽmain.(*Metrics).SetMè¢«è°ƒç”¨ ä¸€ç›´è¿è¡Œåˆ°runtime.goparkä¸­çš„waitReasonChanSendé˜»å¡žï¼ ä¸€åˆ‡çš„ä¸€åˆ‡éƒ½æ˜Žæœ—äº†ï¼ å•ä¸ªgoroutinesä¸­ï¼Œä¸€ä¸ªä»Žç¼“å†²é€šé“è¯»å–æ•°æ®çš„å‡½æ•°ï¼ŒåŒæ—¶ä¹Ÿåœ¨å¾€é€šé“ä¸­å‘é€æ•°æ®ã€‚å½“è¿›å…¥é€šé“çš„å€¼è¾¾åˆ°é€šé“çš„å®¹é‡æ—¶ï¼Œæ¶ˆè´¹å‡½æ•°ç»§ç»­å¾€å·²æ»¡çš„é€šé“ä¸­å‘é€æ•°æ®å°±ä¼šé€ æˆè‡ªèº«çš„æ­»é”ã€‚ç”±äºŽå•ä¸ªé€šé“çš„æ¶ˆè´¹è€…æ­»é”ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªå°è¯•å¾€é€šé“ä¸­å‘é€æ•°æ®çš„è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡žã€‚ è¿™å°±æ˜¯æˆ‘ä»¬çš„æ•…äº‹ï¼Œä½¿ç”¨ä¸Šè¿°è°ƒè¯•æŠ€æœ¯å¸®åŠ©æˆ‘ä»¬å‘çŽ°äº†é—®é¢˜çš„æ ¹æºã€‚é‚£äº›ä»£ç æ˜¯å¾ˆå¤šå¹´å‰å†™çš„ï¼Œç”šè‡³ä»Žæ²¡æœ‰äººçœ‹è¿‡è¿™äº›ä»£ç ï¼Œä¹Ÿä¸‡ä¸‡æ²¡æœ‰æƒ³åˆ°ä¼šå¯¼è‡´è¿™ä¹ˆå¤§çš„é—®é¢˜ã€‚ å¦‚ä½ æ‰€è§ï¼Œå¹¶ä¸æ˜¯æ‰€æœ‰é—®é¢˜éƒ½èƒ½ç”±å·¥å…·è§£å†³ï¼Œä½†æ˜¯å·¥å…·èƒ½å¤Ÿå¸®åŠ©ä½ æ›´å¥½åœ°å·¥ä½œã€‚æˆ‘å¸Œæœ›ï¼Œé€šè¿‡æ­¤æ–‡èƒ½å¤Ÿæ¿€åŠ±ä½ å¤šå¤šå°è¯•è¿™äº›å·¥å…·ã€‚æˆ‘éžå¸¸ä¹æ„å€¾å¬ä½ ä»¬å¤„ç†ç±»ä¼¼é—®é¢˜çš„å…¶å®ƒè§£å†³æ–¹æ¡ˆã€‚ Vladimiræ˜¯ä¸€ä¸ªåŽç«¯å¼€å‘å·¥ç¨‹å¸ˆï¼Œç›®å‰å°±èŒäºŽadjust.com. @tvii on Twitter, @narqo on Github via: https://blog.gopheracademy.com/advent-2018/postmortem-debugging-delve/ ä½œè€…ï¼šVladimir Varankinè¯‘è€…ï¼šhantmac]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[è‡ªåŠ¨åŒ–è„šæœ¬å®žçŽ°goå®‰è£…ä¸Žå‡çº§]]></title>
    <url>%2F2019%2F01%2F12%2F%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0go%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%87%E7%BA%A7%2F</url>
    <content type="text"><![CDATA[æºç å®‰è£…ï¼š ä¸‹è½½å¯¹åº”çš„æ“ä½œç³»ç»Ÿçš„æœ€æ–°çš„ Golang ç‰ˆæœ¬ï¼šhttps://golang.org/dl/ åœ¨ home ç›®å½•ä¸‹å»ºç«‹ installGoç›®å½•ï¼Œç„¶åŽåœ¨è¯¥ç›®å½•ä¸‹æ–°å»ºå‡çº§ä¸Žéƒ¨ç½²æ–‡ä»¶ä»¥åŠä¸‹è½½æœ€æ–°çš„ golang æºç åŒ…ï¼š ä»¥ä¸‹æ˜¯ installOrUpdate.sh å…·ä½“å†…å®¹ï¼š 1234567891011121314151617# !/bin/bashif [ -z "$1" ]; thenâ€‹ echo "usage: ./install.sh go-package.tar.gz"â€‹ exitfiif [ -d "/usr/local/go" ]; thenâ€‹ echo "Uninstalling old go version..."â€‹ sudo rm -rf /usr/local/gofiecho "Installing..."sudo tar -C /usr/local -xzf $1echo export GOPATH=/go" &gt;&gt; /etc/profileecho export GOROOT=/usr/local/go &gt;&gt; /etc/profileecho export PATH=$PATH:$GOROOT/bin:$GOPATH/bin1 &gt;&gt; /etc/profilesource /etc/profilerm -rf $1echo "Done" ç„¶åŽè¿è¡Œï¼š sudo sh install.sh go1.10.linux-amd64.tar.gz æˆ–è€…æ‰‹åŠ¨è®¾ç½®å¥½GOPATHï¼ŒGOROOT ç¼–è¾‘ /etc/profile åœ¨æ–‡ä»¶å°¾éƒ¨åŠ å…¥ï¼š 12345export GOPATH=/goexport GOROOT=/usr/local/goexport PATH=$PATH:$GOROOT/bin:$GOPATH/bin1è¿è¡Œ source /etc/profile è®©çŽ¯å¢ƒå˜é‡ç”Ÿæ•ˆ è‡³æ­¤ï¼ŒGo å·²å®‰è£…æˆåŠŸ å‡çº§ å¦‚æžœéœ€è¦å‡çº§çš„è¯åªéœ€è¦å°†æœ€æ–°çš„æºç åŒ…ä¸‹è½½åˆ°ç¬¬ä¸€æ­¥çš„ installGo æ–‡ä»¶å¤¹ä¸‹ï¼Œç„¶åŽè¿è¡Œsudo sh install.sh go1.xx.linux-amd64.tar.gz å³å¯ã€‚ shellè„šæœ¬æ›´æ–°åœ°å€github]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[beegoæ³¨è§£è·¯ç”±ä¸­@Paramçš„å‚æ•°è§£é‡Š]]></title>
    <url>%2F2019%2F01%2F03%2Fbeego%E6%B3%A8%E8%A7%A3%E8%B7%AF%E7%94%B1%E4%B8%AD-Param%E7%9A%84%E5%8F%82%E6%95%B0%E8%A7%A3%E9%87%8A%2F</url>
    <content type="text"><![CDATA[beegoæ³¨è§£è·¯ç”±çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæˆ‘ä»¬çš„æ³¨é‡Šåˆ†ä¸ºä»¥ä¸‹ç±»åˆ«ï¼š @Title æŽ¥å£çš„æ ‡é¢˜ï¼Œç”¨æ¥æ ‡ç¤ºå”¯ä¸€æ€§ï¼Œå”¯ä¸€ï¼Œå¯é€‰ æ ¼å¼ï¼šä¹‹åŽè·Ÿä¸€ä¸ªæè¿°å­—ç¬¦ä¸² @Description æŽ¥å£çš„ä½œç”¨ï¼Œç”¨æ¥æè¿°æŽ¥å£çš„ç”¨é€”ï¼Œå”¯ä¸€ï¼Œå¯é€‰ æ ¼å¼ï¼šä¹‹åŽè·Ÿä¸€ä¸ªæè¿°å­—ç¬¦ä¸² @Param è¯·æ±‚çš„å‚æ•°ï¼Œç”¨æ¥æè¿°æŽ¥å—çš„å‚æ•°ï¼Œå¤šä¸ªï¼Œå¯é€‰ æ ¼å¼ï¼šå˜é‡å ä¼ è¾“ç±»åž‹ ç±»åž‹ æ˜¯å¦å¿…é¡» æè¿° ä¼ è¾“ç±»åž‹ï¼špaht or body ç±»åž‹ï¼š å˜é‡åå’Œæè¿°æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸² æ˜¯å¦å¿…é¡»ï¼štrue æˆ–è€…false string int int64 å¯¹è±¡ï¼Œè¿™ä¸ªåœ°æ–¹å¤§å®¶å†™çš„æ—¶å€™éœ€è¦æ³¨æ„ï¼Œéœ€è¦æ˜¯ç›¸å¯¹äºŽå½“å‰é¡¹ç›®çš„è·¯å¾„.å¯¹è±¡ï¼Œä¾‹å¦‚models.Objectè¡¨ç¤ºmodelsç›®å½•ä¸‹çš„Objectå¯¹è±¡ï¼Œè¿™æ ·beeåœ¨ç”Ÿæˆæ–‡æ¡£çš„æ—¶å€™ä¼šåŽ»æ‰«ææ”¹å¯¹è±¡å¹¶æ˜¾ç¤ºç»™ç”¨æˆ·æ”¹å¯¹è±¡ã€‚ query è¡¨ç¤ºå¸¦åœ¨urlä¸²é‡Œé¢?aa=bb&amp;cc=dd form è¡¨ç¤ºä½¿ç”¨è¡¨å•é€’äº¤æ•°æ® path è¡¨ç¤ºURLä¸²ä¸­å¾—å­—ç¬¦ï¼Œä¾‹å¦‚/user/{uid} é‚£ä¹ˆuidå°±æ˜¯ä¸€ä¸ªpathç±»åž‹çš„å‚æ•° body è¡¨ç¤ºä½¿ç”¨raw bodyè¿›è¡Œæ•°æ®çš„ä¼ è¾“ header è¡¨ç¤ºé€šè¿‡headerè¿›è¡Œæ•°æ®çš„ä¼ è¾“ @Success æˆåŠŸè¿”å›žçš„codeå’Œå¯¹è±¡æˆ–è€…ä¿¡æ¯ æ ¼å¼ï¼šcode å¯¹è±¡ç±»åž‹ ä¿¡æ¯æˆ–è€…å¯¹è±¡è·¯å¾„ codeï¼šè¡¨ç¤ºHTTPçš„æ ‡å‡†status codeï¼Œ200 201ç­‰ å¯¹è±¡ç±»åž‹ï¼š{object}è¡¨ç¤ºå¯¹è±¡ï¼Œå…¶ä»–é»˜è®¤éƒ½è®¤ä¸ºæ˜¯å­—ç¬¦ç±»åž‹ï¼Œä¼šæ˜¾ç¤ºç¬¬ä¸‰ä¸ªå‚æ•°ç»™ç”¨æˆ·ï¼Œå¦‚æžœæ˜¯{object}ç±»åž‹ï¼Œé‚£ä¹ˆå°±ä¼šåŽ»æ‰«ææ”¹å¯¹è±¡ï¼Œå¹¶æ˜¾ç¤ºç»™ç”¨æˆ· å¯¹è±¡è·¯å¾„å’Œä¸Šé¢Paramä¸­å¾—å¯¹è±¡ç±»åž‹ä¸€æ ·ï¼Œä½¿ç”¨è·¯å¾„.å¯¹è±¡çš„æ–¹å¼æ¥æè¿° @Failure é”™è¯¯è¿”å›žçš„ä¿¡æ¯ï¼Œ æ ¼å¼ï¼š code ä¿¡æ¯ code:åŒä¸ŠSuccess é”™è¯¯ä¿¡æ¯ï¼šå­—ç¬¦ä¸²æè¿°ä¿¡æ¯ @router ä¸Šé¢å·²ç»æè¿°è¿‡æ”¯æŒä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯è·¯ç”±ï¼Œç¬¬äºŒä¸ªè¡¨ç¤ºæ”¯æŒçš„HTTPæ–¹æ³•]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>beego</tag>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golang use reflect to judge type of variable]]></title>
    <url>%2F2018%2F12%2F25%2Fgolang-use-reflect-to-judge-type-of-variable%2F</url>
    <content type="text"><![CDATA[ä¼—æ‰€å‘¨çŸ¥ï¼Œgolangä¸­å¯ä»¥ä½¿ç”¨ç©ºæŽ¥å£å³interface{}ä»£è¡¨ä»»ä½•ç±»åž‹çš„æ•°æ®ï¼Œé‚£ä¹ˆåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬æœ‰æ—¶éœ€è¦èŽ·å–è¿”å›žå€¼çš„å…·ä½“ç±»åž‹ åœºæ™¯ï¼šbeegoæ¡†æž¶ä¸­çš„orm.Paramsç±»åž‹ï¼Œå®žé™…ä¸Šæ˜¯map[string]interface{},åœ¨ä½¿ç”¨valuesæŽ¥å£çš„æ—¶å€™ï¼Œéœ€è¦ä»Žè¿”å›žMapä¸­èŽ·å–æ•°æ®ï¼Œéœ€è¦è¿™æ ·èŽ·å–ï¼šId:m[&quot;Id&quot;].(string),è¿™æ—¶m[â€œIdâ€]å®žé™…ä¸Šæ˜¯Stringç±»åž‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨reflectæ¨¡å—æ¥èŽ·å–å®žé™…çš„ç±»åž‹ 12reflect.TypeOf(m["Id"])//è¿”å›žä¸ºString 1234567891011package mainimport ( &quot;fmt&quot; &quot;reflect&quot;)func main() &#123; var x int32 = 20 fmt.Println(&quot;type:&quot;, reflect.TypeOf(x))&#125;]]></content>
      <categories>
        <category>go</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysql add primary key auto_increment]]></title>
    <url>%2F2018%2F12%2F25%2Fmysql-add-primary-key-auto-increment%2F</url>
    <content type="text"><![CDATA[æ·»åŠ å­—æ®µid,å¹¶å°†å…¶è®¾ç½®ä¸ºä¸»é”®è‡ªå¢ž alter table TABLE_NAME add id int not null primary key Auto_increment å¦‚æžœæƒ³æ·»åŠ å·²ç»æœ‰äº†ä¸€åˆ—ä¸ºä¸»é”®ï¼Œå¯ä»¥ç”¨ï¼š alter table TABLE_NAME add primary key(COL_NAME); å¦‚æžœæƒ³ä¿®æ”¹ä¸€åˆ—ä¸ºä¸»é”®ï¼Œåˆ™éœ€è¦å…ˆåˆ é™¤åŽŸæ¥çš„ä¸»é”®ï¼š alter table TABLE_NAME drop primary key; å†é‡æ–°æ·»åŠ ä¸»é”®ï¼š alter table TABLE_NAME add primary key(COL_NAME);]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Goå…³äºŽtimeåŒ…çš„è§£æžä¸Žä½¿ç”¨]]></title>
    <url>%2F2018%2F12%2F16%2FGo%E5%85%B3%E4%BA%8Etime%E5%8C%85%E7%9A%84%E8%A7%A3%E6%9E%90%E4%B8%8E%E4%BD%BF%E7%94%A8%2F</url>
    <content type="text"><![CDATA[Goå…³äºŽæ—¶é—´ä¸Žæ—¥æœŸçš„å¤„ç†å…³äºŽtimeçš„æ•°æ®ç±»åž‹ timeåŒ…ä¾èµ–çš„æ•°æ®ç±»åž‹æœ‰ï¼štime.Time,time.Month,time.WeekDay,time.Duration,time.Location. è¯¦ç»†ä»‹ç»ä»¥ä¸Šå‡ ç§æ•°æ®ç±»åž‹ time.Time /usr/local/go/src/time/time.go å®šä¹‰å¦‚ä¸‹: 12345type Time struct &#123; sec int64 // ä»Ž1å¹´1æœˆ1æ—¥ 00:00:00 UTC è‡³ä»Šè¿‡åŽ»çš„ç§’æ•° nsec int32 // æœ€è¿‘ä¸€ç§’åˆ°ä¸‹ä¸€ç§’è¿‡åŽ»çš„çº³ç§’æ•° loc *Location // æ—¶åŒº&#125; time.Timeä¼šè¿”å›žçº³ç§’æ—¶é—´ç²¾åº¦çš„æ—¶é—´ 1234var ti time.Timeti = time.Now()fmt.Printf("æ—¶é—´: %v, æ—¶åŒº: %v, æ—¶é—´ç±»åž‹: %T\n", t, t.Location(), t)//æ—¶é—´: 2018-12-15 09:06:05.816187261 +0800 CST, æ—¶åŒº: Local, æ—¶é—´ç±»åž‹: time.Time time.Month, goä¸­è‡ªå·±é‡æ–°å®šä¹‰äº†monthçš„ç±»åž‹ï¼Œä¸Žtime.yearå’Œtime.dayä¸åŒã€‚ 12345678910111213141516type Month intconst ( January Month = 1 + iota February March April May June July August September October November December) iotaæ˜¯golangè¯­è¨€çš„å¸¸é‡è®¡æ•°å™¨,åªèƒ½åœ¨å¸¸é‡çš„è¡¨è¾¾å¼ä¸­ä½¿ç”¨ã€‚ iotaåœ¨constå…³é”®å­—å‡ºçŽ°æ—¶å°†è¢«é‡ç½®ä¸º0(constå†…éƒ¨çš„ç¬¬ä¸€è¡Œä¹‹å‰)ï¼Œconstä¸­æ¯æ–°å¢žä¸€è¡Œå¸¸é‡å£°æ˜Žå°†ä½¿iotaè®¡æ•°ä¸€æ¬¡(iotaå¯ç†è§£ä¸ºconstè¯­å¥å—ä¸­çš„è¡Œç´¢å¼•)ã€‚ ä½¿ç”¨iotaèƒ½ç®€åŒ–å®šä¹‰ï¼Œåœ¨å®šä¹‰æžšä¸¾æ—¶å¾ˆæœ‰ç”¨ã€‚ time.WeekDay,ä»£è¡¨ä¸€å‘¨ä¹‹ä¸­çš„æ˜ŸæœŸå‡ ï¼ˆå½“ç„¶æ˜¯æŒ‰ç…§è¥¿æ–¹çš„è§„åˆ™ï¼Œä»–ä»¬æŠŠå‘¨æ—¥å½“åšæ˜¯ä¸€å‘¨çš„å¼€å§‹ï¼‰ 1234567891011type WeekDay intconst ( Sunday Weekday = iota Monday Tuesday Wednesday Thursday Friday Saturday) time.Duration,ä»£è¡¨ä¸¤ä¸ªæ—¶é—´ç‚¹ä¹‹é—´çš„çº³ç§’å·®å€¼ã€‚ 12345678910type Duration int64const ( Nanosecond Duration = 1 Microsecond = 1000 * Nanosecond Millisecond = 1000 * Microsecond Second = 1000 * Millisecond Minute = 60 * Second Hour = 60 * Minute) time.Location,æ—¶åŒºä¿¡æ¯ 123456789type Location struct &#123; name string zone []zone tx []zoneTrans cacheStart int64 cacheEnd int64 cacheZone *zone&#125;//åŒ—äº¬æ—¶é—´ï¼šAsia/Shanghai ä»¥ä¸Šç±»åž‹receiverçš„å®žçŽ°æ–¹æ³• time.Timeç›¸å…³æ–¹æ³• func Now() Time {} // å½“å‰æœ¬åœ°æ—¶é—´ func Unix(sec int64, nsec int64) Time {} // æ ¹æ®æ—¶é—´æˆ³è¿”å›žæœ¬åœ°æ—¶é—´ func Date(year int, month Month, day, hour, min, sec, nsec int, loc *Location) Time {} // è¿”å›žæŒ‡å®šæ—¶é—´ 1234567891011/ å½“å‰æœ¬åœ°æ—¶é—´t = time.Now()fmt.Println("'time.Now': ", t)// æ ¹æ®æ—¶é—´æˆ³è¿”å›žæœ¬åœ°æ—¶é—´t_by_unix := time.Unix(1487780010, 0)fmt.Println("'time.Unix': ", t_by_unix)// è¿”å›žæŒ‡å®šæ—¶é—´t_by_date := time.Date(2017, time.Month(2), 23, 1, 30, 30, 0, l)fmt.Println("'time.Date': ", t_by_date) æŒ‰ç…§æ—¶åŒºä¿¡æ¯æ˜¾ç¤ºæ—¶é—´ func (t Time) UTC() Time {} // èŽ·å–æŒ‡å®šæ—¶é—´åœ¨UTC æ—¶åŒºçš„æ—¶é—´è¡¨ç¤º func (t Time) Local() Time {} // ä»¥æœ¬åœ°æ—¶åŒºè¡¨ç¤º func (t Time) In(loc *Location) Time {} // æ—¶é—´åœ¨æŒ‡å®šæ—¶åŒºçš„è¡¨ç¤º func (t Time) Format(layout string) string {} // æŒ‰æŒ‡å®šæ ¼å¼æ˜¾ç¤ºæ—¶é—´ 1234567891011121314// èŽ·å–æŒ‡å®šæ—¶é—´åœ¨UTC æ—¶åŒºçš„æ—¶é—´è¡¨ç¤ºt_by_utc := t.UTC()fmt.Println("'t.UTC': ", t_by_utc)// èŽ·å–æœ¬åœ°æ—¶é—´è¡¨ç¤ºt_by_local := t.Local()fmt.Println("'t.Local': ", t_by_local)// æ—¶é—´åœ¨æŒ‡å®šæ—¶åŒºçš„è¡¨ç¤ºt_in := t.In(time.UTC)fmt.Println("'t.In': ", t_in)// Formatfmt.Println("t.Format", t.Format(time.RFC3339)) èŽ·å–å¹´æœˆæ—¥ç­‰ä¿¡æ¯ func (t Time) Date() (year int, month Month, day int) {} // è¿”å›žæ—¶é—´çš„æ—¥æœŸä¿¡æ¯ func (t Time) Year() int {} // è¿”å›žå¹´ func (t Time) Month() Month {} // æœˆ func (t Time) Day() int {} // æ—¥ func (t Time) Weekday() Weekday {} // æ˜ŸæœŸ func (t Time) ISOWeek() (year, week int) {} // è¿”å›žå¹´ï¼Œæ˜ŸæœŸèŒƒå›´ç¼–å· func (t Time) Clock() (hour, min, sec int) {} // è¿”å›žæ—¶é—´çš„æ—¶åˆ†ç§’ func (t Time) Hour() int {} // è¿”å›žå°æ—¶ func (t Time) Minute() int {} // åˆ†é’Ÿ func (t Time) Second() int {} // ç§’ func (t Time) Nanosecond() int {} // çº³ç§’ func (t Time) YearDay() int {} // ä¸€å¹´ä¸­å¯¹åº”çš„å¤© func (t Time) Location() *Location {} // æ—¶é—´çš„æ—¶åŒº func (t Time) Zone() (name string, offset int) {} // æ—¶é—´æ‰€åœ¨æ—¶åŒºçš„è§„èŒƒåå’Œæƒ³å¯¹UTC æ—¶é—´åç§»é‡ func (t Time) Unix() int64 {} // æ—¶é—´è½¬ä¸ºæ—¶é—´æˆ³ func (t Time) UnixNano() int64 {} // æ—¶é—´è½¬ä¸ºæ—¶é—´æˆ³ï¼ˆçº³ç§’ï¼‰ 123456789101112131415// è¿”å›žæ—¶é—´çš„æ—¥æœŸä¿¡æ¯year, month, day := t.Date()fmt.Println("'t.Date': ", year, month, day)// æ˜ŸæœŸweek := t.Weekday()fmt.Println("'t.Weekday': ", week)// è¿”å›žå¹´ï¼Œæ˜ŸæœŸèŒƒå›´ç¼–å·year, week_int := t.ISOWeek()fmt.Println("'t.ISOWeek': ", year, week_int)// è¿”å›žæ—¶é—´çš„æ—¶åˆ†ç§’hour, min, sec := t.Clock()fmt.Println("'t.Clock': ", hour, min, sec) æ—¶é—´è¿ç®— func (t Time) IsZero() bool {} // æ˜¯å¦æ˜¯é›¶æ—¶æ—¶é—´ func (t Time) After(u Time) bool {} // æ—¶é—´åœ¨u ä¹‹å‰ func (t Time) Before(u Time) bool {} // æ—¶é—´åœ¨u ä¹‹åŽ func (t Time) Equal(u Time) bool {} // æ—¶é—´ä¸Žu ç›¸åŒ func (t Time) Add(d Duration) Time {} // è¿”å›žt +d çš„æ—¶é—´ç‚¹ func (t Time) Sub(u Time) Duration {} // è¿”å›ž t-u func (t Time) AddDate(years int, months int, days int) Time {} è¿”å›žå¢žåŠ äº†ç»™å‡ºçš„å¹´ä»½ã€æœˆä»½å’Œå¤©æ•°çš„æ—¶é—´ç‚¹Time 1234567// è¿”å›žå¢žåŠ äº†ç»™å‡ºçš„å¹´ä»½ã€æœˆä»½å’Œå¤©æ•°çš„æ—¶é—´ç‚¹Timet_new := t.AddDate(0, 1, 1)fmt.Println(&quot;&apos;t.AddDate&apos;: &quot;, t_new)// æ—¶é—´åœ¨u ä¹‹å‰is_after := t.After(t_new)fmt.Println(&quot;&apos;t.After&apos;: &quot;, is_after) time.Durationçš„ç±»åž‹receiverå®žçŽ°çš„æ–¹æ³• func (d Duration) String() string // æ ¼å¼åŒ–è¾“å‡º Duration func (d Duration) Nanoseconds() int64 // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºçº³ç§’ func (d Duration) Seconds() float64 // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºç§’ func (d Duration) Minutes() float64 // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºåˆ†é’Ÿ func (d Duration) Hours() float64 // å°†æ—¶é—´æ®µè¡¨ç¤ºä¸ºå°æ—¶ 1234567// time.Duration æ—¶é—´æ®µfmt.Println("time.Duration æ—¶é—´æ®µ")d = time.Duration(10000000000000)//è¾“å…¥å‚æ•°ä¸ºint64ç±»åž‹fmt.Printf("'String: %v', 'Nanoseconds: %v', 'Seconds: %v', 'Minutes: %v', 'Hours: %v'\n", d.String(), d.Nanoseconds(), d.Seconds(), d.Minutes(), d.Hours())// 'String: 2h46m40s', 'Nanoseconds: 10000000000000', 'Seconds: 10000', 'Minutes: 166.66666666666666', 'Hours: 2.7777777777777777' time.Locationçš„receiverå®žçŽ°çš„æ–¹æ³• func (l *Location) String() string // è¾“å‡ºæ—¶åŒºå func FixedZone(name string, offset int) *Location // FixedZone ä½¿ç”¨ç»™å®šçš„åœ°ç‚¹ånameå’Œæ—¶é—´åç§»é‡offsetï¼ˆå•ä½ç§’ï¼‰åˆ›å»ºå¹¶è¿”å›žä¸€ä¸ªLocation func LoadLocation(name string) (*Location, error) // LoadLocation ä½¿ç”¨ç»™å®šçš„åå­—åˆ›å»ºLocation func Sleep(d Duration) // Sleepé˜»å¡žå½“å‰goç¨‹è‡³å°‘dä»£è¡¨çš„æ—¶é—´æ®µã€‚d&lt;=0æ—¶ï¼ŒSleepä¼šç«‹åˆ»è¿”å›ž 12d_second := time.Secondtime.Sleep(d_second) ä¸€äº›å¸¸ç”¨çš„æŠ€å·§ä¸Žä»£ç ç¤ºä¾‹ stringä¸Žtime.Timeäº’è½¬ 12345678const ( date = "2006-01-02" datetime = "2006-01-02 15:04:02")timeStamp := time.Now().Format(date) //å°†å½“å‰æ—¶é—´ï¼Œå³time.Timeç±»åž‹è½¬ä¸ºstringbillTimeStamp, err := time.Parse(date,timeStamp)//å°†Stringç±»åž‹çš„æ—¶é—´è½¬ä¸ºtime.Timeç±»åž‹ unix timeä¸ŽStringäº’è½¬ 1234567891011121314151617181920212223242526272829303132333435363738endTime := time.Unix(time.Now().Unix(), 0)//æ­¤æ—¶endTimeæ˜¯time.Timeç±»åž‹endStr := endTime.Format(datetime)//å°†unix time è½¬ä¸ºäº†Stringï¼Œå†æ ¹æ®ä¸Šé¢çš„ä¾‹å­ï¼Œå¯è½¬ä¸ºtime.Timepackage mainimport ("fmt""time")func main() &#123;//èŽ·å–æ—¶é—´æˆ³timestamp := time.Now().Unix()fmt.Println(timestamp)//æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²,tmä¸ºTimeç±»åž‹tm := time.Unix(timestamp, 0)fmt.Println(tm.Format("2006-01-02 03:04:05 PM"))fmt.Println(tm.Format("02/01/2006 15:04:05 PM")) //ä»Žå­—ç¬¦ä¸²è½¬ä¸ºæ—¶é—´æˆ³ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯æ ¼å¼ï¼Œç¬¬äºŒä¸ªæ˜¯è¦è½¬æ¢çš„æ—¶é—´å­—ç¬¦ä¸²tm2, _ := time.Parse("01/02/2006", "02/08/2018")fmt.Println(tm2.Unix())&#125; ç›¸å…³å‚è€ƒpkg/timeä¸­æ–‡ç¿»è¯‘ pkg/timeè‹±æ–‡]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä»Žå†’æ³¡æŽ’åºä¼˜åŒ–åˆ°GoåŸºå‡†æµ‹è¯•]]></title>
    <url>%2F2018%2F12%2F15%2F%E4%BB%8E%E5%86%92%E6%B3%A1%E6%8E%92%E5%BA%8F%E4%BC%98%E5%8C%96%E5%88%B0Go%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95%2F</url>
    <content type="text"><![CDATA[Goçš„æµ‹è¯•å•å…ƒæµ‹è¯• æµ‹è¯•æ–‡ä»¶å‘½åï¼šæ–‡ä»¶å‘½åä½¿ç”¨ xx_test.go ä¿å­˜åœ¨é¡¹ç›®ç›®å½•é‡Œå³å¯ï¼Œä¹Ÿå¯ä»¥æ–°å»ºä¸ªtestç›®å½•ï¼ŒTestAllï¼› æµ‹è¯•å‡½æ•°å‘½åï¼šå•å…ƒæµ‹è¯•å‡½æ•°åTestå¼€å¤´ï¼ŒæŽ¥æ”¶ä¸€ä¸ªæŒ‡é’ˆåž‹å‚æ•°ï¼ˆ*testing.Tï¼‰ï¼› è¿è¡Œæµ‹è¯•ç¨‹åºï¼šgo run test -v -run=â€å‡½æ•°åâ€ï¼Œå…¶ä¸­-væ„æ€æ˜¯è¾“å‡ºè¯¦ç»†çš„æµ‹è¯•ä¿¡æ¯ï¼› åŸºå‡†æµ‹è¯• æµ‹è¯•æ–‡ä»¶å‘½åï¼šæµ‹è¯•æ–‡ä»¶å‘½åï¼šæ–‡ä»¶å‘½åä½¿ç”¨ xx_test.go ä¿å­˜åœ¨é¡¹ç›®ç›®å½•é‡Œå³å¯ï¼Œä¹Ÿå¯ä»¥æ–°å»ºä¸ªtestç›®å½•ï¼ŒTestAllï¼› æµ‹è¯•å‡½æ•°å‘½åï¼šåŸºå‡†æµ‹è¯•ä»¥Benchmarkå¼€å¤´ï¼ŒæŽ¥æ”¶ä¸€ä¸ªæŒ‡é’ˆåž‹å‚æ•°ï¼ˆ*testing.Bï¼‰ï¼› è¿è¡Œæµ‹è¯•ç¨‹åºï¼šgo test -v -bench=â€å‡½æ•°åâ€ï¼› è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ˜¯ -benchmem, -benchmem è¡¨ç¤ºåˆ†é…å†…å­˜çš„æ¬¡æ•°å’Œå­—èŠ‚æ•°ï¼Œ-benchtime=â€3sâ€ è¡¨ç¤ºæŒç»­3ç§’ å†’æ³¡æŽ’åºåŠå…¶ç®€å•ä¼˜åŒ–å†’æ³¡æŽ’åºå‰å‡ å¤©çœ‹ä¸€ä¸ªå…¬ä¼—å·ï¼Œè¯´æ˜¯æœ‰ä¸ªäººåŽ»ç¾Žå›¢é¢è¯•ï¼Œè¢«è¦æ±‚æ‰‹å†™å†’æ³¡æŽ’åºç®—æ³•ï¼Œè¿™äººå¿ƒæƒ³è¿™è¿˜ä¸ç®€å•çš„ï¼Œåˆ†åˆ†é’Ÿå†™ä¸‹äº†ä¸‹é¢çš„ä»£ç ï¼Œå¯ä»¥è¯´æ˜¯éžå¸¸æ ‡å‡†çš„å†’æ³¡æŽ’åºäº† 123456789101112func BubbleSort(array []int) &#123; i := 0 for i = 0; i&lt;len(array)-1;i++&#123; for j :=0;j&lt;len(array)-i-1;j++&#123; if array[j]&gt;array[j+1]&#123; swap(j, j+1) &#125; &#125; &#125;&#125; ä½†æ˜¯éšä¹‹ï¼Œé¢è¯•å®˜è¯´è®©ä»–ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªç®—æ³•ï¼Œé—®ä»–æœ‰æ²¡æœ‰å¯ä¼˜åŒ–çš„åœ°æ–¹ï¼Œè¿™äººå°±æ‡µé€¼äº†ã€‚å…¶å®žå†’æ³¡æŽ’åºå¯ä¼˜åŒ–çš„åœ°æ–¹å¾ˆå¤šï¼Œæœ€ç®€å•çš„ä¸€ç§å°±æ˜¯åŠ ä¸€ä¸ªæ ‡å¿—ä½ï¼Œæ£€æŸ¥æ˜¯å¦å·²ç»æŽ’åºå®Œæ¯•ï¼ŒæŽ’åºå·²ç»å®Œæˆçš„è¯å°±æ²¡æœ‰å¿…è¦å†æ¯”è¾ƒä¸‹åŽ»ï¼Œæµªè´¹æ—¶é—´ã€‚ä¸Šé¢çš„ä»£ç æ·»åŠ å‡ è¡Œï¼Œé‚£äººå°±å¾ˆå¯èƒ½æ‹¿åˆ°offeräº†ã€‚ 123456789101112131415func BubbleSort(array []int) &#123; i := 0 for i = 0; i&lt;len(array)-1;i++&#123; exchanged := false for j :=0;j&lt;len(array)-i-1;j++&#123; if array[j]&gt;array[j+1]&#123; swap(j, j+1) exchanged = true &#125; &#125; if exchanged == false &#123; return &#125; &#125;&#125; é‚£ä¹ˆï¼Œå¦‚ä½•æ›´ç›´è§‚çš„çœ‹å‡ºï¼Œä¼˜åŒ–è¿‡çš„ä»£ç ç¡®å®žæœ‰æ•ˆå‘¢ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨goè‡ªå¸¦çš„åŸºå‡†æµ‹è¯•ï¼Œæµ‹è¯•ä¸€ä¸‹ä¸¤æ®µä»£ç çš„æ€§èƒ½ï¼Œä¼˜åŒ–ä¸Žå¦å°±ä¸€ç›®äº†ç„¶ã€‚ åŸºå‡†æµ‹è¯•å†’æ³¡æŽ’åº é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªå­˜æ”¾æµ‹è¯•æ–‡ä»¶çš„æ–‡ä»¶å¤¹ 1mkdir testAll ç„¶åŽåˆ›å»ºåŸºå‡†æµ‹è¯•æ–‡ä»¶ 1touch benchmark_test.go ç¼–å†™åŸºå‡†æµ‹è¯•ä»£ç  1234567var sortArray = []int&#123;41, 24, 76, 11, 45, 64, 21, 69, 19, 36&#125;func BenchmarkBubbleSort(b *testing.B) &#123; for i:=0;i&lt;b.N;i++ &#123; BubbleSort(sortArray) &#125;&#125; æµ‹è¯•åŸºæœ¬å†’æ³¡æŽ’åº æˆ‘ä»¬é¦–å…ˆæµ‹è¯•æœ€åŽŸå§‹çš„å†’æ³¡æŽ’åº åœ¨testAllæ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ 1go test -v -bench=&quot;BubbleSort&quot; åŸºå‡†æµ‹è¯•ç»“æžœå¦‚å›¾æ‰€ç¤ºï¼Œè§£é‡Šä¸€ä¸‹å‡ ä¸ªå…³é”®å‚æ•°ï¼Œ 81.2ns/op è¡¨ç¤ºæ¯æ¬¡æ“ä½œè€—æ—¶81.2çº³ç§’ï¼Œ1.725sè¡¨ç¤ºç¨‹åºè¿è¡Œçš„æ—¶é—´ã€‚ æµ‹è¯•ä¼˜åŒ–çš„å†’æ³¡æŽ’åº æ‰§è¡Œ 1go test -v -bench=&quot;BubbleSort&quot; å¯ä»¥çœ‹åˆ°ä¼˜åŒ–è¿‡çš„ä»£ç ï¼Œæ‰§è¡Œæ—¶é—´ä¸º1.2s,è€Œä¸”æ¯æ¬¡æ“ä½œçš„è€—æ—¶ä¸º23.0çº³ç§’ï¼Œè¶³è¶³é™ä½Žäº†60%å¤šã€‚å¯è§ä¸€ä¸ªå¾ˆç®€å•çš„ä¼˜åŒ–å°±å¯ä»¥ä½¿ä»£ç æå‡è¿™ä¹ˆå¤šï¼Œåœ¨ä»¥åŽçš„å·¥ä½œä¸­ï¼Œå¯¹äºŽä»£ç çš„è®¾è®¡ä¸Žä¼˜åŒ–è¿˜æ˜¯è¦é‡è§†ã€‚]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>go</tag>
        <tag>æŠ€æœ¯å‘¨åˆŠ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[postman æŽ¥å£æµ‹è¯•ç¥žå™¨]]></title>
    <url>%2F2018%2F12%2F08%2Fpostman-%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95%E7%A5%9E%E5%99%A8%2F</url>
    <content type="text"><![CDATA[Postman æŽ¥å£æµ‹è¯•ç¥žå™¨Postman æ˜¯ä¸€ä¸ªæŽ¥å£æµ‹è¯•å’Œ http è¯·æ±‚çš„ç¥žå™¨ï¼Œéžå¸¸å¥½ç”¨ã€‚ å®˜æ–¹ github åœ°å€: https://github.com/postmanlabs Postman çš„ä¼˜ç‚¹ï¼š æ”¯æŒå„ç§çš„è¯·æ±‚ç±»åž‹: getã€postã€putã€patchã€delete ç­‰ æ”¯æŒåœ¨çº¿å­˜å‚¨æ•°æ®ï¼Œé€šè¿‡è´¦å·å°±å¯ä»¥è¿›è¡Œè¿ç§»æ•°æ® å¾ˆæ–¹ä¾¿çš„æ”¯æŒè¯·æ±‚ header å’Œè¯·æ±‚å‚æ•°çš„è®¾ç½® æ”¯æŒä¸åŒçš„è®¤è¯æœºåˆ¶ï¼ŒåŒ…æ‹¬ Basic Authï¼ŒDigest Authï¼ŒOAuth 1.0ï¼ŒOAuth 2.0 ç­‰ å“åº”æ•°æ®æ˜¯è‡ªåŠ¨æŒ‰ç…§è¯­æ³•æ ¼å¼é«˜äº®çš„ï¼ŒåŒ…æ‹¬ HTMLï¼ŒJSON å’Œ XML ä»¥ä¸‹å†…å®¹ä¸»è¦å‚è€ƒï¼š Github: api_tool_postman å®‰è£…Postman å¯ä»¥å•ç‹¬ä½œä¸ºä¸€ä¸ªåº”ç”¨å®‰è£…ï¼Œä¹Ÿå¯ä»¥ä½œä¸º chrome çš„ä¸€ä¸ªæ’ä»¶å®‰è£…ã€‚ chrome æ’ä»¶å®‰è£…, Postman æ’ä»¶åœ°å€ å•ç‹¬åº”ç”¨å®‰è£…ä¸‹è½½ ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹è½½å®‰è£…ç‹¬ç«‹ç‰ˆæœ¬app è½¯ä»¶çš„ Postman çš„è¿‡ç¨‹ï¼š åŽ»ä¸»é¡µPostman å®˜ç½‘æ‰¾åˆ°ï¼šPostman | Apps åŽ»ä¸‹è½½è‡ªå·±å¹³å°çš„ç‰ˆæœ¬ï¼š Mac Windowsï¼ˆx86/x64ï¼‰ Linuxï¼ˆx86/x64ï¼‰ å³å¯ã€‚ å¿«é€Ÿå…¥é—¨ï¼Œæ€»ä½“ä½¿ç”¨æ–¹ç•¥å®‰è£…æˆåŠŸåŽï¼Œæ‰“å¼€è½¯ä»¶ã€‚ æ–°å»ºæŽ¥å£å¯¹åº”çš„Requestï¼šNew -&gt; Request æˆ–ï¼Œåœ¨å³è¾¹çš„ Tab é¡µé¢ä¸­ç‚¹å‡»åŠ å·+ï¼š å³å¯çœ‹åˆ°æ–°å»ºçš„ Tab é¡µï¼š è®¾ç½® HTTP è¯·æ±‚çš„æ–¹æ³•è®¾ç½® HTTP çš„ Method æ–¹æ³•å’Œè¾“å…¥ api çš„åœ°å€ è®¾ç½®ç›¸å…³è¯·æ±‚å¤´ä¿¡æ¯ è®¾ç½®ç›¸å…³ GET æˆ– POST ç­‰çš„å‚æ•° å‘é€è¯·æ±‚éƒ½å¡«å†™å¥½ä¹‹åŽï¼Œç‚¹å‡» Send åŽ»å‘é€è¯·æ±‚ Requestï¼š æŸ¥çœ‹å“åº” Responseçš„ä¿¡æ¯ ç„¶åŽå¯ä»¥é‡å¤ä¸Šè¿°ä¿®æ”¹ Request çš„å‚æ•°ï¼Œç‚¹å‡» Send åŽ»å‘é€è¯·æ±‚çš„è¿‡ç¨‹ï¼Œä»¥ä¾¿è°ƒè¯•åˆ° API æŽ¥å£æ­£å¸¸å·¥ä½œä¸ºæ­¢ã€‚ ä¿å­˜æŽ¥å£é…ç½®å¾…æ•´ä¸ªæŽ¥å£éƒ½è°ƒè¯•å®Œæ¯•åŽï¼Œè®°å¾—ç‚¹å‡» Save åŽ»ä¿å­˜æŽ¥å£ä¿¡æ¯ï¼š åŽ»ä¿å­˜å½“å‰ API æŽ¥å£ï¼Œç„¶åŽéœ€è¦å¡«å†™ç›¸å…³çš„æŽ¥å£ä¿¡æ¯ï¼š Request Name: è¯·æ±‚çš„åå­— æˆ‘ä¸€èˆ¬ä¹ æƒ¯ç”¨ä¿å­˜ä¸º æŽ¥å£çš„æœ€åŽçš„å­—æ®µåï¼Œæ¯”å¦‚http://{{server_address}}/ucows/login/loginä¸­çš„/login/login Request Description: æŽ¥å£çš„æè¿° å¯é€‰ æœ€å¥½å†™ä¸Šè¯¥æŽ¥å£çš„è¦å®žçŽ°çš„åŸºæœ¬åŠŸèƒ½å’Œç›¸å…³æ³¨æ„äº‹é¡¹ æ”¯æŒ Markdown è¯­æ³• Select a collection or folder to save: é€‰æ‹©è¦ä¿å­˜åˆ°å“ªä¸ªåˆ†ç»„ï¼ˆæˆ–æ–‡ä»¶å¤¹ï¼‰ å¾€å¾€ä¿å­˜åˆ°æŸä¸ª API æŽ¥å£åˆ°æ‰€å±žçš„è¯¥é¡¹ç›®åçš„åˆ†ç»„ å¡«å†™å¥½å†…å®¹ï¼Œé€‰æ‹©å¥½åˆ†ç»„ï¼Œå†ç‚¹å‡»ä¿å­˜ï¼š æ­¤æ—¶ï¼ŒTab çš„å³ä¸Šè§’çš„é»„è‰²ç‚¹ï¼ˆè¡¨ç¤ºæ²¡æœ‰ä¿å­˜ï¼‰æ¶ˆå¤±äº†ï¼Œè¡¨ç¤ºå·²ä¿å­˜ã€‚ ä¸”å¯¹åº”çš„åˆ†ç»„ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”çš„æŽ¥å£äº†ï¼š [warning] é»˜è®¤ä¸ä¿å­˜è¿”å›žçš„ Response æ•°æ® ç›´æŽ¥ç‚¹å‡» Save åŽ»ä¿å­˜ï¼Œåªèƒ½ä¿å­˜ API æœ¬èº«ï¼ˆçš„ Request è¯·æ±‚ï¼‰ï¼Œä¸ä¼šä¿å­˜ Response çš„æ•°æ® æƒ³è¦ä¿å­˜ Response æ•°æ®ï¼Œéœ€è¦ç”¨åŽé¢è¦ä»‹ç»çš„ å¤šä¸ª Example Request çš„å¤šå‚æ•°æ“ä½œè¯¦è§£è‡ªåŠ¨è§£æžå¤šä¸ªå‚æ•° Paramsæ¯”å¦‚ï¼Œå¯¹äºŽä¸€ä¸ª GET çš„è¯·æ±‚çš„ url æ˜¯ï¼š http://openapi.youdao.com/api?q=çº åˆ ç (EC)çš„å­¦ä¹ &amp;from=zh_CHS&amp;to=EN&amp;appKey=152e0e77723a0026&amp;salt=4&amp;sign=6BE15F1868019AD71C442E6399DB1FE4 å¯¹åº”ç€å…¶å®žæ˜¯?key=valueå½¢å¼ä¸­åŒ…å«å¤šä¸ª Http çš„ GET çš„ query string=query parameters Postman å¯ä»¥è‡ªåŠ¨å¸®æˆ‘ä»¬è§£æžå‡ºå¯¹åº”å‚æ•°ï¼Œå¯ä»¥ç‚¹å‡» Paramsï¼š çœ‹åˆ°å±•å¼€çš„å¤šä¸ªå‚æ•°ï¼š å¦‚æ­¤å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¿®æ”¹ï¼Œå¢žåˆ å¯¹åº”çš„å‚æ•°äº†ã€‚ ä¸´æ—¶ç¦ç”¨å‚æ•°ä¸”è¿˜æ”¯æŒï¼Œåœ¨ä¸åˆ é™¤æŸå‚æ•°çš„æƒ…å†µä¸‹ï¼Œå¦‚æžœæƒ³è¦æš‚æ—¶ä¸ä¼ å‚æ•°ï¼Œå¯ä»¥æ–¹ä¾¿çš„é€šè¿‡ä¸å‹¾é€‰çš„æ–¹å¼åŽ»å®žçŽ°ï¼š æ‰¹é‡ç¼–è¾‘ GET çš„å¤šä¸ªå‚æ•°å½“ç„¶ï¼Œå¦‚æžœæƒ³è¦æ‰¹é‡çš„ç¼–è¾‘å‚æ•°ï¼Œå¯ä»¥ç‚¹å‡»å³ä¸Šè§’çš„Bulk Editï¼ŒåŽ»å®žçŽ°æ‰¹é‡ç¼–è¾‘ã€‚ æŽ¥å£æè¿°ä¸Žè‡ªåŠ¨ç”Ÿæˆæ–‡æ¡£API çš„æè¿°ä¸­ï¼Œä¹Ÿæ”¯æŒ Markdownï¼Œå®˜æ–¹çš„æŽ¥å£è¯´æ˜Žæ–‡æ¡£ï¼šIntro to API documentationã€‚ æ‰€ä»¥ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿çš„æ·»åŠ æœ‰æ¡ç†çš„æŽ¥å£æè¿°ï¼Œå°¤å…¶æ˜¯å‚æ•°è§£é‡Šäº†ï¼š æè¿°æ”¯æŒ markdown è¯­æ³• è€Œå¯¹äºŽè¦è§£é‡Šçš„å‚æ•°ï¼Œå¯ä»¥é€šè¿‡ä¹‹å‰çš„Param -&gt; Bulk Editçš„å†…å®¹ï¼š æ‹·è´è¿‡æ¥ï¼Œå†ç»§ç»­åŽ»ç¼–è¾‘ï¼š ä»¥åŠæ·»åŠ æ›´å¤šè§£é‡Šä¿¡æ¯ï¼š ç‚¹å‡» Update åŽï¼Œå³å¯ä¿å­˜ã€‚ å‘å¸ƒæŽ¥å£å¹¶ç”Ÿæˆ markdown çš„æè¿°æ–‡ä»¶åŽ»å‘å¸ƒåŽï¼š å¯¹åº”çš„æ•ˆæžœï¼šæœ‰é“ç¿»è¯‘ Response æ·±å…¥Response æ•°æ®æ˜¾ç¤ºæ¨¡å¼Postman å¯¹äºŽè¿”å›žçš„ Response æ•°æ®ï¼Œæ”¯æŒä¸‰ç§æ˜¾ç¤ºæ¨¡å¼ã€‚ é»˜è®¤æ ¼å¼åŒ–åŽçš„ Pretty æ¨¡å¼ Raw åŽŸå§‹æ¨¡å¼ ç‚¹å‡»Rawï¼Œå¯ä»¥æŸ¥çœ‹åˆ°è¿”å›žçš„æ²¡æœ‰æ ¼å¼åŒ–ä¹‹å‰çš„åŽŸå§‹æ•°æ®ï¼š Preview é¢„è§ˆæ¨¡å¼ ä»¥åŠ Previewï¼Œæ˜¯å¯¹åº” Raw åŽŸå§‹æ ¼å¼çš„é¢„è§ˆæ¨¡å¼ï¼š Preview è¿™ç§æ¨¡å¼çš„æ˜¾ç¤ºæ•ˆæžœï¼Œå¥½åƒæ˜¯å¯¹äºŽè¿”å›žçš„æ˜¯ html é¡µé¢è¿™ç±»ï¼Œæ‰æ¯”è¾ƒæœ‰æ•ˆæžœã€‚ Response çš„ Cookieså¾ˆå¤šæ—¶å€™æ™®é€šçš„ API è°ƒç”¨ï¼Œå€’æ˜¯æ²¡æœ‰ Cookie çš„ï¼š Response çš„ Headers å¤´ä¿¡æ¯ä¸¾ä¾‹ï¼Œæ­¤å¤„è¿”å›žçš„æ˜¯æœ‰ Headers å¤´ä¿¡æ¯çš„ï¼š å¯ä»¥ä»Žä¸­çœ‹åˆ°æœåŠ¡å™¨æ˜¯ Nginx çš„ã€‚ ä¿å­˜å¤šä¸ª Exampleä¹‹å‰æƒ³è¦å®žçŽ°ï¼Œè®©å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­èƒ½çœ‹åˆ°æŽ¥å£è¿”å›žçš„ Response æ•°æ®ã€‚åŽæ¥å‘çŽ°æ˜¯Exampleè¿™ä¸ªåŠŸèƒ½åŽ»å®žçŽ°æ­¤æ•ˆæžœçš„ã€‚ å¦‚ä½•æ·»åŠ  Example ç»§ç»­ç‚¹å‡»Save Exampleï¼š ä¿å­˜åŽï¼Œå°±èƒ½çœ‹åˆ°Example(1)äº†ï¼š å•ä¸ª Example åœ¨å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­çš„æ•ˆæžœç„¶åŽå†åŽ»å¯¼å‡ºæ–‡æ¡£ï¼Œå¯¼å‡ºæ–‡æ¡£ä¸­çš„ç¡®èƒ½çœ‹åˆ°è¿”å›žæ•°æ®çš„ä¾‹å­ï¼š å¤šä¸ª Example åœ¨å¯¼å‡ºçš„ API æ–‡æ¡£ä¸­çš„æ•ˆæžœ å…¶ä»–å¥½ç”¨çš„åŠŸèƒ½åŠå·¥å…·åˆ†ç»„ Collectionåœ¨åˆšå¼€å§‹ä¸€ä¸ªé¡¹ç›®æ—¶ï¼Œä¸ºäº†åŽç»­ä¾¿äºŽç»„ç»‡å’Œç®¡ç†ï¼ŒæŠŠåŒå±žè¯¥é¡¹ç›®çš„å¤šä¸ª APIï¼Œæ”¾åœ¨ä¸€ç»„é‡Œ æ‰€ä»¥è¦å…ˆåŽ»æ–°å»ºä¸€ä¸ª Collection: New -&gt; Collection ä½¿ç”¨äº†æ®µæ—¶é—´åŽï¼Œå»ºäº†å¤šä¸ªåˆ†ç»„çš„æ•ˆæžœï¼š å•ä¸ªåˆ†ç»„å±•å¼€åŽçš„æ•ˆæžœï¼š åŽ†å²è®°å½• HistoryPostman æ”¯æŒ history åŽ†å²è®°å½•ï¼Œæ˜¾ç¤ºå‡ºæœ€è¿‘ä½¿ç”¨è¿‡çš„ APIï¼š ç”¨çŽ¯å¢ƒå˜é‡å®žçŽ°å¤šæœåŠ¡å™¨ç‰ˆæœ¬çŽ°å­˜é—®é¢˜åœ¨æµ‹è¯• API æœŸé—´ï¼Œå¾€å¾€å­˜åœ¨å¤šç§çŽ¯å¢ƒï¼Œå¯¹åº” IP åœ°å€ï¼ˆæˆ–åŸŸåä¹Ÿä¸åŒï¼‰ æ¯”å¦‚ï¼š Prod: 1http://116.62.25.57/ucows ç”¨äºŽå¼€å‘å®Œæˆå‘å¸ƒåˆ°ç”Ÿäº§çŽ¯å¢ƒ Dev: 1http://123.206.191.125/ucows ç”¨äºŽå¼€å‘æœŸé—´çš„çº¿ä¸Šçš„ Development çš„æµ‹è¯•çŽ¯å¢ƒ LocalTest: 1http://192.168.0.140:80/ucows ç”¨äºŽå¼€å‘æœŸé—´é…åˆåŽå°å¼€å‘äººå‘˜çš„æœ¬åœ°å±€åŸŸç½‘å†…çš„æœ¬åœ°çŽ¯å¢ƒï¼Œç”¨äºŽè”åˆè°ƒè¯• API æŽ¥å£ è€Œåœ¨æµ‹è¯• API æœŸé—´ï¼Œå¾€å¾€éœ€è¦æ‰‹åŠ¨åŽ»ä¿®æ”¹ API çš„åœ°å€ï¼š æ•ˆçŽ‡æ¯”è¾ƒä½Žï¼Œä¸”åœ°å€æ›´æ¢åŽä¹‹å‰åœ°å€å°±æ²¡æ³•ä¿ç•™äº†ã€‚ å¦å¤–ï¼Œä¸”æ ¹æ®ä¸åŒ IP åœ°å€ï¼ˆæˆ–è€…åŸŸåï¼‰ä¹Ÿä¸å®¹æ˜“è¯†åˆ«æ˜¯å“ªå¥—çŽ¯å¢ƒã€‚ Postman æ”¯æŒç”¨ Environment çŽ¯å¢ƒå˜é‡åŽ»å®žçŽ°å¤šæœåŠ¡å™¨ç‰ˆæœ¬åŽæ¥å‘çŽ° Postman ä¸­ï¼Œæœ‰ Environment å’Œ Global Variableï¼Œç”¨äºŽè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®žçŽ°ä¸åŒçŽ¯å¢ƒçš„ç®¡ç†ï¼š å¾ˆæ˜Žæ˜¾ï¼Œå°±å¯ä»¥ç”¨æ¥å®žçŽ°ä¸ç”¨æ‰‹åŠ¨ä¿®æ”¹ url ä¸­çš„æœåŠ¡å™¨åœ°å€ï¼Œä»Žè€ŒåŠ¨æ€çš„å®žçŽ°ï¼Œæ”¯æŒä¸åŒæœåŠ¡å™¨çŽ¯å¢ƒ: Production ç”Ÿäº§çŽ¯å¢ƒ Development å¼€å‘çŽ¯å¢ƒ Local æœ¬åœ°å±€åŸŸç½‘çŽ¯å¢ƒ å¦‚ä½•ä½¿ç”¨ Enviroment å®žçŽ°å¤šæœåŠ¡å™¨ç‰ˆæœ¬ æˆ–è€…ï¼š Environments are a group of variables &amp; values, that allow you to quickly switch the context for your requests and collections. Learn more about environments You can declare a variable in an environment and give it a starting value, then use it in a request by putting the variable name within curly-braces. Create an environment to get started. è¾“å…¥ Key å’Œ valueï¼š ç‚¹å‡» Add åŽï¼š [info] çŽ¯å¢ƒå˜é‡å¯ä»¥ä½¿ç”¨çš„åœ°æ–¹ URL URL params Header values form-data/url-encoded values Raw body content Helper fields å†™ test æµ‹è¯•è„šæœ¬ä¸­ é€šè¿‡ postman çš„æŽ¥å£ï¼ŒèŽ·å–æˆ–è®¾ç½®çŽ¯å¢ƒå˜é‡çš„å€¼ã€‚ æ­¤å¤„æŠŠä¹‹å‰çš„åœ¨ url ä¸­çš„ IP åœ°å€ï¼ˆæˆ–åŸŸåï¼‰æ¢æˆçŽ¯å¢ƒå˜é‡ï¼š é¼ æ ‡ç§»åŠ¨åˆ°çŽ¯å¢ƒå˜é‡ä¸Šï¼Œå¯ä»¥åŠ¨æ€æ˜¾ç¤ºå‡ºå…·ä½“çš„å€¼ï¼š å†åŽ»æ·»åŠ å¦å¤–ä¸€ä¸ªå¼€å‘çŽ¯å¢ƒï¼š åˆ™å¯æ·»åŠ å®Œ 2 ä¸ªçŽ¯å¢ƒå˜é‡ï¼Œè¡¨ç¤ºä¸¤ä¸ªæœåŠ¡å™¨åœ°å€ï¼Œä¸¤ä¸ªç‰ˆæœ¬ï¼š ç„¶åŽå°±å¯ä»¥åˆ‡æ¢ä¸åŒæœåŠ¡å™¨çŽ¯å¢ƒäº†ï¼š å¯ä»¥çœ‹åˆ°ï¼ŒåŒæ ·çš„å˜é‡ server_addressï¼Œåœ¨åˆ‡æ¢åŽå¯¹åº” IP åœ°å€å°±å˜æˆå¸Œæœ›çš„å¼€å‘çŽ¯å¢ƒçš„ IP äº†ï¼š Postman å¯¼å‡º API æ–‡æ¡£ä¸­å¤šä¸ªçŽ¯å¢ƒå˜é‡çš„æ•ˆæžœé¡ºå¸¦ä¹ŸåŽ»çœ‹çœ‹ï¼Œå¯¼å‡ºä¸º API æ–‡æ¡£åŽï¼Œå¸¦äº†è¿™ç§ Environment çš„å˜é‡çš„æŽ¥å£ï¼Œæ–‡æ¡£é•¿ä»€ä¹ˆæ ·å­ï¼š å‘çŽ°æ˜¯åœ¨å‘å¸ƒä¹‹å‰ï¼Œéœ€è¦é€‰æ‹©å¯¹åº”çš„çŽ¯å¢ƒçš„ï¼š å‘å¸ƒåŽçš„æ–‡æ¡£ï¼Œå¯ä»¥çœ‹åˆ°æ‰€é€‰çŽ¯å¢ƒå’Œå¯¹åº”æœåŠ¡å™¨çš„ IP çš„ï¼š å½“ç„¶å‘å¸ƒæ–‡æ¡£åŽï¼Œä¹Ÿå¯ä»¥å®žæ—¶åˆ‡æ¢çŽ¯å¢ƒï¼š çŽ¯å¢ƒå˜é‡çš„å¥½å¤„å½“æ›´æ¢æœåŠ¡å™¨æ—¶ï¼Œç›´æŽ¥ä¿®æ”¹å˜é‡çš„ IP åœ°å€ï¼š å³å¯å®žæ—¶æ›´æ–°ï¼Œå½“é¼ æ ‡ç§»åŠ¨åˆ°å˜é‡ä¸Šå³å¯çœ‹åˆ°æ•ˆæžœï¼š ä»£ç ç”Ÿæˆå·¥å…·æŸ¥çœ‹å½“å‰è¯·æ±‚çš„ HTTP åŽŸå§‹å†…å®¹å¯¹äºŽå½“å‰çš„è¯·æ±‚ï¼Œè¿˜å¯ä»¥é€šè¿‡ç‚¹å‡» Code åŽ»æŸ¥çœ‹å¯¹åº”çš„ç¬¦åˆ HTTP åè®®çš„åŽŸå§‹çš„å†…å®¹ï¼š å„ç§è¯­è¨€çš„ç¤ºä¾‹ä»£ç Code Generation Toolsæ¯”å¦‚ï¼š Swift è¯­è¨€ Java è¯­è¨€ å…¶ä»–å„ç§è¯­è¨€ è¿˜æ”¯æŒå…¶ä»–å„ç§è¯­è¨€ï¼š ç›®å‰æ”¯æŒçš„è¯­è¨€æœ‰ï¼š HTTP C (LibCurl) cURL C#(RestSharp) Go Java OK HTTP Unirest Javascript NodeJS Objective-C(NSURL) OCaml(Cohttp) PHP Python Ruby(NET::Http) Shell Swift(NSURL) ä»£ç ç”Ÿæˆå·¥å…·çš„å¥½å¤„æ˜¯ï¼šåœ¨å†™è°ƒç”¨æ­¤ API çš„ä»£ç æ—¶ï¼Œå°±å¯ä»¥å‚è€ƒå¯¹åº”ä»£ç ï¼Œç”šè‡³æ‹·è´ç²˜è´´å¯¹åº”ä»£ç ï¼Œå³å¯ã€‚ æµ‹è¯•æŽ¥å£é€‰ä¸­æŸä¸ªåˆ†ç»„åŽï¼Œç‚¹å‡» Runner é€‰ä¸­æŸä¸ªåˆ†ç»„åŽç‚¹å‡» Run å³å¯çœ‹åˆ°æµ‹è¯•ç»“æžœï¼š å…³äºŽæ­¤åŠŸèƒ½çš„ä»‹ç»å¯å‚è€ƒPostman å®˜ç½‘çš„git å›¾ MockServerç›´æŽ¥å‚è€ƒå®˜ç½‘ã€‚ åŠŸèƒ½ç•Œé¢å¤š Tab åˆ†é¡µPostman æ”¯æŒå¤š tab é¡µï¼ŒäºŽæ­¤å¯¹æ¯”ä¹‹å‰æœ‰äº› API è°ƒè¯•å·¥å…·å°±ä¸æ”¯æŒå¤š Tab é¡µï¼Œæ¯”å¦‚Advanced Rest Client å¤š tab çš„å¥½å¤„ï¼š æ–¹ä¾¿åœ¨ä¸€ä¸ª tab ä¸­æµ‹è¯•ï¼Œå¾—åˆ°ç»“æžœåŽï¼Œå¤åˆ¶ç²˜è´´åˆ°å¦å¤–çš„ tab ä¸­ï¼Œç»§ç»­æµ‹è¯•å…¶å®ƒæŽ¥å£ æ¯”å¦‚æ­¤å¤„ tab1 ä¸­ï¼Œæµ‹è¯•äº†èŽ·å–éªŒè¯ç æŽ¥å£åŽï¼Œæ‹·è´æ‰‹æœºå·å’ŒéªŒè¯ç ï¼Œç²˜è´´åˆ° tab2 ä¸­ï¼Œç»§ç»­æµ‹è¯•æ³¨å†Œçš„æŽ¥å£ ç•Œé¢æŸ¥çœ‹æ¨¡å¼Postman çš„é»˜è®¤çš„ Request å’Œ Response æ˜¯ä¸Šä¸‹å¸ƒå±€ï¼š æ­¤å¤„ç‚¹å‡»å³ä¸‹è§’çš„Two pane viewï¼Œå°±å˜æˆå·¦å³çš„äº†ï¼š [info] å·¦å³å¸ƒå±€çš„ç”¨é€” å¯¹äºŽæ•°æ®é‡å¾ˆå¤§ï¼Œåˆæƒ³è¦åŒæ—¶çœ‹åˆ°è¯·æ±‚å’Œè¿”å›žçš„æ•°æ®çš„æ—¶å€™ï¼Œåº”è¯¥æ¯”è¾ƒæœ‰ç”¨ã€‚ å¤šé¢œè‰²ä¸»é¢˜Posman æ”¯æŒä¸¤ç§ä¸»é¢˜ï¼š æ·±è‰²ä¸»é¢˜ å½“å‰æ˜¯æ·±è‰²ä¸»é¢˜ï¼Œæ•ˆæžœå¾ˆä¸é”™ï¼š æµ…è‰²ä¸»é¢˜ å¯ä»¥åˆ‡æ¢åˆ° æµ…è‰²ä¸»é¢˜ï¼š API æ–‡æ¡£ç”Ÿæˆåœ¨æœåŠ¡ç«¯åŽå°çš„å¼€å‘äººå‘˜æµ‹è¯•å¥½äº†æŽ¥å£åŽï¼Œæ‰“ç®—æŠŠæŽ¥å£çš„å„ç§ä¿¡æ¯å‘ç»™ä½¿ç”¨æ­¤ API çš„å‰ç«¯çš„ç§»åŠ¨ç«¯äººå‘˜æ—¶ï¼Œå¾€å¾€ä¼šé‡åˆ°ï¼š è¦ä¹ˆæ˜¯ç”¨å¤åˆ¶ç²˜è´´ -&gt; æ ¼å¼ä¸å‹å¥½ è¦ä¹ˆæ˜¯ç”¨ Postman ä¸­æˆªå›¾ -&gt; æ–¹ä¾¿çœ‹ï¼Œä½†æ˜¯ä¸æ–¹ä¾¿èŽ·å¾— API æŽ¥å£å’Œå­—æ®µç­‰æ–‡å­—å†…å®¹ è¦ä¹ˆæ˜¯ç”¨ Postman ä¸­å¯¼å‡ºä¸º JSON -&gt; json æ–‡ä»¶ä¸­ä¿¡æ¯å¤ªç¹æ‚ï¼Œä¸åˆ©äºŽæ‰¾åˆ°æ‰€éœ€è¦çš„ä¿¡æ¯ è¦ä¹ˆæ˜¯ç”¨æ–‡æ¡£ï¼Œæ¯”å¦‚åŽ»ç¼–å†™ Markdown æ–‡æ¡£ -&gt; ä½†åŽç»­ API çš„å˜æ›´éœ€è¦å®žæ—¶åŒæ­¥ä¿®æ”¹æ–‡æ¡£ï¼Œä¹Ÿä¼šå¾ˆéº»çƒ¦ è¿™éƒ½ä¼šå¯¼è‡´åˆ«äººæŸ¥çœ‹å’Œä½¿ç”¨ API æ—¶å¾ˆä¸æ–¹ä¾¿ã€‚ -&gt; å¯¹æ­¤ï¼ŒPostman æä¾›äº†å‘å¸ƒ API é¢„è§ˆå’Œå‘å¸ƒ API æ–‡æ¡£ ä¸‹é¢ä»‹ç» Postman ä¸­å¦‚ä½•é¢„è§ˆå’Œå‘å¸ƒ API æ–‡æ¡£ã€‚ ç®€è¦æ¦‚è¿°æ­¥éª¤ Collection é¼ æ ‡ç§»åŠ¨åˆ°æŸä¸ª Collectionï¼Œç‚¹å‡» ä¸‰ä¸ªç‚¹ Publish Docs Publish å¾—åˆ° Public URL åˆ«äººæ‰“å¼€è¿™ä¸ª Public URLï¼Œå³å¯æŸ¥çœ‹ API æ–‡æ¡£ é¢„è§ˆ API æ–‡æ¡£ç‚¹å‡»åˆ†ç»„å³è¾¹çš„å¤§äºŽå·&gt; å¦‚æžœåªæ˜¯é¢„è§ˆï¼Œæ¯”å¦‚åŽå°å¼€å‘å‘˜è‡ªå·±æŸ¥çœ‹ API æ–‡æ¡£çš„è¯ï¼Œå¯ä»¥é€‰æ‹©ï¼šView in web ç­‰ä»·äºŽç‚¹å‡»Publish DocsåŽ»å‘å¸ƒï¼š View in Web åŽï¼Œæœ‰ Publish çš„é€‰é¡¹ï¼ˆè§åŽé¢çš„æˆªå›¾ï¼‰ View in Web åŽï¼Œä¼šæ‰“å¼€é¢„è§ˆé¡µé¢ï¼š æ¯”å¦‚ï¼š å¥¶ç‰›äº‘ 1https://documenter.getpostman.com/collection/view/669382-42273840-6237-dbae-5455-26b16f45e2b9 è€Œå³è¾¹çš„ç¤ºä¾‹ä»£ç ï¼Œä¹Ÿå¯ä»¥ä»Žé»˜è®¤çš„ cURL æ¢æˆå…¶ä»–çš„ï¼š å‘å¸ƒ API æ–‡æ¡£å¦‚æžœæƒ³è¦è®©å…¶ä»–äººèƒ½çœ‹åˆ°è¿™ä¸ªæ–‡æ¡£ï¼Œåˆ™ç‚¹å‡» Publishï¼š ç„¶åŽä¼šæ‰“å¼€ç±»ä¼¼äºŽè¿™æ ·çš„åœ°å€ï¼š Postman Documenter 1https://documenter.getpostman.com/collection/publish?meta=Y29sbGVjdGlvbl9pZD00MjI3Mzg0MC02MjM3LWRiYWUtNTQ1NS0yNmIxNmY0NWUyYjkmb3duZXI9NjY5MzgyJmNvbGxlY3Rpb25fbmFtZT0lRTUlQTUlQjYlRTclODklOUIlRTQlQkElOTE= ç‚¹å‡» Publish åŽï¼Œå¯ä»¥ç”Ÿæˆå¯¹åº”çš„å…¬å¼€çš„ç½‘é¡µåœ°å€ï¼š æ‰“å¼€ API æŽ¥å£æ–‡æ¡£åœ°å€ï¼š 1https://documenter.getpostman.com/view/669382/collection/77fd4RM å³å¯çœ‹åˆ°ï¼ˆå’Œå‰é¢é¢„è§ˆä¸€æ ·æ•ˆæžœçš„ API æ–‡æ¡£äº†ï¼‰ï¼š å¦‚æ­¤ï¼Œåˆ«äººå³å¯æŸ¥çœ‹å¯¹åº”çš„ API æŽ¥å£æ–‡æ¡£ã€‚ å·²å‘å¸ƒçš„ API æ–‡æ¡£æ”¯æŒè‡ªåŠ¨æ›´æ–°åŽç»­å¦‚æžœè‡ªå·±çš„ API æŽ¥å£ä¿®æ”¹åŽï¼š æ¯”å¦‚ï¼š ï¼ˆåŽæ¥å‘çŽ°ï¼Œä¸ç”¨å†åŽ»è¿›å…¥æ­¤é¢„è§ˆå’Œå‘å¸ƒçš„æµç¨‹ï¼ŒåŽ»æ›´æ–°æ–‡æ¡£ï¼Œè€Œæ˜¯ Postman è‡ªåŠ¨æ”¯æŒï¼‰ åˆ«äººåŽ»åˆ·æ–°è¯¥æ–‡æ¡£çš„é¡µé¢ï¼š 1https://documenter.getpostman.com/view/669382/collection/77fd4RM å³å¯çœ‹åˆ°æ›´æ–°åŽçš„å†…å®¹ï¼š å‚è€ƒèµ„æ–™ ä¸»è¦å‚è€ƒï¼šGithub: api_tool_postman Manage environments postman-å˜é‡/çŽ¯å¢ƒ/è¿‡æ»¤ç­‰ - ç®€ä¹¦ Postman ä½¿ç”¨æ‰‹å†Œ 3â€”â€”çŽ¯å¢ƒå˜é‡ - ç®€ä¹¦ postman ä½¿ç”¨ä¹‹å››ï¼šåˆ‡æ¢çŽ¯å¢ƒå’Œè®¾ç½®è¯»å–å˜é‡ - ä¹”å¶å¶ - åšå®¢å›­]]></content>
      <categories>
        <category>å·¥å…·</category>
      </categories>
      <tags>
        <tag>postman</tag>
        <tag>å·¥å…·</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŠ€æœ¯å‘¨åˆŠä¹‹influxDBä½¿ç”¨å…¥é—¨]]></title>
    <url>%2F2018%2F12%2F08%2F%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8BinfluxDB%E4%BD%BF%E7%94%A8%E5%85%A5%E9%97%A8%2F</url>
    <content type="text"><![CDATA[å‰è¨€InfluxDBæ˜¯ä¸€ä¸ªç”¨äºŽå­˜å‚¨å’Œåˆ†æžæ—¶é—´åºåˆ—æ•°æ®çš„å¼€æºæ•°æ®åº“ã€‚ ä¸»è¦ç‰¹æ€§æœ‰ï¼š å†…ç½®HTTPæŽ¥å£ï¼Œä½¿ç”¨æ–¹ä¾¿ æ•°æ®å¯ä»¥æ‰“æ ‡è®°ï¼ŒæŸ¥è®©æŸ¥è¯¢å¯ä»¥å¾ˆçµæ´» ç±»SQLçš„æŸ¥è¯¢è¯­å¥ å®‰è£…ç®¡ç†å¾ˆç®€å•ï¼Œå¹¶ä¸”è¯»å†™æ•°æ®å¾ˆé«˜æ•ˆ èƒ½å¤Ÿå®žæ—¶æŸ¥è¯¢ï¼Œæ•°æ®åœ¨å†™å…¥æ—¶è¢«ç´¢å¼•åŽå°±èƒ½å¤Ÿè¢«ç«‹å³æŸ¥å‡º â€¦â€¦ åœ¨æœ€æ–°çš„DB-ENGINESç»™å‡ºçš„æ—¶é—´åºåˆ—æ•°æ®åº“çš„æŽ’åä¸­ï¼ŒInfluxDBé«˜å±…ç¬¬ä¸€ä½ï¼Œå¯ä»¥é¢„è§ï¼ŒInfluxDBä¼šè¶Šæ¥è¶Šå¾—åˆ°å¹¿æ³›çš„ä½¿ç”¨ã€‚ influxDBä½¿ç”¨goè¯­è¨€ç¼–å†™ï¼Œé‡‡ç”¨äº†SQL likeçš„è¯­æ³•ï¼Œéžå¸¸çµæ´»é«˜æ•ˆï¼Œå¦‚æžœä½ çš„æ•°æ®æ˜¯ä¸Žæ—¶é—´ç›¸å…³çš„ï¼Œé‚£ä¹ˆä½¿ç”¨influxDBåšæ•°æ®å¯è§†åŒ–æ˜¯æœ€åˆé€‚ä¸è¿‡çš„ï¼Œå°¤å…¶æ˜¯influxDBè‡ªèº«å°±æä¾›æ•°æ®åº“CRUDæ‰€éœ€è¦çš„APIï¼Œè™½ç„¶ä¸æ˜¯RESTFulçš„ï¼Œä½†æ˜¯ä¹ŸçœåŽ»äº†ç¼–å†™åŽç«¯æŽ¥å£çš„åŠ›æ°”ã€‚ ä¸‹é¢ä»ŽinfluxDBçš„å®‰è£…ã€ä½¿ç”¨CLIçš„influxdbåŸºæœ¬æ“ä½œã€ä½¿ç”¨APIå¯¹influxdbæ“ä½œåŠgolangä»£ç å®žçŽ°ã€ç»åŽ†çš„å‘ï¼Œå‡ ä¸ªæ–¹é¢åˆ†äº«influxDBçš„å…¥é—¨ç»åŽ†ã€‚ å®‰è£… æœ¬æ¬¡å®‰è£…çš„çŽ¯å¢ƒæ˜¯ï¼š CentOS 7 å†…æ ¸ç‰ˆæœ¬ï¼š4.4.135-1.el7.elrepo.x86_64 ç›´æŽ¥ä½¿ç”¨yumå®‰è£… 123456789cat &lt;&lt;EOF | sudo tee /etc/yum.repos.d/influxdb.repo # è¾“å…¥influxDBçš„repoURLåœ°å€ç­‰ä¿¡æ¯[influxdb] name = InfluxDB Repository - RHEL \$releasever baseurl = https://repos.influxdata.com/rhel/\$releasever/\$basearch/stable enabled = 1 gpgcheck = 1 gpgkey = https://repos.influxdata.com/influxdb.key EOF #EOFæ˜¯æ–‡æœ¬çš„ç»“æŸç¬¦ 1sudo yum install influxdb influxd config å®‰è£…å®ŒæˆåŽä½¿ç”¨è¯¥å‘½ä»¤æŸ¥çœ‹influxDBçš„é…ç½®å†…å®¹ï¼Œdefaultçš„configæ–‡ä»¶è·¯å¾„åœ¨ï¼š/etc/influxdb/influxdb.conf å¯åŠ¨influxDB 12345[root@k8s-m1 ~]# influxConnected to http://localhost:8086 version 1.7.1InfluxDB shell version: 1.7.1Enter an InfluxQL query&gt; åˆ°æ­¤å®Œæˆäº†influxDBçš„å®‰è£…ï¼ŒæŽ¥ä¸‹æ¥æˆ‘ä»¬åšåŸºæœ¬çš„é…ç½®ã€‚ é…ç½® ç”¨æˆ·ç®¡ç† 12345678910-- åˆ›å»ºä¸€ä¸ªç®¡ç†å‘˜ç”¨æˆ·CREATE USER "admin" WITH PASSWORD 'xxxx' WITH ALL PRIVILEGES-- åˆ›å»ºä¸€ä¸ªæ™®é€šç”¨æˆ·CREATE USER "user" WITH PASSWORD 'xxxxx'-- ä¸ºç”¨æˆ·æŽˆæƒè¯»æƒé™GRANT READ ON [database] to "user"-- ä¸ºç”¨æˆ·æŽˆæƒå†™æƒé™GRANT WRITE ON [database] to "user"--------------------- # éœ€è¦ä¿®æ”¹InfluxDBçš„é…ç½®æ–‡ä»¶/etc/influxdb/influxdb.confï¼Œè®¾ç½®httpä¸‹çš„auth-enabled = trueï¼Œé‡å¯åŽï¼Œä½¿ç”¨influxå‘½ä»¤ç™»å½•æ•°æ®åº“å°±éœ€è¦ç”¨æˆ·åå’Œå¯†ç äº†ã€‚ï¼ˆInfluxå‘½ä»¤å®žé™…ä¸Šä¹Ÿæ˜¯ä½¿ç”¨APIæ¥æ“ä½œInfluxDBçš„ï¼ŒInfluxDBåªæä¾›äº†APIæŽ¥å£ï¼‰ æŸ¥çœ‹ç”¨æˆ· 123456&gt; show usersuser admin---- -----admin truesjhan true&gt; influxDBçš„é…ç½®é¡¹ç›®æœ‰å¾ˆå¤šï¼Œå‰©ä¸‹çš„å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚ç»§ç»­ç ”ç©¶ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ã€‚ åœ¨è¿›è¡Œæ•°æ®åº“åŸºæœ¬æ“ä½œä¹‹å‰æˆ‘ä»¬å¿…é¡»äº†è§£ä¸€ä¸‹infuxDBçš„ä¸€äº›åŸºæœ¬æ¦‚å¿µ influxDBåŸºæœ¬æ¦‚å¿µ influxDBé‡Œé¢æœ€åŸºæœ¬çš„æ¦‚å¿µå°±æ˜¯ï¼Œmeasurementï¼Œtagsï¼Œfieldsï¼Œpointsã€‚æˆ‘ä»¬å¯ä»¥ç±»æ¯”äºŽMySQLæ¥ç†è§£è¿™å‡ ä¸ªå­—æ®µï¼š measurementç±»ä¼¼äºŽSQLä¸­çš„tableï¼› tagsç±»ä¼¼SQLä¸­çš„è¢«ç´¢å¼•çš„åˆ—ï¼› fieldsç±»ä¼¼äºŽSQLä¸­æ²¡æœ‰è¢«ç´¢å¼•çš„åˆ—ï¼› pointså¯¹åº”SQLçš„tableä¸­çš„æ¯è¡Œæ•°æ®ã€‚ çŸ¥é“äº†è¿™å‡ ä¸ªæ¦‚å¿µï¼Œä¾¿å¯ä»¥ç»§ç»­å¾€ä¸‹è¿›è¡Œï¼Œå¦‚éœ€æ›´åŠ è¯¦ç»†çš„æ–‡æ¡£ï¼Œè‹±æ–‡ç‰ˆæ–‡æ¡£çŒ›æˆ³è¿™é‡Œï¼Œå½“ç„¶ä¹Ÿæœ‰ä¸­æ–‡ç‰ˆï¼ŒçŒ›æˆ³è¿™é‡Œã€‚ä¸çŸ¥ä¸ºä½•ä¸­æ–‡ç‰ˆæˆ‘åªæœ‰ç•ªè”·æ‰èƒ½è®¿é—®ã€‚ influxDBåŸºæœ¬æ“ä½œ é¦–å…ˆï¼Œè·ŸMySQLä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ 12345-- åˆ›å»ºæ•°æ®åº“ï¼Œé»˜è®¤è®¾ç½®CREATE DATABASE &quot;first_db&quot;-- åˆ›å»ºæ•°æ®åº“ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªRetention Policyï¼Œæ•°æ®ä¿ç•™æ—¶é—´æè¿°-- Retention Policyå„éƒ¨åˆ†æè¿°ï¼šDURATIONä¸ºæ•°æ®å­˜å‚¨æ—¶é•¿ï¼Œä¸‹é¢çš„1då³åªå­˜1å¤©çš„æ•°æ®ï¼›REPLICATIONä¸ºæ•°æ®å‰¯æœ¬ï¼Œä¸€èˆ¬åœ¨ä½¿ç”¨é›†ç¾¤çš„æ—¶å€™æ‰ä¼šè®¾ç½®ä¸º&gt;1ï¼›SHARD DURATIONä¸ºåˆ†åŒºé—´éš”ï¼ŒInfluxDBé»˜è®¤å¯¹æ•°æ®åˆ†åŒºï¼Œå¡«å†™30må³å¯¹æ•°æ®æ¯éš”30åˆ†é’Ÿåšä¸€ä¸ªæ–°çš„åˆ†åŒºï¼›Nameæ˜¯RPçš„åå­—ã€‚CREATE DATABASE &quot;first_db&quot; WITH DURATION 1d REPLICATION 1 SHARD DURATION 30m NAME &quot;myrp&quot; æˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªinfluxDBçš„æ•°æ®åº“ï¼Œåå­—ä¸ºfirst_db, æ•°æ®å­˜å‚¨æ—¶é—´ä¸ºä¸€å¤©ï¼Œä¸€ä¸ªå‰¯æœ¬ï¼Œæ¯30åˆ†é’Ÿåšä¸€ä¸ªæ–°çš„åˆ†åŒºã€‚ influxDBæ’å…¥æ•°æ® influx -username admin -password æˆ‘ä»¬æ’å…¥ä¸€æ¡æ•°æ®åˆ°åˆšåˆšåˆ›å»ºçš„æ•°æ®åº“ä¸­ 1insert product,productName=disk,usageType=pay,creator=zhangsan,appId=105 cost=3421.6 æˆ‘ä»¬åˆ†æžä¸€ä¸‹è¿™æ¡æ’å…¥è¯­å¥ï¼Œå…¶ä¸­productå­—æ®µæ˜¯influxDBä¸­çš„measurement,å‰é¢è®²åŸºæœ¬æ¦‚å¿µçš„æ—¶å€™å·²ç»è§£é‡Šè¿‡ï¼Œç±»ä¼¼äºŽMySQLä¸­çš„tableï¼Œâ€œproductName=disk,usageType=pay,creator=zhangsan,appId=105â€ï¼Œè¿™ä¸€å¨åœ¨influxDBä¸­å«åštag set,å¯ä»¥ç†è§£ä¸ºtagçš„ä¸€ä¸ªé›†åˆï¼Œtagçš„ç±»åž‹åªèƒ½æ˜¯å­—ç¬¦ä¸²çš„K-Vï¼Œè¿˜æœ‰éœ€è¦æ³¨æ„çš„æ˜¯tag setä¸Žå‰é¢çš„measurementä¹‹é—´åªæœ‰ä¸€ä¸ªé€—å·ï¼Œå¹¶æ²¡æœ‰ç©ºæ ¼ï¼ï¼Œä¸€å¼€å§‹ä¸çŸ¥é“è¿™å›žäº‹ï¼Œæ€Žä¹ˆæ’å…¥éƒ½æ˜¯å¤±è´¥ã€‚â€œcost=3421.6â€è¿™ä¸ªå«åšfiled setï¼Œfiledçš„ç±»åž‹å¯ä»¥æ˜¯floatã€booleanã€integerã€‚è¿™æ ·æ’å…¥çš„ä¸€æ¡æ•°æ®ï¼ŒinfluxDBä¸­å«åšä¸€ä¸ªpointã€‚ æŸ¥è¯¢æ“ä½œ æŸ¥è¯¢ä¹‹å‰è¦é€‰æ‹©ä½ æƒ³æŸ¥è¯¢çš„æ•°æ®åº“ 1use first_db 1select * from product å¯ä»¥çœ‹åˆ°influxDBè‡ªåŠ¨ä¸ºæˆ‘ä»¬çš„è¿™ä¸ªpointåŠ äº†ä¸€ä¸ªtimestampï¼Œè¿™ä¸ªæ˜¯æ•°æ®çš„UNIXæ—¶é—´æ ¼å¼çš„æ—¶é—´ç²¾åº¦ï¼Œæˆ‘ä»¬åœ¨å¯åŠ¨æ•°æ®åº“æ—¶å¯ä»¥å®šä¹‰è¿™ä¸ªprecisionï¼Œåƒä¸‹é¢è¿™æ · 1influx --precision rfc3339 influxDBè§„å®šäº†å¾ˆå¤šæ—¶é—´ç²¾åº¦ï¼Œå…·ä½“å¯ä»¥åœ¨å‘½ä»¤è¡Œè¾“å‡ºhelpæŸ¥çœ‹ 12precision &lt;format&gt; specifies the format of the timestamp: rfc3339, h, m, s, ms, u or ns# å¯æŒ‡å®šçš„æ—¶é—´ç²¾åº¦ ä½¿ç”¨influxDBå†…ç½®CLIæ‰§è¡ŒæŸ¥è¯¢æ“ä½œ è¿˜æ˜¯æŸ¥è¯¢æˆ‘ä»¬åˆšåˆšæ’å…¥çš„é‚£æ¡æ•°æ®,åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ä»¥ä¸‹å‘½ä»¤ 1curl -G 'http://localhost:8086/query?pretty=true' --data-urlencode "db=first_db" --data-urlencode "q=SELECT \"cost\" FROM \"product\" WHERE \"productName\"='disk'" å¾—åˆ°è¾“å‡ºä¸ºjsonç»“æž„çš„æŸ¥è¯¢ç»“æžœ influxDBå†…ç½®çš„APIå¾ˆå¤§ç¨‹åº¦ç®€åŒ–äº†åŽç«¯çš„å¼€å‘ï¼Œä½¿å„ç§é¡¹ç›®å¯ä»¥å¿«é€Ÿä¸Šçº¿ã€‚ æ’å…¥æ“ä½œçš„API åœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥ 12curl -i -XPOST 'http://localhost:8086/write?db=first_db' --data-binary 'weather,location=us-midwes temperature=125'# æ’å…¥ä¸€æ¡æ•°æ®ï¼Œmeasurement=weatherï¼Œtag=locationï¼Œfiled=temperature,æ—¶é—´æˆ³ä¸ºå½“åœ°æœåŠ¡å™¨æ—¶é—´ æˆ‘ä»¬ä½¿ç”¨postmanæµ‹è¯•è¿™ä¸ªæ’å…¥æŽ¥å£ï¼Œä»¥ç¡®å®šè¯¥æŽ¥å£çš„headerï¼Œbodyç­‰ï¼Œä¸ºæŽ¥ä¸‹æ¥ä½¿ç”¨goç¼–å†™è¯·æ±‚ä»£ç åšå¥½å‡†å¤‡ã€‚é€šè¿‡åˆ†æžURLï¼Œæˆ‘ä»¬å¯çŸ¥è¯·æ±‚çš„paramæ˜¯db=first_dbï¼Œâ€“dat-binaryè¿™ä¸ªå‚æ•°ï¼Œæ„å‘³ç€ä½ çš„request bodyå¿…é¡»æ˜¯raw,è€Œä¸”headerçš„content-Type=â€textâ€,å…·ä½“çš„postmanè®¾ç½®å‚ç…§ä¸‹å›¾ï¼š ç‚¹å‡»Sendä¹‹åŽï¼Œå¯ä»¥åœ¨ä¸‹é¢çœ‹åˆ°responseçš„statusCodeæ˜¯204ï¼Œåœ¨httpåè®®ä¸­ï¼Œè¿™ä¸ªçŠ¶æ€ç æ„æ€æ˜¯è¿”å›žä½“ä¸­æ²¡æœ‰å†…å®¹ã€‚ æˆ‘ä»¬å›žåˆ°influxDBçš„terminalä¸­æŸ¥çœ‹ä¸€ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°è¿™æ¡æ•°æ®å·²ç»æ’å…¥æˆåŠŸäº†ã€‚ GOæ“ä½œinfluxDBçš„APIå®žçŽ°æ’å…¥æ•°æ® å¯ä»¥åˆ©ç”¨è¿™æ ·æ–¹ä¾¿çš„APIï¼Œç¼–å†™ä»£ç ï¼Œå®žçŽ°æ•°æ®çš„æ‰¹é‡é‡‡é›†ã€ç®¡ç†ã€å±•ç¤ºï¼Œè¿™é‡Œæˆ‘ç”¨GOå¯¹æ’å…¥æ•°æ®çš„æ“ä½œç®€å•å®žçŽ°ã€‚ 1234567891011func main() &#123; reqBody := "weather,location=us-midwes temperature=521 1475839730100400200" rb := []byte(reqBody) headers := map[string]string&#123; "Content-type": "text", &#125; resp, _,err := simpleHttpClient.DoRequest("POST","http://10.18.5.30:8086/write?db=first_db",headers,rb,10) if err != nil &#123; panic(err) &#125; fmt.Println(string(resp)) ä½¿ç”¨çš„DoRequestæ–¹æ³•æ¥è‡ªè¿™é‡Œï¼Œè¿™ä¸ªåº“å¯¹golangçš„httpæ“ä½œè¿›è¡Œç®€å•çš„å°è£…ï¼Œè€Œä¸”åŠ å…¥äº†é”™è¯¯å¤„ç†ï¼Œtimeoutå¼‚å¸¸æ£€æµ‹ç­‰ã€‚ å½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨Goè‡ªå¸¦çš„net/httpåŒ…ä¸­çš„POSTæ–¹æ³• 12345678reqBody := "weather,location=us-midwes temperature=521 1475839730100400200" //rb := []byte(reqBody) rb := io.NewReader(reqBody) resp, err := http.Post("http://10.18.5.30:8086/write?db=first_db","text",rb) if err != nil &#123; panic(err) &#125; fmt.Println(string(resp)) éœ€è¦æ³¨æ„çš„æ˜¯å¯¹request bodyçš„ç±»åž‹å¤„ç†ï¼Œnet/http.postæ–¹æ³•è¦æ±‚è¯¥å‚æ•°çš„ç±»åž‹æ˜¯io.readerï¼Œæ‰€ä»¥è¦ä½¿ç”¨io.NewReader()è¿›è¡Œè½¬æ¢ã€‚ æ€»ç»“ ä»¥ä¸Šå°±æ˜¯å¯¹influxDBçš„å…¥é—¨ä»‹ç»ï¼ŒåŒ…æ‹¬åŸºæœ¬æ¦‚å¿µï¼Œå®‰è£…ï¼Œé…ç½®ï¼ŒåŸºæœ¬æ“ä½œï¼ˆCLIï¼ŒAPIï¼‰ä»¥åŠä½¿ç”¨GOç¼–å†™æ“ä½œæ•°æ®åº“çš„ä»£ç ã€‚ä½†influxDBçš„å¥¥ç§˜è¿œä¸æ­¢è¿™äº›ï¼Œå¦‚éœ€æ›´åŠ æ·±å…¥çš„ç ”ç©¶å¯å‚é˜…å®˜æ–¹æ–‡æ¡£ã€‚]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>æŠ€æœ¯å‘¨åˆŠ</tag>
        <tag>influxDB</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[(è½¬è½½)golangè¯­è¨€å¹¶å‘ä¸Žå¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£(2)]]></title>
    <url>%2F2018%2F12%2F07%2F%E8%BD%AC%E8%BD%BD-golang%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E2%80%94%E2%80%94goroutine%E5%92%8Cchannel%E7%9A%84%E8%AF%A6%E7%BB%86%E7%90%86%E8%A7%A3-2%2F</url>
    <content type="text"><![CDATA[æœ¬æ–‡è½¬è½½è‡ªï¼Œç‰ˆæƒå±žäºŽåŽŸä½œè€…ã€‚ Goè¯­è¨€çš„å¹¶å‘å’Œå¹¶è¡Œä¸çŸ¥é“ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ä¸€ä¸ªçŽ°è±¡ï¼Œè¿˜æ˜¯è¿™æ®µä»£ç ï¼Œå¦‚æžœæˆ‘è·‘åœ¨ä¸¤ä¸ªgoroutinesé‡Œé¢çš„è¯: 12345678910111213141516171819var quit chan int = make(chan int)func loop() &#123; for i := 0; i &lt; 10; i++ &#123; fmt.Printf(&quot;%d &quot;, i) &#125; quit &lt;- 0&#125;func main() &#123; // å¼€ä¸¤ä¸ªgoroutineè·‘å‡½æ•°loop, loopå‡½æ•°è´Ÿè´£æ‰“å°10ä¸ªæ•° go loop() go loop() for i := 0; i &lt; 2; i++ &#123; &lt;- quit &#125;&#125; æˆ‘ä»¬è§‚å¯Ÿä¸‹è¾“å‡º: 10 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 è¿™æ˜¯ä¸æ˜¯æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ? ä»¥å‰æˆ‘ä»¬ç”¨çº¿ç¨‹åŽ»åšç±»ä¼¼ä»»åŠ¡çš„æ—¶å€™ï¼Œç³»ç»Ÿçš„çº¿ç¨‹ä¼šæŠ¢å å¼åœ°è¾“å‡ºï¼Œ è¡¨çŽ°å‡ºæ¥çš„æ˜¯ä¹±åºåœ°è¾“å‡ºã€‚è€Œgoroutineä¸ºä»€ä¹ˆæ˜¯è¿™æ ·è¾“å‡ºçš„å‘¢ï¼Ÿ goroutineæ˜¯åœ¨å¹¶è¡Œå—ï¼Ÿæˆ‘ä»¬æ‰¾ä¸ªä¾‹å­æµ‹è¯•ä¸‹: 1234567891011121314151617181920212223242526package mainimport &quot;fmt&quot;import &quot;time&quot;var quit chan intfunc foo(id int) &#123; fmt.Println(id) time.Sleep(time.Second) // åœé¡¿ä¸€ç§’ quit &lt;- 0 // å‘æ¶ˆæ¯ï¼šæˆ‘æ‰§è¡Œå®Œå•¦ï¼&#125;func main() &#123; count := 1000 quit = make(chan int, count) // ç¼“å†²1000ä¸ªæ•°æ® for i := 0; i &lt; count; i++ &#123; //å¼€1000ä¸ªgoroutine go foo(i) &#125; for i :=0 ; i &lt; count; i++ &#123; // ç­‰å¾…æ‰€æœ‰å®Œæˆæ¶ˆæ¯å‘é€å®Œæ¯•ã€‚ &lt;- quit &#125;&#125; è®©æˆ‘ä»¬è·‘ä¸€ä¸‹è¿™ä¸ªç¨‹åº(ä¹‹æ‰€ä»¥å…ˆç¼–è¯‘å†è¿è¡Œï¼Œæ˜¯ä¸ºäº†è®©ç¨‹åºè·‘çš„å°½é‡å¿«,æµ‹è¯•ç»“æžœæ›´å¥½): 123go build test.gotime ./test./test 0.01s user 0.01s system 1% cpu 1.016 total æˆ‘ä»¬çœ‹åˆ°ï¼Œæ€»è®¡ç”¨æ—¶æŽ¥è¿‘ä¸€ç§’ã€‚ è²Œä¼¼å¹¶è¡Œäº†ï¼ æˆ‘ä»¬éœ€è¦é¦–å…ˆè€ƒè™‘ä¸‹ä»€ä¹ˆæ˜¯å¹¶å‘, ä»€ä¹ˆæ˜¯å¹¶è¡Œ å¹¶è¡Œå’Œå¹¶å‘ä»Žæ¦‚å¿µä¸Šè®²ï¼Œå¹¶å‘å’Œå¹¶è¡Œæ˜¯ä¸åŒçš„, ç®€å•æ¥è¯´çœ‹è¿™ä¸ªå›¾ç‰‡(åŽŸå›¾æ¥è‡ªè¿™é‡Œ) ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªCoffeeæœºå™¨ï¼Œé‚£æ˜¯å¹¶å‘ ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸¤ä¸ªCoffeeæœºå™¨ï¼Œé‚£æ˜¯å¹¶è¡Œ æ›´å¤šçš„èµ„æ–™ï¼š å¹¶å‘ä¸æ˜¯å¹¶è¡Œ, å½“ç„¶Googleä¸Šæœ‰æ›´å¤šå…³äºŽå¹¶è¡Œå’Œå¹¶å‘çš„åŒºåˆ«ã€‚ é‚£ä¹ˆå›žåˆ°ä¸€å¼€å§‹çš„ç–‘é—®ä¸Šï¼Œä»Žä¸Šé¢çš„ä¸¤ä¸ªä¾‹å­æ‰§è¡ŒåŽçš„è¡¨çŽ°æ¥çœ‹ï¼Œå¤šä¸ªgoroutineè·‘loopå‡½æ•°ä¼šæŒ¨ä¸ªgoroutineåŽ»è¿›è¡Œï¼Œè€Œsleepåˆ™æ˜¯ä¸€èµ·æ‰§è¡Œçš„ã€‚ è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ é»˜è®¤åœ°ï¼Œ Goæ‰€æœ‰çš„goroutinesåªèƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œè·‘ ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œ ä»¥ä¸Šä¸¤ä¸ªä»£ç éƒ½ä¸æ˜¯å¹¶è¡Œçš„ï¼Œä½†æ˜¯éƒ½æ˜¯æ˜¯å¹¶å‘çš„ã€‚ å¦‚æžœå½“å‰goroutineä¸å‘ç”Ÿé˜»å¡žï¼Œå®ƒæ˜¯ä¸ä¼šè®©å‡ºCPUç»™å…¶ä»–goroutineçš„, æ‰€ä»¥ä¾‹å­ä¸€ä¸­çš„è¾“å‡ºä¼šæ˜¯ä¸€ä¸ªä¸€ä¸ªgoroutineè¿›è¡Œçš„ï¼Œè€Œsleepå‡½æ•°åˆ™é˜»å¡žæŽ‰äº† å½“å‰goroutine, å½“å‰goroutineä¸»åŠ¨è®©å…¶ä»–goroutineæ‰§è¡Œ, æ‰€ä»¥å½¢æˆäº†é€»è¾‘ä¸Šçš„å¹¶è¡Œ, ä¹Ÿå°±æ˜¯å¹¶å‘ã€‚ çœŸæ­£çš„å¹¶è¡Œä¸ºäº†è¾¾åˆ°çœŸæ­£çš„å¹¶è¡Œï¼Œæˆ‘ä»¬éœ€è¦å‘Šè¯‰Goæˆ‘ä»¬å…è®¸åŒæ—¶æœ€å¤šä½¿ç”¨å¤šä¸ªæ ¸ã€‚ å›žåˆ°èµ·åˆçš„ä¾‹å­ï¼Œæˆ‘ä»¬è®¾ç½®æœ€å¤§å¼€2ä¸ªåŽŸç”Ÿçº¿ç¨‹, æˆ‘ä»¬éœ€è¦ç”¨åˆ°runtimeåŒ…(runtimeåŒ…æ˜¯goroutineçš„è°ƒåº¦å™¨): 123456789101112131415161718192021222324import ( &quot;fmt&quot; &quot;runtime&quot;)var quit chan int = make(chan int)func loop() &#123; for i := 0; i &lt; 100; i++ &#123; //ä¸ºäº†è§‚å¯Ÿï¼Œè·‘å¤šäº› fmt.Printf(&quot;%d &quot;, i) &#125; quit &lt;- 0&#125;func main() &#123; runtime.GOMAXPROCS(2) // æœ€å¤šä½¿ç”¨2ä¸ªæ ¸ go loop() go loop() for i := 0; i &lt; 2; i++ &#123; &lt;- quit &#125;&#125; è¿™ä¸‹ä¼šçœ‹åˆ°ä¸¤ä¸ªgoroutineä¼šæŠ¢å å¼åœ°è¾“å‡ºæ•°æ®äº†ã€‚ æˆ‘ä»¬è¿˜å¯ä»¥è¿™æ ·æ˜¾å¼åœ°è®©å‡ºCPUæ—¶é—´ï¼š 123456789101112131415161718func loop() &#123; for i := 0; i &lt; 10; i++ &#123; runtime.Gosched() // æ˜¾å¼åœ°è®©å‡ºCPUæ—¶é—´ç»™å…¶ä»–goroutine fmt.Printf(&quot;%d &quot;, i) &#125; quit &lt;- 0&#125;func main() &#123; go loop() go loop() for i := 0; i &lt; 2; i++ &#123; &lt;- quit &#125;&#125; è§‚å¯Ÿä¸‹ç»“æžœä¼šçœ‹åˆ°è¿™æ ·æœ‰è§„å¾‹çš„è¾“å‡º: 10 0 1 1 2 2 3 3 4 4 5 5 6 6 7 7 8 8 9 9 å…¶å®žï¼Œè¿™ç§ä¸»åŠ¨è®©å‡ºCPUæ—¶é—´çš„æ–¹å¼ä»ç„¶æ˜¯åœ¨å•æ ¸é‡Œè·‘ã€‚ä½†æ‰‹å·¥åœ°åˆ‡æ¢goroutineå¯¼è‡´äº†çœ‹ä¸ŠåŽ»çš„â€œå¹¶è¡Œâ€ã€‚ å…¶å®žä½œä¸ºä¸€ä¸ªPythonç¨‹åºå‘˜ï¼Œgoroutineè®©æˆ‘æ›´å¤šåœ°æƒ³åˆ°çš„æ˜¯geventçš„åç¨‹ï¼Œè€Œä¸æ˜¯åŽŸç”Ÿçº¿ç¨‹ã€‚ å…³äºŽruntimeåŒ…å¯¹goroutineçš„è°ƒåº¦ï¼Œåœ¨stackoverflowä¸Šæœ‰ä¸€ä¸ªä¸é”™çš„ç­”æ¡ˆ:http://stackoverflow.com/questions/13107958/what-exactly-does-runtime-gosched-do ä¸€ä¸ªå°é—®é¢˜æˆ‘åœ¨Segmentfaultçœ‹åˆ°äº†è¿™ä¸ªé—®é¢˜: http://segmentfault.com/q/1010000000207474 é¢˜ç›®è¯´ï¼Œå¦‚ä¸‹çš„ç¨‹åºï¼ŒæŒ‰ç…§ç†è§£åº”è¯¥æ‰“å°ä¸‹5æ¬¡ &quot;world&quot;å‘€ï¼Œå¯æ˜¯ä¸ºä»€ä¹ˆä»€ä¹ˆä¹Ÿæ²¡æœ‰æ‰“å° 1234567891011121314151617package mainimport ( &quot;fmt&quot;)func say(s string) &#123; for i := 0; i &lt; 5; i++ &#123; fmt.Println(s) &#125;&#125;func main() &#123; go say(&quot;world&quot;) //å¼€ä¸€ä¸ªæ–°çš„Goroutinesæ‰§è¡Œ for &#123; &#125;&#125; æ¥¼ä¸‹çš„ç­”æ¡ˆå·²ç»å¾ˆæ£’äº†ï¼Œè¿™é‡ŒGoä»ç„¶åœ¨ä½¿ç”¨å•æ ¸ï¼Œforæ­»å¾ªçŽ¯å æ®äº†å•æ ¸CPUæ‰€æœ‰çš„èµ„æºï¼Œè€Œmainçº¿å’Œsayä¸¤ä¸ªgoroutineéƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢ï¼Œ æ‰€ä»¥sayæ²¡æœ‰æœºä¼šæ‰§è¡Œã€‚è§£å†³æ–¹æ¡ˆè¿˜æ˜¯ä¸¤ä¸ªï¼š å…è®¸Goä½¿ç”¨å¤šæ ¸(runtime.GOMAXPROCS) æ‰‹åŠ¨æ˜¾å¼è°ƒåŠ¨(runtime.Gosched) runtimeè°ƒåº¦å™¨runtimeè°ƒåº¦å™¨æ˜¯ä¸ªå¾ˆç¥žå¥‡çš„ä¸œè¥¿ï¼Œä½†æ˜¯æˆ‘çœŸæ˜¯ä½†æ„¿å®ƒä¸å­˜åœ¨ï¼Œæˆ‘å¸Œæœ›æ˜¾å¼è°ƒåº¦èƒ½æ›´ä¸ºè‡ªç„¶äº›ï¼Œå¤šæ ¸å¤„ç†é»˜è®¤å¼€å¯ã€‚ å…³äºŽruntimeåŒ…å‡ ä¸ªå‡½æ•°: Gosched è®©å‡ºcpu NumCPU è¿”å›žå½“å‰ç³»ç»Ÿçš„CPUæ ¸æ•°é‡ GOMAXPROCS è®¾ç½®æœ€å¤§çš„å¯åŒæ—¶ä½¿ç”¨çš„CPUæ ¸æ•° Goexit é€€å‡ºå½“å‰goroutine(ä½†æ˜¯deferè¯­å¥ä¼šç…§å¸¸æ‰§è¡Œ) æ€»ç»“æˆ‘ä»¬ä»Žä¾‹å­ä¸­å¯ä»¥çœ‹åˆ°ï¼Œé»˜è®¤çš„, æ‰€æœ‰goroutineä¼šåœ¨ä¸€ä¸ªåŽŸç”Ÿçº¿ç¨‹é‡Œè·‘ï¼Œä¹Ÿå°±æ˜¯åªä½¿ç”¨äº†ä¸€ä¸ªCPUæ ¸ã€‚ åœ¨åŒä¸€ä¸ªåŽŸç”Ÿçº¿ç¨‹é‡Œï¼Œå¦‚æžœå½“å‰goroutineä¸å‘ç”Ÿé˜»å¡žï¼Œå®ƒæ˜¯ä¸ä¼šè®©å‡ºCPUæ—¶é—´ç»™å…¶ä»–åŒçº¿ç¨‹çš„goroutinesçš„ï¼Œè¿™æ˜¯Goè¿è¡Œæ—¶å¯¹goroutineçš„è°ƒåº¦ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨runtimeåŒ…æ¥æ‰‹å·¥è°ƒåº¦ã€‚ æœ¬æ–‡å¼€å¤´çš„ä¸¤ä¸ªä¾‹å­éƒ½æ˜¯é™åˆ¶åœ¨å•æ ¸CPUé‡Œæ‰§è¡Œçš„ï¼Œæ‰€æœ‰çš„goroutinesè·‘åœ¨ä¸€ä¸ªçº¿ç¨‹é‡Œé¢ï¼Œåˆ†æžå¦‚ä¸‹: å¯¹äºŽä»£ç ä¾‹å­ä¸€ï¼ˆloopå‡½æ•°çš„é‚£ä¸ªï¼‰ï¼Œæ¯ä¸ªgoroutineæ²¡æœ‰å‘ç”Ÿå µå¡ž(ç›´åˆ°quitæµå…¥æ•°æ®), æ‰€ä»¥åœ¨quitä¹‹å‰æ¯ä¸ªgoroutineä¸ä¼šä¸»åŠ¨è®©å‡ºCPUï¼Œä¹Ÿå°±å‘ç”Ÿäº†ä¸²è¡Œæ‰“å° å¯¹äºŽä»£ç ä¾‹å­äºŒï¼ˆtimeçš„é‚£ä¸ªï¼‰ï¼Œæ¯ä¸ªgoroutineåœ¨sleepè¢«è°ƒç”¨çš„æ—¶å€™ä¼šé˜»å¡žï¼Œè®©å‡ºCPU, æ‰€ä»¥ä¾‹å­äºŒå¹¶å‘æ‰§è¡Œã€‚ é‚£ä¹ˆå…³äºŽæˆ‘ä»¬å¼€å¯å¤šæ ¸çš„æ—¶å€™å‘¢ï¼ŸGoè¯­è¨€å¯¹goroutineçš„è°ƒåº¦è¡Œä¸ºåˆæ˜¯æ€Žä¹ˆæ ·çš„ï¼Ÿ æˆ‘ä»¬å¯ä»¥åœ¨Golangå®˜æ–¹ç½‘ç«™çš„è¿™é‡Œ æ‰¾åˆ°ä¸€å¥è¯: When a coroutine blocks, such as by calling a blocking system call, the run-time automatically moves other coroutines on the same operating system thread to a different, runnable thread so they wonâ€™t be blocked. ä¹Ÿå°±æ˜¯è¯´: å½“ä¸€ä¸ªgoroutineå‘ç”Ÿé˜»å¡žï¼ŒGoä¼šè‡ªåŠ¨åœ°æŠŠä¸Žè¯¥goroutineå¤„äºŽåŒä¸€ç³»ç»Ÿçº¿ç¨‹çš„å…¶ä»–goroutinesè½¬ç§»åˆ°å¦ä¸€ä¸ªç³»ç»Ÿçº¿ç¨‹ä¸ŠåŽ»ï¼Œä»¥ä½¿è¿™äº›goroutinesä¸é˜»å¡ž å¼€å¯å¤šæ ¸çš„å®žéªŒä»ç„¶éœ€è¦åšä¸€ä¸ªå®žéªŒï¼Œæ¥æµ‹è¯•ä¸‹å¤šæ ¸æ”¯æŒä¸‹goroutinesçš„å¯¹åŽŸç”Ÿçº¿ç¨‹çš„åˆ†é…, ä¹ŸéªŒè¯ä¸‹æˆ‘ä»¬æ‰€å¾—åˆ°çš„ç»“è®ºâ€œgoroutineä¸é˜»å¡žä¸æ”¾å¼€CPUâ€ã€‚ å®žéªŒä»£ç å¦‚ä¸‹: 123456789101112131415161718192021222324252627package mainimport ( &quot;fmt&quot; &quot;runtime&quot;)var quit chan int = make(chan int)func loop(id int) &#123; // id: è¯¥goroutineçš„æ ‡å· for i := 0; i &lt; 10; i++ &#123; //æ‰“å°10æ¬¡è¯¥goroutineçš„æ ‡å· fmt.Printf(&quot;%d &quot;, id) &#125; quit &lt;- 0&#125;func main() &#123; runtime.GOMAXPROCS(2) // æœ€å¤šåŒæ—¶ä½¿ç”¨2ä¸ªæ ¸ for i := 0; i &lt; 3; i++ &#123; //å¼€ä¸‰ä¸ªgoroutine go loop(i) &#125; for i := 0; i &lt; 3; i++ &#123; &lt;- quit &#125;&#125; å¤šè·‘å‡ æ¬¡ä¼šçœ‹åˆ°ç±»ä¼¼è¿™äº›è¾“å‡º(ä¸åŒæœºå™¨çŽ¯å¢ƒä¸ä¸€æ ·): 123450 0 0 0 0 1 1 0 0 1 0 0 1 0 1 2 1 2 1 2 1 2 1 2 1 2 2 2 2 20 0 0 0 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 2 2 2 2 2 2 2 2 2 20 0 0 0 0 0 0 1 1 1 1 1 0 1 0 1 0 1 2 1 2 1 2 2 2 2 2 2 2 20 0 0 0 0 0 0 1 1 1 1 1 1 1 1 1 1 0 2 0 2 0 2 2 2 2 2 2 2 20 0 0 0 0 0 0 1 0 0 1 0 1 2 1 2 1 2 1 2 1 2 1 2 1 2 1 2 2 2 æ‰§è¡Œå®ƒæˆ‘ä»¬ä¼šå‘çŽ°ä»¥ä¸‹çŽ°è±¡: æœ‰æ—¶ä¼šå‘ç”ŸæŠ¢å å¼è¾“å‡º(è¯´æ˜ŽGoå¼€äº†ä¸æ­¢ä¸€ä¸ªåŽŸç”Ÿçº¿ç¨‹ï¼Œè¾¾åˆ°äº†çœŸæ­£çš„å¹¶è¡Œ) æœ‰æ—¶ä¼šé¡ºåºè¾“å‡º, æ‰“å°å®Œ0å†æ‰“å°1, å†æ‰“å°2(è¯´æ˜ŽGoå¼€ä¸€ä¸ªåŽŸç”Ÿçº¿ç¨‹ï¼Œå•çº¿ç¨‹ä¸Šçš„goroutineä¸é˜»å¡žä¸æ¾å¼€CPU) é‚£ä¹ˆï¼Œæˆ‘ä»¬è¿˜ä¼šè§‚å¯Ÿåˆ°ä¸€ä¸ªçŽ°è±¡ï¼Œæ— è®ºæ˜¯æŠ¢å åœ°è¾“å‡ºè¿˜æ˜¯é¡ºåºçš„è¾“å‡ºï¼Œéƒ½ä¼šæœ‰é‚£ä¹ˆä¸¤ä¸ªæ•°å­—è¡¨çŽ°å‡ºè¿™æ ·çš„çŽ°è±¡: ä¸€ä¸ªæ•°å­—çš„æ‰€æœ‰è¾“å‡ºéƒ½ä¼šåœ¨å¦ä¸€ä¸ªæ•°å­—çš„æ‰€æœ‰è¾“å‡ºä¹‹å‰ åŽŸå› æ˜¯ï¼Œ 3ä¸ªgoroutineåˆ†é…åˆ°è‡³å¤š2ä¸ªçº¿ç¨‹ä¸Šï¼Œå°±ä¼šè‡³å°‘ä¸¤ä¸ªgoroutineåˆ†é…åˆ°åŒä¸€ä¸ªçº¿ç¨‹é‡Œï¼Œå•çº¿ç¨‹é‡Œçš„goroutine ä¸é˜»å¡žä¸æ”¾å¼€CPU, ä¹Ÿå°±å‘ç”Ÿäº†é¡ºåºè¾“å‡ºã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[(è½¬è½½)golangè¯­è¨€å¹¶å‘ä¸Žå¹¶è¡Œâ€”â€”goroutineå’Œchannelçš„è¯¦ç»†ç†è§£(1)]]></title>
    <url>%2F2018%2F12%2F07%2F%E8%BD%AC%E8%BD%BD-golang%E8%AF%AD%E8%A8%80%E5%B9%B6%E5%8F%91%E4%B8%8E%E5%B9%B6%E8%A1%8C%E2%80%94%E2%80%94goroutine%E5%92%8Cchannel%E7%9A%84%E8%AF%A6%E7%BB%86%E7%90%86%E8%A7%A3-1%2F</url>
    <content type="text"><![CDATA[æœ¬ç¯‡åšæ–‡è½¬è½½è‡ªgoè¯­è¨€ä¸­æ–‡ç½‘ï¼Œç‰ˆæƒå±žåŽŸä½œè€…æ‰€æœ‰ã€‚ å¦‚æžœä¸æ˜¯æˆ‘å¯¹çœŸæ­£å¹¶è¡Œçš„çº¿ç¨‹çš„è¿½æ±‚ï¼Œå°±ä¸ä¼šè®¤è¯†åˆ°Goæœ‰å¤šä¹ˆçš„è¿·äººã€‚ Goè¯­è¨€ä»Žè¯­è¨€å±‚é¢ä¸Šå°±æ”¯æŒäº†å¹¶å‘ï¼Œè¿™ä¸Žå…¶ä»–è¯­è¨€å¤§ä¸ä¸€æ ·ï¼Œä¸åƒä»¥å‰æˆ‘ä»¬è¦ç”¨Threadåº“ æ¥æ–°å»ºçº¿ç¨‹ï¼Œè¿˜è¦ç”¨çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—åº“æ¥å…±äº«æ•°æ®ã€‚ ä»¥ä¸‹æ˜¯æˆ‘å…¥é—¨çš„å­¦ä¹ ç¬”è®°ã€‚ Goè¯­è¨€çš„goroutinesã€ä¿¡é“å’Œæ­»é”goroutineGoè¯­è¨€ä¸­æœ‰ä¸ªæ¦‚å¿µå«åšgoroutine, è¿™ç±»ä¼¼æˆ‘ä»¬ç†ŸçŸ¥çš„çº¿ç¨‹ï¼Œä½†æ˜¯æ›´è½»ã€‚ ä»¥ä¸‹çš„ç¨‹åºï¼Œæˆ‘ä»¬ä¸²è¡Œåœ°åŽ»æ‰§è¡Œä¸¤æ¬¡loopå‡½æ•°: 1234567891011func loop() &#123; for i := 0; i &lt; 10; i++ &#123; fmt.Printf(&quot;%d &quot;, i) &#125;&#125;func main() &#123; loop() loop()&#125; æ¯«æ— ç–‘é—®ï¼Œè¾“å‡ºä¼šæ˜¯è¿™æ ·çš„: 10 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 ä¸‹é¢æˆ‘ä»¬æŠŠä¸€ä¸ªloopæ”¾åœ¨ä¸€ä¸ªgoroutineé‡Œè·‘ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å…³é”®å­—goæ¥å®šä¹‰å¹¶å¯åŠ¨ä¸€ä¸ªgoroutine: 1234func main() &#123; go loop() // å¯åŠ¨ä¸€ä¸ªgoroutine loop()&#125; è¿™æ¬¡çš„è¾“å‡ºå˜æˆäº†: 10 1 2 3 4 5 6 7 8 9 å¯æ˜¯ä¸ºä»€ä¹ˆåªè¾“å‡ºäº†ä¸€è¶Ÿå‘¢ï¼Ÿæ˜Žæ˜Žæˆ‘ä»¬ä¸»çº¿è·‘äº†ä¸€è¶Ÿï¼Œä¹Ÿå¼€äº†ä¸€ä¸ªgoroutineæ¥è·‘ä¸€è¶Ÿå•Šã€‚ åŽŸæ¥ï¼Œåœ¨goroutineè¿˜æ²¡æ¥å¾—åŠè·‘loopçš„æ—¶å€™ï¼Œä¸»å‡½æ•°å·²ç»é€€å‡ºäº†ã€‚ mainå‡½æ•°é€€å‡ºåœ°å¤ªå¿«äº†ï¼Œæˆ‘ä»¬è¦æƒ³åŠžæ³•é˜»æ­¢å®ƒè¿‡æ—©åœ°é€€å‡ºï¼Œä¸€ä¸ªåŠžæ³•æ˜¯è®©mainç­‰å¾…ä¸€ä¸‹: 12345func main() &#123; go loop() loop() time.Sleep(time.Second) // åœé¡¿ä¸€ç§’&#125; è¿™æ¬¡ç¡®å®žè¾“å‡ºäº†ä¸¤è¶Ÿï¼Œç›®çš„è¾¾åˆ°äº†ã€‚ å¯æ˜¯é‡‡ç”¨ç­‰å¾…çš„åŠžæ³•å¹¶ä¸å¥½ï¼Œå¦‚æžœgoroutineåœ¨ç»“æŸçš„æ—¶å€™ï¼Œå‘Šè¯‰ä¸‹ä¸»çº¿è¯´â€œHey, æˆ‘è¦è·‘å®Œäº†ï¼â€å°±å¥½äº†ï¼Œ å³æ‰€è°“é˜»å¡žä¸»çº¿çš„åŠžæ³•ï¼Œå›žå¿†ä¸‹æˆ‘ä»¬Pythoné‡Œé¢ç­‰å¾…æ‰€æœ‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•çš„å†™æ³•: 12for thread in threads: thread.join() æ˜¯çš„ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦ä¸€ä¸ªç±»ä¼¼joinçš„ä¸œè¥¿æ¥é˜»å¡žä½ä¸»çº¿ã€‚é‚£å°±æ˜¯ä¿¡é“ ä¿¡é“ä¿¡é“æ˜¯ä»€ä¹ˆï¼Ÿç®€å•è¯´ï¼Œæ˜¯goroutineä¹‹é—´äº’ç›¸é€šè®¯çš„ä¸œè¥¿ã€‚ç±»ä¼¼æˆ‘ä»¬Unixä¸Šçš„ç®¡é“ï¼ˆå¯ä»¥åœ¨è¿›ç¨‹é—´ä¼ é€’æ¶ˆæ¯ï¼‰ï¼Œ ç”¨æ¥goroutineä¹‹é—´å‘æ¶ˆæ¯å’ŒæŽ¥æ”¶æ¶ˆæ¯ã€‚å…¶å®žï¼Œå°±æ˜¯åœ¨åšgoroutineä¹‹é—´çš„å†…å­˜å…±äº«ã€‚ ä½¿ç”¨makeæ¥å»ºç«‹ä¸€ä¸ªä¿¡é“: 123var channel chan int = make(chan int)// æˆ–channel := make(chan int) é‚£å¦‚ä½•å‘ä¿¡é“å­˜æ¶ˆæ¯å’Œå–æ¶ˆæ¯å‘¢ï¼Ÿ ä¸€ä¸ªä¾‹å­: 12345678func main() &#123; var messages chan string = make(chan string) go func(message string) &#123; messages &lt;- message // å­˜æ¶ˆæ¯ &#125;(&quot;Ping!&quot;) fmt.Println(&lt;-messages) // å–æ¶ˆæ¯&#125; é»˜è®¤çš„ï¼Œä¿¡é“çš„å­˜æ¶ˆæ¯å’Œå–æ¶ˆæ¯éƒ½æ˜¯é˜»å¡žçš„ (å«åšæ— ç¼“å†²çš„ä¿¡é“ï¼Œä¸è¿‡ç¼“å†²è¿™ä¸ªæ¦‚å¿µç¨åŽäº†è§£ï¼Œå…ˆè¯´é˜»å¡žçš„é—®é¢˜)ã€‚ ä¹Ÿå°±æ˜¯è¯´, æ— ç¼“å†²çš„ä¿¡é“åœ¨å–æ¶ˆæ¯å’Œå­˜æ¶ˆæ¯çš„æ—¶å€™éƒ½ä¼šæŒ‚èµ·å½“å‰çš„goroutineï¼Œé™¤éžå¦ä¸€ç«¯å·²ç»å‡†å¤‡å¥½ã€‚ æ¯”å¦‚ä»¥ä¸‹çš„mainå‡½æ•°å’Œfooå‡½æ•°: 12345678910var ch chan int = make(chan int)func foo() &#123; ch &lt;- 0 // å‘chä¸­åŠ æ•°æ®ï¼Œå¦‚æžœæ²¡æœ‰å…¶ä»–goroutineæ¥å–èµ°è¿™ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆæŒ‚èµ·foo, ç›´åˆ°mainå‡½æ•°æŠŠ0è¿™ä¸ªæ•°æ®æ‹¿èµ°&#125;func main() &#123; go foo() &lt;- ch // ä»Žchå–æ•°æ®ï¼Œå¦‚æžœchä¸­è¿˜æ²¡æ”¾æ•°æ®ï¼Œé‚£å°±æŒ‚èµ·mainçº¿ï¼Œç›´åˆ°fooå‡½æ•°ä¸­æ”¾æ•°æ®ä¸ºæ­¢&#125; é‚£æ—¢ç„¶ä¿¡é“å¯ä»¥é˜»å¡žå½“å‰çš„goroutine, é‚£ä¹ˆå›žåˆ°ä¸Šä¸€éƒ¨åˆ†ã€Œgoroutineã€æ‰€é‡åˆ°çš„é—®é¢˜ã€Œå¦‚ä½•è®©goroutineå‘Šè¯‰ä¸»çº¿æˆ‘æ‰§è¡Œå®Œæ¯•äº†ã€ çš„é—®é¢˜æ¥, ä½¿ç”¨ä¸€ä¸ªä¿¡é“æ¥å‘Šè¯‰ä¸»çº¿å³å¯: 123456789101112131415var complete chan int = make(chan int)func loop() &#123; for i := 0; i &lt; 10; i++ &#123; fmt.Printf(&quot;%d &quot;, i) &#125; complete &lt;- 0 // æ‰§è¡Œå®Œæ¯•äº†ï¼Œå‘ä¸ªæ¶ˆæ¯&#125;func main() &#123; go loop() &lt;- complete // ç›´åˆ°çº¿ç¨‹è·‘å®Œ, å–åˆ°æ¶ˆæ¯. mainåœ¨æ­¤é˜»å¡žä½&#125; å¦‚æžœä¸ç”¨ä¿¡é“æ¥é˜»å¡žä¸»çº¿çš„è¯ï¼Œä¸»çº¿å°±ä¼šè¿‡æ—©è·‘å®Œï¼Œloopçº¿éƒ½æ²¡æœ‰æœºä¼šæ‰§è¡Œã€ã€ã€ å…¶å®žï¼Œæ— ç¼“å†²çš„ä¿¡é“æ°¸è¿œä¸ä¼šå­˜å‚¨æ•°æ®ï¼Œåªè´Ÿè´£æ•°æ®çš„æµé€šï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè®²å‘¢ï¼Ÿ ä»Žæ— ç¼“å†²ä¿¡é“å–æ•°æ®ï¼Œå¿…é¡»è¦æœ‰æ•°æ®æµè¿›æ¥æ‰å¯ä»¥ï¼Œå¦åˆ™å½“å‰çº¿é˜»å¡ž æ•°æ®æµå…¥æ— ç¼“å†²ä¿¡é“, å¦‚æžœæ²¡æœ‰å…¶ä»–goroutineæ¥æ‹¿èµ°è¿™ä¸ªæ•°æ®ï¼Œé‚£ä¹ˆå½“å‰çº¿é˜»å¡ž æ‰€ä»¥ï¼Œä½ å¯ä»¥æµ‹è¯•ä¸‹ï¼Œæ— è®ºå¦‚ä½•ï¼Œæˆ‘ä»¬æµ‹è¯•åˆ°çš„æ— ç¼“å†²ä¿¡é“çš„å¤§å°éƒ½æ˜¯0 (len(channel)) å¦‚æžœä¿¡é“æ­£æœ‰æ•°æ®åœ¨æµåŠ¨ï¼Œæˆ‘ä»¬è¿˜è¦åŠ å…¥æ•°æ®ï¼Œæˆ–è€…ä¿¡é“å¹²æ¶©ï¼Œæˆ‘ä»¬ä¸€ç›´å‘æ— æ•°æ®æµå…¥çš„ç©ºä¿¡é“å–æ•°æ®å‘¢ï¼Ÿ å°±ä¼šå¼•èµ·æ­»é” æ­»é”ä¸€ä¸ªæ­»é”çš„ä¾‹å­: 1234func main() &#123; ch := make(chan int) &lt;- ch // é˜»å¡žmain goroutine, ä¿¡é“cè¢«é”&#125; æ‰§è¡Œè¿™ä¸ªç¨‹åºä½ ä¼šçœ‹åˆ°GoæŠ¥è¿™æ ·çš„é”™è¯¯: 1fatal error: all goroutines are asleep - deadlock! ä½•è°“æ­»é”? æ“ä½œç³»ç»Ÿæœ‰è®²è¿‡çš„ï¼Œæ‰€æœ‰çš„çº¿ç¨‹æˆ–è¿›ç¨‹éƒ½åœ¨ç­‰å¾…èµ„æºçš„é‡Šæ”¾ã€‚å¦‚ä¸Šçš„ç¨‹åºä¸­, åªæœ‰ä¸€ä¸ªgoroutine, æ‰€ä»¥å½“ä½ å‘é‡Œé¢åŠ æ•°æ®æˆ–è€…å­˜æ•°æ®çš„è¯ï¼Œéƒ½ä¼šé”æ­»ä¿¡é“ï¼Œ å¹¶ä¸”é˜»å¡žå½“å‰ goroutine, ä¹Ÿå°±æ˜¯æ‰€æœ‰çš„goroutine(å…¶å®žå°±mainçº¿ä¸€ä¸ª)éƒ½åœ¨ç­‰å¾…ä¿¡é“çš„å¼€æ”¾(æ²¡äººæ‹¿èµ°æ•°æ®ä¿¡é“æ˜¯ä¸ä¼šå¼€æ”¾çš„)ï¼Œä¹Ÿå°±æ˜¯æ­»é”å’¯ã€‚ æˆ‘å‘çŽ°æ­»é”æ˜¯ä¸€ä¸ªå¾ˆæœ‰æ„æ€çš„è¯é¢˜ï¼Œè¿™é‡Œæœ‰å‡ ä¸ªæ­»é”çš„ä¾‹å­: åªåœ¨å•ä¸€çš„goroutineé‡Œæ“ä½œæ— ç¼“å†²ä¿¡é“ï¼Œä¸€å®šæ­»é”ã€‚æ¯”å¦‚ä½ åªåœ¨mainå‡½æ•°é‡Œæ“ä½œä¿¡é“: 12345func main() &#123; ch := make(chan int) ch &lt;- 1 // 1æµå…¥ä¿¡é“ï¼Œå µå¡žå½“å‰çº¿, æ²¡äººå–èµ°æ•°æ®ä¿¡é“ä¸ä¼šæ‰“å¼€ fmt.Println(&quot;This line code wont run&quot;) //åœ¨æ­¤è¡Œæ‰§è¡Œä¹‹å‰Goå°±ä¼šæŠ¥æ­»é”&#125; å¦‚ä¸‹ä¹Ÿæ˜¯ä¸€ä¸ªæ­»é”çš„ä¾‹å­: 123456789101112var ch1 chan int = make(chan int)var ch2 chan int = make(chan int)func say(s string) &#123; fmt.Println(s) ch1 &lt;- &lt;- ch2 // ch1 ç­‰å¾… ch2æµå‡ºçš„æ•°æ®&#125;func main() &#123; go say(&quot;hello&quot;) &lt;- ch1 // å µå¡žä¸»çº¿&#125; å…¶ä¸­ä¸»çº¿ç­‰ch1ä¸­çš„æ•°æ®æµå‡ºï¼Œch1ç­‰ch2çš„æ•°æ®æµå‡ºï¼Œä½†æ˜¯ch2ç­‰å¾…æ•°æ®æµå…¥ï¼Œä¸¤ä¸ªgoroutineéƒ½åœ¨ç­‰ï¼Œä¹Ÿå°±æ˜¯æ­»é”ã€‚ å…¶å®žï¼Œæ€»ç»“æ¥çœ‹ï¼Œä¸ºä»€ä¹ˆä¼šæ­»é”ï¼Ÿéžç¼“å†²ä¿¡é“ä¸Šå¦‚æžœå‘ç”Ÿäº†æµå…¥æ— æµå‡ºï¼Œæˆ–è€…æµå‡ºæ— æµå…¥ï¼Œä¹Ÿå°±å¯¼è‡´äº†æ­»é”ã€‚æˆ–è€…è¿™æ ·ç†è§£ Goå¯åŠ¨çš„æ‰€æœ‰goroutineé‡Œçš„éžç¼“å†²ä¿¡é“ä¸€å®šè¦ä¸€ä¸ªçº¿é‡Œå­˜æ•°æ®ï¼Œä¸€ä¸ªçº¿é‡Œå–æ•°æ®ï¼Œè¦æˆå¯¹æ‰è¡Œ ã€‚æ‰€ä»¥ä¸‹é¢çš„ç¤ºä¾‹ä¸€å®šæ­»é”: 12345678c, quit := make(chan int), make(chan int)go func() &#123; c &lt;- 1 // cé€šé“çš„æ•°æ®æ²¡æœ‰è¢«å…¶ä»–goroutineè¯»å–èµ°ï¼Œå µå¡žå½“å‰goroutine quit &lt;- 0 // quitå§‹ç»ˆæ²¡æœ‰åŠžæ³•å†™å…¥æ•°æ®&#125;()&lt;- quit // quit ç­‰å¾…æ•°æ®çš„å†™ ä»”ç»†åˆ†æžçš„è¯ï¼Œæ˜¯ç”±äºŽï¼šä¸»çº¿ç­‰å¾…quitä¿¡é“çš„æ•°æ®æµå‡ºï¼Œquitç­‰å¾…æ•°æ®å†™å…¥ï¼Œè€Œfuncè¢«cé€šé“å µå¡žï¼Œæ‰€æœ‰goroutineéƒ½åœ¨ç­‰ï¼Œæ‰€ä»¥æ­»é”ã€‚ ç®€å•æ¥çœ‹çš„è¯ï¼Œä¸€å…±ä¸¤ä¸ªçº¿ï¼Œfuncçº¿ä¸­æµå…¥cé€šé“çš„æ•°æ®å¹¶æ²¡æœ‰åœ¨mainçº¿ä¸­æµå‡ºï¼Œè‚¯å®šæ­»é”ã€‚ ä½†æ˜¯ï¼Œæ˜¯å¦æžœçœŸ æ‰€æœ‰ä¸æˆå¯¹å‘ä¿¡é“å­˜å–æ•°æ®çš„æƒ…å†µéƒ½æ˜¯æ­»é”? å¦‚ä¸‹æ˜¯ä¸ªåä¾‹: 1234567func main() &#123; c := make(chan int) go func() &#123; c &lt;- 1 &#125;()&#125; ç¨‹åºæ­£å¸¸é€€å‡ºäº†ï¼Œå¾ˆç®€å•ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬é‚£ä¸ªæ€»ç»“ä¸èµ·ä½œç”¨äº†ï¼Œè¿˜æ˜¯å› ä¸ºä¸€ä¸ªè®©äººå¾ˆå›§çš„åŽŸå› ï¼Œmainåˆæ²¡ç­‰å¾…å…¶å®ƒgoroutineï¼Œè‡ªå·±å…ˆè·‘å®Œäº†ï¼Œ æ‰€ä»¥æ²¡æœ‰æ•°æ®æµå…¥cä¿¡é“ï¼Œä¸€å…±æ‰§è¡Œäº†ä¸€ä¸ªgoroutine, å¹¶ä¸”æ²¡æœ‰å‘ç”Ÿé˜»å¡žï¼Œæ‰€ä»¥æ²¡æœ‰æ­»é”é”™è¯¯ã€‚ é‚£ä¹ˆæ­»é”çš„è§£å†³åŠžæ³•å‘¢ï¼Ÿ æœ€ç®€å•çš„ï¼ŒæŠŠæ²¡å–èµ°çš„æ•°æ®å–èµ°ï¼Œæ²¡æ”¾å…¥çš„æ•°æ®æ”¾å…¥ï¼Œ å› ä¸ºæ— ç¼“å†²ä¿¡é“ä¸èƒ½æ‰¿è½½æ•°æ®ï¼Œé‚£ä¹ˆå°±èµ¶ç´§æ‹¿èµ°ï¼ å…·ä½“æ¥è®²ï¼Œå°±æ­»é”ä¾‹å­3ä¸­çš„æƒ…å†µï¼Œå¯ä»¥è¿™ä¹ˆé¿å…æ­»é”: 123456789c, quit := make(chan int), make(chan int)go func() &#123; c &lt;- 1 quit &lt;- 0&#125;()&lt;- c // å–èµ°cçš„æ•°æ®ï¼&lt;-quit å¦ä¸€ä¸ªè§£å†³åŠžæ³•æ˜¯ç¼“å†²ä¿¡é“, å³è®¾ç½®cæœ‰ä¸€ä¸ªæ•°æ®çš„ç¼“å†²å¤§å°: 1c := make(chan int, 1) è¿™æ ·çš„è¯ï¼Œcå¯ä»¥ç¼“å­˜ä¸€ä¸ªæ•°æ®ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæ”¾å…¥ä¸€ä¸ªæ•°æ®ï¼Œcå¹¶ä¸ä¼šæŒ‚èµ·å½“å‰çº¿, å†æ”¾ä¸€ä¸ªæ‰ä¼šæŒ‚èµ·å½“å‰çº¿ç›´åˆ°ç¬¬ä¸€ä¸ªæ•°æ®è¢«å…¶ä»–goroutineå–èµ°, ä¹Ÿå°±æ˜¯åªé˜»å¡žåœ¨å®¹é‡ä¸€å®šçš„æ—¶å€™ï¼Œä¸è¾¾å®¹é‡ä¸é˜»å¡žã€‚ è¿™ååˆ†ç±»ä¼¼æˆ‘ä»¬Pythonä¸­çš„é˜Ÿåˆ—Queueä¸æ˜¯å—ï¼Ÿ æ— ç¼“å†²ä¿¡é“çš„æ•°æ®è¿›å‡ºé¡ºåºæˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œæ— ç¼“å†²ä¿¡é“ä»Žä¸å­˜å‚¨æ•°æ®ï¼Œæµå…¥çš„æ•°æ®å¿…é¡»è¦æµå‡ºæ‰å¯ä»¥ã€‚ è§‚å¯Ÿä»¥ä¸‹çš„ç¨‹åº: 1234567891011121314151617var ch chan int = make(chan int)func foo(id int) &#123; //id: è¿™ä¸ªroutineçš„æ ‡å· ch &lt;- id&#125;func main() &#123; // å¼€å¯5ä¸ªroutine for i := 0; i &lt; 5; i++ &#123; go foo(i) &#125; // å–å‡ºä¿¡é“ä¸­çš„æ•°æ® for i := 0; i &lt; 5; i++ &#123; fmt.Print(&lt;- ch) &#125;&#125; æˆ‘ä»¬å¼€äº†5ä¸ªgoroutineï¼Œç„¶åŽåˆä¾æ¬¡å–æ•°æ®ã€‚å…¶å®žæ•´ä¸ªçš„æ‰§è¡Œè¿‡ç¨‹ç»†åˆ†çš„è¯ï¼Œ5ä¸ªçº¿çš„æ•°æ® ä¾æ¬¡æµè¿‡ä¿¡é“ch, mainæ‰“å°ä¹‹, è€Œå®è§‚ä¸Šæˆ‘ä»¬çœ‹åˆ°çš„å³ æ— ç¼“å†²ä¿¡é“çš„æ•°æ®æ˜¯å…ˆåˆ°å…ˆå‡ºï¼Œä½†æ˜¯ æ— ç¼“å†²ä¿¡é“å¹¶ä¸å­˜å‚¨æ•°æ®ï¼Œåªè´Ÿè´£æ•°æ®çš„æµé€š ç¼“å†²ä¿¡é“ç»ˆäºŽåˆ°äº†è¿™ä¸ªè¯é¢˜äº†, å…¶å®žç¼“å­˜ä¿¡é“ç”¨è‹±æ–‡æ¥è®²æ›´ä¸ºè¾¾æ„: buffered channel. ç¼“å†²è¿™ä¸ªè¯æ„æ€æ˜¯ï¼Œç¼“å†²ä¿¡é“ä¸ä»…å¯ä»¥æµé€šæ•°æ®ï¼Œè¿˜å¯ä»¥ç¼“å­˜æ•°æ®ã€‚å®ƒæ˜¯æœ‰å®¹é‡çš„ï¼Œå­˜å…¥ä¸€ä¸ªæ•°æ®çš„è¯ , å¯ä»¥å…ˆæ”¾åœ¨ä¿¡é“é‡Œï¼Œä¸å¿…é˜»å¡žå½“å‰çº¿è€Œç­‰å¾…è¯¥æ•°æ®å–èµ°ã€‚ å½“ç¼“å†²ä¿¡é“è¾¾åˆ°æ»¡çš„çŠ¶æ€çš„æ—¶å€™ï¼Œå°±ä¼šè¡¨çŽ°å‡ºé˜»å¡žäº†ï¼Œå› ä¸ºè¿™æ—¶å†ä¹Ÿä¸èƒ½æ‰¿è½½æ›´å¤šçš„æ•°æ®äº†ï¼Œã€Œä½ ä»¬å¿…é¡»æŠŠ æ•°æ®æ‹¿èµ°ï¼Œæ‰å¯ä»¥æµå…¥æ•°æ®ã€ã€‚ åœ¨å£°æ˜Žä¸€ä¸ªä¿¡é“çš„æ—¶å€™ï¼Œæˆ‘ä»¬ç»™makeä»¥ç¬¬äºŒä¸ªå‚æ•°æ¥æŒ‡æ˜Žå®ƒçš„å®¹é‡(é»˜è®¤ä¸º0ï¼Œå³æ— ç¼“å†²): 1var ch chan int = make(chan int, 2) // å†™å…¥2ä¸ªå…ƒç´ éƒ½ä¸ä¼šé˜»å¡žå½“å‰goroutine, å­˜å‚¨ä¸ªæ•°è¾¾åˆ°2çš„æ—¶å€™ä¼šé˜»å¡ž å¦‚ä¸‹çš„ä¾‹å­ï¼Œç¼“å†²ä¿¡é“chå¯ä»¥æ— ç¼“å†²çš„æµå…¥3ä¸ªå…ƒç´ : 123456func main() &#123; ch := make(chan int, 3) ch &lt;- 1 ch &lt;- 2 ch &lt;- 3&#125; å¦‚æžœä½ å†è¯•å›¾æµå…¥ä¸€ä¸ªæ•°æ®çš„è¯ï¼Œä¿¡é“chä¼šé˜»å¡žmainçº¿, æŠ¥æ­»é”ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œç¼“å†²ä¿¡é“ä¼šåœ¨æ»¡å®¹é‡çš„æ—¶å€™åŠ é”ã€‚ å…¶å®žï¼Œç¼“å†²ä¿¡é“æ˜¯å…ˆè¿›å…ˆå‡ºçš„ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç¼“å†²ä¿¡é“çœ‹ä½œä¸ºä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—ï¼š 12345678910func main() &#123; ch := make(chan int, 3) ch &lt;- 1 ch &lt;- 2 ch &lt;- 3 fmt.Println(&lt;-ch) // 1 fmt.Println(&lt;-ch) // 2 fmt.Println(&lt;-ch) // 3&#125; ä¿¡é“æ•°æ®è¯»å–å’Œä¿¡é“å…³é—­ä½ ä¹Ÿè®¸å‘çŽ°ï¼Œä¸Šé¢çš„ä»£ç ä¸€ä¸ªä¸€ä¸ªåœ°åŽ»è¯»å–ä¿¡é“ç®€ç›´å¤ªè´¹äº‹äº†ï¼ŒGoè¯­è¨€å…è®¸æˆ‘ä»¬ä½¿ç”¨rangeæ¥è¯»å–ä¿¡é“: 12345678910func main() &#123; ch := make(chan int, 3) ch &lt;- 1 ch &lt;- 2 ch &lt;- 3 for v := range ch &#123; fmt.Println(v) &#125;&#125; å¦‚æžœä½ æ‰§è¡Œäº†ä¸Šé¢çš„ä»£ç ï¼Œä¼šæŠ¥æ­»é”é”™è¯¯çš„ï¼ŒåŽŸå› æ˜¯rangeä¸ç­‰åˆ°ä¿¡é“å…³é—­æ˜¯ä¸ä¼šç»“æŸè¯»å–çš„ã€‚ä¹Ÿå°±æ˜¯å¦‚æžœ ç¼“å†²ä¿¡é“å¹²æ¶¸äº†ï¼Œé‚£ä¹ˆrangeå°±ä¼šé˜»å¡žå½“å‰goroutine, æ‰€ä»¥æ­»é”å’¯ã€‚ é‚£ä¹ˆï¼Œæˆ‘ä»¬è¯•ç€é¿å…è¿™ç§æƒ…å†µï¼Œæ¯”è¾ƒå®¹æ˜“æƒ³åˆ°çš„æ˜¯è¯»åˆ°ä¿¡é“ä¸ºç©ºçš„æ—¶å€™å°±ç»“æŸè¯»å–: 12345678910ch := make(chan int, 3)ch &lt;- 1ch &lt;- 2ch &lt;- 3for v := range ch &#123; fmt.Println(v) if len(ch) &lt;= 0 &#123; // å¦‚æžœçŽ°æœ‰æ•°æ®é‡ä¸º0ï¼Œè·³å‡ºå¾ªçŽ¯ break &#125;&#125; ä»¥ä¸Šçš„æ–¹æ³•æ˜¯å¯ä»¥æ­£å¸¸è¾“å‡ºçš„ï¼Œä½†æ˜¯æ³¨æ„æ£€æŸ¥ä¿¡é“å¤§å°çš„æ–¹æ³•ä¸èƒ½åœ¨ä¿¡é“å­˜å–éƒ½åœ¨å‘ç”Ÿçš„æ—¶å€™ç”¨äºŽå–å‡ºæ‰€æœ‰æ•°æ®ï¼Œè¿™ä¸ªä¾‹å­ æ˜¯å› ä¸ºæˆ‘ä»¬åªåœ¨chä¸­å­˜äº†æ•°æ®ï¼ŒçŽ°åœ¨ä¸€ä¸ªä¸€ä¸ªå¾€å¤–å–ï¼Œä¿¡é“å¤§å°æ˜¯é€’å‡çš„ã€‚ å¦ä¸€ä¸ªæ–¹å¼æ˜¯æ˜¾å¼åœ°å…³é—­ä¿¡é“: 1234567891011ch := make(chan int, 3)ch &lt;- 1ch &lt;- 2ch &lt;- 3// æ˜¾å¼åœ°å…³é—­ä¿¡é“close(ch)for v := range ch &#123; fmt.Println(v)&#125; è¢«å…³é—­çš„ä¿¡é“ä¼šç¦æ­¢æ•°æ®æµå…¥, æ˜¯åªè¯»çš„ã€‚æˆ‘ä»¬ä»ç„¶å¯ä»¥ä»Žå…³é—­çš„ä¿¡é“ä¸­å–å‡ºæ•°æ®ï¼Œä½†æ˜¯ä¸èƒ½å†å†™å…¥æ•°æ®äº†ã€‚ ç­‰å¾…å¤šgorountineçš„æ–¹æ¡ˆé‚£å¥½ï¼Œæˆ‘ä»¬å›žåˆ°æœ€åˆçš„ä¸€ä¸ªé—®é¢˜ï¼Œä½¿ç”¨ä¿¡é“å µå¡žä¸»çº¿ï¼Œç­‰å¾…å¼€å‡ºåŽ»çš„æ‰€æœ‰goroutineè·‘å®Œã€‚ è¿™æ˜¯ä¸€ä¸ªæ¨¡åž‹ï¼Œå¼€å‡ºå¾ˆå¤šå°goroutine, å®ƒä»¬å„è‡ªè·‘å„è‡ªçš„ï¼Œæœ€åŽè·‘å®Œäº†å‘ä¸»çº¿æŠ¥å‘Šã€‚ æˆ‘ä»¬è®¨è®ºå¦‚ä¸‹2ä¸ªç‰ˆæœ¬çš„æ–¹æ¡ˆ: åªä½¿ç”¨å•ä¸ªæ— ç¼“å†²ä¿¡é“é˜»å¡žä¸»çº¿ ä½¿ç”¨å®¹é‡ä¸ºgoroutinesæ•°é‡çš„ç¼“å†²ä¿¡é“ å¯¹äºŽæ–¹æ¡ˆ1, ç¤ºä¾‹çš„ä»£ç å¤§æ¦‚ä¼šæ˜¯è¿™ä¸ªæ ·å­: 12345678910111213141516171819var quit chan int // åªå¼€ä¸€ä¸ªä¿¡é“func foo(id int) &#123; fmt.Println(id) quit &lt;- 0 // ok, finished&#125;func main() &#123; count := 1000 quit = make(chan int) // æ— ç¼“å†² for i := 0; i &lt; count; i++ &#123; go foo(i) &#125; for i := 0; i &lt; count; i++ &#123; &lt;- quit &#125;&#125; å¯¹äºŽæ–¹æ¡ˆ2, æŠŠä¿¡é“æ¢æˆç¼“å†²1000çš„: 1quit = make(chan int, count) // å®¹é‡1000 å…¶å®žåŒºåˆ«ä»…ä»…åœ¨äºŽä¸€ä¸ªæ˜¯ç¼“å†²çš„ï¼Œä¸€ä¸ªæ˜¯éžç¼“å†²çš„ã€‚ å¯¹äºŽè¿™ä¸ªåœºæ™¯è€Œè¨€ï¼Œä¸¤è€…éƒ½èƒ½å®Œæˆä»»åŠ¡, éƒ½æ˜¯å¯ä»¥çš„ã€‚ æ— ç¼“å†²çš„ä¿¡é“æ˜¯ä¸€æ‰¹æ•°æ®ä¸€ä¸ªä¸€ä¸ªçš„ã€Œæµè¿›æµå‡ºã€ ç¼“å†²ä¿¡é“åˆ™æ˜¯ä¸€ä¸ªä¸€ä¸ªå­˜å‚¨ï¼Œç„¶åŽä¸€èµ·æµå‡ºåŽ»]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysqlä¸­å­—æ®µåä¸Žä¿ç•™å­—å†²çª]]></title>
    <url>%2F2018%2F12%2F04%2Fmysql%E4%B8%AD%E5%AD%97%E6%AE%B5%E5%90%8D%E4%B8%8E%E4%BF%9D%E7%95%99%E5%AD%97%E5%86%B2%E7%AA%81%2F</url>
    <content type="text"><![CDATA[åœ¨è®¾è®¡æ•°æ®åº“çš„æ—¶å€™ä¸å°å¿ƒå°†æ•°æ®åº“çš„å­—æ®µè®¾ç½®æˆäº†å…¶å†…ç½®çš„ä¿ç•™å­—ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¿™æ®µï¼š 123456CREATE TABLE IF NOT EXISTS `test_billing` (`vendor` varchar(255),`cn` varchar(255),`current_date` varchar(255),`cost` varchar(255)) ENGINE=InnoDB DEFAULT CHARSET=utf8; è¿™æ ·ä½ åœ¨æ‰§è¡Œç±»ä¼¼ä¸‹é¢çš„æŸ¥è¯¢æ—¶ï¼š 1select cn, cost from test_billing where current_date like&quot;2018-10%&quot;; è¿”å›žå€¼ä¸­ä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œè¿˜å¸¦äº†ä¸€ä¸ªwarningï¼š 1Empty set, 1 warning (0.00 sec) åŽŸå› å°±æ˜¯å­—æ®µcurrent_dateä¸ŽMySQLå†…ç½®çš„ä¿ç•™å­—å†²çªäº†ï¼Œé‚£ä¹ˆè¿™æ—¶å€™ä½ è¿˜æ€¥éœ€æŸ¥çœ‹è¿™äº›æ•°æ®ï¼Œæ¯”è¾ƒå¿«çš„æ–¹æ³•å°±æ˜¯ï¼šåœ¨å†²çªå­—æ®µä¸ŠåŠ åå¼•å· current_date,å³ 1select cn, cost from test_billing where `current_date` like&quot;2018-10%&quot;; å°±å¯ä»¥è§£å†³äº†ã€‚]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[gitå¸¸ç”¨æ“ä½œ]]></title>
    <url>%2F2018%2F12%2F02%2Fgit%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C%2F</url>
    <content type="text"><![CDATA[é¦–å…ˆæ¥ä¸€éä»Žforkåˆ°pull requestè¿™ä¸ªè¿‡ç¨‹çš„åŸºç¡€æµç¨‹é¦–å…ˆï¼Œfork ä¸€ä¸ªrepositoryï¼Œå®žé™…ä¸Šæ˜¯å¤åˆ¶äº†ä¸€ä»½ repository åˆ°è‡ªå·±çš„ GitHub è´¦æˆ·ä¸‹ï¼Œç„¶åŽå°±å¯ä»¥ä»Ž GitHub å°†å®ƒ clone åˆ°ä½ çš„ç”µè„‘ä¸Šï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š git clone è¿žæŽ¥åˆ°åŽŸå§‹çš„Repositoryï¼Œå› ä¸ºå¦‚æžœåŽŸå§‹çš„Repositoryå†…å®¹æœ‰æ‰€æ”¹å˜æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›èƒ½å¤Ÿpullè¿™äº›å˜åŒ–ï¼Œæ‰€ä»¥æ–°å¢žä¸€ä¸ªè¿œç«¯é“¾æŽ¥ï¼Œå¹¶æŠŠå®ƒå‘½åä¸ºâ€™upstreamâ€™ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š git remote add upstream æ–°å¢žbranchåˆ†æ”¯ï¼Œå¹¶é€‰ç”¨æ–°å¢žåˆ†æ”¯ã€‚é¿å…ä¸Žä¸»åˆ†æ”¯masteré€ æˆå†²çªï¼Œå½“æˆ‘ä»¬åœ¨æ–°å¢žåˆ†æ”¯ä¸Šå®Œæˆäº†è‡ªå·±çš„åŠŸèƒ½åŽå†åˆå¹¶åˆ°ä¸»åˆ†æ”¯ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š git branch git checkout git checkout -b â€“åˆ›å»ºæ–°çš„åˆ†æ”¯å¹¶åˆ‡æ¢åˆ°æ–°çš„åˆ†æ”¯ä¸Šè®°å½•ï¼Œåœ¨æˆ‘ä»¬è‡ªå·±çš„åˆ†æ”¯ä¸Šä¿®æ”¹åŽï¼Œéœ€è¦è®°å½•ä¸‹æ¥ã€‚ git status â€“æŸ¥çœ‹å½“å‰çŠ¶æ€git add -A â€“è®°å½•ä¿®æ”¹æ–‡ä»¶ï¼ŒåŠ ä¸Š -Aï¼Œæœƒå°‡æ–°å¢žæª”æ¡ˆè·Ÿåˆªé™¤æª”æ¡ˆçš„å‹•ä½œä¸€èµ·è¨˜éŒ„ä¸‹ä¾†git commit -m â€œadd a fileâ€ â€“æäº¤å…¨éƒ¨ä¿®æ”¹git checkout master â€“ç¬¬äºŒå¤©å¼€å§‹å·¥ä½œå‰ï¼Œåˆ‡æ¢åˆ°masteråˆ†æ”¯git pull origin master â€“ä»Žmasterçš„è¿œç¨‹åˆ†æ”¯æ‹‰å–ä»£ç git checkout â€“åˆ‡æ¢åˆ°taskæ‰€åœ¨çš„æœ¬åœ°åˆ†æ”¯git rebase -i master â€“å°†masterä¸Šçš„æœ€æ–°çš„ä»£ç åˆå¹¶åˆ°å½“å‰åˆ†æ”¯ä¸Šï¼Œè¿™é‡Œçš„-içš„ä½œç”¨æ˜¯å°†æˆ‘ä»¬ å½“å‰åˆ†æ”¯ä¹‹å‰çš„commitåŽ‹ç¼©æˆä¸ºä¸€ä¸ªcommitï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºŽå½“æˆ‘ä»¬ä¹‹åŽåˆ›å»ºpull requestå¹¶è¿›è¡Œç›¸åº”çš„code reviewçš„æ—¶å€™ï¼Œä»£ç çš„æ”¹åŠ¨ä¼šé›†ä¸­åœ¨ä¸€ä¸ªcommitï¼Œä½¿å¾—code reviewæ›´ç›´è§‚æ–¹ä¾¿git push â€“set-upstream origin â€“æœ€åŽï¼Œå½“taskçš„æ‰€æœ‰ç¼–ç å®Œæˆä¹‹åŽï¼Œå°†ä»£ç pushåˆ°è¿œç¨‹åˆ†æ”¯å…ˆèŽ·å–è¿œç«¯ï¼Œå†æäº¤ï¼Œæ¯æ¬¡æäº¤ä»£ç å‰ï¼Œéƒ½éœ€è¦å…ˆèŽ·å–æœ€æ–°ä»£ç ï¼Œé˜²æ­¢è¦†ç›–ä»–äººä»£ç  git fetch â€“dry-run â€“æ£€æŸ¥è¿œç«¯æ˜¯å¦æœ‰å˜åŠ¨git pull â€“ä»Žè¿œç«¯åˆ†æ”¯æ›´æ–°æœ€æ–°ä»£ç å»ºç«‹Pull Requestsï¼Œè¿›å…¥ä½ çš„githubé¡¹ç›®é¡µï¼Œä¸€èˆ¬æƒ…å†µä¸‹ GitHubä¼šæ£€æµ‹åˆ°ä½ æœ‰äº†æ–°çš„æŽ¨é€ï¼Œä¼šä¸»åŠ¨æç¤ºä½ ï¼Œç‚¹å‡»Create pull requestï¼Œå†™ä¸Šè¯´æ˜Žï¼Œå†æŒ‰Send pull requestå°±å®Œæˆäº†ï¼Œå¦‚æžœ Pull Request æ²’æœ‰é—®é¢˜çš„è¯ï¼Œå¾ˆå¿«å°±æœƒè¢«è‡ªåŠ¨åˆå¹¶ merged äº†å“¦ï¼ æœ¬åœ°åˆå¹¶åˆ†æ”¯ï¼Œå¹¶åˆ é™¤åˆ†æ”¯ï¼Œå°†åˆ†æ”¯åˆå¹¶åˆ°ä¸»åˆ†æ”¯ä¸Šï¼Œå¹¶åˆ é™¤ä¹‹ git checkout master â€“é¦–å…ˆåˆ‡æ¢åˆ°ä¸»åˆ†æ”¯ä¸­git merge â€“åˆå¹¶å¦ä¸€ä¸ªåˆ†æ”¯è¿›æ¥git branch -d â€“åˆ æŽ‰åˆšåˆšåˆå¹¶çš„åˆ†æ”¯git push â€“delete â€“ä¹Ÿå¯ä»¥æŠŠåˆå¹¶åˆ†æ”¯ä»ŽGitHubä¸Šçš„å‰¯æœ¬repositoryä¸­åˆªé™¤å…¶ä»–å¸¸ç”¨å‘½ä»¤git init â€“å°†ä¸€ä¸ªæ–‡ä»¶å¤¹åˆå§‹åŒ–ä¸ºgitä»“åº“git status â€“æ£€æŸ¥å½“å‰repositoryä¸­çš„ä¿®æ”¹git diff â€“æŸ¥çœ‹å¯¹æ–‡ä»¶çš„ä¿®æ”¹git add â€“å‡†å¤‡æäº¤å¯¹äºŽä¸€ä¸ªæ–‡ä»¶çš„ä¿®æ”¹git add . â€“å‡†å¤‡æäº¤å¯¹æ‰€æœ‰æ–‡ä»¶çš„ä¿®æ”¹git commit -m â€œâ€œ â€“æäº¤ä½ æ‰€å‡†å¤‡å¥½çš„ä¿®æ”¹ï¼Œå¹¶é™„ä¸Šç®€çŸ­è¯´æ˜Žgit config â€“global user.username â€“é…ç½®githubè´¦å·git remote add â€“æ–°å¢žè¿œç«¯é“¾æŽ¥git remote set-url â€“å¯¹ä¸€ä¸ªè¿œç«¯è®¾å®šåœ°å€git remote add â€“æ–°å¢žå¸¦åœ°å€çš„è¿œç«¯é“¾æŽ¥git remote -v â€“æŸ¥çœ‹æ‰€æœ‰è¿œç«¯git pull â€“ä»Žä¸€ä¸ªè¿œç«¯æ”¶å–æ›´æ–°ï¼ˆé»˜è®¤ä¸ºä¸»åˆ†æ”¯ï¼‰git push â€“æäº¤ä»£ç åˆ°æŒ‡å®šè¿œç«¯ï¼ˆé»˜è®¤ä¸ºä¸»åˆ†æ”¯ï¼‰git branch -M â€“ä¿®æ”¹å½“å‰åˆ†æ”¯åå­—git branch â€“åˆ—å‡ºæ‰€æœ‰åˆ†æ”¯]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ionic project-Could not find module @angular-devkit/build-angular from XXX]]></title>
    <url>%2F2018%2F11%2F30%2Fionic-project-Could-not-find-module-angular-devkit-build-angular-from-XXX%2F</url>
    <content type="text"><![CDATA[ä»ŽGitHubä¸Šæ‰¾äº†ä¸€ä¸ªionicçš„demoï¼Œå‡†å¤‡è¿è¡Œä¸€ä¸‹ï¼ŒæŠ¥é”™ï¼šCould not find module @angular-devkit/build-angular from XXX æ“ä½œæ­¥éª¤ï¼š git clone https://github.com/ionic-team/ionic-conference-app.git ionic serve æŠ¥é”™ï¼š 1Could not find module &quot;@angular-devkit/build-angular&quot; from è§£å†³æ–¹æ¡ˆï¼š npm install â€“save @angular-devkit/build-angular]]></content>
      <categories>
        <category>frontEnd</category>
      </categories>
      <tags>
        <tag>angular</tag>
        <tag>ionic</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¿«æŽ’ä¹‹golangå®žçŽ°]]></title>
    <url>%2F2018%2F11%2F18%2F%E5%BF%AB%E6%8E%92%E4%B9%8Bgolang%E5%AE%9E%E7%8E%B0%2F</url>
    <content type="text"><![CDATA[å¿«é€ŸæŽ’åºç”±C. A. R. Hoareåœ¨1962å¹´æå‡ºã€‚å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯ï¼šé€šè¿‡ä¸€è¶ŸæŽ’åºå°†è¦æŽ’åºçš„æ•°æ®åˆ†å‰²æˆç‹¬ç«‹çš„ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½æ¯”å¦å¤–ä¸€éƒ¨åˆ†çš„æ‰€æœ‰æ•°æ®éƒ½è¦å°ï¼Œç„¶åŽå†æŒ‰æ­¤æ–¹æ³•å¯¹è¿™ä¸¤éƒ¨åˆ†æ•°æ®åˆ†åˆ«è¿›è¡Œå¿«é€ŸæŽ’åºï¼Œæ•´ä¸ªæŽ’åºè¿‡ç¨‹å¯ä»¥é€’å½’è¿›è¡Œï¼Œä»¥æ­¤è¾¾åˆ°æ•´ä¸ªæ•°æ®å˜æˆæœ‰åºåºåˆ—ã€‚ åˆ©ç”¨åˆ†æ²»æ³•å¯å°†å¿«é€ŸæŽ’åºçš„åˆ†ä¸ºä¸‰æ­¥ï¼š åœ¨æ•°æ®é›†ä¹‹ä¸­ï¼Œé€‰æ‹©ä¸€ä¸ªå…ƒç´ ä½œä¸ºâ€åŸºå‡†â€ï¼ˆpivotï¼‰ã€‚ æ‰€æœ‰å°äºŽâ€åŸºå‡†â€çš„å…ƒç´ ï¼Œéƒ½ç§»åˆ°â€åŸºå‡†â€çš„å·¦è¾¹ï¼›æ‰€æœ‰å¤§äºŽâ€åŸºå‡†â€çš„å…ƒç´ ï¼Œéƒ½ç§»åˆ°â€åŸºå‡†â€çš„å³è¾¹ã€‚è¿™ä¸ªæ“ä½œç§°ä¸ºåˆ†åŒº (partition) æ“ä½œï¼Œåˆ†åŒºæ“ä½œç»“æŸåŽï¼ŒåŸºå‡†å…ƒç´ æ‰€å¤„çš„ä½ç½®å°±æ˜¯æœ€ç»ˆæŽ’åºåŽå®ƒçš„ä½ç½®ã€‚ å¯¹â€åŸºå‡†â€å·¦è¾¹å’Œå³è¾¹çš„ä¸¤ä¸ªå­é›†ï¼Œä¸æ–­é‡å¤ç¬¬ä¸€æ­¥å’Œç¬¬äºŒæ­¥ï¼Œç›´åˆ°æ‰€æœ‰å­é›†åªå‰©ä¸‹ä¸€ä¸ªå…ƒç´ ä¸ºæ­¢ã€‚ å¿«é€ŸæŽ’åºå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸ºO(n log n),æœ€åæƒ…å†µä¸ºO(n2)ï¼Œä¸ç¨³å®šæŽ’åºã€‚ è¿™é‡Œå®žçŽ°äº†ä¸¤ç§æ–¹å¼çš„å¿«æŽ’ï¼Œç¬¬ä¸€ç§æ˜¯å•è·¯çš„ï¼Œå®žçŽ°ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415func partition(sortArray []int, left, right int) int &#123; key := sortArray[right] i := left - 1 for j := left; j &lt; right; j++ &#123; if sortArray[j] &lt;= key &#123; i++ swap(i, j) &#125; &#125; swap(i+1, right) return i + 1&#125; ç¬¬äºŒç§æ˜¯åŒè·¯çš„ï¼š 123456789101112131415161718192021222324252627unc partition2(arr []int,left,right int)(p int) &#123; if left &gt; right &#123; return &#125; i,j,pivot := left,right ,arr[left] for i&lt;j &#123; for i &lt; j &amp;&amp; arr[j] &gt;pivot &#123; j-- &#125; for i &lt; j &amp;&amp; arr[i] &lt;= pivot &#123; i++ &#125; if i &lt; j &#123; arr[i] ,arr[j] = arr[j],arr[i] &#125; &#125; arr[i],arr[left] = arr[left],arr[i] return i æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122import ("fmt")const MAX = 10var sortArray = []int&#123;41, 24, 76, 11, 45, 64, 21, 69, 19, 36&#125;func main() &#123; fmt.Println("before sortï¼š") quickSort(sortArray, 0, MAX-1) fmt.Println("after sort:")&#125;func quickSort(sortArray []int, left, right int) &#123; if left &lt; right &#123; pos := partition2(sortArray, left, right)//ä¿®æ”¹æ­¤å¤„æµ‹è¯•ä¸åŒçš„å®žçŽ°æ–¹å¼ quickSort(sortArray, left, pos-1) quickSort(sortArray, pos+1, right) &#125;&#125; BUT! è¦è¡¨è¾¾å¿«æŽ’çš„æ€æƒ³ï¼Œè¿˜æ˜¯ä½¿ç”¨Pythonæ¯”è¾ƒé€å½»ï¼š 123456789def quickSort(array): if len(array) &lt; 2: return array else: pivot = array[0] less = [i for i in array[1:] if i &lt;= pivot] greater = [i for i in array[1:] if i &gt; pivot] return quickSort(less) + [pivot] + quickSort(greater) æ˜¯ä¸æ˜¯å°†å¿«æŽ’çš„åˆ†æ²»æ€æƒ³è¡¨è¾¾åœ°æ·‹æ¼“å°½è‡´ï¼Œç®€æ´ç¾Žè§‚ã€‚ â€‹ â€‹ Endï¼]]></content>
      <categories>
        <category>æ•°æ®ç»“æž„ä¸Žç®—æ³•</category>
      </categories>
      <tags>
        <tag>go æ•°æ®ç»“æž„ä¸Žç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[gitå¦‚ä½•æ‰¾å›žè¢«åˆ é™¤çš„åˆ†æ”¯]]></title>
    <url>%2F2018%2F11%2F15%2Fgit%E5%A6%82%E4%BD%95%E6%89%BE%E5%9B%9E%E8%A2%AB%E5%88%A0%E9%99%A4%E7%9A%84%E5%88%86%E6%94%AF%2F</url>
    <content type="text"><![CDATA[åœ¨ä½¿ç”¨gitçš„è¿‡ç¨‹ä¸­ï¼Œå› ä¸ºäººä¸ºå› ç´ é€ æˆåˆ†æ”¯ï¼ˆcommit)è¢«åˆ é™¤ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ­¥éª¤è¿›è¡Œæ¢å¤ã€‚ é¦–å…ˆç”¨ä»¥ä¸‹æ­¥éª¤åˆ›å»ºä¸€ä¸ªæ–°åˆ†æ”¯ï¼Œä¿®æ”¹ä¸€äº›æ–‡ä»¶åŽåˆ é™¤ï¼Œä»¥ä¾¿è¿›è¡Œæ¢å¤ã€‚1.åˆ›å»ºåˆ†æ”¯ abc git branch abc1 2.æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨ git branch -a abc developremotes/origin-dev/develop1234 3.åˆ‡æ¢åˆ°abcåˆ†æ”¯ï¼Œéšä¾¿ä¿®æ”¹ä¸€ä¸‹ä¸œè¥¿åŽ commit åˆ‡æ¢åˆ†æ”¯git checkout abcSwitched to branch â€˜abcâ€™ åˆ›å»ºä¸€ä¸ªæ–‡ä»¶echo â€˜abcâ€™ &gt; test.txt commitgit add .git commit -m â€˜add test.txtâ€™[abc 3eac14d] add test.txt 1 file changed, 1 insertion(+) create mode 100644 test.txt12345678910111213 4.åˆ é™¤åˆ†æ”¯abc git branch -D abcDeleted branch abc (was 3eac14d).12 5.æŸ¥çœ‹åˆ†æ”¯åˆ—è¡¨ï¼Œabcåˆ†æ”¯å·²ä¸å­˜åœ¨ git branch -a developremotes/origin-dev/develop123 æ¢å¤æ­¥éª¤å¦‚ä¸‹ï¼š1.ä½¿ç”¨git log -g æ‰¾å›žä¹‹å‰æäº¤çš„commitcommit 3eac14d05bc1264cda54a7c21f04c3892f32406aReflog: HEAD@{1} (fdipzone &#102;&#x64;&#105;&#112;&#122;&#x6f;&#x6e;&#101;&#64;&#115;&#105;&#x6e;&#x61;&#46;&#x63;&#111;&#x6d;)Reflog message: commit: add test.txtAuthor: fdipzone &#102;&#x64;&#105;&#112;&#x7a;&#x6f;&#110;&#101;&#x40;&#115;&#x69;&#x6e;&#97;&#46;&#99;&#x6f;&#109;Date: Sun Jan 31 22:26:33 2016 +0800 add test.txt 123456789 2.ä½¿ç”¨git branch recover_branch[æ–°åˆ†æ”¯] commit_idå‘½ä»¤ç”¨è¿™ä¸ªcommitåˆ›å»ºä¸€ä¸ªåˆ†æ”¯git branch recover_branch_abc 3eac14d05bc1264cda54a7c21f04c3892f32406a git branch -a developrecover_branch_abcremotes/origin-dev/develop123456å¯ä»¥è§åˆ°recover_branch_abcå·²åˆ›å»º 3.åˆ‡æ¢åˆ°recover_branch_abcåˆ†æ”¯ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨git checkout recover_branch_abcSwitched to branch â€˜recover_branch_abcâ€™ ls -lttotal 8-rw-râ€“râ€“ 1 fdipzone staff 4 1 31 22:38 test.txt123456 è¿™æ ·å°±å¯ä»¥æ¢å¤è¢«è¯¯åˆ çš„åˆ†æ”¯äº†åŽŸæ–‡ï¼šhttps://blog.csdn.net/fdipzone/article/details/50616386ç‰ˆæƒå£°æ˜Žï¼šæœ¬æ–‡ä¸ºåšä¸»åŽŸåˆ›æ–‡ç« ï¼Œè½¬è½½è¯·é™„ä¸Šåšæ–‡é“¾æŽ¥ï¼]]></content>
      <categories>
        <category>git</category>
      </categories>
      <tags>
        <tag>git</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangè¯»å–å‘½ä»¤è¡Œä¼ æ¥çš„å‚æ•°]]></title>
    <url>%2F2018%2F11%2F06%2Fgolang%E8%AF%BB%E5%8F%96%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BC%A0%E6%9D%A5%E7%9A%84%E5%8F%82%E6%95%B0%2F</url>
    <content type="text"><![CDATA[Golang-ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°Golangæœ‰ä¸¤ä¸ªæ ‡å‡†åŒ…ä¸­éƒ½æœ‰èŽ·å¾—å‘½ä»¤è¡Œå‚æ•°çš„æ–¹æ³•ï¼š 12[*]os/Argså¯ä»¥ç®€å•åœ°èŽ·å¾—ä¸€ä¸ªç±»ä¼¼ï¼£è¯­è¨€ä¸­çš„argvç»“æž„[*]flagåˆ™æä¾›äº†ä¸€ä¸ªæ›´ä¸ºå¤æ‚çš„æ ‡å¿—ä¸Žå€¼çš„æ–¹æ³• os.Argsos.Argsè¿”å›žä¸€ä¸ªå­—ç¬¦ä¸²æ•°ç»„[] string. ä½¿ç”¨æ–¹æ³•å¾ˆç®€å•ï¼špackage main 12345678import ( &quot;fmt&quot; &quot;os&quot;)func main() &#123; fmt.Println(os.Args)&#125; ä½¿ç”¨å‘½ä»¤ï¼šgo run test.go arg1 arg2 å¯è§è¿”å›žäº†ä¸€ä¸ªä¸‰ä¸ªå…ƒç´ çš„æ•°ç»„ï¼Œç¬¬ï¼ä¸ªå…ƒç´ æ˜¯ç¨‹åºçš„åå­—åŒ…æ‹¬è·¯å¾„ï¼Œos.Argså°±ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œos.Argså°±æ˜¯ç¬¬äºŒä¸ªå‚æ•°ã€‚ flagåŒ…flagåŒ…æä¾›çš„åŠŸèƒ½éžå¸¸å¤æ‚ã€‚ å®ƒå°†å‘½ä»¤è¡Œå‚æ•°åˆ†ä¸ºéžæ ‡å¿—ç±»å‚æ•°(nonflag arguments)å’ŒFlagsï¼Œæ ‡å¿—å‚æ•°æ˜¯è¿™æ ·çš„-flagname=xï¼Œæ¯”å¦‚è¯´-baudrate=1200ã€‚ éžæ ‡å¿—ç±»å‚æ•°ä¸ºarg1 arg2ã€‚ flagå‚æ•°å¤„ç†æµç¨‹ç”±äºŽæ ‡å¿—ç±»å‚æ•°æ˜¯å‚æ•°çš„ä¸€éƒ¨åˆ†ï¼Œä½†åˆç‰¹æ®Šï¼Œä¸ºäº†å°†æ ‡å¿—ç±»å‚æ•°åŒºåˆ«å¤„ç† flagåŒ…æœ‰ä¸¤ç±»æ–¹æ³•ï¼Œä¸€ç±»æ˜¯flagå¤„ç†æ–¹æ³•ï¼Œå¦ä¸€ç±»æ˜¯æ­£å¸¸çš„å‚æ•°å¤„ç†æ–¹æ³•ã€‚ æ­£å¸¸çš„å‚æ•°å¤„ç†æ–¹æ³•æ­£å¸¸å‚æ•°å¤„ç†æ–¹æ³•ä¸Žos.Argså·®ä¸å¤šï¼Œè¿™é‡Œæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œflag.Args()ï¼Œè¿”å›žä¹Ÿæ˜¯[]string. 1234567891011121314package mainimport ( &quot;fmt&quot;/* &quot;os/exec&quot; &quot;bytes&quot;*/ &quot;flag&quot;)func main() &#123; flag.Parse() fmt.Println(flag.Args())&#125; go run test.go arg1 arg2 å¦‚æžœæœ‰æ ‡å¿—ç±»å‚æ•°å‘¢ï¼Ÿ 1go run test.go arg1 arg2 -baudrate=1200 è¿™é‡Œå……åˆ†è¯æ˜Žäº†æ ‡å¿—ç±»å‚æ•°ä¹Ÿæ˜¯å‚æ•°ã€‚ æ ‡å¿—ç±»å‚æ•°Parseå‰å®šä¹‰å¦‚æžœä½¿ç”¨æ ‡å¿—ç±»å‚æ•°ï¼Œè¦æå‰å®šä¹‰,å®šä¹‰ä¹‹åŽå†è°ƒç”¨Parseæ‰èƒ½è§£æžå‡ºæ¥ï¼š 12345678910111213141516package mainimport ( &quot;fmt&quot; &quot;flag&quot;)func main() &#123; baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;) databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;) flag.Parse() fmt.Println(*baudrate) fmt.Println(*databits) fmt.Println(flag.Args())&#125;go run test.go -baudrate=9600 -databits=8 arg1 arg2 æ ‡å¿—ç±»å‚æ•°å¿…é¡»åœ¨Parseä¹‹å®šä¹‰ï¼Œå¦åˆ™ä¼šå‡ºé”™ï¼š 123456789101112131415161718192021package mainimport ( &quot;fmt&quot; &quot;flag&quot;)func main() &#123; flag.Parse() baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;) databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;) fmt.Println(*baudrate) fmt.Println(*databits) fmt.Println(flag.Args())&#125;go run test.go -baudrate=9600 -databits=8 arg1 arg2flag provided but not defined: -baudrateUsage of /tmp/go-build944578075/command-line-arguments/_obj/a.out:exit status 2 flag.Intè¿”å›žçš„æ˜¯åœ°å€ éœ€è¦æ³¨æ„çš„æ˜¯è¿™é‡Œflag.Intè¿”å›žçš„å€¼ä¸ºä¸€ä¸ªåœ°å€ï¼Œä½ å¯ä»¥éšæ—¶åˆ°è¿™ä¸ªåœ°å€é‡ŒåŽ»å–å€¼ ä½†åœ¨Parseä¹‹å‰å–å€¼ï¼Œå–åˆ°çš„æ˜¯é»˜è®¤å€¼ï¼ŒParseä¹‹åŽåŽ»éšå€¼ï¼Œå–åˆ°çš„æ‰æ˜¯çœŸæ­£çš„å€¼ï¼š 1234567891011121314151617package mainimport ( &quot;fmt&quot; &quot;flag&quot;)func main() &#123; baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;) databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;) fmt.Println(*baudrate) fmt.Println(*databits) flag.Parse() fmt.Println(flag.Args())&#125;go run test.go -baudrate=9600 -databits=8 arg1 arg2 æ ‡å¿—ç±»å‚æ•°é¡ºåº æ ‡å¿—ç±»å‚æ•°ä¹‹é—´çš„å‰åŽé¡ºåºå¯ä»¥æ”¹å˜ï¼Œä½†æ˜¯ä¼¼ä¹Žæ ‡å¿—ç±»å‚æ•°éžè¦æ”¾åˆ°éžæ ‡å¿—ç±»å‚æ•°ä¹‹å‰æ‰èƒ½æ­£ç¡®è§£æžã€‚ 12345678910111213141516package mainimport ( &quot;fmt&quot; &quot;flag&quot;)func main() &#123; databits:=flag.Int(&quot;databits&quot;,10,&quot;number of data bits&quot;) baudrate:=flag.Int(&quot;baudrate&quot;,1200, &quot;help message for flagname&quot;) flag.Parse() fmt.Println(*baudrate) fmt.Println(*databits) fmt.Println(flag.Args())&#125;go run test.go -baudrate=9600 -databits=8 arg1 arg2 ä¸Šé¢çš„å‘½ä»¤æ­£ç¡®è§£æžäº†ï¼Œè°ƒæ¢äº†baudrateå’Œdatabitsçš„é¡ºåº 1go run test.go arg1 -baudrate=9600 -databits=8 arg2 ä¸Šå‰è¿™é‡Œæ²¡èƒ½æ­£ç¡®è§£æžï¼Œå¯ä»¥baudrateå’Œdatabitså¾—åˆ°çš„è¿˜æ˜¯é»˜è®¤å€¼ï¼Œè€Œéžæ ‡å¿—ç±»å‚æ•°èŽ·å–åˆ°äº†æ‰€æœ‰çš„å‚æ•°ã€‚ â€“help flag.Intçš„æœ€åŽä¸€ä¸ªå‚æ•°æ˜¯helpä¿¡æ¯ï¼š 123456go run test.go --helpUsage of /tmp/go-build327358548/command-line-arguments/_obj/a.out: -baudrate=1200: help message for flagname -databits=10: number of data bitsexit status 2 flag.Stringä¼ å…¥çš„å‚æ•°æ˜¾ç„¶ä¸èƒ½éƒ½æ˜¯æ•°å­—ï¼Œå®žé™…goè¯­è¨€æä¾›çš„ç±»åž‹éƒ½æ”¯æŒï¼Œä¸Žflag.Intç±»ä¼¼ï¼Œæ‰€æœ‰å…¶ä»–å‡½æ•°éƒ½æœ‰ï¼š 1flag.String flag.Uint flag.Float64.... flag.IntVarflag.Intè¿”å›žçš„æ˜¯æŒ‡é’ˆï¼Œç”¨èµ·æ¥å¯ä»¥æœ‰ç‚¹ä¸å¤ªå¥½ï¼Œflag.IntVarå¯èƒ½ç”¨èµ·æ¥æ›´å¥½çš„äº›ï¼š 1234var baudrate intflag.IntVar(&amp;baudrate,&quot;baudrate&quot;,1200,&quot;baudrate of serial port&quot;)flag.Parse()fmt.Println(baudrate) å½“å‰ä½ ä¸€æ ·å¯ä»¥ç”¨flag.UintVar flag.Float64Var flag.StringVar å‚æ•°ä¸ªæ•°å‚æ•°ä¸ªæ•°ä¹Ÿåˆ†ä¸ºæ ‡å¿—ç±»å‚æ•°çš„éžæ ‡å¿—ç±»å‚æ•°ï¼Œä¸¤ä¸ªæ–¹æ³•ä¸ºNArgå’ŒNFlag, 123456789101112131415161718package mainimport ( "fmt" "flag")func main() &#123; databits:=flag.Int("databits",10,"number of data bits") baudrate:=flag.Int("baudrate",1200, "help message for flagname") flag.Parse() fmt.Println(*baudrate) fmt.Println(*databits) fmt.Println(flag.Args()) fmt.Println(flag.NArg()) fmt.Println(flag.NFlag())&#125;go run test.go -baudrate=9600 -databits=8 arg1 arg2 ä»¥ä¸Šä»£ç çš„æ‰§è¡Œçš„è¿‡ç¨‹ä»¥åŠæ‰§è¡Œç»“æžœæ˜¯ï¼š ä»Žä¸Šåˆ°ä¸‹æ‰“å°å‡ºçš„å‚æ•°å«ä¹‰åˆ†åˆ«æ˜¯ï¼š 1111ï¼šæŒ‡å®šçš„æ ‡å¿—ç±»å‚æ•°baudrateï¼Œé»˜è®¤å€¼æ˜¯1200ï¼Œå¯éšæ„æ›´æ”¹ï¼› 1011ï¼š æŒ‡å®šçš„æ ‡å¿—ç±»å‚æ•°databitsï¼Œé»˜è®¤å€¼æ˜¯10ï¼Œå¯éšæ„æ›´æ”¹ï¼› [la, la]:éžæ ‡å¿—ç±»å‚æ•°ä¸ºarg1 arg2ï¼› 2ï¼šéžæ ‡å¿—ç±»å‚æ•°çš„æ•°é‡ 2ï¼šæ ‡å¿—ç±»å‚æ•°çš„æ•°é‡ â€‹ The End!]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>go</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[MySQLä½¿ç”¨group byåˆ†ç»„åŽå¯¹æ¯ç»„æ“ä½œ]]></title>
    <url>%2F2018%2F11%2F05%2FMySQL%E4%BD%BF%E7%94%A8group-by%E5%88%86%E7%BB%84%E5%90%8E%E5%AF%B9%E6%AF%8F%E7%BB%84%E6%93%8D%E4%BD%9C%2F</url>
    <content type="text"><![CDATA[group by æ“ä½œ åˆ†ç»„èƒ½å¤Ÿå°†æ•°æ®åˆ†æˆå‡ ä¸ªé€»è¾‘ç»„ï¼Œç„¶åŽå¯¹å…¶è¿›è¡Œèšé›†æ“ä½œ å‰å‡ å¤©å¼€å‘çš„æ—¶å€™é‡åˆ°è¿™æ ·çš„ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰ä¸€ä¸ªvender-costè¡¨ï¼š mysql&gt; select * from vendor-cost;+â€”â€”â€”+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€“+â€”â€”â€”â€“+â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”-+ vendor host vendor_id start_date cost +â€”â€”â€”+â€”â€”â€”â€”â€“+â€”â€”â€”â€”â€“+â€”â€”â€”â€“+â€”â€”â€”â€”+â€”â€”â€”-+â€”â€”â€”-+| Tencent | ins-m9faipc4 | 100014390 | 2018-10 | 0.015456 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | || Tencent | ins-r76jxurv | 100015923 | 2018-10 | 0.284697 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | || Tencent | ins-ramdkuqz | 100015923 | 2018-10 | 0.021175 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | || Tencent | ins-q7o1dhsa | 100014390 | 2018-10 | 0.113501 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | || Tencent | ins-5xxrgd65 | 100015923 | 2018-10 | 0.058623 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | || Tencent | ins-79g28kn6 | 100015923 | 2018-10 | 0.03808 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”- || | | | | || Tencent | ins-rw54ka4k | 100015923 | 2018-10 | 0.150595 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | || Tencent | ins-ggxrtm1v | 100015923 | 2018-10 | 0.068281 || â€”â€”- | â€”â€”â€”â€” | â€”â€”â€” | â€”â€”- | â€”â€”â€“ || | | | | |ä¸ºäº†ç»Ÿè®¡å‡ºæ¯ä¸ªvendor_idçš„costï¼Œå°±éœ€è¦ä½¿ç”¨åˆ†ç»„è¯­å¥ï¼Œå°†åŒä¸€ä¸ªvendor_idçš„costæ±‚å’Œï¼š select vendor_id, sum(cost) from vendor_cost group by vendor_id; å¾—å‡ºçš„ç»“æžœå°±æ˜¯æ¯ä¸ªvendor_idçš„æ€»costã€‚ è¿˜æœ‰ä¸€ç§group byçš„ç”¨æ³•ï¼šGROUP BY X, Yæ„æ€æ˜¯å°†æ‰€æœ‰å…·æœ‰ç›¸åŒXå­—æ®µå€¼å’ŒYå­—æ®µå€¼çš„è®°å½•æ”¾åˆ°ä¸€ä¸ªåˆ†ç»„é‡Œã€‚ ä¸¾ä¸ªæ —å­ï¼š çŽ°åœ¨æœ‰è¡¨æ ¼ Table: Subject_Selection Subject Semester AttendeeITB001 1 JohnITB001 1 BobITB001 1 MickeyITB001 2 JennyITB001 2 JamesMKB114 1 JohnMKB114 1 Erica æˆ‘ä»¬ä¸‹é¢å†æŽ¥ç€è¦æ±‚ç»Ÿè®¡å‡ºæ¯é—¨å­¦ç§‘æ¯ä¸ªå­¦æœŸæœ‰å¤šå°‘äººé€‰æ‹©ï¼Œåº”ç”¨å¦‚ä¸‹SQL 123SELECT Subject, Semester, Count(*)FROM Subject_SelectionGROUP BY Subject, Semester å¾—åˆ°çš„ç»“æžœæ˜¯ï¼š å¾—åˆ°çš„ç»“æžœæ˜¯ï¼š12345Subject Semester Count------------------------------ITB001 1 3ITB001 2 2MKB114 1 2 ä»Žè¡¨ä¸­çš„è®°å½•æˆ‘ä»¬å¯ä»¥çœ‹å‡ºè¿™ä¸ªåˆ†ç»„ç»“æžœæ˜¯æ­£ç¡®çš„æœ‰3ä¸ªå­¦ç”Ÿåœ¨ç¬¬ä¸€å­¦æœŸé€‰æ‹©äº†ITB001, 2ä¸ªå­¦ç”Ÿåœ¨ç¬¬äºŒå­¦æœŸé€‰æ‹©äº†ITB001,è¿˜æœ‰ä¸¤ä¸ªå­¦ç”Ÿåœ¨ç¬¬ä¸€å­¦æœŸé€‰æ‹©äº†MKB114, æ²¡äººåœ¨ç¬¬äºŒå­¦æœŸé€‰æ‹©MKB114ã€‚]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golang xorm æ“ä½œæŒ‡å—]]></title>
    <url>%2F2018%2F10%2F31%2Fgolang-xorm-%E6%93%8D%E4%BD%9C%E6%8C%87%E5%8D%97%2F</url>
    <content type="text"><![CDATA[https://www.kancloud.cn/xormplus/xorm/167077]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŠ€æœ¯å‘¨åˆŠä¹‹golangä¸­ä¿®æ”¹structçš„sliceçš„å€¼]]></title>
    <url>%2F2018%2F10%2F27%2F%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8Bgolang%E4%B8%AD%E4%BF%AE%E6%94%B9struct%E7%9A%84slice%E7%9A%84%E5%80%BC%2F</url>
    <content type="text"><![CDATA[å‰è¨€ å‰æ®µæ—¶é—´å†™goçš„æ—¶å€™é‡åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œéœ€è¦ä¿®æ”¹ç”±structæž„æˆçš„sliceä¸­structçš„æŸä¸ªå­—æ®µå€¼ï¼Œç±»ä¼¼äºŽä¸‹é¢çš„éœ€æ±‚ï¼š 1234567891011121314151617181920type Docker struct &#123; Ip string ID string&#125;docker1 := Docker&#123; Ip: "222", ID: "aaa", &#125; docker2 := Docker&#123; Ip: "111", ID: "bbb", &#125; var tmpDocker []Docker tmpDocker = append(tmpDocker, docker1) tmpDocker = append(tmpDocker, docker2) çŽ°åœ¨éœ€è¦ä¿®æ”¹tmpDockerä¸­ï¼ŒIpè¿™ä¸ªå­—æ®µçš„å€¼, ä½ å¯ä»¥å…ˆè‡ªå·±å°è¯•ä¿®æ”¹ä¸€ä¸‹ï¼Œç„¶åŽå†å¾€ä¸‹çœ‹ ç”±è¿™ä¸ªé—®é¢˜æˆ‘æŸ¥é˜…å¾ˆå¤šèµ„æ–™ï¼Œæˆ‘ä»¬å…ˆä»Žè¯­è¨€ä¸­ç»å…¸çš„ä¼ å€¼ã€ä¼ å¼•ç”¨è¯´èµ·æ¥ å¯¹äºŽä¸€é—¨è¯­è¨€ï¼Œæˆ‘ä»¬å…³å¿ƒä¼ é€’å‚æ•°çš„è¿‡ç¨‹ä¸­ï¼Œæ˜¯ä¼ å€¼è¿˜æ˜¯ä¼ å¼•ç”¨ï¼Œå…¶å®žå¯¹äºŽä¼ å€¼å’Œä¼ å¼•ç”¨æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤è€çš„é—®é¢˜ï¼Œåœ¨å¤§å­¦å…¥é—¨çš„æ—¶å€™ï¼Œä½ å¯èƒ½å°±æŽ¥è§¦è¿‡è¿™æ ·çš„Cè¯­è¨€ä»£ç ï¼š 12345678910111213141516171819//ä»¥ä¸‹å“ªä¸ªå‡½æ•°èƒ½å®žçŽ°äº¤æ¢ä¸¤ä¸ªæ•°ï¼Ÿ#include&lt;iostream&gt;using namespace std; void swap1(int p,int q)&#123; int temp; temp=p; p=q; q=temp;&#125; void swap2(int *p,int *q)&#123; int *temp; *temp=*p; *p=*q; *q=*temp;&#125; å…¶å®žå¯¹äºŽCè¯­è¨€æ¥è¯´ï¼Œå¹¶æ²¡æœ‰ä¼ å¼•ç”¨çš„æ¦‚å¿µï¼Œçœ‹ä¼¼ä¼ å¼•ç”¨çš„æ“æŽ§ï¼Œå®žé™…ä¸Šä¼ çš„æ˜¯æŒ‡é’ˆçš„åœ°å€ï¼Œä¹Ÿç®—æ˜¯ä¸€ç§ä¼ å€¼ï¼Œå…ˆçœ‹ä¸€ä¸‹ä¼ å€¼ï¼Œä¼ å¼•ç”¨ï¼Œä¼ æŒ‡é’ˆçš„æ¦‚å¿µï¼š ä¼ å€¼ï¼šå¯èƒ½å¾ˆå¤šäººéƒ½å¬è¯´ï¼Œä¼ å€¼æ— éžå°±æ˜¯å®žå‚æ‹·è´ä¼ é€’ç»™å½¢å‚ã€‚è¿™å¥è¯æ²¡æœ‰é”™ï¼Œä½†æ˜¯ç†è§£èµ·æ¥è¿˜æ˜¯æœ‰ç‚¹æŠ½è±¡ã€‚ä¸€å¥è¯ï¼Œä¼ å€¼å°±æ˜¯æŠŠå®žå‚èµ‹å€¼ç»™å½¢å‚ï¼Œèµ‹å€¼å®Œæ¯•åŽå®žå‚å°±å’Œå½¢å‚æ²¡æœ‰ä»»ä½•è”ç³»ï¼Œå¯¹å½¢å‚çš„ä¿®æ”¹å°±ä¸ä¼šå½±å“åˆ°å®žå‚ã€‚ ä¼ åœ°å€ï¼šä¸ºä»€ä¹ˆè¯´ä¼ åœ°å€ä¹Ÿæ˜¯ä¸€ç§ä¼ å€¼å‘¢ï¼Ÿå› ä¸ºä¼ åœ°å€æ˜¯æŠŠå®žå‚åœ°å€çš„æ‹·è´ä¼ é€’ç»™å½¢å‚ã€‚è¿˜æ˜¯ä¸€å¥è¯ï¼Œä¼ åœ°å€å°±æ˜¯æŠŠå®žå‚çš„åœ°å€å¤åˆ¶ç»™å½¢å‚ã€‚å¤åˆ¶å®Œæ¯•åŽå®žå‚çš„åœ°å€å’Œå½¢å‚çš„åœ°å€æ²¡æœ‰ä»»ä½•è”ç³»ï¼Œå¯¹å®žå‚å½¢å‚åœ°å€çš„ä¿®æ”¹ä¸ä¼šå½±å“åˆ°å®žå‚, ä½†æ˜¯å¯¹å½¢å‚åœ°å€æ‰€æŒ‡å‘å¯¹è±¡çš„ä¿®æ”¹å´ç›´æŽ¥ååº”åœ¨å®žå‚ä¸­ï¼Œå› ä¸ºå½¢å‚æŒ‡å‘çš„å¯¹è±¡å°±æ˜¯å½¢å‚çš„å¯¹è±¡ã€‚ ä¼ å¼•ç”¨ï¼šä¼ å¼•ç”¨æœ¬è´¨æ²¡æœ‰ä»»ä½•å®žå‚çš„æ‹·è´ï¼Œä¸€å¥è¯ï¼Œå°±æ˜¯è®©å¦å¤–ä¸€ä¸ªå˜é‡ä¹Ÿæ‰§è¡Œè¯¥å®žå‚ã€‚å°±æ˜¯ä¸¤ä¸ªå˜é‡æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ã€‚è¿™æ˜¯å¯¹å½¢å‚çš„ä¿®æ”¹ï¼Œå¿…ç„¶åæ˜ åˆ°å®žå‚ä¸Šã€‚ é‚£ä¹ˆå¯¹äºŽgoè¯­è¨€æ¥è¯´ï¼Œæ˜¯æ²¡æœ‰å¼•ç”¨ä¼ é€’çš„ï¼Œgoä½œä¸ºäº‘è®¡ç®—æ—¶ä»£çš„Cè¯­è¨€ï¼Œé‡‡ç”¨çš„éƒ½æ˜¯å€¼ä¼ é€’ï¼Œå³ä½¿æ˜¯æŒ‡é’ˆï¼Œä¹Ÿæ˜¯å°†æŒ‡é’ˆçš„åœ°å€å³æŒ‡é’ˆçš„æŒ‡é’ˆï¼Œæ‹·è´ä¸€ä»½ä¼ é€’ï¼Œå¯ä»¥å‚è€ƒè¿™ç¯‡åšæ–‡çš„è®²è§£ï¼šGoè¯­è¨€å‚æ•°ä¼ é€’æ˜¯ä¼ å€¼è¿˜æ˜¯ä¼ å¼•ç”¨ å›žåˆ°æ­£é¢˜ äº†è§£åŸºæœ¬çš„çŸ¥è¯†èƒŒæ™¯ä¹‹åŽï¼Œè®©æˆ‘ä»¬å›žåˆ°æ–‡ç« å¼€å¤´çš„ä»£ç ï¼Œå³è¦ä¿®æ”¹sliceä¸­structæŸå­—æ®µçš„å€¼ã€‚ 123456789101112131415161718type Docker struct &#123; Ip string ID string&#125;docker1 := Docker&#123; Ip: &quot;222&quot;, ID: &quot;aaa&quot;, &#125; docker2 := Docker&#123; Ip: &quot;111&quot;, ID: &quot;bbb&quot;, &#125; var tmpDocker []Docker tmpDocker = append(tmpDocker, docker1) tmpDocker = append(tmpDocker, docker2) å…ˆå°†æˆ‘æœ€åˆçš„ä»£ç å®žçŽ°è´´å‡ºæ¥ï¼š 12345 for _, dockerInfo := range tmpDocker &#123; dockerInfo.Ip = "192.168,.1.1"&#125;fmt.Println(tmpDocker) è®©æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿è¡Œç»“æžœï¼š å‘çŽ°structä¸­Ipå­—æ®µçš„å€¼å¹¶æ²¡æœ‰æ”¹å˜ï¼Œæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ åŽŸå› å°±æ˜¯ï¼šrangeçš„è¿‡ç¨‹ä¸­äº§ç”Ÿäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå³dockerInfoæ˜¯temDockerä¸­æ¯ä¸ªå…ƒç´ çš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥ä½ æ”¹å˜çš„åªæ˜¯å‰¯æœ¬ä¸­Ipå­—æ®µçš„å€¼ï¼Œå¹¶æ²¡æœ‰æ”¹å˜çœŸå®žçš„ã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³å‘¢? è¿™é‡Œæˆ‘æå‡ºä¸¤ç§è§£å†³çš„æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š 1234567//æ–¹æ³•1ï¼šèµ‹ç»™ä¸€ä¸ªæ–°çš„å¯¹è±¡newTmpDocker := []Docker&#123;&#125;//æ–°çš„å¯¹è±¡for _, dockerInfo := range tmpDocker &#123; dockerInfo.Ip = "192.168.1.1" newTmpDocker = append(newTmpDocker, dockerInfo)&#125;fmt.Println(newTmpDocker) å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¾“å‡ºçš„structçš„sliceä¸­æˆ‘ä»¬æƒ³è¦æ”¹å˜çš„å­—æ®µå·²ç»ä¿®æ”¹æˆåŠŸã€‚ ç¬¬äºŒç§æ–¹æ³•æ˜¯å°†å‰¯æœ¬ä¿®æ”¹åŽèµ‹å€¼ 123456æ–¹æ³•2ï¼šä¿®æ”¹å‰¯æœ¬åŽï¼Œå°†å‰¯æœ¬èµ‹å€¼ç»™åŽŸæ¥çš„for i, dockerInfo := range tmpDocker&#123; dockerInfo.Ip = "192.168.1.1" tmpDocker[i] = dockerInfo&#125;fmt.Println(tmpDocker) è¿è¡Œç»“æžœï¼š å¯ä»¥çœ‹åˆ°åŒæ ·ä¿®æ”¹æˆåŠŸã€‚ æ€»ç»“ï¼Œåœ¨goä¸­ï¼Œæ‰€æœ‰ä¼ å‚éƒ½æ˜¯ä¼ å€¼ï¼Œéƒ½æ˜¯ä¸€ä¸ªå‰¯æœ¬ï¼Œå³ä¸€ä¸ªæ‹·è´ï¼Œå› ä¸ºæ‹·è´çš„å†…å®¹æœ‰æ—¶å€™æ˜¯éžå¼•ç”¨ç±»åž‹ï¼ˆintã€stringã€structç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±åœ¨å‡½æ•°ä¸­å°±æ— æ³•ä¿®æ”¹åŽŸå†…å®¹æ•°æ®ï¼›æœ‰çš„æ˜¯å¼•ç”¨ç±»åž‹ï¼ˆæŒ‡é’ˆã€mapã€sliceã€chanç­‰è¿™äº›ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥ä¿®æ”¹åŽŸå†…å®¹æ•°æ®ã€‚æ˜¯å¦å¯ä»¥ä¿®æ”¹åŽŸå†…å®¹æ•°æ®ï¼Œå’Œä¼ å€¼ã€ä¼ å¼•ç”¨æ²¡æœ‰å¿…ç„¶çš„å…³ç³»ã€‚åœ¨C++ä¸­ï¼Œä¼ å¼•ç”¨è‚¯å®šæ˜¯å¯ä»¥ä¿®æ”¹åŽŸå†…å®¹æ•°æ®çš„ï¼Œåœ¨Goè¯­è¨€é‡Œï¼Œè™½ç„¶åªæœ‰ä¼ å€¼ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹åŽŸå†…å®¹æ•°æ®ï¼Œå› ä¸ºå‚æ•°æ˜¯å¼•ç”¨ç±»åž‹ã€‚ è¿™é‡Œä¹Ÿè¦è®°ä½ï¼Œå¼•ç”¨ç±»åž‹å’Œä¼ å¼•ç”¨æ˜¯ä¸¤ä¸ªæ¦‚å¿µã€‚ å†è®°ä½ï¼ŒGoé‡Œåªæœ‰ä¼ å€¼ï¼ˆå€¼ä¼ é€’ï¼‰ã€‚]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>æŠ€æœ¯å‘¨åˆŠ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangä¸­string,rune,byteçš„å…³ç³»]]></title>
    <url>%2F2018%2F10%2F25%2Fgolang%E4%B8%ADstring-rune-byte%E7%9A%84%E5%85%B3%E7%B3%BB%2F</url>
    <content type="text"><![CDATA[golangä¸­Stringçš„åº•å±‚æ˜¯ä½¿ç”¨byte[]æ•°ç»„å­˜å‚¨çš„ï¼Œä¸å¯æ”¹å˜ 12str := "Golang æµ‹è¯•"fmt.Println(len(str)) è¿™æ®µä»£ç æŒ‰é“ç†åº”è¯¥è¾“å‡º6+1+2. å®žé™…è¿è¡Œä¹‹åŽè¾“å‡ºå´æ˜¯13ï¼Œ åŽŸå› æ˜¯ä¸­æ–‡å­—ç¬¦åœ¨utf-8ç¼–ç çš„ç³»ç»Ÿä¸­æ˜¯3ä¸ªå­—èŠ‚å­˜å‚¨çš„ï¼Œåœ¨Unicodeä¸­æ˜¯2ä¸ªå­—èŠ‚å­˜å‚¨çš„ï¼Œgoçš„é»˜è®¤ç¼–ç æ ¼å¼æ˜¯utf-8ï¼Œsoã€‚ã€‚ è¿™æ—¶å€™ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸‹æ ‡è®¿é—®å­—ç¬¦ä¸²ä¸­çš„ä¸­æ–‡å­—ç¬¦æ˜¯ä¸è¡Œçš„ï¼Œæƒ³è¦ä½¿ç”¨ä¸‹æ ‡è®¿é—®ï¼Œå°±éœ€è¦runeå‡ºé©¬ã€‚ åœ¨å®˜æ–¹æ–‡æ¡£ä¸­ï¼Œruneçš„å®šä¹‰æ˜¯ï¼š 123456 rune is an alias for int32 and is equivalent to int32 in all ways. It is used, by convention, to distinguish character values from integer values.int32çš„åˆ«åï¼Œå‡ ä¹Žåœ¨æ‰€æœ‰æ–¹é¢ç­‰åŒäºŽint32å®ƒç”¨æ¥åŒºåˆ†å­—ç¬¦å€¼å’Œæ•´æ•°å€¼type rune int32 é‚£ä¹ˆæˆ‘ä»¬æƒ³è¦å¾—åˆ°é¢„æœŸå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå°±è¦ä½¿ç”¨runeåˆ‡ç‰‡æ¥å®žçŽ°ã€‚ 1fmt.Println("rune:", len([]rune(str))) å°±ä¼šè¾“å‡ºé¢„æœŸçš„rune: 9. è¿™æ—¶æˆ‘ä»¬ä¹Ÿå¯ä»¥æŒ‰ç…§ä¸‹æ ‡åŽ»è®¿é—®strä¸­çš„å­—ç¬¦äº†ã€‚å³[7]rune(str) = â€œæµ‹â€ã€‚ 3.æ€»ç»“ stringçš„åº•å±‚æ˜¯byteï¼Œbyteä¸Žruneçš„ä¸åŒä¹‹å¤„æ˜¯ï¼š byte ç­‰åŒäºŽint8ï¼Œå¸¸ç”¨æ¥å¤„ç†asciiå­—ç¬¦rune ç­‰åŒäºŽint32,å¸¸ç”¨æ¥å¤„ç†unicodeæˆ–utf-8å­—ç¬¦ æˆ–è€…å¯ä»¥è¿™æ ·è¯´ï¼š rune èƒ½æ“ä½œä»»ä½•å­—ç¬¦byte ä¸æ”¯æŒä¸­æ–‡çš„æ“ä½œ â€‹ END]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[ä¸Šæµ·QConä¹‹Goä¸“å®¶David Cheneyå…³äºŽGOæœ€ä½³å®žè·µçš„æ¼”è®²]]></title>
    <url>%2F2018%2F10%2F21%2F%E4%B8%8A%E6%B5%B7QCon%E4%B9%8BGo%E4%B8%93%E5%AE%B6David-Cheney%E5%85%B3%E4%BA%8EGO%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E7%9A%84%E6%BC%94%E8%AE%B2%2F</url>
    <content type="text"><![CDATA[æœ¬å‘¨å…­æœ‰å¹¸å‚åŠ äº†2018QConä¸Šæµ·çš„ä¼šè®®ï¼Œå¬äº†Davidå…³äºŽGOæœ€ä½³å®žè·µçš„ä¸€äº›å»ºè®®ï¼Œä¸‹é¢è´´å‡ºçš„å°±æ˜¯Davidçš„æ¼”è®²ç¨¿ï¼Œå†…å®¹ç›¸å¯¹æ¥è¯´æ¯”è¾ƒåŸºç¡€ï¼Œä½†æ˜¯åˆæ˜¯ç¼–ç¨‹ä¸­ä¸å¯é¿å…çš„ä¸€äº›é—®é¢˜ï¼Œå¸Œæœ›å¯ä»¥ç»™å¤§å®¶å¸¦æ¥ä¸€äº›å¯å‘ã€‚ Table of Contents Introduction \1. Guiding principles 1.1. Simplicity 1.2. Readability 1.3. Productivity \2. Identiers 2.1. Choose identiers for clarity, not brevity 2.2. Identier length 2.3. Donâ€™t name your variables for their types 2.4. Use a consistent naming style 2.5. Use a consistent declaration style 2.6. Be a team player \3. Comments 3.1. Comments on variables and constants should describe their contents not their purpose 3.2. Always document public symbols \4. Package Design 4.1. A good package starts with its name 4.2. Avoid package names like base , common , or util 4.3. Return early rather than nesting deeply 4.4. Make the zero value useful 4.5. Avoid package level state \5. Project Structure 5.1. Consider fewer, larger packages 5.2. Keep package main small as small as possible \6. API Design 6.1. Design APIs that are hard to misuse. 6.2. Design APIs for their default use case 6.3. Let functions dene the behaviour they requires \7. Error handling 7.1. Eliminate error handling by eliminating errors 7.2. Only handle an error once \8. Concurrency 8.1. Keep yourself busy or do the work yourself 8.2. Leave concurrency to the caller 8.3. Never start a goroutine without when it will stop. Introduction Hello, My goal over the next two sessions is to give you my advice for best practices writing Go code. https://dave.cheney.net/practical-go/presentations/qcon-china.html 1/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs This is a workshop style presentation, Iâ€™m going to dispense with the usual slide deck and weâ€™ll work directly from the document which you can take away with you today. TIP You can find the latest version of this presentation at https://dave.cheney.net/practical-go/presentations/qcon-china.html \1. Guiding principles If Iâ€™m going to talk about best practices in any programming language I need some way to define what I mean by best. If you came to my keynote yesterday you would have seen this quote from the Go team lead, Russ Cox: â€œSoftware engineering is what happens to programming when you add time and other programmers. â€” Russ Cox Russ is making the distinction between software programming and software engineering. The former is a program you write for yourself. The latter is a product that many people will work on over time. Engineers will come and go, teams will grow and shrink over time, requirements will change, features will be added and bugs fixed. This is the nature of software engineering. Iâ€™m possibly one of the earliest users of Go in this room, but to argue that my seniority gives my views more weight is false. Instead, the advice Iâ€™m going to present today is informed by what I believe to be the guiding principles underlying Go itself. They are: \1. Simplicity \2. Readability 3. Productivity NOTE Youâ€™ll note that I didnâ€™t say performance, or concurrency. There are languages which are a bit faster than Go, but theyâ€™re certainly not as simple as Go. There are languages which make concurrency their highest goal, but they are not as readable, nor as productive. Performance and concurrency are important attributes, but not as important as simplicity, readability, and productivity. 1.1. Simplicity Why should we strive for simplicity? Why is important that Go programs be simple? Weâ€™ve all been in a situation where you say â€œI canâ€™t understand this codeâ€, yes? Weâ€™ve all worked on programs where youâ€™re scared to make a change because youâ€™re worried itâ€™ll break another part of the program; a part you donâ€™t understand and donâ€™t know how to fix. This is complexity. Complexity turns reliable software in unreliable software. Complexity is what kills software projects. Simplicity is the highest goal of Go. Whatever programs we write, we should be able to agree that they are simple. 1.2. Readability â€œhttps://dave.cheney.net/practical-go/presentations/qcon-china.html 2/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs â€œReadability is essential for maintainability. â€” Mark Reinhold JVM language summit 2018 Why is it important that Go code be readable? Why should we strive for readability? â€œPrograms must be written for people to read, and only incidentally for machines to execute. â€” Hal Abelson and Gerald Sussman Structure and Interpretation of Computer Programs Readability is important because all software, not just Go programs, is written by humans to be read by other humans. The fact that software is also consumed by machines is secondary. Code is read many more times than it is written. A single piece of code will, over its lifetime, be read hundreds, maybe thousands of times. â€œThe most important skill for a programmer is the ability to effectively communicate ideas. â€” GastoÌn Jorquera [1] Readability is key to being able to understand what the program is doing. If you canâ€™t understand what a program is doing, how can you hope to maintain it? If software cannot be maintained, then it will be rewritten; and that could be the last time your company will invest in Go. If youâ€™re writing a program for yourself, maybe it only has to run once, or youâ€™re the only person whoâ€™ll ever see it, then do what ever works for you. But if this is a piece of software that more than one person will contribute to, or that will be used by people over a long enough time that requirements, features, or the environment it runs in changes, then your goal must be for your program to be maintainable. The first step towards writing maintainable code is making sure the code is readable. â€œ1.3. Productivity Design is the art of arranging code to work today, and be changeable forever. â€” Sandi Metz The last underlying principle I want to highlight is productivity. Developer productivity is a sprawling topic but it boils down to this; how much time do you spend doing useful work verses waiting for your tools or hopelessly lost in a foreign code-base. Go programmers should feel that they can get a lot done with Go. The joke goes that Go was designed while waiting for a C++ program to compile. Fast compilation is a key feature of Go and a key recruiting tool to attract new developers. While compilation speed remains a constant battleground, it is fair to say that compilations which take minutes in other languages, take seconds in Go. This helps Go developers feel as productive as their counterparts working in dynamic languages without the reliability issues inherent in those languages. More fundamental to the question of developer productivity, Go programmers realise that code is written to be read and so place the act of reading code above the act of writing it. Go goes so far as to enforce, via tooling and custom, that all code be formatted in a specific style. This removes the friction of learning a project specific dialect and helps spot mistakes because they just look incorrect. Go programmers donâ€™t spend days debugging inscrutable compile errors. They donâ€™t waste days with complicated build scripts or deploying code to production. And most importantly they donâ€™t spend their time trying to understand what their coworker wrote. https://dave.cheney.net/practical-go/presentations/qcon-china.html 3/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Productivity is what the Go team talk about when they say the language must scale. 2. Identiers The first topic weâ€™re going to discuss is identifiers. An identifier is a fancy word for a name; the name of a variable, the name of a function, the name of a method, the name of a type, the name of a package, and so on. â€œPoor naming is symptomatic of poor design. â€” Dave Cheney Given the limited syntax of Go, the names we choose for things in our programs have an oversized impact on the readability of our programs. Readability is the defining quality of good code thus choosing good names is crucial to the readability of Go code. â€œ2.1. Choose identiers for clarity, not brevity Obvious code is important. What you can do in one line you should do in three. â€” Ukiah Smith Go is not a language that optimises for clever one liners. Go is not a language which optimises for the least number of lines in a program. Weâ€™re not optimising for the size of the source code on disk, nor how long it takes to type. â€œGood naming is like a good joke. If you have to explain it, itâ€™s not funny. â€” Dave Cheney Key to this clarity is the names we choose for identifies in Go programs. Letâ€™s talk about the qualities of a good name: A good name is concise. A good name need not be the shortest it can possibly be, but a good name should waste no space on things which are extraneous. Good names have a high signal to noise ratio. A good name is descriptive. A good name should describe the application of a variable or constant, not their contents. A good name should describe the result of a function, or behaviour of a method, not their operation. A good name should describe the purpose of a package, not its contents. The more accurately a name describes the thing it identifies, the better the name. A good name is should be predictable. You should be able to infer the way a name will be used from its name alone. This is a function of choosing descriptive names, but it also about following tradition. This is what Go programmers talk about when they say idiomatic. Letâ€™s talk about each of these properties in depth. 2.2. Identier length Sometimes people criticise the Go style for recommending short variable names. As Rob Pike said, â€œGo programmers want the right length identifiersâ€. [1] Andrew Gerrand suggests that by using longer identifies for some things we indicate to the reader that they are of higher importance. â€œThe greater the distance between a nameâ€™s declaration and its uses, the longer the name should be. â€” Andrew Gerrand [2] From this we can draw some guidelines: https://dave.cheney.net/practical-go/presentations/qcon-china.html 4/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Short variable names work well when the distance between their declaration and last use is short. Long variable names need to justify themselves; the longer they are the more value they need to provide. Lengthy bureaucratic names carry a low amount of signal compared to their weight on the page. Donâ€™t include the name of your type in the name of your variable. Constants should describe the value they hold, not how that value is used. Single letter variables for loops and branches, single words for parameters and return values, multiple words for functions and package level declarations Single words for methods, interfaces, and packages. Remember that the name of a package is part of the name the caller uses to to refer to it, so make use of that. Letâ€™s look at an example to 12type Person struct &#123; Name string Age int } 1234// AverageAge returns the average age of people.func AverageAge(people []Person) int &#123; if len(people) == 0 &#123; return 0 } 12var count, sum intfor _, p := range people &#123; sum += p.Age count += 1 } 12 return sum / count&#125; GO In this example, the range variable p is declared on line 10 and only referenced on the following line. p lives for a very short time both on the page, and during the execution of the function. A reader who is interested in the effect values of p have on the program need only read two lines. By comparison people is declared in the function parameters and lives for seven lines. The same is true for sum , and count , thus they justify their longer names. The reader has to scan a wider number of lines to locate them so they are given more distinctive names. I could have chosen s for sum and c (or possibly n ) for but this would have reduced all the variables in the program to the same level of importance. I could have chosen instead of but that would have left the problem of what to call the for â€¦ range iteration variable. The singular would look odd as the loop iteration variable which lives for little time has a longer name than the slice of values it was derived from. count TIP Use blank lines to break up the flow of a function in the same way you use paragraphs to break up the flow of a document. In AverageAge we have three operations occurring in sequence. The first is the precondition, checking that we donâ€™t divide by zero if people is empty, the second is the accumulation of the sum and count, and the final is the computation of the average. 2.2.1. Context is key https://dave.cheney.net/practical-go/presentations/qcon-china.html 5/45 p people person 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Itâ€™s important to recognise that most advice on naming is contextual. I like to say it is a principle, not a rule. What is the difference between two identifiers, i , and index . We cannot say conclusively that one is better than another, for example is fundamentally more readable than I argue it is not, because it is likely the scope of i , and index for that matter, is limited to the body of the for loop and the extra verbosity of the latter adds little to comprehension of the program. However, which of these functions is more readable? 1func (s *SNMP) Fetch(oid []int, index int) (int, error) or 1func (s *SNMP) Fetch(o []int, i int) (int, error) In this example, oid is an abbreviation for SNMP Object ID, so shortening it to o would mean programmers have to translate from the common notation that they read in documentation to the shorter notation in your code. Similarly, reducing index to i obscures what i stands for as in SNMP messages a sub value of each OID is called an Index. TIP Donâ€™t mix and match long and short formal parameters in the same declaration. 2.3. Donâ€™t name your variables for their types You shouldnâ€™t name your variables after their types for the same reason you donâ€™t name your pets â€œdogâ€ and â€œcatâ€. You also probably shouldnâ€™t include the name of your type in the name of your variableâ€™s name for the same reason. The name of the variable should describe its contents, not the type of the contents. Consider this example: var usersMap map[string]*User Whatâ€™s good about this declaration? We can see that its a map, and it has something to do with the *User type, thatâ€™s probably good. But usersMap is a map, and Go being a statically typed language wonâ€™t let us accidentally use it where a scalar variable is required, so the Map suffix is redundant. Now, consider what happens if we were to declare other variables like: 12for index := 0; index &lt; len(s); index++ &#123; // } 12for i := 0; i &lt; len(s); i++ &#123; // } https://dave.cheney.net/practical-go/presentations/qcon-china.html 6/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs 123var ( companiesMap map[string]*Company productsMap map[string]*Products ) Now we have three map type variables in scope, usersMap , companiesMap , and productsMap , all mapping strings to different types. We know they are maps, and we also know that their map declarations prevent us from using one in place of anotherâ€”the compiler will throw an error if we try to use companiesMap where the code is expecting a map[string]*User . In this situation itâ€™s clear that the Map suffix does not improve the clarity of the code, its just extra boilerplate to type. My suggestion is to avoid any suffix that resembles the type of the variable. TIP If users isnâ€™t descriptive enough, then usersMap wonâ€™t be either. This advice also applies to function parameters. For example: Naming the Config parameter config is redundant. We know its a Config , it says so right there. In this case consider conf or maybe c will do if the lifetime of the variable is short enough. If there is more that one in scope at any one time then calling them conf1 and conf2 is less descriptive than calling them and as the latter are less likely to be mistaken for one another. 1234type Config struct &#123; //&#125;func WriteConfig(w io.Writer, config *Config) *Config original updated Donâ€™t let package names steal good variable names. The name of an imported identifier includes its package name. For example the context package will be known as context.Context . This makes it impossible to use a variable or type in your package. type in the as func WriteLog(context context.Context, message string) Will not compile. This is why the local declaration for context.Context types is traditionally ctx . eg. func WriteLog(ctx context.Context, message string) 2.4. Use a consistent naming style Another property of a good name is it should be predictable. The reader should be able to understand the use of a name when they encounter it for the first time. When they encounter a common name, they should be able to assume it has not changed meanings since the last time they saw it. NOTE https://dave.cheney.net/practical-go/presentations/qcon-china.html 7/45 Context context 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs For example, if your code passes around a database handle, make sure each time the parameter appears, it has the same name. Rather than a combination of d sql.DB , dbase sql.DB , DB sql.DB , and database sql.DB , instead consolidate on something like; db sql.DB Doing so promotes familiarity; if you see a db , you know itâ€™s a sql.DB and that it has either been declared locally or provided for you by the caller. Similarly for method receivers; use the same receiver name every method on that type. This makes it easier for the reader to internalise the use of the receiver across the methods in this type. The convention for short receiver names in Go is at odds with the advice provided so far. This is just NOTE one of the choices made early on that has become the preferred style, just like the use of CamelCase TIP rather than snake_case . Go style dictates that receivers have a single letter name, or acronyms derived from their type. You may find that the name of your receiver sometimes conflicts with name of a parameter in a method. In this case, consider making the parameter name slightly longer, and donâ€™t forget to use this new parameter name consistently. Finally, certain single letter variables have traditionally been associated with loops and counting. For example, i , j , and k are commonly the loop induction variable for simple for loops. n is commonly associated with a counter or accumulator. v is a common shorthand for a value in a generic encoding function, k is commonly used for the key of a map, and s is often used as shorthand for parameters of type string . As with the db example above programmers expect to be a loop induction variable. If you ensure that is always a loop variable, not used in other contexts outside a loop. When readers encounter a variable called , or j , they know that a loop is close by. i i for i TIP If you found yourself with so many nested loops that you exhaust your supply of i , j , and k variables, its probably time to break your function into smaller units. 2.5. Use a consistent declaration style Go has at least six different ways to declare a variable varxint=1 varx=1 varxint;x=1 var x = int(1) x:=1 Iâ€™m sure there are more that I havenâ€™t thought of. This is something that Goâ€™s designers recognise was probably a mistake, but its too late to change it now. With all these different ways of declaring a variable, how do we avoid each Go programmer choosing their own style? I want to present a suggestions for how I declare variables in my programs. This is the style I try to use where possible. https://dave.cheney.net/practical-go/presentations/qcon-china.html 8/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs When declaring, but not initialising, a variable, use var . When declaring a variable that will be explicitly initialised later in the function, use the var keyword. The var acts as a clue to say that this variable has been deliberately declared as the zero value of the indicated type. This is also consistent with the requirement to declare variables at the package level using var as opposed to the short declaration syntaxâ€”although Iâ€™ll argue later that you shouldnâ€™t be using package level variables at all. When declaring and initialising, use := . When declaring and initialising the variable at the same time, that is to say weâ€™re not letting the variable be implicitly initialised to its zero value, I recommend using the short variable declaration form. This makes it clear to the reader that the variable on the left hand side of the := is being deliberately initialised. To explain why, Letâ€™s look at the previous example, but this time deliberately initialising each variable: In the first and third examples, because in Go there are no automatic conversions from one type to another; the type on the left hand side of the assignment operator must be identical to the type on the right hand side. The compiler can infer the type of the variable being declared from the type on the right hand side, to the example can be written more concisely like this: This leaves us with explicitly initialising players to 0 which is redundant because 0 is `playersâ€™ zero value. So its better to make it clear that weâ€™re going to use the zero value by instead writing 1var players int What about the second statement? We cannot elide the type and write var things = nil Because nil does not have a type. [2] Instead we have a choice, do we want the zero value for a slice? 123456789101112var players int // 0var things []Thing // an empty slice of Thingsvar thing Thing // empty Thing structjson.Unmarshall(reader, &amp;thing)var players int = 0var things []Thing = nilvar thing *Thing = new(Thing)json.Unmarshall(reader, thing)var players = 0var things []Thing = nilvar thing = new(Thing)json.Unmarshall(reader, thing) https://dave.cheney.net/practical-go/presentations/qcon-china.html 9/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs 1var things []Thing or do we want to create a slice with zero elements? 1var things = make([]Thing, 0) If we wanted the latter then this is not the zero value for a slice so we should make it clear to the reader that weâ€™re making this choice by using the short declaration form: things := make([]Thing, 0) Which tells the reader that we have chosen to initialise things explicitly. This brings us to the third declaration, var thing = new(Thing) Which is both explicitly initialising a variable and introduces the uncommon use of the new keyword which some Go programmer dislike. If we apply our short declaration syntax recommendation then the statement becomes thing := new(Thing) Which makes it clear that thing is explicitly initialised to the result of new(Thing) â€“a pointer to a Thing â€“but still leaves us with the unusual use of new . We could address this by using the compact literal struct initialiser form, thing := &amp;Thing{} Which does the same as means weâ€™re explicitly initialising , hence why some Go programmers are upset by the duplication. However this with a pointer to a Thing{} , which is the zero value for a Thing . new(Thing) thing Instead we should recognise that is being declared as its zero value and use the address of operator to pass the address of thing to thing 123json.Unmarshallvar thing Thingjson.Unmarshall(reader, &amp;thing) https://dave.cheney.net/practical-go/presentations/qcon-china.html 10/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs NOTE Of course, with any rule of thumb, there are exceptions. For example, sometimes two variables are closely related so writing Would be odd. The declaration may be more readable like this min, max := 0, 1000 12var min intmax := 1000 In summary: When declaring a variable without initialisation, use the var syntax. When declaring and explicitly initialising a variable, use := . Make tricky declarations obvious. When something is complicated, it should look complicated. var length uint32 = 0x80 Here length may be being used with a library which requires a specific numeric type and is more TIP explicit that length is being explicitly chosen to be uint32 than the short declaration form: length := uint32(0x80) In the first example Iâ€™m deliberately breaking my rule of using the var declaration form with an explicit initialiser. This decision to vary from my usual form is a clue to the reader that something unusual is happening. 2.6. Be a team player I talked about a goal of software engineering to produce readable, maintainable, code. Therefore you will likely spend most of your career working on projects of which you are not the sole author. My advice in this situation is to follow the local style. Changing styles in the middle of a file is jarring. Uniformity, even if its not your preferred approach, is more valuable for maintenance than your personal preference. My rule of thumb is; if it fits through gofmt then its usually not worth holding up a code review for. If you want to do a renaming across a code-base, do not mix this into another change. If someone is TIP using git bisect they donâ€™t want to wade through thousands of lines of renaming to find the code you changed as well. \3. Comments Before we move on to larger items I want to spend a few minutes talking about comments. â€œhttps://dave.cheney.net/practical-go/presentations/qcon-china.html 11/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs â€œGood code has lots of comments, bad code requires lots of comments. â€” Dave Thomas and Andrew Hunt The Pragmatic Programmer Comments are very important to the readability of a Go program. A comments should do one of three things: \1. The comment should explain what the thing does. \2. The comment should explain how the thing does what it does. 3. The comment should explain why the thing is why it is. The first form is ideal for commentary on public symbols: The second form is ideal for commentary inside a method: The third form, the why , is unique as it does not displace the first two, but at the same time itâ€™s not a replacement for the what, or the how. The why style of commentary exists to explain the external factors that drove the code you read on the page. Frequently those factors rarely make sense taken out of context, the comment exists to provide that context. In this example it may not be immediately clear what the effect of setting HealthyPanicThreshold to zero percent will do. The comment is needed to clarify that the value of 0 will disable the panic threshold behaviour. 3.1. Comments on variables and constants should describe their contents not their purpose I talked earlier that the name of a variable, or a constant, should describe its purpose. When you add a comment to a variable or constant, that comment should describe the variables contents, not the variables purpose. 1const randomNumber = 6 // determined from an unbiased die In this example the comment describes why is assigned the value six, and where the six was derived from. The comment does not describe where will be used. Here are some more examples: 12345// Open opens the named file for reading.// If successful, methods on the returned file can be used for reading.// queue all dependant actionsvar results []chan errorfor _, dep := range a.Deps &#123; } 12345results = append(results, execute(seen, dep))return &amp;v2.Cluster_CommonLbConfig&#123; // Disable HealthyPanicThreshold HealthyPanicThreshold: &amp;envoy_type.Percent&#123; Value: 0, }, } https://dave.cheney.net/practical-go/presentations/qcon-china.html 12/45 12randomNumberrandomNumber 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs 12345const ( StatusContinue = 100 // RFC 7231, 6.2.1 StatusSwitchingProtocols = 101 // RFC 7231, 6.2.2 StatusProcessing = 102 // RFC 2518, 10.1 StatusOK = 200 // RFC 7231, 6.3.1 In the context of HTTP the number 100 is known as StatusContinue , as defined in RFC 7231, section 6.2.1. For variables without an initial value, the comment should describe who is responsible for // sizeCalculationDisabled indicates whether it is safe // to calculate Typesâ€™ widths and alignments. See dowidth. var sizeCalculationDisabled bool TIP initialising this variable. Here the comment lets the reader know that the dowidth function is responsible for maintaining the state of sizeCalculationDisabled . Hiding in plain sight This is a tip from Kate Gregory. [3] Sometimes youâ€™ll find a better name for a variable hiding in a comment. The comment was added by the author because registry doesnâ€™t explain enough about its purpose â€”itâ€™s a registry, but a registry of what? By renaming the variable to sqlDrivers its now clear that the purpose of this variable is to hold SQL drivers. var sqlDrivers = make(map[string]*sql.Driver) Now the comment is redundant and can be removed. // registry of SQL drivers var registry = make(map[string]*sql.Driver) TIP 3.2. Always document public symbols Because godoc is the documentation for your package, you should always add a comment for every public symbolâ€” variable, constant, function, and methodâ€”declared in your package. Here are two rules from the Google Style guide Any public function that is not both obvious and short must be commented. Any function in a library must be commented regardless of length or complexity https://dave.cheney.net/practical-go/presentations/qcon-china.html 13/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs 123456package ioutil// ReadAll reads from r until an error or EOF and returns the data it read.// A successful call returns err == nil, not err == EOF. Because ReadAll is// defined to read from src until EOF, it does not treat an EOF from Read// as an error to be reported.func ReadAll(r io.Reader) ([]byte, error) There is one exception to this rule; you donâ€™t need to document methods that implement an interface. Specifically donâ€™t do this: This comment says nothing. It doesnâ€™t tell you what the method does, in fact itâ€™s worse, it tells you to go look somewhere else for the documentation. In this situation I suggest removing the comment entirely. Here is an example from the io package 123456789101112131415161718192021222324// Read implements the io.Reader interfacefunc (r *FileReader) Read(buf []byte) (int, error)// LimitReader returns a Reader that reads from r// but stops with EOF after n bytes.// The underlying implementation is a *LimitedReader.func LimitReader(r Reader, n int64) Reader &#123; return &amp;LimitedReader&#123;r, n&#125; &#125;// A LimitedReader reads from R but limits the amount of// data returned to just N bytes. Each call to Read// updates N to reflect the new amount remaining.// Read returns EOF when N &lt;= 0 or when the underlying R returns EOF.type LimitedReader struct &#123; R Reader // underlying reader N int64 // max bytes remaining&#125;func (l *LimitedReader) Read(p []byte) (n int, err error) &#123; if l.N &lt;= 0 &#123; return 0, EOF &#125; if int64(len(p)) &gt; l.N &#123; p = p[0:l.N] &#125; n, err = l.R.Read(p) l.N -= int64(n) return } Note that the declaration is directly preceded by the function that uses it, and the declaration of follows the declaration of LimitedReader itself. Even though LimitedReader.Read has no documentation itself, its clear from that it is an implementation of io.Reader . 12LimitedReaderLimitedReader.Read TIP Before you write the function, write the comment describing the function. If you find it hard to write the comment, then itâ€™s a sign that the code youâ€™re about to write is going to be hard to understand. 3.2.1. Donâ€™t comment bad code, rewrite it â€œhttps://dave.cheney.net/practical-go/presentations/qcon-china.html 14/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs â€œ Donâ€™t comment bad code â€” rewrite it â€” Brian Kernighan Comments highlighting the grossness of a particular piece of code are not sufficient. If you encounter one of these comments, you should raise an issue as a reminder to refactor it later. It is okay to live with technical debt, as long as the amount of debt is known. The tradition in the standard library is to annotate a TODO style comment with the username of the person who noticed it. 1// TODO(dfc) this is O(N^2), find a faster way to do this. The username is not a promise that that person has committed to fixing the issue, but they may be the best person to ask when the time comes to address it. Other projects annotate TODOs with a date or an issue number. â€œ3.2.2. Rather than commenting a block of code, refactor it Good code is its own best documentation. As youâ€™re about to add a comment, ask yourself, â€˜How can I improve the code so that this comment isnâ€™t needed?â€™ Improve the code and then document it to make it even clearer. â€” Steve McConnell Functions should do one thing only. If you find yourself commenting a piece of code because it is unrelated to the rest of the function, consider extracting it into a function of its own. In addition to be easier to comprehend, smaller functions are easier to test in isolation, and now youâ€™ve isolated the orthogonal code into its own function, its name may be all the documentation required. â€œ4. Package Design Write shy code - modules that donâ€™t reveal anything unnecessary to other modules and that donâ€™t rely on other modulesâ€™ implementations. â€” Dave Thomas Each Go package is in effect itâ€™s own small Go program. Just as the implementation of a function or method is unimportant to the caller, the implementation of the functions and methods and types that make your packageâ€™s public APIâ€”its behaviourâ€”is unimportant for the caller. A good Go package should strive to have a low degree of source level coupling such that, as the project grows, changes to one package do not cascade across the code-base. These stop-the-world refactorings place a hard limit on the rate of change in a code base and thus the productivity of the members working in that code-base. In this section weâ€™ll talk about designing a package including the packageâ€™s name, naming types, and tips for writing methods and functions. 4.1. A good package starts with its name Writing a good Go package starts with the packageâ€™s name. Think of your packageâ€™s name as an elevator pitch to describe what it does using just one word. https://dave.cheney.net/practical-go/presentations/qcon-china.html 15/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Just as I talked about names for variables in the previous section, the name of a package is very important. The rule of thumb I follow is not, â€œwhat types should I put in this package?â€. Instead the question I ask â€œwhat does service does package provide?â€ Normally the answer to that question is not â€œthis package provides the X typeâ€, but â€œthis package letâ€™s you speak HTTPâ€. TIP Name your package after what is provides, not what it contains. 4.1.1. Good package names should be unique. Within your project, each package name should be unique. This advice is pretty easy to follow if the advice that a packageâ€™s name should derive from its purposeâ€”if you find you have two packages which need the same name, it is likely either; a. The name of the package is too generic. b. The package overlaps another package of a similar name. In this case either you should review your design, or consider merging the packages. 4.2. Avoid package names like base , common , or util A common cause of poor package names is what call utility packages. These are packages where common helpers and utility code congeals over time. As these packages contain an assortment of unrelated functions, their utility is hard to describe in terms of what the package provides. This often leads to the packageâ€™s name being derived from what the package containsâ€“utilities. Package names like utils or helpers are commonly found in larger projects which have developed deep package hierarchies and want to share helper functions without encountering import loops. By extracting utility functions to new package the import loop is broken, but because the package stems from a design problem in the project, its name doesnâ€™t reflect its purpose, only its function of breaking the import cycle. My recommendation to improve the name of utils or helpers packages is to analyse where they are called and if possible move the relevant functions into their callerâ€™s package. Even if this involves duplicating some helper code this is better than introducing an import dependency between two packages. â€œ[A little] duplication is far cheaper than the wrong abstraction. â€” Sandy Metz In the case where utility functions are used in many places prefer multiple packages, each focused on a single aspect, to a single monolithic package. TIP Use plurals for naming utility packages. For example the strings for string handling utilities. Packages with names like base or common are often found when functionality common to two or more implementations, or common types for a client and server, has been refactored into a separate package. I believe the solution to this is to reduce the number of packages, to combine the client, server, and common code into a single package named after the function of the package. For example, the net/http package does not have client and sub packages, instead it has a client.go and server.go file, each holding their respective types, and a file for the common message transport code. server https://dave.cheney.net/practical-go/presentations/qcon-china.html 16/45 1transport.go 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs TIP An identifierâ€™s name includes its package name. Itâ€™s important to remember that the name of an identifier includes the name of its package. The Get function from the net/http package becomes http.Get when referenced by another package. The Reader type from the strings package becomes strings.Reader when imported into other packages. The Error interface from the net package is clearly related to network errors. 4.3. Return early rather than nesting deeply As Go does not use exceptions for control flow there is no requirement to deeply indent your code just to provide a top level structure for the try and catch blocks. Rather than the successful path nesting deeper and deeper to the right, Go code is written in a style where the success path continues down the screen as the function progresses. My friend Mat Ryer calls this practice â€˜line of sightâ€™ coding. [4] This is achieved by using guard clauses; conditional blocks with assert preconditions upon entering a function. Here is an example from the bytes package, 12func (b *Buffer) UnreadRune() error &#123; if b.lastRead &lt;= opInvalid &#123; GO 1234567 return errors.New(&quot;bytes.Buffer: UnreadRune: previous operation was not a successfulReadRune&quot;) &#125; if b.off &gt;= int(b.lastRead) &#123; b.off -= int(b.lastRead) &#125; b.lastRead = opInvalid return nil } Upon entering UnreadRune the state of b.lastRead is checked and if the previous operation was not an error is returned immediately. From there the rest of the function proceeds with the assertion that is greater that opInvalid . Compare this to the same function written without a guard clause, 1234567func (b *Buffer) UnreadRune() error &#123; if b.lastRead &gt; opInvalid &#123; if b.off &gt;= int(b.lastRead) &#123; b.off -= int(b.lastRead) &#125; b.lastRead = opInvalid return nil } 12 return errors.New(&quot;bytes.Buffer: UnreadRune: previous operation was not a successfulReadRune&quot;) } GO The body of the successful case, the most common, is nested inside the first if condition and the successful exit condition, return nil , has to be discovered by careful matching of closing braces. The final line of the function now returns an error, and the called must trace the execution of the function back to the matching opening brace to know https://dave.cheney.net/practical-go/presentations/qcon-china.html 17/45 ReadRune b.lastRead 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs when control will reach this point. This is more error prone for the reader, and the maintenance programmer, hence why Go prefer to use guard clauses and returning early on errors. 4.4. Make the zero value useful Every variable declaration, assuming no explicit initialiser is provided, will be automatically initialised to a value that matches the contents of zeroed memory. This is the values zero value. The type of the value determines its zero value; for numeric types it is zero, for pointer types nil, the same for slices, maps, and channels. This property of always setting a value to a known default is important for safety and correctness of your program and can make your Go programs simpler and more compact. This is what Go programmers talk about when they say â€œgive your structs a useful zero valueâ€. Consider the sync.Mutex type. sync.Mutex contains two unexported integer fields, representing the mutexâ€™s internal state. Thanks to the zero value those fields will be set to will be set to 0 whenever a sync.Mutex is declared. sync.Mutex has been deliberately coded to take advantage of this property, making the type usable without explicit initialisation. 12type MyInt struct &#123; mu sync.Mutex val int } 123456func main() &#123; var i MyInt // i.mu is usable without explicit initialisation. i.mu.Lock() i.val++ i.mu.Unlock() } GO Another example of a type with a useful zero value is bytes.Buffer . You can declare a bytes.Buffer and start writing to it without explicit initialisation. A useful property of slices is their zero value is nil . This makes sense if we look at the runtimeâ€™s definition of a slice header. 1234func main() &#123; var b bytes.Buffer b.WriteString(&quot;Hello, world!\n&quot;) io.Copy(os.Stdout, &amp;b) } GO 1234type slice struct &#123; array *[...]T // pointer to the underlying array len int cap int } https://dave.cheney.net/practical-go/presentations/qcon-china.html 18/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs The zero value of this struct would imply len and cap have the value 0 , and array , the pointer to memory holding the contents of the sliceâ€™s backing array, would be nil . This means you donâ€™t need to explicitly make a slice, you can just declare it. 1234567func main() &#123; // s := make([]string, 0) // s := []string&#123;&#125; var s []string s = append(s, &quot;Hello&quot;) s = append(s, &quot;world&quot;) fmt.Println(strings.Join(s, &quot; &quot;)) } GO var s []string is similar to the two commented lines above it, but not identical. It is possible to detect the difference between a slice value that is nil and a slice value that has zero length. The following code will output false. NOTE A surprising, but useful, property of uninitialised pointer variablesâ€”nil pointersâ€”is you can call methods on types that have a nil value. This can be used to provide default values simply. func main() { var s1 = []string{} var s2 []string fmt.Println(reflect.DeepEqual(s1, s2)) } GO 12type Config struct &#123; path string } 12345678910func (c *Config) Path() string &#123; if c == nil &#123; return &quot;/usr/home&quot; &#125; return c.path&#125;func main() &#123; var c1 *Config var c2 = &amp;Config&#123; path: &quot;/export&quot;, } 12 fmt.Println(c1.Path(), c2.Path())&#125; GO 4.5. Avoid package level state The key to writing maintainable programs is that they should be loosely coupledâ€”a change to one package should have a low probability of affecting another package that does not directly depend on the first. There are two excellent ways to achieve loose coupling in Go https://dave.cheney.net/practical-go/presentations/qcon-china.html 19/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs \1. Use interfaces to describe the behaviour your functions or methods require. 2. Avoid the use of global state. In Go we can declare variables at the function or method scope, and also at the package scope. When the variable is public, given a identifier starting with a capital letter, then its scope is effectively global to the entire programâ€”any package may observe the type and contents of that variable at any time. Mutable global state introduces tight coupling between independent parts of your program as global variables become an invisible parameter to every function in your program! Any function that relies on a global variable can be broken if that variableâ€™s type changes. Any function that relies on the state of a global variable can be broken if another part of the program changes that variable. If you want to reduce the coupling a global variable creates, \1. Move the relevant variables as fields on structs that need them. \2. Use interfaces to reduce the coupling between the behaviour and the implementation of that behaviour. \5. Project Structure Letâ€™s talk about combining packages together into a project. Commonly this will be a single git repository, but in the future Go developers will use module and project interchangeably. Just like a package, each project should have a clear purpose. If your project is a library, it should provide one thing, say XML parsing, or logging. You should avoid combining multiple purposes into a single package, this will help avoid the dreaded common library. In my experience, the common repo ends up tightly coupled to its biggest consumer and that makes TIP it hard to back-port fixes without upgrading both common and consumer in lock step, bringing in a lot of unrelated changes and API breakage along the way. If your project is an application, like your web application, Kubernetes controller, and so on, then you might have one or more packages inside your project. For example, the Kubernetes controller I work on has a single package which serves as both the server deployed to a Kubernetes cluster, and a client for debugging purposes. 5.1. Consider fewer, larger packages One of the things I tend to pick up in code review for programmers who are transitioning from other languages to Go is they tend to overuse packages. Go does not provide elaborate ways of establishing visibility; thing Javaâ€™s public , protected , private , and implicit default access modifiers. There is no equivalent of C++â€™s notion of friend classes. In Go we have only two access modifiers, public and private, indicated by the capitalisation of the first letter of the identifier. If an identifier is public, itâ€™s name starts with a capital letter, that identifier can be referenced by any other Go package. NOTE You may hear people say exported and not exported as synonyms for public and private. Given the limited controls available to control access to a packageâ€™s symbols, what practices should Go programmers follow to avoid creating over-complicated package hierarchies? main cmd/contour https://dave.cheney.net/practical-go/presentations/qcon-china.html 20/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs TIP Every package, with the exception of cmd/ and internal/ , should contain some source code. The advice I find myself repeating is to prefer fewer, larger packages. Your default position should be to not create a new package. That will lead to too many types being made public creating a wide, shallow, API surface for your package.. The sections below explores this suggestion in more detail. TIP Coming from Java? If youâ€™re coming from a Java or C# background, consider this rule of thumb. - A Java package is equivalent to a single .go source file. - A Go package is equivalent to a whole Maven module or .NET assembly. 5.1.1. Arrange code into les by import statements If youâ€™re arranging your packages by what they provide to callers, should you do the same for files within a Go package? How do you know when you should break up a .go file into multiple ones? How do you know when youâ€™ve gone to far and should consider consolidating .go file? Here are the rules of thumb I use: Start each package with one file. Give that file the same name as the name of the folder. eg. package http should be placed in a file called in a directory named http . As your package grows you may decide to split apart the various responsibilities into different files. eg, contains the `Request and Response types, client.go contains the Client type, server.go contains the type. If you find your files have similar import declarations, consider combining them. Alternatively, identify the differences between the import sets and move those Different files should be responsible for different areas of the package. may be responsible for marshalling of HTTP requests and responses on and off the network, may contain the low level network handling logic, client.go and server.go implement the HTTP business logic of request construction or routing, and so on. TIP Prefer nouns for source file names. The Go compiler compiles each package in parallel. Within a package the compiler compiles each NOTE function (methods are just fancy functions in Go) in parallel. Changing the layout of your code within a package does not affect compilation time. 5.1.2. Prefer internal tests to external tests The go tool supports writing your testing package tests in two places. Assuming your package is called http2 , you can write a file and use the declaration. Doing so will compile the code in as if it were part of the package. This is known colloquially as an internal test. The go tool also supports a special package declaration, ending in test , ie., package http_test . This allows your test files to live alongside your code in the same package, however when those tests are compiled they are not part of your packageâ€™s code, they live in their own package. This allows you to write your tests as if you were another package calling into your code. This is known as an _external test. .go http.go messages.go Server messages.go http.go 1http2_test.go package http2 1http2_test.go http2 https://dave.cheney.net/practical-go/presentations/qcon-china.html 21/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs I recommend using internal tests when writing unit tests for your package. This allows you to test each function or method directly, avoiding the bureaucracy of external testing. However, you should place your Example test functions in an external test file. This ensures that when viewed in godoc, the examples have the appropriate package prefix and can be easily copy pasted. TIP Avoid elaborate package hierarchies, resist the desire to apply taxonomy With one exception, which weâ€™ll talk about next, the hierarchy of Go packages has no meaning to the go tool. For example, the net/http package is not a child or sub-package of the net package. If you find you have created intermediate directories in your project which contain no .go files, you may have failed to follow this advice. 5.1.3. Use internal packages to reduce your public API surface If your project contains multiple packages you may have some exported functions which are intended to be used by other packages in your project, but are not intended to be part of your projectâ€™s public API. If you find yourself in this situation the go tool recognises a special folder nameâ€”not package nameâ€“, internal/ which can be used to place code which is public to your project, but private to other projects. To create such a package, place it in a directory named internal/ or in a sub-directory of a directory named internal/ . When the go command sees an import of a package with in its path, it verifies that the package doing the import is within the tree rooted at the parent of the directory. For example, a package can be imported only by code in the directory tree rooted at â€¦ /a/b/c . It cannot be imported by code in or in any other repository. [5] 5.2. Keep package main small as small as possible Your main function, and package should do as little as possible. This is because main.main acts as a singleton; there can only be one function in a program, including tests. Because main.main is a singleton there are a lot of assumptions built into the things that main.main will call that they will only be called during main.main or main.init, and only called once. This makes it hard to write tests for code written in main.main , thus you should aim to move as much of your business logic out of your main function and ideally out of your main package. TIP main should parse flags, open connections to databases, loggers, and such, then hand off execution to a high level object. \6. API Design The last piece of design advice Iâ€™m going to give today I feel is the most important. All of the suggestions Iâ€™ve made so far are just that, suggestions. These are the way I try to write my Go, but Iâ€™m not going to push them hard in code review. However when it comes to reviewing APIs during code review, I am less forgiving. This is because everything Iâ€™ve talked about so far can be fixed without breaking backward compatibility; they are, for the most part, implementation details. When it comes to the public API of a package, it pays to put considerable thought into the initial design, because changing that design later is going to be disruptive for people who are already using your API. https://dave.cheney.net/practical-go/presentations/qcon-china.html 22/45 internal main â€¦/a/b/g internal 1.../a/b/c/internal/d/e/f main 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs â€œ6.1. Design APIs that are hard to misuse. APIs should be easy to use and hard to misuse. â€” Josh Bloch [3] If you take anything away from this presentation, it should be this advice from Josh Bloch. If an API is hard to use for simple things, then every invocation of the API will look complicated. When the actual invocation of the API is complicated it will be less obvious and more likely to be overlooked. 6.1.1. Be wary of functions which take several parameters of the same type A good example of a simple looking, but hard to use correctly API is one which takes two or more parameters of the same type. Letâ€™s compare two function signatures: Whatâ€™s the difference between these two functions? Obviously one returns the maximum of two numbers, the other copies a file, but thatâ€™s not the important thing. Max is commutative; the order of the parameters does not matter. The maximum of eight and ten is ten regardless of if I compare eight to ten or ten two eight. However, this property does not hold true for CopyFile . Which one of these statements made a backup of your presentation and which one overwrite your presentation with last weekâ€™s version? You canâ€™t tell without consulting the documentation. A code reviewer cannot know if youâ€™ve got the order correct without consulting the documentation. One possible solution to this is to introduce a helper type which will be responsible for calling CopyFile correctly. 123456789func Max(a, b int) intfunc CopyFile(to, from string) errorMax(8, 10) // 10Max(10, 8) // 10CopyFile(&quot;/tmp/backup&quot;, &quot;presentation.md&quot;)CopyFile(&quot;presentation.md&quot;, &quot;/tmp/backup&quot;)type Source stringfunc (src Source) CopyTo(dest string) error &#123; return CopyFile(dest, string(src)) } 123func main() &#123; var from Source = &quot;presentation.md&quot; from.CopyTo(&quot;/tmp/backup&quot;) } GO In this way CopyFile is always called correctlyâ€”this can be asserted with a unit testâ€”and can possibly be made private, further reducing the likelihood of misuse. https://dave.cheney.net/practical-go/presentations/qcon-china.html 23/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs TIP APIs with multiple parameters of the same type are hard to use correctly. 6.2. Design APIs for their default use case A few years ago I gave a talk [6] about using functional options [7] to make APIs easier to use for their default case. The gist of this talk was you should design your APIs for the common use case. Sad another way, your API should not require the caller to provide parameters which they donâ€™t care about. 6.2.1. Discourage the use of nil as a parameter I opened this chapter with the suggestion that you shouldnâ€™t force the caller of your API into providing you parameters when they donâ€™t really care what those parameters mean. This is what I mean when I say design APIs for their default use case. Hereâ€™s an example from the net/http package package http 12345678// ListenAndServe listens on the TCP network address addr and then calls// Serve with handler to handle requests on incoming connections.// Accepted connections are configured to enable TCP keep-alives.//// The handler is typically nil, in which case the DefaultServeMux is used.//// ListenAndServe always returns a non-nil error.func ListenAndServe(addr string, handler Handler) error &#123; ListenAndServe takes two parameters, a TCP address to listen for incoming connections, and http.Handler to handle the incoming HTTP request. Serve allows the second parameter to be nil , and notes that usually the caller will pass nil indicating that they want to use http.DefaultServeMux as the implicit parameter. Now the caller of Serve has two ways to do the same thing. Both do exactly the same thing. This behaviour is viral. The http package also has a http.Serve helper, which you can reasonably imagine that builds upon like this 12http.ListenAndServe(&quot;0.0.0.0:8080&quot;, nil)http.ListenAndServe(&quot;0.0.0.0:8080&quot;, http.DefaultServeMux) nil 1234ListenAndServefunc ListenAndServe(addr string, handler Handler) error &#123; l, err := net.Listen(&quot;tcp&quot;, addr) if err != nil &#123; return err } 123 defer l.Close() return Serve(l, handler)&#125; GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 24/45 http.Serve 1ListenAndServe nil handler DefaultServeMux`â€ logic. http.Serve Accepting `nil nil Serve 123http.Serve(nil, nil) http.ListenAndServeDefaultServeMux nil 123const root = http.Dir(&quot;/htdocs&quot;)http.Handle(&quot;/&quot;, http.FileServer(root))http.ListenAndServe(&quot;0.0.0.0:8080&quot;, nil) GO 123const root = http.Dir(&quot;/htdocs&quot;)http.Handle(&quot;/&quot;, http.FileServer(root))http.ListenAndServe(&quot;0.0.0.0:8080&quot;, http.DefaultServeMux) GO 1234const root = http.Dir(&quot;/htdocs&quot;)mux := http.NewServeMux()http.Handle(&quot;/&quot;, http.FileServer(root))http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux) GO 1func ShutdownVMs(ids []string) error 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Because behaviour. In fact, permits the caller to pass for the second parameter, also supports this is the one that implements the â€œif is nil , use for one parameter may lead the caller into thinking they can pass for both parameters. However calling like this, results in an ugly panic. TIP Donâ€™t mix nil and non nil-able parameters in the same function signature. The author of was trying to make the API userâ€™s life easier in the common case, but possibly made the package harder to use safely. There is no difference in line count between using explicitly, or implicitly via . verses and a was this confusion really worth saving one line? TIP Give serious consideration to how much time helper functions will save the programmer. Clear is better than concise. Avoid public APIs with test only parameters TIP Avoid exposing APIs with values who only differ in test scope. Instead, use Public wrappers to hide those parameters, use test scoped helpers to set the property in test scope. 6.2.2. Prefer var args to []T parameters Itâ€™s very common to write a function or method that takes a slice of values. https://dave.cheney.net/practical-go/presentations/qcon-china.html 25/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs This is just an example I made up, but its common to a lot of code Iâ€™ve worked on. The problem with signatures like these is they presume that they will be called with more than one entry. However, what I have found is many times these type of functions are called with only one argument, which has to be â€œboxedâ€ inside a slice just to meet the requirements of the functions signature. Additionally, because the ids parameter is a slice, you can pass an empty slice or nil to the function and the compiler will be happy. This adds extra testing load because you should cover these cases in your testing. To give an example of this class of API, recently I was refactoring a piece of logic that required me to set some extra fields if at least one of a set of parameters was non zero. The logic looked like this: As the if statement was getting very long I wanted to pull the logic of the check out into its own function. This is what I came up with: 12345678if svc.MaxConnections &gt; 0 || svc.MaxPendingRequests &gt; 0 || svc.MaxRequests &gt; 0 ||svc.MaxRetries &gt; 0 &#123; // apply the non zero parameters&#125;// anyPostive indicates if any value is greater than zero.func anyPositive(values ...int) bool &#123; for _, v := range values &#123; if v &gt; 0 &#123; return true } } 12 return false&#125; GO This enabled me to make the condition where the inner block will be executed clear to the reader: However there is a problem with anyPositive , someone could accidentally invoke it like this if anyPositive() { â€¦ } In this case anyPositive would return false because it would execute zero iterations and immediately return false . This isnâ€™t the worst thing in the world â€” that would be if anyPositive returned true when passed no arguments. Nevertheless it would be be better if we could change the signature of anyPositive to enforce that the caller should pass at least one argument. We can do that by combining normal and vararg parameters like this: 12if anyPositive(svc.MaxConnections, svc.MaxPendingRequests, svc.MaxRequests, svc.MaxRetries) &#123; // apply the non zero parameters } https://dave.cheney.net/practical-go/presentations/qcon-china.html 26/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Now anyPositive cannot be called with less than one argument. 6.3. Let functions dene the behaviour they requires Letâ€™s say Iâ€™ve been given a task to write a function that persists a Document structure to disk. I could specify this function, Save, which takes an *os.File as the destination to write the Document . But this has a few problems The signature of Save precludes the option to write the data to a network location. Assuming that network storage is likely to become requirement later, the signature of this function would have to change, impacting all its callers. Save is also unpleasant to test, because it operates directly with files on disk. So, to verify its operation, the test would have to read the contents of the file after being written. And I would have to ensure that f was written to a temporary location and always removed afterwards. os.File also defines a lot of methods which are not relevant to , like reading directories and checking to see if a path is a symlink. It would be useful if the signature of the function could describe only the parts of os.File that were relevant. What can we do ? Using io.ReadWriteCloser we can apply the interface segregation principle to redefine Save to take an interface that describes more general file shaped things. With this change, any type that implements the io.ReadWriteCloser interface can be substituted for the previous *os.File . This makes Save both broader in its application, and clarifies to the caller of Save which methods of the *os.File type are relevant to its operation. 12// Save writes the contents of doc to the file f.func Save(f *os.File, doc *Document) error Save Save 1234567891011// Save writes the contents of doc to the supplied// ReadWriterCloser.func Save(rwc io.ReadWriteCloser, doc *Document) error// anyPostive indicates if any value is greater than zero.func anyPositive(first int, rest ...int) bool &#123; if first &gt; 0 &#123; return true &#125; for _, v := range rest &#123; if v &gt; 0 &#123; return true } } 12 return false&#125; GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 27/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs And as the author of I no longer have the option to call those unrelated methods on as it is hidden behind the interface. But we can take the interface segregation principle a bit further. Firstly, it is unlikely that if Save follows the single responsibility principle, it will read the file it just wrote to verify its contentsâ€”that should be responsibility of another piece of code. So we can narrow the specification for the interface we pass to Save to just writing and closing. Secondly, by providing Save with a mechanism to close its stream, which we inherited in this desire to make it still look like a file, this raises the question of under what circumstances will wc be closed. Possibly Save will call Close unconditionally, or perhaps Close will be called in the case of success. This presents a problem for the caller of Save as it may want to write additional data to the stream after the document is written. A better solution would be to redefine Save to take only an io.Writer , stripping it completely of the responsibility to do anything but write data to a stream. By applying the interface segregation principle to our Save function, the results has simultaneously been a function which is the most specific in terms of its requirementsâ€”it only needs a thing that is writableâ€”and the most general in its function, we can now use Save to save our data to anything which implements io.Writer. \7. Error handling Iâ€™ve given several presentations about error handling [8] and written a lot about error handling on my blog. I also spoke a lot about error handling in yesterdayâ€™s session so I wonâ€™t repeat what Iâ€™ve said. https://dave.cheney.net/2014/12/24/inspecting-errors https://dave.cheney.net/2016/04/07/constant-errors Instead I want to cover two other areas related to error handling. 7.1. Eliminate error handling by eliminating errors If you were in my presentation yesterday I talked about the draft proposals for improving error handling. But do you know what is better than an improved syntax for handling errors? Not needing to handle errors at all. Save *os.File 123456// Save writes the contents of doc to the supplied// WriteCloser.func Save(wc io.WriteCloser, doc *Document) error// Save writes the contents of doc to the supplied// Writer.func Save(w io.Writer, doc *Document) error NOTE Iâ€™m not saying â€œremove your error handlingâ€. What I am suggesting is, change your code so you do not have errors to handle. 1io.ReadWriteCloser https://dave.cheney.net/practical-go/presentations/qcon-china.html 28/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs This section draws inspiration from John Ousterhoutâ€™s recently book, A philosophy of Software Design [9]. One of the chapters in that book is called â€œDefine Errors Out of Existenceâ€. Weâ€™re going to try to apply this advice to Go. 7.1.1. Counting lines Letâ€™s write a function to count the number of lines in a file. 12345func CountLines(r io.Reader) (int, error) &#123; var ( br = bufio.NewReader(r) lines int err error ) 1234for &#123; _, err = br.ReadString(&apos;\n&apos;) lines++ if err != nil &#123; break } } 12if err != io.EOF &#123; return 0, err } 12 return lines, nil&#125; GO Because weâ€™re following our advice from previous sections, CountLines takes an io.Reader, not a *File; its the job of the caller to provide the io.Reader whoâ€™s contents we want to count. We construct a bufio.Reader , and then sit in a loop calling the ReadString method, incrementing a counter until we reach the end of the file, then we return the number of lines read. At least thatâ€™s the code we want to write, but instead this function is made more complicated by error handling. For example, there is this strange construction, We increment the count of lines before checking the errorâ€”that looks odd. The reason we have to write it this way is ReadString will return an error if it encounters and end-of-file before hitting a newline character. This can happen if there is no final newline in the file. To try to fix this, we rearrange the logic to increment the line count, then see if we need to exit the loop. NOTE this logic still isnâ€™t perfect, can you spot the bug? 123_, err = br.ReadString(&apos;\n&apos;)lines++if err != nil &#123; break } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 29/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs But weâ€™re not done checking errors yet. will return when it hits the end of the file. This is expected, needs some way of saying stop, there is nothing more to read. So before we return the error to the caller of , we need to check if the error was not io.EOF , and in that case propagate it up, otherwise we return nil to say that everything worked fine. I think this is a good example of Russ Coxâ€™s observation that error handling can obscure the operation of the function. Letâ€™s look at an improved version. ReadString io.EOF ReadString CountLine 12345func CountLines(r io.Reader) (int, error) &#123; sc := bufio.NewScanner(r) lines := 0 for sc.Scan() &#123; lines++ } 12 return lines, sc.Err()&#125; GO This improved version switches from using bufio.Reader to bufio.Scanner . Under the hood bufio.Scanner uses , but it adds a nice layer of abstraction which helps remove the error handling with obscured the operation of . 1bufio.Reader CountLines NOTE The method, the body of our bufio.Scanner can scan for any pattern, but by default it looks for newlines. returns true if the scanner has matched a line of text and has not encountered an error. So, loop will be called only when there is a line of text in the scannerâ€™s buffer. This means our revised sc.Scan() for CountLines correctly handles the case where there is no trailing newline, and also handles the case where the file was empty. Secondly, as sc.Scan returns false once an error is encountered, our for loop will exit when the end-of-file is reached or an error is encountered. The type memoises the first error it encountered and we can recover that error once weâ€™ve exited the loop using the method. Lastly, sc.Err() takes care of handling io.EOF and will convert it to a nil if the end of file was reached without encountering another error. 1bufio.Scanner sc.Err() TIP When you find yourself faced with overbearing error handling, try to extract some of the operations into a helper type. 7.1.2. WriteResponse My second example is inspired from the Errors are values blog post [10]. Earlier in this presentation Weâ€™ve seen examples dealing with opening, writing and closing files. The error handling is present, but not overwhelming as the operations can be encapsulated in helpers like ioutil.ReadFile and ioutil.WriteFile . However when dealing with low level network protocols it becomes necessary to build the response directly using I/O primitives the error handling can become repetitive. Consider this fragment of a HTTP server which is constructing the HTTP response. https://dave.cheney.net/practical-go/presentations/qcon-china.html 30/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs First we construct the status line using fmt.Fprintf , and check the error. Then for each header we write the header key and value, checking the error each time. Lastly we terminate the header section with an additional \r\n , check the error, and copy the response body to the client. Finally, although we donâ€™t need to check the error from io.Copy , we need to translate it from the two return value form that io.Copy returns into the single return value that WriteResponse returns. Thatâ€™s a lot of repetitive work. But we can make it easier on ourselves by introducing a small wrapper type, errWriter . errWriter fulfils the io.Writer contract so it can be used to wrap an existing io.Writer . errWriter passes writes through to its underlying writer until an error is detected. From that point on, it discards any writes and returns the previous error. 12type Header struct &#123; Key, Value string } 1234567type Status struct &#123; Code int Reason string&#125;func WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error &#123; _, err := fmt.Fprintf(w, &quot;HTTP/1.1 %d %s\r\n&quot;, st.Code, st.Reason) if err != nil &#123; return err } 123for _, h := range headers &#123; _, err := fmt.Fprintf(w, &quot;%s: %s\r\n&quot;, h.Key, h.Value) if err != nil &#123; return err } } 12if _, err := fmt.Fprint(w, &quot;\r\n&quot;); err != nil &#123; return err } 1_, err = io.Copy(w, body) return err } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 31/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Applying errWriter to WriteResponse dramatically improves the clarity of the code. Each of the operations no longer needs to bracket itself with an error check. Reporting the error is moved to the end of the function by inspecting the ew.err field, avoiding the annoying translation from `io.Copyâ€™s return values. 7.2. Only handle an error once Lastly, I want to mention that you should only handle errors once. Handling an error means inspecting the error value, and making a single decision. If you make less than one decision, youâ€™re ignoring the error. As we see here, the error from w.WriteAll is being discarded. But making more than one decision in response to a single error is also problematic. The following is code that I come across frequently. 12// WriteAll writes the contents of buf to the supplied writer.func WriteAll(w io.Writer, buf []byte) &#123; } 123w.Write(buf)type errWriter struct &#123; io.Writer err error } 1234567func (e *errWriter) Write(buf []byte) (int, error) &#123; if e.err != nil &#123; return 0, e.err &#125; var n int n, e.err = e.Writer.Write(buf) return n, nil } 12345func WriteResponse(w io.Writer, st Status, headers []Header, body io.Reader) error &#123; ew := &amp;errWriter&#123;Writer: w&#125; fmt.Fprintf(ew, &quot;HTTP/1.1 %d %s\r\n&quot;, st.Code, st.Reason) for _, h := range headers &#123; fmt.Fprintf(ew, &quot;%s: %s\r\n&quot;, h.Key, h.Value) } 123fmt.Fprint(ew, &quot;\r\n&quot;)io.Copy(ew, body)return ew.err } GO 123456func WriteAll(w io.Writer, buf []byte) error &#123; _, err := w.Write(buf) if err != nil &#123; log.Println(&quot;unable to write:&quot;, err) // annotated error goes to log file return err // unannotated error returned to caller &#125; return nil } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 32/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs In this example if an error occurs during , a line will be written to a log file, noting the file and line that the error occurred, and the error is also returned to the caller, who possibly will log it, and return it, all the way back up to the top of the program. The caller is probably doing the same 1234func WriteConfig(w io.Writer, conf *Config) error &#123; buf, err := json.Marshal(conf) if err != nil &#123; log.Printf(&quot;could not marshal config: %v&quot;, err) return err } 123if err := WriteAll(w, buf); err != nil &#123; log.Println(&quot;could not write config: %v&quot;, err) return err } return nil } GO So you get a stack of duplicate lines in your log file, but at the top of the program you get the original error without any context. I want to dig into this a little further because I donâ€™t see the problems with logging and returning as just a matter of personal preference. 12345678910111213unable to write: io.EOFcould not write config: io.EOFerr := WriteConfig(f, &amp;conf)fmt.Println(err) // io.EOFfunc WriteConfig(w io.Writer, conf *Config) error &#123; buf, err := json.Marshal(conf) if err != nil &#123; log.Printf(&quot;could not marshal config: %v&quot;, err) // oops, forgot to return &#125; if err := WriteAll(w, buf); err != nil &#123; log.Println(&quot;could not write config: %v&quot;, err) return err } return nil } GO The problem I see a lot is programmers forgetting to return from an error. As we talked about earlier, Go style is to use guard clauses, checking preconditions as the function progresses and returning early. In this example the author checked the error, logged it, but forgot to return. This has caused a subtle bug. w.Write https://dave.cheney.net/practical-go/presentations/qcon-china.html 33/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs The contract for error handling in Go says that you cannot make any assumptions about the contents of other return values in the presence of an error. As the JSON marshalling failed, the contents of buf are unknown, maybe it contains nothing, but worse it could contain a 1/2 written JSON fragment. Because the programmer forgot to return after checking and logging the error, the corrupt buffer will be passed to WriteAll , which will probably succeed and so the config file will be written incorrectly. However the function will return just fine, and the only indication that a problem happened will be a single log line complaining about marshalling JSON, not a failure to write the config. 7.2.1. Adding context to errors The bug occurred because the author was trying to add context to the error message. They were trying to leave themselves a breadcrumb to point them back to the source of the error. Letâ€™s look at another way to do the same thing using fmt.Errorf . 1234567func WriteConfig(w io.Writer, conf *Config) error &#123; buf, err := json.Marshal(conf) if err != nil &#123; return fmt.Errorf(&quot;could not marshal config: %v&quot;, err) &#125; if err := WriteAll(w, buf); err != nil &#123; return fmt.Errorf(&quot;could not write config: %v&quot;, err) } return nil } 12345func WriteAll(w io.Writer, buf []byte) error &#123; _, err := w.Write(buf) if err != nil &#123; return fmt.Errorf(&quot;write failed: %v&quot;, err) &#125; return nil } GO By combining the annotation of the error with returning onto one line there it is harder to forget to return an error and avoid continuing accidentally. If an I/O error occurs writing the file, the errorâ€™s `Error() method will report something like this; could not write config: write failed: input/output error 7.2.2. Wrapping errors with github.com/pkg/errors The fmt.Errorf pattern works well for annotating the error message, but it does so at the cost of obscuring the type of the original error. Iâ€™ve argued that treating errors as opaque values is important to producing software which is loosely coupled, so the face that the type of the original error should not matter if the only thing you do with an error value is \1. Check that it is not nil . 2. Print or log it. However there are some cases, I believe they are infrequent, where you do need to recover the original error. In that case you can use something like my errors package to annotate errors like this https://dave.cheney.net/practical-go/presentations/qcon-china.html 34/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Now the error reported will be the nice K&amp;D [11] style error, 1could not read config: open failed: open /Users/dfc/.settings.xml: no such file or directory and the error value retains a reference to the original cause. 123456func main() &#123; _, err := ReadConfig() if err != nil &#123; fmt.Printf(&quot;original error: %T %v\n&quot;, errors.Cause(err), errors.Cause(err)) fmt.Printf(&quot;stack trace:\n%+v\n&quot;, err) os.Exit(1) } } GO Thus you can recover the original error and print a stack trace; 12345678910111213141516func ReadFile(path string) ([]byte, error) &#123; f, err := os.Open(path) if err != nil &#123; return nil, errors.Wrap(err, &quot;open failed&quot;) &#125; defer f.Close() buf, err := ioutil.ReadAll(f) if err != nil &#123; return nil, errors.Wrap(err, &quot;read failed&quot;) &#125; return buf, nil&#125;func ReadConfig() ([]byte, error) &#123; home := os.Getenv(&quot;HOME&quot;) config, err := ReadFile(filepath.Join(home, &quot;.settings.xml&quot;)) return config, errors.WithMessage(err, &quot;could not read config&quot;) } 1234func main() &#123; _, err := ReadConfig() if err != nil &#123; fmt.Println(err) os.Exit(1) } } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 35/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Using the errors package gives you the ability to add context to error values, in a way that is inspectable by both a human and a machine. If you came to my presentation yesterday youâ€™ll know that wrapping is moving into the standard library in an upcoming Go release. \8. Concurrency Often Go is chosen for a project because of its concurrency features. The Go team have gone to great lengths to make concurrency in Go cheap (in terms of hardware resources) and performant, however it is possible to use Goâ€™s concurrency features to write code which is neither performent or reliable. With the time I have left I want to leave you with some advice for avoid some of the pitfalls that come with Goâ€™s concurrency features. Go features first class support for concurrency with channels, and the select and go statements. If youâ€™ve learnt Go formally from a book or training course, you might have noticed that the concurrency section is always one of the last youâ€™ll cover. This workshop is no different, I have chosen to cover concurrency last, as if it is somehow additional to the regular the skills a Go programmer should master. There is a dichotomy here; Goâ€™s headline feature is our simple, lightweight concurrency model. As a product, our language almost sells itself on this on feature alone. On the other hand, there is a narrative that concurrency isnâ€™t actually that easy to use, otherwise authors wouldnâ€™t make it the last chapter in their book and we wouldnâ€™t look back on our formative efforts with regret. This section discusses some pitfalls of naive usage of Goâ€™s concurrency features. 8.1. Keep yourself busy or do the work yourself What is the problem with this program? 123456789101112131415original error: *os.PathError open /Users/dfc/.settings.xml: no such file or directorystack trace:open /Users/dfc/.settings.xml: no such file or directoryopen failedmain.ReadFile /Users/dfc/devel/practical-go/src/errors/readfile2.go:16main.ReadConfig /Users/dfc/devel/practical-go/src/errors/readfile2.go:29main.main /Users/dfc/devel/practical-go/src/errors/readfile2.go:35runtime.main /Users/dfc/go/src/runtime/proc.go:201runtime.goexit /Users/dfc/go/src/runtime/asm_amd64.s:1333could not read config https://dave.cheney.net/practical-go/presentations/qcon-china.html 36/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs The program does what we intended, it serves a simple web server. However it also does something else at the same time, it wastes CPU in an infinite loop. This is because the for{} on the last line of main is going to block the main goroutine because it doesnâ€™t do any IO, wait on a lock, send or receive on a channel, or otherwise communicate with the scheduler. As the Go runtime is mostly cooperatively scheduled, this program is going to spin fruitlessly on a single CPU, and may eventually end up live-locked. How could we fix this? Hereâ€™s one suggestion. package main 123import ( &quot;fmt&quot; &quot;log&quot; â€œnet/httpâ€ â€œruntimeâ€ ) 12345678func main() &#123; http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123; fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;) &#125;) go func() &#123; if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123; log.Fatal(err) &#125; }() 12for &#123; runtime.Gosched() } } GO package main GO 123import ( &quot;fmt&quot; &quot;log&quot; â€œnet/httpâ€ ) 12345678func main() &#123; http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123; fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;) &#125;) go func() &#123; if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123; log.Fatal(err) &#125; }() for { } } https://dave.cheney.net/practical-go/presentations/qcon-china.html 37/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs This might look silly, but itâ€™s a common common solution I see in the wild. Itâ€™s symptomatic of not understanding the underlying problem. Now, if youâ€™re a little more experienced with go, you might instead write something like this. package main 123import ( &quot;fmt&quot; &quot;log&quot; â€œnet/httpâ€ ) 12345678func main() &#123; http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123; fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;) &#125;) go func() &#123; if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123; log.Fatal(err) &#125; }() select {} } GO An empty select statement will block forever. This is a useful property because now weâ€™re not spinning a whole CPU just to call runtime.GoSched() . However, weâ€™re only treating the symptom, not the cause. I want to present to you another solution, one which has hopefully already occurred to you. Rather than run in a goroutine, leaving us with the problem of what to do with the main goroutine, simply run 12http.ListenAndServehttp.ListenAndServe TIP on the main goroutine itself. If the main.main function of a Go program returns then the Go program will unconditionally exit no matter what other goroutines started by the program over time are doing. package main 123import ( &quot;fmt&quot; &quot;log&quot; â€œnet/httpâ€ ) 123456func main() &#123; http.HandleFunc(&quot;/&quot;, func(w http.ResponseWriter, r *http.Request) &#123; fmt.Fprintln(w, &quot;Hello, GopherCon SG&quot;) &#125;) if err := http.ListenAndServe(&quot;:8080&quot;, nil); err != nil &#123; log.Fatal(err) } } GO So this is my first piece of advice: if your goroutine cannot make progress until it gets the result from another, oftentimes it is simpler to just do the work yourself rather than to delegate it. https://dave.cheney.net/practical-go/presentations/qcon-china.html 38/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs This often eliminates a lot of state tracking and channel manipulation required to plumb a result back from a goroutine to its initiator. TIP Many Go programmers overuse goroutines, especially when they are starting out. As with all things in life, moderation is the key the key to success. 8.2. Leave concurrency to the caller What is the difference between these two APIs? 123456// ListDirectory returns the contents of dir.func ListDirectory(dir string) ([]string, error)// ListDirectory returns a channel over which// directory entries will be published. When the list// of entries is exhausted, the channel will be closed.func ListDirectory(dir string) chan string Firstly, the obvious differences; the first example reads a directory into a slice then returns the whole slice, or an error if something went wrong. This happens synchronously, the caller of ListDirectory blocks until all directory entries have been read. Depending on how large the directory, this could take a long time, and could potentially allocate a lot of memory building up the slide of directory entry names. Lets look at the second example. This is a little more Go like, ListDirectory returns a channel over which directory entries will be passed. When the channel is closed, that is your indication that there are no more directory entries. As the population of the channel happens after ListDirectory returns, ListDirectory is probably starting a goroutine to populate the channel. NOTE Its not necessary for the second version to actually use a Go routine; it could allocate a channel sufficient to hold all the directory entries without blocking, fill the channel, close it, then return the channel to the caller. But this is unlikely, as this would have the same problems with consuming a large amount of memory to buffer all the results in a channel. The channel version of ListDirectory has two further problems: By using a closed channel as the signal that there are no more items to process there is no way for ListDirectory to tell the caller that the set of items returned over the channel is incomplete because an error was encountered partway through. There is no way for the caller to tell the difference between an empty directory and an error to read from the directory entirely. Both result in a channel returned from ListDirectory which appears to be closed immediately. The caller must continue to read from the channel until it is closed because that is the only way the caller can know that the goroutine which was started to fill the channel has stopped. This is a serious limitation on the use of ListDirectory , the caller has to spend time reading from the channel even though it may have received the answer it wanted. It is probably more efficient in terms of memory usage for medium to large directories, but this method is no faster than the original slice based method. The solution to the problems of both implementations is to use a callback, a function that is called in the context of each directory entry as it is executed. https://dave.cheney.net/practical-go/presentations/qcon-china.html 39/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Not surprisingly this is how the filepath.WalkDir function works. If your function starts a goroutine you must provide the caller with a way to explicitly stop that TIP goroutine. It is often easier to leave decision to execute a function asynchronously to the caller of that function. 8.3. Never start a goroutine without when it will stop. The previous example showed using a goroutine when one wasnâ€™t really necessary. But one of the driving reasons for using Go is the first class concurrency features the language offers. Indeed there are many instances where you want to exploit the parallelism available in your hardware. To do so, you must use goroutines. This simple application serves http traffic on two different ports, port 8080 for application traffic and port 8001 for access to the /debug/pprof endpoint. package main 12import ( &quot;fmt&quot; â€œnet/httpâ€ 12345678910 _ &quot;net/http/pprof&quot;)func main() &#123; mux := http.NewServeMux() mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123; fmt.Fprintln(resp, &quot;Hello, QCon!&quot;) &#125;) go http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux) // debug http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux) // app traffic&#125; GO Although this program isnâ€™t very complicated, it represents the basis of a real application. There are a few problems with the application as it stands which will reveal themselves as the application grows, so lets address a few of them now. 1func ListDirectory(dir string, fn func(string)) https://dave.cheney.net/practical-go/presentations/qcon-china.html 40/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs By breaking the serveApp and serveDebug handlers out into their own functions weâ€™ve decoupled them from main.main . Weâ€™ve also followed the advice from above and make sure that serveApp and serveDebug leave their concurrency to the caller. But there are some operability problems with this program. If serveApp returns then main.main will return causing the program to shutdown and be restarted by whatever process manager youâ€™re using. TIP Just as functions in Go leave concurrency to the caller, applications should leave the job of monitoring their status and restarting them if they fail to the program that invoked them. Do not make your applications responsible for restarting themselves, this is a procedure best handled from outside the application. However, serveDebug is run in a separate goroutine and if it returns just that goroutine will exit while the rest of the program continues on. Your operations staff will not be happy to find that they cannot get the statistics out of your application when they want too because the /debug handler stopped working a long time ago. What we want to ensure is that if any of the goroutines responsible for serving this application stop, we shut down the application. 123456789func serveApp() &#123; mux := http.NewServeMux() mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123; fmt.Fprintln(resp, &quot;Hello, QCon!&quot;) &#125;) http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux)&#125;func serveDebug() &#123; http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux) } 12func main() &#123; go serveDebug() serveApp() } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 41/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Now serverApp and serveDebug check the error returned from ListenAndServe and call if required. Because both handlers are running in goroutines, we park the main goroutine in a . This approach has a number of problems: \1. If ListenAndServer returns with a nil error, log.Fatal wonâ€™t be called and the HTTP service on that port will shut down without stopping the application. \2. log.Fatal calls os.Exit which will unconditionally exit the program; defers wonâ€™t be called, other goroutines wonâ€™t be notified to shut down, the program will just stop. This makes it difficult to write tests for those functions. TIP Only use log.Fatal from main.main or init functions. What weâ€™d really like is to pass any error that occurs back to the originator of the goroutine so that it can know why the goroutine stopped, can shut down the process cleanly. log.Fatal select{} 1234567func serveApp() &#123; mux := http.NewServeMux() mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123; fmt.Fprintln(resp, &quot;Hello, QCon!&quot;) &#125;) if err := http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux); err != nil &#123; log.Fatal(err) } } 1234func serveDebug() &#123; if err := http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux); err != nil &#123; log.Fatal(err) &#125; } 123func main() &#123; go serveDebug() go serveApp() select {} } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 42/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs We can use a channel to collect the return status of the goroutine. The size of the channel is equal to the number of goroutines we want to manage so that sending to the done channel will not block, as this will block the shutdown the of goroutine, causing it to leak. As there is no way to safely close the done channel we cannot use the for range idiom to loop of the channel until all goroutines have reported in, instead we loop for as many goroutines we started, which is equal to the capacity of the channel. Now we have a way to wait for each goroutine to exit cleanly and log any error they encounter. All that is needed is a way to forward the shutdown signal from the first goroutine that exits to the others. It turns out that asking a http.Server to shut down is a little involved, so Iâ€™ve spun that logic out into a helper function. The serve helper takes an address and http.Handler , similar to http.ListenAndServe , and also a stop channel which we use to trigger the Shutdown method. 123456789func serveApp() error &#123; mux := http.NewServeMux() mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123; fmt.Fprintln(resp, &quot;Hello, QCon!&quot;) &#125;) return http.ListenAndServe(&quot;0.0.0.0:8080&quot;, mux)&#125;func serveDebug() error &#123; return http.ListenAndServe(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux) } 1234567func main() &#123; done := make(chan error, 2) go func() &#123; done &lt;- serveDebug() &#125;() go func() &#123; done &lt;- serveApp() }() 1234for i := 0; i &lt; cap(done); i++ &#123; if err := &lt;-done; err != nil &#123; fmt.Println(&quot;error: %v&quot;, err) &#125; } } GO https://dave.cheney.net/practical-go/presentations/qcon-china.html 43/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs Now, each time we receive a value on the channel, we close the stop channel which causes all the goroutines waiting on that channel to shut down their . This in turn will cause all the remaining ListenAndServe goroutines to return. Once all the goroutines we started have stopped, main.main returns and the process stops cleanly. done http.Server TIP Writing this logic yourself is repetitive and subtle. Consider something like this package, https://github.com/heptio/workgroup which will do most of the work for you. 12func serve(addr string, handler http.Handler, stop &lt;-chan struct&#123;&#125;) error &#123; s := http.Server&#123; Addr: addr, 12345 Handler: handler,&#125;go func() &#123; &lt;-stop // wait for stop signal s.Shutdown(context.Background()) }() 1234567891011 return s.ListenAndServe()&#125;func serveApp(stop &lt;-chan struct&#123;&#125;) error &#123; mux := http.NewServeMux() mux.HandleFunc(&quot;/&quot;, func(resp http.ResponseWriter, req *http.Request) &#123; fmt.Fprintln(resp, &quot;Hello, QCon!&quot;) &#125;) return serve(&quot;0.0.0.0:8080&quot;, mux, stop)&#125;func serveDebug(stop &lt;-chan struct&#123;&#125;) error &#123; return serve(&quot;127.0.0.1:8001&quot;, http.DefaultServeMux, stop) } 12345678func main() &#123; done := make(chan error, 2) stop := make(chan struct&#123;&#125;) go func() &#123; done &lt;- serveDebug(stop) &#125;() go func() &#123; done &lt;- serveApp(stop) }() 123456789var stopped boolfor i := 0; i &lt; cap(done); i++ &#123; if err := &lt;-done; err != nil &#123; fmt.Println(&quot;error: %v&quot;, err) &#125; if !stopped &#123; stopped = true close(stop) &#125; } } GO ä¸‹é¢æ˜¯Davidç»™å‡ºçš„ä¸€ä¸‹å…³äºŽgoçš„å­¦ä¹ å‚è€ƒèµ„æ–™çš„é“¾æŽ¥ï¼š https://dave.cheney.net/practical-go/presentations/qcon-china.html 44/45 2018/10/21 Practical Go: Real world advice for writing maintainable Go programs https://gaston.life/books/effective-programming/ https://talks.golang.org/2014/names.slide#4 https://www.infoq.com/articles/API-Design-Joshua-Bloch https://www.lysator.liu.se/c/pikestyle.html https://speakerdeck.com/campoy/understanding-nil https://www.youtube.com/watch?v=Ic2y6w8lMPA https://medium.com/@matryer/line-of-sight-in-code-186dd7cdea88 https://golang.org/doc/go1.4#internalpackages https://dave.cheney.net/2014/10/17/functional-options-for-friendly-apis https://commandcenter.blogspot.com/2014/01/self-referential-functions-and-design.html https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully https://www.amazon.com/Philosophy-Software-Design-John-Ousterhout/dp/1732102201 https://blog.golang.org/errors-are-values http://www.gopl.io/]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>GO QCon æŠ€æœ¯åˆ†äº«</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŠ€æœ¯å‘¨åˆŠä¹‹æ”¹å–„ Python ç¨‹åºçš„ 91 ä¸ªå»ºè®®ï¼ˆè½¬è½½)]]></title>
    <url>%2F2018%2F10%2F21%2F%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E6%94%B9%E5%96%84-Python-%E7%A8%8B%E5%BA%8F%E7%9A%84-91-%E4%B8%AA%E5%BB%BA%E8%AE%AE%EF%BC%88%E8%BD%AC%E8%BD%BD%2F</url>
    <content type="text"><![CDATA[æœ¬ç¯‡åšå®¢è½¬è½½è‡ªzhuanlan.zhihu.com/p/32817459ã€‚ é™¤äº†Googleçš„Pythonä»£ç è§„èŒƒå¤–ï¼Œä»Žæ¥æ²¡æœ‰ç±»ä¼¼çš„ä¹¦ç±ã€‚å¶ç„¶çš„æœºä¼šçœ‹åˆ°è¿™ä¹ˆä¸€æœ¬ä¹¦ï¼Œè¯»å®Œä¹‹åŽè§‰å¾—è¿˜ä¸é”™ï¼Œæ‰€ä»¥åšä¸ªç®€å•çš„ç¬”è®°ã€‚æœ‰æƒ³å­¦ä¹ ç±»ä¼¼çŸ¥è¯†çš„æœ‹å‹ï¼Œåˆæ‡’å¾—åŽ»è¯»å®Œæ•´æœ¬ä¹¦ç±ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹ã€‚ 1ï¼šå¼•è®ºå»ºè®®1ã€ç†è§£Pythonicæ¦‚å¿µâ€”-è¯¦è§Pythonä¸­çš„ã€ŠPythonä¹‹ç¦…ã€‹ å»ºè®®2ã€ç¼–å†™Pythonicä»£ç  ï¼ˆ1ï¼‰é¿å…ä¸è§„èŒƒä»£ç ï¼Œæ¯”å¦‚åªç”¨å¤§å°å†™åŒºåˆ†å˜é‡ã€ä½¿ç”¨å®¹æ˜“æ··æ·†çš„å˜é‡åã€å®³æ€•è¿‡é•¿å˜é‡åç­‰ã€‚æœ‰æ—¶å€™é•¿çš„å˜é‡åä¼šä½¿ä»£ç æ›´åŠ å…·æœ‰å¯è¯»æ€§ã€‚ ï¼ˆ2ï¼‰æ·±å…¥å­¦ä¹ Pythonç›¸å…³çŸ¥è¯†ï¼Œæ¯”å¦‚è¯­è¨€ç‰¹æ€§ã€åº“ç‰¹æ€§ç­‰ï¼Œæ¯”å¦‚Pythonæ¼”å˜è¿‡ç¨‹ç­‰ã€‚æ·±å…¥å­¦ä¹ ä¸€ä¸¤ä¸ªä¸šå†…å…¬è®¤çš„Pythonicçš„ä»£ç åº“ï¼Œæ¯”å¦‚Flaskç­‰ã€‚ å»ºè®®3ï¼šç†è§£Pythonä¸ŽCçš„ä¸åŒä¹‹å¤„ï¼Œæ¯”å¦‚ç¼©è¿›ä¸Ž{}ï¼Œå•å¼•å·åŒå¼•å·ï¼Œä¸‰å…ƒæ“ä½œç¬¦ï¼Ÿï¼ŒSwitch-Caseè¯­å¥ç­‰ã€‚ å»ºè®®4ï¼šåœ¨ä»£ç ä¸­é€‚å½“æ·»åŠ æ³¨é‡Š å»ºè®®5ï¼šé€‚å½“æ·»åŠ ç©ºè¡Œä½¿ä»£ç å¸ƒå±€æ›´åŠ åˆç† å»ºè®®6ï¼šç¼–å†™å‡½æ•°çš„4ä¸ªåŽŸåˆ™ ï¼ˆ1ï¼‰å‡½æ•°è®¾è®¡è¦å°½é‡çŸ­å°ï¼ŒåµŒå¥—å±‚æ¬¡ä¸å®œè¿‡æ·± ï¼ˆ2ï¼‰å‡½æ•°å£°æ˜Žåº”è¯¥åšåˆ°åˆç†ã€ç®€å•ã€æ˜“ç”¨ ï¼ˆ3ï¼‰å‡½æ•°å‚æ•°è®¾è®¡åº”è¯¥è€ƒè™‘å‘ä¸‹å…¼å®¹ ï¼ˆ4ï¼‰ä¸€ä¸ªå‡½æ•°åªåšä¸€ä»¶äº‹ï¼Œå°½é‡ä¿è¯å‡½æ•°ç²’åº¦çš„ä¸€è‡´æ€§ å»ºè®®7ï¼šå°†å¸¸é‡é›†ä¸­åœ¨ä¸€ä¸ªæ–‡ä»¶ï¼Œä¸”å¸¸é‡åå°½é‡ä½¿ç”¨å…¨å¤§å†™å­—æ¯ 2ï¼šç¼–ç¨‹æƒ¯ç”¨æ³•å»ºè®®8ï¼šåˆ©ç”¨assertè¯­å¥æ¥å‘çŽ°é—®é¢˜ï¼Œä½†è¦æ³¨æ„ï¼Œæ–­è¨€assertä¼šå½±å“æ•ˆçŽ‡ å»ºè®®9ï¼šæ•°æ®äº¤æ¢å€¼æ—¶ä¸æŽ¨èä½¿ç”¨ä¸´æ—¶å˜é‡ï¼Œè€Œæ˜¯ç›´æŽ¥a, b = b, a å»ºè®®10ï¼šå……åˆ†åˆ©ç”¨æƒ°æ€§è®¡ç®—ï¼ˆLazy evaluationï¼‰çš„ç‰¹æ€§ï¼Œä»Žè€Œé¿å…ä¸å¿…è¦çš„è®¡ç®— å»ºè®®11ï¼šç†è§£æžšä¸¾æ›¿ä»£å®žçŽ°çš„ç¼ºé™·ï¼ˆæœ€æ–°ç‰ˆPythonä¸­å·²ç»åŠ å…¥äº†æžšä¸¾ç‰¹æ€§ï¼‰ å»ºè®®12ï¼šä¸æŽ¨èä½¿ç”¨typeæ¥è¿›è¡Œç±»åž‹æ£€æŸ¥ï¼Œå› ä¸ºæœ‰äº›æ—¶å€™typeçš„ç»“æžœå¹¶ä¸ä¸€å®šå¯é ã€‚å¦‚æžœæœ‰éœ€æ±‚ï¼Œå»ºè®®ä½¿ç”¨isinstanceå‡½æ•°æ¥ä»£æ›¿ å»ºè®®13ï¼šå°½é‡å°†å˜é‡è½¬åŒ–ä¸ºæµ®ç‚¹ç±»åž‹åŽå†åšé™¤æ³•ï¼ˆPython3ä»¥åŽä¸ç”¨è€ƒè™‘ï¼‰ å»ºè®®14ï¼šè­¦æƒ•eval()å‡½æ•°çš„å®‰å…¨æ¼æ´žï¼Œæœ‰ç‚¹ç±»ä¼¼äºŽSQLæ³¨å…¥ å»ºè®®15ï¼šä½¿ç”¨enumerate()åŒæ—¶èŽ·å–åºåˆ—è¿­ä»£çš„ç´¢å¼•å’Œå€¼ å»ºè®®16ï¼šåˆ†æ¸…==å’Œisçš„é€‚ç”¨åœºæ™¯ï¼Œç‰¹åˆ«æ˜¯åœ¨æ¯”è¾ƒå­—ç¬¦ä¸²ç­‰ä¸å¯å˜ç±»åž‹å˜é‡æ—¶ï¼ˆè¯¦è§è¯„è®ºï¼‰ å»ºè®®17ï¼šå°½é‡ä½¿ç”¨Unicodeã€‚åœ¨Python2ä¸­ç¼–ç æ˜¯å¾ˆè®©äººå¤´ç—›çš„ä¸€ä»¶äº‹ï¼Œä½†Python3å°±ä¸ç”¨è¿‡å¤šè€ƒè™‘äº† å»ºè®®18ï¼šæž„å»ºåˆç†çš„åŒ…å±‚æ¬¡æ¥ç®¡ç†Module 3ï¼šåŸºç¡€ç”¨æ³•å»ºè®®19ï¼šæœ‰èŠ‚åˆ¶çš„ä½¿ç”¨fromâ€¦importè¯­å¥ï¼Œé˜²æ­¢æ±¡æŸ“å‘½åç©ºé—´ å»ºè®®20ï¼šä¼˜å…ˆä½¿ç”¨absolute importæ¥å¯¼å…¥æ¨¡å—ï¼ˆPython3ä¸­å·²ç»ç§»é™¤äº†relative importï¼‰ å»ºè®®21ï¼ši+=1ä¸ç­‰äºŽ++iï¼Œåœ¨Pythonä¸­ï¼Œ++iå‰è¾¹çš„åŠ å·ä»…è¡¨ç¤ºæ­£ï¼Œä¸è¡¨ç¤ºæ“ä½œ å»ºè®®22ï¼šä¹ æƒ¯ä½¿ç”¨withè‡ªåŠ¨å…³é—­èµ„æºï¼Œç‰¹åˆ«æ˜¯åœ¨æ–‡ä»¶è¯»å†™ä¸­ å»ºè®®23ï¼šä½¿ç”¨elseå­å¥ç®€åŒ–å¾ªçŽ¯ï¼ˆå¼‚å¸¸å¤„ç†ï¼‰ å»ºè®®24ï¼šéµå¾ªå¼‚å¸¸å¤„ç†çš„å‡ ç‚¹åŸºæœ¬åŽŸåˆ™ ï¼ˆ1ï¼‰æ³¨æ„å¼‚å¸¸çš„ç²’åº¦ï¼Œtryå—ä¸­å°½é‡å°‘å†™ä»£ç  ï¼ˆ2ï¼‰è°¨æ…Žä½¿ç”¨å•ç‹¬çš„exceptè¯­å¥ï¼Œæˆ–except Exceptionè¯­å¥ï¼Œè€Œæ˜¯å®šä½åˆ°å…·ä½“å¼‚å¸¸ ï¼ˆ3ï¼‰æ³¨æ„å¼‚å¸¸æ•èŽ·çš„é¡ºåºï¼Œåœ¨åˆé€‚çš„å±‚æ¬¡å¤„ç†å¼‚å¸¸ ï¼ˆ4ï¼‰ä½¿ç”¨æ›´åŠ å‹å¥½çš„å¼‚å¸¸ä¿¡æ¯ï¼Œéµå®ˆå¼‚å¸¸å‚æ•°çš„è§„èŒƒ å»ºè®®25ï¼šé¿å…finallyä¸­å¯èƒ½å‘ç”Ÿçš„é™·é˜± å»ºè®®26ï¼šæ·±å…¥ç†è§£Noneï¼Œæ­£ç¡®åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºç©ºã€‚Pythonä¸­ä¸‹åˆ—æ•°æ®ä¼šåˆ¤æ–­ä¸ºç©ºï¼š å»ºè®®27ï¼šè¿žæŽ¥å­—ç¬¦ä¸²åº”ä¼˜å…ˆä½¿ç”¨joinå‡½æ•°ï¼Œè€Œä¸æ˜¯+æ“ä½œ å»ºè®®28ï¼šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ—¶å°½é‡ä½¿ç”¨.formatå‡½æ•°ï¼Œè€Œä¸æ˜¯%å½¢å¼ å»ºè®®29ï¼šåŒºåˆ«å¯¹å¾…å¯å˜å¯¹è±¡å’Œä¸å¯å˜å¯¹è±¡ï¼Œç‰¹åˆ«æ˜¯ä½œä¸ºå‡½æ•°å‚æ•°æ—¶ å»ºè®®30ï¼š[], {}å’Œ()ï¼šä¸€è‡´çš„å®¹å™¨åˆå§‹åŒ–å½¢å¼ã€‚ä½¿ç”¨åˆ—è¡¨è§£æžå¯ä»¥ä½¿ä»£ç æ›´æ¸…æ™°ï¼ŒåŒæ—¶æ•ˆçŽ‡æ›´é«˜ å»ºè®®31ï¼šå‡½æ•°ä¼ å‚æ•°ï¼Œæ—¢ä¸æ˜¯ä¼ å€¼ä¹Ÿä¸æ˜¯ä¼ å¼•ç”¨ï¼Œè€Œæ˜¯ä¼ å¯¹è±¡æˆ–è€…è¯´å¯¹è±¡çš„å¼•ç”¨ å»ºè®®32ï¼šè­¦æƒ•é»˜è®¤å‚æ•°æ½œåœ¨çš„é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯å½“é»˜è®¤å‚æ•°ä¸ºå¯å˜å¯¹è±¡æ—¶ å»ºè®®33ï¼šå‡½æ•°ä¸­æ…Žç”¨å˜é•¿å‚æ•°*argså’Œ**kargs ï¼ˆ1ï¼‰è¿™ç§ä½¿ç”¨å¤ªçµæ´»ï¼Œä»Žè€Œä½¿å¾—å‡½æ•°ç­¾åä¸å¤Ÿæ¸…æ™°ï¼Œå¯è¯»æ€§è¾ƒå·® ï¼ˆ2ï¼‰å¦‚æžœå› ä¸ºå‡½æ•°å‚æ•°è¿‡å¤šè€Œæ˜¯ç”¨å˜é•¿å‚æ•°ç®€åŒ–å‡½æ•°å®šä¹‰ï¼Œé‚£ä¹ˆä¸€èˆ¬è¯¥å‡½æ•°å¯ä»¥é‡æž„ å»ºè®®34ï¼šæ·±å…¥ç†è§£str()å’Œrepr()çš„åŒºåˆ« ï¼ˆ1ï¼‰ä¸¤è€…ä¹‹é—´çš„ç›®æ ‡ä¸åŒï¼šsträ¸»è¦é¢å‘å®¢æˆ·ï¼Œå…¶ç›®çš„æ˜¯å¯è¯»æ€§ï¼Œè¿”å›žå½¢å¼ä¸ºç”¨æˆ·å‹å¥½æ€§å’Œå¯è¯»æ€§éƒ½æ¯”è¾ƒé«˜çš„å­—ç¬¦ä¸²å½¢å¼ï¼›è€Œrepræ˜¯é¢å‘Pythonè§£é‡Šå™¨æˆ–è€…è¯´Pythonå¼€å‘äººå‘˜ï¼Œå…¶ç›®çš„æ˜¯å‡†ç¡®æ€§ï¼Œå…¶è¿”å›žå€¼è¡¨ç¤ºPythonè§£é‡Šå™¨å†…éƒ¨çš„å®šä¹‰ ï¼ˆ2ï¼‰åœ¨è§£é‡Šå™¨ä¸­ç›´æŽ¥è¾“å…¥å˜é‡ï¼Œé»˜è®¤è°ƒç”¨reprå‡½æ•°ï¼Œè€Œprint(var)é»˜è®¤è°ƒç”¨strå‡½æ•° ï¼ˆ3ï¼‰reprå‡½æ•°çš„è¿”å›žå€¼ä¸€èˆ¬å¯ä»¥ç”¨evalå‡½æ•°æ¥è¿˜åŽŸå¯¹è±¡ ï¼ˆ4ï¼‰ä¸¤è€…åˆ†åˆ«è°ƒç”¨å¯¹è±¡çš„å†…å»ºå‡½æ•°str__()å’Œ__repr() å»ºè®®35ï¼šåˆ†æ¸…é™æ€æ–¹æ³•staticmethodå’Œç±»æ–¹æ³•classmethodçš„ä½¿ç”¨åœºæ™¯ 4ï¼šåº“å»ºè®®36ï¼šæŽŒæ¡å­—ç¬¦ä¸²çš„åŸºæœ¬ç”¨æ³• å»ºè®®37ï¼šæŒ‰éœ€é€‰æ‹©sort()å’Œsorted()å‡½æ•° ã€‹sort()æ˜¯åˆ—è¡¨åœ¨å°±åœ°è¿›è¡ŒæŽ’åºï¼Œæ‰€ä»¥ä¸èƒ½æŽ’åºå…ƒç»„ç­‰ä¸å¯å˜ç±»åž‹ã€‚ ã€‹sorted()å¯ä»¥æŽ’åºä»»æ„çš„å¯è¿­ä»£ç±»åž‹ï¼ŒåŒæ—¶ä¸æ”¹å˜åŽŸå˜é‡æœ¬èº«ã€‚ å»ºè®®38ï¼šä½¿ç”¨copyæ¨¡å—æ·±æ‹·è´å¯¹è±¡ï¼ŒåŒºåˆ†æµ…æ‹·è´ï¼ˆshallow copyï¼‰å’Œæ·±æ‹·è´ï¼ˆdeep copyï¼‰ å»ºè®®39ï¼šä½¿ç”¨Counterè¿›è¡Œè®¡æ•°ç»Ÿè®¡ï¼ŒCounteræ˜¯å­—å…¸ç±»çš„å­ç±»ï¼Œåœ¨collectionsæ¨¡å—ä¸­ å»ºè®®40ï¼šæ·±å…¥æŽŒæ¡ConfigParser å»ºè®®41ï¼šä½¿ç”¨argparseæ¨¡å—å¤„ç†å‘½ä»¤è¡Œå‚æ•° å»ºè®®42ï¼šä½¿ç”¨pandaså¤„ç†å¤§åž‹CSVæ–‡ä»¶ ã€‹Pythonæœ¬èº«æä¾›ä¸€ä¸ªCSVæ–‡ä»¶å¤„ç†æ¨¡å—ï¼Œå¹¶æä¾›readerã€writerç­‰å‡½æ•°ã€‚ ã€‹Pandaså¯æä¾›åˆ†å—ã€åˆå¹¶å¤„ç†ç­‰ï¼Œé€‚ç”¨äºŽæ•°æ®é‡å¤§çš„æƒ…å†µï¼Œä¸”å¯¹äºŒç»´æ•°æ®æ“ä½œæ›´æ–¹ä¾¿ã€‚ å»ºè®®43ï¼šä½¿ç”¨ElementTreeè§£æžXML å»ºè®®44ï¼šç†è§£æ¨¡å—pickleçš„ä¼˜åŠ£ ã€‹ä¼˜åŠ¿ï¼šæŽ¥å£ç®€å•ã€å„å¹³å°é€šç”¨ã€æ”¯æŒçš„æ•°æ®ç±»åž‹å¹¿æ³›ã€æ‰©å±•æ€§å¼º ã€‹åŠ£åŠ¿ï¼šä¸ä¿è¯æ•°æ®æ“ä½œçš„åŽŸå­æ€§ã€å­˜åœ¨å®‰å…¨é—®é¢˜ã€ä¸åŒè¯­è¨€ä¹‹é—´ä¸å…¼å®¹ å»ºè®®45ï¼šåºåˆ—åŒ–çš„å¦ä¸€ä¸ªé€‰æ‹©JSONæ¨¡å—ï¼šloadå’Œdumpæ“ä½œ å»ºè®®46ï¼šä½¿ç”¨tracebackèŽ·å–æ ˆä¿¡æ¯ å»ºè®®47ï¼šä½¿ç”¨loggingè®°å½•æ—¥å¿—ä¿¡æ¯ å»ºè®®48ï¼šä½¿ç”¨threadingæ¨¡å—ç¼–å†™å¤šçº¿ç¨‹ç¨‹åº å»ºè®®49ï¼šä½¿ç”¨Queueæ¨¡å—ä½¿å¤šçº¿ç¨‹ç¼–ç¨‹æ›´å®‰å…¨ 5ï¼šè®¾è®¡æ¨¡å¼å»ºè®®50ï¼šåˆ©ç”¨æ¨¡å—å®žçŽ°å•ä¾‹æ¨¡å¼ å»ºè®®51ï¼šç”¨mixinæ¨¡å¼è®©ç¨‹åºæ›´åŠ çµæ´» å»ºè®®52ï¼šç”¨å‘å¸ƒ-è®¢é˜…æ¨¡å¼å®žçŽ°æ¾è€¦åˆ å»ºè®®53ï¼šç”¨çŠ¶æ€æ¨¡å¼ç¾ŽåŒ–ä»£ç  6ï¼šå†…éƒ¨æœºåˆ¶å»ºè®®54ï¼šç†è§£build-inå¯¹è±¡ å»ºè®®55ï¼šinit__()ä¸æ˜¯æž„é€ æ–¹æ³•ï¼Œç†è§£__new()ä¸Žå®ƒä¹‹é—´çš„åŒºåˆ« å»ºè®®56ï¼šç†è§£å˜é‡çš„æŸ¥æ‰¾æœºåˆ¶ï¼Œå³ä½œç”¨åŸŸ ã€‹å±€éƒ¨ä½œç”¨åŸŸ ã€‹å…¨å±€ä½œç”¨åŸŸ ã€‹åµŒå¥—ä½œç”¨åŸŸ ã€‹å†…ç½®ä½œç”¨åŸŸ å»ºè®®57ï¼šä¸ºä»€ä¹ˆéœ€è¦selfå‚æ•° å»ºè®®58ï¼šç†è§£MROï¼ˆæ–¹æ³•è§£æžé¡ºåºï¼‰ä¸Žå¤šç»§æ‰¿ å»ºè®®59ï¼šç†è§£æè¿°ç¬¦æœºåˆ¶ å»ºè®®60ï¼šåŒºåˆ«getattr__()ä¸Ž__getattribute()æ–¹æ³•ä¹‹é—´çš„åŒºåˆ« å»ºè®®61ï¼šä½¿ç”¨æ›´å®‰å…¨çš„property å»ºè®®62ï¼šæŽŒæ¡å…ƒç±»metaclass å»ºè®®63ï¼šç†Ÿæ‚‰Pythonå¯¹è±¡åè®® å»ºè®®64ï¼šåˆ©ç”¨æ“ä½œç¬¦é‡è½½å®žçŽ°ä¸­ç¼€è¯­æ³• å»ºè®®65ï¼šç†Ÿæ‚‰Pythonçš„è¿­ä»£å™¨åè®® å»ºè®®66ï¼šç†Ÿæ‚‰Pythonçš„ç”Ÿæˆå™¨ å»ºè®®67ï¼šåŸºäºŽç”Ÿæˆå™¨çš„åç¨‹å’Œgreenletï¼Œç†è§£åç¨‹ã€å¤šçº¿ç¨‹ã€å¤šè¿›ç¨‹ä¹‹é—´çš„åŒºåˆ« å»ºè®®68ï¼šç†è§£GILçš„å±€é™æ€§ å»ºè®®69ï¼šå¯¹è±¡çš„ç®¡ç†å’Œåžƒåœ¾å›žæ”¶ 7ï¼šä½¿ç”¨å·¥å…·è¾…åŠ©é¡¹ç›®å¼€å‘å»ºè®®70ï¼šä»ŽPyPIå®‰è£…ç¬¬ä¸‰æ–¹åŒ… å»ºè®®71ï¼šä½¿ç”¨pipå’Œyolkå®‰è£…ã€ç®¡ç†åŒ… å»ºè®®72ï¼šåšpasteråˆ›å»ºåŒ… å»ºè®®73ï¼šç†è§£å•å…ƒæµ‹è¯•çš„æ¦‚å¿µ å»ºè®®74ï¼šä¸ºåŒ…ç¼–å†™å•å…ƒæµ‹è¯• å»ºè®®75ï¼šåˆ©ç”¨æµ‹è¯•é©±åŠ¨å¼€å‘ï¼ˆTDDï¼‰æé«˜ä»£ç çš„å¯æµ‹æ€§ å»ºè®®76ï¼šä½¿ç”¨Pylintæ£€æŸ¥ä»£ç é£Žæ ¼ ã€‹ä»£ç é£Žæ ¼å®¡æŸ¥ ã€‹ä»£ç é”™è¯¯æ£€æŸ¥ ã€‹å‘çŽ°é‡å¤ä»¥åŠä¸åˆç†çš„ä»£ç ï¼Œæ–¹ä¾¿é‡æž„ ã€‹é«˜åº¦çš„å¯é…ç½®åŒ–å’Œå¯å®šåˆ¶åŒ– ã€‹æ”¯æŒå„ç§IDEå’Œç¼–è¾‘å™¨çš„é›†æˆ ã€‹èƒ½å¤ŸåŸºäºŽPythonä»£ç ç”ŸæˆUMLå›¾ ã€‹èƒ½å¤Ÿä¸ŽJenkinsç­‰æŒç»­é›†æˆå·¥å…·ç›¸ç»“åˆï¼Œæ”¯æŒè‡ªåŠ¨ä»£ç å®¡æŸ¥ å»ºè®®77ï¼šè¿›è¡Œé«˜æ•ˆçš„ä»£ç å®¡æŸ¥ å»ºè®®78ï¼šå°†åŒ…å‘å¸ƒåˆ°PyPI 8ï¼šæ€§èƒ½å‰–æžä¸Žä¼˜åŒ–å»ºè®®79ï¼šäº†è§£ä»£ç ä¼˜åŒ–çš„åŸºæœ¬åŽŸåˆ™ å»ºè®®80ï¼šå€ŸåŠ©æ€§èƒ½ä¼˜åŒ–å·¥å…· å»ºè®®81ï¼šåˆ©ç”¨cProfileå®šä½æ€§èƒ½ç“¶é¢ˆ å»ºè®®82ï¼šä½¿ç”¨memory_profilerå’Œobjgraphå‰–æžå†…å­˜ä½¿ç”¨ å»ºè®®83ï¼šåŠªåŠ›é™ä½Žç®—æ³•å¤æ‚åº¦ å»ºè®®84ï¼šæŽŒæ¡å¾ªçŽ¯ä¼˜åŒ–çš„åŸºæœ¬æŠ€å·§ ã€‹å‡å°‘å¾ªçŽ¯å†…éƒ¨çš„è®¡ç®— ã€‹å°†æ˜¾å¼å¾ªçŽ¯æ”¹ä¸ºéšå¼å¾ªçŽ¯ï¼Œå½“ç„¶è¿™ä¼šç‰ºç‰²ä»£ç çš„å¯è¯»æ€§ ã€‹åœ¨å¾ªçŽ¯ä¸­å°½é‡å¼•ç”¨å±€éƒ¨å˜é‡ ã€‹å…³æ³¨å†…å±‚åµŒå¥—å¾ªçŽ¯ å»ºè®®85ï¼šä½¿ç”¨ç”Ÿæˆå™¨æé«˜æ•ˆçŽ‡ å»ºè®®86ï¼šä½¿ç”¨ä¸åŒçš„æ•°æ®ç»“æž„ä¼˜åŒ–æ€§èƒ½ å»ºè®®87ï¼šå……åˆ†åˆ©ç”¨setçš„ä¼˜åŠ¿ å»ºè®®88ï¼šä½¿ç”¨multiprocessingæ¨¡å—å…‹æœGILç¼ºé™· å»ºè®®89ï¼šä½¿ç”¨çº¿ç¨‹æ± æé«˜æ•ˆçŽ‡ å»ºè®®90ï¼šä½¿ç”¨C/C++æ¨¡å—æ‰©å±•æé«˜æ€§èƒ½ å»ºè®®91ï¼šä½¿ç”¨Cythonbç¼–å†™æ‰©å±•æ¨¡å—]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>ç¼–ç¨‹è§„èŒƒ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŠ€æœ¯å‘¨åˆŠä¹‹åŸºäºŽbeego webæ¡†æž¶çš„RESTful APIçš„æž„å»ºä¹‹æ—…]]></title>
    <url>%2F2018%2F10%2F14%2F%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E5%9F%BA%E4%BA%8Ebeego-web%E6%A1%86%E6%9E%B6%E7%9A%84RESTful-API%E7%9A%84%E6%9E%84%E5%BB%BA%E4%B9%8B%E6%97%85%2F</url>
    <content type="text"><![CDATA[å‰è¨€â€‹ beegoæ˜¯ä¸€ä¸ªå¿«é€Ÿå¼€å‘GOåº”ç”¨çš„httpæ¡†æž¶ï¼Œä½œè€…æ˜¯goè¯­è¨€æ–¹å‘çš„å¤§ç‰›ï¼Œastaxieã€‚beegoå¯ä»¥ç”¨æ¥å¿«é€Ÿå¼€å‘APIã€webã€åŽç«¯æœåŠ¡ç­‰åº”ç”¨ï¼Œæ˜¯ä¸€ä¸ªRESTFulé£Žæ ¼çš„æ¡†æž¶ï¼Œä¸»è¦çš„è®¾è®¡çµæ„Ÿæ¥è‡ªäºŽPython webå¼€å‘æ¡†æž¶tornadoã€flaskã€sinstraï¼Œå¾ˆå¥½çš„ç»“åˆäº†Goè¯­è¨€æœ¬èº«çš„ä¸€äº›ç‰¹æ€§ï¼ˆinterfaceï¼Œstructç»§æ‰¿ç­‰ï¼‰ã€‚ â€‹ beegoæ˜¯åŸºäºŽå…«å¤§ç‹¬ç«‹æ¨¡å—æ¥å®žçŽ°çš„ï¼Œå¾ˆå¥½çš„å®žçŽ°äº†æ¨¡å—é—´çš„è§£è€¦ï¼Œå³ä½¿ç”¨æˆ·ä¸ä½¿ç”¨httpçš„é€»è¾‘ï¼Œä¹Ÿå¯ä»¥å¾ˆå¥½çš„ä½¿ç”¨å…¶ä¸­çš„å„ä¸ªæ¨¡å—ã€‚ä½œè€…è‡ªå·±è¯´ï¼Œä»–çš„è¿™ç§æ€æƒ³æ¥è‡ªäºŽä¹é«˜ç§¯æœ¨ï¼Œè®¾è®¡beegoçš„æ—¶å€™ï¼Œè¿™äº›æ¨¡å—å°±æ˜¯ç§¯æœ¨ï¼Œè€Œæœ€ç»ˆæ­å»ºå¥½çš„æœºå™¨äººå°±æ˜¯beegoã€‚ â€‹ è¿™ç¯‡åšæ–‡é€šè¿‡ä½¿ç”¨beegoæ¥æž„å»ºAPIï¼Œè®²è§£å®žçŽ°è¿‡ç¨‹ä¸­çš„ç»†èŠ‚ä»¥åŠé‡åˆ°çš„ä¸€äº›å‘ï¼Œè®©æˆ‘ä»¬é©¬ä¸Šå¼€å§‹beegoçš„APIæž„å»ºä¹‹æ—…å§ï¼ é¡¹ç›®åˆ›å»º è¿›å…¥åˆ°ä½ çš„$GOPATH/src å®‰è£…beegoå¼€å‘åŒ…è‡ªå·±å¿«é€Ÿå¼€å‘å·¥å…·bee 123go get github.com/astaxie/beegogo get github.com/astaxie/beego/ormgo get github.com/beego/bee ä½¿ç”¨å¿«é€Ÿå¼€å‘å·¥å…·beeï¼Œåˆ›å»ºæˆ‘ä»¬çš„APIé¡¹ç›® 1bee new firstAPI æˆ‘ä»¬å¾—åˆ°çš„é¡¹ç›®ç»“æž„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š å¯ä»¥çœ‹å‡ºè¿™æ˜¯ä¸€ä¸ªå…¸åž‹çš„MVCæž¶æž„çš„åº”ç”¨ï¼ŒbeegoæŠŠæˆ‘ä»¬é¡¹ç›®æ‰€éœ€è¦çš„ä¸€äº›éƒ½å‡†å¤‡å¥½äº†ï¼Œä¾‹å¦‚é…ç½®æ–‡ä»¶confï¼Œæµ‹è¯•æ–‡ä»¶testsç­‰ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸“æ³¨äºŽAPIä»£ç çš„ç¼–å†™å³å¯ã€‚ è¿è¡Œé¡¹ç›®å¹¶èŽ·å¾—APIè‡ªåŠ¨åŒ–æ–‡æ¡£1bee run -gendoc=true -downdoc=true è¿è¡Œä¸Šè¿°ä»£ç è¾“å‡ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­è®¿é—®ï¼šæœ¬æœºIPï¼š8080/swaggerï¼Œå°±ä¼šçœ‹åˆ°swaggerçš„APIæ–‡æ¡£ï¼Œæˆ‘ä»¬ä»£ç æ›´æ–°åŽï¼Œè¯¥æ–‡æ¡£å°±ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œéžå¸¸æ–¹ä¾¿ã€‚ modelsè®¾è®¡ å¯¹ æ•°æ®åº“object æ“ä½œæœ‰å››ä¸ªæ–¹æ³• Read / Insert / Update / Delete 1234567891011ç¤ºä¾‹ä»£ç ï¼šo := orm.NewOrm()user := new(User)user.Name = "slene"fmt.Println(o.Insert(user))user.Name = "Your"fmt.Println(o.Update(user))fmt.Println(o.Read(user))fmt.Println(o.Delete(user)) è¿˜æœ‰å…¶ä»–çš„æ–¹æ³•å¯ä»¥å‚é˜…beegoå®˜æ–¹æ–‡æ¡£ï¼Œé‡Œé¢å¯¹ormæ“ä½œæœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚ åˆ›å»ºä¸€ä¸ªæ•°æ®åº“å¹¶è®¾è®¡ä¸€å¼ æ•°æ®åº“è¡¨ 1234567CREATE TABLE IF NOT EXISTS `student` (`Id` int(11),`Name` varchar(255),`Birthdate` varchar(255),`Gender` bool,`Score` int(11)) ENGINE=InnoDB DEFAULT CHARSET=utf8; åœ¨modelsæ–‡ä»¶å¤¹ä¸‹æ–°å»ºä¸€ä¸ªæ–‡ä»¶Student.go,å¹¶å®žçŽ°ä»¥ä¸‹ä»£ç ï¼Œä»£ç ä¸­å…³é”®ç‚¹éƒ½æœ‰æ³¨é‡Š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172package modelsimport ( "fmt" "github.com/astaxie/beego/orm")//åœ¨modelsæ¨¡å—ä¸­åˆ›å»ºä¸€ä¸ªstructï¼Œç›®çš„æ˜¯ä½¿ç”¨beegoçš„ormæ¡†æž¶ï¼Œä½¿structä¸Žæ•°æ®åº“ä¸­çš„å­—æ®µäº§ç”Ÿå¯¹åº”å…³ç³»type Student struct &#123; Id int`orm:"column(Id)"` //column()æ‹¬å·ä¸­çš„å­—æ®µå°±æ˜¯åœ¨å®šä¹‰æ•°æ®åº“æ—¶çš„ç›¸åº”å­—æ®µï¼Œè¿™ä¸€æ®µå¿…é¡»ä¸¥æ ¼å¡«å†™ï¼Œä¸ç„¶åœ¨APIè¯»å†™æ•°æ®æ—¶å°±ä¼šå‡ºçŽ°è¯»ä¸åˆ°æˆ–è€…å†™ä¸è¿›åŽ»çš„é—®é¢˜ Name string `orm:"column(Name)"` BirthDate string `orm:"column(Birthdate)"` Gender bool `orm:"column(Gender)"` Score int `orm:"column(Score)"`&#125;//è¯¥å‡½æ•°èŽ·å¾—æ•°æ®åº“ä¸­æ‰€æœ‰studentçš„ä¿¡æ¯ï¼Œè¿”å›žå€¼æ˜¯ä¸€ä¸ªç»“æž„ä½“æ•°ç»„æŒ‡é’ˆfunc GetAllStudents() []*Student &#123; o := orm.NewOrm() //äº§ç”Ÿä¸€ä¸ªormå¯¹è±¡ o.Using("default") //è¿™å¥è¯çš„æ„æ€æ˜¯ä½¿ç”¨å®šä¹‰çš„é»˜è®¤æ•°æ®åº“ï¼Œä¸Žmain.goä¸­çš„orm.RegisterDataBase()å¯¹åº” var students []*Student //å®šä¹‰æŒ‡å‘ç»“æž„ä½“æ•°ç»„çš„æŒ‡é’ˆ q := o.QueryTable("student")//èŽ·å¾—ä¸€ä¸ªæ•°æ®åº“è¡¨çš„è¯·æ±‚ q.All(&amp;students)//å–åˆ°è¿™ä¸ªè¡¨ä¸­çš„æ‰€æœ‰æ•°æ® return students&#125;//è¯¥å‡½æ•°æ ¹æ®studentä¸­çš„Idï¼Œè¿”å›žè¯¥å­¦ç”Ÿçš„ä¿¡æ¯func GetStudentById(id int) Student &#123; u := Student&#123;Id:id&#125;//æ ¹æ®æ‰€ä¼ å…¥çš„Idå¾—åˆ°å¯¹åº”studentçš„å¯¹è±¡ o := orm.NewOrm()//new ä¸€ä¸ªormå¯¹è±¡ o.Using("default")//ä½¿ç”¨æœ€å¼€å§‹å®šä¹‰çš„defaultæ•°æ®åº“ err := o.Read(&amp;u)//è¯»å–Id=idçš„studentçš„ä¿¡æ¯ if err == orm.ErrNoRows &#123; fmt.Println("æŸ¥è¯¢ä¸åˆ°")//å¯¹åº”æ“ä½œï¼Œä¸ä¸€å®šæ˜¯print &#125; else if err == orm.ErrMissPK &#123; fmt.Println("æ²¡æœ‰ä¸»é”®") &#125; return u&#125;//æ·»åŠ ä¸€ä¸ªå­¦ç”Ÿçš„ä¿¡æ¯åˆ°æ•°æ®åº“ä¸­ï¼Œå‚æ•°æ˜¯æŒ‡å‘studentç»“æž„é¢˜çš„æŒ‡é’ˆfunc AddStudent(student *Student) Student &#123; o := orm.NewOrm() o.Using("default") o.Insert(student)//æ’å…¥æ•°æ®åº“ return *student&#125;func UpdateStudent(student *Student) &#123; o := orm.NewOrm() o.Using("default") o.Update(student)//æ›´æ–°è¯¥studentçš„ä¿¡æ¯&#125;func DeleteStudent(id int) &#123; o := orm.NewOrm() o.Using("default") o.Delete(&amp;Student&#123;Id:id&#125;)//åˆ é™¤å¯¹åº”idçš„studentçš„ä¿¡æ¯&#125;func init() &#123; orm.RegisterModel(new(Student))//å°†æ•°æ®åº“æ³¨å†Œåˆ°orm&#125; modelè¿™ä¸€å±‚ä¸»è¦æ˜¯å®šä¹‰structï¼Œå¹¶ä¸ºä¸Šå±‚ç¼–å†™è¯»å†™æ•°æ®åº“ã€‚å¤„ç†æ•°æ®çš„ä»£ç ã€‚ controllerå±‚å®žçŽ°åŸºäºŽ beego çš„ Controller è®¾è®¡ï¼Œåªéœ€è¦åŒ¿åç»„åˆ beego.Controller å°±å¯ä»¥äº†ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 123type xxxController struct &#123; beego.Controller&#125; beego.Controller å®žçŽ°äº†æŽ¥å£ beego.ControllerInterfaceï¼Œbeego.ControllerInterface å®šä¹‰äº†å¦‚ä¸‹å‡½æ•°ï¼š Init(ct *context.Context, childName string, app interface{}) è¿™ä¸ªå‡½æ•°ä¸»è¦åˆå§‹åŒ–äº† Contextã€ç›¸åº”çš„ Controller åç§°ï¼Œæ¨¡æ¿åï¼Œåˆå§‹åŒ–æ¨¡æ¿å‚æ•°çš„å®¹å™¨ Dataï¼Œapp å³ä¸ºå½“å‰æ‰§è¡Œçš„ Controller çš„ reflecttypeï¼Œè¿™ä¸ª app å¯ä»¥ç”¨æ¥æ‰§è¡Œå­ç±»çš„æ–¹æ³•ã€‚ Prepare() è¿™ä¸ªå‡½æ•°ä¸»è¦æ˜¯ä¸ºäº†ç”¨æˆ·æ‰©å±•ç”¨çš„ï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨ä¸‹é¢å®šä¹‰çš„è¿™äº› Method æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œç”¨æˆ·å¯ä»¥é‡å†™è¿™ä¸ªå‡½æ•°å®žçŽ°ç±»ä¼¼ç”¨æˆ·éªŒè¯ä¹‹ç±»ã€‚ Get() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ GETï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Get è¯·æ±‚ã€‚ Post() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ POSTï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Post è¯·æ±‚ã€‚ Delete() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ DELETEï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Delete è¯·æ±‚ã€‚ Put() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ PUTï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Put è¯·æ±‚. Head() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ HEADï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Head è¯·æ±‚ã€‚ Patch() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„ HTTP Method æ˜¯ PATCHï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Patch è¯·æ±‚. Options() å¦‚æžœç”¨æˆ·è¯·æ±‚çš„HTTP Methodæ˜¯OPTIONSï¼Œé‚£ä¹ˆå°±æ‰§è¡Œè¯¥å‡½æ•°ï¼Œé»˜è®¤æ˜¯ 405ï¼Œç”¨æˆ·ç»§æ‰¿çš„å­ struct ä¸­å¯ä»¥å®žçŽ°äº†è¯¥æ–¹æ³•ä»¥å¤„ç† Options è¯·æ±‚ã€‚ Finish() è¿™ä¸ªå‡½æ•°æ˜¯åœ¨æ‰§è¡Œå®Œç›¸åº”çš„ HTTP Method æ–¹æ³•ä¹‹åŽæ‰§è¡Œçš„ï¼Œé»˜è®¤æ˜¯ç©ºï¼Œç”¨æˆ·å¯ä»¥åœ¨å­ struct ä¸­é‡å†™è¿™ä¸ªå‡½æ•°ï¼Œæ‰§è¡Œä¾‹å¦‚æ•°æ®åº“å…³é—­ï¼Œæ¸…ç†æ•°æ®ä¹‹ç±»çš„å·¥ä½œã€‚ Render() error è¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨æ¥å®žçŽ°æ¸²æŸ“æ¨¡æ¿ï¼Œå¦‚æžœ beego.AutoRender ä¸º true çš„æƒ…å†µä¸‹æ‰ä¼šæ‰§è¡Œã€‚ æ‰€ä»¥é€šè¿‡å­ struct çš„æ–¹æ³•é‡å†™ï¼Œç”¨æˆ·å°±å¯ä»¥å®žçŽ°è‡ªå·±çš„é€»è¾‘ã€‚ routerså±‚å®žçŽ°ä»€ä¹ˆæ˜¯è·¯ç”±è®¾ç½®å‘¢ï¼Ÿå‰é¢ä»‹ç»çš„ MVC ç»“æž„æ‰§è¡Œæ—¶ï¼Œä»‹ç»è¿‡ beego å­˜åœ¨ä¸‰ç§æ–¹å¼çš„è·¯ç”±:å›ºå®šè·¯ç”±ã€æ­£åˆ™è·¯ç”±ã€è‡ªåŠ¨è·¯ç”±ï¼Œä¸ŽRESTFul APIç›¸å…³çš„å°±æ˜¯å›ºå®šè·¯ç”±å’Œæ­£åˆ™è·¯ç”±ã€‚ ä¸‹é¢å°±æ˜¯å›ºå®šè·¯ç”±çš„ä¾‹å­ 1234beego.Router("/", &amp;controllers.MainController&#123;&#125;)beego.Router("/admin", &amp;admin.UserController&#123;&#125;)beego.Router("/admin/index", &amp;admin.ArticleController&#123;&#125;)beego.Router("/admin/addpkg", &amp;admin.AddController&#123;&#125;) ä¸‹é¢æ˜¯æ­£åˆ™è·¯ç”±çš„ä¾‹å­ï¼š beego.Router(â€œ/api/?:idâ€, &amp;controllers.RController{}) é»˜è®¤åŒ¹é… //ä¾‹å¦‚å¯¹äºŽURLâ€/api/123â€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:idâ€å€¼ä¸ºâ€123â€ beego.Router(â€œ/api/:idâ€, &amp;controllers.RController{}) é»˜è®¤åŒ¹é… //ä¾‹å¦‚å¯¹äºŽURLâ€/api/123â€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:idâ€å€¼ä¸ºâ€123â€ï¼Œä½†URLâ€/api/â€œåŒ¹é…å¤±è´¥ beego.Router(â€œ/api/:id([0-9]+)â€œ, &amp;controllers.RController{}) è‡ªå®šä¹‰æ­£åˆ™åŒ¹é… //ä¾‹å¦‚å¯¹äºŽURLâ€/api/123â€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:idâ€å€¼ä¸ºâ€123â€ beego.Router(â€œ/user/:username([\w]+)â€œ, &amp;controllers.RController{}) æ­£åˆ™å­—ç¬¦ä¸²åŒ¹é… //ä¾‹å¦‚å¯¹äºŽURLâ€/user/astaxieâ€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:usernameâ€å€¼ä¸ºâ€astaxieâ€ beego.Router(â€œ/download/.â€, &amp;controllers.RController{}) *åŒ¹é…æ–¹å¼ //ä¾‹å¦‚å¯¹äºŽURLâ€/download/file/api.xmlâ€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:pathâ€å€¼ä¸ºâ€file/apiâ€ï¼Œ â€œ:extâ€å€¼ä¸ºâ€xmlâ€ beego.Router(â€œ/download/ceshi/*â€œ, &amp;controllers.RController{}) *å…¨åŒ¹é…æ–¹å¼ //ä¾‹å¦‚å¯¹äºŽURLâ€/download/ceshi/file/api.jsonâ€å¯ä»¥åŒ¹é…æˆåŠŸï¼Œæ­¤æ—¶å˜é‡â€:splatâ€å€¼ä¸ºâ€file/api.jsonâ€ beego.Router(â€œ/:id:intâ€, &amp;controllers.RController{}) int ç±»åž‹è®¾ç½®æ–¹å¼ï¼ŒåŒ¹é… :idä¸ºint ç±»åž‹ï¼Œæ¡†æž¶å¸®ä½ å®žçŽ°äº†æ­£åˆ™ ([0-9]+) beego.Router(â€œ/:hi:stringâ€, &amp;controllers.RController{}) string ç±»åž‹è®¾ç½®æ–¹å¼ï¼ŒåŒ¹é… :hi ä¸º string ç±»åž‹ã€‚æ¡†æž¶å¸®ä½ å®žçŽ°äº†æ­£åˆ™ ([\w]+) beego.Router(â€œ/cms_:id([0-9]+).htmlâ€, &amp;controllers.CmsController{}) å¸¦æœ‰å‰ç¼€çš„è‡ªå®šä¹‰æ­£åˆ™ //åŒ¹é… :id ä¸ºæ­£åˆ™ç±»åž‹ã€‚åŒ¹é… cms_123.html è¿™æ ·çš„ url :id = 123 ä¸ªäººè§‰å¾—ï¼Œæœ€æ–¹ä¾¿çš„è¿˜æ˜¯ç±»ä¼¼äºŽPythonæ¡†æž¶flaskçš„æ³¨è§£è·¯ç”±ï¼Œä¹Ÿæ˜¯åœ¨è¿™ä¸ªé¡¹ç›®ä¸­ä½¿ç”¨çš„ï¼š åœ¨routers/routers.goé‡Œé¢æ·»åŠ ä½ æ‰€å¸Œæœ›çš„API 12345678910111213141516171819202122232425262728package routersimport ( "firstAPI/controllers" "github.com/astaxie/beego")func init() &#123; ns := beego.NewNamespace("/v1", beego.NSNamespace("/object", beego.NSInclude( &amp;controllers.ObjectController&#123;&#125;, ), ), beego.NSNamespace("/user", beego.NSInclude( &amp;controllers.UserController&#123;&#125;, ), ), beego.NSNamespace("/student", beego.NSInclude( &amp;controllers.StudentController&#123;&#125;, ), ), ) beego.AddNamespace(ns)&#125; ä»¥ä¸Šä»£ç å®žçŽ°äº†å¦‚ä¸‹çš„APIï¼š /v1/object /v1/user /v1/student éžå¸¸æ¸…æ™°æ˜Žäº†ã€‚ main.goçš„æ•°æ®åº“é…ç½®1234567891011121314151617181920212223package mainimport ( _ "firstAPI/routers" "github.com/astaxie/beego" "github.com/astaxie/beego/orm" _ "github.com/go-sql-driver/mysql")func init() &#123; orm.RegisterDriver("mysql", orm.DRMySQL)//æ³¨å†ŒMySQLçš„driver orm.RegisterDataBase("default", "mysql", "root:test@tcp(127.0.0.1:3306)/restapi_test?charset=utf8")//æœ¬åœ°æ•°æ®åº“çš„è´¦å·ã€‚å¯†ç ç­‰ orm.RunSyncdb("default", false, true)&#125;func main() &#123; if beego.BConfig.RunMode == "dev" &#123; beego.BConfig.WebConfig.DirectoryIndex = true beego.BConfig.WebConfig.StaticDir["/swagger"] = "swagger"//é™æ€æ–‡æ¡£ &#125; beego.Run()&#125; å…³é”®ç‚¹éƒ½åœ¨ä»£ç ä¸­ä»¥æ³¨é‡Šçš„å½¢å¼å±•çŽ°ã€‚ postmanæµ‹è¯•bee run è¿è¡Œä»£ç åŽï¼Œæˆ‘ä»¬ä½¿ç”¨postmanæµ‹è¯•ä¸€ä¸‹æˆ‘ä»¬æ‰€æž„å»ºçš„APIæ•ˆæžœå¦‚ä½•ã€‚ è¿™é‡ŒèŠ‚çœç¯‡å¹…ï¼Œåªæµ‹è¯•ä¸€ä¸ªæŽ¥å£ã€‚ åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬åŸºäºŽbeegoå°±å®žçŽ°äº†ç®€å•APIæŽ¥å£çš„æž„å»ºï¼Œæ˜¯ä¸æ˜¯æ—¢æ¸…æ™°åˆç®€å•å‘¢ï¼Ÿèµ¶å¿«è‡ªå·±åŠ¨æ‰‹è¯•è¯•å§ï¼ æœ¬æœŸæŠ€æœ¯å‘¨åˆŠç»“æŸï¼Œä»£ç å·²ä¸Šä¼ åˆ°GitHubï¼Œå¯ä»¥æŸ¥é˜…ï¼Œæˆ‘ä»¬ä¸‹æœŸå†ä¼šï¼]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>golang beego</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æ€»ç»“ç‰ˆå›¾è§£http]]></title>
    <url>%2F2018%2F10%2F12%2F%E6%80%BB%E7%BB%93%E7%89%88%E5%9B%BE%E8%A7%A3http%2F</url>
    <content type="text"><![CDATA[è¯¥åšå®¢è½¬è½½è‡ªå…¬ä¼—å·freeCodeCamp ä½œä¸ºä¸€ä¸ªå‰ç«¯ï¼Œå¦‚æžœå¯¹ä¸€ä¸ªç½‘é¡µä»Žå‘èµ·è¯·æ±‚åˆ°è¿”å›žæ•°æ®è¿™æœŸé—´å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆéƒ½ä¸çŸ¥é“çš„è¯ï¼Œé‚£ä¸æ˜¯ä¸€ä¸ªå¥½å‰ç«¯ã€‚æœ€è¿‘ï¼Œè¯»äº†å›¾è§£httpï¼Œä»¥åŠæœ‰å…³httpç›¸å…³çš„æ–‡ç« ï¼Œè¿˜æœ‰è‡ªå·±ä¹Ÿä¸‹è½½äº†wiresharkæŠ“åŒ…å·¥å…·ï¼Œå®žé™…è§‚å¯Ÿäº†ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹ï¼Œä¸‹é¢å°±æ­¤åšäº›æ€»ç»“ã€‚ ä¸€.ä»Žè¾“å…¥ä¸€ä¸ªurlåˆ°è¿”å›žæ•°æ®ï¼Œä¸­é—´åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ å‡è®¾ï¼Œæˆ‘ä»¬åœ¨æµè§ˆå™¨è¾“å…¥http://www.baidu.com:80/index.htmlï¼Œå‡è®¾è§£æžå‡ºçš„ipåœ°å€æ˜¯202.43.78.3 1.æµè§ˆå™¨è§£æžå‡ºä¸»æœºå è§£æžå‡ºçš„ä¸»æœºåæ˜¯www.baidu.com 2.æµè§ˆå™¨æŸ¥è¯¢è¿™ä¸ªä¸»æœºåçš„ipåœ°å€ï¼ˆdnsï¼‰ dnsè§£æžçš„ä½œç”¨å°±æ˜¯æŠŠåŸŸåè§£æžæˆipåœ°å€ï¼Œè¿™æ ·æ‰èƒ½åœ¨å¹¿åŸŸç½‘è·¯ç”±å™¨è½¬å‘æŠ¥æ–‡ç»™ç›®æ ‡ipï¼Œä¸ç„¶è·¯ç”±å™¨ä¸çŸ¥é“è¦æŠŠæŠ¥æ–‡å‘ç»™è°ã€‚ä¸‹é¢å°±è®²ä¸‹å¤§æ¦‚çš„è¿‡ç¨‹ï¼Œä¸ä¼šæ¶‰åŠå¤ªå¤šç»†èŠ‚ã€‚ï¼ˆä»¥chromeä¸ºä¾‹å­ï¼‰ ï¼ˆ1ï¼‰æµè§ˆå™¨å¯åŠ¨æ—¶ï¼Œé¦–å…ˆæµè§ˆå™¨ä¼šåŽ»æ“ä½œç³»ç»ŸèŽ·å–dnsæœåŠ¡å™¨åœ°å€ï¼Œç„¶åŽæŠŠè¿™ä¸ªåœ°å€ç¼“å­˜ä¸‹æ¥ã€‚åŒæ—¶æµè§ˆå™¨è¿˜ä¼šåŽ»è¯»å–å’Œè§£æžhostsæ–‡ä»¶ï¼ŒåŒæ ·æ”¾åˆ°ç¼“å­˜ä¸­ã€‚æµè§ˆå™¨å¯¹è§£æžè¿‡çš„åŸŸåå’Œipåœ°å€ï¼Œéƒ½ä¼šä¿å­˜ç€è¿™ä¸¤è€…çš„æ˜ å°„å…³ç³»ã€‚ï¼ˆå­˜åˆ°cacheä¸­ï¼‰ ï¼ˆ2ï¼‰å½“è§£æžåŸŸåçš„æ—¶å€™ï¼Œé¦–å…ˆæµè§ˆå™¨ä¼šåŽ»cacheä¸­æŸ¥æ‰¾æœ‰æ²¡æœ‰ç¼“å­˜å¥½çš„æ˜ å°„å…³ç³»ï¼Œå¦‚æžœæ²¡æœ‰çš„è¯ï¼Œå°±åŽ»hostsæ–‡ä»¶ä¸­æŸ¥æ‰¾ï¼Œå¦‚æžœä¹Ÿæ²¡æœ‰çš„è¯ï¼Œæµè§ˆå™¨å°±ä¼šå‘èµ·è¯·æ±‚åŽ»dnsæœåŠ¡å™¨ç¼“å­˜æŸ¥è¯¢äº†ï¼Œå¦‚æžœç¼“å­˜é‡Œé¢ä¹Ÿæ²¡æœ‰ï¼Œé‚£æœ€åŽå°±æ˜¯dnsæœåŠ¡å™¨åŽ»æŸ¥è¯¢äº†ã€‚ 3.æµè§ˆå™¨èŽ·å–ç«¯å£å· 4.æµè§ˆå™¨å‘ç›®æ ‡ipåœ°å€å‘èµ·ä¸€æ¡åˆ°202.43.78.3:80çš„tcpè¿žæŽ¥ ä¸ºäº†ä¼ è¾“çš„å¯é æ€§ï¼Œtcpåè®®è¦æœ‰ä¸‰æ¬¡æ¡æ‰‹è¿‡ç¨‹ï¼š ï¼ˆ1ï¼‰é¦–å…ˆæµè§ˆå™¨ä¼šå‘æœåŠ¡å™¨å‘èµ·ä¸€ä¸ªè¿žæŽ¥è¯·æ±‚ ï¼ˆ2ï¼‰æœåŠ¡å™¨ä¼šå¯¹è¿žæŽ¥è¯·æ±‚åšå‡ºå“åº”ï¼Œè¡¨ç¤ºåŒæ„å»ºç«‹è¿žæŽ¥ ï¼ˆ3ï¼‰æµè§ˆå™¨æ”¶åˆ°å“åº”åŽï¼Œå†å‘ŠçŸ¥å¯¹æ–¹ï¼Œå®ƒçŸ¥é“æœåŠ¡å™¨åŒæ„å®ƒå»ºç«‹è¿žæŽ¥äº†ã€‚ 5.æ•°æ®åŒ…åœ¨ipå±‚ä¼ è¾“ æ•°æ®åŒ…åœ¨ipå±‚ä¼ è¾“ï¼Œé€šè¿‡å¤šå°è®¡ç®—æœºå’Œç½‘ç»œè®¾å¤‡ä¸­è½¬ï¼Œåœ¨ä¸­è½¬æ—¶ï¼Œåˆ©ç”¨ä¸­è½¬è®¾å¤‡çš„macåœ°å€æœç´¢ä¸‹ä¸€ä¸ªä¸­è½¬ç›®æ ‡ï¼ˆé‡‡ç”¨ARPåè®®ï¼Œæ ¹æ®é€šä¿¡æ–¹çš„ipåœ°å€å°±å¯ä»¥åæŸ¥å‡ºå¯¹åº”çš„macåœ°å€ï¼‰ï¼Œç›´åˆ°ç›®æ ‡ipåœ°å€ã€‚ 6.æ•°æ®é“¾è·¯å±‚å¤„ç†ç½‘ç»œè¿žæŽ¥çš„ç¡¬ä»¶éƒ¨åˆ† æ•°æ®é“¾è·¯å±‚å¤„ç†ç½‘ç»œè¿žæŽ¥çš„ç¡¬ä»¶éƒ¨åˆ†ï¼Œæ¯”å¦‚ç½‘å¡ï¼Œæ‰¾åˆ°æœåŠ¡å™¨çš„ç½‘å¡ 7.æµè§ˆå™¨å‘æœåŠ¡å™¨å‘é€ä¸€æ¡httpæŠ¥æ–‡ æ¯ä¸€æ¡httpæŠ¥æ–‡çš„ç»„æˆï¼š èµ·å§‹è¡Œ+é¦–éƒ¨+ä¸»ä½“(å¯é€‰) èµ·å§‹è¡Œï¼šhttp/1.0 200 ok (ä¸€èˆ¬åŒ…æ‹¬httpç‰ˆæœ¬ï¼Œè¿”å›žçŠ¶æ€ç ï¼Œè¿”å›žç åŽŸå› ) é¦–éƒ¨ï¼šcontent-type:text/plain content-length:19 ä¸»ä½“ï¼šname=jane 8.æœåŠ¡å™¨æŽ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œè¿›è¡Œä¸€äº›å¤„ç†ï¼Œè¿”å›žå“åº”æŠ¥æ–‡ webæœåŠ¡å™¨æŽ¥æ”¶åˆ°è¯·æ±‚ä¹‹åŽï¼Œå®žé™…ä¸Šä¼šåšäº›ä»€ä¹ˆå‘¢ï¼Ÿ ï¼ˆ1ï¼‰å»ºç«‹è¿žæŽ¥ï¼Œå¦‚æžœæŽ¥å—ä¸€ä¸ªå®¢æˆ·ç«¯è¿žæŽ¥ï¼Œå°±å»ºç«‹è¿žæŽ¥ï¼Œå¦‚æžœä¸åŒæ„ï¼Œå°±å°†å…¶å…³é—­ã€‚ ï¼ˆ2ï¼‰æŽ¥æ”¶è¯·æ±‚ï¼Œè¯»å–httpè¯·æ±‚æŠ¥æ–‡ ï¼ˆ3ï¼‰è®¿é—®èµ„æºï¼Œè®¿é—®æŠ¥æ–‡ä¸­æŒ‡å®šçš„èµ„æº ï¼ˆ4ï¼‰æž„å»ºå“åº”ï¼Œåˆ›å»ºå¸¦æœ‰é¦–éƒ¨çš„httpå“åº”æŠ¥æ–‡ ï¼ˆ5ï¼‰å‘é€å“åº”ï¼Œå°†å“åº”å›žé€ç»™å®¢æˆ·ç«¯ 9.æµè§ˆå™¨è¯»å–httpå“åº”æŠ¥æ–‡ 10.æµè§ˆå™¨å…³é—­è¿žæŽ¥ çœ‹äº†ä¸Šé¢çš„ä¸€ä¸ªç®€å•è¿‡ç¨‹ï¼Œå¤§å®¶ä¼šä¸ä¼šæœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼Œéš¾é“æ¯æ¬¡å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ï¼Œéƒ½è¦å»ºç«‹ä¸€æ¬¡tcpè¿žæŽ¥å—ï¼Œæˆ‘ä»¬ç»å¸¸å†™çš„å¹¶å‘ajaxè¯·æ±‚ï¼Œæ¯æ¡è¯·æ±‚éƒ½æ˜¯å„è‡ªç‹¬ç«‹å»ºç«‹çš„tcpè¿žæŽ¥ï¼Ÿä¸€æ¡tcpè¿žæŽ¥å»ºç«‹ä¹‹åŽï¼Œæ˜¯ä»€ä¹ˆæ—¶å€™å…³é—­çš„ï¼Ÿå¸¦ç€è¿™äº›é—®é¢˜ï¼Œçœ‹çœ‹ä¸‹é¢è¦è®²çš„httpçš„ç‰¹æ€§ äºŒ.httpçš„ç‰¹æ€§ 1.httpæ˜¯ä¸ä¿å­˜çŠ¶æ€çš„åè®® httpåè®®æ˜¯ä¸€ç§æ— çŠ¶æ€çš„åè®®ï¼Œæ„æ€å°±æ˜¯è¯´å®ƒä¸ä¼šå¯¹æ¯æ¬¡çš„è¯·æ±‚å’Œå“åº”ä¹‹é—´çš„é€šä¿¡çŠ¶æ€è¿›è¡Œä¿å­˜ã€‚ä½ ä¹‹å‰å‘è¿‡çš„ä»»ä½•è¯·æ±‚çš„ä¿¡æ¯ï¼Œæ²¡æœ‰ä»»ä½•è®°å½•ã€‚ä¹‹æ‰€ä»¥è¿™æ ·è®¾è®¡ï¼Œä¹Ÿæ˜¯ä¸ºäº†è®©httpå˜å¾—æ¯”è¾ƒç®€å•ï¼Œå¯ä»¥å¤„ç†å¤§é‡äº‹ç‰©ã€‚ä½†æ˜¯æ— çŠ¶æ€çš„ç‰¹æ€§ï¼Œä¹Ÿä¼šå¯¼è‡´ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚è¯´ä¸€ä¸ªç”¨æˆ·ç™»å½•ä¸€å®¶ç½‘ç«™ä¹‹åŽï¼Œè·³åˆ°å¦ä¸€ä¸ªé¡µé¢ï¼Œåº”è¯¥è¿˜ä¿æŒç€ç™»å½•çŠ¶æ€ï¼Œæ‰€ä»¥åŽé¢å°±å‡ºäº†cookieçŠ¶æ€ç®¡ç†æŠ€æœ¯ã€‚ç›¸ä¿¡å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰äº†ã€‚ 2.è¯·æ±‚åªèƒ½ä»Žå®¢æˆ·ç«¯å¼€å§‹ï¼Œå®¢æˆ·ç«¯ä¸å¯ä»¥æŽ¥æ”¶é™¤å“åº”ä»¥å¤–çš„æŒ‡ä»¤ æœåŠ¡å™¨å¿…é¡»ç­‰å¾…å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œæ‰èƒ½ç»™å®¢æˆ·ç«¯å‘é€å“åº”æ•°æ®ï¼Œæ‰€ä»¥è¯´æœåŠ¡å™¨æ˜¯ä¸èƒ½ä¸»åŠ¨ç»™å®¢æˆ·ç«¯æŽ¨é€æ•°æ®çš„ã€‚å¯¹äºŽä¸€äº›å®žæ—¶ç›‘æŽ§çš„åŠŸèƒ½ï¼Œå¸¸å¸¸ç”¨websocketæ¥ä»£æ›¿ 3.æ²¡æœ‰ç”¨æˆ·è®¤è¯ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‘èµ·è¯·æ±‚ åœ¨httpåè®®é€šä¿¡æ—¶ï¼Œæ˜¯ä¸å­˜åœ¨ç¡®è®¤é€šä¿¡æ–¹çš„å¤„ç†æ­¥éª¤çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥å‘èµ·è¯·æ±‚ã€‚å¦å¤–ï¼ŒæœåŠ¡å™¨åªè¦æ”¶åˆ°è¯·æ±‚ï¼Œæ— è®ºæ˜¯è°ï¼Œéƒ½ä¼šè¿”å›žä¸€ä¸ªå“åº”ã€‚æ‰€ä»¥ä¼šå­˜åœ¨ä¼ªè£…çš„éšæ‚£ã€‚åŽé¢å‡ºçŽ°çš„httpså°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚ 4.é€šä¿¡ä½¿ç”¨çš„æ˜¯æ˜Žæ–‡ 5.æ— æ³•è¯æ˜ŽæŠ¥æ–‡å®Œæ•´æ€§ 6.å¯ä»»æ„é€‰æ‹©æ•°æ®åŽ‹ç¼©æ ¼å¼ï¼Œéžå¼ºåˆ¶åŽ‹ç¼©å‘é€ 7.httpæŒä¹…è¿žæŽ¥å’Œå¹¶è¡Œè¿žæŽ¥ ä¸€å¼€å§‹ï¼Œhttpè¯·æ±‚æ˜¯ä¸²è¡Œçš„ï¼Œä¸€ä¸ªhttpè¯·æ±‚ï¼Œå°±ä¼šå»ºç«‹ä¸€æ¡tcpè¿žæŽ¥ï¼Œæµè§ˆå™¨æ”¶åˆ°å“åº”ä¹‹åŽï¼Œå°±ä¼šæ–­å¼€è¿žæŽ¥ã€‚ç­‰ä¸Šä¸€ä¸ªè¯·æ±‚å›žæ¥äº†ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚æ‰èƒ½ç»§ç»­è¯·æ±‚ã€‚è¿™æ ·åšçš„ç¼ºç‚¹æ˜¯ï¼Œæ¯”è¾ƒè€—æ—¶é—´å’Œå†…å­˜ï¼ŒåŽé¢å°±å‡ºçŽ°äº†ä¸‹é¢ä¸€ç³»åˆ—çš„ä¼˜åŒ–è¿žæŽ¥æ€§èƒ½çš„æ–¹æ³•ã€‚ ï¼ˆ1ï¼‰å¹¶è¡Œè¿žæŽ¥ åŽŸç†ï¼šé€šè¿‡å¤šæ¡tcpè¿žæŽ¥å‘èµ·å¹¶å‘çš„httpè¯·æ±‚ å¹¶è¡Œè¿žæŽ¥å¯ä»¥åŒæ—¶å‘èµ·å¤šä¸ªhttpè¯·æ±‚ï¼Œæ¯æ¬¡å‘èµ·ä¸€ä¸ªhttpè¯·æ±‚ï¼Œå°±ä¼šå»ºç«‹ä¸€ä¸ªtcpè¿žæŽ¥ã€‚æ¯ä¸ªhttpè¯·æ±‚æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šç›¸äº’ç­‰å¾…ï¼Œè¿™æ ·åšï¼Œå¾ˆå¯èƒ½ä¼šæé«˜é¡µé¢çš„åŠ è½½é€Ÿåº¦ï¼Œå› ä¸ºäººä»¬ä¼šçœ‹åˆ°é¡µé¢ä¸Šé¢ï¼Œå¾ˆå¤šä¸ªä¸œè¥¿ä¼šåŒæ—¶å‡ºçŽ°ï¼Œæ‰€ä»¥æ„Ÿè§‰é¡µé¢åŠ è½½å˜å¿«äº†ã€‚å®žé™…ä¸Šæœ‰æ—¶å€™æ˜¯çœŸçš„å˜å¿«äº†ï¼Œå› ä¸ºå®ƒæ˜¯å¹¶è¡Œå·¥ä½œçš„ã€‚ä½†æ˜¯æœ‰æ—¶å€™ä¸æ˜¯çœŸçš„å¿«äº†ã€‚æ¯”å¦‚è¯´ï¼Œå®¢æˆ·ç«¯çš„ç½‘ç»œå¸¦å®½ä¸è¶³æ—¶ï¼Œï¼ˆæµè§ˆå™¨æ˜¯é€šè¿‡ä¸€ä¸ª28kbpsçš„modemè¿žæŽ¥åˆ°å› ç‰¹ç½‘ä¸ŠåŽ»çš„ï¼‰ï¼Œå¦‚æžœå¹¶è¡ŒåŠ è½½å¤šä¸ªè¯·æ±‚ï¼Œæ¯ä¸ªè¯·æ±‚å°±ä¼šåŽ»ç«žäº‰è¿™ä¸ªæœ‰é™çš„å¸¦å®½ï¼Œæ¯ä¸ªè¯·æ±‚å°±ä¼šä»¥æ¯”è¾ƒæ…¢çš„é€Ÿåº¦åŠ è½½ã€‚è¿™æ ·å¸¦æ¥çš„æ€§èƒ½æå‡å°±å¾ˆå°ã€‚ ï¼ˆ2ï¼‰æŒä¹…è¿žæŽ¥ åŽŸç†ï¼šé‡ç”¨tcpè¿žæŽ¥ï¼Œä»¥æ¶ˆé™¤è¿žæŽ¥åŠå…³é—­æ—¶å»¶ ä»Žhttp1.1å¼€å§‹ï¼Œå°±å…è®¸å½“httpå“åº”ç»“æŸåŽï¼Œtcpè¿žæŽ¥å¯ä»¥ä¿æŒåœ¨æ‰“å¼€çŠ¶æ€ï¼Œä»¥ä¾¿ç»™æœªæ¥çš„httpè¯·æ±‚é‡ç”¨çŽ°åœ¨çš„è¿žæŽ¥ã€‚é‚£ä¹ˆï¼Œè¿™ä¸ªtcpè¿žæŽ¥ä»€ä¹ˆæ—¶å€™ä¼šå…³é—­å‘¢ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œ40så†…ï¼Œå¦‚æžœæ²¡æœ‰æ–°çš„è¯·æ±‚ï¼Œå°±ä¼šå…³é—­ã€‚ ï¼ˆ3ï¼‰ç®¡é“åŒ–è¿žæŽ¥ åŽŸç†ï¼šé€šè¿‡å…±äº«çš„tcpè¿žæŽ¥å‘èµ·å¹¶å‘çš„httpè¯·æ±‚ å¹¶è¡Œè¿žæŽ¥å¯ä»¥æé«˜å¤åˆé¡µé¢çš„ä¼ è¾“é€Ÿåº¦ï¼Œä½†æ˜¯ä¹Ÿæœ‰è®¸å¤šç¼ºç‚¹ï¼Œæ¯”å¦‚æ¯æ¬¡éƒ½ä¼šå»ºç«‹ä¸€æ¬¡tcpè¿žæŽ¥ï¼Œä¼šè€—è´¹æ—¶é—´å’Œå¸¦å®½ã€‚æŒä¹…è¿žæŽ¥çš„ä¼˜åŠ¿å°±æ˜¯é™ä½Žäº†æ—¶å»¶å’Œtcpçš„è¿žæŽ¥æ•°é‡ã€‚ä½†æ˜¯æŒä¹…è¿žæŽ¥å¯èƒ½ä¼šå¯¼è‡´çš„ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¯èƒ½ä¼šç´¯ç§¯å¤§é‡çš„ç©ºé—²è¿žæŽ¥ã€‚è€—è´¹èµ„æºã€‚ æŒä¹…è¿žæŽ¥å’Œå¹¶è¡Œè¿žæŽ¥é…åˆä½¿ç”¨æ‰æ˜¯æœ€é«˜æ•ˆçš„æ–¹å¼ã€‚ ä¸€èˆ¬æµè§ˆå™¨ä¼šé™åˆ¶ï¼ŒåŒä¸ªåŸŸåä¸‹çš„å¹¶è¡Œè¿žæŽ¥çš„ä¸ªæ•°æ˜¯4ä¸ªï¼Œå³æ‰“å¼€å°‘é‡çš„å¹¶è¡Œè¿žæŽ¥ï¼Œå…¶ä¸­æ¯ä¸ªéƒ½æ˜¯æŒä¹…è¿žæŽ¥ã€‚è¿™ä¹Ÿæ˜¯çŽ°åœ¨ç”¨çš„æœ€å¤šçš„æ–¹å¼ã€‚]]></content>
      <categories>
        <category>ç½‘ç»œ</category>
      </categories>
      <tags>
        <tag>ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python apscheduler - skipped: maximum number of running instances reached]]></title>
    <url>%2F2018%2F09%2F28%2Fpython-apscheduler-skipped-maximum-number-of-running-instances-reached%2F</url>
    <content type="text"><![CDATA[å‡ºçŽ°é—®é¢˜çš„ä»£ç 123scheduler = BackgroundScheduler()scheduler.add_job(runsync, 'interval', seconds=1)scheduler.start() é—®é¢˜å‡ºçŽ°çš„æƒ…å†µ è¿è¡Œä¸€æ®µä»£ç ï¼Œæ—¶è€ŒæŠ¥é”™æ—¶è€Œä¸æŠ¥é”™ æŠ¥é”™æ˜¯ï¼š 1WARNING:apscheduler.scheduler:Execution of job &quot;runsync (trigger: interval[0:00:01], next run at: 2015-12-01 11:50:42 UTC)&quot; skipped: maximum number of running instances reached (1) åˆ†æž apschedulerè¿™ä¸ªæ¨¡å—ï¼Œåœ¨ä½ çš„ä»£ç è¿è¡Œæ—¶é—´å¤§äºŽintervalçš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥é”™ ä¹Ÿå°±æ˜¯è¯´ï¼Œä½ çš„ä»£ç è¿è¡Œæ—¶é—´è¶…å‡ºäº†ä½ çš„å®šæ—¶ä»»åŠ¡çš„æ—¶é—´é—´éš”ã€‚ è§£å†³ å¢žå¤§æ—¶é—´é—´éš”å³å¯ ###]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python çš„loggingæ¨¡å—å®žçŽ°jsonæ ¼å¼çš„æ—¥å¿—è¾“å‡º]]></title>
    <url>%2F2018%2F09%2F27%2Fpython-%E7%9A%84logging%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0json%E6%A0%BC%E5%BC%8F%E7%9A%84%E6%97%A5%E5%BF%97%E8%BE%93%E5%87%BA%2F</url>
    <content type="text"><![CDATA[å‰è¨€ï¼š æƒ³è¦è®©å¼€å‘è¿‡ç¨‹æˆ–è€…æ˜¯ä¸Šçº¿åŽçš„bugæ— å¤„å¯è—ï¼Œæœ€å¥½çš„æ–¹å¼ä¾¿æ˜¯åœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¸æ–­æ”¶é›†é‡è¦çš„æ—¥å¿—ï¼Œä»¥ä¾›åˆ†æžä½¿ç”¨ã€‚Pythonä¸­å†…ç½®çš„logæ”¶é›†æ¨¡å—æ˜¯loggingï¼Œè¯¥æ¨¡å—ä½¿ç”¨èµ·æ¥æ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†æ˜¯ç¾Žä¸­ä¸è¶³çš„åœ°æ–¹å°±æ˜¯æ—¥å¿—çš„æ ¼å¼è½¬æˆjsonæ¯”è¾ƒéº»çƒ¦ã€‚äºŽæ˜¯æˆ‘ç»“åˆloggingå’Œå¦ä¸€ä¸ªæ¨¡å—python-json-logger(pip install python-json-logger) ï¼Œå®žçŽ°jsonæ ¼å¼çš„æ—¥å¿—è¾“å‡ºã€‚ æºç ï¼šä»¥ä¸‹ä»£ç å¯ä»¥åšæˆæ¨¡å—ï¼Œç›´æŽ¥å¯¼å…¥ä½¿ç”¨123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384import logging, logging.config, osimport structlogfrom structlog import configure, processors, stdlib, threadlocalfrom pythonjsonlogger import jsonloggerBASE_DIR = BASE_DIR = os.path.dirname(os.path.abspath(__file__))DEBUG = True # æ ‡è®°æ˜¯å¦åœ¨å¼€å‘çŽ¯å¢ƒ# ç»™è¿‡æ»¤å™¨ä½¿ç”¨çš„åˆ¤æ–­class RequireDebugTrue(logging.Filter): # å®žçŽ°filteræ–¹æ³• def filter(self, record): return DEBUGdef get_logger(): LOGGING = &#123; # åŸºæœ¬è®¾ç½® 'version': 1, # æ—¥å¿—çº§åˆ« 'disable_existing_loggers': False, # æ˜¯å¦ç¦ç”¨çŽ°æœ‰çš„è®°å½•å™¨ # æ—¥å¿—æ ¼å¼é›†åˆ 'formatters': &#123; # æ ‡å‡†è¾“å‡ºæ ¼å¼ 'json': &#123; # [å…·ä½“æ—¶é—´][çº¿ç¨‹å:çº¿ç¨‹ID][æ—¥å¿—åå­—:æ—¥å¿—çº§åˆ«åç§°(æ—¥å¿—çº§åˆ«ID)] [è¾“å‡ºçš„æ¨¡å—:è¾“å‡ºçš„å‡½æ•°]:æ—¥å¿—å†…å®¹ 'format': '[%(asctime)s][%(threadName)s:%(thread)d][%(name)s:%(levelname)s(%(lineno)d)]\n[%(module)s:%(funcName)s]:%(message)s', 'class': 'pythonjsonlogger.jsonlogger.JsonFormatter', &#125; &#125;, # è¿‡æ»¤å™¨ 'filters': &#123; 'require_debug_true': &#123; '()': RequireDebugTrue, &#125; &#125;, # å¤„ç†å™¨é›†åˆ 'handlers': &#123; # è¾“å‡ºåˆ°æŽ§åˆ¶å° # è¾“å‡ºåˆ°æ–‡ä»¶ 'TimeChecklog': &#123; 'level': 'DEBUG', 'class': 'logging.handlers.RotatingFileHandler', 'formatter': 'json', 'filename': os.path.join("./log/", 'TimeoutCheck.log'), # è¾“å‡ºä½ç½® 'maxBytes': 1024 * 1024 * 5, # æ–‡ä»¶å¤§å° 5M 'backupCount': 5, # å¤‡ä»½ä»½æ•° 'encoding': 'utf8', # æ–‡ä»¶ç¼–ç  &#125;, &#125;, # æ—¥å¿—ç®¡ç†å™¨é›†åˆ 'loggers': &#123; # ç®¡ç†å™¨ 'proxyCheck': &#123; 'handlers': ['TimeChecklog'], 'level': 'DEBUG', 'propagate': True, # æ˜¯å¦ä¼ é€’ç»™çˆ¶è®°å½•å™¨ &#125;, &#125; &#125; configure( logger_factory=stdlib.LoggerFactory(), processors=[ stdlib.render_to_log_kwargs] ) logging.config.dictConfig(LOGGING) logger = logging.getLogger("proxyCheck") return logger# æµ‹è¯•ç”¨ä¾‹ï¼Œä½ å¯ä»¥æŠŠget_logger()å°è£…æˆä¸€ä¸ªæ¨¡å—ï¼Œfrom xxx import get_logger()logger1 = get_logger()def test(): try: a = 1 / 0 except Exception as e: logger1.error(e) # å†™å…¥é”™è¯¯æ—¥å¿— #å¦‚æžœéœ€è¦æ·»åŠ é¢å¤–çš„ä¿¡æ¯ï¼Œä½¿ç”¨extraå…³é”®å­—å³å¯ logger1.error(e, extra=&#123;key1: value1, key2:value2&#125;) # å…¶ä»–é”™è¯¯å¤„ç†ä»£ç  passtest() ### æµ‹è¯•ç»“æžœ æµ‹è¯•çš„ç»“æžœï¼Œå¯ä»¥åœ¨./log/xxx.logæ–‡ä»¶ä¸­çœ‹åˆ°è¾“å‡ºçš„æ—¥å¿— 1&#123;&quot;asctime&quot;: &quot;2018-09-28 09:52:12,622&quot;, &quot;threadName&quot;: &quot;MainThread&quot;, &quot;thread&quot;: 4338656704, &quot;name&quot;: &quot;proxyCheck&quot;, &quot;levelname&quot;: &quot;ERROR&quot;, &quot;%(lineno&quot;: null, &quot;module&quot;: &quot;mylog&quot;, &quot;funcName&quot;: &quot;test&quot;, &quot;message&quot;: &quot;division by zero&quot;&#125; å¯ä»¥çœ‹åˆ°æ—¥å¿—æ˜¯jsonæ ¼å¼ï¼Œè¿™æ ·ä½ å°±å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä½¿ç”¨grafnaå’ŒESå°†æ—¥å¿—åšæˆçœ‹æ¿æ¥å±•ç¤ºäº†ã€‚]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python å‘é€å„ç§æ ¼å¼çš„é‚®ä»¶]]></title>
    <url>%2F2018%2F09%2F17%2Fpython-%E5%8F%91%E9%80%81%E5%90%84%E7%A7%8D%E6%A0%BC%E5%BC%8F%E7%9A%84%E9%82%AE%E4%BB%B6%2F</url>
    <content type="text"><![CDATA[12345678910111213141516171819202122232425262728293031323334353637383940414243import smtplibfrom email.mime.multipart import MIMEMultipartfrom email.mime.text import MIMETextfrom email.mime.application import MIMEApplication_user = "sigeken@qq.com"_pwd = "***"_to = "402363522@qq.com" #å¦‚åå­—æ‰€ç¤ºMultipartå°±æ˜¯åˆ†å¤šä¸ªéƒ¨åˆ†msg = MIMEMultipart()msg["Subject"] = "don't panic"msg["From"] = _usermsg["To"] = _to #---è¿™æ˜¯æ–‡å­—éƒ¨åˆ†---part = MIMEText("ä¹”è£…æ‰“æ‰®ï¼Œä¸æ‹©æ‰‹æ®µ")msg.attach(part) #---è¿™æ˜¯é™„ä»¶éƒ¨åˆ†---#xlsxç±»åž‹é™„ä»¶part = MIMEApplication(open('foo.xlsx','rb').read())part.add_header('Content-Disposition', 'attachment', filename="foo.xlsx")msg.attach(part) #jpgç±»åž‹é™„ä»¶part = MIMEApplication(open('foo.jpg','rb').read())part.add_header('Content-Disposition', 'attachment', filename="foo.jpg")msg.attach(part) #pdfç±»åž‹é™„ä»¶part = MIMEApplication(open('foo.pdf','rb').read())part.add_header('Content-Disposition', 'attachment', filename="foo.pdf")msg.attach(part) #mp3ç±»åž‹é™„ä»¶part = MIMEApplication(open('foo.mp3','rb').read())part.add_header('Content-Disposition', 'attachment', filename="foo.mp3")msg.attach(part) s = smtplib.SMTP("smtp.qq.com", timeout=30)#è¿žæŽ¥smtpé‚®ä»¶æœåŠ¡å™¨,ç«¯å£é»˜è®¤æ˜¯25s.login(_user, _pwd)#ç™»é™†æœåŠ¡å™¨s.sendmail(_user, _to, msg.as_string())#å‘é€é‚®ä»¶s.close()]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŠ€æœ¯å‘¨åˆŠä¹‹å½“ä½ pingçš„æ—¶å€™ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ]]></title>
    <url>%2F2018%2F09%2F16%2F%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E5%BD%93%E4%BD%A0ping%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%8C%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F%2F</url>
    <content type="text"><![CDATA[æˆ‘ä»¬åœ¨é‡åˆ°ç½‘ç»œä¸é€šçš„æƒ…å†µï¼Œå¤§å®¶éƒ½çŸ¥é“åŽ» ping ä¸€ä¸‹ï¼Œçœ‹ä¸€ä¸‹ç½‘ç»œçŠ¶å†µã€‚é‚£ä½ çŸ¥é“ã€Œpingã€å‘½ä»¤åŽèƒŒçš„é€»è¾‘æ˜¯ä»€ä¹ˆå—ï¼ŸçŸ¥é“å®ƒæ˜¯å¦‚ä½•å®žçŽ°çš„å—ï¼Ÿæœ¬å‘¨å°±è®©æˆ‘ä»¬æ·±å…¥æµ…å‡ºpingçš„æœºåˆ¶ã€‚ pingçš„ä½œç”¨å’ŒåŽŸç†ç®€å•æ¥è¯´ï¼Œã€Œpingã€æ˜¯ç”¨æ¥æŽ¢æµ‹æœ¬æœºä¸Žç½‘ç»œä¸­å¦ä¸€ä¸»æœºä¹‹é—´æ˜¯å¦å¯è¾¾çš„å‘½ä»¤ï¼Œå¦‚æžœä¸¤å°ä¸»æœºä¹‹é—´pingä¸é€šï¼Œåˆ™è¡¨æ˜Žè¿™ä¸¤å°ä¸»æœºä¸èƒ½å»ºç«‹èµ·è¿žæŽ¥ã€‚pingæ˜¯å®šä½ç½‘ç»œé€šä¸é€šçš„ä¸€ä¸ªé‡è¦æ‰‹æ®µã€‚ ping å‘½ä»¤æ˜¯åŸºäºŽ ICMP åè®®æ¥å·¥ä½œçš„ï¼Œã€Œ ICMP ã€å…¨ç§°ä¸º Internet æŽ§åˆ¶æŠ¥æ–‡åè®®ï¼ˆ Internet Control Message Protocolï¼‰ã€‚ping å‘½ä»¤ä¼šå‘é€ä¸€ä»½ICMPå›žæ˜¾è¯·æ±‚æŠ¥æ–‡ç»™ç›®æ ‡ä¸»æœºï¼Œå¹¶ç­‰å¾…ç›®æ ‡ä¸»æœºè¿”å›žICMPå›žæ˜¾åº”ç­”ã€‚å› ä¸ºICMPåè®®ä¼šè¦æ±‚ç›®æ ‡ä¸»æœºåœ¨æ”¶åˆ°æ¶ˆæ¯ä¹‹åŽï¼Œå¿…é¡»è¿”å›žICMPåº”ç­”æ¶ˆæ¯ç»™æºä¸»æœºï¼Œå¦‚æžœæºä¸»æœºåœ¨ä¸€å®šæ—¶é—´å†…æ”¶åˆ°äº†ç›®æ ‡ä¸»æœºçš„åº”ç­”ï¼Œåˆ™è¡¨æ˜Žä¸¤å°ä¸»æœºä¹‹é—´ç½‘ç»œæ˜¯å¯è¾¾çš„ã€‚ ä¸¾ä¸€ä¸ªä¾‹å­æ¥æè¿°ã€Œpingã€å‘½ä»¤çš„å·¥ä½œè¿‡ç¨‹ï¼š å‡è®¾æœ‰ä¸¤ä¸ªä¸»æœºï¼Œä¸»æœºAï¼ˆ192.168.0.1ï¼‰å’Œä¸»æœºBï¼ˆ192.168.0.2ï¼‰ï¼ŒçŽ°åœ¨æˆ‘ä»¬è¦ç›‘æµ‹ä¸»æœºAå’Œä¸»æœºBä¹‹é—´ç½‘ç»œæ˜¯å¦å¯è¾¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬åœ¨ä¸»æœºAä¸Šè¾“å…¥å‘½ä»¤ï¼šping 192.168.0.2 æ­¤æ—¶ï¼Œpingå‘½ä»¤ä¼šåœ¨ä¸»æœºAä¸Šæž„å»ºä¸€ä¸ª ICMPçš„è¯·æ±‚æ•°æ®åŒ…ï¼ˆæ•°æ®åŒ…é‡Œçš„å†…å®¹åŽé¢å†è¯¦è¿°ï¼‰ï¼Œç„¶åŽ ICMPåè®®ä¼šå°†è¿™ä¸ªæ•°æ®åŒ…ä»¥åŠç›®æ ‡IPï¼ˆ192.168.0.2ï¼‰ç­‰ä¿¡æ¯ä¸€åŒäº¤ç»™IPå±‚åè®®ã€‚ IPå±‚åè®®å¾—åˆ°è¿™äº›ä¿¡æ¯åŽï¼Œå°†æºåœ°å€ï¼ˆå³æœ¬æœºIPï¼‰ã€ç›®æ ‡åœ°å€ï¼ˆå³ç›®æ ‡IPï¼š192.168.0.2ï¼‰ã€å†åŠ ä¸Šä¸€äº›å…¶å®ƒçš„æŽ§åˆ¶ä¿¡æ¯ï¼Œæž„å»ºæˆä¸€ä¸ªIPæ•°æ®åŒ…ã€‚ IPæ•°æ®åŒ…æž„å»ºå®ŒæˆåŽï¼Œè¿˜ä¸å¤Ÿï¼Œè¿˜éœ€è¦åŠ ä¸ŠMACåœ°å€ï¼Œå› æ­¤ï¼Œè¿˜éœ€è¦é€šè¿‡ARPæ˜ å°„è¡¨æ‰¾å‡ºç›®æ ‡IPæ‰€å¯¹åº”çš„MACåœ°å€ã€‚å½“æ‹¿åˆ°äº†ç›®æ ‡ä¸»æœºçš„MACåœ°å€å’Œæœ¬æœºMACåŽï¼Œä¸€å¹¶äº¤ç»™æ•°æ®é“¾è·¯å±‚ï¼Œç»„è£…æˆä¸€ä¸ªæ•°æ®å¸§ï¼Œä¾æ®ä»¥å¤ªç½‘çš„ä»‹è´¨è®¿é—®è§„åˆ™ï¼Œå°†å®ƒä»¬ä¼ é€å‡ºå‡ºåŽ»ã€‚ å½“ä¸»æœºBæ”¶åˆ°è¿™ä¸ªæ•°æ®å¸§ä¹‹åŽï¼Œä¼šé¦–å…ˆæ£€æŸ¥å®ƒçš„ç›®æ ‡MACåœ°å€æ˜¯ä¸æ˜¯æœ¬æœºï¼Œå¦‚æžœæ˜¯å°±æŽ¥æ”¶ä¸‹æ¥å¤„ç†ï¼ŒæŽ¥æ”¶ä¹‹åŽä¼šæ£€æŸ¥è¿™ä¸ªæ•°æ®å¸§ï¼Œå°†æ•°æ®å¸§ä¸­çš„IPæ•°æ®åŒ…å–å‡ºæ¥ï¼Œäº¤ç»™æœ¬æœºçš„IPå±‚åè®®ï¼Œç„¶åŽIPå±‚åè®®æ£€æŸ¥å®Œä¹‹åŽï¼Œå†å°†ICMPæ•°æ®åŒ…å–å‡ºæ¥äº¤ç»™ICMPåè®®å¤„ç†ï¼Œå½“è¿™ä¸€æ­¥ä¹Ÿå¤„ç†å®Œæˆä¹‹åŽï¼Œå°±ä¼šæž„å»ºä¸€ä¸ªICMPåº”ç­”æ•°æ®åŒ…ï¼Œå›žå‘ç»™ä¸»æœºA åœ¨ä¸€å®šçš„æ—¶é—´å†…ï¼Œå¦‚æžœä¸»æœºAæ”¶åˆ°äº†åº”ç­”åŒ…ï¼Œåˆ™è¯´æ˜Žå®ƒä¸Žä¸»æœºBä¹‹é—´ç½‘ç»œå¯è¾¾ï¼Œå¦‚æžœæ²¡æœ‰æ”¶åˆ°ï¼Œåˆ™è¯´æ˜Žç½‘ç»œä¸å¯è¾¾ã€‚é™¤äº†ç›‘æµ‹æ˜¯å¦å¯è¾¾ä»¥å¤–ï¼Œè¿˜å¯ä»¥åˆ©ç”¨åº”ç­”æ—¶é—´å’Œå‘èµ·æ—¶é—´ä¹‹é—´çš„å·®å€¼ï¼Œè®¡ç®—å‡ºæ•°æ®åŒ…çš„å»¶è¿Ÿè€—æ—¶ã€‚ é€šè¿‡pingçš„æµç¨‹å¯ä»¥å‘çŽ°ï¼ŒICMPåè®®æ˜¯è¿™ä¸ªè¿‡ç¨‹çš„åŸºç¡€ï¼Œæ˜¯éžå¸¸é‡è¦çš„ï¼Œå› æ­¤ä¸‹é¢å°±æŠŠICMPåè®®å†è¯¦ç»†è§£é‡Šä¸€ä¸‹ã€‚ ICMPç®€ä»‹æˆ‘ä»¬çŸ¥é“ï¼Œpingå‘½ä»¤æ˜¯åŸºäºŽICMPåè®®æ¥å®žçŽ°çš„ã€‚é‚£ä¹ˆæˆ‘ä»¬å†æ¥çœ‹ä¸‹å›¾ï¼Œå°±æ˜Žç™½äº†ICMPåè®®åˆæ˜¯é€šè¿‡IPåè®®æ¥å‘é€çš„ï¼Œå³ICMPæŠ¥æ–‡æ˜¯å°è£…åœ¨IPåŒ…ä¸­ã€‚ IPåè®®æ˜¯ä¸€ç§æ— è¿žæŽ¥çš„ï¼Œä¸å¯é çš„æ•°æ®åŒ…åè®®ï¼Œå®ƒå¹¶ä¸èƒ½ä¿è¯æ•°æ®ä¸€å®šè¢«é€è¾¾ï¼Œé‚£ä¹ˆæˆ‘ä»¬è¦ä¿è¯æ•°æ®é€åˆ°å°±éœ€è¦é€šè¿‡å…¶å®ƒæ¨¡å—æ¥ååŠ©å®žçŽ°ï¼Œè¿™é‡Œå°±å¼•å…¥çš„æ˜¯ICMPåè®®ã€‚ å½“ä¼ é€çš„IPæ•°æ®åŒ…å‘é€å¼‚å¸¸çš„æ—¶å€™ï¼ŒICMPå°±ä¼šå°†å¼‚å¸¸ä¿¡æ¯å°è£…åœ¨åŒ…å†…ï¼Œç„¶åŽå›žä¼ ç»™æºä¸»æœºã€‚ å°†ä¸Šå›¾å†ç»†æ‹†ä¸€ä¸‹å¯è§ï¼š å°†ICMPéƒ¨åˆ†æ‹†å¼€ç»§ç»­åˆ†æžï¼š ç”±å›¾å¯çŸ¥ï¼ŒICMPæ•°æ®åŒ…ç”±8bitçš„ç±»åž‹å­—æ®µå’Œ8bitçš„ä»£ç å­—æ®µä»¥åŠ16bitçš„æ ¡éªŒå­—æ®µå†åŠ ä¸Šé€‰é¡¹æ•°æ®ç»„æˆã€‚ ICMPåè®®å¤§è‡´å¯åˆ†ä¸ºä¸¤ç±»ï¼š æŸ¥è¯¢æŠ¥æ–‡ç±»åž‹ å·®é”™æŠ¥æ–‡ç±»åž‹ æŸ¥è¯¢æŠ¥æ–‡ç±»åž‹ï¼š æŸ¥è¯¢æŠ¥æ–‡ä¸»è¦åº”ç”¨äºŽï¼špingæŸ¥è¯¢ã€å­ç½‘æŽ©ç æŸ¥è¯¢ã€æ—¶é—´æˆ³æŸ¥è¯¢ç­‰ç­‰ã€‚ ä¸Šé¢è®²åˆ°çš„pingå‘½ä»¤çš„æµç¨‹å…¶å®žå°±å¯¹åº”ICMPåè®®æŸ¥è¯¢æŠ¥æ–‡ç±»åž‹çš„ä¸€ç§ä½¿ç”¨ã€‚åœ¨ä¸»æœºAæž„å»ºICMPè¯·æ±‚æ•°æ®åŒ…çš„æ—¶å€™ï¼Œå…¶ICMPçš„ç±»åž‹å­—æ®µä¸­ä½¿ç”¨çš„æ˜¯ 8 ï¼ˆå›žé€è¯·æ±‚ï¼‰ï¼Œå½“ä¸»æœºBæž„å»ºICMPåº”ç­”åŒ…çš„æ—¶å€™ï¼Œå…¶ICMPç±»åž‹å­—æ®µå°±ä½¿ç”¨çš„æ˜¯ 0 ï¼ˆå›žé€åº”ç­”ï¼‰ï¼Œæ›´å¤šç±»åž‹å€¼å‚è€ƒä¸Šè¡¨ã€‚ å¯¹ æŸ¥è¯¢æŠ¥æ–‡ç±»åž‹ çš„ç†è§£å¯å‚è€ƒä¸€ä¸‹æ–‡ç« æœ€å¼€å§‹è®²çš„pingæµç¨‹ï¼Œè¿™é‡Œå°±ä¸åšèµ˜è¿°ã€‚ å·®é”™æŠ¥æ–‡ç±»åž‹ï¼š å·®é”™æŠ¥æ–‡ä¸»è¦äº§ç”ŸäºŽå½“æ•°æ®ä¼ é€å‘é€é”™è¯¯çš„æ—¶å€™ã€‚ å®ƒåŒ…æ‹¬ï¼šç›®æ ‡ä¸å¯è¾¾ï¼ˆç½‘ç»œä¸å¯è¾¾ã€ä¸»æœºä¸å¯è¾¾ã€åè®®ä¸å¯è¾¾ã€ç«¯å£ä¸å¯è¾¾ã€ç¦æ­¢åˆ†ç‰‡ç­‰ï¼‰ã€è¶…æ—¶ã€å‚æ•°é—®é¢˜ã€é‡å®šå‘ï¼ˆç½‘ç»œé‡å®šå‘ã€ä¸»æœºé‡å®šå‘ç­‰ï¼‰ç­‰ç­‰ã€‚ å·®é”™æŠ¥æ–‡é€šå¸¸åŒ…å«äº†å¼•èµ·é”™è¯¯çš„IPæ•°æ®åŒ…çš„ç¬¬ä¸€ä¸ªåˆ†ç‰‡çš„IPé¦–éƒ¨ï¼ŒåŠ ä¸Šè¯¥åˆ†ç‰‡æ•°æ®éƒ¨åˆ†çš„å‰8ä¸ªå­—èŠ‚ã€‚ å½“ä¼ é€IPæ•°æ®åŒ…å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼ˆä¾‹å¦‚ ä¸»æœºä¸å¯è¾¾ï¼‰ï¼ŒICMPåè®®å°±ä¼šæŠŠé”™è¯¯ä¿¡æ¯å°åŒ…ï¼Œç„¶åŽä¼ é€å›žæºä¸»æœºï¼Œé‚£ä¹ˆæºä¸»æœºå°±çŸ¥é“è¯¥æ€Žä¹ˆå¤„ç†äº†ã€‚ é‚£æ˜¯ä¸æ˜¯åªæœ‰é‡åˆ°é”™è¯¯çš„æ—¶å€™æ‰èƒ½ä½¿ç”¨ å·®é”™æŠ¥æ–‡ç±»åž‹ å‘¢ï¼Ÿä¹Ÿä¸ä¸€å®šã€‚ Traceroute å°±æ˜¯ä¸€ä¸ªä¾‹å¤–ï¼ŒTracerouteæ˜¯ç”¨æ¥ä¾¦æµ‹æºä¸»æœºåˆ°ç›®æ ‡ä¸»æœºä¹‹é—´æ‰€ç»è¿‡è·¯ç”±æƒ…å†µçš„å¸¸ç”¨å·¥å…·ã€‚Traceroute çš„åŽŸç†å°±æ˜¯åˆ©ç”¨ICMPçš„è§„åˆ™ï¼Œåˆ¶é€ ä¸€äº›é”™è¯¯çš„äº‹ä»¶å‡ºæ¥ï¼Œç„¶åŽæ ¹æ®é”™è¯¯çš„äº‹ä»¶æ¥è¯„ä¼°ç½‘ç»œè·¯ç”±æƒ…å†µã€‚ å…·ä½“åšæ³•å°±æ˜¯ï¼š Tracerouteä¼šè®¾ç½®ç‰¹æ®Šçš„TTLå€¼ï¼Œæ¥è¿½è¸ªæºä¸»æœºå’Œç›®æ ‡ä¸»æœºä¹‹é—´çš„è·¯ç”±æ•°ã€‚é¦–å…ˆå®ƒç»™ç›®æ ‡ä¸»æœºå‘é€ä¸€ä¸ª TTL=1 çš„UDPæ•°æ®åŒ…ï¼Œé‚£ä¹ˆè¿™ä¸ªæ•°æ®åŒ…ä¸€æ—¦åœ¨è·¯ä¸Šé‡åˆ°ä¸€ä¸ªè·¯ç”±å™¨ï¼ŒTTLå°±å˜æˆäº†0ï¼ˆTTLè§„åˆ™æ˜¯æ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨éƒ½ä¼šå‡1ï¼‰ï¼Œå› ä¸ºTTL=0äº†ï¼Œæ‰€ä»¥è·¯ç”±å™¨å°±ä¼šæŠŠè¿™ä¸ªæ•°æ®åŒ…ä¸¢æŽ‰ï¼Œç„¶åŽäº§ç”Ÿä¸€ä¸ªé”™è¯¯ç±»åž‹ï¼ˆè¶…æ—¶ï¼‰çš„ICMPæ•°æ®åŒ…å›žå‘ç»™æºä¸»æœºï¼Œä¹Ÿå°±æ˜¯å·®é”™åŒ…ã€‚è¿™ä¸ªæ—¶å€™æºä¸»æœºå°±æ‹¿åˆ°äº†ç¬¬ä¸€ä¸ªè·¯ç”±èŠ‚ç‚¹çš„IPå’Œç›¸å…³ä¿¡æ¯äº†ã€‚ æŽ¥ç€ï¼Œæºä¸»æœºå†ç»™ç›®æ ‡ä¸»æœºå‘ä¸€ä¸ª TTL=2 çš„UDPæ•°æ®åŒ…ï¼Œä¾æ—§ä¸Šè¿°æµç¨‹èµ°ä¸€éï¼Œå°±çŸ¥é“ç¬¬äºŒä¸ªè·¯ç”±èŠ‚ç‚¹çš„IPå’Œè€—æ—¶æƒ…å†µç­‰ä¿¡æ¯äº†ã€‚ å¦‚æ­¤åå¤è¿›è¡Œï¼ŒTracerouteå°±å¯ä»¥æ‹¿åˆ°ä»Žä¸»æœºAåˆ°ä¸»æœºBä¹‹é—´æ‰€æœ‰è·¯ç”±å™¨çš„ä¿¡æ¯äº†ã€‚ ä½†æ˜¯æœ‰ä¸ªé—®é¢˜æ˜¯ï¼Œå¦‚æžœæ•°æ®åŒ…åˆ°è¾¾äº†ç›®æ ‡ä¸»æœºçš„è¯ï¼Œå³ä½¿ç›®æ ‡ä¸»æœºæŽ¥æ”¶åˆ°TTLå€¼ä¸º1çš„IPæ•°æ®åŒ…ï¼Œå®ƒä¹Ÿæ˜¯ä¸ä¼šä¸¢å¼ƒè¯¥æ•°æ®åŒ…çš„ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿä¸€ä»½è¶…æ—¶çš„ICMPå›žå‘æ•°æ®åŒ…çš„ï¼Œå› ä¸ºæ•°æ®åŒ…å·²ç»è¾¾åˆ°äº†ç›®çš„åœ°å˜›ã€‚é‚£æˆ‘ä»¬åº”è¯¥æ€Žä¹ˆè®¤å®šæ•°æ®åŒ…æ˜¯å¦è¾¾åˆ°äº†ç›®æ ‡ä¸»æœºå‘¢ï¼Ÿ Tracerouteçš„æ–¹æ³•æ˜¯åœ¨æºä¸»æœºå‘é€UDPæ•°æ®åŒ…ç»™ç›®æ ‡ä¸»æœºçš„æ—¶å€™ï¼Œä¼šè®¾ç½®ä¸€ä¸ªä¸å¯èƒ½è¾¾åˆ°çš„ç›®æ ‡ç«¯å£å·ï¼ˆä¾‹å¦‚å¤§äºŽ30000çš„ç«¯å£å·ï¼‰ï¼Œé‚£ä¹ˆå½“è¿™ä¸ªæ•°æ®åŒ…çœŸçš„åˆ°è¾¾ç›®æ ‡ä¸»æœºçš„æ—¶å€™ï¼Œç›®æ ‡ä¸»æœºå‘çŽ°æ²¡æœ‰å¯¹åº”çš„ç«¯å£å·ï¼Œå› æ­¤ä¼šäº§ç”Ÿä¸€ä»½â€œç«¯å£ä¸å¯è¾¾â€çš„é”™è¯¯ICMPæŠ¥æ–‡è¿”å›žç»™æºä¸»æœºã€‚ tracerootçš„å…·ä½“ä½¿ç”¨æ–¹æ³•ç½‘ä¸Šéƒ½æœ‰å¾ˆå¤šè®²è§£ï¼Œå¯ä»¥å®žé™…æ“ä½œä¸€ä¸‹ã€‚]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>ç½‘ç»œ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[CentOS7-å®‰è£…docker-composeæ—¶ç”±äºŽpip10åŒ…ç®¡ç†å¯¼è‡´çš„é”™è¯¯]]></title>
    <url>%2F2018%2F09%2F13%2FCentOS7-%E5%AE%89%E8%A3%85docker-compose%E6%97%B6%E7%94%B1%E4%BA%8Epip10%E5%8C%85%E7%AE%A1%E7%90%86%E5%AF%BC%E8%87%B4%E7%9A%84%E9%94%99%E8%AF%AF%2F</url>
    <content type="text"><![CDATA[ä»Šå¤©åœ¨CentOSä¸‹å®‰è£…docker-composeï¼Œé‡åˆ°äº†Cannot uninstall â€˜requestsâ€™. It is a distutils installed project and thus we cannot accurately determine which files belong to it which would lead to only a partial uninstall.é”™è¯¯çš„åŽŸå› æ˜¯requestsé»˜è®¤ç‰ˆæœ¬ä¸º2.6.0ï¼Œä½†æ˜¯docker-composeè¦2.9ä»¥ä¸Šæ‰æ”¯æŒï¼Œä½†æ˜¯æ— æ³•æ­£å¸¸å¸è½½2.9ç‰ˆæœ¬ï¼Œæ˜¯pip10å¯¹åŒ…çš„ç®¡ç†å­˜åœ¨å˜åŒ–ã€‚ è§£å†³æ–¹æ¡ˆï¼š pip install -l requests==2.9]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[æŠ€æœ¯å‘¨åˆŠä¹‹è§£æžPythonä¸­çš„èµ‹å€¼ã€æµ…æ‹·è´ã€æ·±æ‹·è´]]></title>
    <url>%2F2018%2F09%2F09%2F%E6%8A%80%E6%9C%AF%E5%91%A8%E5%88%8A%E4%B9%8B%E8%A7%A3%E6%9E%90Python%E4%B8%AD%E7%9A%84%E8%B5%8B%E5%80%BC%E3%80%81%E6%B5%85%E6%8B%B7%E8%B4%9D%E3%80%81%E6%B7%B1%E6%8B%B7%E8%B4%9D%2F</url>
    <content type="text"><![CDATA[äº‹æƒ…çš„èµ·å›  æœ¬å‘¨æˆ‘ä»¬åˆ†äº«çš„ä¸»é¢˜æ˜¯Pythonä¸­å…³äºŽæµ…æ‹·è´å’Œæ·±æ‹·è´çš„ç‰¹æ€§ï¼Œæƒ³è¦æ·±å…¥ç ”ç©¶Pythonä¸­çš„æµ…æ‹·è´å’Œæ·±æ‹·è´çš„èµ·å› åœ¨äºŽï¼Œæˆ‘æƒ³ç”Ÿæˆä¸€ä¸ªjsonå­—ç¬¦ä¸²ï¼Œè¯¥å­—ç¬¦ä¸²æœªdumpsä¹‹å‰æ˜¯ä¸€ä¸ªPythonçš„æ•°æ®ç»“æž„ï¼Œé‡Œé¢åŒ…å«å­—å…¸ï¼Œä»¥åŠListï¼Œåœ¨éåŽ†ç”Ÿæˆdictionaryæ—¶å€™ï¼Œå‡ºçŽ°ä¸€ä¸ªbugï¼Œå°±æ˜¯æ¯æ¬¡éåŽ†ç”Ÿæˆçš„dictionaryéƒ½æ˜¯ä¸Šä¸€æ¬¡çš„å€¼ï¼ŒçŽ°è±¡å¯ä»¥çœ‹ä»¥ä¸‹ä»£ç ã€‚ 123456789101112131415161718# è¿™é‡Œæˆ‘ä»¬å®šä¹‰ä¸€ä¸ªå‡½æ•°get_data()def get_data(): ...: appid_dict = &#123;&#125; ...: appid_all_dict = &#123;&#125; ...: import pdb;pdb.set_trace() ...: for i in range(10): ...: appid_dict['a'] = i ...: appid_all_dict[i] = appid_dict# æˆ‘ä»¬çš„åˆè¡·æ˜¯æƒ³è¦å¾—åˆ°# &#123;0: &#123;'a': 0&#125;, 1: &#123;'a': 1&#125;, 2: &#123;'a': 2&#125;, 3: &#123;'a': 3&#125;&#125;....è¿™æ ·çš„ä¸€ä¸ªdict# ä½†æ˜¯åœ¨è°ƒè¯•è¿‡ç¨‹ä¸­ï¼Œå‘çŽ°å¾—åˆ°çš„ç»“æžœæ˜¯è¿™æ ·çš„ï¼š# (Pdb) appid_all_dict# &#123;0: &#123;'a': 2&#125;, 1: &#123;'a': 2&#125;, 2: &#123;'a': 2&#125;&#125;# (Pdb) # å³ï¼ŒåŽé¢çš„appid_dictéƒ½ä¼šæŠŠå‰é¢çš„è¦†ç›–æŽ‰ï¼Œè¿™æ˜¯ä»€ä¹ˆåŽŸå› å‘¢ï¼Ÿ# æˆ‘ä»¬è¿™é‡Œå…ˆæŠŠåŽŸå› è¯´ä¸€ä¸‹ï¼šå› ä¸ºPythonä¸­å¯¹dictçš„æ“ä½œé»˜è®¤æ˜¯æµ…æ‹·è´ï¼Œå³åŒæ ·çš„å­—å…¸ï¼Œä½¿ç”¨å¤šæ¬¡çš„è¯ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½æ˜¯æŒ‡å‘åŒä¸€ç‰‡å†…å­˜åœ°å€(å¼•ç”¨)ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢çš„ç¨‹åºä¸­åŽé¢å¯¹appid_dictçš„èµ‹å€¼ï¼Œéƒ½å°†å‰é¢çš„ç»™è¦†ç›–æŽ‰äº†ï¼Œå¯¼è‡´æ¯ä¸€ä¸ªappid_dictæŒ‡å‘åŒä¸€ç‰‡å†…å­˜ï¼Œè¯»å–çš„å½“ç„¶å°±æ˜¯æœ€åŽä¸€æ¬¡çš„appid_dictçš„å€¼ï¼Œå³ä¸Šé¢ç¨‹åºçš„æ‰§è¡Œç»“æžœï¼š&#123;0: &#123;'a': 9&#125;, 1: &#123;'a': 9&#125;, 2: &#123;'a': 9&#125;, 3: &#123;'a': 9&#125;, 4: &#123;'a': 9&#125;, 5: &#123;'a': 9&#125;, 6: &#123;'a': 9&#125;, 7: &#123;'a': 9&#125;, 8: &#123;'a': 9&#125;, 9: &#123;'a': 9&#125;&#125; é‚£ä¹ˆå¦‚ä½•ä¿®æ”¹è¿™ä¸ªbugï¼Œè®©ç¨‹åºè¾“å‡ºæˆ‘ä»¬æƒ³è¦å¾—åˆ°çš„ç»“æžœï¼š 1&#123;0: &#123;'a': 0&#125;, 1: &#123;'a': 1&#125;, 2: &#123;'a': 2&#125;, 3: &#123;'a': 3&#125;, 4: &#123;'a': 4&#125;, 5: &#123;'a': 5&#125;, 6: &#123;'a': 6&#125;, 7: &#123;'a': 7&#125;, 8: &#123;'a': 8&#125;, 9: &#123;'a': 9&#125;&#125; çœ‹å®Œä¸‹é¢å¯¹äºŽPythonèµ‹å€¼ã€æµ…æ‹·è´ã€æ·±æ‹·è´çš„è§£æžï¼Œç›¸ä¿¡ä½ å°±å¯ä»¥è‡ªå·±è§£å†³è¿™ä¸ªé—®é¢˜äº† Pythonä¸­çš„èµ‹å€¼æ“ä½œ èµ‹å€¼ï¼šå°±æ˜¯å¯¹è±¡çš„å¼•ç”¨ ä¸¾ä¾‹ï¼š a = b: èµ‹å€¼å¼•ç”¨ï¼Œaå’Œbéƒ½æŒ‡å‘åŒä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚å›¾æ‰€ç¤º Pythonä¸­æµ…æ‹·è´ a = b.copy(): a æ˜¯bçš„æµ…æ‹·è´ï¼Œaå’Œbæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œä½†æ˜¯å®ƒä»¬çš„å­å¯¹è±¡è¿˜æ˜¯æŒ‡å‘åŒä¸€ç‰‡å¼•ç”¨ã€‚ Pythonä¸­å¯¹å­—å…¸çš„é»˜è®¤èµ‹å€¼æ“ä½œå°±æ˜¯æµ…æ‹·è´ï¼Œæ‰€ä»¥å¯¼è‡´äº†æ–‡ç« å¼€å¤´æ‰€å‡ºçŽ°çš„æƒ…å†µã€‚ Pythonä¸­çš„æ·±æ‹·è´ é¦–å…ˆimport copy,å¯¼å…¥copyæ¨¡å—ï¼ˆPythonä¸­è‡ªå¸¦ï¼‰ï¼Œb = copy.deepcopy(a), æˆ‘ä»¬å°±è¯´bæ˜¯açš„æ·±æ‹·è´ï¼Œbæ‹·è´äº†aæ‰€æœ‰çš„èµ„æºå¯¹è±¡ï¼Œå¹¶æ–°å¼€è¾Ÿäº†ä¸€å—åœ°å€ç©ºé—´ï¼Œä¸¤è€…äº’ä¸å¹²æ¶‰ã€‚ å®žé™…çš„ä¾‹å­æ¥è¿›ä¸€æ­¥è¯´æ˜Ž12345678910111213141516171819202122In [13]: import copyIn [14]: def temp(): ...: a = [1, 2, 3, 4, ['a', 'b']] ...: b = a # èµ‹å€¼æ“ä½œï¼Œç›´æŽ¥ä¼ æ‰€æœ‰å¯¹è±¡çš„å¼•ç”¨ ...: c = copy.copy(a) # æµ…æ‹·è´ï¼Œå­å¯¹è±¡æŒ‡å‘åŒä¸€å¼•ç”¨ ...: d = copy.deepcopy(a) # æ·±æ‹·è´ï¼Œäº’ä¸å¹²æ¶‰ ...: a.append(5) # ä¿®æ”¹å¯¹è±¡a ...: a[4].append('c') # ä¿®æ”¹aä¸­çš„æ•°ç»„ ...: print( 'a = ', a ) ...: print( 'b = ', b ) ...: print( 'c = ', c ) ...: print( 'd = ', d ) ...: In [15]: In [15]: temp()a = [1, 2, 3, 4, ['a', 'b', 'c'], 5]b = [1, 2, 3, 4, ['a', 'b', 'c'], 5]c = [1, 2, 3, 4, ['a', 'b', 'c']]d = [1, 2, 3, 4, ['a', 'b']] è§£å†³æœ€åˆçš„é—®é¢˜ çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å†å›žå¤´çœ‹æ–‡ç« æœ€åˆçš„é‚£ä¸ªé—®é¢˜ï¼Œå°±å¯ä»¥å¾ˆeasyåœ°è§£å†³äº†ã€‚ 12345678def get_data(): ...: appid_dict = &#123;&#125; ...: appid_all_dict = &#123;&#125; ...: import pdb;pdb.set_trace() ...: for i in range(10): appid_dict = copy.deepcopy(appid_dict)# åªéœ€è¦åŠ ä¸Šè¿™ä¸€è¡Œï¼Œä½¿å…¶æˆä¸ºæ·±æ‹·è´ï¼Œé—®é¢˜è§£å†³ï¼ ...: appid_dict['a'] = i ...: appid_all_dict[i] = appid_dict æ€»ç»“è¦å¯¹Pythonçš„dictionaryè¿›è¡Œè¿­ä»£åˆ†æžï¼Œä¸€å®šè¦æ³¨æ„å…¶ä¸­çš„æ·±æ‹·è´é—®é¢˜ï¼Œå‡ºçŽ°é—®é¢˜åŽï¼Œä¹Ÿè¦å¤šå¾€è¿™æ–¹é¢è€ƒè™‘ã€‚ æœ¬æœŸæŠ€æœ¯å‘¨åˆŠåˆ°æ­¤ç»“æŸã€‚]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>Python</tag>
        <tag>æŠ€æœ¯å‘¨åˆŠ</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golang ç¼–è¯‘é’ˆå¯¹ä¸åŒå¹³å°çš„å¯æ‰§è¡Œç¨‹åº]]></title>
    <url>%2F2018%2F09%2F07%2Fgolang-%E7%BC%96%E8%AF%91%E9%92%88%E5%AF%B9%E4%B8%8D%E5%90%8C%E5%B9%B3%E5%8F%B0%E7%9A%84%E5%8F%AF%E6%89%A7%E8%A1%8C%E7%A8%8B%E5%BA%8F%2F</url>
    <content type="text"><![CDATA[1234567891011121314151617181920212223242526272829303132333435363738Golang æ”¯æŒåœ¨ä¸€ä¸ªå¹³å°ä¸‹ç”Ÿæˆå¦ä¸€ä¸ªå¹³å°å¯æ‰§è¡Œç¨‹åºçš„äº¤å‰ç¼–è¯‘åŠŸèƒ½ã€‚Macä¸‹ç¼–è¯‘Linux, Windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼šCGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build test.goCGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.goLinuxä¸‹ç¼–è¯‘Mac, Windowså¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼šCGO_ENABLED=0 GOOS=darwin GOARCH=amd64 go build test.goCGO_ENABLED=0 GOOS=windows GOARCH=amd64 go build test.goWindowsä¸‹ç¼–è¯‘Mac, Linuxå¹³å°çš„64ä½å¯æ‰§è¡Œç¨‹åºï¼šSET CGO_ENABLED=0SET GOOS=darwin3SET GOARCH=amd64go build test.goSET CGO_ENABLED=0SET GOOS=linuxSET GOARCH=amd64go build test.go GOOSï¼šç›®æ ‡å¯æ‰§è¡Œç¨‹åºè¿è¡Œæ“ä½œç³»ç»Ÿï¼Œæ”¯æŒ darwinï¼Œfreebsdï¼Œlinuxï¼ŒwindowsGOARCHï¼šç›®æ ‡å¯æ‰§è¡Œç¨‹åºæ“ä½œç³»ç»Ÿæž„æž¶ï¼ŒåŒ…æ‹¬ 386ï¼Œamd64ï¼ŒarmGolang version 1.5ä»¥å‰ç‰ˆæœ¬åœ¨é¦–æ¬¡äº¤å‰ç¼–è¯‘æ—¶è¿˜éœ€è¦é…ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒï¼šCGO_ENABLED=0 GOOS=linux GOARCH=amd64 ./make.bashCGO_ENABLED=0 GOOS=windows GOARCH=amd64 ./make.bash]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[å¸¸ç”¨çš„Pythonå°æ¨¡å—]]></title>
    <url>%2F2018%2F09%2F06%2F%E5%B8%B8%E7%94%A8%E7%9A%84Python%E5%B0%8F%E6%A8%A1%E5%9D%97%2F</url>
    <content type="text"><![CDATA[å·¥ä½œæˆ–è€…ç”Ÿæ´»ä¸­æ€»ä¼šé‡åˆ°ä¸€äº›å¸¸ç”¨çš„Pythonæ¨¡å—ï¼Œä¸ºäº†é¿å…é‡å¤çš„å·¥ä½œï¼Œå°†è¿™äº›è‡ªå·±å†™è¿‡çš„Pythonæ¨¡å—è®°å½•ä¸‹æ¥ï¼Œæ–¹ä¾¿ä½¿ç”¨çš„æ—¶å€™æŸ¥æ‰¾ã€‚ Pythonå†™CSVæ–‡ä»¶ï¼Œå¹¶é˜²æ­¢ä¸­æ–‡ä¹±ç 12345678def write_csv(a_list,b_list): with open('vm_data.csv', 'w') as f: f.write(codecs.BOM_UTF8.decode()) writer1 = csv.writer(f, dialect='excel') #å†™CVSçš„æ ‡é¢˜ writer1.writerow(['a', 'b']) #å°†æ•°æ®å†™å…¥CSVæ–‡ä»¶ writer1.writerows(zip(a_list, b_list)) Pythonå°†æ•°æ®ç»“æž„è½¬ä¸ºjson,å¹¶ä¼˜åŒ–jsonå­—ç¬¦ä¸²çš„ç»“æž„ï¼Œå¤„ç†ä¸­æ–‡ä¹±ç 12345with open("appid.json", 'w', encoding='utf8', ) as f: f.write(json.dumps(final, sort_keys=True, indent=2, ensure_ascii=False))# sort_keys = True: å°†å­—å…¸çš„keyæŒ‰ç…§å­—æ¯æŽ’åº# ident = 2: ä¼˜åŒ–jsonå­—ç¬¦ä¸²ç»“æž„ï¼Œçœ‹èµ·æ¥æ›´ç¾Žè§‚# ensure_ascii=False: é˜²æ­¢jsonå­—ç¬¦ä¸²ä¸­çš„ä¸­æ–‡ä¹±ç  ä½¿ç”¨requestsåŒ…è¿›è¡Œç½‘ç»œè¯·æ±‚ï¼ˆä»¥postä¸ºä¾‹ï¼‰1234567891011def get_data(url): final = &#123;&#125; url = &quot;http://xxxx.com&quot; request_body = &#123; &apos;access_token&apos;: access_token, &apos;request_body&apos;: &#123;&quot;params1&quot;: param1, &apos;params2&apos;: param2&#125; &#125; headers = &#123; &apos;Content-type&apos;: &apos;application/json&apos; &#125; data = requests.post(url, headers=headers, data=json.dumps(request_body))]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Mysqlæ— æ³•è¿žæŽ¥[MySql Host is blocked because of many connection errors]]]></title>
    <url>%2F2018%2F09%2F01%2FMysql%E6%97%A0%E6%B3%95%E8%BF%9E%E6%8E%A5%2F</url>
    <content type="text"><![CDATA[æµ‹è¯•çŽ¯å¢ƒï¼Œå‘çŽ°æ•°æ®åº“ï¼ˆMySQLæ•°æ®åº“ï¼‰æ— æ³•ç™»å½•ï¼ŒæŠ¥é”™å¦‚ä¸‹ï¼š Host is blocked because of many connection errors; unblock with â€˜mysqladmin flush-hostsâ€™ è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨mysqladmin flush-hosts å‘½ä»¤æ¸…ç†ä¸€ä¸‹hostsæ–‡ä»¶ï¼ˆä¸çŸ¥é“mysqladminåœ¨å“ªä¸ªç›®å½•ä¸‹å¯ä»¥ä½¿ç”¨å‘½ä»¤æŸ¥æ‰¾ï¼šwhereis mysqladminï¼‰ï¼› ç™»å½•åˆ°MySQLæ•°æ®åº“ä¸­ï¼Œmysql -uroot -h host -p æ‰§è¡Œ 1mysqladmin flush-hosts é—®é¢˜è§£å†³ã€‚]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[mysql å¼€å¯è¿œç¨‹è¿žæŽ¥]]></title>
    <url>%2F2018%2F08%2F29%2Fmysql-%E5%BC%80%E5%90%AF%E8%BF%9C%E7%A8%8B%E8%BF%9E%E6%8E%A5%2F</url>
    <content type="text"><![CDATA[èƒŒæ™¯ï¼š å»ºç«™çš„æ—¶å€™ä¼šå‡ºçŽ°æ•°æ®åº“å’Œç½‘ç«™æ˜¯ä¸åŒçš„ipï¼Œå°±éœ€è¦å¼€å¯MySQLçš„è¿œç¨‹è¿žæŽ¥æœåŠ¡ï¼Œä½†æ˜¯MySQLç”±äºŽå®‰å…¨åŽŸå› ï¼Œé»˜è®¤è®¾ç½®æ˜¯ä¸å…è®¸è¿œç¨‹åªèƒ½æœ¬åœ°è¿žæŽ¥ï¼Œè¦å¼€å¯è¿œç¨‹è¿žæŽ¥å°±éœ€è¦ä¿®æ”¹æŸäº›é…ç½®æ–‡ä»¶ã€‚ æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤ï¼Œå¼€å¯MySQLçš„è¿œç¨‹è¿žæŽ¥ è¿›å…¥æ•°æ®åº“cmd 12mysql -uroot -h host -pEnter password:*** è¿žæŽ¥åˆ°é»˜è®¤mysqlæ•°æ®åº“ 123show databases;use mysql; é…ç½® 1Grant all privileges on *.* to 'root'@'host' identified by 'password' with grant option; hostè¡¨ç¤ºä½ è¿œç¨‹è¿žæŽ¥æ•°æ®åº“è®¾å¤‡çš„ipåœ°å€ï¼ˆå¦‚æžœä½ æƒ³è®©æ‰€æœ‰æœºå™¨éƒ½èƒ½è¿œç¨‹è¿žæŽ¥ï¼Œhostæ”¹ä¸ºâ€˜%â€™ï¼Œä¸æŽ¨èè¿™æ ·ä½¿ç”¨ï¼‰ï¼Œpasswordè¡¨ç¤ºMySQLçš„rootç”¨æˆ·å¯†ç  åˆ·æ–°oré‡å¯MySQL 1mysql&gt; flush privileges; æœ€åŽéžå¸¸é‡è¦çš„ä¸€ç‚¹ 123vim /etc/vim /etc/mysql/my.cnfå±è”½bing-server 127.0.0.0#bing-server 127.0.0.0 å®Œæˆï¼Œå¯ä»¥è¿œç¨‹è¿žæŽ¥ä½ çš„æ•°æ®åº“äº†]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>mysql</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golang factory design å¼•å‘çš„ä¸€ç³»åˆ—æ€è€ƒ]]></title>
    <url>%2F2018%2F08%2F29%2Fgolang-factory-design-%E5%BC%95%E5%8F%91%E7%9A%84%E4%B8%80%E7%B3%BB%E5%88%97%E6%80%9D%E8%80%83%2F</url>
    <content type="text"><![CDATA[å†™åœ¨å‰é¢ï¼Œçªç„¶èŒç”Ÿä¸€ä¸ªå¿µå¤´ï¼Œåšä¸€ä¸ªæŠ€æœ¯å‘¨åˆŠç³»åˆ—ï¼Œå°†æ¯å‘¨å·¥ä½œæˆ–è€…ç”Ÿæ´»å½“ä¸­é‡åˆ°çš„æ¯”è¾ƒæœ‰è¶£çš„é—®é¢˜è®°å½•ä¸‹æ¥ï¼Œä¸€æ¥æ—¶æ€»ç»“ä¸€ä¸‹ï¼ŒäºŒæ¥æ˜¯ä¸ºäº†ä»¥åŽé€€å½¹äº†ï¼Œå¯ä»¥å›žé¡¾è‡ªå·±çš„æŠ€æœ¯ç”Ÿæ¶¯ã€‚ æ²¡æœ‰ä»€ä¹ˆæ„å¤–çš„è¯ï¼Œæˆ‘ä¼šæ¯å‘¨å…­æ™šæ›´æ–°ã€‚ æœ€è¿‘åœ¨æ•´åˆä¸‰å®¶å…¬æœ‰äº‘ï¼ˆAWSï¼Œali, ucloudï¼‰çš„æŽ¥å£ï¼Œè€ƒè™‘åˆ°ä»£ç å¤ç”¨çš„é—®é¢˜ï¼ŒäºŽæ˜¯å¼€å§‹è€ƒè™‘ä½¿ç”¨ä¸€ç§è®¾è®¡æ¨¡å¼ï¼Œè¿™ç§åœºæ™¯ä¸‹ï¼Œæœ€åˆé€‚çš„ä¾¿æ˜¯å·¥åŽ‚æ¨¡å¼ï¼Œå°†ä¸‰å®¶åŽ‚å•†çš„å…¬æœ‰æŽ¥å£æ”¾å…¥å·¥åŽ‚æ–¹æ³•ä¸­ï¼Œç„¶åŽå¯¹æ¯ä¸€å®¶newä¸€ä¸ªå®žä¾‹å³å¯ï¼Œä»¥åŽå†æœ‰æ–°çš„åŽ‚å•†åŠ å…¥ï¼Œæ”¹åŠ¨çš„ä»£ç ä¹Ÿä¸ä¼šå¤ªå¤šã€‚ä½†æ˜¯è®¾è®¡æ¨¡å¼è¿™ç§ä¸œè¥¿å¤©ç„¶é€‚åˆäºŽjavaï¼Œå¯¹äºŽgolangè¿™ç§æ¯”è¾ƒæ–°çš„è¯­è¨€æ¥è¯´ï¼Œå®žçŽ°èµ·æ¥ç›¸å¯¹æ²¡æœ‰é‚£ä¹ˆå®¹æ˜“ï¼Œå¯¹äºŽåˆšæŽ¥è§¦golangçš„æˆ‘æ¥è¯´ï¼Œå¯¹ä¸€äº›golangçš„ç‰¹æ€§ä¸Šå¹¶ä¸æ˜¯å¾ˆç†Ÿæ‚‰ï¼Œæ‰€ä»¥åœ¨æ­¤æœŸé—´é‡åˆ°ä¸€äº›ä¸è§£çš„é—®é¢˜ï¼Œå†™å‡ºæ¥åˆ†äº«ä¸€ä¸‹ã€‚ é¦–å…ˆï¼Œä»€ä¹ˆæ˜¯å·¥åŽ‚æ¨¡å¼ ç®€å•å·¥åŽ‚æ¨¡å¼å°±æ˜¯é€šè¿‡ä¼ é€’ä¸åŒçš„å‚æ•°ï¼Œç”Ÿæˆä¸åŒçš„å®žä¾‹ï¼Œå·¥åŽ‚æ–¹æ³•ä¸ºæ¯ä¸€ä¸ªproductæä¾›ä¸€ä¸ªå·¥ç¨‹ç±»ï¼Œé€šè¿‡ä¸åŒçš„å·¥åŽ‚åˆ›å»ºä¸åŒçš„å®žä¾‹ã€‚ å…¸åž‹å·¥åŽ‚æ¨¡å¼çš„å®žçŽ°æ–¹å¼ï¼ˆå³å…¸åž‹oopå®žçŽ°æ–¹å¼ï¼‰ 12345678910111213141516171819202122class ProviderModel&#123; provider string func factory(providerName string, test string)&#123; if providerName == "AWS" &#123; return new AWS(test) &#125; if providerName == "Ali"&#123; return new Ali(test) &#125; &#125;&#125;class AWS extends ProviderModel &#123; func construct(test string)&#123; this.test = test &#125; func doRequest()&#123;&#125;&#125;awsmodel := ProviderModel::factory("AWS")awsmodel.doRequest()alimodel := ProviderModel ::factory("Ali") alimodel.doRequest() golangå®žçŽ°å·¥åŽ‚æ¨¡å¼å­˜åœ¨çš„é—®é¢˜ golangçš„ç‰¹æ€§ä¸­å¹¶æ²¡æœ‰åƒjavaä¸€æ ·çš„ç»§æ‰¿å’Œé‡è½½ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åˆ©ç”¨golangå­˜åœ¨çš„ç‰¹æ€§ï¼Œé€è¿‡å·¥åŽ‚æ¨¡å¼çš„è¡¨é¢é€æžå…¶æœ¬è´¨ã€‚ æˆ‘ä»¬çœ‹ä¸€ä¸‹å·¥åŽ‚æ¨¡å¼å°±çŸ¥é“ï¼Œæ‰€è°“å·¥åŽ‚å…¶å®žå°±æ˜¯å®šä¹‰äº†ä¸€äº›éœ€è¦åŽ»å®žçŽ°çš„æ–¹æ³•ï¼Œgolangçš„interfaceæ­£æ˜¯å¯ä»¥åšåˆ°ã€‚äºŽæ˜¯å…ˆåˆ°Googleä¸Šæœäº†ä¸€æ®µgolangå®žçŽ°çš„å·¥åŽ‚æ¨¡å¼çš„ä»£ç ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647package mainimport ( "fmt")type Operater interface &#123; Operate(int, int) int&#125;type AddOperate struct &#123;&#125;func (this *AddOperate) Operate(rhs int, lhs int) int &#123; return rhs + lhs&#125;type MultipleOperate struct &#123;&#125;func (this *MultipleOperate) Operate(rhs int, lhs int) int &#123; return rhs * lhs&#125;type OperateFactory struct &#123;&#125;func NewOperateFactory() *OperateFactory &#123; return &amp;OperateFactory&#123;&#125;&#125;func (this *OperateFactory) CreateOperate(operatename string) Operater &#123; switch operatename &#123; case "+": return &amp;AddOperate&#123;&#125; case "*": return &amp;MultipleOperate&#123;&#125; default: panic("æ— æ•ˆè¿ç®—ç¬¦å·") return nil &#125;&#125;func main() &#123; Operator := NewOperateFactory().CreateOperate("+") fmt.Printf("add result is %d\n", Operator.Operate(1, 2))&#125; ä»£ç çœ‹èµ·æ¥æ²¡ä»€ä¹ˆé—®é¢˜ï¼ŒåŽæ¥åˆçœ‹åˆ°ä¸€ç§å®žçŽ°æ–¹å¼ï¼Œæ¥è‡ªè¿™ç¯‡åšå®¢ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728type site interface &#123; fetch()&#125;type siteModel struct &#123; URL string&#125;type site1 struct &#123; siteModel&#125;func (s site1) fetch() &#123; fmt.Println("site1 fetch data")&#125;func factory(s string) site &#123; if s == "site" &#123; return site1&#123; siteModel&#123;URL: "http://www.xxxx.com"&#125;, &#125; &#125; return nil&#125;func main() &#123; s := factory("site") s.fetch()&#125; ä»£ç åˆçœ‹ä¸ŠåŽ»è·Ÿç¬¬ä¸€ä¸ªå®žçŽ°æ²¡ä»€ä¹ˆä¸ä¸€æ ·ï¼Œä½†æ˜¯å½“æˆ‘è¯¦ç»†é˜…è¯»ä»£ç æ—¶ï¼Œä¸‹é¢çš„è¿™å¥ä»£ç ç€å®žæŠŠæˆ‘å¼„æ™•äº† 12345678func factory(s string) site &#123; if s == "site" &#123; return site1&#123; siteModel&#123;URL: "http://www.xxxx.com"&#125;, &#125; &#125; return nil&#125; factoryå‡½æ•°çš„è¿”å›žå€¼å®šä¹‰æ˜Žæ˜Žæ˜¯ä¸€ä¸ªinterface, ä½†æ˜¯åœ¨returnçš„æ—¶å€™ï¼Œå´è¿”å›žä¸€ä¸ªstructï¼ŒæŸ¥é˜…å¾ˆå¤šèµ„æ–™åŽï¼Œè¿™ç¯‡åšå®¢å¸®äº†æˆ‘çš„å¤§å¿™ï¼Œå…¶ä¸­å¯¹interfaceçš„è§£é‡Šæœ‰è¿™ä¹ˆä¸€å¥è¯ï¼šåœ¨ Golang ä¸­ï¼Œinterface æ˜¯ä¸€ç»„ method çš„é›†åˆï¼Œæ˜¯ duck-type programming çš„ä¸€ç§ä½“çŽ°ã€‚ä¸å…³å¿ƒå±žæ€§ï¼ˆæ•°æ®ï¼‰ï¼Œåªå…³å¿ƒè¡Œä¸ºï¼ˆæ–¹æ³•ï¼‰ã€‚å…·ä½“ä½¿ç”¨ä¸­ä½ å¯ä»¥è‡ªå®šä¹‰è‡ªå·±çš„ structï¼Œå¹¶æä¾›ç‰¹å®šçš„ interface é‡Œé¢çš„ method å°±å¯ä»¥æŠŠå®ƒå½“æˆ interface æ¥ä½¿ç”¨ã€‚ä¹‹åŽåˆè¯¦ç»†çœ‹äº†å‡ éè¿™ç¯‡åšæ–‡ï¼ŒçŠ¹å¦‚é†é†çŒé¡¶ï¼Œå¯¹golanginterfaceçš„ç†è§£æ›´æ·±äº†ä¸€å±‚ã€‚è¯»å®Œè¿™ç¯‡åŽå†åŽ»å®žçŽ°å·¥åŽ‚æ¨¡å¼ï¼Œæˆ–è€…å†åŽ»å†™golangçš„ä»£ç ï¼Œå¯¹interfaceçš„ä½¿ç”¨å°±ä¼šæ›´è‡ªå¦‚ä¸€äº›ã€‚ æ€»ç»“ æœ¬æœŸæŠ€æœ¯å‘¨åˆŠä¸»è¦ç”±golangå·¥åŽ‚æ¨¡å¼çš„è®¨è®ºå¼•èµ·ï¼Œä¹‹åŽåˆæ¶‰åŠåˆ°golang interfaceç‰¹æ€§çš„è®¨è®ºï¼Œå¯¹ä»¥åŽä½¿ç”¨golangç¼–å†™æ›´åŠ å¤æ‚çš„ä»£ç å¾ˆæœ‰å¸®åŠ©ã€‚ æœ¬æœŸç»“æŸï¼Œæ¬²çŸ¥åŽäº‹å¦‚ä½•ï¼Œä¸”çœ‹ä¸‹å‘¨åˆ†è§£ã€‚]]></content>
      <categories>
        <category>æŠ€æœ¯å‘¨åˆŠ</category>
      </categories>
      <tags>
        <tag>golang design pattern go-interface</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangä¸­çš„å·¥åŽ‚æ¨¡å¼]]></title>
    <url>%2F2018%2F08%2F27%2Fgolang%E4%B8%AD%E7%9A%84%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F-md%2F</url>
    <content type="text"><![CDATA[ç ”ç©¶goçš„è®¾è®¡æ¨¡å¼ï¼Œå¿…é¡»äº†è§£goçš„structå’Œinterfaceï¼Œè‹¥ä¸ç†Ÿæ‚‰ï¼Œå…ˆé˜…è¯»ä»¥ä¸‹å†…å®¹ goè¯­è¨€çš„struct goè¯­è¨€çš„interface 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849* ç®€å•å·¥åŽ‚æ¨¡å¼package mainimport ( "fmt")type Operater interface &#123; Operate(int, int) int&#125;type AddOperate struct &#123;&#125;func (this *AddOperate) Operate(rhs int, lhs int) int &#123; return rhs + lhs&#125;type MultipleOperate struct &#123;&#125;func (this *MultipleOperate) Operate(rhs int, lhs int) int &#123; return rhs * lhs&#125;type OperateFactory struct &#123;&#125;func NewOperateFactory() *OperateFactory &#123; return &amp;OperateFactory&#123;&#125;&#125;func (this *OperateFactory) CreateOperate(operatename string) Operater &#123; switch operatename &#123; case "+": return &amp;AddOperate&#123;&#125; case "*": return &amp;MultipleOperate&#123;&#125; default: panic("æ— æ•ˆè¿ç®—ç¬¦å·") return nil &#125;&#125;func main() &#123; Operator := NewOperateFactory().CreateOperate("+") fmt.Printf("add result is %d\n", Operator.Operate(1, 2))&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697* å·¥åŽ‚æ–¹æ³•package mainimport ( "fmt")type Operation struct &#123; a float64 b float64&#125;type OperationI interface &#123; GetResult() float64 SetA(float64) SetB(float64)&#125;func (op *Operation) SetA(a float64) &#123; op.a = a&#125;func (op *Operation) SetB(b float64) &#123; op.b = b&#125;type AddOperation struct &#123; Operation&#125;func (this *AddOperation) GetResult() float64 &#123; return this.a + this.b&#125;type SubOperation struct &#123; Operation&#125;func (this *SubOperation) GetResult() float64 &#123; return this.a - this.b&#125;type MulOperation struct &#123; Operation&#125;func (this *MulOperation) GetResult() float64 &#123; return this.a * this.b&#125;type DivOperation struct &#123; Operation&#125;func (this *DivOperation) GetResult() float64 &#123; return this.a / this.b&#125;type IFactory interface &#123; CreateOperation() Operation&#125;type AddFactory struct &#123;&#125;func (this *AddFactory) CreateOperation() OperationI &#123; return &amp;(AddOperation&#123;&#125;)&#125;type SubFactory struct &#123;&#125;func (this *SubFactory) CreateOperation() OperationI &#123; return &amp;(SubOperation&#123;&#125;)&#125;type MulFactory struct &#123;&#125;func (this *MulFactory) CreateOperation() OperationI &#123; return &amp;(MulOperation&#123;&#125;)&#125;type DivFactory struct &#123;&#125;func (this *DivFactory) CreateOperation() OperationI &#123; return &amp;(DivOperation&#123;&#125;)&#125;func main() &#123; fac := &amp;(AddFactory&#123;&#125;) oper := fac.CreateOperation() oper.SetA(1) oper.SetB(2) fmt.Println(oper.GetResult())&#125; 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849* æŠ½è±¡å·¥åŽ‚æ–¹æ³•package mainimport "fmt"type GirlFriend struct &#123; nationality string eyesColor string language string&#125;type AbstractFactory interface &#123; CreateMyLove() GirlFriend&#125;type IndianGirlFriendFactory struct &#123;&#125;type KoreanGirlFriendFactory struct &#123;&#125;func (a IndianGirlFriendFactory) CreateMyLove() GirlFriend &#123; return GirlFriend&#123;"Indian", "Black", "Hindi"&#125;&#125;func (a KoreanGirlFriendFactory) CreateMyLove() GirlFriend &#123; return GirlFriend&#123;"Korean", "Brown", "Korean"&#125;&#125;func getGirlFriend(typeGf string) GirlFriend &#123; var gffact AbstractFactory switch typeGf &#123; case "Indian": gffact = IndianGirlFriendFactory&#123;&#125; return gffact.CreateMyLove() case "Korean": gffact = KoreanGirlFriendFactory&#123;&#125; return gffact.CreateMyLove() &#125; return GirlFriend&#123;&#125;&#125;func main() &#123; a := getGirlFriend("Indian") fmt.Println(a.eyesColor)&#125;]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
        <tag>è®¾è®¡æ¨¡å¼</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Mac os çŽ¯å¢ƒé…ç½®ruby on rails åŠå…¶Hello world]]></title>
    <url>%2F2018%2F08%2F26%2FMac-os-%E9%85%8D%E7%BD%AE-ruby-on-rails-md%2F</url>
    <content type="text"><![CDATA[ä»Šå¤©åœ¨Mac OSçŽ¯å¢ƒä¸­å€’è…¾ruby on railsï¼Œé‡åˆ°ä¸€äº›å‘å¹¶æŽ’å‘åŽæ€»ç»“ä¸€ä¸ªæ­å»ºè¿‡ç¨‹ï¼Œä¾›å¤§å®¶å‚è€ƒã€‚ å¤§çº² æœ¬ç€ITå±Šèƒ½ç”¨æœ€æ–°çš„å°±ä¸ç”¨å‰é¢çš„ç‰ˆæœ¬çš„å®—æ—¨ï¼Œåœ¨è¿›è¡Œä¹‹å‰å¿…é¡»å°†ä½ çš„Macå‡çº§åˆ°æœ€æ–°çš„macOS High Sierra å®‰è£… XCode Command Line Tools é…ç½®Git å®‰è£…Homebrew å®‰è£…GPG å®‰è£…RVM å®‰è£…ruby å‡çº§RubyGems å®‰è£…rails åŸºæœ¬MVCæŽ¢ç©¶ä¹‹Hello world Ruby On rails for mac os High Sierra Mac OSæ˜¯è‡ªå¸¦rubyçš„ï¼Œä½†æ˜¯è¿™äº›rubyçš„ç‰ˆæœ¬éƒ½ä¸æ˜¯æœ€æ–°çš„ï¼Œæˆ‘ä»¬ä¹Ÿä¸è¦ç”¨è¿™äº›è¿‡æ—¶çš„ç‰ˆæœ¬ é¦–å…ˆï¼Œå‡çº§ä½ çš„Mac OSåˆ°10.13 æŸ¥çœ‹æ˜¯å¦å®‰è£…xcode command line toolï¼š 1234$:xcode-select -på¦‚æžœä½ çœ‹åˆ°ï¼šxcode-select: error: unable to get active developer directory...è¯´æ˜Žä½ æ²¡æœ‰å®‰è£…xcode command line tool,éœ€è¦æŒ‰ç…§ä¸‹é¢çš„æ­¥éª¤å®‰è£…ã€‚ 123å¦‚æžœä½ çœ‹åˆ°ï¼š$:/Applications/Xcode.app/Contents/Developer æˆ–è€…/Library/Developer/CommandLineToolsæ­å–œä½ ï¼Œxcode command line toolä½ å·²ç»å®‰è£…å¥½äº† 123Butï¼Œå¦‚æžœä½ å¾ˆä¸å¹¸è¿åœ°çœ‹åˆ°äº†è¿™å¥è¯ï¼š$: /Applications/Apple Dev Tools/Xcode.app/Contents/Developeré‚£ä¹ˆä½ å°±è¦å¸æŽ‰xcodeé‡æ–°å®‰è£…äº†ï¼Œå…·ä½“åŽŸå› çœ‹ è¿™é‡Œ å®‰è£…xcode 1xcode-select --install ä¸€è·¯ç¡®è®¤ä¹‹åŽï¼Œå°±å¯ä»¥å®‰å¥½xcodeï¼Œä½†æ˜¯å¦‚æžœä½ çš„ç½‘é€Ÿä¸å¥½ï¼Œç­‰å¾…æ—¶é—´è¿‡é•¿ï¼Œä½ å¯ä»¥ä»Žè¿™é‡Œè¾“å…¥ä½ çš„APPIDä¸‹è½½ã€‚ ç¡®è®¤ä¸€ä¸‹æ˜¯å¦å®‰å¥½ 12$ xcode-select -p/Library/Developer/CommandLineTools é…ç½®Git åœ¨å®‰è£…ruby on rails ä¹‹å‰ï¼Œä½ åº”è¯¥é…ç½®ä½ çš„Gitã€‚Gitåœ¨Mac OSä¸Šä½¿è‡ªåŠ¨å®‰è£…çš„è½¯ä»¶ æ£€æŸ¥Gitç‰ˆæœ¬å¹¶ç¡®è®¤å·²ç»å®‰è£…è®©ä½ æ”¾å¿ƒ 12$ git versiongit version 2.4.9 (Apple Git-60) é…ç½®Gitä¹‹å‰ï¼Œä½ åº”è¯¥åˆ°GitHubä¸Šæ³¨å†Œä½ çš„è´¦å·å¹¶è®°ä½å¯†ç å’Œé‚®ç®±ã€‚å¹¶ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤é…ç½®ï¼š 1234567$ git config -l --globalfatal: unable to read config file '/Users/.../.gitconfig': No such file or directory$ git config --global user.name "Your Real Name"$ git config --global user.email me@example.com$ git config -l --globaluser.name=Your Real Nameuser.email=me@example.com Gité…ç½®å®Œæˆï¼Œåœ¨ä½ æƒ³ç”¨Gitçš„æ—¶å€™ï¼Œå®ƒå°±ä¼šè¹¦å‡ºæ¥äº†ã€‚ å®‰è£…Homebrow æ£€æŸ¥homebrowæ˜¯å¦å·²ç»å®‰è£… 12$ brew-bash: brew: command not found RVMéœ€è¦Homebrow,å…¶å®žä¸€ä¸ªMac OSé¢å®‰è£…åŒ…ç®¡ç†å·¥å…·ï¼Œç”¨æ¥ä¸‹è½½ä¸€äº›è½¯ä»¶ï¼Œç±»ä¼¼äºŽUbuntuçš„apt-getå’Œcentosçš„yum install.ä¸ºé¿å…å®‰è£…RMå‡ºçŽ°é—®é¢˜ï¼Œæˆ‘ä»¬å¿…é¡»å®‰è£…homebrowï¼š 1$ ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)" å®‰è£…è¿‡ç¨‹ä¸­å¯èƒ½ä¼šå‡ºçŽ°ä¸€äº›warningå¹¶è®©ä½ è¾“å…¥å¯†ç ï¼š 123WARNING: Improper use of the sudo command could lead to data loss...To proceed, enter your password...Password: å°½ç®¡è¾“å…¥å¯†ç ï¼Œå¿½ç•¥warningã€‚ æˆ‘ä»¬è¿™é‡Œæ˜¯ä½¿ç”¨äº†Mac OSå†…ç½®çš„rubyæ¥å®‰è£…homebrowã€‚ å®‰è£…GPG gpgæ˜¯ä¸€ä¸ªç”¨æ¥æ£€æŸ¥RVMä¸‹è½½åŒ…çš„å®‰å…¨æ€§çš„ç¨‹åºï¼Œæˆ‘ä»¬ä½¿ç”¨homebrewæ¥å®‰è£…gpg: 1$ brew install gpg gpgå®‰è£…ä¹‹åŽï¼Œä¸ºRVMå®‰è£…key: 1$ command curl -sSL https://rvm.io/mpapis.asc | gpg --import - å®‰è£…RVM RVMï¼Œæ˜¯Ruby version managerçš„ç®€å†™ï¼Œç”¨æ¥å®‰è£…rubyæˆ–è€…ç®¡ç†railsç‰ˆæœ¬ã€‚è¿™ä¸ªç½‘ç«™è¯¦ç»†è¯´æ˜Žäº†å®‰è£…rubyçš„æ–¹å¼ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰ä¸€ç§æœ€ç®€ä¾¿çš„æ–¹å¼ï¼š 1$ \curl -L https://get.rvm.io | bash -s stable â€œcurlâ€å‰é¢çš„â€œ\â€ç”¨æ¥é¿å…rubyç‰ˆæœ¬çš„å†²çªï¼Œä¸è¦æ¼æŽ‰ã€‚ å®‰è£…è¿‡ç¨‹ä¸­ä½ å¯èƒ½ä¼šçœ‹åˆ° 123mkdir: /etc/openssl: Permission deniedmkdir -p "/etc/openssl" failed, retrying with sudoyour password required for 'mkdir -p /etc/openssl': è¯·è¾“å…¥å¯†ç å¹¶ç»§ç»­ã€‚ å¦‚æžœä½ å·²ç»å®‰è£…è¿‡RVMï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤updateï¼š 1$ rvm get stable --autolibs=enable é‡å¯terminalçª—å£æˆ–è€…ä½¿ç”¨ï¼šä½¿RVMç”Ÿæ•ˆ 1$ source ~/.rvm/scripts/rvm å®‰è£…ruby åœ¨å®‰è£…RVMä¹‹åŽï¼Œæˆ‘ä»¬å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„rubyã€‚ruby 2.5.1æ˜¯å†™æ­¤åšå®¢æ—¶å½“å‰æœ€æ–°çš„rubyç‰ˆæœ¬ï¼Œè¿˜è¯·æŸ¥çœ‹rubyå®˜ç½‘æŸ¥çœ‹æœ€æ–°ç‰ˆæœ¬çš„rubyã€‚å¿…é¡»æŒ‡å®šrubyçš„ç‰ˆæœ¬ï¼š 1$ rvm install ruby-2.5.1 å®‰è£…åŽæ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š 12$ ruby -vruby 2.5.1... å‡çº§rubyGemset RubyGemsæ˜¯ä¸€ä¸ªrubyçš„åŒ…ç®¡ç†å·¥å…·ï¼Œç”¨æ¥å®‰è£…rubyçš„å·¥å…·æˆ–è€…é¢å¤–åŠŸèƒ½çš„åŒ…ã€‚ æŸ¥çœ‹gemç‰ˆæœ¬ï¼š 1$ gem -v å°†gemå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ 1$ gem update --system æ˜¾ç¤ºRVM gemsetsçš„æœ€åˆä¸¤ä¸ªè®¾ç½® 1234$ rvm gemset listgemsets for ruby-2.5.0=&gt; (default) global ä¸€èˆ¬ä½¿ç”¨globalï¼š 1$ rvm gemset use global å®‰è£…bundle,Bundleæ˜¯ä¸€ä¸ªç®¡ç†gemçš„å¿…é¡»çš„å·¥å…· 1$ gem install Bundler å®‰è£…Nokogiriï¼ŒNokogiriéœ€è¦ç¼–è¯‘æˆæŒ‡å®šçš„ç³»ç»Ÿï¼Œåœ¨ä¸Šé¢çš„é…ç½®ä¸‹ï¼Œå·ç§°æœ€éš¾å®‰è£…çš„åŒ…ï¼Œä¹Ÿå°†å®‰è£…å¥½ 1$ gem install nokogiri å¦‚æžœä½ çœŸçš„ä¸å¹¸è¿åœ¨å®‰è£…æ—¶é‡åˆ°é—®é¢˜ï¼ŒStack Overflowèƒ½å¸®åˆ°ä½ ã€‚ å®‰è£…rails è¿™é‡Œæ˜¯ruby On railæœ€æ–°çš„ç‰ˆæœ¬ï¼Œ5.1æ˜¯æœ€æ–°ç¨³å®šç‰ˆæœ¬ï¼Œ5.2æ˜¯releaseç‰ˆæœ¬ï¼Œæˆ‘ä»¬å®‰è£…5.1. 1$ gem install rails --version=5.1 å¦‚æžœä½ å–œæ¬¢å°é²œï¼Œå¯ä»¥ä½¿ç”¨ 1$ gem install rails --pre å®‰è£…releaseç‰ˆæœ¬ã€‚ æ£€æŸ¥ä¸€ä¸‹railsæ˜¯å¦è£…å¥½ï¼š 12$ rails -vRails 5.2.0 åˆ°æ­¤ä¸ºæ­¢ï¼Œruby on rails ä»¥åŠå…¶çŽ¯å¢ƒé…ç½®éƒ½å·²å¦¥å½“ï¼Œå¯ä»¥å¼€å§‹ä½ çš„rubyä¹‹æ—…äº†ã€‚ ruby on rails çš„Hello world 123456$ cd /$ mkdir worlspace$ cd workspace$ rails _5.1.0_ new hello_app$ cd hello_app$ rails server å°†http://localhost:3000è¾“å…¥æµè§ˆå™¨ï¼Œå°±èƒ½çœ‹åˆ°ruby on railsçš„æ¬¢è¿Žç•Œé¢ã€‚]]></content>
      <categories>
        <category>ruby</category>
      </categories>
      <tags>
        <tag>ruby on rails</tag>
        <tag>web</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[goå®žçŽ°UNIX command]]></title>
    <url>%2F2018%2F08%2F22%2Fgo-unix-cmd-md%2F</url>
    <content type="text"><![CDATA[12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970package mainimport ( "bufio" "errors" "fmt" "os" "os/exec" "strings")func main() &#123; reader := bufio.NewReader(os.Stdin) for &#123; fmt.Print("&gt; ") // è¯»å–é”®ç›˜çš„è¾“å…¥. input, err := reader.ReadString('\n') if err != nil &#123; fmt.Fprintln(os.Stderr, err) &#125; // æ‰§è¡Œå¹¶è§£æžcommand. err = execInput(input) if err != nil &#123; fmt.Fprintln(os.Stderr, err) &#125; &#125;&#125;// å¦‚æžœcdå‘½ä»¤æ²¡æœ‰è·¯å¾„çš„è¯ï¼Œå°±æŠ¥ä¸‹é¢çš„é”™è¯¯var ErrNoPath = errors.New("path required")func execInput(input string) error &#123; // ç§»é™¤æ¢è¡Œç¬¦. input = strings.TrimSuffix(input, "\n") // å°†è¾“å…¥åˆ†å‰²æˆå‚æ•°. args := strings.Split(input, " ") // å¯¹cdå‘½ä»¤çš„æƒ…å†µè¿›è¡ŒåŒºåˆ†. switch args[0] &#123; case "cd": // æš‚æ—¶ä¸æ”¯æŒcdåŠ ç©ºæ ¼è¿›å…¥homeç›®å½•. if len(args) &lt; 2 &#123; return ErrNoPath &#125; err := os.Chdir(args[1]) if err != nil &#123; return err &#125; // Stop further processing. return nil case "exit": os.Exit(0) &#125; // Prepare the command to execute. cmd := exec.Command(args[0], args[1:]...) // Set the correct output device. cmd.Stderr = os.Stderr cmd.Stdout = os.Stdout // Execute the command and save it's output. err := cmd.Run() if err != nil &#123; return err &#125; return nil&#125; 12//æ‰§è¡Œå¹¶æµ‹è¯•go run main.go æš‚æ—¶ä¸æ”¯æŒtabé”®è‡ªåŠ¨è¡¥å…¨å‘½ä»¤ï¼Œåªæ˜¯æä¾›ä¸€ç§ç®€å•çš„æ€è·¯ã€‚]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>go</tag>
        <tag>unix</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[iterm2 çªç„¶æŠ¥å¾ˆå¥‡æ€ªçš„é”™è¯¯-Error No user exists for uid 501]]></title>
    <url>%2F2018%2F08%2F21%2Fiterm2-strange-err-md-md%2F</url>
    <content type="text"><![CDATA[123No user exists for uid 501fatal: Could not read from remote repository.Please make sure you have the correct access rightsand the repository exists. ä¸Šåˆè¿˜å¥½å¥½çš„ï¼Œåˆšåˆšè¿žæŽ¥GitHubæŠ¥è¿™ä¸ªé”™è¯¯ï¼ŒæŽ’æŸ¥åŽäº†è§£åˆ°æ˜¯iterm2çš„ç¥žå‘ã€‚ é‡å¯itermç»ˆç«¯å°±å¥½ ç³»ç»Ÿæœ‰æ›´æ–°çš„è¯ éœ€è¦é‡å¯ç»ˆç«¯ æ›´æ–°ã€‚]]></content>
      <categories>
        <category>ç”Ÿæ´»ä¸­å¥‡æ€ªçš„å‘</category>
      </categories>
      <tags>
        <tag>æ—¥å¸¸çš„å‘ç³»åˆ—</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[golangä¸­interfaceçš„é€šç”¨è®¾è®¡æ–¹æ³•]]></title>
    <url>%2F2018%2F08%2F21%2Fgolang%E9%80%9A%E7%94%A8%E6%8E%A5%E5%8F%A3%E8%AE%BE%E8%AE%A1%E6%96%B9%E6%B3%95%2F</url>
    <content type="text"><![CDATA[golangä¸­æŽ¥å£è®¾è®¡çš„é€šç”¨æ–¹æ³• 123456789101112131415161718192021222324251. æŽ¥å£å®šä¹‰type XxxManager interface &#123; Create(args argsType) (*XxxStruct, error) Get(args argsType) (**XxxStruct, error) Update(args argsType) (*XxxStruct, error) Delete(name string, options *DeleleOptions) error&#125;2. ç»“æž„ä½“å®šä¹‰ type XxxManagerImpl struct &#123; Name string Namespace string kubeCli *kubernetes.Clientset&#125;3ï¼Œæž„é€ å‡½æ•°func NewXxxManagerImpl (namespace, name string, kubeCli *kubernetes.Clientset) XxxManager &#123; return &amp;XxxManagerImpl&#123; Name name, Namespace namespace, kubeCli: kubeCli, &#125;&#125;4. æ–¹æ³•å…·ä½“å®žçŽ°func (xm *XxxManagerImpl) Create(args argsType) (*XxxStruct, error) &#123; //å…·ä½“çš„æ–¹æ³•å®žçŽ°&#125; golangé€šç”¨æŽ¥å£è®¾è®¡ æ ¹æ®ä»¥ä¸Šè®¾è®¡cdosapiå°è£…æŽ¥å£ï¼š]]></content>
      <categories>
        <category>golang</category>
      </categories>
      <tags>
        <tag>golang</tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[python3ä¸­é‡åˆ°'TypeError Unicode-objects must be encoded before hashing']]></title>
    <url>%2F2018%2F08%2F20%2Fpython-md5-err-md%2F</url>
    <content type="text"><![CDATA[Python3ä¸­è¿›è¡ŒMD5åŠ å¯†ï¼Œé‡åˆ°ç¼–ç é—®é¢˜ 12345678910111213141516171819202122232425262728293031323334353637383940import hashlibfrom urllib.parse import urlencode, quote_plusimport urllibdef verfy_ac(private_key): item = &#123; "Action" : "CreateUHostInstance", "CPU" : 2, "ChargeType" : "Month", "DiskSpace" : 10, "ImageId" : "f43736e1-65a5-4bea-ad2e-8a46e18883c2", "LoginMode" : "Password", "Memory" : 2048, "Name" : "Host01", "Password" : "VUNsb3VkLmNu", "PublicKey" : "ucloudsomeone%40example.com1296235120854146120", "Quantity" : 1, "Region" : "cn-bj2", "Zone" : "cn-bj2-04" &#125; # å°†å‚æ•°ä¸²æŽ’åº params_data = "" import pdb;pdb.set_trace() for key, value in item.items(): params_data = params_data + str(key) + str(value) params_data = params_data + private_key params_data_en = quote_plus(params_data) sign = hashlib.sha1() sign.update(params_data_en.encode('utf8')) signature = sign.hexdigest() return signatureprint(verfy_ac("46f09bb9fab4f12dfc160dae12273d5332b5debe")) è¿™æ˜¯ucloudå®˜æ–¹çš„APIæ•™ç¨‹ï¼Œæƒ³æ ¹æ®æ­¤æ•™ç¨‹ç”Ÿæˆç­¾åï¼Œæ•™ç¨‹ä¸­çš„ä»£ç æ˜¯åŸºäºŽPython2.7ç¼–å†™ï¼Œæˆ‘å°†å…¶æ”¹æˆäº†Python3.ä½†æ˜¯åœ¨æ‰§è¡Œæ—¶æŠ¥é”™ï¼š 1TypeError: Unicode-objects must be encoded before hashing æŽ’é”™åŽå‘çŽ°python3ä¸­å­—ç¬¦å¯¹è±¡æ˜¯unicodeå¯¹è±¡ï¼Œä¸èƒ½ç›´æŽ¥åŠ å¯†ï¼Œéœ€è¦ç¼–ç åŽæ‰èƒ½è¿›è¡Œupdateã€‚ å°±æ˜¯æ”¹æˆå¦‚ä¸‹å³å¯ï¼š 1sign.update(params_data_en.encode('utf8'))]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>md5ç¼–ç </tag>
      </tags>
  </entry>
  <entry>
    <title><![CDATA[Hello World]]></title>
    <url>%2F2018%2F08%2F18%2Fhello-world%2F</url>
    <content type="text"><![CDATA[Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub. Quick StartCreate a new post1$ hexo new "My New Post" More info: Writing Run server1$ hexo server More info: Server Generate static files1$ hexo generate More info: Generating Deploy to remote sites1$ hexo deploy More info: Deployment]]></content>
  </entry>
</search>
